<!doctype html public "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
    <title>PHPXRef 0.7.1 : Unnamed Project : /auth/mnet/auth.php source</title>
    <link rel="stylesheet" href="../../sample.css" type="text/css">
    <link rel="stylesheet" href="../../sample-print.css" type="text/css" media="print">
    <style id="hilight" type="text/css"></style>
    <meta http-equiv="content-type" content="text/html;charset=iso-8859-1">
</head>
<body bgcolor="#ffffff" text="#000000" link="#801800" vlink="#300540" alink="#ffffff">
<table class="pagetitle" width="100%">
	<tr>
        <td valign="top" class="pagetitle">
            [ <a href="../../index.html">Index</a> ]
        </td>
        <td align="right" class="pagetitle">
		    <h2 style="margin-bottom: 0px">PHP Cross Reference of Unnamed Project</h2>
	    </td>
    </tr>
</table>


<!-- Generated by PHPXref 0.7.1 at Thu May 28 19:17:31 2015 -->
<!-- PHPXref (c) 2000-2010 Gareth Watts - gareth@omnipotent.net -->
<!-- http://phpxref.sourceforge.net/ -->

<script src="../../phpxref.js" type="text/javascript"></script>
<script language="JavaScript" type="text/javascript">
<!--
ext='.html';
relbase='../../';
subdir='auth/mnet';
filename='auth.php.source.html';
cookiekey='phpxref';
handleNavFrame(relbase, subdir, filename);

// -->
</script>
<script language="JavaScript" type="text/javascript">
if (gwGetCookie('xrefnav')=='off')
  document.write('<p class="navlinks">[ <a href="javascript:navOn()">Show Explorer<\/a> ]<\/p>');
else
  document.write('<p class="navlinks">[ <a href="javascript:navOff()">Hide Explorer<\/a> ]<\/p>');
</script>
<noscript>
<p class="navlinks">
[ <a href="../../nav.html" target="_top">Show Explorer</a> ]
[ <a href="index.html" target="_top">Hide Navbar</a> ]
</p>
</noscript>
<script language="JavaScript" type="text/javascript">
<!--

document.writeln('<table align="right" class="searchbox-link"><tr><td><a class="searchbox-link" href="javascript:void(0)" onMouseOver="showSearchBox()">Search</a><br>');
document.writeln('<table border="0" cellspacing="0" cellpadding="0" class="searchbox" id="searchbox">');
document.writeln('<tr><td class="searchbox-title">');
document.writeln('<a class="searchbox-title" href="javascript:showSearchPopup()">Search History +</a>');
document.writeln('<\/td><\/tr>');

document.writeln('<tr><td class="searchbox-body" id="searchbox-body">');
document.writeln('<form name="search" style="margin:0px; padding:0px" onSubmit=\'return jump()\'>');
document.writeln('<a class="searchbox-body" href="../../_classes/index.html">Class<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="classname"><br>');
document.writeln('<a id="funcsearchlink" class="searchbox-body" href="../../_functions/index.html">Function<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="funcname"><br>');
document.writeln('<a class="searchbox-body" href="../../_variables/index.html">Variable<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="varname"><br>');
document.writeln('<a class="searchbox-body" href="../../_constants/index.html">Constant<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="constname"><br>');
document.writeln('<a class="searchbox-body" href="../../_tables/index.html">Table<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="tablename"><br>');
document.writeln('<input type="submit" class="searchbox-button" value="Search">');
document.writeln('<\/form>');
document.writeln('<\/td><\/tr><\/table>');
document.writeln('<\/td><\/tr><\/table>');
// -->
</script>
<div id="search-popup" class="searchpopup"><p id="searchpopup-title" class="searchpopup-title">title</p><div id="searchpopup-body" class="searchpopup-body">Body</div><p class="searchpopup-close"><a href="javascript:gwCloseActive()">[close]</a></p></div>
<h2 class="listing-heading"><a href="./index.html">/auth/mnet/</a> -> <a href="auth.php.html">auth.php</a> (source)</h2>
<div class="listing">
<p class="viewlinks">[<a href="auth.php.html">Summary view</a>]
[<a href="javascript:window.print();">Print</a>]
[<a href="auth.php.source.txt" target="_new">Text view</a>]
</p>
<pre>
<a name="l1"><span class="linenum">   1</span></a>  &lt;?php
<a name="l2"><span class="linenum">   2</span></a>  <span class="comment">// This file is part of Moodle - http://moodle.org/</span>
<a name="l3"><span class="linenum">   3</span></a>  <span class="comment">//</span>
<a name="l4"><span class="linenum">   4</span></a>  <span class="comment">// Moodle is free software: you can redistribute it and/or modify</span>
<a name="l5"><span class="linenum">   5</span></a>  <span class="comment">// it under the terms of the GNU General Public License as published by</span>
<a name="l6"><span class="linenum">   6</span></a>  <span class="comment">// the Free Software Foundation, either version 3 of the License, or</span>
<a name="l7"><span class="linenum">   7</span></a>  <span class="comment">// (at your option) any later version.</span>
<a name="l8"><span class="linenum">   8</span></a>  <span class="comment">//</span>
<a name="l9"><span class="linenum">   9</span></a>  <span class="comment">// Moodle is distributed in the hope that it will be useful,</span>
<a name="l10"><span class="linenum">  10</span></a>  <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l11"><span class="linenum">  11</span></a>  <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l12"><span class="linenum">  12</span></a>  <span class="comment">// GNU General Public License for more details.</span>
<a name="l13"><span class="linenum">  13</span></a>  <span class="comment">//</span>
<a name="l14"><span class="linenum">  14</span></a>  <span class="comment">// You should have received a copy of the GNU General Public License</span>
<a name="l15"><span class="linenum">  15</span></a>  <span class="comment">// along with Moodle.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l16"><span class="linenum">  16</span></a>  
<a name="l17"><span class="linenum">  17</span></a>  <span class="comment">/**</span>
<a name="l18"><span class="linenum">  18</span></a>  <span class="comment"> * Authentication Plugin: Moodle Network Authentication</span>
<a name="l19"><span class="linenum">  19</span></a>  <span class="comment"> * Multiple host authentication support for Moodle Network.</span>
<a name="l20"><span class="linenum">  20</span></a>  <span class="comment"> *</span>
<a name="l21"><span class="linenum">  21</span></a>  <span class="comment"> * @package auth_mnet</span>
<a name="l22"><span class="linenum">  22</span></a>  <span class="comment"> * @author Martin Dougiamas</span>
<a name="l23"><span class="linenum">  23</span></a>  <span class="comment"> * @license http://www.gnu.org/copyleft/gpl.html GNU Public License</span>
<a name="l24"><span class="linenum">  24</span></a>  <span class="comment"> */</span>
<a name="l25"><span class="linenum">  25</span></a>  
<a name="l26"><span class="linenum">  26</span></a>  <a class="phpfunction" onClick="logFunction('defined')" href="../../_functions/defined.html" onMouseOver="phpfuncPopup(event,'defined')">defined</a>('<a class="constant" onClick="logConstant('MOODLE_INTERNAL')" href="../../_constants/MOODLE_INTERNAL.html" onMouseOver="constPopup(event,'MOODLE_INTERNAL')">MOODLE_INTERNAL</a>') || die();
<a name="l27"><span class="linenum">  27</span></a>  
<a name="l28"><span class="linenum">  28</span></a>  require_once(<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('libdir')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/libdir.html">libdir</a>.'/authlib.php');
<a name="l29"><span class="linenum">  29</span></a>  
<a name="l30"><span class="linenum">  30</span></a>  <span class="comment">/**</span>
<a name="l31"><span class="linenum">  31</span></a>  <span class="comment"> * Moodle Network authentication plugin.</span>
<a name="l32"><span class="linenum">  32</span></a>  <span class="comment"> */</span>
<a name="l33"><span class="linenum">  33</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('auth_plugin_mnet')" href="../../_classes/auth_plugin_mnet.html" onMouseOver="classPopup(event,'auth_plugin_mnet')">auth_plugin_mnet</a> <span class="keyword">extends</span> <a class="class" onClick="logClass('auth_plugin_base')" href="../../_classes/auth_plugin_base.html" onMouseOver="classPopup(event,'auth_plugin_base')">auth_plugin_base</a> {
<a name="l34"><span class="linenum">  34</span></a>  
<a name="l35"><span class="linenum">  35</span></a>      <span class="comment">/**</span>
<a name="l36"><span class="linenum">  36</span></a>  <span class="comment">     * Constructor.</span>
<a name="l37"><span class="linenum">  37</span></a>  <span class="comment">     */</span>
<a name="l38"><span class="linenum">  38</span></a>      function <a class="function" onClick="logFunction('auth_plugin_mnet')" href="../../_functions/auth_plugin_mnet.html" onMouseOver="funcPopup(event,'auth_plugin_mnet')">auth_plugin_mnet</a>() {
<a name="l39"><span class="linenum">  39</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('authtype')" class="var it39456" onMouseOver="hilite(39456)" onMouseOut="lolite()" href="../../_variables/authtype.html">authtype</a> = 'mnet';
<a name="l40"><span class="linenum">  40</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('config')" class="var it39456" onMouseOver="hilite(39456)" onMouseOut="lolite()" href="../../_variables/config.html">config</a> = <a class="function" onClick="logFunction('get_config')" href="../../_functions/get_config.html" onMouseOver="funcPopup(event,'get_config')">get_config</a>('auth_mnet');
<a name="l41"><span class="linenum">  41</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('mnet')" class="var it39456" onMouseOver="hilite(39456)" onMouseOut="lolite()" href="../../_variables/mnet.html">mnet</a> = <a class="function" onClick="logFunction('get_mnet_environment')" href="../../_functions/get_mnet_environment.html" onMouseOver="funcPopup(event,'get_mnet_environment')">get_mnet_environment</a>();
<a name="l42"><span class="linenum">  42</span></a>      }
<a name="l43"><span class="linenum">  43</span></a>  
<a name="l44"><span class="linenum">  44</span></a>      <span class="comment">/**</span>
<a name="l45"><span class="linenum">  45</span></a>  <span class="comment">     * This function is normally used to determine if the username and password</span>
<a name="l46"><span class="linenum">  46</span></a>  <span class="comment">     * are correct for local logins. Always returns false, as local users do not</span>
<a name="l47"><span class="linenum">  47</span></a>  <span class="comment">     * need to login over mnet xmlrpc.</span>
<a name="l48"><span class="linenum">  48</span></a>  <span class="comment">     *</span>
<a name="l49"><span class="linenum">  49</span></a>  <span class="comment">     * @param string $username The username</span>
<a name="l50"><span class="linenum">  50</span></a>  <span class="comment">     * @param string $password The password</span>
<a name="l51"><span class="linenum">  51</span></a>  <span class="comment">     * @return bool Authentication success or failure.</span>
<a name="l52"><span class="linenum">  52</span></a>  <span class="comment">     */</span>
<a name="l53"><span class="linenum">  53</span></a>      function <a class="function" onClick="logFunction('user_login')" href="../../_functions/user_login.html" onMouseOver="funcPopup(event,'user_login')">user_login</a>(<a class="var it463" onMouseOver="hilite(463)" onMouseOut="lolite()" onClick="logVariable('username')" href="../../_variables/username.html">$username</a>, <a class="var it2550" onMouseOver="hilite(2550)" onMouseOut="lolite()" onClick="logVariable('password')" href="../../_variables/password.html">$password</a>) {
<a name="l54"><span class="linenum">  54</span></a>          return false; <span class="comment">// print_error(&quot;mnetlocal&quot;);</span>
<a name="l55"><span class="linenum">  55</span></a>      }
<a name="l56"><span class="linenum">  56</span></a>  
<a name="l57"><span class="linenum">  57</span></a>      <span class="comment">/**</span>
<a name="l58"><span class="linenum">  58</span></a>  <span class="comment">     * Return user data for the provided token, compare with user_agent string.</span>
<a name="l59"><span class="linenum">  59</span></a>  <span class="comment">     *</span>
<a name="l60"><span class="linenum">  60</span></a>  <span class="comment">     * @param  string $token    The unique ID provided by remotehost.</span>
<a name="l61"><span class="linenum">  61</span></a>  <span class="comment">     * @param  string $UA       User Agent string.</span>
<a name="l62"><span class="linenum">  62</span></a>  <span class="comment">     * @return array  $userdata Array of user info for remote host</span>
<a name="l63"><span class="linenum">  63</span></a>  <span class="comment">     */</span>
<a name="l64"><span class="linenum">  64</span></a>      function <a class="function" onClick="logFunction('user_authorise')" href="../../_functions/user_authorise.html" onMouseOver="funcPopup(event,'user_authorise')">user_authorise</a>(<a class="var it464" onMouseOver="hilite(464)" onMouseOut="lolite()" onClick="logVariable('token')" href="../../_variables/token.html">$token</a>, <a class="var it3522" onMouseOver="hilite(3522)" onMouseOut="lolite()" onClick="logVariable('useragent')" href="../../_variables/useragent.html">$useragent</a>) {
<a name="l65"><span class="linenum">  65</span></a>          global <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it1063" onMouseOver="hilite(1063)" onMouseOut="lolite()" onClick="logVariable('SITE')" href="../../_variables/SITE.html">$SITE</a>, <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l66"><span class="linenum">  66</span></a>          <a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a> = <a class="function" onClick="logFunction('get_mnet_remote_client')" href="../../_functions/get_mnet_remote_client.html" onMouseOver="funcPopup(event,'get_mnet_remote_client')">get_mnet_remote_client</a>();
<a name="l67"><span class="linenum">  67</span></a>          require_once <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('dirroot')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/dirroot.html">dirroot</a> . '<a class="filename" href="../../mnet/xmlrpc/serverlib.php.html">/mnet/xmlrpc/serverlib.php</a>';
<a name="l68"><span class="linenum">  68</span></a>  
<a name="l69"><span class="linenum">  69</span></a>          <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('mnet_session', array('token'=&gt;<a class="var it464" onMouseOver="hilite(464)" onMouseOut="lolite()" onClick="logVariable('token')" href="../../_variables/token.html">$token</a>, 'useragent'=&gt;<a class="var it3522" onMouseOver="hilite(3522)" onMouseOut="lolite()" onClick="logVariable('useragent')" href="../../_variables/useragent.html">$useragent</a>));
<a name="l70"><span class="linenum">  70</span></a>          if (empty(<a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>)) {
<a name="l71"><span class="linenum">  71</span></a>              throw <span class="keyword">new </span><a class="class" onClick="logClass('mnet_server_exception')" href="../../_classes/mnet_server_exception.html" onMouseOver="classPopup(event,'mnet_server_exception')">mnet_server_exception</a>(1, 'authfail_nosessionexists');
<a name="l72"><span class="linenum">  72</span></a>          }
<a name="l73"><span class="linenum">  73</span></a>  
<a name="l74"><span class="linenum">  74</span></a>  <span class="comment">        // check session confirm timeout</span>
<a name="l75"><span class="linenum">  75</span></a>          if (<a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('confirm_timeout')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/confirm_timeout.html">confirm_timeout</a> &lt; <a class="phpfunction" onClick="logFunction('time')" href="../../_functions/time.html" onMouseOver="phpfuncPopup(event,'time')">time</a>()) {
<a name="l76"><span class="linenum">  76</span></a>              throw <span class="keyword">new </span><a class="class" onClick="logClass('mnet_server_exception')" href="../../_classes/mnet_server_exception.html" onMouseOver="classPopup(event,'mnet_server_exception')">mnet_server_exception</a>(2, 'authfail_sessiontimedout');
<a name="l77"><span class="linenum">  77</span></a>          }
<a name="l78"><span class="linenum">  78</span></a>  
<a name="l79"><span class="linenum">  79</span></a>  <span class="comment">        // session okay, try getting the user</span>
<a name="l80"><span class="linenum">  80</span></a>          if (!<a class="var it119" onMouseOver="hilite(119)" onMouseOut="lolite()" onClick="logVariable('user')" href="../../_variables/user.html">$user</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('user', array('id'=&gt;<a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('userid')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>))) {
<a name="l81"><span class="linenum">  81</span></a>              throw <span class="keyword">new </span><a class="class" onClick="logClass('mnet_server_exception')" href="../../_classes/mnet_server_exception.html" onMouseOver="classPopup(event,'mnet_server_exception')">mnet_server_exception</a>(3, 'authfail_usermismatch');
<a name="l82"><span class="linenum">  82</span></a>          }
<a name="l83"><span class="linenum">  83</span></a>  
<a name="l84"><span class="linenum">  84</span></a>          <a class="var it522" onMouseOver="hilite(522)" onMouseOut="lolite()" onClick="logVariable('userdata')" href="../../_variables/userdata.html">$userdata</a> = <a class="function" onClick="logFunction('mnet_strip_user')" href="../../_functions/mnet_strip_user.html" onMouseOver="funcPopup(event,'mnet_strip_user')">mnet_strip_user</a>((array)<a class="var it119" onMouseOver="hilite(119)" onMouseOut="lolite()" onClick="logVariable('user')" href="../../_variables/user.html">$user</a>, <a class="function" onClick="logFunction('mnet_fields_to_send')" href="../../_functions/mnet_fields_to_send.html" onMouseOver="funcPopup(event,'mnet_fields_to_send')">mnet_fields_to_send</a>(<a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a>));
<a name="l85"><span class="linenum">  85</span></a>  
<a name="l86"><span class="linenum">  86</span></a>  <span class="comment">        // extra special ones</span>
<a name="l87"><span class="linenum">  87</span></a>          <a class="var it522" onMouseOver="hilite(522)" onMouseOut="lolite()" onClick="logVariable('userdata')" href="../../_variables/userdata.html">$userdata</a>['auth']                    = 'mnet';
<a name="l88"><span class="linenum">  88</span></a>          <a class="var it522" onMouseOver="hilite(522)" onMouseOut="lolite()" onClick="logVariable('userdata')" href="../../_variables/userdata.html">$userdata</a>['wwwroot']                 = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('mnet')" class="var it39456" onMouseOver="hilite(39456)" onMouseOut="lolite()" href="../../_variables/mnet.html">mnet</a>-&gt;wwwroot;
<a name="l89"><span class="linenum">  89</span></a>          <a class="var it522" onMouseOver="hilite(522)" onMouseOut="lolite()" onClick="logVariable('userdata')" href="../../_variables/userdata.html">$userdata</a>['session.gc_maxlifetime']  = <a class="phpfunction" onClick="logFunction('ini_get')" href="../../_functions/ini_get.html" onMouseOver="phpfuncPopup(event,'ini_get')">ini_get</a>('session.gc_maxlifetime');
<a name="l90"><span class="linenum">  90</span></a>  
<a name="l91"><span class="linenum">  91</span></a>          if (<a class="phpfunction" onClick="logFunction('array_key_exists')" href="../../_functions/array_key_exists.html" onMouseOver="phpfuncPopup(event,'array_key_exists')">array_key_exists</a>('picture', <a class="var it522" onMouseOver="hilite(522)" onMouseOut="lolite()" onClick="logVariable('userdata')" href="../../_variables/userdata.html">$userdata</a>) &amp;&amp; !empty(<a class="var it119" onMouseOver="hilite(119)" onMouseOut="lolite()" onClick="logVariable('user')" href="../../_variables/user.html">$user</a>-&gt;<a onClick="logVariable('picture')" class="var it39447" onMouseOver="hilite(39447)" onMouseOut="lolite()" href="../../_variables/picture.html">picture</a>)) {
<a name="l92"><span class="linenum">  92</span></a>              <a class="var it586" onMouseOver="hilite(586)" onMouseOut="lolite()" onClick="logVariable('fs')" href="../../_variables/fs.html">$fs</a> = <a class="function" onClick="logFunction('get_file_storage')" href="../../_functions/get_file_storage.html" onMouseOver="funcPopup(event,'get_file_storage')">get_file_storage</a>();
<a name="l93"><span class="linenum">  93</span></a>              <a class="var it1419" onMouseOver="hilite(1419)" onMouseOut="lolite()" onClick="logVariable('usercontext')" href="../../_variables/usercontext.html">$usercontext</a> = <a class="class" onClick="logClass('context_user')" href="../../_classes/context_user.html" onMouseOver="classPopup(event,'context_user')">context_user</a>::<a class="function" onClick="logFunction('instance')" href="../../_functions/instance.html" onMouseOver="funcPopup(event,'instance')">instance</a>(<a class="var it119" onMouseOver="hilite(119)" onMouseOut="lolite()" onClick="logVariable('user')" href="../../_variables/user.html">$user</a>-&gt;<a onClick="logVariable('id')" class="var it39447" onMouseOver="hilite(39447)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, <a class="constant" onClick="logConstant('MUST_EXIST')" href="../../_constants/MUST_EXIST.html" onMouseOver="constPopup(event,'MUST_EXIST')">MUST_EXIST</a>);
<a name="l94"><span class="linenum">  94</span></a>              if (<a class="var it20767" onMouseOver="hilite(20767)" onMouseOut="lolite()" onClick="logVariable('usericonfile')" href="../../_variables/usericonfile.html">$usericonfile</a> = <a class="var it586" onMouseOver="hilite(586)" onMouseOut="lolite()" onClick="logVariable('fs')" href="../../_variables/fs.html">$fs</a>-&gt;<a class="function" onClick="logFunction('get_file')" href="../../_functions/get_file.html" onMouseOver="funcPopup(event,'get_file')">get_file</a>(<a class="var it1419" onMouseOver="hilite(1419)" onMouseOut="lolite()" onClick="logVariable('usercontext')" href="../../_variables/usercontext.html">$usercontext</a>-&gt;<a onClick="logVariable('id')" class="var it39494" onMouseOver="hilite(39494)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, 'user', 'icon', 0, '/', 'f1.png')) {
<a name="l95"><span class="linenum">  95</span></a>                  <a class="var it522" onMouseOver="hilite(522)" onMouseOut="lolite()" onClick="logVariable('userdata')" href="../../_variables/userdata.html">$userdata</a>['_mnet_userpicture_timemodified'] = <a class="var it20767" onMouseOver="hilite(20767)" onMouseOut="lolite()" onClick="logVariable('usericonfile')" href="../../_variables/usericonfile.html">$usericonfile</a>-&gt;<a class="function" onClick="logFunction('get_timemodified')" href="../../_functions/get_timemodified.html" onMouseOver="funcPopup(event,'get_timemodified')">get_timemodified</a>();
<a name="l96"><span class="linenum">  96</span></a>                  <a class="var it522" onMouseOver="hilite(522)" onMouseOut="lolite()" onClick="logVariable('userdata')" href="../../_variables/userdata.html">$userdata</a>['_mnet_userpicture_mimetype'] = <a class="var it20767" onMouseOver="hilite(20767)" onMouseOut="lolite()" onClick="logVariable('usericonfile')" href="../../_variables/usericonfile.html">$usericonfile</a>-&gt;<a class="function" onClick="logFunction('get_mimetype')" href="../../_functions/get_mimetype.html" onMouseOver="funcPopup(event,'get_mimetype')">get_mimetype</a>();
<a name="l97"><span class="linenum">  97</span></a>              } else if (<a class="var it20767" onMouseOver="hilite(20767)" onMouseOut="lolite()" onClick="logVariable('usericonfile')" href="../../_variables/usericonfile.html">$usericonfile</a> = <a class="var it586" onMouseOver="hilite(586)" onMouseOut="lolite()" onClick="logVariable('fs')" href="../../_variables/fs.html">$fs</a>-&gt;<a class="function" onClick="logFunction('get_file')" href="../../_functions/get_file.html" onMouseOver="funcPopup(event,'get_file')">get_file</a>(<a class="var it1419" onMouseOver="hilite(1419)" onMouseOut="lolite()" onClick="logVariable('usercontext')" href="../../_variables/usercontext.html">$usercontext</a>-&gt;<a onClick="logVariable('id')" class="var it39494" onMouseOver="hilite(39494)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, 'user', 'icon', 0, '/', 'f1.jpg')) {
<a name="l98"><span class="linenum">  98</span></a>                  <a class="var it522" onMouseOver="hilite(522)" onMouseOut="lolite()" onClick="logVariable('userdata')" href="../../_variables/userdata.html">$userdata</a>['_mnet_userpicture_timemodified'] = <a class="var it20767" onMouseOver="hilite(20767)" onMouseOut="lolite()" onClick="logVariable('usericonfile')" href="../../_variables/usericonfile.html">$usericonfile</a>-&gt;<a class="function" onClick="logFunction('get_timemodified')" href="../../_functions/get_timemodified.html" onMouseOver="funcPopup(event,'get_timemodified')">get_timemodified</a>();
<a name="l99"><span class="linenum">  99</span></a>                  <a class="var it522" onMouseOver="hilite(522)" onMouseOut="lolite()" onClick="logVariable('userdata')" href="../../_variables/userdata.html">$userdata</a>['_mnet_userpicture_mimetype'] = <a class="var it20767" onMouseOver="hilite(20767)" onMouseOut="lolite()" onClick="logVariable('usericonfile')" href="../../_variables/usericonfile.html">$usericonfile</a>-&gt;<a class="function" onClick="logFunction('get_mimetype')" href="../../_functions/get_mimetype.html" onMouseOver="funcPopup(event,'get_mimetype')">get_mimetype</a>();
<a name="l100"><span class="linenum"> 100</span></a>              }
<a name="l101"><span class="linenum"> 101</span></a>          }
<a name="l102"><span class="linenum"> 102</span></a>  
<a name="l103"><span class="linenum"> 103</span></a>          <a class="var it522" onMouseOver="hilite(522)" onMouseOut="lolite()" onClick="logVariable('userdata')" href="../../_variables/userdata.html">$userdata</a>['myhosts'] = array();
<a name="l104"><span class="linenum"> 104</span></a>          if (<a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a> = <a class="function" onClick="logFunction('enrol_get_users_courses')" href="../../_functions/enrol_get_users_courses.html" onMouseOver="funcPopup(event,'enrol_get_users_courses')">enrol_get_users_courses</a>(<a class="var it119" onMouseOver="hilite(119)" onMouseOut="lolite()" onClick="logVariable('user')" href="../../_variables/user.html">$user</a>-&gt;<a onClick="logVariable('id')" class="var it39447" onMouseOver="hilite(39447)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, false)) {
<a name="l105"><span class="linenum"> 105</span></a>              <a class="var it522" onMouseOver="hilite(522)" onMouseOut="lolite()" onClick="logVariable('userdata')" href="../../_variables/userdata.html">$userdata</a>['myhosts'][] = array('name'=&gt; <a class="var it1063" onMouseOver="hilite(1063)" onMouseOut="lolite()" onClick="logVariable('SITE')" href="../../_variables/SITE.html">$SITE</a>-&gt;<a onClick="logVariable('shortname')" class="var it39635" onMouseOver="hilite(39635)" onMouseOut="lolite()" href="../../_variables/shortname.html">shortname</a>, 'url' =&gt; <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('wwwroot')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/wwwroot.html">wwwroot</a>, 'count' =&gt; <a class="phpfunction" onClick="logFunction('count')" href="../../_functions/count.html" onMouseOver="phpfuncPopup(event,'count')">count</a>(<a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>));
<a name="l106"><span class="linenum"> 106</span></a>          }
<a name="l107"><span class="linenum"> 107</span></a>  
<a name="l108"><span class="linenum"> 108</span></a>          <a class="var it125" onMouseOver="hilite(125)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a> = &quot;SELECT h.name AS hostname, h.wwwroot, h.id AS hostid,
<a name="l109"><span class="linenum"> 109</span></a>                         <a class="phpfunction" onClick="logFunction('COUNT')" href="../../_functions/count.html" onMouseOver="phpfuncPopup(event,'count')">COUNT</a>(c.id) AS count
<a name="l110"><span class="linenum"> 110</span></a>                    FROM {mnetservice_enrol_courses} c
<a name="l111"><span class="linenum"> 111</span></a>                    JOIN {mnetservice_enrol_enrolments} e <a class="function" onClick="logFunction('ON')" href="../../_functions/on.html" onMouseOver="funcPopup(event,'on')">ON</a> (e.hostid = c.hostid AND e.remotecourseid = c.remoteid)
<a name="l112"><span class="linenum"> 112</span></a>                    JOIN {mnet_host} h ON h.id = c.hostid
<a name="l113"><span class="linenum"> 113</span></a>                   WHERE e.userid = ? AND c.hostid = ?
<a name="l114"><span class="linenum"> 114</span></a>                GROUP BY h.name, h.wwwroot, h.id&quot;;
<a name="l115"><span class="linenum"> 115</span></a>  
<a name="l116"><span class="linenum"> 116</span></a>          if (<a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records_sql')" href="../../_functions/get_records_sql.html" onMouseOver="funcPopup(event,'get_records_sql')">get_records_sql</a>(<a class="var it125" onMouseOver="hilite(125)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a>, array(<a class="var it119" onMouseOver="hilite(119)" onMouseOut="lolite()" onClick="logVariable('user')" href="../../_variables/user.html">$user</a>-&gt;<a onClick="logVariable('id')" class="var it39447" onMouseOver="hilite(39447)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, <a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a>-&gt;<a onClick="logVariable('id')" class="var it39817" onMouseOver="hilite(39817)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>))) {
<a name="l117"><span class="linenum"> 117</span></a>              foreach(<a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a> as <a class="var it101" onMouseOver="hilite(101)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>) {
<a name="l118"><span class="linenum"> 118</span></a>                  <a class="var it522" onMouseOver="hilite(522)" onMouseOut="lolite()" onClick="logVariable('userdata')" href="../../_variables/userdata.html">$userdata</a>['myhosts'][] = array('name'=&gt; <a class="var it101" onMouseOver="hilite(101)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>-&gt;<a onClick="logVariable('hostname')" class="var it39506" onMouseOver="hilite(39506)" onMouseOut="lolite()" href="../../_variables/hostname.html">hostname</a>, 'url' =&gt; <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('wwwroot')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/wwwroot.html">wwwroot</a>.'/auth/mnet/jump.php?hostid='.<a class="var it101" onMouseOver="hilite(101)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>-&gt;<a onClick="logVariable('hostid')" class="var it39506" onMouseOver="hilite(39506)" onMouseOut="lolite()" href="../../_variables/hostid.html">hostid</a>, 'count' =&gt; <a class="var it101" onMouseOver="hilite(101)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>-&gt;<a onClick="logVariable('count')" class="var it39506" onMouseOver="hilite(39506)" onMouseOut="lolite()" href="../../_variables/count.html">count</a>);
<a name="l119"><span class="linenum"> 119</span></a>              }
<a name="l120"><span class="linenum"> 120</span></a>          }
<a name="l121"><span class="linenum"> 121</span></a>  
<a name="l122"><span class="linenum"> 122</span></a>          return <a class="var it522" onMouseOver="hilite(522)" onMouseOut="lolite()" onClick="logVariable('userdata')" href="../../_variables/userdata.html">$userdata</a>;
<a name="l123"><span class="linenum"> 123</span></a>      }
<a name="l124"><span class="linenum"> 124</span></a>  
<a name="l125"><span class="linenum"> 125</span></a>      <span class="comment">/**</span>
<a name="l126"><span class="linenum"> 126</span></a>  <span class="comment">     * Generate a random string for use as an RPC session token.</span>
<a name="l127"><span class="linenum"> 127</span></a>  <span class="comment">     */</span>
<a name="l128"><span class="linenum"> 128</span></a>      function <a class="function" onClick="logFunction('generate_token')" href="../../_functions/generate_token.html" onMouseOver="funcPopup(event,'generate_token')">generate_token</a>() {
<a name="l129"><span class="linenum"> 129</span></a>          return <a class="phpfunction" onClick="logFunction('sha1')" href="../../_functions/sha1.html" onMouseOver="phpfuncPopup(event,'sha1')">sha1</a>(<a class="phpfunction" onClick="logFunction('str_shuffle')" href="../../_functions/str_shuffle.html" onMouseOver="phpfuncPopup(event,'str_shuffle')">str_shuffle</a>('' . <a class="phpfunction" onClick="logFunction('mt_rand')" href="../../_functions/mt_rand.html" onMouseOver="phpfuncPopup(event,'mt_rand')">mt_rand</a>() . <a class="phpfunction" onClick="logFunction('time')" href="../../_functions/time.html" onMouseOver="phpfuncPopup(event,'time')">time</a>()));
<a name="l130"><span class="linenum"> 130</span></a>      }
<a name="l131"><span class="linenum"> 131</span></a>  
<a name="l132"><span class="linenum"> 132</span></a>      <span class="comment">/**</span>
<a name="l133"><span class="linenum"> 133</span></a>  <span class="comment">     * Starts an RPC jump session and returns the jump redirect URL.</span>
<a name="l134"><span class="linenum"> 134</span></a>  <span class="comment">     *</span>
<a name="l135"><span class="linenum"> 135</span></a>  <span class="comment">     * @param int $mnethostid id of the mnet host to jump to</span>
<a name="l136"><span class="linenum"> 136</span></a>  <span class="comment">     * @param string $wantsurl url to redirect to after the jump (usually on remote system)</span>
<a name="l137"><span class="linenum"> 137</span></a>  <span class="comment">     * @param boolean $wantsurlbackhere defaults to false, means that the remote system should bounce us back here</span>
<a name="l138"><span class="linenum"> 138</span></a>  <span class="comment">     *                                  rather than somewhere inside *its* wwwroot</span>
<a name="l139"><span class="linenum"> 139</span></a>  <span class="comment">     */</span>
<a name="l140"><span class="linenum"> 140</span></a>      function <a class="function" onClick="logFunction('start_jump_session')" href="../../_functions/start_jump_session.html" onMouseOver="funcPopup(event,'start_jump_session')">start_jump_session</a>(<a class="var it523" onMouseOver="hilite(523)" onMouseOut="lolite()" onClick="logVariable('mnethostid')" href="../../_variables/mnethostid.html">$mnethostid</a>, <a class="var it4003" onMouseOver="hilite(4003)" onMouseOut="lolite()" onClick="logVariable('wantsurl')" href="../../_variables/wantsurl.html">$wantsurl</a>, <a class="var it20768" onMouseOver="hilite(20768)" onMouseOut="lolite()" onClick="logVariable('wantsurlbackhere')" href="../../_variables/wantsurlbackhere.html">$wantsurlbackhere</a>=false) {
<a name="l141"><span class="linenum"> 141</span></a>          global <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it9" onMouseOver="hilite(9)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>, <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l142"><span class="linenum"> 142</span></a>          require_once <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('dirroot')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/dirroot.html">dirroot</a> . '<a class="filename" href="../../mnet/xmlrpc/client.php.html">/mnet/xmlrpc/client.php</a>';
<a name="l143"><span class="linenum"> 143</span></a>  
<a name="l144"><span class="linenum"> 144</span></a>          if (\core\session\<a class="class" onClick="logClass('manager')" href="../../_classes/manager.html" onMouseOver="classPopup(event,'manager')">manager</a>::<a class="function" onClick="logFunction('is_loggedinas')" href="../../_functions/is_loggedinas.html" onMouseOver="funcPopup(event,'is_loggedinas')">is_loggedinas</a>()) {
<a name="l145"><span class="linenum"> 145</span></a>              <a class="function" onClick="logFunction('print_error')" href="../../_functions/print_error.html" onMouseOver="funcPopup(event,'print_error')">print_error</a>('notpermittedtojumpas', 'mnet');
<a name="l146"><span class="linenum"> 146</span></a>          }
<a name="l147"><span class="linenum"> 147</span></a>  
<a name="l148"><span class="linenum"> 148</span></a>  <span class="comment">        // check remote login permissions</span>
<a name="l149"><span class="linenum"> 149</span></a>          if (! <a class="function" onClick="logFunction('has_capability')" href="../../_functions/has_capability.html" onMouseOver="funcPopup(event,'has_capability')">has_capability</a>('moodle/site:mnetlogintoremote', <a class="class" onClick="logClass('context_system')" href="../../_classes/context_system.html" onMouseOver="classPopup(event,'context_system')">context_system</a>::<a class="function" onClick="logFunction('instance')" href="../../_functions/instance.html" onMouseOver="funcPopup(event,'instance')">instance</a>())
<a name="l150"><span class="linenum"> 150</span></a>                  or <a class="function" onClick="logFunction('is_mnet_remote_user')" href="../../_functions/is_mnet_remote_user.html" onMouseOver="funcPopup(event,'is_mnet_remote_user')">is_mnet_remote_user</a>(<a class="var it9" onMouseOver="hilite(9)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>)
<a name="l151"><span class="linenum"> 151</span></a>                  or <a class="function" onClick="logFunction('isguestuser')" href="../../_functions/isguestuser.html" onMouseOver="funcPopup(event,'isguestuser')">isguestuser</a>()
<a name="l152"><span class="linenum"> 152</span></a>                  or !<a class="function" onClick="logFunction('isloggedin')" href="../../_functions/isloggedin.html" onMouseOver="funcPopup(event,'isloggedin')">isloggedin</a>()) {
<a name="l153"><span class="linenum"> 153</span></a>              <a class="function" onClick="logFunction('print_error')" href="../../_functions/print_error.html" onMouseOver="funcPopup(event,'print_error')">print_error</a>('notpermittedtojump', 'mnet');
<a name="l154"><span class="linenum"> 154</span></a>          }
<a name="l155"><span class="linenum"> 155</span></a>  
<a name="l156"><span class="linenum"> 156</span></a>  <span class="comment">        // check for SSO publish permission first</span>
<a name="l157"><span class="linenum"> 157</span></a>          if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('has_service')" href="../../_functions/has_service.html" onMouseOver="funcPopup(event,'has_service')">has_service</a>(<a class="var it523" onMouseOver="hilite(523)" onMouseOut="lolite()" onClick="logVariable('mnethostid')" href="../../_variables/mnethostid.html">$mnethostid</a>, 'sso_sp') == false) {
<a name="l158"><span class="linenum"> 158</span></a>              <a class="function" onClick="logFunction('print_error')" href="../../_functions/print_error.html" onMouseOver="funcPopup(event,'print_error')">print_error</a>('hostnotconfiguredforsso', 'mnet');
<a name="l159"><span class="linenum"> 159</span></a>          }
<a name="l160"><span class="linenum"> 160</span></a>  
<a name="l161"><span class="linenum"> 161</span></a>  <span class="comment">        // set RPC timeout to 30 seconds if not configured</span>
<a name="l162"><span class="linenum"> 162</span></a>          if (empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('config')" class="var it39456" onMouseOver="hilite(39456)" onMouseOut="lolite()" href="../../_variables/config.html">config</a>-&gt;rpc_negotiation_timeout)) {
<a name="l163"><span class="linenum"> 163</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('config')" class="var it39456" onMouseOver="hilite(39456)" onMouseOut="lolite()" href="../../_variables/config.html">config</a>-&gt;rpc_negotiation_timeout = 30;
<a name="l164"><span class="linenum"> 164</span></a>              <a class="function" onClick="logFunction('set_config')" href="../../_functions/set_config.html" onMouseOver="funcPopup(event,'set_config')">set_config</a>('rpc_negotiation_timeout', '30', 'auth_mnet');
<a name="l165"><span class="linenum"> 165</span></a>          }
<a name="l166"><span class="linenum"> 166</span></a>  
<a name="l167"><span class="linenum"> 167</span></a>  <span class="comment">        // get the host info</span>
<a name="l168"><span class="linenum"> 168</span></a>          <a class="var it15854" onMouseOver="hilite(15854)" onMouseOut="lolite()" onClick="logVariable('mnet_peer')" href="../../_variables/mnet_peer.html">$mnet_peer</a> = <span class="keyword">new </span><a class="class" onClick="logClass('mnet_peer')" href="../../_classes/mnet_peer.html" onMouseOver="classPopup(event,'mnet_peer')">mnet_peer</a>();
<a name="l169"><span class="linenum"> 169</span></a>          <a class="var it15854" onMouseOver="hilite(15854)" onMouseOut="lolite()" onClick="logVariable('mnet_peer')" href="../../_variables/mnet_peer.html">$mnet_peer</a>-&gt;<a class="function" onClick="logFunction('set_id')" href="../../_functions/set_id.html" onMouseOver="funcPopup(event,'set_id')">set_id</a>(<a class="var it523" onMouseOver="hilite(523)" onMouseOut="lolite()" onClick="logVariable('mnethostid')" href="../../_variables/mnethostid.html">$mnethostid</a>);
<a name="l170"><span class="linenum"> 170</span></a>  
<a name="l171"><span class="linenum"> 171</span></a>  <span class="comment">        // set up the session</span>
<a name="l172"><span class="linenum"> 172</span></a>          <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('mnet_session',
<a name="l173"><span class="linenum"> 173</span></a>                                     array('userid'=&gt;<a class="var it9" onMouseOver="hilite(9)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>-&gt;<a onClick="logVariable('id')" class="var it39490" onMouseOver="hilite(39490)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, 'mnethostid'=&gt;<a class="var it523" onMouseOver="hilite(523)" onMouseOut="lolite()" onClick="logVariable('mnethostid')" href="../../_variables/mnethostid.html">$mnethostid</a>,
<a name="l174"><span class="linenum"> 174</span></a>                                     'useragent'=&gt;<a class="phpfunction" onClick="logFunction('sha1')" href="../../_functions/sha1.html" onMouseOver="phpfuncPopup(event,'sha1')">sha1</a>(<a class="var it74" onMouseOver="hilite(74)" onMouseOut="lolite()" onClick="logVariable('_SERVER')" href="../../_variables/_SERVER.html">$_SERVER</a>['HTTP_USER_AGENT'])));
<a name="l175"><span class="linenum"> 175</span></a>          if (<a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a> == false) {
<a name="l176"><span class="linenum"> 176</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a> = new stdClass();
<a name="l177"><span class="linenum"> 177</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('mnethostid')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/mnethostid.html">mnethostid</a> = <a class="var it523" onMouseOver="hilite(523)" onMouseOut="lolite()" onClick="logVariable('mnethostid')" href="../../_variables/mnethostid.html">$mnethostid</a>;
<a name="l178"><span class="linenum"> 178</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('userid')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> = <a class="var it9" onMouseOver="hilite(9)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>-&gt;<a onClick="logVariable('id')" class="var it39490" onMouseOver="hilite(39490)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l179"><span class="linenum"> 179</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('username')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/username.html">username</a> = <a class="var it9" onMouseOver="hilite(9)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>-&gt;<a onClick="logVariable('username')" class="var it39490" onMouseOver="hilite(39490)" onMouseOut="lolite()" href="../../_variables/username.html">username</a>;
<a name="l180"><span class="linenum"> 180</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('useragent')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/useragent.html">useragent</a> = <a class="phpfunction" onClick="logFunction('sha1')" href="../../_functions/sha1.html" onMouseOver="phpfuncPopup(event,'sha1')">sha1</a>(<a class="var it74" onMouseOver="hilite(74)" onMouseOut="lolite()" onClick="logVariable('_SERVER')" href="../../_variables/_SERVER.html">$_SERVER</a>['HTTP_USER_AGENT']);
<a name="l181"><span class="linenum"> 181</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('token')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/token.html">token</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('generate_token')" href="../../_functions/generate_token.html" onMouseOver="funcPopup(event,'generate_token')">generate_token</a>();
<a name="l182"><span class="linenum"> 182</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('confirm_timeout')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/confirm_timeout.html">confirm_timeout</a> = <a class="phpfunction" onClick="logFunction('time')" href="../../_functions/time.html" onMouseOver="phpfuncPopup(event,'time')">time</a>() + <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('config')" class="var it39456" onMouseOver="hilite(39456)" onMouseOut="lolite()" href="../../_variables/config.html">config</a>-&gt;rpc_negotiation_timeout;
<a name="l183"><span class="linenum"> 183</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('expires')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/expires.html">expires</a> = <a class="phpfunction" onClick="logFunction('time')" href="../../_functions/time.html" onMouseOver="phpfuncPopup(event,'time')">time</a>() + (integer)<a class="phpfunction" onClick="logFunction('ini_get')" href="../../_functions/ini_get.html" onMouseOver="phpfuncPopup(event,'ini_get')">ini_get</a>('session.gc_maxlifetime');
<a name="l184"><span class="linenum"> 184</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('session_id')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/session_id.html">session_id</a> = <a class="phpfunction" onClick="logFunction('session_id')" href="../../_functions/session_id.html" onMouseOver="phpfuncPopup(event,'session_id')">session_id</a>();
<a name="l185"><span class="linenum"> 185</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('id')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/id.html">id</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('mnet_session', <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>);
<a name="l186"><span class="linenum"> 186</span></a>          } else {
<a name="l187"><span class="linenum"> 187</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('useragent')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/useragent.html">useragent</a> = <a class="phpfunction" onClick="logFunction('sha1')" href="../../_functions/sha1.html" onMouseOver="phpfuncPopup(event,'sha1')">sha1</a>(<a class="var it74" onMouseOver="hilite(74)" onMouseOut="lolite()" onClick="logVariable('_SERVER')" href="../../_variables/_SERVER.html">$_SERVER</a>['HTTP_USER_AGENT']);
<a name="l188"><span class="linenum"> 188</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('token')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/token.html">token</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('generate_token')" href="../../_functions/generate_token.html" onMouseOver="funcPopup(event,'generate_token')">generate_token</a>();
<a name="l189"><span class="linenum"> 189</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('confirm_timeout')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/confirm_timeout.html">confirm_timeout</a> = <a class="phpfunction" onClick="logFunction('time')" href="../../_functions/time.html" onMouseOver="phpfuncPopup(event,'time')">time</a>() + <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('config')" class="var it39456" onMouseOver="hilite(39456)" onMouseOut="lolite()" href="../../_variables/config.html">config</a>-&gt;rpc_negotiation_timeout;
<a name="l190"><span class="linenum"> 190</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('expires')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/expires.html">expires</a> = <a class="phpfunction" onClick="logFunction('time')" href="../../_functions/time.html" onMouseOver="phpfuncPopup(event,'time')">time</a>() + (integer)<a class="phpfunction" onClick="logFunction('ini_get')" href="../../_functions/ini_get.html" onMouseOver="phpfuncPopup(event,'ini_get')">ini_get</a>('session.gc_maxlifetime');
<a name="l191"><span class="linenum"> 191</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('session_id')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/session_id.html">session_id</a> = <a class="phpfunction" onClick="logFunction('session_id')" href="../../_functions/session_id.html" onMouseOver="phpfuncPopup(event,'session_id')">session_id</a>();
<a name="l192"><span class="linenum"> 192</span></a>              <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('update_record')" href="../../_functions/update_record.html" onMouseOver="funcPopup(event,'update_record')">update_record</a>('mnet_session', <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>);
<a name="l193"><span class="linenum"> 193</span></a>          }
<a name="l194"><span class="linenum"> 194</span></a>  
<a name="l195"><span class="linenum"> 195</span></a>  <span class="comment">        // construct the redirection URL</span>
<a name="l196"><span class="linenum"> 196</span></a>  <span class="comment">        //$transport = mnet_get_protocol($mnet_peer-&gt;transport);</span>
<a name="l197"><span class="linenum"> 197</span></a>          <a class="var it4003" onMouseOver="hilite(4003)" onMouseOut="lolite()" onClick="logVariable('wantsurl')" href="../../_variables/wantsurl.html">$wantsurl</a> = <a class="phpfunction" onClick="logFunction('urlencode')" href="../../_functions/urlencode.html" onMouseOver="phpfuncPopup(event,'urlencode')">urlencode</a>(<a class="var it4003" onMouseOver="hilite(4003)" onMouseOut="lolite()" onClick="logVariable('wantsurl')" href="../../_variables/wantsurl.html">$wantsurl</a>);
<a name="l198"><span class="linenum"> 198</span></a>          <a class="var it122" onMouseOver="hilite(122)" onMouseOut="lolite()" onClick="logVariable('url')" href="../../_variables/url.html">$url</a> = &quot;{<a class="var it15854" onMouseOver="hilite(15854)" onMouseOut="lolite()" onClick="logVariable('mnet_peer')" href="../../_variables/mnet_peer.html">$mnet_peer</a>-&gt;<a onClick="logVariable('wwwroot')" class="var it39818" onMouseOver="hilite(39818)" onMouseOut="lolite()" href="../../_variables/wwwroot.html">wwwroot</a>}{<a class="var it15854" onMouseOver="hilite(15854)" onMouseOut="lolite()" onClick="logVariable('mnet_peer')" href="../../_variables/mnet_peer.html">$mnet_peer</a>-&gt;<a onClick="logVariable('application')" class="var it39818" onMouseOver="hilite(39818)" onMouseOut="lolite()" href="../../_variables/application.html">application</a>-&gt;sso_land_url}?token={<a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('token')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/token.html">token</a>}&amp;idp={<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('mnet')" class="var it39456" onMouseOver="hilite(39456)" onMouseOut="lolite()" href="../../_variables/mnet.html">mnet</a>-&gt;wwwroot}&amp;wantsurl={<a class="var it4003" onMouseOver="hilite(4003)" onMouseOut="lolite()" onClick="logVariable('wantsurl')" href="../../_variables/wantsurl.html">$wantsurl</a>}&quot;;
<a name="l199"><span class="linenum"> 199</span></a>          if (<a class="var it20768" onMouseOver="hilite(20768)" onMouseOut="lolite()" onClick="logVariable('wantsurlbackhere')" href="../../_variables/wantsurlbackhere.html">$wantsurlbackhere</a>) {
<a name="l200"><span class="linenum"> 200</span></a>              <a class="var it122" onMouseOver="hilite(122)" onMouseOut="lolite()" onClick="logVariable('url')" href="../../_variables/url.html">$url</a> .= '&amp;remoteurl=1';
<a name="l201"><span class="linenum"> 201</span></a>          }
<a name="l202"><span class="linenum"> 202</span></a>  
<a name="l203"><span class="linenum"> 203</span></a>          return <a class="var it122" onMouseOver="hilite(122)" onMouseOut="lolite()" onClick="logVariable('url')" href="../../_variables/url.html">$url</a>;
<a name="l204"><span class="linenum"> 204</span></a>      }
<a name="l205"><span class="linenum"> 205</span></a>  
<a name="l206"><span class="linenum"> 206</span></a>      <span class="comment">/**</span>
<a name="l207"><span class="linenum"> 207</span></a>  <span class="comment">     * This function confirms the remote (ID provider) host's mnet session</span>
<a name="l208"><span class="linenum"> 208</span></a>  <span class="comment">     * by communicating the token and UA over the XMLRPC transport layer, and</span>
<a name="l209"><span class="linenum"> 209</span></a>  <span class="comment">     * returns the local user record on success.</span>
<a name="l210"><span class="linenum"> 210</span></a>  <span class="comment">     *</span>
<a name="l211"><span class="linenum"> 211</span></a>  <span class="comment">     *   @param string    $token           The random session token.</span>
<a name="l212"><span class="linenum"> 212</span></a>  <span class="comment">     *   @param mnet_peer $remotepeer   The ID provider mnet_peer object.</span>
<a name="l213"><span class="linenum"> 213</span></a>  <span class="comment">     *   @return array The local user record.</span>
<a name="l214"><span class="linenum"> 214</span></a>  <span class="comment">     */</span>
<a name="l215"><span class="linenum"> 215</span></a>      function <a class="function" onClick="logFunction('confirm_mnet_session')" href="../../_functions/confirm_mnet_session.html" onMouseOver="funcPopup(event,'confirm_mnet_session')">confirm_mnet_session</a>(<a class="var it464" onMouseOver="hilite(464)" onMouseOut="lolite()" onClick="logVariable('token')" href="../../_variables/token.html">$token</a>, <a class="var it20769" onMouseOver="hilite(20769)" onMouseOut="lolite()" onClick="logVariable('remotepeer')" href="../../_variables/remotepeer.html">$remotepeer</a>) {
<a name="l216"><span class="linenum"> 216</span></a>          global <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l217"><span class="linenum"> 217</span></a>          require_once <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('dirroot')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/dirroot.html">dirroot</a> . '<a class="filename" href="../../mnet/xmlrpc/client.php.html">/mnet/xmlrpc/client.php</a>';
<a name="l218"><span class="linenum"> 218</span></a>          require_once <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('libdir')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/libdir.html">libdir</a> . '/gdlib.php';
<a name="l219"><span class="linenum"> 219</span></a>          require_once(<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('dirroot')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/dirroot.html">dirroot</a>.'<a class="filename" href="../../user/lib.php.html">/user/lib.php</a>');
<a name="l220"><span class="linenum"> 220</span></a>  
<a name="l221"><span class="linenum"> 221</span></a>  <span class="comment">        // verify the remote host is configured locally before attempting RPC call</span>
<a name="l222"><span class="linenum"> 222</span></a>          if (! <a class="var it20770" onMouseOver="hilite(20770)" onMouseOut="lolite()" onClick="logVariable('remotehost')" href="../../_variables/remotehost.html">$remotehost</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('mnet_host', array('wwwroot' =&gt; <a class="var it20769" onMouseOver="hilite(20769)" onMouseOut="lolite()" onClick="logVariable('remotepeer')" href="../../_variables/remotepeer.html">$remotepeer</a>-&gt;<a onClick="logVariable('wwwroot')" class="var it39819" onMouseOver="hilite(39819)" onMouseOut="lolite()" href="../../_variables/wwwroot.html">wwwroot</a>, 'deleted' =&gt; 0))) {
<a name="l223"><span class="linenum"> 223</span></a>              <a class="function" onClick="logFunction('print_error')" href="../../_functions/print_error.html" onMouseOver="funcPopup(event,'print_error')">print_error</a>('notpermittedtoland', 'mnet');
<a name="l224"><span class="linenum"> 224</span></a>          }
<a name="l225"><span class="linenum"> 225</span></a>  
<a name="l226"><span class="linenum"> 226</span></a>  <span class="comment">        // set up the RPC request</span>
<a name="l227"><span class="linenum"> 227</span></a>          <a class="var it6112" onMouseOver="hilite(6112)" onMouseOut="lolite()" onClick="logVariable('mnetrequest')" href="../../_variables/mnetrequest.html">$mnetrequest</a> = <span class="keyword">new </span><a class="class" onClick="logClass('mnet_xmlrpc_client')" href="../../_classes/mnet_xmlrpc_client.html" onMouseOver="classPopup(event,'mnet_xmlrpc_client')">mnet_xmlrpc_client</a>();
<a name="l228"><span class="linenum"> 228</span></a>          <a class="var it6112" onMouseOver="hilite(6112)" onMouseOut="lolite()" onClick="logVariable('mnetrequest')" href="../../_variables/mnetrequest.html">$mnetrequest</a>-&gt;<a class="function" onClick="logFunction('set_method')" href="../../_functions/set_method.html" onMouseOver="funcPopup(event,'set_method')">set_method</a>('auth/mnet/auth.php/user_authorise');
<a name="l229"><span class="linenum"> 229</span></a>  
<a name="l230"><span class="linenum"> 230</span></a>  <span class="comment">        // set $token and $useragent parameters</span>
<a name="l231"><span class="linenum"> 231</span></a>          <a class="var it6112" onMouseOver="hilite(6112)" onMouseOut="lolite()" onClick="logVariable('mnetrequest')" href="../../_variables/mnetrequest.html">$mnetrequest</a>-&gt;<a class="function" onClick="logFunction('add_param')" href="../../_functions/add_param.html" onMouseOver="funcPopup(event,'add_param')">add_param</a>(<a class="var it464" onMouseOver="hilite(464)" onMouseOut="lolite()" onClick="logVariable('token')" href="../../_variables/token.html">$token</a>);
<a name="l232"><span class="linenum"> 232</span></a>          <a class="var it6112" onMouseOver="hilite(6112)" onMouseOut="lolite()" onClick="logVariable('mnetrequest')" href="../../_variables/mnetrequest.html">$mnetrequest</a>-&gt;<a class="function" onClick="logFunction('add_param')" href="../../_functions/add_param.html" onMouseOver="funcPopup(event,'add_param')">add_param</a>(<a class="phpfunction" onClick="logFunction('sha1')" href="../../_functions/sha1.html" onMouseOver="phpfuncPopup(event,'sha1')">sha1</a>(<a class="var it74" onMouseOver="hilite(74)" onMouseOut="lolite()" onClick="logVariable('_SERVER')" href="../../_variables/_SERVER.html">$_SERVER</a>['HTTP_USER_AGENT']));
<a name="l233"><span class="linenum"> 233</span></a>  
<a name="l234"><span class="linenum"> 234</span></a>  <span class="comment">        // Thunderbirds are go! Do RPC call and store response</span>
<a name="l235"><span class="linenum"> 235</span></a>          if (<a class="var it6112" onMouseOver="hilite(6112)" onMouseOut="lolite()" onClick="logVariable('mnetrequest')" href="../../_variables/mnetrequest.html">$mnetrequest</a>-&gt;<a class="function" onClick="logFunction('send')" href="../../_functions/send.html" onMouseOver="funcPopup(event,'send')">send</a>(<a class="var it20769" onMouseOver="hilite(20769)" onMouseOut="lolite()" onClick="logVariable('remotepeer')" href="../../_variables/remotepeer.html">$remotepeer</a>) === true) {
<a name="l236"><span class="linenum"> 236</span></a>              <a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a> = (object) <a class="var it6112" onMouseOver="hilite(6112)" onMouseOut="lolite()" onClick="logVariable('mnetrequest')" href="../../_variables/mnetrequest.html">$mnetrequest</a>-&gt;<a onClick="logVariable('response')" class="var it39820" onMouseOver="hilite(39820)" onMouseOut="lolite()" href="../../_variables/response.html">response</a>;
<a name="l237"><span class="linenum"> 237</span></a>          } else {
<a name="l238"><span class="linenum"> 238</span></a>              foreach (<a class="var it6112" onMouseOver="hilite(6112)" onMouseOut="lolite()" onClick="logVariable('mnetrequest')" href="../../_variables/mnetrequest.html">$mnetrequest</a>-&gt;<a onClick="logVariable('error')" class="var it39820" onMouseOver="hilite(39820)" onMouseOut="lolite()" href="../../_variables/error.html">error</a> as <a class="var it3102" onMouseOver="hilite(3102)" onMouseOut="lolite()" onClick="logVariable('errormessage')" href="../../_variables/errormessage.html">$errormessage</a>) {
<a name="l239"><span class="linenum"> 239</span></a>                  <a class="function" onClick="logFunction('list')" href="../../_functions/list.html" onMouseOver="funcPopup(event,'list')">list</a>(<a class="var it2562" onMouseOver="hilite(2562)" onMouseOut="lolite()" onClick="logVariable('code')" href="../../_variables/code.html">$code</a>, <a class="var it643" onMouseOver="hilite(643)" onMouseOut="lolite()" onClick="logVariable('message')" href="../../_variables/message.html">$message</a>) = <a class="phpfunction" onClick="logFunction('array_map')" href="../../_functions/array_map.html" onMouseOver="phpfuncPopup(event,'array_map')">array_map</a>('trim',<a class="phpfunction" onClick="logFunction('explode')" href="../../_functions/explode.html" onMouseOver="phpfuncPopup(event,'explode')">explode</a>(':', <a class="var it3102" onMouseOver="hilite(3102)" onMouseOut="lolite()" onClick="logVariable('errormessage')" href="../../_variables/errormessage.html">$errormessage</a>, 2));
<a name="l240"><span class="linenum"> 240</span></a>                  if(<a class="var it2562" onMouseOver="hilite(2562)" onMouseOut="lolite()" onClick="logVariable('code')" href="../../_variables/code.html">$code</a> == 702) {
<a name="l241"><span class="linenum"> 241</span></a>                      <a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('site')" href="../../_variables/site.html">$site</a> = <a class="function" onClick="logFunction('get_site')" href="../../_functions/get_site.html" onMouseOver="funcPopup(event,'get_site')">get_site</a>();
<a name="l242"><span class="linenum"> 242</span></a>                      <a class="function" onClick="logFunction('print_error')" href="../../_functions/print_error.html" onMouseOver="funcPopup(event,'print_error')">print_error</a>('mnet_session_prohibited', 'mnet', <a class="var it20769" onMouseOver="hilite(20769)" onMouseOut="lolite()" onClick="logVariable('remotepeer')" href="../../_variables/remotepeer.html">$remotepeer</a>-&gt;<a onClick="logVariable('wwwroot')" class="var it39819" onMouseOver="hilite(39819)" onMouseOut="lolite()" href="../../_variables/wwwroot.html">wwwroot</a>, <a class="function" onClick="logFunction('format_string')" href="../../_functions/format_string.html" onMouseOver="funcPopup(event,'format_string')">format_string</a>(<a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('site')" href="../../_variables/site.html">$site</a>-&gt;<a onClick="logVariable('fullname')" class="var it39527" onMouseOver="hilite(39527)" onMouseOut="lolite()" href="../../_variables/fullname.html">fullname</a>));
<a name="l243"><span class="linenum"> 243</span></a>                      exit;
<a name="l244"><span class="linenum"> 244</span></a>                  }
<a name="l245"><span class="linenum"> 245</span></a>                  <a class="var it643" onMouseOver="hilite(643)" onMouseOut="lolite()" onClick="logVariable('message')" href="../../_variables/message.html">$message</a> .= &quot;ERROR <a class="var it2562" onMouseOver="hilite(2562)" onMouseOut="lolite()" onClick="logVariable('code')" href="../../_variables/code.html">$code</a>:&lt;br/&gt;<a class="var it3102" onMouseOver="hilite(3102)" onMouseOut="lolite()" onClick="logVariable('errormessage')" href="../../_variables/errormessage.html">$errormessage</a>&lt;br/&gt;&quot;;
<a name="l246"><span class="linenum"> 246</span></a>              }
<a name="l247"><span class="linenum"> 247</span></a>              <a class="function" onClick="logFunction('print_error')" href="../../_functions/print_error.html" onMouseOver="funcPopup(event,'print_error')">print_error</a>(&quot;rpcerror&quot;, '', '', <a class="var it643" onMouseOver="hilite(643)" onMouseOut="lolite()" onClick="logVariable('message')" href="../../_variables/message.html">$message</a>);
<a name="l248"><span class="linenum"> 248</span></a>          }
<a name="l249"><span class="linenum"> 249</span></a>          unset(<a class="var it6112" onMouseOver="hilite(6112)" onMouseOut="lolite()" onClick="logVariable('mnetrequest')" href="../../_variables/mnetrequest.html">$mnetrequest</a>);
<a name="l250"><span class="linenum"> 250</span></a>  
<a name="l251"><span class="linenum"> 251</span></a>          if (empty(<a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>) or empty(<a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>-&gt;<a onClick="logVariable('username')" class="var it39821" onMouseOver="hilite(39821)" onMouseOut="lolite()" href="../../_variables/username.html">username</a>)) {
<a name="l252"><span class="linenum"> 252</span></a>              <a class="function" onClick="logFunction('print_error')" href="../../_functions/print_error.html" onMouseOver="funcPopup(event,'print_error')">print_error</a>('unknownerror', 'mnet');
<a name="l253"><span class="linenum"> 253</span></a>              exit;
<a name="l254"><span class="linenum"> 254</span></a>          }
<a name="l255"><span class="linenum"> 255</span></a>  
<a name="l256"><span class="linenum"> 256</span></a>          if (<a class="function" onClick="logFunction('user_not_fully_set_up')" href="../../_functions/user_not_fully_set_up.html" onMouseOver="funcPopup(event,'user_not_fully_set_up')">user_not_fully_set_up</a>(<a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>)) {
<a name="l257"><span class="linenum"> 257</span></a>              <a class="function" onClick="logFunction('print_error')" href="../../_functions/print_error.html" onMouseOver="funcPopup(event,'print_error')">print_error</a>('notenoughidpinfo', 'mnet');
<a name="l258"><span class="linenum"> 258</span></a>              exit;
<a name="l259"><span class="linenum"> 259</span></a>          }
<a name="l260"><span class="linenum"> 260</span></a>  
<a name="l261"><span class="linenum"> 261</span></a>          <a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a> = <a class="function" onClick="logFunction('mnet_strip_user')" href="../../_functions/mnet_strip_user.html" onMouseOver="funcPopup(event,'mnet_strip_user')">mnet_strip_user</a>(<a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>, <a class="function" onClick="logFunction('mnet_fields_to_import')" href="../../_functions/mnet_fields_to_import.html" onMouseOver="funcPopup(event,'mnet_fields_to_import')">mnet_fields_to_import</a>(<a class="var it20769" onMouseOver="hilite(20769)" onMouseOut="lolite()" onClick="logVariable('remotepeer')" href="../../_variables/remotepeer.html">$remotepeer</a>));
<a name="l262"><span class="linenum"> 262</span></a>  
<a name="l263"><span class="linenum"> 263</span></a>          <a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>-&gt;<a onClick="logVariable('auth')" class="var it39821" onMouseOver="hilite(39821)" onMouseOut="lolite()" href="../../_variables/auth.html">auth</a> = 'mnet';
<a name="l264"><span class="linenum"> 264</span></a>          <a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>-&gt;<a onClick="logVariable('wwwroot')" class="var it39821" onMouseOver="hilite(39821)" onMouseOut="lolite()" href="../../_variables/wwwroot.html">wwwroot</a> = <a class="var it20769" onMouseOver="hilite(20769)" onMouseOut="lolite()" onClick="logVariable('remotepeer')" href="../../_variables/remotepeer.html">$remotepeer</a>-&gt;<a onClick="logVariable('wwwroot')" class="var it39819" onMouseOver="hilite(39819)" onMouseOut="lolite()" href="../../_variables/wwwroot.html">wwwroot</a>;
<a name="l265"><span class="linenum"> 265</span></a>  
<a name="l266"><span class="linenum"> 266</span></a>  <span class="comment">        // the user may roam from Moodle 1.x where lang has _utf8 suffix</span>
<a name="l267"><span class="linenum"> 267</span></a>  <span class="comment">        // also, make sure that the lang is actually installed, otherwise set site default</span>
<a name="l268"><span class="linenum"> 268</span></a>          if (isset(<a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>-&gt;<a onClick="logVariable('lang')" class="var it39821" onMouseOver="hilite(39821)" onMouseOut="lolite()" href="../../_variables/lang.html">lang</a>)) {
<a name="l269"><span class="linenum"> 269</span></a>              <a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>-&gt;<a onClick="logVariable('lang')" class="var it39821" onMouseOver="hilite(39821)" onMouseOut="lolite()" href="../../_variables/lang.html">lang</a> = <a class="function" onClick="logFunction('clean_param')" href="../../_functions/clean_param.html" onMouseOver="funcPopup(event,'clean_param')">clean_param</a>(<a class="phpfunction" onClick="logFunction('str_replace')" href="../../_functions/str_replace.html" onMouseOver="phpfuncPopup(event,'str_replace')">str_replace</a>('_utf8', '', <a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>-&gt;<a onClick="logVariable('lang')" class="var it39821" onMouseOver="hilite(39821)" onMouseOut="lolite()" href="../../_variables/lang.html">lang</a>), <a class="constant" onClick="logConstant('PARAM_LANG')" href="../../_constants/PARAM_LANG.html" onMouseOver="constPopup(event,'PARAM_LANG')">PARAM_LANG</a>);
<a name="l270"><span class="linenum"> 270</span></a>          }
<a name="l271"><span class="linenum"> 271</span></a>          if (empty(<a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>-&gt;<a onClick="logVariable('lang')" class="var it39821" onMouseOver="hilite(39821)" onMouseOut="lolite()" href="../../_variables/lang.html">lang</a>)) {
<a name="l272"><span class="linenum"> 272</span></a>              if (!empty(<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('lang')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/lang.html">lang</a>)) {
<a name="l273"><span class="linenum"> 273</span></a>                  <a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>-&gt;<a onClick="logVariable('lang')" class="var it39821" onMouseOver="hilite(39821)" onMouseOut="lolite()" href="../../_variables/lang.html">lang</a> = <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('lang')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/lang.html">lang</a>;
<a name="l274"><span class="linenum"> 274</span></a>              } else {
<a name="l275"><span class="linenum"> 275</span></a>                  <a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>-&gt;<a onClick="logVariable('lang')" class="var it39821" onMouseOver="hilite(39821)" onMouseOut="lolite()" href="../../_variables/lang.html">lang</a> = 'en';
<a name="l276"><span class="linenum"> 276</span></a>              }
<a name="l277"><span class="linenum"> 277</span></a>          }
<a name="l278"><span class="linenum"> 278</span></a>          <a class="var it20771" onMouseOver="hilite(20771)" onMouseOut="lolite()" onClick="logVariable('firsttime')" href="../../_variables/firsttime.html">$firsttime</a> = false;
<a name="l279"><span class="linenum"> 279</span></a>  
<a name="l280"><span class="linenum"> 280</span></a>  <span class="comment">        // get the local record for the remote user</span>
<a name="l281"><span class="linenum"> 281</span></a>          <a class="var it20772" onMouseOver="hilite(20772)" onMouseOut="lolite()" onClick="logVariable('localuser')" href="../../_variables/localuser.html">$localuser</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('user', array('username'=&gt;<a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>-&gt;<a onClick="logVariable('username')" class="var it39821" onMouseOver="hilite(39821)" onMouseOut="lolite()" href="../../_variables/username.html">username</a>, 'mnethostid'=&gt;<a class="var it20770" onMouseOver="hilite(20770)" onMouseOut="lolite()" onClick="logVariable('remotehost')" href="../../_variables/remotehost.html">$remotehost</a>-&gt;<a onClick="logVariable('id')" class="var it39822" onMouseOver="hilite(39822)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>));
<a name="l282"><span class="linenum"> 282</span></a>  
<a name="l283"><span class="linenum"> 283</span></a>  <span class="comment">        // add the remote user to the database if necessary, and if allowed</span>
<a name="l284"><span class="linenum"> 284</span></a>  <span class="comment">        // TODO: refactor into a separate function</span>
<a name="l285"><span class="linenum"> 285</span></a>          if (empty(<a class="var it20772" onMouseOver="hilite(20772)" onMouseOut="lolite()" onClick="logVariable('localuser')" href="../../_variables/localuser.html">$localuser</a>) || ! <a class="var it20772" onMouseOver="hilite(20772)" onMouseOut="lolite()" onClick="logVariable('localuser')" href="../../_variables/localuser.html">$localuser</a>-&gt;<a onClick="logVariable('id')" class="var it39823" onMouseOver="hilite(39823)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>) {
<a name="l286"><span class="linenum"> 286</span></a>              <span class="comment">/*</span>
<a name="l287"><span class="linenum"> 287</span></a>  <span class="comment">            if (empty($this-&gt;config-&gt;auto_add_remote_users)) {</span>
<a name="l288"><span class="linenum"> 288</span></a>  <span class="comment">                print_error('nolocaluser', 'mnet');</span>
<a name="l289"><span class="linenum"> 289</span></a>  <span class="comment">            } See MDL-21327   for why this is commented out</span>
<a name="l290"><span class="linenum"> 290</span></a>  <span class="comment">            */</span>
<a name="l291"><span class="linenum"> 291</span></a>              <a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>-&gt;<a onClick="logVariable('mnethostid')" class="var it39821" onMouseOver="hilite(39821)" onMouseOut="lolite()" href="../../_variables/mnethostid.html">mnethostid</a> = <a class="var it20770" onMouseOver="hilite(20770)" onMouseOut="lolite()" onClick="logVariable('remotehost')" href="../../_variables/remotehost.html">$remotehost</a>-&gt;<a onClick="logVariable('id')" class="var it39822" onMouseOver="hilite(39822)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l292"><span class="linenum"> 292</span></a>              <a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>-&gt;<a onClick="logVariable('firstaccess')" class="var it39821" onMouseOver="hilite(39821)" onMouseOut="lolite()" href="../../_variables/firstaccess.html">firstaccess</a> = 0;
<a name="l293"><span class="linenum"> 293</span></a>              <a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>-&gt;<a onClick="logVariable('confirmed')" class="var it39821" onMouseOver="hilite(39821)" onMouseOut="lolite()" href="../../_variables/confirmed.html">confirmed</a> = 1;
<a name="l294"><span class="linenum"> 294</span></a>  
<a name="l295"><span class="linenum"> 295</span></a>              <a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>-&gt;<a onClick="logVariable('id')" class="var it39821" onMouseOver="hilite(39821)" onMouseOut="lolite()" href="../../_variables/id.html">id</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('user', <a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>);
<a name="l296"><span class="linenum"> 296</span></a>              <a class="var it20771" onMouseOver="hilite(20771)" onMouseOut="lolite()" onClick="logVariable('firsttime')" href="../../_variables/firsttime.html">$firsttime</a> = true;
<a name="l297"><span class="linenum"> 297</span></a>              <a class="var it20772" onMouseOver="hilite(20772)" onMouseOut="lolite()" onClick="logVariable('localuser')" href="../../_variables/localuser.html">$localuser</a> = <a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>;
<a name="l298"><span class="linenum"> 298</span></a>          }
<a name="l299"><span class="linenum"> 299</span></a>  
<a name="l300"><span class="linenum"> 300</span></a>  <span class="comment">        // check sso access control list for permission first</span>
<a name="l301"><span class="linenum"> 301</span></a>          if (!<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('can_login_remotely')" href="../../_functions/can_login_remotely.html" onMouseOver="funcPopup(event,'can_login_remotely')">can_login_remotely</a>(<a class="var it20772" onMouseOver="hilite(20772)" onMouseOut="lolite()" onClick="logVariable('localuser')" href="../../_variables/localuser.html">$localuser</a>-&gt;<a onClick="logVariable('username')" class="var it39823" onMouseOver="hilite(39823)" onMouseOut="lolite()" href="../../_variables/username.html">username</a>, <a class="var it20770" onMouseOver="hilite(20770)" onMouseOut="lolite()" onClick="logVariable('remotehost')" href="../../_variables/remotehost.html">$remotehost</a>-&gt;<a onClick="logVariable('id')" class="var it39822" onMouseOver="hilite(39822)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>)) {
<a name="l302"><span class="linenum"> 302</span></a>              <a class="function" onClick="logFunction('print_error')" href="../../_functions/print_error.html" onMouseOver="funcPopup(event,'print_error')">print_error</a>('sso_mnet_login_refused', 'mnet', '', array('user'=&gt;<a class="var it20772" onMouseOver="hilite(20772)" onMouseOut="lolite()" onClick="logVariable('localuser')" href="../../_variables/localuser.html">$localuser</a>-&gt;<a onClick="logVariable('username')" class="var it39823" onMouseOver="hilite(39823)" onMouseOut="lolite()" href="../../_variables/username.html">username</a>, 'host'=&gt;<a class="var it20770" onMouseOver="hilite(20770)" onMouseOut="lolite()" onClick="logVariable('remotehost')" href="../../_variables/remotehost.html">$remotehost</a>-&gt;<a onClick="logVariable('name')" class="var it39822" onMouseOver="hilite(39822)" onMouseOut="lolite()" href="../../_variables/name.html">name</a>));
<a name="l303"><span class="linenum"> 303</span></a>          }
<a name="l304"><span class="linenum"> 304</span></a>  
<a name="l305"><span class="linenum"> 305</span></a>          <a class="var it586" onMouseOver="hilite(586)" onMouseOut="lolite()" onClick="logVariable('fs')" href="../../_variables/fs.html">$fs</a> = <a class="function" onClick="logFunction('get_file_storage')" href="../../_functions/get_file_storage.html" onMouseOver="funcPopup(event,'get_file_storage')">get_file_storage</a>();
<a name="l306"><span class="linenum"> 306</span></a>  
<a name="l307"><span class="linenum"> 307</span></a>  <span class="comment">        // update the local user record with remote user data</span>
<a name="l308"><span class="linenum"> 308</span></a>          foreach ((array) <a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a> as <a class="var it36" onMouseOver="hilite(36)" onMouseOut="lolite()" onClick="logVariable('key')" href="../../_variables/key.html">$key</a> =&gt; <a class="var it1140" onMouseOver="hilite(1140)" onMouseOut="lolite()" onClick="logVariable('val')" href="../../_variables/val.html">$val</a>) {
<a name="l309"><span class="linenum"> 309</span></a>  
<a name="l310"><span class="linenum"> 310</span></a>              if (<a class="var it36" onMouseOver="hilite(36)" onMouseOut="lolite()" onClick="logVariable('key')" href="../../_variables/key.html">$key</a> == '_mnet_userpicture_timemodified' and empty(<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('disableuserimages')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/disableuserimages.html">disableuserimages</a>) and isset(<a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>-&gt;<a onClick="logVariable('picture')" class="var it39821" onMouseOver="hilite(39821)" onMouseOut="lolite()" href="../../_variables/picture.html">picture</a>)) {
<a name="l311"><span class="linenum"> 311</span></a>  <span class="comment">                // update the user picture if there is a newer verion at the identity provider</span>
<a name="l312"><span class="linenum"> 312</span></a>                  <a class="var it1419" onMouseOver="hilite(1419)" onMouseOut="lolite()" onClick="logVariable('usercontext')" href="../../_variables/usercontext.html">$usercontext</a> = <a class="class" onClick="logClass('context_user')" href="../../_classes/context_user.html" onMouseOver="classPopup(event,'context_user')">context_user</a>::<a class="function" onClick="logFunction('instance')" href="../../_functions/instance.html" onMouseOver="funcPopup(event,'instance')">instance</a>(<a class="var it20772" onMouseOver="hilite(20772)" onMouseOut="lolite()" onClick="logVariable('localuser')" href="../../_variables/localuser.html">$localuser</a>-&gt;<a onClick="logVariable('id')" class="var it39823" onMouseOver="hilite(39823)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, <a class="constant" onClick="logConstant('MUST_EXIST')" href="../../_constants/MUST_EXIST.html" onMouseOver="constPopup(event,'MUST_EXIST')">MUST_EXIST</a>);
<a name="l313"><span class="linenum"> 313</span></a>                  if (<a class="var it20767" onMouseOver="hilite(20767)" onMouseOut="lolite()" onClick="logVariable('usericonfile')" href="../../_variables/usericonfile.html">$usericonfile</a> = <a class="var it586" onMouseOver="hilite(586)" onMouseOut="lolite()" onClick="logVariable('fs')" href="../../_variables/fs.html">$fs</a>-&gt;<a class="function" onClick="logFunction('get_file')" href="../../_functions/get_file.html" onMouseOver="funcPopup(event,'get_file')">get_file</a>(<a class="var it1419" onMouseOver="hilite(1419)" onMouseOut="lolite()" onClick="logVariable('usercontext')" href="../../_variables/usercontext.html">$usercontext</a>-&gt;<a onClick="logVariable('id')" class="var it39494" onMouseOver="hilite(39494)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, 'user', 'icon', 0, '/', 'f1.png')) {
<a name="l314"><span class="linenum"> 314</span></a>                      <a class="var it20773" onMouseOver="hilite(20773)" onMouseOut="lolite()" onClick="logVariable('localtimemodified')" href="../../_variables/localtimemodified.html">$localtimemodified</a> = <a class="var it20767" onMouseOver="hilite(20767)" onMouseOut="lolite()" onClick="logVariable('usericonfile')" href="../../_variables/usericonfile.html">$usericonfile</a>-&gt;<a class="function" onClick="logFunction('get_timemodified')" href="../../_functions/get_timemodified.html" onMouseOver="funcPopup(event,'get_timemodified')">get_timemodified</a>();
<a name="l315"><span class="linenum"> 315</span></a>                  } else if (<a class="var it20767" onMouseOver="hilite(20767)" onMouseOut="lolite()" onClick="logVariable('usericonfile')" href="../../_variables/usericonfile.html">$usericonfile</a> = <a class="var it586" onMouseOver="hilite(586)" onMouseOut="lolite()" onClick="logVariable('fs')" href="../../_variables/fs.html">$fs</a>-&gt;<a class="function" onClick="logFunction('get_file')" href="../../_functions/get_file.html" onMouseOver="funcPopup(event,'get_file')">get_file</a>(<a class="var it1419" onMouseOver="hilite(1419)" onMouseOut="lolite()" onClick="logVariable('usercontext')" href="../../_variables/usercontext.html">$usercontext</a>-&gt;<a onClick="logVariable('id')" class="var it39494" onMouseOver="hilite(39494)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, 'user', 'icon', 0, '/', 'f1.jpg')) {
<a name="l316"><span class="linenum"> 316</span></a>                      <a class="var it20773" onMouseOver="hilite(20773)" onMouseOut="lolite()" onClick="logVariable('localtimemodified')" href="../../_variables/localtimemodified.html">$localtimemodified</a> = <a class="var it20767" onMouseOver="hilite(20767)" onMouseOut="lolite()" onClick="logVariable('usericonfile')" href="../../_variables/usericonfile.html">$usericonfile</a>-&gt;<a class="function" onClick="logFunction('get_timemodified')" href="../../_functions/get_timemodified.html" onMouseOver="funcPopup(event,'get_timemodified')">get_timemodified</a>();
<a name="l317"><span class="linenum"> 317</span></a>                  } else {
<a name="l318"><span class="linenum"> 318</span></a>                      <a class="var it20773" onMouseOver="hilite(20773)" onMouseOut="lolite()" onClick="logVariable('localtimemodified')" href="../../_variables/localtimemodified.html">$localtimemodified</a> = 0;
<a name="l319"><span class="linenum"> 319</span></a>                  }
<a name="l320"><span class="linenum"> 320</span></a>  
<a name="l321"><span class="linenum"> 321</span></a>                  if (!empty(<a class="var it1140" onMouseOver="hilite(1140)" onMouseOut="lolite()" onClick="logVariable('val')" href="../../_variables/val.html">$val</a>) and <a class="var it20773" onMouseOver="hilite(20773)" onMouseOut="lolite()" onClick="logVariable('localtimemodified')" href="../../_variables/localtimemodified.html">$localtimemodified</a> &lt; <a class="var it1140" onMouseOver="hilite(1140)" onMouseOut="lolite()" onClick="logVariable('val')" href="../../_variables/val.html">$val</a>) {
<a name="l322"><span class="linenum"> 322</span></a>                      <a class="function" onClick="logFunction('mnet_debug')" href="../../_functions/mnet_debug.html" onMouseOver="funcPopup(event,'mnet_debug')">mnet_debug</a>('refetching the user picture from the identity provider host');
<a name="l323"><span class="linenum"> 323</span></a>                      <a class="var it20774" onMouseOver="hilite(20774)" onMouseOut="lolite()" onClick="logVariable('fetchrequest')" href="../../_variables/fetchrequest.html">$fetchrequest</a> = <span class="keyword">new </span><a class="class" onClick="logClass('mnet_xmlrpc_client')" href="../../_classes/mnet_xmlrpc_client.html" onMouseOver="classPopup(event,'mnet_xmlrpc_client')">mnet_xmlrpc_client</a>();
<a name="l324"><span class="linenum"> 324</span></a>                      <a class="var it20774" onMouseOver="hilite(20774)" onMouseOut="lolite()" onClick="logVariable('fetchrequest')" href="../../_variables/fetchrequest.html">$fetchrequest</a>-&gt;<a class="function" onClick="logFunction('set_method')" href="../../_functions/set_method.html" onMouseOver="funcPopup(event,'set_method')">set_method</a>('auth/mnet/auth.php/fetch_user_image');
<a name="l325"><span class="linenum"> 325</span></a>                      <a class="var it20774" onMouseOver="hilite(20774)" onMouseOut="lolite()" onClick="logVariable('fetchrequest')" href="../../_variables/fetchrequest.html">$fetchrequest</a>-&gt;<a class="function" onClick="logFunction('add_param')" href="../../_functions/add_param.html" onMouseOver="funcPopup(event,'add_param')">add_param</a>(<a class="var it20772" onMouseOver="hilite(20772)" onMouseOut="lolite()" onClick="logVariable('localuser')" href="../../_variables/localuser.html">$localuser</a>-&gt;<a onClick="logVariable('username')" class="var it39823" onMouseOver="hilite(39823)" onMouseOut="lolite()" href="../../_variables/username.html">username</a>);
<a name="l326"><span class="linenum"> 326</span></a>                      if (<a class="var it20774" onMouseOver="hilite(20774)" onMouseOut="lolite()" onClick="logVariable('fetchrequest')" href="../../_variables/fetchrequest.html">$fetchrequest</a>-&gt;<a class="function" onClick="logFunction('send')" href="../../_functions/send.html" onMouseOver="funcPopup(event,'send')">send</a>(<a class="var it20769" onMouseOver="hilite(20769)" onMouseOut="lolite()" onClick="logVariable('remotepeer')" href="../../_variables/remotepeer.html">$remotepeer</a>) === true) {
<a name="l327"><span class="linenum"> 327</span></a>                          if (<a class="function" onClick="logFunction('strlen')" href="../../_functions/strlen.html" onMouseOver="funcPopup(event,'strlen')">strlen</a>(<a class="var it20774" onMouseOver="hilite(20774)" onMouseOut="lolite()" onClick="logVariable('fetchrequest')" href="../../_variables/fetchrequest.html">$fetchrequest</a>-&gt;<a onClick="logVariable('response')" class="var it39824" onMouseOver="hilite(39824)" onMouseOut="lolite()" href="../../_variables/response.html">response</a>['f1']) &gt; 0) {
<a name="l328"><span class="linenum"> 328</span></a>                              <a class="var it20775" onMouseOver="hilite(20775)" onMouseOut="lolite()" onClick="logVariable('imagefilename')" href="../../_variables/imagefilename.html">$imagefilename</a> = <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('tempdir')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/tempdir.html">tempdir</a> . '/mnet-usericon-' . <a class="var it20772" onMouseOver="hilite(20772)" onMouseOut="lolite()" onClick="logVariable('localuser')" href="../../_variables/localuser.html">$localuser</a>-&gt;<a onClick="logVariable('id')" class="var it39823" onMouseOver="hilite(39823)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l329"><span class="linenum"> 329</span></a>                              <a class="var it20776" onMouseOver="hilite(20776)" onMouseOut="lolite()" onClick="logVariable('imagecontents')" href="../../_variables/imagecontents.html">$imagecontents</a> = <a class="phpfunction" onClick="logFunction('base64_decode')" href="../../_functions/base64_decode.html" onMouseOver="phpfuncPopup(event,'base64_decode')">base64_decode</a>(<a class="var it20774" onMouseOver="hilite(20774)" onMouseOut="lolite()" onClick="logVariable('fetchrequest')" href="../../_variables/fetchrequest.html">$fetchrequest</a>-&gt;<a onClick="logVariable('response')" class="var it39824" onMouseOver="hilite(39824)" onMouseOut="lolite()" href="../../_variables/response.html">response</a>['f1']);
<a name="l330"><span class="linenum"> 330</span></a>                              <a class="phpfunction" onClick="logFunction('file_put_contents')" href="../../_functions/file_put_contents.html" onMouseOver="phpfuncPopup(event,'file_put_contents')">file_put_contents</a>(<a class="var it20775" onMouseOver="hilite(20775)" onMouseOut="lolite()" onClick="logVariable('imagefilename')" href="../../_variables/imagefilename.html">$imagefilename</a>, <a class="var it20776" onMouseOver="hilite(20776)" onMouseOut="lolite()" onClick="logVariable('imagecontents')" href="../../_variables/imagecontents.html">$imagecontents</a>);
<a name="l331"><span class="linenum"> 331</span></a>                              if (<a class="var it19099" onMouseOver="hilite(19099)" onMouseOut="lolite()" onClick="logVariable('newrev')" href="../../_variables/newrev.html">$newrev</a> = <a class="function" onClick="logFunction('process_new_icon')" href="../../_functions/process_new_icon.html" onMouseOver="funcPopup(event,'process_new_icon')">process_new_icon</a>(<a class="var it1419" onMouseOver="hilite(1419)" onMouseOut="lolite()" onClick="logVariable('usercontext')" href="../../_variables/usercontext.html">$usercontext</a>, 'user', 'icon', 0, <a class="var it20775" onMouseOver="hilite(20775)" onMouseOut="lolite()" onClick="logVariable('imagefilename')" href="../../_variables/imagefilename.html">$imagefilename</a>)) {
<a name="l332"><span class="linenum"> 332</span></a>                                  <a class="var it20772" onMouseOver="hilite(20772)" onMouseOut="lolite()" onClick="logVariable('localuser')" href="../../_variables/localuser.html">$localuser</a>-&gt;<a onClick="logVariable('picture')" class="var it39823" onMouseOver="hilite(39823)" onMouseOut="lolite()" href="../../_variables/picture.html">picture</a> = <a class="var it19099" onMouseOver="hilite(19099)" onMouseOut="lolite()" onClick="logVariable('newrev')" href="../../_variables/newrev.html">$newrev</a>;
<a name="l333"><span class="linenum"> 333</span></a>                              }
<a name="l334"><span class="linenum"> 334</span></a>                              <a class="phpfunction" onClick="logFunction('unlink')" href="../../_functions/unlink.html" onMouseOver="phpfuncPopup(event,'unlink')">unlink</a>(<a class="var it20775" onMouseOver="hilite(20775)" onMouseOut="lolite()" onClick="logVariable('imagefilename')" href="../../_variables/imagefilename.html">$imagefilename</a>);
<a name="l335"><span class="linenum"> 335</span></a>                          }
<a name="l336"><span class="linenum"> 336</span></a>  <span class="comment">                        // note that since Moodle 2.0 we ignore $fetchrequest-&gt;response['f2']</span>
<a name="l337"><span class="linenum"> 337</span></a>  <span class="comment">                        // the mimetype information provided is ignored and the type of the file is detected</span>
<a name="l338"><span class="linenum"> 338</span></a>  <span class="comment">                        // by process_new_icon()</span>
<a name="l339"><span class="linenum"> 339</span></a>                      }
<a name="l340"><span class="linenum"> 340</span></a>                  }
<a name="l341"><span class="linenum"> 341</span></a>              }
<a name="l342"><span class="linenum"> 342</span></a>  
<a name="l343"><span class="linenum"> 343</span></a>              if(<a class="var it36" onMouseOver="hilite(36)" onMouseOut="lolite()" onClick="logVariable('key')" href="../../_variables/key.html">$key</a> == 'myhosts') {
<a name="l344"><span class="linenum"> 344</span></a>                  <a class="var it20772" onMouseOver="hilite(20772)" onMouseOut="lolite()" onClick="logVariable('localuser')" href="../../_variables/localuser.html">$localuser</a>-&gt;<a onClick="logVariable('mnet_foreign_host_array')" class="var it39823" onMouseOver="hilite(39823)" onMouseOut="lolite()" href="../../_variables/mnet_foreign_host_array.html">mnet_foreign_host_array</a> = array();
<a name="l345"><span class="linenum"> 345</span></a>                  foreach(<a class="var it1140" onMouseOver="hilite(1140)" onMouseOut="lolite()" onClick="logVariable('val')" href="../../_variables/val.html">$val</a> as <a class="var it20777" onMouseOver="hilite(20777)" onMouseOut="lolite()" onClick="logVariable('rhost')" href="../../_variables/rhost.html">$rhost</a>) {
<a name="l346"><span class="linenum"> 346</span></a>                      <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('name')" href="../../_variables/name.html">$name</a>  = <a class="function" onClick="logFunction('clean_param')" href="../../_functions/clean_param.html" onMouseOver="funcPopup(event,'clean_param')">clean_param</a>(<a class="var it20777" onMouseOver="hilite(20777)" onMouseOut="lolite()" onClick="logVariable('rhost')" href="../../_variables/rhost.html">$rhost</a>['name'], <a class="constant" onClick="logConstant('PARAM_ALPHANUM')" href="../../_constants/PARAM_ALPHANUM.html" onMouseOver="constPopup(event,'PARAM_ALPHANUM')">PARAM_ALPHANUM</a>);
<a name="l347"><span class="linenum"> 347</span></a>                      <a class="var it122" onMouseOver="hilite(122)" onMouseOut="lolite()" onClick="logVariable('url')" href="../../_variables/url.html">$url</a>   = <a class="function" onClick="logFunction('clean_param')" href="../../_functions/clean_param.html" onMouseOver="funcPopup(event,'clean_param')">clean_param</a>(<a class="var it20777" onMouseOver="hilite(20777)" onMouseOut="lolite()" onClick="logVariable('rhost')" href="../../_variables/rhost.html">$rhost</a>['url'], <a class="constant" onClick="logConstant('PARAM_URL')" href="../../_constants/PARAM_URL.html" onMouseOver="constPopup(event,'PARAM_URL')">PARAM_URL</a>);
<a name="l348"><span class="linenum"> 348</span></a>                      <a class="var it441" onMouseOver="hilite(441)" onMouseOut="lolite()" onClick="logVariable('count')" href="../../_variables/count.html">$count</a> = <a class="function" onClick="logFunction('clean_param')" href="../../_functions/clean_param.html" onMouseOver="funcPopup(event,'clean_param')">clean_param</a>(<a class="var it20777" onMouseOver="hilite(20777)" onMouseOut="lolite()" onClick="logVariable('rhost')" href="../../_variables/rhost.html">$rhost</a>['count'], <a class="constant" onClick="logConstant('PARAM_INT')" href="../../_constants/PARAM_INT.html" onMouseOver="constPopup(event,'PARAM_INT')">PARAM_INT</a>);
<a name="l349"><span class="linenum"> 349</span></a>                      <a class="var it20778" onMouseOver="hilite(20778)" onMouseOut="lolite()" onClick="logVariable('url_is_local')" href="../../_variables/url_is_local.html">$url_is_local</a> = <a class="phpfunction" onClick="logFunction('stristr')" href="../../_functions/stristr.html" onMouseOver="phpfuncPopup(event,'stristr')">stristr</a>(<a class="var it122" onMouseOver="hilite(122)" onMouseOut="lolite()" onClick="logVariable('url')" href="../../_variables/url.html">$url</a> , <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('wwwroot')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/wwwroot.html">wwwroot</a>);
<a name="l350"><span class="linenum"> 350</span></a>                      if (!empty(<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('name')" href="../../_variables/name.html">$name</a>) &amp;&amp; !empty(<a class="var it441" onMouseOver="hilite(441)" onMouseOut="lolite()" onClick="logVariable('count')" href="../../_variables/count.html">$count</a>) &amp;&amp; empty(<a class="var it20778" onMouseOver="hilite(20778)" onMouseOut="lolite()" onClick="logVariable('url_is_local')" href="../../_variables/url_is_local.html">$url_is_local</a>)) {
<a name="l351"><span class="linenum"> 351</span></a>                          <a class="var it20772" onMouseOver="hilite(20772)" onMouseOut="lolite()" onClick="logVariable('localuser')" href="../../_variables/localuser.html">$localuser</a>-&gt;<a onClick="logVariable('mnet_foreign_host_array')" class="var it39823" onMouseOver="hilite(39823)" onMouseOut="lolite()" href="../../_variables/mnet_foreign_host_array.html">mnet_foreign_host_array</a>[] = array('name'  =&gt; <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('name')" href="../../_variables/name.html">$name</a>,
<a name="l352"><span class="linenum"> 352</span></a>                                                                        'url'   =&gt; <a class="var it122" onMouseOver="hilite(122)" onMouseOut="lolite()" onClick="logVariable('url')" href="../../_variables/url.html">$url</a>,
<a name="l353"><span class="linenum"> 353</span></a>                                                                        'count' =&gt; <a class="var it441" onMouseOver="hilite(441)" onMouseOut="lolite()" onClick="logVariable('count')" href="../../_variables/count.html">$count</a>);
<a name="l354"><span class="linenum"> 354</span></a>                      }
<a name="l355"><span class="linenum"> 355</span></a>                  }
<a name="l356"><span class="linenum"> 356</span></a>              }
<a name="l357"><span class="linenum"> 357</span></a>  
<a name="l358"><span class="linenum"> 358</span></a>              <a class="var it20772" onMouseOver="hilite(20772)" onMouseOut="lolite()" onClick="logVariable('localuser')" href="../../_variables/localuser.html">$localuser</a>-&gt;{<a class="var it36" onMouseOver="hilite(36)" onMouseOut="lolite()" onClick="logVariable('key')" href="../../_variables/key.html">$key</a>} = <a class="var it1140" onMouseOver="hilite(1140)" onMouseOut="lolite()" onClick="logVariable('val')" href="../../_variables/val.html">$val</a>;
<a name="l359"><span class="linenum"> 359</span></a>          }
<a name="l360"><span class="linenum"> 360</span></a>  
<a name="l361"><span class="linenum"> 361</span></a>          <a class="var it20772" onMouseOver="hilite(20772)" onMouseOut="lolite()" onClick="logVariable('localuser')" href="../../_variables/localuser.html">$localuser</a>-&gt;<a onClick="logVariable('mnethostid')" class="var it39823" onMouseOver="hilite(39823)" onMouseOut="lolite()" href="../../_variables/mnethostid.html">mnethostid</a> = <a class="var it20769" onMouseOver="hilite(20769)" onMouseOut="lolite()" onClick="logVariable('remotepeer')" href="../../_variables/remotepeer.html">$remotepeer</a>-&gt;<a onClick="logVariable('id')" class="var it39819" onMouseOver="hilite(39819)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l362"><span class="linenum"> 362</span></a>          <a class="function" onClick="logFunction('user_update_user')" href="../../_functions/user_update_user.html" onMouseOver="funcPopup(event,'user_update_user')">user_update_user</a>(<a class="var it20772" onMouseOver="hilite(20772)" onMouseOut="lolite()" onClick="logVariable('localuser')" href="../../_variables/localuser.html">$localuser</a>, false);
<a name="l363"><span class="linenum"> 363</span></a>  
<a name="l364"><span class="linenum"> 364</span></a>          if (!<a class="var it20771" onMouseOver="hilite(20771)" onMouseOut="lolite()" onClick="logVariable('firsttime')" href="../../_variables/firsttime.html">$firsttime</a>) {
<a name="l365"><span class="linenum"> 365</span></a>  <span class="comment">            // repeat customer! let the IDP know about enrolments</span>
<a name="l366"><span class="linenum"> 366</span></a>  <span class="comment">            // we have for this user.</span>
<a name="l367"><span class="linenum"> 367</span></a>  <span class="comment">            // set up the RPC request</span>
<a name="l368"><span class="linenum"> 368</span></a>              <a class="var it6112" onMouseOver="hilite(6112)" onMouseOut="lolite()" onClick="logVariable('mnetrequest')" href="../../_variables/mnetrequest.html">$mnetrequest</a> = <span class="keyword">new </span><a class="class" onClick="logClass('mnet_xmlrpc_client')" href="../../_classes/mnet_xmlrpc_client.html" onMouseOver="classPopup(event,'mnet_xmlrpc_client')">mnet_xmlrpc_client</a>();
<a name="l369"><span class="linenum"> 369</span></a>              <a class="var it6112" onMouseOver="hilite(6112)" onMouseOut="lolite()" onClick="logVariable('mnetrequest')" href="../../_variables/mnetrequest.html">$mnetrequest</a>-&gt;<a class="function" onClick="logFunction('set_method')" href="../../_functions/set_method.html" onMouseOver="funcPopup(event,'set_method')">set_method</a>('auth/mnet/auth.php/update_enrolments');
<a name="l370"><span class="linenum"> 370</span></a>  
<a name="l371"><span class="linenum"> 371</span></a>  <span class="comment">            // pass username and an assoc array of &quot;my courses&quot;</span>
<a name="l372"><span class="linenum"> 372</span></a>  <span class="comment">            // with info so that the IDP can maintain mnetservice_enrol_enrolments</span>
<a name="l373"><span class="linenum"> 373</span></a>              <a class="var it6112" onMouseOver="hilite(6112)" onMouseOut="lolite()" onClick="logVariable('mnetrequest')" href="../../_variables/mnetrequest.html">$mnetrequest</a>-&gt;<a class="function" onClick="logFunction('add_param')" href="../../_functions/add_param.html" onMouseOver="funcPopup(event,'add_param')">add_param</a>(<a class="var it15510" onMouseOver="hilite(15510)" onMouseOut="lolite()" onClick="logVariable('remoteuser')" href="../../_variables/remoteuser.html">$remoteuser</a>-&gt;<a onClick="logVariable('username')" class="var it39821" onMouseOver="hilite(39821)" onMouseOut="lolite()" href="../../_variables/username.html">username</a>);
<a name="l374"><span class="linenum"> 374</span></a>              <a class="var it399" onMouseOver="hilite(399)" onMouseOut="lolite()" onClick="logVariable('fields')" href="../../_variables/fields.html">$fields</a> = 'id, category, sortorder, fullname, shortname, idnumber, summary, startdate, visible';
<a name="l375"><span class="linenum"> 375</span></a>              <a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a> = <a class="function" onClick="logFunction('enrol_get_users_courses')" href="../../_functions/enrol_get_users_courses.html" onMouseOver="funcPopup(event,'enrol_get_users_courses')">enrol_get_users_courses</a>(<a class="var it20772" onMouseOver="hilite(20772)" onMouseOut="lolite()" onClick="logVariable('localuser')" href="../../_variables/localuser.html">$localuser</a>-&gt;<a onClick="logVariable('id')" class="var it39823" onMouseOver="hilite(39823)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, false, <a class="var it399" onMouseOver="hilite(399)" onMouseOut="lolite()" onClick="logVariable('fields')" href="../../_variables/fields.html">$fields</a>, 'visible DESC,sortorder ASC');
<a name="l376"><span class="linenum"> 376</span></a>              if (<a class="phpfunction" onClick="logFunction('is_array')" href="../../_functions/is_array.html" onMouseOver="phpfuncPopup(event,'is_array')">is_array</a>(<a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>) &amp;&amp; !empty(<a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>)) {
<a name="l377"><span class="linenum"> 377</span></a>  <span class="comment">                // Second request to do the JOINs that we'd have done</span>
<a name="l378"><span class="linenum"> 378</span></a>  <span class="comment">                // inside enrol_get_users_courses() if we had been allowed</span>
<a name="l379"><span class="linenum"> 379</span></a>                  <a class="var it125" onMouseOver="hilite(125)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a> = &quot;SELECT c.id,
<a name="l380"><span class="linenum"> 380</span></a>                                 cc.name AS cat_name, cc.description AS cat_description
<a name="l381"><span class="linenum"> 381</span></a>                            FROM {course} c
<a name="l382"><span class="linenum"> 382</span></a>                            JOIN {course_categories} cc ON c.category = cc.id
<a name="l383"><span class="linenum"> 383</span></a>                           WHERE c.id IN (&quot; . <a class="function" onClick="logFunction('join')" href="../../_functions/join.html" onMouseOver="funcPopup(event,'join')">join</a>(',',<a class="phpfunction" onClick="logFunction('array_keys')" href="../../_functions/array_keys.html" onMouseOver="phpfuncPopup(event,'array_keys')">array_keys</a>(<a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>)) . ')';
<a name="l384"><span class="linenum"> 384</span></a>                  <a class="var it2018" onMouseOver="hilite(2018)" onMouseOut="lolite()" onClick="logVariable('extra')" href="../../_variables/extra.html">$extra</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records_sql')" href="../../_functions/get_records_sql.html" onMouseOver="funcPopup(event,'get_records_sql')">get_records_sql</a>(<a class="var it125" onMouseOver="hilite(125)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a>);
<a name="l385"><span class="linenum"> 385</span></a>  
<a name="l386"><span class="linenum"> 386</span></a>                  <a class="var it1933" onMouseOver="hilite(1933)" onMouseOut="lolite()" onClick="logVariable('keys')" href="../../_variables/keys.html">$keys</a> = <a class="phpfunction" onClick="logFunction('array_keys')" href="../../_functions/array_keys.html" onMouseOver="phpfuncPopup(event,'array_keys')">array_keys</a>(<a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>);
<a name="l387"><span class="linenum"> 387</span></a>                  <a class="var it20779" onMouseOver="hilite(20779)" onMouseOut="lolite()" onClick="logVariable('studentroles')" href="../../_variables/studentroles.html">$studentroles</a> = <a class="function" onClick="logFunction('get_archetype_roles')" href="../../_functions/get_archetype_roles.html" onMouseOver="funcPopup(event,'get_archetype_roles')">get_archetype_roles</a>('student');
<a name="l388"><span class="linenum"> 388</span></a>                  if (!empty(<a class="var it20779" onMouseOver="hilite(20779)" onMouseOut="lolite()" onClick="logVariable('studentroles')" href="../../_variables/studentroles.html">$studentroles</a>)) {
<a name="l389"><span class="linenum"> 389</span></a>                      <a class="var it3143" onMouseOver="hilite(3143)" onMouseOut="lolite()" onClick="logVariable('defaultrole')" href="../../_variables/defaultrole.html">$defaultrole</a> = <a class="phpfunction" onClick="logFunction('reset')" href="../../_functions/reset.html" onMouseOver="phpfuncPopup(event,'reset')">reset</a>(<a class="var it20779" onMouseOver="hilite(20779)" onMouseOut="lolite()" onClick="logVariable('studentroles')" href="../../_variables/studentroles.html">$studentroles</a>);
<a name="l390"><span class="linenum"> 390</span></a>  <span class="comment">                    //$defaultrole = get_default_course_role($ccache[$shortname]); //TODO: rewrite this completely, there is no default course role any more!!!</span>
<a name="l391"><span class="linenum"> 391</span></a>                      foreach (<a class="var it1933" onMouseOver="hilite(1933)" onMouseOut="lolite()" onClick="logVariable('keys')" href="../../_variables/keys.html">$keys</a> AS <a class="var it102" onMouseOver="hilite(102)" onMouseOut="lolite()" onClick="logVariable('id')" href="../../_variables/id.html">$id</a>) {
<a name="l392"><span class="linenum"> 392</span></a>                          if (<a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>[<a class="var it102" onMouseOver="hilite(102)" onMouseOut="lolite()" onClick="logVariable('id')" href="../../_variables/id.html">$id</a>]-&gt;visible == 0) {
<a name="l393"><span class="linenum"> 393</span></a>                              unset(<a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>[<a class="var it102" onMouseOver="hilite(102)" onMouseOut="lolite()" onClick="logVariable('id')" href="../../_variables/id.html">$id</a>]);
<a name="l394"><span class="linenum"> 394</span></a>                              continue;
<a name="l395"><span class="linenum"> 395</span></a>                          }
<a name="l396"><span class="linenum"> 396</span></a>                          <a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>[<a class="var it102" onMouseOver="hilite(102)" onMouseOut="lolite()" onClick="logVariable('id')" href="../../_variables/id.html">$id</a>]-&gt;cat_id          = <a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>[<a class="var it102" onMouseOver="hilite(102)" onMouseOut="lolite()" onClick="logVariable('id')" href="../../_variables/id.html">$id</a>]-&gt;category;
<a name="l397"><span class="linenum"> 397</span></a>                          <a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>[<a class="var it102" onMouseOver="hilite(102)" onMouseOut="lolite()" onClick="logVariable('id')" href="../../_variables/id.html">$id</a>]-&gt;defaultroleid   = <a class="var it3143" onMouseOver="hilite(3143)" onMouseOut="lolite()" onClick="logVariable('defaultrole')" href="../../_variables/defaultrole.html">$defaultrole</a>-&gt;<a onClick="logVariable('id')" class="var it39825" onMouseOver="hilite(39825)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l398"><span class="linenum"> 398</span></a>                          unset(<a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>[<a class="var it102" onMouseOver="hilite(102)" onMouseOut="lolite()" onClick="logVariable('id')" href="../../_variables/id.html">$id</a>]-&gt;category);
<a name="l399"><span class="linenum"> 399</span></a>                          unset(<a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>[<a class="var it102" onMouseOver="hilite(102)" onMouseOut="lolite()" onClick="logVariable('id')" href="../../_variables/id.html">$id</a>]-&gt;visible);
<a name="l400"><span class="linenum"> 400</span></a>  
<a name="l401"><span class="linenum"> 401</span></a>                          <a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>[<a class="var it102" onMouseOver="hilite(102)" onMouseOut="lolite()" onClick="logVariable('id')" href="../../_variables/id.html">$id</a>]-&gt;cat_name        = <a class="var it2018" onMouseOver="hilite(2018)" onMouseOut="lolite()" onClick="logVariable('extra')" href="../../_variables/extra.html">$extra</a>[<a class="var it102" onMouseOver="hilite(102)" onMouseOut="lolite()" onClick="logVariable('id')" href="../../_variables/id.html">$id</a>]-&gt;cat_name;
<a name="l402"><span class="linenum"> 402</span></a>                          <a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>[<a class="var it102" onMouseOver="hilite(102)" onMouseOut="lolite()" onClick="logVariable('id')" href="../../_variables/id.html">$id</a>]-&gt;cat_description = <a class="var it2018" onMouseOver="hilite(2018)" onMouseOut="lolite()" onClick="logVariable('extra')" href="../../_variables/extra.html">$extra</a>[<a class="var it102" onMouseOver="hilite(102)" onMouseOut="lolite()" onClick="logVariable('id')" href="../../_variables/id.html">$id</a>]-&gt;cat_description;
<a name="l403"><span class="linenum"> 403</span></a>                          <a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>[<a class="var it102" onMouseOver="hilite(102)" onMouseOut="lolite()" onClick="logVariable('id')" href="../../_variables/id.html">$id</a>]-&gt;defaultrolename = <a class="var it3143" onMouseOver="hilite(3143)" onMouseOut="lolite()" onClick="logVariable('defaultrole')" href="../../_variables/defaultrole.html">$defaultrole</a>-&gt;<a onClick="logVariable('name')" class="var it39825" onMouseOver="hilite(39825)" onMouseOut="lolite()" href="../../_variables/name.html">name</a>;
<a name="l404"><span class="linenum"> 404</span></a>  <span class="comment">                        // coerce to array</span>
<a name="l405"><span class="linenum"> 405</span></a>                          <a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>[<a class="var it102" onMouseOver="hilite(102)" onMouseOut="lolite()" onClick="logVariable('id')" href="../../_variables/id.html">$id</a>] = (array)<a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>[<a class="var it102" onMouseOver="hilite(102)" onMouseOut="lolite()" onClick="logVariable('id')" href="../../_variables/id.html">$id</a>];
<a name="l406"><span class="linenum"> 406</span></a>                      }
<a name="l407"><span class="linenum"> 407</span></a>                  } else {
<a name="l408"><span class="linenum"> 408</span></a>                      throw <span class="keyword">new </span><a class="class" onClick="logClass('moodle_exception')" href="../../_classes/moodle_exception.html" onMouseOver="classPopup(event,'moodle_exception')">moodle_exception</a>('unknownrole', 'error', '', 'student');
<a name="l409"><span class="linenum"> 409</span></a>                  }
<a name="l410"><span class="linenum"> 410</span></a>              } else {
<a name="l411"><span class="linenum"> 411</span></a>  <span class="comment">                // if the array is empty, send it anyway</span>
<a name="l412"><span class="linenum"> 412</span></a>  <span class="comment">                // we may be clearing out stale entries</span>
<a name="l413"><span class="linenum"> 413</span></a>                  <a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a> = array();
<a name="l414"><span class="linenum"> 414</span></a>              }
<a name="l415"><span class="linenum"> 415</span></a>              <a class="var it6112" onMouseOver="hilite(6112)" onMouseOut="lolite()" onClick="logVariable('mnetrequest')" href="../../_variables/mnetrequest.html">$mnetrequest</a>-&gt;<a class="function" onClick="logFunction('add_param')" href="../../_functions/add_param.html" onMouseOver="funcPopup(event,'add_param')">add_param</a>(<a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>);
<a name="l416"><span class="linenum"> 416</span></a>  
<a name="l417"><span class="linenum"> 417</span></a>  <span class="comment">            // Call 0800-RPC Now! -- we don't care too much if it fails</span>
<a name="l418"><span class="linenum"> 418</span></a>  <span class="comment">            // as it's just informational.</span>
<a name="l419"><span class="linenum"> 419</span></a>              if (<a class="var it6112" onMouseOver="hilite(6112)" onMouseOut="lolite()" onClick="logVariable('mnetrequest')" href="../../_variables/mnetrequest.html">$mnetrequest</a>-&gt;<a class="function" onClick="logFunction('send')" href="../../_functions/send.html" onMouseOver="funcPopup(event,'send')">send</a>(<a class="var it20769" onMouseOver="hilite(20769)" onMouseOut="lolite()" onClick="logVariable('remotepeer')" href="../../_variables/remotepeer.html">$remotepeer</a>) === false) {
<a name="l420"><span class="linenum"> 420</span></a>  <span class="comment">                // error_log(print_r($mnetrequest-&gt;error,1));</span>
<a name="l421"><span class="linenum"> 421</span></a>              }
<a name="l422"><span class="linenum"> 422</span></a>          }
<a name="l423"><span class="linenum"> 423</span></a>  
<a name="l424"><span class="linenum"> 424</span></a>          return <a class="var it20772" onMouseOver="hilite(20772)" onMouseOut="lolite()" onClick="logVariable('localuser')" href="../../_variables/localuser.html">$localuser</a>;
<a name="l425"><span class="linenum"> 425</span></a>      }
<a name="l426"><span class="linenum"> 426</span></a>  
<a name="l427"><span class="linenum"> 427</span></a>  
<a name="l428"><span class="linenum"> 428</span></a>      <span class="comment">/**</span>
<a name="l429"><span class="linenum"> 429</span></a>  <span class="comment">     * creates (or updates) the mnet session once</span>
<a name="l430"><span class="linenum"> 430</span></a>  <span class="comment">     * {@see confirm_mnet_session} and {@see complete_user_login} have both been called</span>
<a name="l431"><span class="linenum"> 431</span></a>  <span class="comment">     *</span>
<a name="l432"><span class="linenum"> 432</span></a>  <span class="comment">     * @param stdclass  $user the local user (must exist already</span>
<a name="l433"><span class="linenum"> 433</span></a>  <span class="comment">     * @param string    $token the jump/land token</span>
<a name="l434"><span class="linenum"> 434</span></a>  <span class="comment">     * @param mnet_peer $remotepeer the mnet_peer object of this users's idp</span>
<a name="l435"><span class="linenum"> 435</span></a>  <span class="comment">     */</span>
<a name="l436"><span class="linenum"> 436</span></a>      public function <a class="function" onClick="logFunction('update_mnet_session')" href="../../_functions/update_mnet_session.html" onMouseOver="funcPopup(event,'update_mnet_session')">update_mnet_session</a>(<a class="var it119" onMouseOver="hilite(119)" onMouseOut="lolite()" onClick="logVariable('user')" href="../../_variables/user.html">$user</a>, <a class="var it464" onMouseOver="hilite(464)" onMouseOut="lolite()" onClick="logVariable('token')" href="../../_variables/token.html">$token</a>, <a class="var it20769" onMouseOver="hilite(20769)" onMouseOut="lolite()" onClick="logVariable('remotepeer')" href="../../_variables/remotepeer.html">$remotepeer</a>) {
<a name="l437"><span class="linenum"> 437</span></a>          global <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l438"><span class="linenum"> 438</span></a>          <a class="var it20780" onMouseOver="hilite(20780)" onMouseOut="lolite()" onClick="logVariable('session_gc_maxlifetime')" href="../../_variables/session_gc_maxlifetime.html">$session_gc_maxlifetime</a> = 1440;
<a name="l439"><span class="linenum"> 439</span></a>          if (isset(<a class="var it119" onMouseOver="hilite(119)" onMouseOut="lolite()" onClick="logVariable('user')" href="../../_variables/user.html">$user</a>-&gt;<a onClick="logVariable('session_gc_maxlifetime')" class="var it39447" onMouseOver="hilite(39447)" onMouseOut="lolite()" href="../../_variables/session_gc_maxlifetime.html">session_gc_maxlifetime</a>)) {
<a name="l440"><span class="linenum"> 440</span></a>              <a class="var it20780" onMouseOver="hilite(20780)" onMouseOut="lolite()" onClick="logVariable('session_gc_maxlifetime')" href="../../_variables/session_gc_maxlifetime.html">$session_gc_maxlifetime</a> = <a class="var it119" onMouseOver="hilite(119)" onMouseOut="lolite()" onClick="logVariable('user')" href="../../_variables/user.html">$user</a>-&gt;<a onClick="logVariable('session_gc_maxlifetime')" class="var it39447" onMouseOver="hilite(39447)" onMouseOut="lolite()" href="../../_variables/session_gc_maxlifetime.html">session_gc_maxlifetime</a>;
<a name="l441"><span class="linenum"> 441</span></a>          }
<a name="l442"><span class="linenum"> 442</span></a>          if (!<a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('mnet_session',
<a name="l443"><span class="linenum"> 443</span></a>                                     array('userid'=&gt;<a class="var it119" onMouseOver="hilite(119)" onMouseOut="lolite()" onClick="logVariable('user')" href="../../_variables/user.html">$user</a>-&gt;<a onClick="logVariable('id')" class="var it39447" onMouseOver="hilite(39447)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, 'mnethostid'=&gt;<a class="var it20769" onMouseOver="hilite(20769)" onMouseOut="lolite()" onClick="logVariable('remotepeer')" href="../../_variables/remotepeer.html">$remotepeer</a>-&gt;<a onClick="logVariable('id')" class="var it39819" onMouseOver="hilite(39819)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>,
<a name="l444"><span class="linenum"> 444</span></a>                                     'useragent'=&gt;<a class="phpfunction" onClick="logFunction('sha1')" href="../../_functions/sha1.html" onMouseOver="phpfuncPopup(event,'sha1')">sha1</a>(<a class="var it74" onMouseOver="hilite(74)" onMouseOut="lolite()" onClick="logVariable('_SERVER')" href="../../_variables/_SERVER.html">$_SERVER</a>['HTTP_USER_AGENT'])))) {
<a name="l445"><span class="linenum"> 445</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a> = new stdClass();
<a name="l446"><span class="linenum"> 446</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('mnethostid')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/mnethostid.html">mnethostid</a> = <a class="var it20769" onMouseOver="hilite(20769)" onMouseOut="lolite()" onClick="logVariable('remotepeer')" href="../../_variables/remotepeer.html">$remotepeer</a>-&gt;<a onClick="logVariable('id')" class="var it39819" onMouseOver="hilite(39819)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l447"><span class="linenum"> 447</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('userid')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> = <a class="var it119" onMouseOver="hilite(119)" onMouseOut="lolite()" onClick="logVariable('user')" href="../../_variables/user.html">$user</a>-&gt;<a onClick="logVariable('id')" class="var it39447" onMouseOver="hilite(39447)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l448"><span class="linenum"> 448</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('username')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/username.html">username</a> = <a class="var it119" onMouseOver="hilite(119)" onMouseOut="lolite()" onClick="logVariable('user')" href="../../_variables/user.html">$user</a>-&gt;<a onClick="logVariable('username')" class="var it39447" onMouseOver="hilite(39447)" onMouseOut="lolite()" href="../../_variables/username.html">username</a>;
<a name="l449"><span class="linenum"> 449</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('useragent')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/useragent.html">useragent</a> = <a class="phpfunction" onClick="logFunction('sha1')" href="../../_functions/sha1.html" onMouseOver="phpfuncPopup(event,'sha1')">sha1</a>(<a class="var it74" onMouseOver="hilite(74)" onMouseOut="lolite()" onClick="logVariable('_SERVER')" href="../../_variables/_SERVER.html">$_SERVER</a>['HTTP_USER_AGENT']);
<a name="l450"><span class="linenum"> 450</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('token')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/token.html">token</a> = <a class="var it464" onMouseOver="hilite(464)" onMouseOut="lolite()" onClick="logVariable('token')" href="../../_variables/token.html">$token</a>; <span class="comment">// Needed to support simultaneous sessions</span>
<a name="l451"><span class="linenum"> 451</span></a>  <span class="comment">                                           // and preserving DB rec uniqueness</span>
<a name="l452"><span class="linenum"> 452</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('confirm_timeout')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/confirm_timeout.html">confirm_timeout</a> = <a class="phpfunction" onClick="logFunction('time')" href="../../_functions/time.html" onMouseOver="phpfuncPopup(event,'time')">time</a>();
<a name="l453"><span class="linenum"> 453</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('expires')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/expires.html">expires</a> = <a class="phpfunction" onClick="logFunction('time')" href="../../_functions/time.html" onMouseOver="phpfuncPopup(event,'time')">time</a>() + (integer)<a class="var it20780" onMouseOver="hilite(20780)" onMouseOut="lolite()" onClick="logVariable('session_gc_maxlifetime')" href="../../_variables/session_gc_maxlifetime.html">$session_gc_maxlifetime</a>;
<a name="l454"><span class="linenum"> 454</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('session_id')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/session_id.html">session_id</a> = <a class="phpfunction" onClick="logFunction('session_id')" href="../../_functions/session_id.html" onMouseOver="phpfuncPopup(event,'session_id')">session_id</a>();
<a name="l455"><span class="linenum"> 455</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('id')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/id.html">id</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('mnet_session', <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>);
<a name="l456"><span class="linenum"> 456</span></a>          } else {
<a name="l457"><span class="linenum"> 457</span></a>              <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>-&gt;<a onClick="logVariable('expires')" class="var it39816" onMouseOver="hilite(39816)" onMouseOut="lolite()" href="../../_variables/expires.html">expires</a> = <a class="phpfunction" onClick="logFunction('time')" href="../../_functions/time.html" onMouseOver="phpfuncPopup(event,'time')">time</a>() + (integer)<a class="var it20780" onMouseOver="hilite(20780)" onMouseOut="lolite()" onClick="logVariable('session_gc_maxlifetime')" href="../../_variables/session_gc_maxlifetime.html">$session_gc_maxlifetime</a>;
<a name="l458"><span class="linenum"> 458</span></a>              <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('update_record')" href="../../_functions/update_record.html" onMouseOver="funcPopup(event,'update_record')">update_record</a>('mnet_session', <a class="var it20765" onMouseOver="hilite(20765)" onMouseOut="lolite()" onClick="logVariable('mnet_session')" href="../../_variables/mnet_session.html">$mnet_session</a>);
<a name="l459"><span class="linenum"> 459</span></a>          }
<a name="l460"><span class="linenum"> 460</span></a>      }
<a name="l461"><span class="linenum"> 461</span></a>  
<a name="l462"><span class="linenum"> 462</span></a>  
<a name="l463"><span class="linenum"> 463</span></a>  
<a name="l464"><span class="linenum"> 464</span></a>      <span class="comment">/**</span>
<a name="l465"><span class="linenum"> 465</span></a>  <span class="comment">     * Invoke this function _on_ the IDP to update it with enrolment info local to</span>
<a name="l466"><span class="linenum"> 466</span></a>  <span class="comment">     * the SP right after calling user_authorise()</span>
<a name="l467"><span class="linenum"> 467</span></a>  <span class="comment">     *</span>
<a name="l468"><span class="linenum"> 468</span></a>  <span class="comment">     * Normally called by the SP after calling user_authorise()</span>
<a name="l469"><span class="linenum"> 469</span></a>  <span class="comment">     *</span>
<a name="l470"><span class="linenum"> 470</span></a>  <span class="comment">     * @param string $username The username</span>
<a name="l471"><span class="linenum"> 471</span></a>  <span class="comment">     * @param array $courses  Assoc array of courses following the structure of mnetservice_enrol_courses</span>
<a name="l472"><span class="linenum"> 472</span></a>  <span class="comment">     * @return bool</span>
<a name="l473"><span class="linenum"> 473</span></a>  <span class="comment">     */</span>
<a name="l474"><span class="linenum"> 474</span></a>      function <a class="function" onClick="logFunction('update_enrolments')" href="../../_functions/update_enrolments.html" onMouseOver="funcPopup(event,'update_enrolments')">update_enrolments</a>(<a class="var it463" onMouseOver="hilite(463)" onMouseOut="lolite()" onClick="logVariable('username')" href="../../_variables/username.html">$username</a>, <a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>) {
<a name="l475"><span class="linenum"> 475</span></a>          global <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l476"><span class="linenum"> 476</span></a>          <a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a> = <a class="function" onClick="logFunction('get_mnet_remote_client')" href="../../_functions/get_mnet_remote_client.html" onMouseOver="funcPopup(event,'get_mnet_remote_client')">get_mnet_remote_client</a>();
<a name="l477"><span class="linenum"> 477</span></a>  
<a name="l478"><span class="linenum"> 478</span></a>          if (empty(<a class="var it463" onMouseOver="hilite(463)" onMouseOut="lolite()" onClick="logVariable('username')" href="../../_variables/username.html">$username</a>) || !<a class="phpfunction" onClick="logFunction('is_array')" href="../../_functions/is_array.html" onMouseOver="phpfuncPopup(event,'is_array')">is_array</a>(<a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>)) {
<a name="l479"><span class="linenum"> 479</span></a>              return false;
<a name="l480"><span class="linenum"> 480</span></a>          }
<a name="l481"><span class="linenum"> 481</span></a>  <span class="comment">        // make sure it is a user we have an in active session</span>
<a name="l482"><span class="linenum"> 482</span></a>  <span class="comment">        // with that host...</span>
<a name="l483"><span class="linenum"> 483</span></a>          <a class="var it20781" onMouseOver="hilite(20781)" onMouseOut="lolite()" onClick="logVariable('mnetsessions')" href="../../_variables/mnetsessions.html">$mnetsessions</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records')" href="../../_functions/get_records.html" onMouseOver="funcPopup(event,'get_records')">get_records</a>('mnet_session', array('username' =&gt; <a class="var it463" onMouseOver="hilite(463)" onMouseOut="lolite()" onClick="logVariable('username')" href="../../_variables/username.html">$username</a>, 'mnethostid' =&gt; <a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a>-&gt;<a onClick="logVariable('id')" class="var it39817" onMouseOver="hilite(39817)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>), '', 'id, userid');
<a name="l484"><span class="linenum"> 484</span></a>          <a class="var it182" onMouseOver="hilite(182)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> = null;
<a name="l485"><span class="linenum"> 485</span></a>          foreach (<a class="var it20781" onMouseOver="hilite(20781)" onMouseOut="lolite()" onClick="logVariable('mnetsessions')" href="../../_variables/mnetsessions.html">$mnetsessions</a> as <a class="var it20782" onMouseOver="hilite(20782)" onMouseOut="lolite()" onClick="logVariable('mnetsession')" href="../../_variables/mnetsession.html">$mnetsession</a>) {
<a name="l486"><span class="linenum"> 486</span></a>              if (<a class="phpfunction" onClick="logFunction('is_null')" href="../../_functions/is_null.html" onMouseOver="phpfuncPopup(event,'is_null')">is_null</a>(<a class="var it182" onMouseOver="hilite(182)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>)) {
<a name="l487"><span class="linenum"> 487</span></a>                  <a class="var it182" onMouseOver="hilite(182)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> = <a class="var it20782" onMouseOver="hilite(20782)" onMouseOut="lolite()" onClick="logVariable('mnetsession')" href="../../_variables/mnetsession.html">$mnetsession</a>-&gt;<a onClick="logVariable('userid')" class="var it39826" onMouseOver="hilite(39826)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>;
<a name="l488"><span class="linenum"> 488</span></a>                  continue;
<a name="l489"><span class="linenum"> 489</span></a>              }
<a name="l490"><span class="linenum"> 490</span></a>              if (<a class="var it182" onMouseOver="hilite(182)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> != <a class="var it20782" onMouseOver="hilite(20782)" onMouseOut="lolite()" onClick="logVariable('mnetsession')" href="../../_variables/mnetsession.html">$mnetsession</a>-&gt;<a onClick="logVariable('userid')" class="var it39826" onMouseOver="hilite(39826)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>) {
<a name="l491"><span class="linenum"> 491</span></a>                  throw <span class="keyword">new </span><a class="class" onClick="logClass('mnet_server_exception')" href="../../_classes/mnet_server_exception.html" onMouseOver="classPopup(event,'mnet_server_exception')">mnet_server_exception</a>(3, 'authfail_usermismatch');
<a name="l492"><span class="linenum"> 492</span></a>              }
<a name="l493"><span class="linenum"> 493</span></a>          }
<a name="l494"><span class="linenum"> 494</span></a>  
<a name="l495"><span class="linenum"> 495</span></a>          if (empty(<a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>)) { // no courses? clear out quickly
<a name="l496"><span class="linenum"> 496</span></a>              <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('delete_records')" href="../../_functions/delete_records.html" onMouseOver="funcPopup(event,'delete_records')">delete_records</a>('mnetservice_enrol_enrolments', array('hostid'=&gt;<a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a>-&gt;<a onClick="logVariable('id')" class="var it39817" onMouseOver="hilite(39817)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, 'userid'=&gt;<a class="var it182" onMouseOver="hilite(182)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>));
<a name="l497"><span class="linenum"> 497</span></a>              return true;
<a name="l498"><span class="linenum"> 498</span></a>          }
<a name="l499"><span class="linenum"> 499</span></a>  
<a name="l500"><span class="linenum"> 500</span></a>  <span class="comment">        // IMPORTANT: Ask for remoteid as the first element in the query, so</span>
<a name="l501"><span class="linenum"> 501</span></a>  <span class="comment">        // that the array that comes back is indexed on the same field as the</span>
<a name="l502"><span class="linenum"> 502</span></a>  <span class="comment">        // array that we have received from the remote client</span>
<a name="l503"><span class="linenum"> 503</span></a>          <a class="var it125" onMouseOver="hilite(125)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a> = &quot;SELECT c.remoteid, c.id, c.categoryid AS cat_id, c.categoryname AS cat_name, c.sortorder,
<a name="l504"><span class="linenum"> 504</span></a>                         c.fullname, c.shortname, c.idnumber, c.summary, c.summaryformat, c.startdate,
<a name="l505"><span class="linenum"> 505</span></a>                         e.id AS enrolmentid
<a name="l506"><span class="linenum"> 506</span></a>                    FROM {mnetservice_enrol_courses} c
<a name="l507"><span class="linenum"> 507</span></a>               LEFT JOIN {mnetservice_enrol_enrolments} e <a class="function" onClick="logFunction('ON')" href="../../_functions/on.html" onMouseOver="funcPopup(event,'on')">ON</a> (e.hostid = c.hostid AND e.remotecourseid = c.remoteid)
<a name="l508"><span class="linenum"> 508</span></a>                   WHERE e.userid = ? AND c.hostid = ?&quot;;
<a name="l509"><span class="linenum"> 509</span></a>  
<a name="l510"><span class="linenum"> 510</span></a>          <a class="var it20783" onMouseOver="hilite(20783)" onMouseOut="lolite()" onClick="logVariable('currentcourses')" href="../../_variables/currentcourses.html">$currentcourses</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records_sql')" href="../../_functions/get_records_sql.html" onMouseOver="funcPopup(event,'get_records_sql')">get_records_sql</a>(<a class="var it125" onMouseOver="hilite(125)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a>, array(<a class="var it182" onMouseOver="hilite(182)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>, <a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a>-&gt;<a onClick="logVariable('id')" class="var it39817" onMouseOver="hilite(39817)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>));
<a name="l511"><span class="linenum"> 511</span></a>  
<a name="l512"><span class="linenum"> 512</span></a>          <a class="var it20784" onMouseOver="hilite(20784)" onMouseOut="lolite()" onClick="logVariable('local_courseid_array')" href="../../_variables/local_courseid_array.html">$local_courseid_array</a> = array();
<a name="l513"><span class="linenum"> 513</span></a>          foreach(<a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a> as <a class="var it19013" onMouseOver="hilite(19013)" onMouseOut="lolite()" onClick="logVariable('ix')" href="../../_variables/ix.html">$ix</a> =&gt; <a class="var it101" onMouseOver="hilite(101)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>) {
<a name="l514"><span class="linenum"> 514</span></a>  
<a name="l515"><span class="linenum"> 515</span></a>              <a class="var it101" onMouseOver="hilite(101)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>['remoteid'] = <a class="var it101" onMouseOver="hilite(101)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>['id'];
<a name="l516"><span class="linenum"> 516</span></a>              <a class="var it101" onMouseOver="hilite(101)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>['hostid']   =  (int)<a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a>-&gt;<a onClick="logVariable('id')" class="var it39817" onMouseOver="hilite(39817)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l517"><span class="linenum"> 517</span></a>              <a class="var it20785" onMouseOver="hilite(20785)" onMouseOut="lolite()" onClick="logVariable('userisregd')" href="../../_variables/userisregd.html">$userisregd</a>         = false;
<a name="l518"><span class="linenum"> 518</span></a>  
<a name="l519"><span class="linenum"> 519</span></a>  <span class="comment">            // if we do not have the the information about the remote course, it is not available</span>
<a name="l520"><span class="linenum"> 520</span></a>  <span class="comment">            // to us for remote enrolment - skip</span>
<a name="l521"><span class="linenum"> 521</span></a>              if (<a class="phpfunction" onClick="logFunction('array_key_exists')" href="../../_functions/array_key_exists.html" onMouseOver="phpfuncPopup(event,'array_key_exists')">array_key_exists</a>(<a class="var it101" onMouseOver="hilite(101)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>['remoteid'], <a class="var it20783" onMouseOver="hilite(20783)" onMouseOut="lolite()" onClick="logVariable('currentcourses')" href="../../_variables/currentcourses.html">$currentcourses</a>)) {
<a name="l522"><span class="linenum"> 522</span></a>  <span class="comment">                // Pointer to current course:</span>
<a name="l523"><span class="linenum"> 523</span></a>                  <a class="var it20786" onMouseOver="hilite(20786)" onMouseOut="lolite()" onClick="logVariable('currentcourse')" href="../../_variables/currentcourse.html">$currentcourse</a> =&amp; <a class="var it20783" onMouseOver="hilite(20783)" onMouseOut="lolite()" onClick="logVariable('currentcourses')" href="../../_variables/currentcourses.html">$currentcourses</a>[<a class="var it101" onMouseOver="hilite(101)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>['remoteid']];
<a name="l524"><span class="linenum"> 524</span></a>  <span class="comment">                // We have a record - is it up-to-date?</span>
<a name="l525"><span class="linenum"> 525</span></a>                  <a class="var it101" onMouseOver="hilite(101)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>['id'] = <a class="var it20786" onMouseOver="hilite(20786)" onMouseOut="lolite()" onClick="logVariable('currentcourse')" href="../../_variables/currentcourse.html">$currentcourse</a>-&gt;<a onClick="logVariable('id')" class="var it39827" onMouseOver="hilite(39827)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l526"><span class="linenum"> 526</span></a>  
<a name="l527"><span class="linenum"> 527</span></a>                  <a class="var it20787" onMouseOver="hilite(20787)" onMouseOut="lolite()" onClick="logVariable('saveflag')" href="../../_variables/saveflag.html">$saveflag</a> = false;
<a name="l528"><span class="linenum"> 528</span></a>  
<a name="l529"><span class="linenum"> 529</span></a>                  foreach(<a class="var it101" onMouseOver="hilite(101)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a> as <a class="var it36" onMouseOver="hilite(36)" onMouseOut="lolite()" onClick="logVariable('key')" href="../../_variables/key.html">$key</a> =&gt; <a class="var it35" onMouseOver="hilite(35)" onMouseOut="lolite()" onClick="logVariable('value')" href="../../_variables/value.html">$value</a>) {
<a name="l530"><span class="linenum"> 530</span></a>                      if (<a class="var it20786" onMouseOver="hilite(20786)" onMouseOut="lolite()" onClick="logVariable('currentcourse')" href="../../_variables/currentcourse.html">$currentcourse</a>-&gt;<a class="var it36" onMouseOver="hilite(36)" onMouseOut="lolite()" onClick="logVariable('key')" href="../../_variables/key.html">$key</a> != <a class="var it35" onMouseOver="hilite(35)" onMouseOut="lolite()" onClick="logVariable('value')" href="../../_variables/value.html">$value</a>) {
<a name="l531"><span class="linenum"> 531</span></a>                          <a class="var it20787" onMouseOver="hilite(20787)" onMouseOut="lolite()" onClick="logVariable('saveflag')" href="../../_variables/saveflag.html">$saveflag</a> = true;
<a name="l532"><span class="linenum"> 532</span></a>                          <a class="var it20786" onMouseOver="hilite(20786)" onMouseOut="lolite()" onClick="logVariable('currentcourse')" href="../../_variables/currentcourse.html">$currentcourse</a>-&gt;<a class="var it36" onMouseOver="hilite(36)" onMouseOut="lolite()" onClick="logVariable('key')" href="../../_variables/key.html">$key</a> = <a class="var it35" onMouseOver="hilite(35)" onMouseOut="lolite()" onClick="logVariable('value')" href="../../_variables/value.html">$value</a>;
<a name="l533"><span class="linenum"> 533</span></a>                      }
<a name="l534"><span class="linenum"> 534</span></a>                  }
<a name="l535"><span class="linenum"> 535</span></a>  
<a name="l536"><span class="linenum"> 536</span></a>                  if (<a class="var it20787" onMouseOver="hilite(20787)" onMouseOut="lolite()" onClick="logVariable('saveflag')" href="../../_variables/saveflag.html">$saveflag</a>) {
<a name="l537"><span class="linenum"> 537</span></a>                      <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('update_record')" href="../../_functions/update_record.html" onMouseOver="funcPopup(event,'update_record')">update_record</a>('mnetervice_enrol_courses', <a class="var it20786" onMouseOver="hilite(20786)" onMouseOut="lolite()" onClick="logVariable('currentcourse')" href="../../_variables/currentcourse.html">$currentcourse</a>);
<a name="l538"><span class="linenum"> 538</span></a>                  }
<a name="l539"><span class="linenum"> 539</span></a>  
<a name="l540"><span class="linenum"> 540</span></a>                  if (isset(<a class="var it20786" onMouseOver="hilite(20786)" onMouseOut="lolite()" onClick="logVariable('currentcourse')" href="../../_variables/currentcourse.html">$currentcourse</a>-&gt;<a onClick="logVariable('enrolmentid')" class="var it39827" onMouseOver="hilite(39827)" onMouseOut="lolite()" href="../../_variables/enrolmentid.html">enrolmentid</a>) &amp;&amp; <a class="phpfunction" onClick="logFunction('is_numeric')" href="../../_functions/is_numeric.html" onMouseOver="phpfuncPopup(event,'is_numeric')">is_numeric</a>(<a class="var it20786" onMouseOver="hilite(20786)" onMouseOut="lolite()" onClick="logVariable('currentcourse')" href="../../_variables/currentcourse.html">$currentcourse</a>-&gt;<a onClick="logVariable('enrolmentid')" class="var it39827" onMouseOver="hilite(39827)" onMouseOut="lolite()" href="../../_variables/enrolmentid.html">enrolmentid</a>)) {
<a name="l541"><span class="linenum"> 541</span></a>                      <a class="var it20785" onMouseOver="hilite(20785)" onMouseOut="lolite()" onClick="logVariable('userisregd')" href="../../_variables/userisregd.html">$userisregd</a> = true;
<a name="l542"><span class="linenum"> 542</span></a>                  }
<a name="l543"><span class="linenum"> 543</span></a>              } else {
<a name="l544"><span class="linenum"> 544</span></a>                  unset (<a class="var it520" onMouseOver="hilite(520)" onMouseOut="lolite()" onClick="logVariable('courses')" href="../../_variables/courses.html">$courses</a>[<a class="var it19013" onMouseOver="hilite(19013)" onMouseOut="lolite()" onClick="logVariable('ix')" href="../../_variables/ix.html">$ix</a>]);
<a name="l545"><span class="linenum"> 545</span></a>                  continue;
<a name="l546"><span class="linenum"> 546</span></a>              }
<a name="l547"><span class="linenum"> 547</span></a>  
<a name="l548"><span class="linenum"> 548</span></a>  <span class="comment">            // By this point, we should always have a $dataObj-&gt;id</span>
<a name="l549"><span class="linenum"> 549</span></a>              <a class="var it20784" onMouseOver="hilite(20784)" onMouseOut="lolite()" onClick="logVariable('local_courseid_array')" href="../../_variables/local_courseid_array.html">$local_courseid_array</a>[] = <a class="var it101" onMouseOver="hilite(101)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>['id'];
<a name="l550"><span class="linenum"> 550</span></a>  
<a name="l551"><span class="linenum"> 551</span></a>  <span class="comment">            // Do we have a record for this assignment?</span>
<a name="l552"><span class="linenum"> 552</span></a>              if (<a class="var it20785" onMouseOver="hilite(20785)" onMouseOut="lolite()" onClick="logVariable('userisregd')" href="../../_variables/userisregd.html">$userisregd</a>) {
<a name="l553"><span class="linenum"> 553</span></a>  <span class="comment">                // Yes - we know about this one already</span>
<a name="l554"><span class="linenum"> 554</span></a>  <span class="comment">                // We don't want to do updates because the new data is probably</span>
<a name="l555"><span class="linenum"> 555</span></a>  <span class="comment">                // 'less complete' than the data we have.</span>
<a name="l556"><span class="linenum"> 556</span></a>              } else {
<a name="l557"><span class="linenum"> 557</span></a>  <span class="comment">                // No - create a record</span>
<a name="l558"><span class="linenum"> 558</span></a>                  <a class="var it20789" onMouseOver="hilite(20789)" onMouseOut="lolite()" onClick="logVariable('assignObj')" href="../../_variables/assignObj.html">$assignObj</a> = new stdClass();
<a name="l559"><span class="linenum"> 559</span></a>                  <a class="var it20789" onMouseOver="hilite(20789)" onMouseOut="lolite()" onClick="logVariable('assignObj')" href="../../_variables/assignObj.html">$assignObj</a>-&gt;<a onClick="logVariable('userid')" class="var it39828" onMouseOver="hilite(39828)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>    = <a class="var it182" onMouseOver="hilite(182)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>;
<a name="l560"><span class="linenum"> 560</span></a>                  <a class="var it20789" onMouseOver="hilite(20789)" onMouseOut="lolite()" onClick="logVariable('assignObj')" href="../../_variables/assignObj.html">$assignObj</a>-&gt;<a onClick="logVariable('hostid')" class="var it39828" onMouseOver="hilite(39828)" onMouseOut="lolite()" href="../../_variables/hostid.html">hostid</a>    = (int)<a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a>-&gt;<a onClick="logVariable('id')" class="var it39817" onMouseOver="hilite(39817)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l561"><span class="linenum"> 561</span></a>                  <a class="var it20789" onMouseOver="hilite(20789)" onMouseOut="lolite()" onClick="logVariable('assignObj')" href="../../_variables/assignObj.html">$assignObj</a>-&gt;<a onClick="logVariable('remotecourseid')" class="var it39828" onMouseOver="hilite(39828)" onMouseOut="lolite()" href="../../_variables/remotecourseid.html">remotecourseid</a> = <a class="var it101" onMouseOver="hilite(101)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>['remoteid'];
<a name="l562"><span class="linenum"> 562</span></a>                  <a class="var it20789" onMouseOver="hilite(20789)" onMouseOut="lolite()" onClick="logVariable('assignObj')" href="../../_variables/assignObj.html">$assignObj</a>-&gt;<a onClick="logVariable('rolename')" class="var it39828" onMouseOver="hilite(39828)" onMouseOut="lolite()" href="../../_variables/rolename.html">rolename</a>  = <a class="var it101" onMouseOver="hilite(101)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>['defaultrolename'];
<a name="l563"><span class="linenum"> 563</span></a>                  <a class="var it20789" onMouseOver="hilite(20789)" onMouseOut="lolite()" onClick="logVariable('assignObj')" href="../../_variables/assignObj.html">$assignObj</a>-&gt;<a onClick="logVariable('id')" class="var it39828" onMouseOver="hilite(39828)" onMouseOut="lolite()" href="../../_variables/id.html">id</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('mnetservice_enrol_enrolments', <a class="var it20789" onMouseOver="hilite(20789)" onMouseOut="lolite()" onClick="logVariable('assignObj')" href="../../_variables/assignObj.html">$assignObj</a>);
<a name="l564"><span class="linenum"> 564</span></a>              }
<a name="l565"><span class="linenum"> 565</span></a>          }
<a name="l566"><span class="linenum"> 566</span></a>  
<a name="l567"><span class="linenum"> 567</span></a>  <span class="comment">        // Clean up courses that the user is no longer enrolled in.</span>
<a name="l568"><span class="linenum"> 568</span></a>          if (!empty(<a class="var it20784" onMouseOver="hilite(20784)" onMouseOut="lolite()" onClick="logVariable('local_courseid_array')" href="../../_variables/local_courseid_array.html">$local_courseid_array</a>)) {
<a name="l569"><span class="linenum"> 569</span></a>              <a class="var it20791" onMouseOver="hilite(20791)" onMouseOut="lolite()" onClick="logVariable('local_courseid_string')" href="../../_variables/local_courseid_string.html">$local_courseid_string</a> = <a class="phpfunction" onClick="logFunction('implode')" href="../../_functions/implode.html" onMouseOver="phpfuncPopup(event,'implode')">implode</a>(', ', <a class="var it20784" onMouseOver="hilite(20784)" onMouseOut="lolite()" onClick="logVariable('local_courseid_array')" href="../../_variables/local_courseid_array.html">$local_courseid_array</a>);
<a name="l570"><span class="linenum"> 570</span></a>              <a class="var it20792" onMouseOver="hilite(20792)" onMouseOut="lolite()" onClick="logVariable('whereclause')" href="../../_variables/whereclause.html">$whereclause</a> = &quot; userid = ? AND hostid = ? AND remotecourseid NOT IN (<a class="var it20791" onMouseOver="hilite(20791)" onMouseOut="lolite()" onClick="logVariable('local_courseid_string')" href="../../_variables/local_courseid_string.html">$local_courseid_string</a>)&quot;;
<a name="l571"><span class="linenum"> 571</span></a>              <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('delete_records_select')" href="../../_functions/delete_records_select.html" onMouseOver="funcPopup(event,'delete_records_select')">delete_records_select</a>('mnetservice_enrol_enrolments', <a class="var it20792" onMouseOver="hilite(20792)" onMouseOut="lolite()" onClick="logVariable('whereclause')" href="../../_variables/whereclause.html">$whereclause</a>, array(<a class="var it182" onMouseOver="hilite(182)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>, <a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a>-&gt;<a onClick="logVariable('id')" class="var it39817" onMouseOver="hilite(39817)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>));
<a name="l572"><span class="linenum"> 572</span></a>          }
<a name="l573"><span class="linenum"> 573</span></a>      }
<a name="l574"><span class="linenum"> 574</span></a>  
<a name="l575"><span class="linenum"> 575</span></a>      function <a class="function" onClick="logFunction('prevent_local_passwords')" href="../../_functions/prevent_local_passwords.html" onMouseOver="funcPopup(event,'prevent_local_passwords')">prevent_local_passwords</a>() {
<a name="l576"><span class="linenum"> 576</span></a>          return true;
<a name="l577"><span class="linenum"> 577</span></a>      }
<a name="l578"><span class="linenum"> 578</span></a>  
<a name="l579"><span class="linenum"> 579</span></a>      <span class="comment">/**</span>
<a name="l580"><span class="linenum"> 580</span></a>  <span class="comment">     * Returns true if this authentication plugin is 'internal'.</span>
<a name="l581"><span class="linenum"> 581</span></a>  <span class="comment">     *</span>
<a name="l582"><span class="linenum"> 582</span></a>  <span class="comment">     * @return bool</span>
<a name="l583"><span class="linenum"> 583</span></a>  <span class="comment">     */</span>
<a name="l584"><span class="linenum"> 584</span></a>      function <a class="function" onClick="logFunction('is_internal')" href="../../_functions/is_internal.html" onMouseOver="funcPopup(event,'is_internal')">is_internal</a>() {
<a name="l585"><span class="linenum"> 585</span></a>          return false;
<a name="l586"><span class="linenum"> 586</span></a>      }
<a name="l587"><span class="linenum"> 587</span></a>  
<a name="l588"><span class="linenum"> 588</span></a>      <span class="comment">/**</span>
<a name="l589"><span class="linenum"> 589</span></a>  <span class="comment">     * Returns true if this authentication plugin can change the user's</span>
<a name="l590"><span class="linenum"> 590</span></a>  <span class="comment">     * password.</span>
<a name="l591"><span class="linenum"> 591</span></a>  <span class="comment">     *</span>
<a name="l592"><span class="linenum"> 592</span></a>  <span class="comment">     * @return bool</span>
<a name="l593"><span class="linenum"> 593</span></a>  <span class="comment">     */</span>
<a name="l594"><span class="linenum"> 594</span></a>      function <a class="function" onClick="logFunction('can_change_password')" href="../../_functions/can_change_password.html" onMouseOver="funcPopup(event,'can_change_password')">can_change_password</a>() {
<a name="l595"><span class="linenum"> 595</span></a>  <span class="comment">        //TODO: it should be able to redirect, right?</span>
<a name="l596"><span class="linenum"> 596</span></a>          return false;
<a name="l597"><span class="linenum"> 597</span></a>      }
<a name="l598"><span class="linenum"> 598</span></a>  
<a name="l599"><span class="linenum"> 599</span></a>      <span class="comment">/**</span>
<a name="l600"><span class="linenum"> 600</span></a>  <span class="comment">     * Returns the URL for changing the user's pw, or false if the default can</span>
<a name="l601"><span class="linenum"> 601</span></a>  <span class="comment">     * be used.</span>
<a name="l602"><span class="linenum"> 602</span></a>  <span class="comment">     *</span>
<a name="l603"><span class="linenum"> 603</span></a>  <span class="comment">     * @return moodle_url</span>
<a name="l604"><span class="linenum"> 604</span></a>  <span class="comment">     */</span>
<a name="l605"><span class="linenum"> 605</span></a>      function <a class="function" onClick="logFunction('change_password_url')" href="../../_functions/change_password_url.html" onMouseOver="funcPopup(event,'change_password_url')">change_password_url</a>() {
<a name="l606"><span class="linenum"> 606</span></a>          return null;
<a name="l607"><span class="linenum"> 607</span></a>      }
<a name="l608"><span class="linenum"> 608</span></a>  
<a name="l609"><span class="linenum"> 609</span></a>      <span class="comment">/**</span>
<a name="l610"><span class="linenum"> 610</span></a>  <span class="comment">     * Prints a form for configuring this authentication plugin.</span>
<a name="l611"><span class="linenum"> 611</span></a>  <span class="comment">     *</span>
<a name="l612"><span class="linenum"> 612</span></a>  <span class="comment">     * This function is called from admin/auth.php, and outputs a full page with</span>
<a name="l613"><span class="linenum"> 613</span></a>  <span class="comment">     * a form for configuring this plugin.</span>
<a name="l614"><span class="linenum"> 614</span></a>  <span class="comment">     *</span>
<a name="l615"><span class="linenum"> 615</span></a>  <span class="comment">     * @param object $config</span>
<a name="l616"><span class="linenum"> 616</span></a>  <span class="comment">     * @param object $err</span>
<a name="l617"><span class="linenum"> 617</span></a>  <span class="comment">     * @param array $user_fields</span>
<a name="l618"><span class="linenum"> 618</span></a>  <span class="comment">     */</span>
<a name="l619"><span class="linenum"> 619</span></a>      function <a class="function" onClick="logFunction('config_form')" href="../../_functions/config_form.html" onMouseOver="funcPopup(event,'config_form')">config_form</a>(<a class="var it1113" onMouseOver="hilite(1113)" onMouseOut="lolite()" onClick="logVariable('config')" href="../../_variables/config.html">$config</a>, <a class="var it1340" onMouseOver="hilite(1340)" onMouseOut="lolite()" onClick="logVariable('err')" href="../../_variables/err.html">$err</a>, <a class="var it7573" onMouseOver="hilite(7573)" onMouseOut="lolite()" onClick="logVariable('user_fields')" href="../../_variables/user_fields.html">$user_fields</a>) {
<a name="l620"><span class="linenum"> 620</span></a>          global <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l621"><span class="linenum"> 621</span></a>  
<a name="l622"><span class="linenum"> 622</span></a>           <a class="var it450" onMouseOver="hilite(450)" onMouseOut="lolite()" onClick="logVariable('query')" href="../../_variables/query.html">$query</a> = &quot;
<a name="l623"><span class="linenum"> 623</span></a>              SELECT
<a name="l624"><span class="linenum"> 624</span></a>                  h.id,
<a name="l625"><span class="linenum"> 625</span></a>                  h.name as hostname,
<a name="l626"><span class="linenum"> 626</span></a>                  h.wwwroot,
<a name="l627"><span class="linenum"> 627</span></a>                  h2idp.publish as idppublish,
<a name="l628"><span class="linenum"> 628</span></a>                  h2idp.subscribe as idpsubscribe,
<a name="l629"><span class="linenum"> 629</span></a>                  idp.name as idpname,
<a name="l630"><span class="linenum"> 630</span></a>                  h2sp.publish as sppublish,
<a name="l631"><span class="linenum"> 631</span></a>                  h2sp.subscribe as spsubscribe,
<a name="l632"><span class="linenum"> 632</span></a>                  sp.name as spname
<a name="l633"><span class="linenum"> 633</span></a>              FROM
<a name="l634"><span class="linenum"> 634</span></a>                  {mnet_host} h
<a name="l635"><span class="linenum"> 635</span></a>              LEFT JOIN
<a name="l636"><span class="linenum"> 636</span></a>                  {mnet_host2service} h2idp
<a name="l637"><span class="linenum"> 637</span></a>              ON
<a name="l638"><span class="linenum"> 638</span></a>                 (h.id = h2idp.hostid AND
<a name="l639"><span class="linenum"> 639</span></a>                 (h2idp.publish = 1 OR
<a name="l640"><span class="linenum"> 640</span></a>                  h2idp.subscribe = 1))
<a name="l641"><span class="linenum"> 641</span></a>              INNER JOIN
<a name="l642"><span class="linenum"> 642</span></a>                  {mnet_service} idp
<a name="l643"><span class="linenum"> 643</span></a>              ON
<a name="l644"><span class="linenum"> 644</span></a>                 (h2idp.serviceid = idp.id AND
<a name="l645"><span class="linenum"> 645</span></a>                  idp.name = 'sso_idp')
<a name="l646"><span class="linenum"> 646</span></a>              LEFT JOIN
<a name="l647"><span class="linenum"> 647</span></a>                  {mnet_host2service} h2sp
<a name="l648"><span class="linenum"> 648</span></a>              ON
<a name="l649"><span class="linenum"> 649</span></a>                 (h.id = h2sp.hostid AND
<a name="l650"><span class="linenum"> 650</span></a>                 (h2sp.publish = 1 OR
<a name="l651"><span class="linenum"> 651</span></a>                  h2sp.subscribe = 1))
<a name="l652"><span class="linenum"> 652</span></a>              INNER JOIN
<a name="l653"><span class="linenum"> 653</span></a>                  {mnet_service} sp
<a name="l654"><span class="linenum"> 654</span></a>              ON
<a name="l655"><span class="linenum"> 655</span></a>                 (h2sp.serviceid = sp.id AND
<a name="l656"><span class="linenum"> 656</span></a>                  sp.name = 'sso_sp')
<a name="l657"><span class="linenum"> 657</span></a>              WHERE
<a name="l658"><span class="linenum"> 658</span></a>                 ((h2idp.publish = 1 AND h2sp.subscribe = 1) OR
<a name="l659"><span class="linenum"> 659</span></a>                 (h2sp.publish = 1 AND h2idp.subscribe = 1)) AND
<a name="l660"><span class="linenum"> 660</span></a>                  h.id != ?
<a name="l661"><span class="linenum"> 661</span></a>              ORDER BY
<a name="l662"><span class="linenum"> 662</span></a>                  h.name ASC&quot;;
<a name="l663"><span class="linenum"> 663</span></a>  
<a name="l664"><span class="linenum"> 664</span></a>          <a class="var it5501" onMouseOver="hilite(5501)" onMouseOut="lolite()" onClick="logVariable('id_providers')" href="../../_variables/id_providers.html">$id_providers</a>       = array();
<a name="l665"><span class="linenum"> 665</span></a>          <a class="var it5502" onMouseOver="hilite(5502)" onMouseOut="lolite()" onClick="logVariable('service_providers')" href="../../_variables/service_providers.html">$service_providers</a>  = array();
<a name="l666"><span class="linenum"> 666</span></a>          if (<a class="var it15984" onMouseOver="hilite(15984)" onMouseOut="lolite()" onClick="logVariable('resultset')" href="../../_variables/resultset.html">$resultset</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records_sql')" href="../../_functions/get_records_sql.html" onMouseOver="funcPopup(event,'get_records_sql')">get_records_sql</a>(<a class="var it450" onMouseOver="hilite(450)" onMouseOut="lolite()" onClick="logVariable('query')" href="../../_variables/query.html">$query</a>, array(<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('mnet_localhost_id')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/mnet_localhost_id.html">mnet_localhost_id</a>))) {
<a name="l667"><span class="linenum"> 667</span></a>              foreach(<a class="var it15984" onMouseOver="hilite(15984)" onMouseOut="lolite()" onClick="logVariable('resultset')" href="../../_variables/resultset.html">$resultset</a> as <a class="var it20793" onMouseOver="hilite(20793)" onMouseOut="lolite()" onClick="logVariable('hostservice')" href="../../_variables/hostservice.html">$hostservice</a>) {
<a name="l668"><span class="linenum"> 668</span></a>                  if(!empty(<a class="var it20793" onMouseOver="hilite(20793)" onMouseOut="lolite()" onClick="logVariable('hostservice')" href="../../_variables/hostservice.html">$hostservice</a>-&gt;<a onClick="logVariable('idppublish')" class="var it39829" onMouseOver="hilite(39829)" onMouseOut="lolite()" href="../../_variables/idppublish.html">idppublish</a>) &amp;&amp; !empty(<a class="var it20793" onMouseOver="hilite(20793)" onMouseOut="lolite()" onClick="logVariable('hostservice')" href="../../_variables/hostservice.html">$hostservice</a>-&gt;<a onClick="logVariable('spsubscribe')" class="var it39829" onMouseOver="hilite(39829)" onMouseOut="lolite()" href="../../_variables/spsubscribe.html">spsubscribe</a>)) {
<a name="l669"><span class="linenum"> 669</span></a>                      <a class="var it5502" onMouseOver="hilite(5502)" onMouseOut="lolite()" onClick="logVariable('service_providers')" href="../../_variables/service_providers.html">$service_providers</a>[]= array('id' =&gt; <a class="var it20793" onMouseOver="hilite(20793)" onMouseOut="lolite()" onClick="logVariable('hostservice')" href="../../_variables/hostservice.html">$hostservice</a>-&gt;<a onClick="logVariable('id')" class="var it39829" onMouseOver="hilite(39829)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, 'name' =&gt; <a class="var it20793" onMouseOver="hilite(20793)" onMouseOut="lolite()" onClick="logVariable('hostservice')" href="../../_variables/hostservice.html">$hostservice</a>-&gt;<a onClick="logVariable('hostname')" class="var it39829" onMouseOver="hilite(39829)" onMouseOut="lolite()" href="../../_variables/hostname.html">hostname</a>, 'wwwroot' =&gt; <a class="var it20793" onMouseOver="hilite(20793)" onMouseOut="lolite()" onClick="logVariable('hostservice')" href="../../_variables/hostservice.html">$hostservice</a>-&gt;<a onClick="logVariable('wwwroot')" class="var it39829" onMouseOver="hilite(39829)" onMouseOut="lolite()" href="../../_variables/wwwroot.html">wwwroot</a>);
<a name="l670"><span class="linenum"> 670</span></a>                  }
<a name="l671"><span class="linenum"> 671</span></a>                  if(!empty(<a class="var it20793" onMouseOver="hilite(20793)" onMouseOut="lolite()" onClick="logVariable('hostservice')" href="../../_variables/hostservice.html">$hostservice</a>-&gt;<a onClick="logVariable('idpsubscribe')" class="var it39829" onMouseOver="hilite(39829)" onMouseOut="lolite()" href="../../_variables/idpsubscribe.html">idpsubscribe</a>) &amp;&amp; !empty(<a class="var it20793" onMouseOver="hilite(20793)" onMouseOut="lolite()" onClick="logVariable('hostservice')" href="../../_variables/hostservice.html">$hostservice</a>-&gt;<a onClick="logVariable('sppublish')" class="var it39829" onMouseOver="hilite(39829)" onMouseOut="lolite()" href="../../_variables/sppublish.html">sppublish</a>)) {
<a name="l672"><span class="linenum"> 672</span></a>                      <a class="var it5501" onMouseOver="hilite(5501)" onMouseOut="lolite()" onClick="logVariable('id_providers')" href="../../_variables/id_providers.html">$id_providers</a>[]= array('id' =&gt; <a class="var it20793" onMouseOver="hilite(20793)" onMouseOut="lolite()" onClick="logVariable('hostservice')" href="../../_variables/hostservice.html">$hostservice</a>-&gt;<a onClick="logVariable('id')" class="var it39829" onMouseOver="hilite(39829)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, 'name' =&gt; <a class="var it20793" onMouseOver="hilite(20793)" onMouseOut="lolite()" onClick="logVariable('hostservice')" href="../../_variables/hostservice.html">$hostservice</a>-&gt;<a onClick="logVariable('hostname')" class="var it39829" onMouseOver="hilite(39829)" onMouseOut="lolite()" href="../../_variables/hostname.html">hostname</a>, 'wwwroot' =&gt; <a class="var it20793" onMouseOver="hilite(20793)" onMouseOut="lolite()" onClick="logVariable('hostservice')" href="../../_variables/hostservice.html">$hostservice</a>-&gt;<a onClick="logVariable('wwwroot')" class="var it39829" onMouseOver="hilite(39829)" onMouseOut="lolite()" href="../../_variables/wwwroot.html">wwwroot</a>);
<a name="l673"><span class="linenum"> 673</span></a>                  }
<a name="l674"><span class="linenum"> 674</span></a>              }
<a name="l675"><span class="linenum"> 675</span></a>          }
<a name="l676"><span class="linenum"> 676</span></a>  
<a name="l677"><span class="linenum"> 677</span></a>          <span class="keyword">include</span> <a class="filename" href="../../auth/imap/config.html.html" onMouseOver="reqPopup(event, 'config.html', '../../auth/imap/config.html')"> &quot;config.html&quot;</a>;
<a name="l678"><span class="linenum"> 678</span></a>      }
<a name="l679"><span class="linenum"> 679</span></a>  
<a name="l680"><span class="linenum"> 680</span></a>      <span class="comment">/**</span>
<a name="l681"><span class="linenum"> 681</span></a>  <span class="comment">     * Processes and stores configuration data for this authentication plugin.</span>
<a name="l682"><span class="linenum"> 682</span></a>  <span class="comment">     */</span>
<a name="l683"><span class="linenum"> 683</span></a>      function <a class="function" onClick="logFunction('process_config')" href="../../_functions/process_config.html" onMouseOver="funcPopup(event,'process_config')">process_config</a>(<a class="var it1113" onMouseOver="hilite(1113)" onMouseOut="lolite()" onClick="logVariable('config')" href="../../_variables/config.html">$config</a>) {
<a name="l684"><span class="linenum"> 684</span></a>  <span class="comment">        // set to defaults if undefined</span>
<a name="l685"><span class="linenum"> 685</span></a>          if (!isset (<a class="var it1113" onMouseOver="hilite(1113)" onMouseOut="lolite()" onClick="logVariable('config')" href="../../_variables/config.html">$config</a>-&gt;<a onClick="logVariable('rpc_negotiation_timeout')" class="var it39457" onMouseOver="hilite(39457)" onMouseOut="lolite()" href="../../_variables/rpc_negotiation_timeout.html">rpc_negotiation_timeout</a>)) {
<a name="l686"><span class="linenum"> 686</span></a>              <a class="var it1113" onMouseOver="hilite(1113)" onMouseOut="lolite()" onClick="logVariable('config')" href="../../_variables/config.html">$config</a>-&gt;<a onClick="logVariable('rpc_negotiation_timeout')" class="var it39457" onMouseOver="hilite(39457)" onMouseOut="lolite()" href="../../_variables/rpc_negotiation_timeout.html">rpc_negotiation_timeout</a> = '30';
<a name="l687"><span class="linenum"> 687</span></a>          }
<a name="l688"><span class="linenum"> 688</span></a>          <span class="comment">/*</span>
<a name="l689"><span class="linenum"> 689</span></a>  <span class="comment">        if (!isset ($config-&gt;auto_add_remote_users)) {</span>
<a name="l690"><span class="linenum"> 690</span></a>  <span class="comment">            $config-&gt;auto_add_remote_users = '0';</span>
<a name="l691"><span class="linenum"> 691</span></a>  <span class="comment">        } See MDL-21327   for why this is commented out</span>
<a name="l692"><span class="linenum"> 692</span></a>  <span class="comment">        set_config('auto_add_remote_users',   $config-&gt;auto_add_remote_users,   'auth_mnet');</span>
<a name="l693"><span class="linenum"> 693</span></a>  <span class="comment">        */</span>
<a name="l694"><span class="linenum"> 694</span></a>  
<a name="l695"><span class="linenum"> 695</span></a>  <span class="comment">        // save settings</span>
<a name="l696"><span class="linenum"> 696</span></a>          <a class="function" onClick="logFunction('set_config')" href="../../_functions/set_config.html" onMouseOver="funcPopup(event,'set_config')">set_config</a>('rpc_negotiation_timeout', <a class="var it1113" onMouseOver="hilite(1113)" onMouseOut="lolite()" onClick="logVariable('config')" href="../../_variables/config.html">$config</a>-&gt;<a onClick="logVariable('rpc_negotiation_timeout')" class="var it39457" onMouseOver="hilite(39457)" onMouseOut="lolite()" href="../../_variables/rpc_negotiation_timeout.html">rpc_negotiation_timeout</a>, 'auth_mnet');
<a name="l697"><span class="linenum"> 697</span></a>  
<a name="l698"><span class="linenum"> 698</span></a>          return true;
<a name="l699"><span class="linenum"> 699</span></a>      }
<a name="l700"><span class="linenum"> 700</span></a>  
<a name="l701"><span class="linenum"> 701</span></a>      <span class="comment">/**</span>
<a name="l702"><span class="linenum"> 702</span></a>  <span class="comment">     * Poll the IdP server to let it know that a user it has authenticated is still</span>
<a name="l703"><span class="linenum"> 703</span></a>  <span class="comment">     * online</span>
<a name="l704"><span class="linenum"> 704</span></a>  <span class="comment">     *</span>
<a name="l705"><span class="linenum"> 705</span></a>  <span class="comment">     * @return  void</span>
<a name="l706"><span class="linenum"> 706</span></a>  <span class="comment">     */</span>
<a name="l707"><span class="linenum"> 707</span></a>      function <a class="function" onClick="logFunction('keepalive_client')" href="../../_functions/keepalive_client.html" onMouseOver="funcPopup(event,'keepalive_client')">keepalive_client</a>() {
<a name="l708"><span class="linenum"> 708</span></a>          global <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l709"><span class="linenum"> 709</span></a>          <a class="var it20798" onMouseOver="hilite(20798)" onMouseOut="lolite()" onClick="logVariable('cutoff')" href="../../_variables/cutoff.html">$cutoff</a> = <a class="phpfunction" onClick="logFunction('time')" href="../../_functions/time.html" onMouseOver="phpfuncPopup(event,'time')">time</a>() - 300; <span class="comment">// TODO - find out what the remote server's session</span>
<a name="l710"><span class="linenum"> 710</span></a>  <span class="comment">                                // cutoff is, and preempt that</span>
<a name="l711"><span class="linenum"> 711</span></a>  
<a name="l712"><span class="linenum"> 712</span></a>          <a class="var it125" onMouseOver="hilite(125)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a> = &quot;
<a name="l713"><span class="linenum"> 713</span></a>              select
<a name="l714"><span class="linenum"> 714</span></a>                  id,
<a name="l715"><span class="linenum"> 715</span></a>                  username,
<a name="l716"><span class="linenum"> 716</span></a>                  mnethostid
<a name="l717"><span class="linenum"> 717</span></a>              from
<a name="l718"><span class="linenum"> 718</span></a>                  {user}
<a name="l719"><span class="linenum"> 719</span></a>              where
<a name="l720"><span class="linenum"> 720</span></a>                  lastaccess &gt; ? AND
<a name="l721"><span class="linenum"> 721</span></a>                  mnethostid != ?
<a name="l722"><span class="linenum"> 722</span></a>              order by
<a name="l723"><span class="linenum"> 723</span></a>                  mnethostid&quot;;
<a name="l724"><span class="linenum"> 724</span></a>  
<a name="l725"><span class="linenum"> 725</span></a>          <a class="var it20799" onMouseOver="hilite(20799)" onMouseOut="lolite()" onClick="logVariable('immigrants')" href="../../_variables/immigrants.html">$immigrants</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records_sql')" href="../../_functions/get_records_sql.html" onMouseOver="funcPopup(event,'get_records_sql')">get_records_sql</a>(<a class="var it125" onMouseOver="hilite(125)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a>, array(<a class="var it20798" onMouseOver="hilite(20798)" onMouseOut="lolite()" onClick="logVariable('cutoff')" href="../../_variables/cutoff.html">$cutoff</a>, <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('mnet_localhost_id')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/mnet_localhost_id.html">mnet_localhost_id</a>));
<a name="l726"><span class="linenum"> 726</span></a>  
<a name="l727"><span class="linenum"> 727</span></a>          if (<a class="var it20799" onMouseOver="hilite(20799)" onMouseOut="lolite()" onClick="logVariable('immigrants')" href="../../_variables/immigrants.html">$immigrants</a> == false) {
<a name="l728"><span class="linenum"> 728</span></a>              return true;
<a name="l729"><span class="linenum"> 729</span></a>          }
<a name="l730"><span class="linenum"> 730</span></a>  
<a name="l731"><span class="linenum"> 731</span></a>          <a class="var it20800" onMouseOver="hilite(20800)" onMouseOut="lolite()" onClick="logVariable('usersArray')" href="../../_variables/usersArray.html">$usersArray</a> = array();
<a name="l732"><span class="linenum"> 732</span></a>          foreach(<a class="var it20799" onMouseOver="hilite(20799)" onMouseOut="lolite()" onClick="logVariable('immigrants')" href="../../_variables/immigrants.html">$immigrants</a> as <a class="var it20801" onMouseOver="hilite(20801)" onMouseOut="lolite()" onClick="logVariable('immigrant')" href="../../_variables/immigrant.html">$immigrant</a>) {
<a name="l733"><span class="linenum"> 733</span></a>              <a class="var it20800" onMouseOver="hilite(20800)" onMouseOut="lolite()" onClick="logVariable('usersArray')" href="../../_variables/usersArray.html">$usersArray</a>[<a class="var it20801" onMouseOver="hilite(20801)" onMouseOut="lolite()" onClick="logVariable('immigrant')" href="../../_variables/immigrant.html">$immigrant</a>-&gt;<a onClick="logVariable('mnethostid')" class="var it39830" onMouseOver="hilite(39830)" onMouseOut="lolite()" href="../../_variables/mnethostid.html">mnethostid</a>][] = <a class="var it20801" onMouseOver="hilite(20801)" onMouseOut="lolite()" onClick="logVariable('immigrant')" href="../../_variables/immigrant.html">$immigrant</a>-&gt;<a onClick="logVariable('username')" class="var it39830" onMouseOver="hilite(39830)" onMouseOut="lolite()" href="../../_variables/username.html">username</a>;
<a name="l734"><span class="linenum"> 734</span></a>          }
<a name="l735"><span class="linenum"> 735</span></a>  
<a name="l736"><span class="linenum"> 736</span></a>          require_once <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('dirroot')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/dirroot.html">dirroot</a> . '<a class="filename" href="../../mnet/xmlrpc/client.php.html">/mnet/xmlrpc/client.php</a>';
<a name="l737"><span class="linenum"> 737</span></a>          foreach(<a class="var it20800" onMouseOver="hilite(20800)" onMouseOut="lolite()" onClick="logVariable('usersArray')" href="../../_variables/usersArray.html">$usersArray</a> as <a class="var it523" onMouseOver="hilite(523)" onMouseOut="lolite()" onClick="logVariable('mnethostid')" href="../../_variables/mnethostid.html">$mnethostid</a> =&gt; <a class="var it572" onMouseOver="hilite(572)" onMouseOut="lolite()" onClick="logVariable('users')" href="../../_variables/users.html">$users</a>) {
<a name="l738"><span class="linenum"> 738</span></a>              <a class="var it15854" onMouseOver="hilite(15854)" onMouseOut="lolite()" onClick="logVariable('mnet_peer')" href="../../_variables/mnet_peer.html">$mnet_peer</a> = <span class="keyword">new </span><a class="class" onClick="logClass('mnet_peer')" href="../../_classes/mnet_peer.html" onMouseOver="classPopup(event,'mnet_peer')">mnet_peer</a>();
<a name="l739"><span class="linenum"> 739</span></a>              <a class="var it15854" onMouseOver="hilite(15854)" onMouseOut="lolite()" onClick="logVariable('mnet_peer')" href="../../_variables/mnet_peer.html">$mnet_peer</a>-&gt;<a class="function" onClick="logFunction('set_id')" href="../../_functions/set_id.html" onMouseOver="funcPopup(event,'set_id')">set_id</a>(<a class="var it523" onMouseOver="hilite(523)" onMouseOut="lolite()" onClick="logVariable('mnethostid')" href="../../_variables/mnethostid.html">$mnethostid</a>);
<a name="l740"><span class="linenum"> 740</span></a>  
<a name="l741"><span class="linenum"> 741</span></a>              <a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a> = <span class="keyword">new </span><a class="class" onClick="logClass('mnet_xmlrpc_client')" href="../../_classes/mnet_xmlrpc_client.html" onMouseOver="classPopup(event,'mnet_xmlrpc_client')">mnet_xmlrpc_client</a>();
<a name="l742"><span class="linenum"> 742</span></a>              <a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a>-&gt;<a class="function" onClick="logFunction('set_method')" href="../../_functions/set_method.html" onMouseOver="funcPopup(event,'set_method')">set_method</a>('auth/mnet/auth.php/keepalive_server');
<a name="l743"><span class="linenum"> 743</span></a>  
<a name="l744"><span class="linenum"> 744</span></a>  <span class="comment">            // set $token and $useragent parameters</span>
<a name="l745"><span class="linenum"> 745</span></a>              <a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a>-&gt;<a class="function" onClick="logFunction('add_param')" href="../../_functions/add_param.html" onMouseOver="funcPopup(event,'add_param')">add_param</a>(<a class="var it572" onMouseOver="hilite(572)" onMouseOut="lolite()" onClick="logVariable('users')" href="../../_variables/users.html">$users</a>);
<a name="l746"><span class="linenum"> 746</span></a>  
<a name="l747"><span class="linenum"> 747</span></a>              if (<a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a>-&gt;<a class="function" onClick="logFunction('send')" href="../../_functions/send.html" onMouseOver="funcPopup(event,'send')">send</a>(<a class="var it15854" onMouseOver="hilite(15854)" onMouseOut="lolite()" onClick="logVariable('mnet_peer')" href="../../_variables/mnet_peer.html">$mnet_peer</a>) === true) {
<a name="l748"><span class="linenum"> 748</span></a>                  if (!isset(<a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a>-&gt;<a onClick="logVariable('response')" class="var it39831" onMouseOver="hilite(39831)" onMouseOut="lolite()" href="../../_variables/response.html">response</a>['code'])) {
<a name="l749"><span class="linenum"> 749</span></a>                      <a class="function" onClick="logFunction('debugging')" href="../../_functions/debugging.html" onMouseOver="funcPopup(event,'debugging')">debugging</a>(&quot;Server side error has occured on host <a class="var it523" onMouseOver="hilite(523)" onMouseOut="lolite()" onClick="logVariable('mnethostid')" href="../../_variables/mnethostid.html">$mnethostid</a>&quot;);
<a name="l750"><span class="linenum"> 750</span></a>                      continue;
<a name="l751"><span class="linenum"> 751</span></a>                  } elseif (<a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a>-&gt;<a onClick="logVariable('response')" class="var it39831" onMouseOver="hilite(39831)" onMouseOut="lolite()" href="../../_variables/response.html">response</a>['code'] &gt; 0) {
<a name="l752"><span class="linenum"> 752</span></a>                      <a class="function" onClick="logFunction('debugging')" href="../../_functions/debugging.html" onMouseOver="funcPopup(event,'debugging')">debugging</a>(<a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a>-&gt;<a onClick="logVariable('response')" class="var it39831" onMouseOver="hilite(39831)" onMouseOut="lolite()" href="../../_variables/response.html">response</a>['message']);
<a name="l753"><span class="linenum"> 753</span></a>                  }
<a name="l754"><span class="linenum"> 754</span></a>  
<a name="l755"><span class="linenum"> 755</span></a>                  if (!isset(<a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a>-&gt;<a onClick="logVariable('response')" class="var it39831" onMouseOver="hilite(39831)" onMouseOut="lolite()" href="../../_variables/response.html">response</a>['last log id'])) {
<a name="l756"><span class="linenum"> 756</span></a>                      <a class="function" onClick="logFunction('debugging')" href="../../_functions/debugging.html" onMouseOver="funcPopup(event,'debugging')">debugging</a>(&quot;Server side error has occured on host <a class="var it523" onMouseOver="hilite(523)" onMouseOut="lolite()" onClick="logVariable('mnethostid')" href="../../_variables/mnethostid.html">$mnethostid</a>\nNo log ID was received.&quot;);
<a name="l757"><span class="linenum"> 757</span></a>                      continue;
<a name="l758"><span class="linenum"> 758</span></a>                  }
<a name="l759"><span class="linenum"> 759</span></a>              } else {
<a name="l760"><span class="linenum"> 760</span></a>                  <a class="function" onClick="logFunction('debugging')" href="../../_functions/debugging.html" onMouseOver="funcPopup(event,'debugging')">debugging</a>(&quot;Server side error has occured on host <a class="var it523" onMouseOver="hilite(523)" onMouseOut="lolite()" onClick="logVariable('mnethostid')" href="../../_variables/mnethostid.html">$mnethostid</a>: &quot; .
<a name="l761"><span class="linenum"> 761</span></a>                            <a class="function" onClick="logFunction('join')" href="../../_functions/join.html" onMouseOver="funcPopup(event,'join')">join</a>(&quot;\n&quot;, <a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a>-&gt;<a onClick="logVariable('error')" class="var it39831" onMouseOver="hilite(39831)" onMouseOut="lolite()" href="../../_variables/error.html">error</a>));
<a name="l762"><span class="linenum"> 762</span></a>                  break;
<a name="l763"><span class="linenum"> 763</span></a>              }
<a name="l764"><span class="linenum"> 764</span></a>          }
<a name="l765"><span class="linenum"> 765</span></a>      }
<a name="l766"><span class="linenum"> 766</span></a>  
<a name="l767"><span class="linenum"> 767</span></a>      <span class="comment">/**</span>
<a name="l768"><span class="linenum"> 768</span></a>  <span class="comment">     * Receives an array of log entries from an SP and adds them to the mnet_log</span>
<a name="l769"><span class="linenum"> 769</span></a>  <span class="comment">     * table</span>
<a name="l770"><span class="linenum"> 770</span></a>  <span class="comment">     *</span>
<a name="l771"><span class="linenum"> 771</span></a>  <span class="comment">     * @deprecated since Moodle 2.8 Please don't use this function for recording mnet logs.</span>
<a name="l772"><span class="linenum"> 772</span></a>  <span class="comment">     * @param   array   $array      An array of usernames</span>
<a name="l773"><span class="linenum"> 773</span></a>  <span class="comment">     * @return  string              &quot;All ok&quot; or an error message</span>
<a name="l774"><span class="linenum"> 774</span></a>  <span class="comment">     */</span>
<a name="l775"><span class="linenum"> 775</span></a>      function <a class="function" onClick="logFunction('refresh_log')" href="../../_functions/refresh_log.html" onMouseOver="funcPopup(event,'refresh_log')">refresh_log</a>(<a class="var it134" onMouseOver="hilite(134)" onMouseOut="lolite()" onClick="logVariable('array')" href="../../_variables/array.html">$array</a>) {
<a name="l776"><span class="linenum"> 776</span></a>          <a class="function" onClick="logFunction('debugging')" href="../../_functions/debugging.html" onMouseOver="funcPopup(event,'debugging')">debugging</a>('<a class="function" onClick="logFunction('refresh_log')" href="../../_functions/refresh_log.html" onMouseOver="funcPopup(event,'refresh_log')">refresh_log</a>() is deprecated, The transfer of logs through mnet are no longer recorded.', <a class="constant" onClick="logConstant('DEBUG_DEVELOPER')" href="../../_constants/DEBUG_DEVELOPER.html" onMouseOver="constPopup(event,'DEBUG_DEVELOPER')">DEBUG_DEVELOPER</a>);
<a name="l777"><span class="linenum"> 777</span></a>          return array('code' =&gt; 0, 'message' =&gt; 'All ok');
<a name="l778"><span class="linenum"> 778</span></a>      }
<a name="l779"><span class="linenum"> 779</span></a>  
<a name="l780"><span class="linenum"> 780</span></a>      <span class="comment">/**</span>
<a name="l781"><span class="linenum"> 781</span></a>  <span class="comment">     * Receives an array of usernames from a remote machine and prods their</span>
<a name="l782"><span class="linenum"> 782</span></a>  <span class="comment">     * sessions to keep them alive</span>
<a name="l783"><span class="linenum"> 783</span></a>  <span class="comment">     *</span>
<a name="l784"><span class="linenum"> 784</span></a>  <span class="comment">     * @param   array   $array      An array of usernames</span>
<a name="l785"><span class="linenum"> 785</span></a>  <span class="comment">     * @return  string              &quot;All ok&quot; or an error message</span>
<a name="l786"><span class="linenum"> 786</span></a>  <span class="comment">     */</span>
<a name="l787"><span class="linenum"> 787</span></a>      function <a class="function" onClick="logFunction('keepalive_server')" href="../../_functions/keepalive_server.html" onMouseOver="funcPopup(event,'keepalive_server')">keepalive_server</a>(<a class="var it134" onMouseOver="hilite(134)" onMouseOut="lolite()" onClick="logVariable('array')" href="../../_variables/array.html">$array</a>) {
<a name="l788"><span class="linenum"> 788</span></a>          global <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l789"><span class="linenum"> 789</span></a>          <a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a> = <a class="function" onClick="logFunction('get_mnet_remote_client')" href="../../_functions/get_mnet_remote_client.html" onMouseOver="funcPopup(event,'get_mnet_remote_client')">get_mnet_remote_client</a>();
<a name="l790"><span class="linenum"> 790</span></a>  
<a name="l791"><span class="linenum"> 791</span></a>  <span class="comment">        // We don't want to output anything to the client machine</span>
<a name="l792"><span class="linenum"> 792</span></a>          <a class="var it340" onMouseOver="hilite(340)" onMouseOut="lolite()" onClick="logVariable('start')" href="../../_variables/start.html">$start</a> = <a class="phpfunction" onClick="logFunction('ob_start')" href="../../_functions/ob_start.html" onMouseOver="phpfuncPopup(event,'ob_start')">ob_start</a>();
<a name="l793"><span class="linenum"> 793</span></a>  
<a name="l794"><span class="linenum"> 794</span></a>  <span class="comment">        // We'll get session records in batches of 30</span>
<a name="l795"><span class="linenum"> 795</span></a>          <a class="var it20803" onMouseOver="hilite(20803)" onMouseOut="lolite()" onClick="logVariable('superArray')" href="../../_variables/superArray.html">$superArray</a> = <a class="phpfunction" onClick="logFunction('array_chunk')" href="../../_functions/array_chunk.html" onMouseOver="phpfuncPopup(event,'array_chunk')">array_chunk</a>(<a class="var it134" onMouseOver="hilite(134)" onMouseOut="lolite()" onClick="logVariable('array')" href="../../_variables/array.html">$array</a>, 30);
<a name="l796"><span class="linenum"> 796</span></a>  
<a name="l797"><span class="linenum"> 797</span></a>          <a class="var it20804" onMouseOver="hilite(20804)" onMouseOut="lolite()" onClick="logVariable('returnString')" href="../../_variables/returnString.html">$returnString</a> = '';
<a name="l798"><span class="linenum"> 798</span></a>  
<a name="l799"><span class="linenum"> 799</span></a>          foreach(<a class="var it20803" onMouseOver="hilite(20803)" onMouseOut="lolite()" onClick="logVariable('superArray')" href="../../_variables/superArray.html">$superArray</a> as <a class="var it20805" onMouseOver="hilite(20805)" onMouseOut="lolite()" onClick="logVariable('subArray')" href="../../_variables/subArray.html">$subArray</a>) {
<a name="l800"><span class="linenum"> 800</span></a>              <a class="var it20805" onMouseOver="hilite(20805)" onMouseOut="lolite()" onClick="logVariable('subArray')" href="../../_variables/subArray.html">$subArray</a> = <a class="phpfunction" onClick="logFunction('array_values')" href="../../_functions/array_values.html" onMouseOver="phpfuncPopup(event,'array_values')">array_values</a>(<a class="var it20805" onMouseOver="hilite(20805)" onMouseOut="lolite()" onClick="logVariable('subArray')" href="../../_variables/subArray.html">$subArray</a>);
<a name="l801"><span class="linenum"> 801</span></a>              <a class="var it20806" onMouseOver="hilite(20806)" onMouseOut="lolite()" onClick="logVariable('instring')" href="../../_variables/instring.html">$instring</a> = &quot;('&quot;.<a class="phpfunction" onClick="logFunction('implode')" href="../../_functions/implode.html" onMouseOver="phpfuncPopup(event,'implode')">implode</a>(&quot;', '&quot;,<a class="var it20805" onMouseOver="hilite(20805)" onMouseOut="lolite()" onClick="logVariable('subArray')" href="../../_variables/subArray.html">$subArray</a>).&quot;')&quot;;
<a name="l802"><span class="linenum"> 802</span></a>              <a class="var it450" onMouseOver="hilite(450)" onMouseOut="lolite()" onClick="logVariable('query')" href="../../_variables/query.html">$query</a> = &quot;select id, session_id, username from {mnet_session} where username in <a class="var it20806" onMouseOver="hilite(20806)" onMouseOut="lolite()" onClick="logVariable('instring')" href="../../_variables/instring.html">$instring</a>&quot;;
<a name="l803"><span class="linenum"> 803</span></a>              <a class="var it594" onMouseOver="hilite(594)" onMouseOut="lolite()" onClick="logVariable('results')" href="../../_variables/results.html">$results</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records_sql')" href="../../_functions/get_records_sql.html" onMouseOver="funcPopup(event,'get_records_sql')">get_records_sql</a>(<a class="var it450" onMouseOver="hilite(450)" onMouseOut="lolite()" onClick="logVariable('query')" href="../../_variables/query.html">$query</a>);
<a name="l804"><span class="linenum"> 804</span></a>  
<a name="l805"><span class="linenum"> 805</span></a>              if (<a class="var it594" onMouseOver="hilite(594)" onMouseOut="lolite()" onClick="logVariable('results')" href="../../_variables/results.html">$results</a> == false) {
<a name="l806"><span class="linenum"> 806</span></a>  <span class="comment">                // We seem to have a username that breaks our query:</span>
<a name="l807"><span class="linenum"> 807</span></a>  <span class="comment">                // TODO: Handle this error appropriately</span>
<a name="l808"><span class="linenum"> 808</span></a>                  <a class="var it20804" onMouseOver="hilite(20804)" onMouseOut="lolite()" onClick="logVariable('returnString')" href="../../_variables/returnString.html">$returnString</a> .= &quot;We failed to refresh the session for the following usernames: \n&quot;.<a class="phpfunction" onClick="logFunction('implode')" href="../../_functions/implode.html" onMouseOver="phpfuncPopup(event,'implode')">implode</a>(&quot;\n&quot;, <a class="var it20805" onMouseOver="hilite(20805)" onMouseOut="lolite()" onClick="logVariable('subArray')" href="../../_variables/subArray.html">$subArray</a>).&quot;\n\n&quot;;
<a name="l809"><span class="linenum"> 809</span></a>              } else {
<a name="l810"><span class="linenum"> 810</span></a>                  foreach(<a class="var it594" onMouseOver="hilite(594)" onMouseOut="lolite()" onClick="logVariable('results')" href="../../_variables/results.html">$results</a> as <a class="var it20807" onMouseOver="hilite(20807)" onMouseOut="lolite()" onClick="logVariable('emigrant')" href="../../_variables/emigrant.html">$emigrant</a>) {
<a name="l811"><span class="linenum"> 811</span></a>                      \core\session\<a class="class" onClick="logClass('manager')" href="../../_classes/manager.html" onMouseOver="classPopup(event,'manager')">manager</a>::<a class="function" onClick="logFunction('touch_session')" href="../../_functions/touch_session.html" onMouseOver="funcPopup(event,'touch_session')">touch_session</a>(<a class="var it20807" onMouseOver="hilite(20807)" onMouseOut="lolite()" onClick="logVariable('emigrant')" href="../../_variables/emigrant.html">$emigrant</a>-&gt;<a onClick="logVariable('session_id')" class="var it39832" onMouseOver="hilite(39832)" onMouseOut="lolite()" href="../../_variables/session_id.html">session_id</a>);
<a name="l812"><span class="linenum"> 812</span></a>                  }
<a name="l813"><span class="linenum"> 813</span></a>              }
<a name="l814"><span class="linenum"> 814</span></a>          }
<a name="l815"><span class="linenum"> 815</span></a>  
<a name="l816"><span class="linenum"> 816</span></a>          <a class="var it1658" onMouseOver="hilite(1658)" onMouseOut="lolite()" onClick="logVariable('end')" href="../../_variables/end.html">$end</a> = <a class="phpfunction" onClick="logFunction('ob_end_clean')" href="../../_functions/ob_end_clean.html" onMouseOver="phpfuncPopup(event,'ob_end_clean')">ob_end_clean</a>();
<a name="l817"><span class="linenum"> 817</span></a>  
<a name="l818"><span class="linenum"> 818</span></a>          if (empty(<a class="var it20804" onMouseOver="hilite(20804)" onMouseOut="lolite()" onClick="logVariable('returnString')" href="../../_variables/returnString.html">$returnString</a>)) return array('code' =&gt; 0, 'message' =&gt; 'All ok', 'last log id' =&gt; <a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a>-&gt;<a onClick="logVariable('last_log_id')" class="var it39817" onMouseOver="hilite(39817)" onMouseOut="lolite()" href="../../_variables/last_log_id.html">last_log_id</a>);
<a name="l819"><span class="linenum"> 819</span></a>          return array('code' =&gt; 1, 'message' =&gt; <a class="var it20804" onMouseOver="hilite(20804)" onMouseOut="lolite()" onClick="logVariable('returnString')" href="../../_variables/returnString.html">$returnString</a>, 'last log id' =&gt; <a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a>-&gt;<a onClick="logVariable('last_log_id')" class="var it39817" onMouseOver="hilite(39817)" onMouseOut="lolite()" href="../../_variables/last_log_id.html">last_log_id</a>);
<a name="l820"><span class="linenum"> 820</span></a>      }
<a name="l821"><span class="linenum"> 821</span></a>  
<a name="l822"><span class="linenum"> 822</span></a>      <span class="comment">/**</span>
<a name="l823"><span class="linenum"> 823</span></a>  <span class="comment">     * Cron function will be called automatically by cron.php every 5 minutes</span>
<a name="l824"><span class="linenum"> 824</span></a>  <span class="comment">     *</span>
<a name="l825"><span class="linenum"> 825</span></a>  <span class="comment">     * @return void</span>
<a name="l826"><span class="linenum"> 826</span></a>  <span class="comment">     */</span>
<a name="l827"><span class="linenum"> 827</span></a>      function <a class="function" onClick="logFunction('cron')" href="../../_functions/cron.html" onMouseOver="funcPopup(event,'cron')">cron</a>() {
<a name="l828"><span class="linenum"> 828</span></a>          global <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l829"><span class="linenum"> 829</span></a>  
<a name="l830"><span class="linenum"> 830</span></a>  <span class="comment">        // run the keepalive client</span>
<a name="l831"><span class="linenum"> 831</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('keepalive_client')" href="../../_functions/keepalive_client.html" onMouseOver="funcPopup(event,'keepalive_client')">keepalive_client</a>();
<a name="l832"><span class="linenum"> 832</span></a>  
<a name="l833"><span class="linenum"> 833</span></a>          <a class="var it20809" onMouseOver="hilite(20809)" onMouseOut="lolite()" onClick="logVariable('random100')" href="../../_variables/random100.html">$random100</a> = <a class="phpfunction" onClick="logFunction('rand')" href="../../_functions/rand.html" onMouseOver="phpfuncPopup(event,'rand')">rand</a>(0,100);
<a name="l834"><span class="linenum"> 834</span></a>          if (<a class="var it20809" onMouseOver="hilite(20809)" onMouseOut="lolite()" onClick="logVariable('random100')" href="../../_variables/random100.html">$random100</a> &lt; 10) {     // Approximately 10% of the time.
<a name="l835"><span class="linenum"> 835</span></a>  <span class="comment">            // nuke olden sessions</span>
<a name="l836"><span class="linenum"> 836</span></a>              <a class="var it20810" onMouseOver="hilite(20810)" onMouseOut="lolite()" onClick="logVariable('longtime')" href="../../_variables/longtime.html">$longtime</a> = <a class="phpfunction" onClick="logFunction('time')" href="../../_functions/time.html" onMouseOver="phpfuncPopup(event,'time')">time</a>() - (1 * 3600 * 24);
<a name="l837"><span class="linenum"> 837</span></a>              <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('delete_records_select')" href="../../_functions/delete_records_select.html" onMouseOver="funcPopup(event,'delete_records_select')">delete_records_select</a>('mnet_session', &quot;expires &lt; ?&quot;, array(<a class="var it20810" onMouseOver="hilite(20810)" onMouseOut="lolite()" onClick="logVariable('longtime')" href="../../_variables/longtime.html">$longtime</a>));
<a name="l838"><span class="linenum"> 838</span></a>          }
<a name="l839"><span class="linenum"> 839</span></a>      }
<a name="l840"><span class="linenum"> 840</span></a>  
<a name="l841"><span class="linenum"> 841</span></a>      <span class="comment">/**</span>
<a name="l842"><span class="linenum"> 842</span></a>  <span class="comment">     * Cleanup any remote mnet_sessions, kill the local mnet_session data</span>
<a name="l843"><span class="linenum"> 843</span></a>  <span class="comment">     *</span>
<a name="l844"><span class="linenum"> 844</span></a>  <span class="comment">     * This is called by require_logout in moodlelib</span>
<a name="l845"><span class="linenum"> 845</span></a>  <span class="comment">     *</span>
<a name="l846"><span class="linenum"> 846</span></a>  <span class="comment">     * @return   void</span>
<a name="l847"><span class="linenum"> 847</span></a>  <span class="comment">     */</span>
<a name="l848"><span class="linenum"> 848</span></a>      function <a class="function" onClick="logFunction('prelogout_hook')" href="../../_functions/prelogout_hook.html" onMouseOver="funcPopup(event,'prelogout_hook')">prelogout_hook</a>() {
<a name="l849"><span class="linenum"> 849</span></a>          global <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it9" onMouseOver="hilite(9)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>;
<a name="l850"><span class="linenum"> 850</span></a>  
<a name="l851"><span class="linenum"> 851</span></a>          if (!<a class="function" onClick="logFunction('is_enabled_auth')" href="../../_functions/is_enabled_auth.html" onMouseOver="funcPopup(event,'is_enabled_auth')">is_enabled_auth</a>('mnet')) {
<a name="l852"><span class="linenum"> 852</span></a>              return;
<a name="l853"><span class="linenum"> 853</span></a>          }
<a name="l854"><span class="linenum"> 854</span></a>  
<a name="l855"><span class="linenum"> 855</span></a>  <span class="comment">        // If the user is local to this Moodle:</span>
<a name="l856"><span class="linenum"> 856</span></a>          if (<a class="var it9" onMouseOver="hilite(9)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>-&gt;<a onClick="logVariable('mnethostid')" class="var it39490" onMouseOver="hilite(39490)" onMouseOut="lolite()" href="../../_variables/mnethostid.html">mnethostid</a> == <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('mnet')" class="var it39456" onMouseOver="hilite(39456)" onMouseOut="lolite()" href="../../_variables/mnet.html">mnet</a>-&gt;id) {
<a name="l857"><span class="linenum"> 857</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('kill_children')" href="../../_functions/kill_children.html" onMouseOver="funcPopup(event,'kill_children')">kill_children</a>(<a class="var it9" onMouseOver="hilite(9)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>-&gt;<a onClick="logVariable('username')" class="var it39490" onMouseOver="hilite(39490)" onMouseOut="lolite()" href="../../_variables/username.html">username</a>, <a class="phpfunction" onClick="logFunction('sha1')" href="../../_functions/sha1.html" onMouseOver="phpfuncPopup(event,'sha1')">sha1</a>(<a class="var it74" onMouseOver="hilite(74)" onMouseOut="lolite()" onClick="logVariable('_SERVER')" href="../../_variables/_SERVER.html">$_SERVER</a>['HTTP_USER_AGENT']));
<a name="l858"><span class="linenum"> 858</span></a>  
<a name="l859"><span class="linenum"> 859</span></a>  <span class="comment">        // Else the user has hit 'logout' at a Service Provider Moodle:</span>
<a name="l860"><span class="linenum"> 860</span></a>          } else {
<a name="l861"><span class="linenum"> 861</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('kill_parent')" href="../../_functions/kill_parent.html" onMouseOver="funcPopup(event,'kill_parent')">kill_parent</a>(<a class="var it9" onMouseOver="hilite(9)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>-&gt;<a onClick="logVariable('username')" class="var it39490" onMouseOver="hilite(39490)" onMouseOut="lolite()" href="../../_variables/username.html">username</a>, <a class="phpfunction" onClick="logFunction('sha1')" href="../../_functions/sha1.html" onMouseOver="phpfuncPopup(event,'sha1')">sha1</a>(<a class="var it74" onMouseOver="hilite(74)" onMouseOut="lolite()" onClick="logVariable('_SERVER')" href="../../_variables/_SERVER.html">$_SERVER</a>['HTTP_USER_AGENT']));
<a name="l862"><span class="linenum"> 862</span></a>  
<a name="l863"><span class="linenum"> 863</span></a>          }
<a name="l864"><span class="linenum"> 864</span></a>      }
<a name="l865"><span class="linenum"> 865</span></a>  
<a name="l866"><span class="linenum"> 866</span></a>      <span class="comment">/**</span>
<a name="l867"><span class="linenum"> 867</span></a>  <span class="comment">     * The SP uses this function to kill the session on the parent IdP</span>
<a name="l868"><span class="linenum"> 868</span></a>  <span class="comment">     *</span>
<a name="l869"><span class="linenum"> 869</span></a>  <span class="comment">     * @param   string  $username       Username for session to kill</span>
<a name="l870"><span class="linenum"> 870</span></a>  <span class="comment">     * @param   string  $useragent      SHA1 hash of user agent to look for</span>
<a name="l871"><span class="linenum"> 871</span></a>  <span class="comment">     * @return  string                  A plaintext report of what has happened</span>
<a name="l872"><span class="linenum"> 872</span></a>  <span class="comment">     */</span>
<a name="l873"><span class="linenum"> 873</span></a>      function <a class="function" onClick="logFunction('kill_parent')" href="../../_functions/kill_parent.html" onMouseOver="funcPopup(event,'kill_parent')">kill_parent</a>(<a class="var it463" onMouseOver="hilite(463)" onMouseOut="lolite()" onClick="logVariable('username')" href="../../_variables/username.html">$username</a>, <a class="var it3522" onMouseOver="hilite(3522)" onMouseOut="lolite()" onClick="logVariable('useragent')" href="../../_variables/useragent.html">$useragent</a>) {
<a name="l874"><span class="linenum"> 874</span></a>          global <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it9" onMouseOver="hilite(9)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>, <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l875"><span class="linenum"> 875</span></a>  
<a name="l876"><span class="linenum"> 876</span></a>          require_once <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('dirroot')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/dirroot.html">dirroot</a>.'<a class="filename" href="../../mnet/xmlrpc/client.php.html">/mnet/xmlrpc/client.php</a>';
<a name="l877"><span class="linenum"> 877</span></a>          <a class="var it125" onMouseOver="hilite(125)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a> = &quot;
<a name="l878"><span class="linenum"> 878</span></a>              select
<a name="l879"><span class="linenum"> 879</span></a>                  *
<a name="l880"><span class="linenum"> 880</span></a>              from
<a name="l881"><span class="linenum"> 881</span></a>                  {mnet_session} s
<a name="l882"><span class="linenum"> 882</span></a>              where
<a name="l883"><span class="linenum"> 883</span></a>                  s.username   = ? AND
<a name="l884"><span class="linenum"> 884</span></a>                  s.useragent  = ? AND
<a name="l885"><span class="linenum"> 885</span></a>                  s.mnethostid = ?&quot;;
<a name="l886"><span class="linenum"> 886</span></a>  
<a name="l887"><span class="linenum"> 887</span></a>          <a class="var it20781" onMouseOver="hilite(20781)" onMouseOut="lolite()" onClick="logVariable('mnetsessions')" href="../../_variables/mnetsessions.html">$mnetsessions</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records_sql')" href="../../_functions/get_records_sql.html" onMouseOver="funcPopup(event,'get_records_sql')">get_records_sql</a>(<a class="var it125" onMouseOver="hilite(125)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a>, array(<a class="var it463" onMouseOver="hilite(463)" onMouseOut="lolite()" onClick="logVariable('username')" href="../../_variables/username.html">$username</a>, <a class="var it3522" onMouseOver="hilite(3522)" onMouseOut="lolite()" onClick="logVariable('useragent')" href="../../_variables/useragent.html">$useragent</a>, <a class="var it9" onMouseOver="hilite(9)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>-&gt;<a onClick="logVariable('mnethostid')" class="var it39490" onMouseOver="hilite(39490)" onMouseOut="lolite()" href="../../_variables/mnethostid.html">mnethostid</a>));
<a name="l888"><span class="linenum"> 888</span></a>  
<a name="l889"><span class="linenum"> 889</span></a>          <a class="var it6503" onMouseOver="hilite(6503)" onMouseOut="lolite()" onClick="logVariable('ignore')" href="../../_variables/ignore.html">$ignore</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('delete_records')" href="../../_functions/delete_records.html" onMouseOver="funcPopup(event,'delete_records')">delete_records</a>('mnet_session',
<a name="l890"><span class="linenum"> 890</span></a>                                   array('username'=&gt;<a class="var it463" onMouseOver="hilite(463)" onMouseOut="lolite()" onClick="logVariable('username')" href="../../_variables/username.html">$username</a>,
<a name="l891"><span class="linenum"> 891</span></a>                                   'useragent'=&gt;<a class="var it3522" onMouseOver="hilite(3522)" onMouseOut="lolite()" onClick="logVariable('useragent')" href="../../_variables/useragent.html">$useragent</a>,
<a name="l892"><span class="linenum"> 892</span></a>                                   'mnethostid'=&gt;<a class="var it9" onMouseOver="hilite(9)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>-&gt;<a onClick="logVariable('mnethostid')" class="var it39490" onMouseOver="hilite(39490)" onMouseOut="lolite()" href="../../_variables/mnethostid.html">mnethostid</a>));
<a name="l893"><span class="linenum"> 893</span></a>  
<a name="l894"><span class="linenum"> 894</span></a>          if (false != <a class="var it20781" onMouseOver="hilite(20781)" onMouseOut="lolite()" onClick="logVariable('mnetsessions')" href="../../_variables/mnetsessions.html">$mnetsessions</a>) {
<a name="l895"><span class="linenum"> 895</span></a>              <a class="var it15854" onMouseOver="hilite(15854)" onMouseOut="lolite()" onClick="logVariable('mnet_peer')" href="../../_variables/mnet_peer.html">$mnet_peer</a> = <span class="keyword">new </span><a class="class" onClick="logClass('mnet_peer')" href="../../_classes/mnet_peer.html" onMouseOver="classPopup(event,'mnet_peer')">mnet_peer</a>();
<a name="l896"><span class="linenum"> 896</span></a>              <a class="var it15854" onMouseOver="hilite(15854)" onMouseOut="lolite()" onClick="logVariable('mnet_peer')" href="../../_variables/mnet_peer.html">$mnet_peer</a>-&gt;<a class="function" onClick="logFunction('set_id')" href="../../_functions/set_id.html" onMouseOver="funcPopup(event,'set_id')">set_id</a>(<a class="var it9" onMouseOver="hilite(9)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>-&gt;<a onClick="logVariable('mnethostid')" class="var it39490" onMouseOver="hilite(39490)" onMouseOut="lolite()" href="../../_variables/mnethostid.html">mnethostid</a>);
<a name="l897"><span class="linenum"> 897</span></a>  
<a name="l898"><span class="linenum"> 898</span></a>              <a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a> = <span class="keyword">new </span><a class="class" onClick="logClass('mnet_xmlrpc_client')" href="../../_classes/mnet_xmlrpc_client.html" onMouseOver="classPopup(event,'mnet_xmlrpc_client')">mnet_xmlrpc_client</a>();
<a name="l899"><span class="linenum"> 899</span></a>              <a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a>-&gt;<a class="function" onClick="logFunction('set_method')" href="../../_functions/set_method.html" onMouseOver="funcPopup(event,'set_method')">set_method</a>('auth/mnet/auth.php/kill_children');
<a name="l900"><span class="linenum"> 900</span></a>  
<a name="l901"><span class="linenum"> 901</span></a>  <span class="comment">            // set $token and $useragent parameters</span>
<a name="l902"><span class="linenum"> 902</span></a>              <a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a>-&gt;<a class="function" onClick="logFunction('add_param')" href="../../_functions/add_param.html" onMouseOver="funcPopup(event,'add_param')">add_param</a>(<a class="var it463" onMouseOver="hilite(463)" onMouseOut="lolite()" onClick="logVariable('username')" href="../../_variables/username.html">$username</a>);
<a name="l903"><span class="linenum"> 903</span></a>              <a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a>-&gt;<a class="function" onClick="logFunction('add_param')" href="../../_functions/add_param.html" onMouseOver="funcPopup(event,'add_param')">add_param</a>(<a class="var it3522" onMouseOver="hilite(3522)" onMouseOut="lolite()" onClick="logVariable('useragent')" href="../../_variables/useragent.html">$useragent</a>);
<a name="l904"><span class="linenum"> 904</span></a>              if (<a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a>-&gt;<a class="function" onClick="logFunction('send')" href="../../_functions/send.html" onMouseOver="funcPopup(event,'send')">send</a>(<a class="var it15854" onMouseOver="hilite(15854)" onMouseOut="lolite()" onClick="logVariable('mnet_peer')" href="../../_variables/mnet_peer.html">$mnet_peer</a>) === false) {
<a name="l905"><span class="linenum"> 905</span></a>                  <a class="function" onClick="logFunction('debugging')" href="../../_functions/debugging.html" onMouseOver="funcPopup(event,'debugging')">debugging</a>(<a class="function" onClick="logFunction('join')" href="../../_functions/join.html" onMouseOver="funcPopup(event,'join')">join</a>(&quot;\n&quot;, <a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a>-&gt;<a onClick="logVariable('error')" class="var it39831" onMouseOver="hilite(39831)" onMouseOut="lolite()" href="../../_variables/error.html">error</a>));
<a name="l906"><span class="linenum"> 906</span></a>                  return false;
<a name="l907"><span class="linenum"> 907</span></a>              }
<a name="l908"><span class="linenum"> 908</span></a>          }
<a name="l909"><span class="linenum"> 909</span></a>  
<a name="l910"><span class="linenum"> 910</span></a>          return true;
<a name="l911"><span class="linenum"> 911</span></a>      }
<a name="l912"><span class="linenum"> 912</span></a>  
<a name="l913"><span class="linenum"> 913</span></a>      <span class="comment">/**</span>
<a name="l914"><span class="linenum"> 914</span></a>  <span class="comment">     * The IdP uses this function to kill child sessions on other hosts</span>
<a name="l915"><span class="linenum"> 915</span></a>  <span class="comment">     *</span>
<a name="l916"><span class="linenum"> 916</span></a>  <span class="comment">     * @param   string  $username       Username for session to kill</span>
<a name="l917"><span class="linenum"> 917</span></a>  <span class="comment">     * @param   string  $useragent      SHA1 hash of user agent to look for</span>
<a name="l918"><span class="linenum"> 918</span></a>  <span class="comment">     * @return  string                  A plaintext report of what has happened</span>
<a name="l919"><span class="linenum"> 919</span></a>  <span class="comment">     */</span>
<a name="l920"><span class="linenum"> 920</span></a>      function <a class="function" onClick="logFunction('kill_children')" href="../../_functions/kill_children.html" onMouseOver="funcPopup(event,'kill_children')">kill_children</a>(<a class="var it463" onMouseOver="hilite(463)" onMouseOut="lolite()" onClick="logVariable('username')" href="../../_variables/username.html">$username</a>, <a class="var it3522" onMouseOver="hilite(3522)" onMouseOut="lolite()" onClick="logVariable('useragent')" href="../../_variables/useragent.html">$useragent</a>) {
<a name="l921"><span class="linenum"> 921</span></a>          global <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it9" onMouseOver="hilite(9)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>, <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l922"><span class="linenum"> 922</span></a>          <a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a> = null;
<a name="l923"><span class="linenum"> 923</span></a>          if (<a class="phpfunction" onClick="logFunction('defined')" href="../../_functions/defined.html" onMouseOver="phpfuncPopup(event,'defined')">defined</a>('<a class="constant" onClick="logConstant('MNET_SERVER')" href="../../_constants/MNET_SERVER.html" onMouseOver="constPopup(event,'MNET_SERVER')">MNET_SERVER</a>')) {
<a name="l924"><span class="linenum"> 924</span></a>              <a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a> = <a class="function" onClick="logFunction('get_mnet_remote_client')" href="../../_functions/get_mnet_remote_client.html" onMouseOver="funcPopup(event,'get_mnet_remote_client')">get_mnet_remote_client</a>();
<a name="l925"><span class="linenum"> 925</span></a>          }
<a name="l926"><span class="linenum"> 926</span></a>          require_once <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('dirroot')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/dirroot.html">dirroot</a>.'<a class="filename" href="../../mnet/xmlrpc/client.php.html">/mnet/xmlrpc/client.php</a>';
<a name="l927"><span class="linenum"> 927</span></a>  
<a name="l928"><span class="linenum"> 928</span></a>          <a class="var it182" onMouseOver="hilite(182)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('user', 'id', array('mnethostid'=&gt;<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('mnet_localhost_id')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/mnet_localhost_id.html">mnet_localhost_id</a>, 'username'=&gt;<a class="var it463" onMouseOver="hilite(463)" onMouseOut="lolite()" onClick="logVariable('username')" href="../../_variables/username.html">$username</a>));
<a name="l929"><span class="linenum"> 929</span></a>  
<a name="l930"><span class="linenum"> 930</span></a>          <a class="var it17149" onMouseOver="hilite(17149)" onMouseOut="lolite()" onClick="logVariable('returnstring')" href="../../_variables/returnstring.html">$returnstring</a> = '';
<a name="l931"><span class="linenum"> 931</span></a>  
<a name="l932"><span class="linenum"> 932</span></a>          <a class="var it20781" onMouseOver="hilite(20781)" onMouseOut="lolite()" onClick="logVariable('mnetsessions')" href="../../_variables/mnetsessions.html">$mnetsessions</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records')" href="../../_functions/get_records.html" onMouseOver="funcPopup(event,'get_records')">get_records</a>('mnet_session', array('userid' =&gt; <a class="var it182" onMouseOver="hilite(182)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>, 'useragent' =&gt; <a class="var it3522" onMouseOver="hilite(3522)" onMouseOut="lolite()" onClick="logVariable('useragent')" href="../../_variables/useragent.html">$useragent</a>));
<a name="l933"><span class="linenum"> 933</span></a>  
<a name="l934"><span class="linenum"> 934</span></a>          if (false == <a class="var it20781" onMouseOver="hilite(20781)" onMouseOut="lolite()" onClick="logVariable('mnetsessions')" href="../../_variables/mnetsessions.html">$mnetsessions</a>) {
<a name="l935"><span class="linenum"> 935</span></a>              <a class="var it17149" onMouseOver="hilite(17149)" onMouseOut="lolite()" onClick="logVariable('returnstring')" href="../../_variables/returnstring.html">$returnstring</a> .= &quot;Could find no remote sessions\n&quot;;
<a name="l936"><span class="linenum"> 936</span></a>              <a class="var it20781" onMouseOver="hilite(20781)" onMouseOut="lolite()" onClick="logVariable('mnetsessions')" href="../../_variables/mnetsessions.html">$mnetsessions</a> = array();
<a name="l937"><span class="linenum"> 937</span></a>          }
<a name="l938"><span class="linenum"> 938</span></a>  
<a name="l939"><span class="linenum"> 939</span></a>          foreach(<a class="var it20781" onMouseOver="hilite(20781)" onMouseOut="lolite()" onClick="logVariable('mnetsessions')" href="../../_variables/mnetsessions.html">$mnetsessions</a> as <a class="var it20782" onMouseOver="hilite(20782)" onMouseOut="lolite()" onClick="logVariable('mnetsession')" href="../../_variables/mnetsession.html">$mnetsession</a>) {
<a name="l940"><span class="linenum"> 940</span></a>  <span class="comment">            // If this script is being executed by a remote peer, that means the user has clicked</span>
<a name="l941"><span class="linenum"> 941</span></a>  <span class="comment">            // logout on that peer, and the session on that peer can be deleted natively.</span>
<a name="l942"><span class="linenum"> 942</span></a>  <span class="comment">            // Skip over it.</span>
<a name="l943"><span class="linenum"> 943</span></a>              if (isset(<a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a>-&gt;<a onClick="logVariable('id')" class="var it39817" onMouseOver="hilite(39817)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>) &amp;&amp; (<a class="var it20782" onMouseOver="hilite(20782)" onMouseOut="lolite()" onClick="logVariable('mnetsession')" href="../../_variables/mnetsession.html">$mnetsession</a>-&gt;<a onClick="logVariable('mnethostid')" class="var it39826" onMouseOver="hilite(39826)" onMouseOut="lolite()" href="../../_variables/mnethostid.html">mnethostid</a> == <a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a>-&gt;<a onClick="logVariable('id')" class="var it39817" onMouseOver="hilite(39817)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>)) {
<a name="l944"><span class="linenum"> 944</span></a>                  continue;
<a name="l945"><span class="linenum"> 945</span></a>              }
<a name="l946"><span class="linenum"> 946</span></a>              <a class="var it17149" onMouseOver="hilite(17149)" onMouseOut="lolite()" onClick="logVariable('returnstring')" href="../../_variables/returnstring.html">$returnstring</a> .=  &quot;Deleting session\n&quot;;
<a name="l947"><span class="linenum"> 947</span></a>  
<a name="l948"><span class="linenum"> 948</span></a>              <a class="var it15854" onMouseOver="hilite(15854)" onMouseOut="lolite()" onClick="logVariable('mnet_peer')" href="../../_variables/mnet_peer.html">$mnet_peer</a> = <span class="keyword">new </span><a class="class" onClick="logClass('mnet_peer')" href="../../_classes/mnet_peer.html" onMouseOver="classPopup(event,'mnet_peer')">mnet_peer</a>();
<a name="l949"><span class="linenum"> 949</span></a>              <a class="var it15854" onMouseOver="hilite(15854)" onMouseOut="lolite()" onClick="logVariable('mnet_peer')" href="../../_variables/mnet_peer.html">$mnet_peer</a>-&gt;<a class="function" onClick="logFunction('set_id')" href="../../_functions/set_id.html" onMouseOver="funcPopup(event,'set_id')">set_id</a>(<a class="var it20782" onMouseOver="hilite(20782)" onMouseOut="lolite()" onClick="logVariable('mnetsession')" href="../../_variables/mnetsession.html">$mnetsession</a>-&gt;<a onClick="logVariable('mnethostid')" class="var it39826" onMouseOver="hilite(39826)" onMouseOut="lolite()" href="../../_variables/mnethostid.html">mnethostid</a>);
<a name="l950"><span class="linenum"> 950</span></a>  
<a name="l951"><span class="linenum"> 951</span></a>              <a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a> = <span class="keyword">new </span><a class="class" onClick="logClass('mnet_xmlrpc_client')" href="../../_classes/mnet_xmlrpc_client.html" onMouseOver="classPopup(event,'mnet_xmlrpc_client')">mnet_xmlrpc_client</a>();
<a name="l952"><span class="linenum"> 952</span></a>              <a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a>-&gt;<a class="function" onClick="logFunction('set_method')" href="../../_functions/set_method.html" onMouseOver="funcPopup(event,'set_method')">set_method</a>('auth/mnet/auth.php/kill_child');
<a name="l953"><span class="linenum"> 953</span></a>  
<a name="l954"><span class="linenum"> 954</span></a>  <span class="comment">            // set $token and $useragent parameters</span>
<a name="l955"><span class="linenum"> 955</span></a>              <a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a>-&gt;<a class="function" onClick="logFunction('add_param')" href="../../_functions/add_param.html" onMouseOver="funcPopup(event,'add_param')">add_param</a>(<a class="var it463" onMouseOver="hilite(463)" onMouseOut="lolite()" onClick="logVariable('username')" href="../../_variables/username.html">$username</a>);
<a name="l956"><span class="linenum"> 956</span></a>              <a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a>-&gt;<a class="function" onClick="logFunction('add_param')" href="../../_functions/add_param.html" onMouseOver="funcPopup(event,'add_param')">add_param</a>(<a class="var it3522" onMouseOver="hilite(3522)" onMouseOut="lolite()" onClick="logVariable('useragent')" href="../../_variables/useragent.html">$useragent</a>);
<a name="l957"><span class="linenum"> 957</span></a>              if (<a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a>-&gt;<a class="function" onClick="logFunction('send')" href="../../_functions/send.html" onMouseOver="funcPopup(event,'send')">send</a>(<a class="var it15854" onMouseOver="hilite(15854)" onMouseOut="lolite()" onClick="logVariable('mnet_peer')" href="../../_variables/mnet_peer.html">$mnet_peer</a>) === false) {
<a name="l958"><span class="linenum"> 958</span></a>                  <a class="function" onClick="logFunction('debugging')" href="../../_functions/debugging.html" onMouseOver="funcPopup(event,'debugging')">debugging</a>(&quot;Server side error has occured on host <a class="var it20782" onMouseOver="hilite(20782)" onMouseOut="lolite()" onClick="logVariable('mnetsession')" href="../../_variables/mnetsession.html">$mnetsession</a>-&gt;<a onClick="logVariable('mnethostid')" class="var it39826" onMouseOver="hilite(39826)" onMouseOut="lolite()" href="../../_variables/mnethostid.html">mnethostid</a>: &quot; .
<a name="l959"><span class="linenum"> 959</span></a>                            <a class="function" onClick="logFunction('join')" href="../../_functions/join.html" onMouseOver="funcPopup(event,'join')">join</a>(&quot;\n&quot;, <a class="var it20802" onMouseOver="hilite(20802)" onMouseOut="lolite()" onClick="logVariable('mnet_request')" href="../../_variables/mnet_request.html">$mnet_request</a>-&gt;<a onClick="logVariable('error')" class="var it39831" onMouseOver="hilite(39831)" onMouseOut="lolite()" href="../../_variables/error.html">error</a>));
<a name="l960"><span class="linenum"> 960</span></a>              }
<a name="l961"><span class="linenum"> 961</span></a>          }
<a name="l962"><span class="linenum"> 962</span></a>  
<a name="l963"><span class="linenum"> 963</span></a>          <a class="var it6503" onMouseOver="hilite(6503)" onMouseOut="lolite()" onClick="logVariable('ignore')" href="../../_variables/ignore.html">$ignore</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('delete_records')" href="../../_functions/delete_records.html" onMouseOver="funcPopup(event,'delete_records')">delete_records</a>('mnet_session',
<a name="l964"><span class="linenum"> 964</span></a>                                   array('useragent'=&gt;<a class="var it3522" onMouseOver="hilite(3522)" onMouseOut="lolite()" onClick="logVariable('useragent')" href="../../_variables/useragent.html">$useragent</a>, 'userid'=&gt;<a class="var it182" onMouseOver="hilite(182)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>));
<a name="l965"><span class="linenum"> 965</span></a>  
<a name="l966"><span class="linenum"> 966</span></a>          if (isset(<a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a>) &amp;&amp; isset(<a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a>-&gt;<a onClick="logVariable('id')" class="var it39817" onMouseOver="hilite(39817)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>)) {
<a name="l967"><span class="linenum"> 967</span></a>              \core\session\<a class="class" onClick="logClass('manager')" href="../../_classes/manager.html" onMouseOver="classPopup(event,'manager')">manager</a>::<a class="function" onClick="logFunction('kill_user_sessions')" href="../../_functions/kill_user_sessions.html" onMouseOver="funcPopup(event,'kill_user_sessions')">kill_user_sessions</a>(<a class="var it182" onMouseOver="hilite(182)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>);
<a name="l968"><span class="linenum"> 968</span></a>          }
<a name="l969"><span class="linenum"> 969</span></a>          return <a class="var it17149" onMouseOver="hilite(17149)" onMouseOut="lolite()" onClick="logVariable('returnstring')" href="../../_variables/returnstring.html">$returnstring</a>;
<a name="l970"><span class="linenum"> 970</span></a>      }
<a name="l971"><span class="linenum"> 971</span></a>  
<a name="l972"><span class="linenum"> 972</span></a>      <span class="comment">/**</span>
<a name="l973"><span class="linenum"> 973</span></a>  <span class="comment">     * When the IdP requests that child sessions are terminated,</span>
<a name="l974"><span class="linenum"> 974</span></a>  <span class="comment">     * this function will be called on each of the child hosts. The machine that</span>
<a name="l975"><span class="linenum"> 975</span></a>  <span class="comment">     * calls the function (over xmlrpc) provides us with the mnethostid we need.</span>
<a name="l976"><span class="linenum"> 976</span></a>  <span class="comment">     *</span>
<a name="l977"><span class="linenum"> 977</span></a>  <span class="comment">     * @param   string  $username       Username for session to kill</span>
<a name="l978"><span class="linenum"> 978</span></a>  <span class="comment">     * @param   string  $useragent      SHA1 hash of user agent to look for</span>
<a name="l979"><span class="linenum"> 979</span></a>  <span class="comment">     * @return  bool                    True on success</span>
<a name="l980"><span class="linenum"> 980</span></a>  <span class="comment">     */</span>
<a name="l981"><span class="linenum"> 981</span></a>      function <a class="function" onClick="logFunction('kill_child')" href="../../_functions/kill_child.html" onMouseOver="funcPopup(event,'kill_child')">kill_child</a>(<a class="var it463" onMouseOver="hilite(463)" onMouseOut="lolite()" onClick="logVariable('username')" href="../../_variables/username.html">$username</a>, <a class="var it3522" onMouseOver="hilite(3522)" onMouseOut="lolite()" onClick="logVariable('useragent')" href="../../_variables/useragent.html">$useragent</a>) {
<a name="l982"><span class="linenum"> 982</span></a>          global <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l983"><span class="linenum"> 983</span></a>          <a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a> = <a class="function" onClick="logFunction('get_mnet_remote_client')" href="../../_functions/get_mnet_remote_client.html" onMouseOver="funcPopup(event,'get_mnet_remote_client')">get_mnet_remote_client</a>();
<a name="l984"><span class="linenum"> 984</span></a>          <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('session')" href="../../_variables/session.html">$session</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('mnet_session', array('username'=&gt;<a class="var it463" onMouseOver="hilite(463)" onMouseOut="lolite()" onClick="logVariable('username')" href="../../_variables/username.html">$username</a>, 'mnethostid'=&gt;<a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a>-&gt;<a onClick="logVariable('id')" class="var it39817" onMouseOver="hilite(39817)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, 'useragent'=&gt;<a class="var it3522" onMouseOver="hilite(3522)" onMouseOut="lolite()" onClick="logVariable('useragent')" href="../../_variables/useragent.html">$useragent</a>));
<a name="l985"><span class="linenum"> 985</span></a>          <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('delete_records')" href="../../_functions/delete_records.html" onMouseOver="funcPopup(event,'delete_records')">delete_records</a>('mnet_session', array('username'=&gt;<a class="var it463" onMouseOver="hilite(463)" onMouseOut="lolite()" onClick="logVariable('username')" href="../../_variables/username.html">$username</a>, 'mnethostid'=&gt;<a class="var it18067" onMouseOver="hilite(18067)" onMouseOut="lolite()" onClick="logVariable('remoteclient')" href="../../_variables/remoteclient.html">$remoteclient</a>-&gt;<a onClick="logVariable('id')" class="var it39817" onMouseOver="hilite(39817)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, 'useragent'=&gt;<a class="var it3522" onMouseOver="hilite(3522)" onMouseOut="lolite()" onClick="logVariable('useragent')" href="../../_variables/useragent.html">$useragent</a>));
<a name="l986"><span class="linenum"> 986</span></a>          if (false != <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('session')" href="../../_variables/session.html">$session</a>) {
<a name="l987"><span class="linenum"> 987</span></a>              \core\session\<a class="class" onClick="logClass('manager')" href="../../_classes/manager.html" onMouseOver="classPopup(event,'manager')">manager</a>::<a class="function" onClick="logFunction('kill_session')" href="../../_functions/kill_session.html" onMouseOver="funcPopup(event,'kill_session')">kill_session</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('session')" href="../../_variables/session.html">$session</a>-&gt;<a onClick="logVariable('session_id')" class="var it39833" onMouseOver="hilite(39833)" onMouseOut="lolite()" href="../../_variables/session_id.html">session_id</a>);
<a name="l988"><span class="linenum"> 988</span></a>              return true;
<a name="l989"><span class="linenum"> 989</span></a>          }
<a name="l990"><span class="linenum"> 990</span></a>          return false;
<a name="l991"><span class="linenum"> 991</span></a>      }
<a name="l992"><span class="linenum"> 992</span></a>  
<a name="l993"><span class="linenum"> 993</span></a>      <span class="comment">/**</span>
<a name="l994"><span class="linenum"> 994</span></a>  <span class="comment">     * To delete a host, we must delete all current sessions that users from</span>
<a name="l995"><span class="linenum"> 995</span></a>  <span class="comment">     * that host are currently engaged in.</span>
<a name="l996"><span class="linenum"> 996</span></a>  <span class="comment">     *</span>
<a name="l997"><span class="linenum"> 997</span></a>  <span class="comment">     * @param   string  $sessionidarray   An array of session hashes</span>
<a name="l998"><span class="linenum"> 998</span></a>  <span class="comment">     * @return  bool                      True on success</span>
<a name="l999"><span class="linenum"> 999</span></a>  <span class="comment">     */</span>
<a name="l1000"><span class="linenum">1000</span></a>      function <a class="function" onClick="logFunction('end_local_sessions')" href="../../_functions/end_local_sessions.html" onMouseOver="funcPopup(event,'end_local_sessions')">end_local_sessions</a>(&amp;<a class="var it20811" onMouseOver="hilite(20811)" onMouseOut="lolite()" onClick="logVariable('sessionArray')" href="../../_variables/sessionArray.html">$sessionArray</a>) {
<a name="l1001"><span class="linenum">1001</span></a>          global <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>;
<a name="l1002"><span class="linenum">1002</span></a>          if (<a class="phpfunction" onClick="logFunction('is_array')" href="../../_functions/is_array.html" onMouseOver="phpfuncPopup(event,'is_array')">is_array</a>(<a class="var it20811" onMouseOver="hilite(20811)" onMouseOut="lolite()" onClick="logVariable('sessionArray')" href="../../_variables/sessionArray.html">$sessionArray</a>)) {
<a name="l1003"><span class="linenum">1003</span></a>              while(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('session')" href="../../_variables/session.html">$session</a> = <a class="phpfunction" onClick="logFunction('array_pop')" href="../../_functions/array_pop.html" onMouseOver="phpfuncPopup(event,'array_pop')">array_pop</a>(<a class="var it20811" onMouseOver="hilite(20811)" onMouseOut="lolite()" onClick="logVariable('sessionArray')" href="../../_variables/sessionArray.html">$sessionArray</a>)) {
<a name="l1004"><span class="linenum">1004</span></a>                  \core\session\<a class="class" onClick="logClass('manager')" href="../../_classes/manager.html" onMouseOver="classPopup(event,'manager')">manager</a>::<a class="function" onClick="logFunction('kill_session')" href="../../_functions/kill_session.html" onMouseOver="funcPopup(event,'kill_session')">kill_session</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('session')" href="../../_variables/session.html">$session</a>-&gt;<a onClick="logVariable('session_id')" class="var it39833" onMouseOver="hilite(39833)" onMouseOut="lolite()" href="../../_variables/session_id.html">session_id</a>);
<a name="l1005"><span class="linenum">1005</span></a>              }
<a name="l1006"><span class="linenum">1006</span></a>              return true;
<a name="l1007"><span class="linenum">1007</span></a>          }
<a name="l1008"><span class="linenum">1008</span></a>          return false;
<a name="l1009"><span class="linenum">1009</span></a>      }
<a name="l1010"><span class="linenum">1010</span></a>  
<a name="l1011"><span class="linenum">1011</span></a>      <span class="comment">/**</span>
<a name="l1012"><span class="linenum">1012</span></a>  <span class="comment">     * Returns the user's profile image info</span>
<a name="l1013"><span class="linenum">1013</span></a>  <span class="comment">     *</span>
<a name="l1014"><span class="linenum">1014</span></a>  <span class="comment">     * If the user exists and has a profile picture, the returned array will contain keys:</span>
<a name="l1015"><span class="linenum">1015</span></a>  <span class="comment">     *  f1          - the content of the default 100x100px image</span>
<a name="l1016"><span class="linenum">1016</span></a>  <span class="comment">     *  f1_mimetype - the mimetype of the f1 file</span>
<a name="l1017"><span class="linenum">1017</span></a>  <span class="comment">     *  f2          - the content of the 35x35px variant of the image</span>
<a name="l1018"><span class="linenum">1018</span></a>  <span class="comment">     *  f2_mimetype - the mimetype of the f2 file</span>
<a name="l1019"><span class="linenum">1019</span></a>  <span class="comment">     *</span>
<a name="l1020"><span class="linenum">1020</span></a>  <span class="comment">     * The mimetype information was added in Moodle 2.0. In Moodle 1.x, images are always jpegs.</span>
<a name="l1021"><span class="linenum">1021</span></a>  <span class="comment">     *</span>
<a name="l1022"><span class="linenum">1022</span></a>  <span class="comment">     * @see process_new_icon()</span>
<a name="l1023"><span class="linenum">1023</span></a>  <span class="comment">     * @uses mnet_remote_client callable via MNet XML-RPC</span>
<a name="l1024"><span class="linenum">1024</span></a>  <span class="comment">     * @param int $userid The id of the user</span>
<a name="l1025"><span class="linenum">1025</span></a>  <span class="comment">     * @return false|array false if user not found, empty array if no picture exists, array with data otherwise</span>
<a name="l1026"><span class="linenum">1026</span></a>  <span class="comment">     */</span>
<a name="l1027"><span class="linenum">1027</span></a>      function <a class="function" onClick="logFunction('fetch_user_image')" href="../../_functions/fetch_user_image.html" onMouseOver="funcPopup(event,'fetch_user_image')">fetch_user_image</a>(<a class="var it463" onMouseOver="hilite(463)" onMouseOut="lolite()" onClick="logVariable('username')" href="../../_variables/username.html">$username</a>) {
<a name="l1028"><span class="linenum">1028</span></a>          global <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l1029"><span class="linenum">1029</span></a>  
<a name="l1030"><span class="linenum">1030</span></a>          if (<a class="var it119" onMouseOver="hilite(119)" onMouseOut="lolite()" onClick="logVariable('user')" href="../../_variables/user.html">$user</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('user', array('username' =&gt; <a class="var it463" onMouseOver="hilite(463)" onMouseOut="lolite()" onClick="logVariable('username')" href="../../_variables/username.html">$username</a>, 'mnethostid' =&gt; <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('mnet_localhost_id')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/mnet_localhost_id.html">mnet_localhost_id</a>))) {
<a name="l1031"><span class="linenum">1031</span></a>              <a class="var it586" onMouseOver="hilite(586)" onMouseOut="lolite()" onClick="logVariable('fs')" href="../../_variables/fs.html">$fs</a> = <a class="function" onClick="logFunction('get_file_storage')" href="../../_functions/get_file_storage.html" onMouseOver="funcPopup(event,'get_file_storage')">get_file_storage</a>();
<a name="l1032"><span class="linenum">1032</span></a>              <a class="var it1419" onMouseOver="hilite(1419)" onMouseOut="lolite()" onClick="logVariable('usercontext')" href="../../_variables/usercontext.html">$usercontext</a> = <a class="class" onClick="logClass('context_user')" href="../../_classes/context_user.html" onMouseOver="classPopup(event,'context_user')">context_user</a>::<a class="function" onClick="logFunction('instance')" href="../../_functions/instance.html" onMouseOver="funcPopup(event,'instance')">instance</a>(<a class="var it119" onMouseOver="hilite(119)" onMouseOut="lolite()" onClick="logVariable('user')" href="../../_variables/user.html">$user</a>-&gt;<a onClick="logVariable('id')" class="var it39447" onMouseOver="hilite(39447)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, <a class="constant" onClick="logConstant('MUST_EXIST')" href="../../_constants/MUST_EXIST.html" onMouseOver="constPopup(event,'MUST_EXIST')">MUST_EXIST</a>);
<a name="l1033"><span class="linenum">1033</span></a>              <a class="var it49" onMouseOver="hilite(49)" onMouseOut="lolite()" onClick="logVariable('return')" href="../../_variables/return.html">$return</a> = array();
<a name="l1034"><span class="linenum">1034</span></a>              if (<a class="var it4099" onMouseOver="hilite(4099)" onMouseOut="lolite()" onClick="logVariable('f1')" href="../../_variables/f1.html">$f1</a> = <a class="var it586" onMouseOver="hilite(586)" onMouseOut="lolite()" onClick="logVariable('fs')" href="../../_variables/fs.html">$fs</a>-&gt;<a class="function" onClick="logFunction('get_file')" href="../../_functions/get_file.html" onMouseOver="funcPopup(event,'get_file')">get_file</a>(<a class="var it1419" onMouseOver="hilite(1419)" onMouseOut="lolite()" onClick="logVariable('usercontext')" href="../../_variables/usercontext.html">$usercontext</a>-&gt;<a onClick="logVariable('id')" class="var it39494" onMouseOver="hilite(39494)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, 'user', 'icon', 0, '/', 'f1.png')) {
<a name="l1035"><span class="linenum">1035</span></a>                  <a class="var it49" onMouseOver="hilite(49)" onMouseOut="lolite()" onClick="logVariable('return')" href="../../_variables/return.html">$return</a>['f1'] = <a class="phpfunction" onClick="logFunction('base64_encode')" href="../../_functions/base64_encode.html" onMouseOver="phpfuncPopup(event,'base64_encode')">base64_encode</a>(<a class="var it4099" onMouseOver="hilite(4099)" onMouseOut="lolite()" onClick="logVariable('f1')" href="../../_variables/f1.html">$f1</a>-&gt;<a class="function" onClick="logFunction('get_content')" href="../../_functions/get_content.html" onMouseOver="funcPopup(event,'get_content')">get_content</a>());
<a name="l1036"><span class="linenum">1036</span></a>                  <a class="var it49" onMouseOver="hilite(49)" onMouseOut="lolite()" onClick="logVariable('return')" href="../../_variables/return.html">$return</a>['f1_mimetype'] = <a class="var it4099" onMouseOver="hilite(4099)" onMouseOut="lolite()" onClick="logVariable('f1')" href="../../_variables/f1.html">$f1</a>-&gt;<a class="function" onClick="logFunction('get_mimetype')" href="../../_functions/get_mimetype.html" onMouseOver="funcPopup(event,'get_mimetype')">get_mimetype</a>();
<a name="l1037"><span class="linenum">1037</span></a>              } else if (<a class="var it4099" onMouseOver="hilite(4099)" onMouseOut="lolite()" onClick="logVariable('f1')" href="../../_variables/f1.html">$f1</a> = <a class="var it586" onMouseOver="hilite(586)" onMouseOut="lolite()" onClick="logVariable('fs')" href="../../_variables/fs.html">$fs</a>-&gt;<a class="function" onClick="logFunction('get_file')" href="../../_functions/get_file.html" onMouseOver="funcPopup(event,'get_file')">get_file</a>(<a class="var it1419" onMouseOver="hilite(1419)" onMouseOut="lolite()" onClick="logVariable('usercontext')" href="../../_variables/usercontext.html">$usercontext</a>-&gt;<a onClick="logVariable('id')" class="var it39494" onMouseOver="hilite(39494)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, 'user', 'icon', 0, '/', 'f1.jpg')) {
<a name="l1038"><span class="linenum">1038</span></a>                  <a class="var it49" onMouseOver="hilite(49)" onMouseOut="lolite()" onClick="logVariable('return')" href="../../_variables/return.html">$return</a>['f1'] = <a class="phpfunction" onClick="logFunction('base64_encode')" href="../../_functions/base64_encode.html" onMouseOver="phpfuncPopup(event,'base64_encode')">base64_encode</a>(<a class="var it4099" onMouseOver="hilite(4099)" onMouseOut="lolite()" onClick="logVariable('f1')" href="../../_variables/f1.html">$f1</a>-&gt;<a class="function" onClick="logFunction('get_content')" href="../../_functions/get_content.html" onMouseOver="funcPopup(event,'get_content')">get_content</a>());
<a name="l1039"><span class="linenum">1039</span></a>                  <a class="var it49" onMouseOver="hilite(49)" onMouseOut="lolite()" onClick="logVariable('return')" href="../../_variables/return.html">$return</a>['f1_mimetype'] = <a class="var it4099" onMouseOver="hilite(4099)" onMouseOut="lolite()" onClick="logVariable('f1')" href="../../_variables/f1.html">$f1</a>-&gt;<a class="function" onClick="logFunction('get_mimetype')" href="../../_functions/get_mimetype.html" onMouseOver="funcPopup(event,'get_mimetype')">get_mimetype</a>();
<a name="l1040"><span class="linenum">1040</span></a>              }
<a name="l1041"><span class="linenum">1041</span></a>              if (<a class="var it20812" onMouseOver="hilite(20812)" onMouseOut="lolite()" onClick="logVariable('f2')" href="../../_variables/f2.html">$f2</a> = <a class="var it586" onMouseOver="hilite(586)" onMouseOut="lolite()" onClick="logVariable('fs')" href="../../_variables/fs.html">$fs</a>-&gt;<a class="function" onClick="logFunction('get_file')" href="../../_functions/get_file.html" onMouseOver="funcPopup(event,'get_file')">get_file</a>(<a class="var it1419" onMouseOver="hilite(1419)" onMouseOut="lolite()" onClick="logVariable('usercontext')" href="../../_variables/usercontext.html">$usercontext</a>-&gt;<a onClick="logVariable('id')" class="var it39494" onMouseOver="hilite(39494)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, 'user', 'icon', 0, '/', 'f2.png')) {
<a name="l1042"><span class="linenum">1042</span></a>                  <a class="var it49" onMouseOver="hilite(49)" onMouseOut="lolite()" onClick="logVariable('return')" href="../../_variables/return.html">$return</a>['f2'] = <a class="phpfunction" onClick="logFunction('base64_encode')" href="../../_functions/base64_encode.html" onMouseOver="phpfuncPopup(event,'base64_encode')">base64_encode</a>(<a class="var it20812" onMouseOver="hilite(20812)" onMouseOut="lolite()" onClick="logVariable('f2')" href="../../_variables/f2.html">$f2</a>-&gt;<a class="function" onClick="logFunction('get_content')" href="../../_functions/get_content.html" onMouseOver="funcPopup(event,'get_content')">get_content</a>());
<a name="l1043"><span class="linenum">1043</span></a>                  <a class="var it49" onMouseOver="hilite(49)" onMouseOut="lolite()" onClick="logVariable('return')" href="../../_variables/return.html">$return</a>['f2_mimetype'] = <a class="var it20812" onMouseOver="hilite(20812)" onMouseOut="lolite()" onClick="logVariable('f2')" href="../../_variables/f2.html">$f2</a>-&gt;<a class="function" onClick="logFunction('get_mimetype')" href="../../_functions/get_mimetype.html" onMouseOver="funcPopup(event,'get_mimetype')">get_mimetype</a>();
<a name="l1044"><span class="linenum">1044</span></a>              } else if (<a class="var it20812" onMouseOver="hilite(20812)" onMouseOut="lolite()" onClick="logVariable('f2')" href="../../_variables/f2.html">$f2</a> = <a class="var it586" onMouseOver="hilite(586)" onMouseOut="lolite()" onClick="logVariable('fs')" href="../../_variables/fs.html">$fs</a>-&gt;<a class="function" onClick="logFunction('get_file')" href="../../_functions/get_file.html" onMouseOver="funcPopup(event,'get_file')">get_file</a>(<a class="var it1419" onMouseOver="hilite(1419)" onMouseOut="lolite()" onClick="logVariable('usercontext')" href="../../_variables/usercontext.html">$usercontext</a>-&gt;<a onClick="logVariable('id')" class="var it39494" onMouseOver="hilite(39494)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, 'user', 'icon', 0, '/', 'f2.jpg')) {
<a name="l1045"><span class="linenum">1045</span></a>                  <a class="var it49" onMouseOver="hilite(49)" onMouseOut="lolite()" onClick="logVariable('return')" href="../../_variables/return.html">$return</a>['f2'] = <a class="phpfunction" onClick="logFunction('base64_encode')" href="../../_functions/base64_encode.html" onMouseOver="phpfuncPopup(event,'base64_encode')">base64_encode</a>(<a class="var it20812" onMouseOver="hilite(20812)" onMouseOut="lolite()" onClick="logVariable('f2')" href="../../_variables/f2.html">$f2</a>-&gt;<a class="function" onClick="logFunction('get_content')" href="../../_functions/get_content.html" onMouseOver="funcPopup(event,'get_content')">get_content</a>());
<a name="l1046"><span class="linenum">1046</span></a>                  <a class="var it49" onMouseOver="hilite(49)" onMouseOut="lolite()" onClick="logVariable('return')" href="../../_variables/return.html">$return</a>['f2_mimetype'] = <a class="var it20812" onMouseOver="hilite(20812)" onMouseOut="lolite()" onClick="logVariable('f2')" href="../../_variables/f2.html">$f2</a>-&gt;<a class="function" onClick="logFunction('get_mimetype')" href="../../_functions/get_mimetype.html" onMouseOver="funcPopup(event,'get_mimetype')">get_mimetype</a>();
<a name="l1047"><span class="linenum">1047</span></a>              }
<a name="l1048"><span class="linenum">1048</span></a>              return <a class="var it49" onMouseOver="hilite(49)" onMouseOut="lolite()" onClick="logVariable('return')" href="../../_variables/return.html">$return</a>;
<a name="l1049"><span class="linenum">1049</span></a>          }
<a name="l1050"><span class="linenum">1050</span></a>          return false;
<a name="l1051"><span class="linenum">1051</span></a>      }
<a name="l1052"><span class="linenum">1052</span></a>  
<a name="l1053"><span class="linenum">1053</span></a>      <span class="comment">/**</span>
<a name="l1054"><span class="linenum">1054</span></a>  <span class="comment">     * Returns the theme information and logo url as strings.</span>
<a name="l1055"><span class="linenum">1055</span></a>  <span class="comment">     *</span>
<a name="l1056"><span class="linenum">1056</span></a>  <span class="comment">     * @return string     The theme info</span>
<a name="l1057"><span class="linenum">1057</span></a>  <span class="comment">     */</span>
<a name="l1058"><span class="linenum">1058</span></a>      function <a class="function" onClick="logFunction('fetch_theme_info')" href="../../_functions/fetch_theme_info.html" onMouseOver="funcPopup(event,'fetch_theme_info')">fetch_theme_info</a>() {
<a name="l1059"><span class="linenum">1059</span></a>          global <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>;
<a name="l1060"><span class="linenum">1060</span></a>  
<a name="l1061"><span class="linenum">1061</span></a>          <a class="var it1112" onMouseOver="hilite(1112)" onMouseOut="lolite()" onClick="logVariable('themename')" href="../../_variables/themename.html">$themename</a> = &quot;<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('theme')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/theme.html">theme</a>&quot;;
<a name="l1062"><span class="linenum">1062</span></a>          <a class="var it20813" onMouseOver="hilite(20813)" onMouseOut="lolite()" onClick="logVariable('logourl')" href="../../_variables/logourl.html">$logourl</a>   = &quot;<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('wwwroot')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/wwwroot.html">wwwroot</a>/theme/<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('theme')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/theme.html">theme</a>/images/logo.jpg&quot;;
<a name="l1063"><span class="linenum">1063</span></a>  
<a name="l1064"><span class="linenum">1064</span></a>          <a class="var it49" onMouseOver="hilite(49)" onMouseOut="lolite()" onClick="logVariable('return')" href="../../_variables/return.html">$return</a>['themename'] = <a class="var it1112" onMouseOver="hilite(1112)" onMouseOut="lolite()" onClick="logVariable('themename')" href="../../_variables/themename.html">$themename</a>;
<a name="l1065"><span class="linenum">1065</span></a>          <a class="var it49" onMouseOver="hilite(49)" onMouseOut="lolite()" onClick="logVariable('return')" href="../../_variables/return.html">$return</a>['logourl'] = <a class="var it20813" onMouseOver="hilite(20813)" onMouseOut="lolite()" onClick="logVariable('logourl')" href="../../_variables/logourl.html">$logourl</a>;
<a name="l1066"><span class="linenum">1066</span></a>          return <a class="var it49" onMouseOver="hilite(49)" onMouseOut="lolite()" onClick="logVariable('return')" href="../../_variables/return.html">$return</a>;
<a name="l1067"><span class="linenum">1067</span></a>      }
<a name="l1068"><span class="linenum">1068</span></a>  
<a name="l1069"><span class="linenum">1069</span></a>      <span class="comment">/**</span>
<a name="l1070"><span class="linenum">1070</span></a>  <span class="comment">     * Determines if an MNET host is providing the nominated service.</span>
<a name="l1071"><span class="linenum">1071</span></a>  <span class="comment">     *</span>
<a name="l1072"><span class="linenum">1072</span></a>  <span class="comment">     * @param int    $mnethostid   The id of the remote host</span>
<a name="l1073"><span class="linenum">1073</span></a>  <span class="comment">     * @param string $servicename  The name of the service</span>
<a name="l1074"><span class="linenum">1074</span></a>  <span class="comment">     * @return bool                Whether the service is available on the remote host</span>
<a name="l1075"><span class="linenum">1075</span></a>  <span class="comment">     */</span>
<a name="l1076"><span class="linenum">1076</span></a>      function <a class="function" onClick="logFunction('has_service')" href="../../_functions/has_service.html" onMouseOver="funcPopup(event,'has_service')">has_service</a>(<a class="var it523" onMouseOver="hilite(523)" onMouseOut="lolite()" onClick="logVariable('mnethostid')" href="../../_variables/mnethostid.html">$mnethostid</a>, <a class="var it17201" onMouseOver="hilite(17201)" onMouseOut="lolite()" onClick="logVariable('servicename')" href="../../_variables/servicename.html">$servicename</a>) {
<a name="l1077"><span class="linenum">1077</span></a>          global <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l1078"><span class="linenum">1078</span></a>  
<a name="l1079"><span class="linenum">1079</span></a>          <a class="var it125" onMouseOver="hilite(125)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a> = &quot;
<a name="l1080"><span class="linenum">1080</span></a>              SELECT
<a name="l1081"><span class="linenum">1081</span></a>                  svc.id as serviceid,
<a name="l1082"><span class="linenum">1082</span></a>                  svc.name,
<a name="l1083"><span class="linenum">1083</span></a>                  svc.description,
<a name="l1084"><span class="linenum">1084</span></a>                  svc.offer,
<a name="l1085"><span class="linenum">1085</span></a>                  svc.apiversion,
<a name="l1086"><span class="linenum">1086</span></a>                  h2s.id as h2s_id
<a name="l1087"><span class="linenum">1087</span></a>              FROM
<a name="l1088"><span class="linenum">1088</span></a>                  {mnet_host} h,
<a name="l1089"><span class="linenum">1089</span></a>                  {mnet_service} svc,
<a name="l1090"><span class="linenum">1090</span></a>                  {mnet_host2service} h2s
<a name="l1091"><span class="linenum">1091</span></a>              WHERE
<a name="l1092"><span class="linenum">1092</span></a>                  h.deleted = '0' AND
<a name="l1093"><span class="linenum">1093</span></a>                  h.id = h2s.hostid AND
<a name="l1094"><span class="linenum">1094</span></a>                  h2s.hostid = ? AND
<a name="l1095"><span class="linenum">1095</span></a>                  h2s.serviceid = svc.id AND
<a name="l1096"><span class="linenum">1096</span></a>                  svc.name = ? AND
<a name="l1097"><span class="linenum">1097</span></a>                  h2s.subscribe = '1'&quot;;
<a name="l1098"><span class="linenum">1098</span></a>  
<a name="l1099"><span class="linenum">1099</span></a>          return <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records_sql')" href="../../_functions/get_records_sql.html" onMouseOver="funcPopup(event,'get_records_sql')">get_records_sql</a>(<a class="var it125" onMouseOver="hilite(125)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a>, array(<a class="var it523" onMouseOver="hilite(523)" onMouseOut="lolite()" onClick="logVariable('mnethostid')" href="../../_variables/mnethostid.html">$mnethostid</a>, <a class="var it17201" onMouseOver="hilite(17201)" onMouseOut="lolite()" onClick="logVariable('servicename')" href="../../_variables/servicename.html">$servicename</a>));
<a name="l1100"><span class="linenum">1100</span></a>      }
<a name="l1101"><span class="linenum">1101</span></a>  
<a name="l1102"><span class="linenum">1102</span></a>      <span class="comment">/**</span>
<a name="l1103"><span class="linenum">1103</span></a>  <span class="comment">     * Checks the MNET access control table to see if the username/mnethost</span>
<a name="l1104"><span class="linenum">1104</span></a>  <span class="comment">     * is permitted to login to this moodle.</span>
<a name="l1105"><span class="linenum">1105</span></a>  <span class="comment">     *</span>
<a name="l1106"><span class="linenum">1106</span></a>  <span class="comment">     * @param string $username   The username</span>
<a name="l1107"><span class="linenum">1107</span></a>  <span class="comment">     * @param int    $mnethostid The id of the remote mnethost</span>
<a name="l1108"><span class="linenum">1108</span></a>  <span class="comment">     * @return bool              Whether the user can login from the remote host</span>
<a name="l1109"><span class="linenum">1109</span></a>  <span class="comment">     */</span>
<a name="l1110"><span class="linenum">1110</span></a>      function <a class="function" onClick="logFunction('can_login_remotely')" href="../../_functions/can_login_remotely.html" onMouseOver="funcPopup(event,'can_login_remotely')">can_login_remotely</a>(<a class="var it463" onMouseOver="hilite(463)" onMouseOut="lolite()" onClick="logVariable('username')" href="../../_variables/username.html">$username</a>, <a class="var it523" onMouseOver="hilite(523)" onMouseOut="lolite()" onClick="logVariable('mnethostid')" href="../../_variables/mnethostid.html">$mnethostid</a>) {
<a name="l1111"><span class="linenum">1111</span></a>          global <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l1112"><span class="linenum">1112</span></a>  
<a name="l1113"><span class="linenum">1113</span></a>          <a class="var it11292" onMouseOver="hilite(11292)" onMouseOut="lolite()" onClick="logVariable('accessctrl')" href="../../_variables/accessctrl.html">$accessctrl</a> = 'allow';
<a name="l1114"><span class="linenum">1114</span></a>          <a class="var it11293" onMouseOver="hilite(11293)" onMouseOut="lolite()" onClick="logVariable('aclrecord')" href="../../_variables/aclrecord.html">$aclrecord</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('mnet_sso_access_control', array('username'=&gt;<a class="var it463" onMouseOver="hilite(463)" onMouseOut="lolite()" onClick="logVariable('username')" href="../../_variables/username.html">$username</a>, 'mnet_host_id'=&gt;<a class="var it523" onMouseOver="hilite(523)" onMouseOut="lolite()" onClick="logVariable('mnethostid')" href="../../_variables/mnethostid.html">$mnethostid</a>));
<a name="l1115"><span class="linenum">1115</span></a>          if (!empty(<a class="var it11293" onMouseOver="hilite(11293)" onMouseOut="lolite()" onClick="logVariable('aclrecord')" href="../../_variables/aclrecord.html">$aclrecord</a>)) {
<a name="l1116"><span class="linenum">1116</span></a>              <a class="var it11292" onMouseOver="hilite(11292)" onMouseOut="lolite()" onClick="logVariable('accessctrl')" href="../../_variables/accessctrl.html">$accessctrl</a> = <a class="var it11293" onMouseOver="hilite(11293)" onMouseOut="lolite()" onClick="logVariable('aclrecord')" href="../../_variables/aclrecord.html">$aclrecord</a>-&gt;<a onClick="logVariable('accessctrl')" class="var it39834" onMouseOver="hilite(39834)" onMouseOut="lolite()" href="../../_variables/accessctrl.html">accessctrl</a>;
<a name="l1117"><span class="linenum">1117</span></a>          }
<a name="l1118"><span class="linenum">1118</span></a>          return <a class="var it11292" onMouseOver="hilite(11292)" onMouseOut="lolite()" onClick="logVariable('accessctrl')" href="../../_variables/accessctrl.html">$accessctrl</a> == 'allow';
<a name="l1119"><span class="linenum">1119</span></a>      }
<a name="l1120"><span class="linenum">1120</span></a>  
<a name="l1121"><span class="linenum">1121</span></a>      function <a class="function" onClick="logFunction('logoutpage_hook')" href="../../_functions/logoutpage_hook.html" onMouseOver="funcPopup(event,'logoutpage_hook')">logoutpage_hook</a>() {
<a name="l1122"><span class="linenum">1122</span></a>          global <a class="var it9" onMouseOver="hilite(9)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>, <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it4346" onMouseOver="hilite(4346)" onMouseOut="lolite()" onClick="logVariable('redirect')" href="../../_variables/redirect.html">$redirect</a>, <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l1123"><span class="linenum">1123</span></a>  
<a name="l1124"><span class="linenum">1124</span></a>          if (!empty(<a class="var it9" onMouseOver="hilite(9)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>-&gt;<a onClick="logVariable('mnethostid')" class="var it39490" onMouseOver="hilite(39490)" onMouseOut="lolite()" href="../../_variables/mnethostid.html">mnethostid</a>) and <a class="var it9" onMouseOver="hilite(9)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>-&gt;<a onClick="logVariable('mnethostid')" class="var it39490" onMouseOver="hilite(39490)" onMouseOut="lolite()" href="../../_variables/mnethostid.html">mnethostid</a> != <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('mnet_localhost_id')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/mnet_localhost_id.html">mnet_localhost_id</a>) {
<a name="l1125"><span class="linenum">1125</span></a>              <a class="var it100" onMouseOver="hilite(100)" onMouseOut="lolite()" onClick="logVariable('host')" href="../../_variables/host.html">$host</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('mnet_host', array('id'=&gt;<a class="var it9" onMouseOver="hilite(9)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>-&gt;<a onClick="logVariable('mnethostid')" class="var it39490" onMouseOver="hilite(39490)" onMouseOut="lolite()" href="../../_variables/mnethostid.html">mnethostid</a>));
<a name="l1126"><span class="linenum">1126</span></a>              <a class="var it4346" onMouseOver="hilite(4346)" onMouseOut="lolite()" onClick="logVariable('redirect')" href="../../_variables/redirect.html">$redirect</a> = <a class="var it100" onMouseOver="hilite(100)" onMouseOut="lolite()" onClick="logVariable('host')" href="../../_variables/host.html">$host</a>-&gt;<a onClick="logVariable('wwwroot')" class="var it39835" onMouseOver="hilite(39835)" onMouseOut="lolite()" href="../../_variables/wwwroot.html">wwwroot</a>.'/';
<a name="l1127"><span class="linenum">1127</span></a>          }
<a name="l1128"><span class="linenum">1128</span></a>      }
<a name="l1129"><span class="linenum">1129</span></a>  
<a name="l1130"><span class="linenum">1130</span></a>      <span class="comment">/**</span>
<a name="l1131"><span class="linenum">1131</span></a>  <span class="comment">     * Trims a log line from mnet peer to limit each part to a length which can be stored in our DB</span>
<a name="l1132"><span class="linenum">1132</span></a>  <span class="comment">     *</span>
<a name="l1133"><span class="linenum">1133</span></a>  <span class="comment">     * @param object $logline The log information to be trimmed</span>
<a name="l1134"><span class="linenum">1134</span></a>  <span class="comment">     * @return object The passed logline object trimmed to not exceed storable limits</span>
<a name="l1135"><span class="linenum">1135</span></a>  <span class="comment">     */</span>
<a name="l1136"><span class="linenum">1136</span></a>      function <a class="function" onClick="logFunction('trim_logline')" href="../../_functions/trim_logline.html" onMouseOver="funcPopup(event,'trim_logline')">trim_logline</a> (<a class="var it20814" onMouseOver="hilite(20814)" onMouseOut="lolite()" onClick="logVariable('logline')" href="../../_variables/logline.html">$logline</a>) {
<a name="l1137"><span class="linenum">1137</span></a>          <a class="var it17920" onMouseOver="hilite(17920)" onMouseOut="lolite()" onClick="logVariable('limits')" href="../../_variables/limits.html">$limits</a> = array('ip' =&gt; 15, 'coursename' =&gt; 40, 'module' =&gt; 20, 'action' =&gt; 40,
<a name="l1138"><span class="linenum">1138</span></a>                          'url' =&gt; 255);
<a name="l1139"><span class="linenum">1139</span></a>          foreach (<a class="var it17920" onMouseOver="hilite(17920)" onMouseOut="lolite()" onClick="logVariable('limits')" href="../../_variables/limits.html">$limits</a> as <a class="var it1682" onMouseOver="hilite(1682)" onMouseOut="lolite()" onClick="logVariable('property')" href="../../_variables/property.html">$property</a> =&gt; <a class="var it589" onMouseOver="hilite(589)" onMouseOut="lolite()" onClick="logVariable('limit')" href="../../_variables/limit.html">$limit</a>) {
<a name="l1140"><span class="linenum">1140</span></a>              if (isset(<a class="var it20814" onMouseOver="hilite(20814)" onMouseOut="lolite()" onClick="logVariable('logline')" href="../../_variables/logline.html">$logline</a>-&gt;<a class="var it1682" onMouseOver="hilite(1682)" onMouseOut="lolite()" onClick="logVariable('property')" href="../../_variables/property.html">$property</a>)) {
<a name="l1141"><span class="linenum">1141</span></a>                  <a class="var it20814" onMouseOver="hilite(20814)" onMouseOut="lolite()" onClick="logVariable('logline')" href="../../_variables/logline.html">$logline</a>-&gt;<a class="var it1682" onMouseOver="hilite(1682)" onMouseOut="lolite()" onClick="logVariable('property')" href="../../_variables/property.html">$property</a> = <a class="phpfunction" onClick="logFunction('substr')" href="../../_functions/substr.html" onMouseOver="phpfuncPopup(event,'substr')">substr</a>(<a class="var it20814" onMouseOver="hilite(20814)" onMouseOut="lolite()" onClick="logVariable('logline')" href="../../_variables/logline.html">$logline</a>-&gt;<a class="var it1682" onMouseOver="hilite(1682)" onMouseOut="lolite()" onClick="logVariable('property')" href="../../_variables/property.html">$property</a>, 0, <a class="var it589" onMouseOver="hilite(589)" onMouseOut="lolite()" onClick="logVariable('limit')" href="../../_variables/limit.html">$limit</a>);
<a name="l1142"><span class="linenum">1142</span></a>              }
<a name="l1143"><span class="linenum">1143</span></a>          }
<a name="l1144"><span class="linenum">1144</span></a>  
<a name="l1145"><span class="linenum">1145</span></a>          return <a class="var it20814" onMouseOver="hilite(20814)" onMouseOut="lolite()" onClick="logVariable('logline')" href="../../_variables/logline.html">$logline</a>;
<a name="l1146"><span class="linenum">1146</span></a>      }
<a name="l1147"><span class="linenum">1147</span></a>  
<a name="l1148"><span class="linenum">1148</span></a>      <span class="comment">/**</span>
<a name="l1149"><span class="linenum">1149</span></a>  <span class="comment">     * Returns a list of potential IdPs that this authentication plugin supports.</span>
<a name="l1150"><span class="linenum">1150</span></a>  <span class="comment">     * This is used to provide links on the login page.</span>
<a name="l1151"><span class="linenum">1151</span></a>  <span class="comment">     *</span>
<a name="l1152"><span class="linenum">1152</span></a>  <span class="comment">     * @param string $wantsurl the relative url fragment the user wants to get to.  You can use this to compose a returnurl, for example</span>
<a name="l1153"><span class="linenum">1153</span></a>  <span class="comment">     *</span>
<a name="l1154"><span class="linenum">1154</span></a>  <span class="comment">     * @return array like:</span>
<a name="l1155"><span class="linenum">1155</span></a>  <span class="comment">     *              array(</span>
<a name="l1156"><span class="linenum">1156</span></a>  <span class="comment">     *                  array(</span>
<a name="l1157"><span class="linenum">1157</span></a>  <span class="comment">     *                      'url' =&gt; 'http://someurl',</span>
<a name="l1158"><span class="linenum">1158</span></a>  <span class="comment">     *                      'icon' =&gt; new pix_icon(...),</span>
<a name="l1159"><span class="linenum">1159</span></a>  <span class="comment">     *                      'name' =&gt; get_string('somename', 'auth_yourplugin'),</span>
<a name="l1160"><span class="linenum">1160</span></a>  <span class="comment">     *                 ),</span>
<a name="l1161"><span class="linenum">1161</span></a>  <span class="comment">     *             )</span>
<a name="l1162"><span class="linenum">1162</span></a>  <span class="comment">     */</span>
<a name="l1163"><span class="linenum">1163</span></a>      function <a class="function" onClick="logFunction('loginpage_idp_list')" href="../../_functions/loginpage_idp_list.html" onMouseOver="funcPopup(event,'loginpage_idp_list')">loginpage_idp_list</a>(<a class="var it4003" onMouseOver="hilite(4003)" onMouseOut="lolite()" onClick="logVariable('wantsurl')" href="../../_variables/wantsurl.html">$wantsurl</a>) {
<a name="l1164"><span class="linenum">1164</span></a>          global <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>, <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>;
<a name="l1165"><span class="linenum">1165</span></a>  
<a name="l1166"><span class="linenum">1166</span></a>  <span class="comment">        // strip off wwwroot, since the remote site will prefix it's return url with this</span>
<a name="l1167"><span class="linenum">1167</span></a>          <a class="var it4003" onMouseOver="hilite(4003)" onMouseOut="lolite()" onClick="logVariable('wantsurl')" href="../../_variables/wantsurl.html">$wantsurl</a> = <a class="phpfunction" onClick="logFunction('preg_replace')" href="../../_functions/preg_replace.html" onMouseOver="phpfuncPopup(event,'preg_replace')">preg_replace</a>('/(' . <a class="phpfunction" onClick="logFunction('preg_quote')" href="../../_functions/preg_quote.html" onMouseOver="phpfuncPopup(event,'preg_quote')">preg_quote</a>(<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('wwwroot')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/wwwroot.html">wwwroot</a>, '/') . '|' . <a class="phpfunction" onClick="logFunction('preg_quote')" href="../../_functions/preg_quote.html" onMouseOver="phpfuncPopup(event,'preg_quote')">preg_quote</a>(<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('httpswwwroot')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/httpswwwroot.html">httpswwwroot</a>, '/') . ')/', '', <a class="var it4003" onMouseOver="hilite(4003)" onMouseOut="lolite()" onClick="logVariable('wantsurl')" href="../../_variables/wantsurl.html">$wantsurl</a>);
<a name="l1168"><span class="linenum">1168</span></a>  
<a name="l1169"><span class="linenum">1169</span></a>          <a class="var it125" onMouseOver="hilite(125)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a> = &quot;SELECT DISTINCT h.id, h.wwwroot, h.name, a.sso_jump_url, a.name as application
<a name="l1170"><span class="linenum">1170</span></a>                    FROM {mnet_host} h
<a name="l1171"><span class="linenum">1171</span></a>                    JOIN {mnet_host2service} m ON h.id = m.hostid
<a name="l1172"><span class="linenum">1172</span></a>                    JOIN {mnet_service} s ON s.id = m.serviceid
<a name="l1173"><span class="linenum">1173</span></a>                    JOIN {mnet_application} a ON h.applicationid = a.id
<a name="l1174"><span class="linenum">1174</span></a>                   WHERE s.name = ? AND h.deleted = ? AND m.publish = ?&quot;;
<a name="l1175"><span class="linenum">1175</span></a>          <a class="var it46" onMouseOver="hilite(46)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array('sso_sp', 0, 1);
<a name="l1176"><span class="linenum">1176</span></a>  
<a name="l1177"><span class="linenum">1177</span></a>          if (!empty(<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('mnet_all_hosts_id')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/mnet_all_hosts_id.html">mnet_all_hosts_id</a>)) {
<a name="l1178"><span class="linenum">1178</span></a>              <a class="var it125" onMouseOver="hilite(125)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a> .= &quot; AND h.id &lt;&gt; ?&quot;;
<a name="l1179"><span class="linenum">1179</span></a>              <a class="var it46" onMouseOver="hilite(46)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>[] = <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('mnet_all_hosts_id')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/mnet_all_hosts_id.html">mnet_all_hosts_id</a>;
<a name="l1180"><span class="linenum">1180</span></a>          }
<a name="l1181"><span class="linenum">1181</span></a>  
<a name="l1182"><span class="linenum">1182</span></a>          if (!<a class="var it99" onMouseOver="hilite(99)" onMouseOut="lolite()" onClick="logVariable('hosts')" href="../../_variables/hosts.html">$hosts</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records_sql')" href="../../_functions/get_records_sql.html" onMouseOver="funcPopup(event,'get_records_sql')">get_records_sql</a>(<a class="var it125" onMouseOver="hilite(125)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a>, <a class="var it46" onMouseOver="hilite(46)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>)) {
<a name="l1183"><span class="linenum">1183</span></a>              return array();
<a name="l1184"><span class="linenum">1184</span></a>          }
<a name="l1185"><span class="linenum">1185</span></a>  
<a name="l1186"><span class="linenum">1186</span></a>          <a class="var it20815" onMouseOver="hilite(20815)" onMouseOut="lolite()" onClick="logVariable('idps')" href="../../_variables/idps.html">$idps</a> = array();
<a name="l1187"><span class="linenum">1187</span></a>          foreach (<a class="var it99" onMouseOver="hilite(99)" onMouseOut="lolite()" onClick="logVariable('hosts')" href="../../_variables/hosts.html">$hosts</a> as <a class="var it100" onMouseOver="hilite(100)" onMouseOut="lolite()" onClick="logVariable('host')" href="../../_variables/host.html">$host</a>) {
<a name="l1188"><span class="linenum">1188</span></a>              <a class="var it20815" onMouseOver="hilite(20815)" onMouseOut="lolite()" onClick="logVariable('idps')" href="../../_variables/idps.html">$idps</a>[] = array(
<a name="l1189"><span class="linenum">1189</span></a>                  'url'  =&gt; <span class="keyword">new </span><a class="class" onClick="logClass('moodle_url')" href="../../_classes/moodle_url.html" onMouseOver="classPopup(event,'moodle_url')">moodle_url</a>(<a class="var it100" onMouseOver="hilite(100)" onMouseOut="lolite()" onClick="logVariable('host')" href="../../_variables/host.html">$host</a>-&gt;<a onClick="logVariable('wwwroot')" class="var it39835" onMouseOver="hilite(39835)" onMouseOut="lolite()" href="../../_variables/wwwroot.html">wwwroot</a> . <a class="var it100" onMouseOver="hilite(100)" onMouseOut="lolite()" onClick="logVariable('host')" href="../../_variables/host.html">$host</a>-&gt;<a onClick="logVariable('sso_jump_url')" class="var it39835" onMouseOver="hilite(39835)" onMouseOut="lolite()" href="../../_variables/sso_jump_url.html">sso_jump_url</a>, array('hostwwwroot' =&gt; <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('wwwroot')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../../_variables/wwwroot.html">wwwroot</a>, 'wantsurl' =&gt; <a class="var it4003" onMouseOver="hilite(4003)" onMouseOut="lolite()" onClick="logVariable('wantsurl')" href="../../_variables/wantsurl.html">$wantsurl</a>, 'remoteurl' =&gt; 1)),
<a name="l1190"><span class="linenum">1190</span></a>                  'icon' =&gt; <span class="keyword">new </span><a class="class" onClick="logClass('pix_icon')" href="../../_classes/pix_icon.html" onMouseOver="classPopup(event,'pix_icon')">pix_icon</a>('i/' . <a class="var it100" onMouseOver="hilite(100)" onMouseOut="lolite()" onClick="logVariable('host')" href="../../_variables/host.html">$host</a>-&gt;<a onClick="logVariable('application')" class="var it39835" onMouseOver="hilite(39835)" onMouseOut="lolite()" href="../../_variables/application.html">application</a> . '_host', <a class="var it100" onMouseOver="hilite(100)" onMouseOut="lolite()" onClick="logVariable('host')" href="../../_variables/host.html">$host</a>-&gt;<a onClick="logVariable('name')" class="var it39835" onMouseOver="hilite(39835)" onMouseOut="lolite()" href="../../_variables/name.html">name</a>),
<a name="l1191"><span class="linenum">1191</span></a>                  'name' =&gt; <a class="var it100" onMouseOver="hilite(100)" onMouseOut="lolite()" onClick="logVariable('host')" href="../../_variables/host.html">$host</a>-&gt;<a onClick="logVariable('name')" class="var it39835" onMouseOver="hilite(39835)" onMouseOut="lolite()" href="../../_variables/name.html">name</a>,
<a name="l1192"><span class="linenum">1192</span></a>              );
<a name="l1193"><span class="linenum">1193</span></a>          }
<a name="l1194"><span class="linenum">1194</span></a>          return <a class="var it20815" onMouseOver="hilite(20815)" onMouseOut="lolite()" onClick="logVariable('idps')" href="../../_variables/idps.html">$idps</a>;
<a name="l1195"><span class="linenum">1195</span></a>      }
<a name="l1196"><span class="linenum">1196</span></a>  }
</pre>
</div>
<script language="JavaScript" type="text/javascript">
FUNC_DATA={
'set_config': ['set_config', 'Set a configuration value for this plugin ', [['mod/assign','assignmentplugin.php',314],['lib/portfolio','plugin.php',515],['lib','moodlelib.php',1331],['lib','enrollib.php',1152],['lib/editor/tinymce/classes','plugin.php',84]], 985],
'get_mnet_remote_client': ['get_mnet_remote_client', 'during xmlrpc server code execution, any code wishing to access information about the remote peer must use this to get it. ', [['lib','moodlelib.php',9185]], 19],
'trim_logline': ['trim_logline', 'Trims a log line from mnet peer to limit each part to a length which can be stored in our DB ', [['auth/mnet','auth.php',1130]], 0],
'mnet_fields_to_import': ['mnet_fields_to_import', 'return an array of the profile fields to import from the given host, when creating/updating user accounts ', [['mnet','lib.php',856]], 2],
'get_config': ['get_config', 'Get a configuration value for this plugin ', [['mod/assign','assignmentplugin.php',345],['lib/portfolio','plugin.php',546],['question/engine','bank.php',109],['lib','moodlelib.php',1404],['lib','enrollib.php',1141],['lib/editor/tinymce/classes','plugin.php',73],['admin/tool/log/classes/helper','store.php',63]], 847],
'get_content': ['get_content', 'Parent class version of this function simply returns NULL This should be implemented by the derived class to return the content object. ', [['blocks','moodleblock.class.php',143],['blocks/login','block_login.php',34],['blocks/participants','block_participants.php',30],['blocks/feedback','block_feedback.php',40],['blocks/quiz_results','block_quiz_results.php',52],['blocks/community','block_community.php',50],['blocks/mnet_hosts','block_mnet_hosts.php',42],['blocks/course_overview','block_course_overview.php',45],['blocks/mentees','block_mentees.php',43],['blocks/myprofile','block_myprofile.php',47],['blocks/social_activities','block_social_activities.php',34],['blocks/calendar_month','block_calendar_month.php',33],['lib','modinfolib.php',1250],['blocks/navigation','block_navigation.php',131],['blocks/site_main_menu','block_site_main_menu.php',34],['blocks/blog_tags','block_blog_tags.php',62],['blocks/private_files','block_private_files.php',43],['blocks/news_items','block_news_items.php',37],['blocks/messages','block_messages.php',30],['blocks/course_summary','block_course_summary.php',40],['lib/simplepie/library/SimplePie','Item.php',372],['blocks/tag_youtube','block_tag_youtube.php',48],['mod/workshop','locallib.php',3857],['blocks/completionstatus','block_completionstatus.php',44],['blocks/badges','block_badges.php',69],['blocks/activity_modules','block_activity_modules.php',33],['blocks/search_forums','block_search_forums.php',30],['blocks/section_links','block_section_links.php',53],['blocks/blog_menu','block_blog_menu.php',52],['blocks/selfcompletion','block_selfcompletion.php',45],['blocks/online_users','block_online_users.php',39],['blocks/activity_results','block_activity_results.php',129],['blocks/blog_recent','block_blog_recent.php',46],['blocks/admin_bookmarks','block_admin_bookmarks.php',69],['blocks/glossary_random','block_glossary_random.php',168],['blocks/course_list','block_course_list.php',37],['blocks/tags','block_tags.php',56],['lib/filestorage','stored_file.php',451],['lib/filebrowser','virtual_root_file.php',106],['blocks/recent_activity','block_recent_activity.php',50],['blocks/calendar_upcoming','block_calendar_upcoming.php',33],['blocks/html','block_html.php',47],['lib','navigationlib.php',566],['blocks/comments','block_comments.php',48],['blocks/settings','block_settings.php',102],['blocks/tag_flickr','block_tag_flickr.php',46],['blocks/rss_client','block_rss_client.php',46]], 62],
'kill_children': ['kill_children', 'The IdP uses this function to kill child sessions on other hosts ', [['auth/mnet','auth.php',913]], 1],
'is_internal': ['is_internal', 'Returns true if this authentication plugin is \'internal\'. ', [['auth/radius','auth.php',142],['lib','authlib.php',203],['auth/pam','auth.php',92],['auth/db','auth.php',650],['auth/email','auth.php',164],['auth/shibboleth','auth.php',161],['auth/none','auth.php',80],['auth/nologin','auth.php',62],['auth/cas','auth.php',67],['auth/mnet','auth.php',579],['auth/pop3','auth.php',97],['auth/nntp','auth.php',80],['auth/manual','auth.php',103],['auth/fc','auth.php',161],['auth/imap','auth.php',101],['auth/webservice','auth.php',90],['auth/ldap','auth.php',1590]], 18],
'format_string': ['format_string', 'Given a simple string, this function returns the string processed by enabled string filters if $CFG->filterall is enabled ', [['lib','weblib.php',1318]], 854],
'get_timemodified': ['get_timemodified', 'Returns unix timestamp of last file modification. ', [['lib/filestorage','stored_file.php',756],['lib/filebrowser','virtual_root_file.php',272],['lib/filebrowser','file_info.php',295],['lib/filebrowser','file_info_stored.php',258]], 48],
'enrol_get_users_courses': ['enrol_get_users_courses', 'Returns list of courses user is enrolled into. (Note: use enrol_get_all_users_courses if you want to use the list wihtout any cap checks ) ', [['lib','enrollib.php',679]], 18],
'on': ['on', '', [['lib/requirejs','require.js',506]], 3494],
'debugging': ['debugging', 'Standard Debugging Function ', [['lib','weblib.php',2854]], 853],
'strlen': ['strlen', 'Multibyte safe strlen() function, uses mbstring or iconv for UTF-8, falls back to typo3. ', [['lib/classes','text.php',281],['lib/typo3','class.t3lib_cs.php',1520]], 1698],
'end_local_sessions': ['end_local_sessions', 'To delete a host, we must delete all current sessions that users from that host are currently engaged in. ', [['auth/mnet','auth.php',993]], 1],
'get_mnet_environment': ['get_mnet_environment', 'helper function to load up and initialise the mnet environment this must be called before you use mnet functions. ', [['lib','moodlelib.php',9168]], 14],
'mnet_debug': ['mnet_debug', 'Output debug information about mnet.  this will go to the <b>error_log</b>. ', [['mnet','lib.php',556]], 24],
'insert_record': ['insert_record', 'Insert a record into a table and return the "id" field if required. ', [['lib/dml','pgsql_native_moodle_database.php',883],['lib/dml','oci_native_moodle_database.php',1249],['lib/dml','sqlsrv_native_moodle_database.php',978],['lib/dml','mssql_native_moodle_database.php',898],['lib/dml','mysqli_native_moodle_database.php',1177],['lib/dml/tests','dml_test.php',5427],['lib/dml','pdo_moodle_database.php',386],['question/engine/upgrade','upgradelib.php',121]], 1512],
'logoutpage_hook': ['logoutpage_hook', 'Hook for overriding behaviour of logout page. This method is called from login/logout.php page for all enabled auth plugins. ', [['lib','authlib.php',482],['auth/shibboleth','auth.php',193],['auth/cas','auth.php',490],['auth/mnet','auth.php',1121]], 1],
'update_enrolments': ['update_enrolments', 'Invoke this function _on_ the IDP to update it with enrolment info local to the SP right after calling user_authorise() ', [['auth/mnet','auth.php',464]], 0],
'add_param': ['add_param', 'Add a parameter to the array of parameters. ', [['mnet/xmlrpc','client.php',70]], 24],
'has_capability': ['has_capability', 'Wrapper round the has_capability funciton that automatically passes in the quiz context. ', [['mod/quiz','attemptlib.php',299],['mod/quiz','attemptlib.php',884],['lib','accesslib.php',346]], 1929],
'is_enabled_auth': ['is_enabled_auth', 'Checks if a given plugin is in the list of enabled authentication plugins. ', [['lib','moodlelib.php',3580]], 30],
'touch_session': ['touch_session', 'Fake last access for given session, this prevents session timeout. ', [['lib/classes/session','manager.php',559]], 6],
'get_records': ['get_records', 'Get a number of records as an array of objects where all the given conditions met. ', [['lib/dml','moodle_database.php',1236],['lib','coursecatlib.php',654],['question','category_class.php',63]], 860],
'keepalive_client': ['keepalive_client', 'Poll the IdP server to let it know that a user it has authenticated is still online ', [['auth/mnet','auth.php',701]], 1],
'keepalive_server': ['keepalive_server', 'Receives an array of usernames from a remote machine and prods their sessions to keep them alive ', [['auth/mnet','auth.php',780]], 0],
'start_jump_session': ['start_jump_session', 'Starts an RPC jump session and returns the jump redirect URL. ', [['auth/mnet','auth.php',132]], 2],
'kill_child': ['kill_child', 'When the IdP requests that child sessions are terminated, this function will be called on each of the child hosts. The machine that calls the function (over xmlrpc) provides us with the mnethostid we need. ', [['auth/mnet','auth.php',972]], 0],
'join': ['join', 'Join a room. For internal use by the Games SDK only. Calling this method directly is unsupported. (rooms.join) ', [['lib/google/src/Google/Service','Games.php',1715],['lib/google/src/Google/Service','Games.php',2099]], 949],
'get_record': ['get_record', 'Get a single database record as an object where all the given conditions met. ', [['lib/dml','moodle_database.php',1413]], 2960],
'refresh_log': ['refresh_log', 'Receives an array of log entries from an SP and adds them to the mnet_log table ', [['auth/mnet','auth.php',767]], 2],
'cron': ['cron', 'The method being run via cron.php ', [['lib/classes/update','checker.php',189],['mod/assign','assignmentplugin.php',534],['completion/criteria','completion_criteria_grade.php',176],['repository/dropbox','lib.php',704],['question/engine','bank.php',415],['enrol/category','lib.php',77],['completion/criteria','completion_criteria_activity.php',197],['completion/criteria','completion_criteria_course.php',152],['enrol/cohort','lib.php',136],['lib','enrollib.php',1849],['enrol/paypal','lib.php',310],['mod/assign','locallib.php',1695],['enrol/manual','lib.php',285],['auth/mnet','auth.php',822],['lib/filestorage','file_storage.php',2200],['enrol/imsenterprise','lib.php',67],['repository','lib.php',2407],['enrol/flatfile','lib.php',164],['completion/criteria','completion_criteria_date.php',144],['cache/classes','helper.php',659],['blocks/recent_activity','block_recent_activity.php',231],['enrol/meta','lib.php',146],['admin/registration','lib.php',50],['enrol/self','lib.php',456],['completion/criteria','completion_criteria_duration.php',197],['blocks/rss_client','block_rss_client.php',277]], 41],
'has_service': ['has_service', 'Determines if an MNET host is providing the nominated service. ', [['auth/mnet','auth.php',1069]], 1],
'fetch_user_image': ['fetch_user_image', 'Returns the user\'s profile image info ', [['auth/mnet','auth.php',1011]], 0],
'prelogout_hook': ['prelogout_hook', 'Pre logout hook. This method is called from require_logout() for all enabled auth plugins, ', [['lib','authlib.php',470],['auth/mnet','auth.php',841]], 1],
'isloggedin': ['isloggedin', 'Return true, if session is currently logged into the backend server ', [['lib/zend/Zend/Service','LiveDocx.php',293],['lib','accesslib.php',1909]], 177],
'user_not_fully_set_up': ['user_not_fully_set_up', 'Determines if a user has completed setting up their account. ', [['lib','moodlelib.php',3120]], 7],
'user_authorise': ['user_authorise', 'Return user data for the provided token, compare with user_agent string. ', [['auth/mnet','auth.php',57]], 0],
'process_config': ['process_config', 'Processes and stores configuration data for this authentication plugin. ', [['auth/radius','auth.php',175],['lib','authlib.php',414],['auth/pam','auth.php',123],['auth/db','auth.php',725],['auth/email','auth.php',223],['auth/shibboleth','auth.php',231],['auth/none','auth.php',139],['auth/cas','auth.php',269],['auth/mnet','auth.php',680],['auth/pop3','auth.php',144],['auth/nntp','auth.php',111],['auth/manual','auth.php',193],['auth/fc','auth.php',216],['auth/imap','auth.php',148],['auth/webservice','auth.php',141],['auth/ldap','auth.php',1833],['backup/moodle2','restore_stepslib.php',2118]], 3],
'confirm_mnet_session': ['confirm_mnet_session', 'This function confirms the remote (ID provider) host\'s mnet session by communicating the token and UA over the XMLRPC transport layer, and returns the local user record on success. ', [['auth/mnet','auth.php',206]], 1],
'user_login': ['user_login', 'Returns true if the username and password work and false if they are wrong or don\'t exist. ', [['auth/radius','auth.php',46],['lib','authlib.php',132],['auth/pam','auth.php',62],['auth/db','auth.php',50],['auth/email','auth.php',42],['auth/shibboleth','auth.php',46],['auth/none','auth.php',42],['auth/nologin','auth.php',42],['auth/cas','auth.php',53],['auth/mnet','auth.php',44],['auth/pop3','auth.php',43],['auth/nntp','auth.php',43],['auth/manual','auth.php',56],['auth/fc','auth.php',45],['auth/imap','auth.php',43],['auth/webservice','auth.php',43],['auth/ldap','auth.php',153]], 15],
'update_mnet_session': ['update_mnet_session', 'creates (or updates) the mnet session once {@see confirm_mnet_session} and {@see complete_user_login} have both been called ', [['auth/mnet','auth.php',428]], 1],
'kill_parent': ['kill_parent', 'The SP uses this function to kill the session on the parent IdP ', [['auth/mnet','auth.php',866]], 1],
'get_site': ['get_site', 'Returns $course object of the top-level site. ', [['lib','datalib.php',547]], 76],
'get_mimetype': ['get_mimetype', 'Gets mimetype ', [['lib/portfolio','caller.php',453],['lib/filestorage','stored_file.php',738],['lib/filebrowser','virtual_root_file.php',254],['lib/filebrowser','file_info.php',277],['lib','medialib.php',192],['lib/filebrowser','file_info_stored.php',240]], 56],
'kill_session': ['kill_session', 'Kill one session, the session record is removed afterwards. ', [['lib/classes/session','file.php',107],['lib/classes/session','database.php',106],['lib/classes/session','memcache.php',194],['lib/classes/session','manager.php',590],['lib/classes/session','memcached.php',196]], 17],
'list': ['list', '', [['mod/data/preset/imagegallery','jstemplate.js',9]], 1891],
'set_method': ['set_method', 'Set the path to the method or function we want to execute on the remote machine. Examples: mod/scorm/functionname auth/mnet/methodname In the case of auth and enrolment plugins, an object will be created and the method on that object will be called ', [['mnet/xmlrpc','client.php',51]], 18],
'generate_token': ['generate_token', 'Generate a random string for use as an RPC session token. ', [['auth/mnet','auth.php',125]], 2],
'get_archetype_roles': ['get_archetype_roles', 'Returns roles of a specified archetype ', [['lib','accesslib.php',3231]], 21],
'send': ['send', '', [['lib/horde/framework/Horde/Mail/Transport','Smtpmx.php',179],['lib/horde/framework/Horde/Mail/Transport','Smtphorde.php',116],['lib/horde/framework/Horde/Mail/Transport','Null.php',54],['lib/zend/Zend/Service/DeveloperGarden','SendSms.php',126],['lib/google/src/Google/Service','Gmail.php',739],['lib/google/src/Google/Service','Gmail.php',1057],['lib','excellib.class.php',132],['lib/horde/framework/Horde/Mail/Transport','Mail.php',60],['auth/cas/CAS/CAS/Request','AbstractRequest.php',223],['lib/pear/Auth','RADIUS.php',370],['lib/phpmailer','class.phpmailer.php',954],['lib/zend/Zend/Service/Amazon','Sqs.php',185],['lib/horde/framework/Horde/Mail/Transport','Smtp.php',158],['auth/cas/CAS/CAS/ProxiedService/Http','Abstract.php',126],['auth/cas/CAS/CAS/ProxiedService','Http.php',62],['lib/jabber/XMPP','XMLStream.php',677],['lib','odslib.class.php',81],['auth/cas/CAS/CAS/Request','CurlMultiRequest.php',99],['lib/horde/framework/Horde/Mime','Part.php',1679],['backup/util/xml/output','memory_xml_output.class.php',59],['lib/horde/framework/Horde/Mail/Transport','Mock.php',91],['lib/horde/framework/Horde/Mail/Transport','Sendmail.php',89],['mnet/xmlrpc','client.php',119],['auth/cas/CAS/CAS/Request','RequestInterface.php',136],['lib/jabber/XMPP','BOSH.php',150],['auth/cas/CAS/CAS/Request','MultiRequestInterface.php',75],['mod/lti/classes/local/ltiservice','response.php',205],['backup/util/xml/output','file_xml_output.class.php',66],['lib/htmlpurifier/HTMLPurifier','ErrorCollector.php',65],['lib/horde/framework/Horde/Mime','Mail.php',372]], 205],
'user_update_user': ['user_update_user', 'Update a user with a user object (will compare against the ID) ', [['user','lib.php',117]], 27],
'config_form': ['config_form', 'Prints a form for configuring this authentication plugin. ', [['auth/radius','auth.php',161],['lib','authlib.php',390],['auth/pam','auth.php',111],['message/output/popup','message_output_popup.php',68],['auth/db','auth.php',710],['auth/email','auth.php',211],['auth/shibboleth','auth.php',219],['auth/none','auth.php',127],['auth/cas','auth.php',218],['auth/mnet','auth.php',609],['auth/pop3','auth.php',130],['auth/nntp','auth.php',99],['auth/manual','auth.php',150],['auth/fc','auth.php',204],['auth/imap','auth.php',134],['auth/webservice','auth.php',130],['message/output/airnotifier','message_output_airnotifier.php',119],['message/output/jabber','message_output_jabber.php',98],['auth/ldap','auth.php',1814],['message/output/email','message_output_email.php',104]], 3],
'auth_plugin_mnet': ['auth_plugin_mnet', 'Constructor. ', [['auth/mnet','auth.php',35]], 1],
'isguestuser': ['isguestuser', 'Determines if a user is logged in as real guest user with username \'guest\'. ', [['lib','accesslib.php',1922]], 237],
'clean_param': ['clean_param', 'Used by {@link optional_param()} and {@link required_param()} to clean the variables and/or cast to specific types, based on an options field. <code> $course->format = clean_param($course->format, PARAM_ALPHA); $selectedgradeitem = clean_param($selectedgradeitem, PARAM_INT); </code> ', [['lib','moodlelib.php',768]], 607],
'can_change_password': ['can_change_password', 'Returns true if this authentication plugin can change the user\'s password. ', [['auth/radius','auth.php',151],['lib','authlib.php',151],['auth/pam','auth.php',101],['auth/db','auth.php',675],['auth/email','auth.php',173],['auth/shibboleth','auth.php',170],['auth/none','auth.php',89],['auth/nologin','auth.php',72],['auth/cas','auth.php',76],['auth/mnet','auth.php',588],['auth/pop3','auth.php',106],['auth/nntp','auth.php',89],['auth/manual','auth.php',112],['auth/fc','auth.php',170],['auth/imap','auth.php',110],['auth/webservice','auth.php',101],['auth/ldap','auth.php',1599]], 13],
'delete_records_select': ['delete_records_select', 'Delete one or more records from a table which match a particular WHERE clause. ', [['lib/dml','pgsql_native_moodle_database.php',1247],['lib/dml','oci_native_moodle_database.php',1445],['lib/dml','sqlsrv_native_moodle_database.php',1153],['lib/dml','mssql_native_moodle_database.php',1082],['lib/dml','mysqli_native_moodle_database.php',1469],['lib/dml/tests','dml_test.php',5432],['lib/dml','pdo_moodle_database.php',207]], 166],
'kill_user_sessions': ['kill_user_sessions', 'Terminate all sessions of given user unconditionally. ', [['lib/classes/session','manager.php',608]], 14],
'process_new_icon': ['process_new_icon', 'Stores optimised icon images in icon file area. ', [['lib','gdlib.php',90]], 6],
'instance': ['instance', 'Retrieve sole instance of the registry. ', [['lib/htmlpurifier/HTMLPurifier','URISchemeRegistry.php',9],['lib/classes/update','checker.php',62],['lib/htmlpurifier/HTMLPurifier','EntityLookup.php',29],['lib/classes','useragent.php',101],['backup/cc','validator.php',35],['lib/portfolio','exporter.php',251],['lib/tests','update_deployer_test.php',69],['lib/tests','string_manager_standard_test.php',124],['lib','modinfolib.php',373],['','mdeploy.php',96],['cache','disabledlib.php',171],['cache','disabledlib.php',296],['admin/tool/installaddon/classes','validator.php',85],['cache/classes','config.php',87],['course/format','lib.php',156],['lib','accesslib.php',6184],['lib','accesslib.php',6436],['lib','accesslib.php',6614],['lib','accesslib.php',6868],['lib','accesslib.php',7129],['lib','accesslib.php',7341],['cache','locallib.php',52],['lib/htmlpurifier','HTMLPurifier.php',251],['cache/classes','factory.php',114],['lib/htmlpurifier/HTMLPurifier','LanguageFactory.php',53],['cache/classes','helper.php',76],['lib/htmlpurifier/HTMLPurifier','DefinitionCacheFactory.php',31],['lib/classes','plugin_manager.php',83],['lib','filterlib.php',81],['lib/htmlpurifier/HTMLPurifier','ConfigSchema.php',80],['lib/classes/update','deployer.php',54],['admin/tool/installaddon/classes','pluginfo_client.php',37],['admin/tool/installaddon/classes','installer.php',40],['backup/cc/cc_lib','cc_utils.php',387],['backup/cc/cc_lib','cc_utils.php',443]], 3942],
'get_records_sql': ['get_records_sql', 'Get a number of records as an array of objects using a SQL statement. ', [['lib/dml','pgsql_native_moodle_database.php',732],['lib/dml','oci_native_moodle_database.php',1102],['lib/dml','sqlsrv_native_moodle_database.php',823],['lib/dml','mssql_native_moodle_database.php',741],['lib/dml','mysqli_native_moodle_database.php',1049],['lib/dml/tests','dml_test.php',5424],['lib/dml','pdo_moodle_database.php',308]], 678],
'mnet_strip_user': ['mnet_strip_user', 'given a user object (or array) and a list of allowed fields, strip out all the fields that should not be included. This can be used both for outgoing data and incoming data. ', [['mnet','lib.php',892]], 4],
'mnet_fields_to_send': ['mnet_fields_to_send', 'return an array of the profile fields to send with user information to the given mnet host. ', [['mnet','lib.php',844]], 2],
'update_record': ['update_record', 'Update a record in a table ', [['lib/dml','pgsql_native_moodle_database.php',1137],['lib/dml','oci_native_moodle_database.php',1355],['lib/dml','sqlsrv_native_moodle_database.php',1081],['lib/dml','mssql_native_moodle_database.php',1003],['lib/dml','mysqli_native_moodle_database.php',1397],['lib/dml/tests','dml_test.php',5430],['lib/dml','pdo_moodle_database.php',460]], 565],
'change_password_url': ['change_password_url', 'Returns the URL for changing the users\' passwords, or empty if the default URL can be used. ', [['lib','authlib.php',162],['auth/db','auth.php',685],['auth/email','auth.php',183],['auth/none','auth.php',99],['auth/cas','auth.php',259],['auth/mnet','auth.php',599],['auth/pop3','auth.php',116],['auth/manual','auth.php',122],['auth/imap','auth.php',120],['auth/webservice','auth.php',111],['auth/ldap','auth.php',1609]], 9],
'print_error': ['print_error', 'Abort execution by throwing of a general exception, default exception handler displays the error message in most cases. ', [['lib','setuplib.php',449]], 1560],
'loginpage_idp_list': ['loginpage_idp_list', 'Returns a list of potential IdPs that this authentication plugin supports. This is used to provide links on the login page. ', [['lib','authlib.php',554],['auth/mnet','auth.php',1148]], 1],
'get_file': ['get_file', 'Return file path. ', [['repository/filesystem','lib.php',183],['repository/flickr_public','lib.php',453],['repository/boxnet','lib.php',179],['lib','webdavlib.php',391],['repository/dropbox','lib.php',410],['mod/data/field/picture','field.class.php',124],['repository/s3','lib.php',201],['lib/filestorage','file_storage.php',448],['repository/skydrive','lib.php',130],['repository/webdav','lib.php',73],['repository/dropbox','locallib.php',114],['repository','lib.php',1701],['repository/flickr','lib.php',277],['repository/googledocs','lib.php',408],['lib','externallib.php',870],['mod/data/field/file','field.class.php',121],['repository/equella','lib.php',166],['repository/alfresco','lib.php',195]], 162],
'can_login_remotely': ['can_login_remotely', 'Checks the MNET access control table to see if the username/mnethost is permitted to login to this moodle. ', [['auth/mnet','auth.php',1102]], 1],
'is_mnet_remote_user': ['is_mnet_remote_user', 'Returns whether or not the user object is a remote MNET user. This function is in moodlelib because it does not rely on loading any of the MNET code. ', [['lib','moodlelib.php',8869]], 20],
'delete_records': ['delete_records', 'Delete the records from a table where all the given conditions met. If conditions not specified, table is truncated. ', [['lib/dml','moodle_database.php',1815],['lib/dml','sqlite3_pdo_moodle_database.php',337]], 778],
'fetch_theme_info': ['fetch_theme_info', 'Returns the theme information and logo url as strings. ', [['auth/mnet','auth.php',1053]], 0],
'get_field': ['get_field', 'Get the right field name to fetch a stat for these attempts that is calculated for more than one $whichattempts (count or avg). ', [['mod/quiz/report/statistics/classes','calculated.php',109],['lib/dml','moodle_database.php',1497],['user/filters','lib.php',124],['lib/behat','behat_field_manager.php',243]], 485],
'prevent_local_passwords': ['prevent_local_passwords', '', [['auth/radius','auth.php',138],['lib','authlib.php',215],['auth/pam','auth.php',88],['auth/db','auth.php',646],['auth/email','auth.php',160],['auth/shibboleth','auth.php',157],['auth/none','auth.php',76],['auth/nologin','auth.php',57],['auth/cas','auth.php',49],['auth/mnet','auth.php',575],['auth/pop3','auth.php',93],['auth/nntp','auth.php',76],['auth/manual','auth.php',99],['auth/fc','auth.php',157],['auth/imap','auth.php',97],['auth/ldap','auth.php',1581]], 2],
'get_file_storage': ['get_file_storage', 'Returns local file storage instance ', [['lib','moodlelib.php',5950]], 486],
'set_id': ['set_id', 'Setter for $id. ', [['lib/classes/task','adhoc_task.php',43],['lib/classes/message/inbound','handler.php',100],['mnet','peer.php',257]], 19],
'is_loggedinas': ['is_loggedinas', 'Is current $USER logged-in-as somebody else? ', [['lib/classes/session','manager.php',786]], 32],
'urlencode': ['urlencode', '', [], 234],
'array_key_exists': ['array_key_exists', '', [], 1539],
'substr': ['substr', '', [], 2883],
'explode': ['explode', '', [], 1599],
'is_array': ['is_array', '', [], 1820],
'mt_rand': ['mt_rand', '', [], 54],
'unlink': ['unlink', '', [], 252],
'ob_start': ['ob_start', '', [], 101],
'file_put_contents': ['file_put_contents', '', [], 86],
'count': ['count', '', [], 3984],
'defined': ['defined', '', [], 4098],
'str_replace': ['str_replace', '', [], 1667],
'ob_end_clean': ['ob_end_clean', '', [], 79],
'array_chunk': ['array_chunk', '', [], 10],
'is_null': ['is_null', '', [], 1992],
'session_id': ['session_id', '', [], 35],
'sha1': ['sha1', '', [], 188],
'array_values': ['array_values', '', [], 283],
'time': ['time', '', [], 1768],
'base64_decode': ['base64_decode', '', [], 101],
'stristr': ['stristr', '', [], 55],
'reset': ['reset', '', [], 1070],
'array_keys': ['array_keys', '', [], 1152],
'preg_replace': ['preg_replace', '', [], 903],
'base64_encode': ['base64_encode', '', [], 146],
'array_pop': ['array_pop', '', [], 438],
'implode': ['implode', '', [], 1259],
'str_shuffle': ['str_shuffle', '', [], 7],
'rand': ['rand', '', [], 107],
'array_map': ['array_map', '', [], 149],
'ini_get': ['ini_get', '', [], 142],
'preg_quote': ['preg_quote', '', [], 207],
'is_numeric': ['is_numeric', '', [], 723]};
CLASS_DATA={
'context_system': ['context_system', 'System context class ', [['lib','accesslib.php',6106]], 929],
'mnet_peer': ['mnet_peer', '', [['mnet','peer.php',13]], 28],
'manager': ['manager', 'Defines MAnager class for myprofile navigation tree. ', [['user/classes/output/myprofile','manager.php',28],['lib/classes/log','manager.php',29],['admin/tool/messageinbound/classes','manager.php',29],['lib/classes/message','manager.php',31],['lib/classes/message/inbound','manager.php',29],['admin/tool/log/classes/log','manager.php',29],['lib/classes/session','manager.php',29],['lib/classes/task','manager.php',28],['lib/classes/event','manager.php',30]], 346],
'mnet_xmlrpc_client': ['mnet_xmlrpc_client', 'Class representing an XMLRPC request against a remote machine ', [['mnet/xmlrpc','client.php',13]], 17],
'moodle_url': ['moodle_url', 'Class for creating and manipulating urls. ', [['lib','weblib.php',240]], 2887],
'auth_plugin_base': ['auth_plugin_base', 'Abstract authentication plugin. ', [['lib','authlib.php',82]], 16],
'context_user': ['context_user', 'User context class ', [['lib','accesslib.php',6347]], 288],
'mnet_server_exception': ['mnet_server_exception', 'mnet server exception.  extends moodle_exception, but takes slightly different arguments. and unlike the rest of moodle, the actual int error code is used. this exception should only be used during an xmlrpc server request, ie, not for client requests. ', [['mnet/xmlrpc','serverlib.php',661]], 44],
'moodle_exception': ['moodle_exception', 'Base Moodle Exception class ', [['lib','setuplib.php',68]], 478],
'pix_icon': ['pix_icon', 'Data structure representing an icon. ', [['lib','outputcomponents.php',497]], 247],
'auth_plugin_mnet': ['auth_plugin_mnet', 'Moodle Network authentication plugin. ', [['auth/mnet','auth.php',30]], 2]};
CONST_DATA={
'PARAM_ALPHANUM': ['PARAM_ALPHANUM', '', [['lib','moodlelib.php',88]], 97],
'PARAM_URL': ['PARAM_URL', '', [['lib','moodlelib.php',239]], 121],
'PARAM_LANG': ['PARAM_LANG', '', [['lib','moodlelib.php',161]], 20],
'PARAM_INT': ['PARAM_INT', '', [['lib','moodlelib.php',156]], 2948],
'DEBUG_DEVELOPER': ['DEBUG_DEVELOPER', '', [['lib','setuplib.php',40]], 554],
'MUST_EXIST': ['MUST_EXIST', '', [['lib','dmllib.php',52]], 1252],
'MOODLE_INTERNAL': ['MOODLE_INTERNAL', '', [['admin/cli','install.php',138],['','install.php',93],['lib','setup.php',386]], 3532],
'MNET_SERVER': ['MNET_SERVER', '', [['mnet/xmlrpc','server.php',18]], 5]};
</script>
<div id="func-popup" class="funcpopup"><p id="func-title" class="popup-title">title</p><p id="func-desc" class="popup-desc">Description</p><p id="func-body" class="popup-body">Body</p></div>
<div id="class-popup" class="funcpopup"><p id="class-title" class="popup-title">title</p><p id="class-desc" class="popup-desc">Description</p><p id="class-body" class="popup-body">Body</p></div>
<div id="const-popup" class="funcpopup"><p id="const-title" class="popup-title">title</p><p id="const-desc" class="popup-desc">Description</p><p id="const-body" class="popup-body">Body</p></div>
<div id="req-popup" class="funcpopup"><p id="req-title" class="popup-title">title</p><p id="req-body" class="popup-body">Body</p></div>
<!-- A link to the phpxref site in your customized footer file is appreciated ;-) -->
<br><hr>
<table width="100%">
	<tr><td>Generated: Thu May 28 19:17:31 2015</td>
	<td align="right"><i>Cross-referenced by <a href="http://phpxref.sourceforge.net/">PHPXref 0.7.1</a></i></td>
	</tr>
</table>
</body></html>
