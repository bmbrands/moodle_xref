<!doctype html public "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
    <title>PHPXRef 0.7.1 : Unnamed Project : /backup/moodle2/restore_stepslib.php source</title>
    <link rel="stylesheet" href="../../sample.css" type="text/css">
    <link rel="stylesheet" href="../../sample-print.css" type="text/css" media="print">
    <style id="hilight" type="text/css"></style>
    <meta http-equiv="content-type" content="text/html;charset=iso-8859-1">
</head>
<body bgcolor="#ffffff" text="#000000" link="#801800" vlink="#300540" alink="#ffffff">
<table class="pagetitle" width="100%">
	<tr>
        <td valign="top" class="pagetitle">
            [ <a href="../../index.html">Index</a> ]
        </td>
        <td align="right" class="pagetitle">
		    <h2 style="margin-bottom: 0px">PHP Cross Reference of Unnamed Project</h2>
	    </td>
    </tr>
</table>


<!-- Generated by PHPXref 0.7.1 at Thu Aug 11 10:00:09 2016 -->
<!-- PHPXref (c) 2000-2010 Gareth Watts - gareth@omnipotent.net -->
<!-- http://phpxref.sourceforge.net/ -->

<script src="../../phpxref.js" type="text/javascript"></script>
<script language="JavaScript" type="text/javascript">
<!--
ext='.html';
relbase='../../';
subdir='backup/moodle2';
filename='restore_stepslib.php.source.html';
cookiekey='phpxref';
handleNavFrame(relbase, subdir, filename);

// -->
</script>
<script language="JavaScript" type="text/javascript">
if (gwGetCookie('xrefnav')=='off')
  document.write('<p class="navlinks">[ <a href="javascript:navOn()">Show Explorer<\/a> ]<\/p>');
else
  document.write('<p class="navlinks">[ <a href="javascript:navOff()">Hide Explorer<\/a> ]<\/p>');
</script>
<noscript>
<p class="navlinks">
[ <a href="../../nav.html" target="_top">Show Explorer</a> ]
[ <a href="index.html" target="_top">Hide Navbar</a> ]
</p>
</noscript>
<script language="JavaScript" type="text/javascript">
<!--

document.writeln('<table align="right" class="searchbox-link"><tr><td><a class="searchbox-link" href="javascript:void(0)" onMouseOver="showSearchBox()">Search</a><br>');
document.writeln('<table border="0" cellspacing="0" cellpadding="0" class="searchbox" id="searchbox">');
document.writeln('<tr><td class="searchbox-title">');
document.writeln('<a class="searchbox-title" href="javascript:showSearchPopup()">Search History +</a>');
document.writeln('<\/td><\/tr>');

document.writeln('<tr><td class="searchbox-body" id="searchbox-body">');
document.writeln('<form name="search" style="margin:0px; padding:0px" onSubmit=\'return jump()\'>');
document.writeln('<a class="searchbox-body" href="../../_classes/index.html">Class<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="classname"><br>');
document.writeln('<a id="funcsearchlink" class="searchbox-body" href="../../_functions/index.html">Function<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="funcname"><br>');
document.writeln('<a class="searchbox-body" href="../../_variables/index.html">Variable<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="varname"><br>');
document.writeln('<a class="searchbox-body" href="../../_constants/index.html">Constant<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="constname"><br>');
document.writeln('<a class="searchbox-body" href="../../_tables/index.html">Table<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="tablename"><br>');
document.writeln('<input type="submit" class="searchbox-button" value="Search">');
document.writeln('<\/form>');
document.writeln('<\/td><\/tr><\/table>');
document.writeln('<\/td><\/tr><\/table>');
// -->
</script>
<div id="search-popup" class="searchpopup"><p id="searchpopup-title" class="searchpopup-title">title</p><div id="searchpopup-body" class="searchpopup-body">Body</div><p class="searchpopup-close"><a href="javascript:gwCloseActive()">[close]</a></p></div>
<h2 class="listing-heading"><a href="./index.html">/backup/moodle2/</a> -> <a href="restore_stepslib.php.html">restore_stepslib.php</a> (source)</h2>
<div class="listing">
<p class="viewlinks">[<a href="restore_stepslib.php.html">Summary view</a>]
[<a href="javascript:window.print();">Print</a>]
[<a href="restore_stepslib.php.source.txt" target="_new">Text view</a>]
</p>
<pre>
<a name="l1"><span class="linenum">   1</span></a>  &lt;?php
<a name="l2"><span class="linenum">   2</span></a>  
<a name="l3"><span class="linenum">   3</span></a>  <span class="comment">// This file is part of Moodle - http://moodle.org/</span>
<a name="l4"><span class="linenum">   4</span></a>  <span class="comment">//</span>
<a name="l5"><span class="linenum">   5</span></a>  <span class="comment">// Moodle is free software: you can redistribute it and/or modify</span>
<a name="l6"><span class="linenum">   6</span></a>  <span class="comment">// it under the terms of the GNU General Public License as published by</span>
<a name="l7"><span class="linenum">   7</span></a>  <span class="comment">// the Free Software Foundation, either version 3 of the License, or</span>
<a name="l8"><span class="linenum">   8</span></a>  <span class="comment">// (at your option) any later version.</span>
<a name="l9"><span class="linenum">   9</span></a>  <span class="comment">//</span>
<a name="l10"><span class="linenum">  10</span></a>  <span class="comment">// Moodle is distributed in the hope that it will be useful,</span>
<a name="l11"><span class="linenum">  11</span></a>  <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l12"><span class="linenum">  12</span></a>  <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l13"><span class="linenum">  13</span></a>  <span class="comment">// GNU General Public License for more details.</span>
<a name="l14"><span class="linenum">  14</span></a>  <span class="comment">//</span>
<a name="l15"><span class="linenum">  15</span></a>  <span class="comment">// You should have received a copy of the GNU General Public License</span>
<a name="l16"><span class="linenum">  16</span></a>  <span class="comment">// along with Moodle.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l17"><span class="linenum">  17</span></a>  
<a name="l18"><span class="linenum">  18</span></a>  <span class="comment">/**</span>
<a name="l19"><span class="linenum">  19</span></a>  <span class="comment"> * Defines various restore steps that will be used by common tasks in restore</span>
<a name="l20"><span class="linenum">  20</span></a>  <span class="comment"> *</span>
<a name="l21"><span class="linenum">  21</span></a>  <span class="comment"> * @package     core_backup</span>
<a name="l22"><span class="linenum">  22</span></a>  <span class="comment"> * @subpackage  moodle2</span>
<a name="l23"><span class="linenum">  23</span></a>  <span class="comment"> * @category    backup</span>
<a name="l24"><span class="linenum">  24</span></a>  <span class="comment"> * @copyright   2010 onwards Eloy Lafuente (stronk7) {@link http://stronk7.com}</span>
<a name="l25"><span class="linenum">  25</span></a>  <span class="comment"> * @license     http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later</span>
<a name="l26"><span class="linenum">  26</span></a>  <span class="comment"> */</span>
<a name="l27"><span class="linenum">  27</span></a>  
<a name="l28"><span class="linenum">  28</span></a>  <a class="phpfunction" onClick="logFunction('defined')" href="../../_functions/defined.html" onMouseOver="phpfuncPopup(event,'defined')">defined</a>('<a class="constant" onClick="logConstant('MOODLE_INTERNAL')" href="../../_constants/MOODLE_INTERNAL.html" onMouseOver="constPopup(event,'MOODLE_INTERNAL')">MOODLE_INTERNAL</a>') || die();
<a name="l29"><span class="linenum">  29</span></a>  
<a name="l30"><span class="linenum">  30</span></a>  <span class="comment">/**</span>
<a name="l31"><span class="linenum">  31</span></a>  <span class="comment"> * delete old directories and conditionally create backup_temp_ids table</span>
<a name="l32"><span class="linenum">  32</span></a>  <span class="comment"> */</span>
<a name="l33"><span class="linenum">  33</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_create_and_clean_temp_stuff')" href="../../_classes/restore_create_and_clean_temp_stuff.html" onMouseOver="classPopup(event,'restore_create_and_clean_temp_stuff')">restore_create_and_clean_temp_stuff</a> extends restore_execution_step {
<a name="l34"><span class="linenum">  34</span></a>  
<a name="l35"><span class="linenum">  35</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l36"><span class="linenum">  36</span></a>          <a class="var it2527" onMouseOver="hilite(2527)" onMouseOut="lolite()" onClick="logVariable('exists')" href="../../_variables/exists.html">$exists</a> = restore_controller_dbops::<a class="function" onClick="logFunction('create_restore_temp_tables')" href="../../_functions/create_restore_temp_tables.html" onMouseOver="funcPopup(event,'create_restore_temp_tables')">create_restore_temp_tables</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>()); <span class="comment">// temp tables conditionally</span>
<a name="l37"><span class="linenum">  37</span></a>  <span class="comment">        // If the table already exists, it's because restore_prechecks have been executed in the same</span>
<a name="l38"><span class="linenum">  38</span></a>  <span class="comment">        // request (without problems) and it already contains a bunch of preloaded information (users...)</span>
<a name="l39"><span class="linenum">  39</span></a>  <span class="comment">        // that we aren't going to execute again</span>
<a name="l40"><span class="linenum">  40</span></a>          if (<a class="var it2527" onMouseOver="hilite(2527)" onMouseOut="lolite()" onClick="logVariable('exists')" href="../../_variables/exists.html">$exists</a>) { // Inform plan about preloaded information
<a name="l41"><span class="linenum">  41</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('set_preloaded_information')" href="../../_functions/set_preloaded_information.html" onMouseOver="funcPopup(event,'set_preloaded_information')">set_preloaded_information</a>();
<a name="l42"><span class="linenum">  42</span></a>          }
<a name="l43"><span class="linenum">  43</span></a>  <span class="comment">        // Create the old-course-ctxid to new-course-ctxid mapping, we need that available since the beginning</span>
<a name="l44"><span class="linenum">  44</span></a>          <a class="var it868" onMouseOver="hilite(868)" onMouseOut="lolite()" onClick="logVariable('itemid')" href="../../_variables/itemid.html">$itemid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_old_contextid')" href="../../_functions/get_old_contextid.html" onMouseOver="funcPopup(event,'get_old_contextid')">get_old_contextid</a>();
<a name="l45"><span class="linenum">  45</span></a>          <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="class" onClick="logClass('context_course')" href="../../_classes/context_course.html" onMouseOver="classPopup(event,'context_course')">context_course</a>::<a class="function" onClick="logFunction('instance')" href="../../_functions/instance.html" onMouseOver="funcPopup(event,'instance')">instance</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>())-&gt;id;
<a name="l46"><span class="linenum">  46</span></a>          restore_dbops::<a class="function" onClick="logFunction('set_backup_ids_record')" href="../../_functions/set_backup_ids_record.html" onMouseOver="funcPopup(event,'set_backup_ids_record')">set_backup_ids_record</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'context', <a class="var it868" onMouseOver="hilite(868)" onMouseOut="lolite()" onClick="logVariable('itemid')" href="../../_variables/itemid.html">$itemid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>);
<a name="l47"><span class="linenum">  47</span></a>  <span class="comment">        // Create the old-system-ctxid to new-system-ctxid mapping, we need that available since the beginning</span>
<a name="l48"><span class="linenum">  48</span></a>          <a class="var it868" onMouseOver="hilite(868)" onMouseOut="lolite()" onClick="logVariable('itemid')" href="../../_variables/itemid.html">$itemid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_old_system_contextid')" href="../../_functions/get_old_system_contextid.html" onMouseOver="funcPopup(event,'get_old_system_contextid')">get_old_system_contextid</a>();
<a name="l49"><span class="linenum">  49</span></a>          <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="class" onClick="logClass('context_system')" href="../../_classes/context_system.html" onMouseOver="classPopup(event,'context_system')">context_system</a>::<a class="function" onClick="logFunction('instance')" href="../../_functions/instance.html" onMouseOver="funcPopup(event,'instance')">instance</a>()-&gt;id;
<a name="l50"><span class="linenum">  50</span></a>          restore_dbops::<a class="function" onClick="logFunction('set_backup_ids_record')" href="../../_functions/set_backup_ids_record.html" onMouseOver="funcPopup(event,'set_backup_ids_record')">set_backup_ids_record</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'context', <a class="var it868" onMouseOver="hilite(868)" onMouseOut="lolite()" onClick="logVariable('itemid')" href="../../_variables/itemid.html">$itemid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>);
<a name="l51"><span class="linenum">  51</span></a>  <span class="comment">        // Create the old-course-id to new-course-id mapping, we need that available since the beginning</span>
<a name="l52"><span class="linenum">  52</span></a>          <a class="var it868" onMouseOver="hilite(868)" onMouseOut="lolite()" onClick="logVariable('itemid')" href="../../_variables/itemid.html">$itemid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_old_courseid')" href="../../_functions/get_old_courseid.html" onMouseOver="funcPopup(event,'get_old_courseid')">get_old_courseid</a>();
<a name="l53"><span class="linenum">  53</span></a>          <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l54"><span class="linenum">  54</span></a>          restore_dbops::<a class="function" onClick="logFunction('set_backup_ids_record')" href="../../_functions/set_backup_ids_record.html" onMouseOver="funcPopup(event,'set_backup_ids_record')">set_backup_ids_record</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'course', <a class="var it868" onMouseOver="hilite(868)" onMouseOut="lolite()" onClick="logVariable('itemid')" href="../../_variables/itemid.html">$itemid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>);
<a name="l55"><span class="linenum">  55</span></a>  
<a name="l56"><span class="linenum">  56</span></a>      }
<a name="l57"><span class="linenum">  57</span></a>  }
<a name="l58"><span class="linenum">  58</span></a>  
<a name="l59"><span class="linenum">  59</span></a>  <span class="comment">/**</span>
<a name="l60"><span class="linenum">  60</span></a>  <span class="comment"> * delete the temp dir used by backup/restore (conditionally),</span>
<a name="l61"><span class="linenum">  61</span></a>  <span class="comment"> * delete old directories and drop temp ids table</span>
<a name="l62"><span class="linenum">  62</span></a>  <span class="comment"> */</span>
<a name="l63"><span class="linenum">  63</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_drop_and_clean_temp_stuff')" href="../../_classes/restore_drop_and_clean_temp_stuff.html" onMouseOver="classPopup(event,'restore_drop_and_clean_temp_stuff')">restore_drop_and_clean_temp_stuff</a> extends restore_execution_step {
<a name="l64"><span class="linenum">  64</span></a>  
<a name="l65"><span class="linenum">  65</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l66"><span class="linenum">  66</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>;
<a name="l67"><span class="linenum">  67</span></a>          restore_controller_dbops::<a class="function" onClick="logFunction('drop_restore_temp_tables')" href="../../_functions/drop_restore_temp_tables.html" onMouseOver="funcPopup(event,'drop_restore_temp_tables')">drop_restore_temp_tables</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>()); <span class="comment">// Drop ids temp table</span>
<a name="l68"><span class="linenum">  68</span></a>          <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_progress')" href="../../_functions/get_progress.html" onMouseOver="funcPopup(event,'get_progress')">get_progress</a>();
<a name="l69"><span class="linenum">  69</span></a>          <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>-&gt;<a class="function" onClick="logFunction('start_progress')" href="../../_functions/start_progress.html" onMouseOver="funcPopup(event,'start_progress')">start_progress</a>('Deleting backup dir');
<a name="l70"><span class="linenum">  70</span></a>          backup_helper::<a class="function" onClick="logFunction('delete_old_backup_dirs')" href="../../_functions/delete_old_backup_dirs.html" onMouseOver="funcPopup(event,'delete_old_backup_dirs')">delete_old_backup_dirs</a>(<a class="phpfunction" onClick="logFunction('strtotime')" href="../../_functions/strtotime.html" onMouseOver="phpfuncPopup(event,'strtotime')">strtotime</a>('-1 week'), <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>);      <span class="comment">// Delete &gt; 1 week old temp dirs.</span>
<a name="l71"><span class="linenum">  71</span></a>          if (empty(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('keeptempdirectoriesonbackup')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/keeptempdirectoriesonbackup.html">keeptempdirectoriesonbackup</a>)) { // Conditionally
<a name="l72"><span class="linenum">  72</span></a>              backup_helper::<a class="function" onClick="logFunction('delete_backup_dir')" href="../../_functions/delete_backup_dir.html" onMouseOver="funcPopup(event,'delete_backup_dir')">delete_backup_dir</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_tempdir')" href="../../_functions/get_tempdir.html" onMouseOver="funcPopup(event,'get_tempdir')">get_tempdir</a>(), <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>); <span class="comment">// Empty restore dir</span>
<a name="l73"><span class="linenum">  73</span></a>          }
<a name="l74"><span class="linenum">  74</span></a>          <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>-&gt;<a class="function" onClick="logFunction('end_progress')" href="../../_functions/end_progress.html" onMouseOver="funcPopup(event,'end_progress')">end_progress</a>();
<a name="l75"><span class="linenum">  75</span></a>      }
<a name="l76"><span class="linenum">  76</span></a>  }
<a name="l77"><span class="linenum">  77</span></a>  
<a name="l78"><span class="linenum">  78</span></a>  <span class="comment">/**</span>
<a name="l79"><span class="linenum">  79</span></a>  <span class="comment"> * Restore calculated grade items, grade categories etc</span>
<a name="l80"><span class="linenum">  80</span></a>  <span class="comment"> */</span>
<a name="l81"><span class="linenum">  81</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_gradebook_structure_step')" href="../../_classes/restore_gradebook_structure_step.html" onMouseOver="classPopup(event,'restore_gradebook_structure_step')">restore_gradebook_structure_step</a> extends restore_structure_step {
<a name="l82"><span class="linenum">  82</span></a>  
<a name="l83"><span class="linenum">  83</span></a>      <span class="comment">/**</span>
<a name="l84"><span class="linenum">  84</span></a>  <span class="comment">     * To conditionally decide if this step must be executed</span>
<a name="l85"><span class="linenum">  85</span></a>  <span class="comment">     * Note the &quot;settings&quot; conditions are evaluated in the</span>
<a name="l86"><span class="linenum">  86</span></a>  <span class="comment">     * corresponding task. Here we check for other conditions</span>
<a name="l87"><span class="linenum">  87</span></a>  <span class="comment">     * not being restore settings (files, site settings...)</span>
<a name="l88"><span class="linenum">  88</span></a>  <span class="comment">     */</span>
<a name="l89"><span class="linenum">  89</span></a>       protected function <a class="function" onClick="logFunction('execute_condition')" href="../../_functions/execute_condition.html" onMouseOver="funcPopup(event,'execute_condition')">execute_condition</a>() {
<a name="l90"><span class="linenum">  90</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l91"><span class="linenum">  91</span></a>  
<a name="l92"><span class="linenum">  92</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>() == <a class="constant" onClick="logConstant('SITEID')" href="../../_constants/SITEID.html" onMouseOver="constPopup(event,'SITEID')">SITEID</a>) {
<a name="l93"><span class="linenum">  93</span></a>              return false;
<a name="l94"><span class="linenum">  94</span></a>          }
<a name="l95"><span class="linenum">  95</span></a>  
<a name="l96"><span class="linenum">  96</span></a>  <span class="comment">        // No gradebook info found, don't execute</span>
<a name="l97"><span class="linenum">  97</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_taskbasepath')" href="../../_functions/get_taskbasepath.html" onMouseOver="funcPopup(event,'get_taskbasepath')">get_taskbasepath</a>();
<a name="l98"><span class="linenum">  98</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="phpfunction" onClick="logFunction('rtrim')" href="../../_functions/rtrim.html" onMouseOver="phpfuncPopup(event,'rtrim')">rtrim</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>, '/') . '/' . <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('filename')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/filename.html">filename</a>;
<a name="l99"><span class="linenum">  99</span></a>          if (!<a class="phpfunction" onClick="logFunction('file_exists')" href="../../_functions/file_exists.html" onMouseOver="phpfuncPopup(event,'file_exists')">file_exists</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>)) {
<a name="l100"><span class="linenum"> 100</span></a>              return false;
<a name="l101"><span class="linenum"> 101</span></a>          }
<a name="l102"><span class="linenum"> 102</span></a>  
<a name="l103"><span class="linenum"> 103</span></a>  <span class="comment">        // Some module present in backup file isn't available to restore</span>
<a name="l104"><span class="linenum"> 104</span></a>  <span class="comment">        // in this site, don't execute</span>
<a name="l105"><span class="linenum"> 105</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('is_missing_modules')" href="../../_functions/is_missing_modules.html" onMouseOver="funcPopup(event,'is_missing_modules')">is_missing_modules</a>()) {
<a name="l106"><span class="linenum"> 106</span></a>              return false;
<a name="l107"><span class="linenum"> 107</span></a>          }
<a name="l108"><span class="linenum"> 108</span></a>  
<a name="l109"><span class="linenum"> 109</span></a>  <span class="comment">        // Some activity has been excluded to be restored, don't execute</span>
<a name="l110"><span class="linenum"> 110</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('is_excluding_activities')" href="../../_functions/is_excluding_activities.html" onMouseOver="funcPopup(event,'is_excluding_activities')">is_excluding_activities</a>()) {
<a name="l111"><span class="linenum"> 111</span></a>              return false;
<a name="l112"><span class="linenum"> 112</span></a>          }
<a name="l113"><span class="linenum"> 113</span></a>  
<a name="l114"><span class="linenum"> 114</span></a>  <span class="comment">        // There should only be one grade category (the 1 associated with the course itself)</span>
<a name="l115"><span class="linenum"> 115</span></a>  <span class="comment">        // If other categories already exist we're restoring into an existing course.</span>
<a name="l116"><span class="linenum"> 116</span></a>  <span class="comment">        // Restoring categories into a course with an existing category structure is unlikely to go well</span>
<a name="l117"><span class="linenum"> 117</span></a>          <a class="var it261" onMouseOver="hilite(261)" onMouseOut="lolite()" onClick="logVariable('category')" href="../../_variables/category.html">$category</a> = new stdclass();
<a name="l118"><span class="linenum"> 118</span></a>          <a class="var it261" onMouseOver="hilite(261)" onMouseOut="lolite()" onClick="logVariable('category')" href="../../_variables/category.html">$category</a>-&gt;<a onClick="logVariable('courseid')" class="var it42970" onMouseOver="hilite(42970)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a>  = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l119"><span class="linenum"> 119</span></a>          <a class="var it15346" onMouseOver="hilite(15346)" onMouseOut="lolite()" onClick="logVariable('catcount')" href="../../_variables/catcount.html">$catcount</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('count_records')" href="../../_functions/count_records.html" onMouseOver="funcPopup(event,'count_records')">count_records</a>('grade_categories', (array)<a class="var it261" onMouseOver="hilite(261)" onMouseOut="lolite()" onClick="logVariable('category')" href="../../_variables/category.html">$category</a>);
<a name="l120"><span class="linenum"> 120</span></a>          if (<a class="var it15346" onMouseOver="hilite(15346)" onMouseOut="lolite()" onClick="logVariable('catcount')" href="../../_variables/catcount.html">$catcount</a>&gt;1) {
<a name="l121"><span class="linenum"> 121</span></a>              return false;
<a name="l122"><span class="linenum"> 122</span></a>          }
<a name="l123"><span class="linenum"> 123</span></a>  
<a name="l124"><span class="linenum"> 124</span></a>  <span class="comment">        // Identify the backup we're dealing with.</span>
<a name="l125"><span class="linenum"> 125</span></a>          <a class="var it10723" onMouseOver="hilite(10723)" onMouseOut="lolite()" onClick="logVariable('backuprelease')" href="../../_variables/backuprelease.html">$backuprelease</a> = <a class="phpfunction" onClick="logFunction('floatval')" href="../../_functions/floatval.html" onMouseOver="phpfuncPopup(event,'floatval')">floatval</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_task')" href="../../_functions/get_task.html" onMouseOver="funcPopup(event,'get_task')">get_task</a>()-&gt;<a class="function" onClick="logFunction('get_info')" href="../../_functions/get_info.html" onMouseOver="funcPopup(event,'get_info')">get_info</a>()-&gt;backup_release); <span class="comment">// The major version: 2.9, 3.0, ...</span>
<a name="l126"><span class="linenum"> 126</span></a>          <a class="var it15347" onMouseOver="hilite(15347)" onMouseOut="lolite()" onClick="logVariable('backupbuild')" href="../../_variables/backupbuild.html">$backupbuild</a> = 0;
<a name="l127"><span class="linenum"> 127</span></a>          <a class="phpfunction" onClick="logFunction('preg_match')" href="../../_functions/preg_match.html" onMouseOver="phpfuncPopup(event,'preg_match')">preg_match</a>('/(\d{8})/', <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_task')" href="../../_functions/get_task.html" onMouseOver="funcPopup(event,'get_task')">get_task</a>()-&gt;<a class="function" onClick="logFunction('get_info')" href="../../_functions/get_info.html" onMouseOver="funcPopup(event,'get_info')">get_info</a>()-&gt;moodle_release, <a class="var it161" onMouseOver="hilite(161)" onMouseOut="lolite()" onClick="logVariable('matches')" href="../../_variables/matches.html">$matches</a>);
<a name="l128"><span class="linenum"> 128</span></a>          if (!empty(<a class="var it161" onMouseOver="hilite(161)" onMouseOut="lolite()" onClick="logVariable('matches')" href="../../_variables/matches.html">$matches</a>[1])) {
<a name="l129"><span class="linenum"> 129</span></a>              <a class="var it15347" onMouseOver="hilite(15347)" onMouseOut="lolite()" onClick="logVariable('backupbuild')" href="../../_variables/backupbuild.html">$backupbuild</a> = (int) <a class="var it161" onMouseOver="hilite(161)" onMouseOut="lolite()" onClick="logVariable('matches')" href="../../_variables/matches.html">$matches</a>[1]; <span class="comment">// The date of Moodle build at the time of the backup.</span>
<a name="l130"><span class="linenum"> 130</span></a>          }
<a name="l131"><span class="linenum"> 131</span></a>  
<a name="l132"><span class="linenum"> 132</span></a>  <span class="comment">        // On older versions the freeze value has to be converted.</span>
<a name="l133"><span class="linenum"> 133</span></a>  <span class="comment">        // We do this from here as it is happening right before the file is read.</span>
<a name="l134"><span class="linenum"> 134</span></a>  <span class="comment">        // This only targets the backup files that can contain the legacy freeze.</span>
<a name="l135"><span class="linenum"> 135</span></a>          if (<a class="var it15347" onMouseOver="hilite(15347)" onMouseOut="lolite()" onClick="logVariable('backupbuild')" href="../../_variables/backupbuild.html">$backupbuild</a> &gt; 20150618 &amp;&amp; (<a class="var it10723" onMouseOver="hilite(10723)" onMouseOut="lolite()" onClick="logVariable('backuprelease')" href="../../_variables/backuprelease.html">$backuprelease</a> &lt; 3.0 || <a class="var it15347" onMouseOver="hilite(15347)" onMouseOut="lolite()" onClick="logVariable('backupbuild')" href="../../_variables/backupbuild.html">$backupbuild</a> &lt; 20160527)) {
<a name="l136"><span class="linenum"> 136</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('rewrite_step_backup_file_for_legacy_freeze')" href="../../_functions/rewrite_step_backup_file_for_legacy_freeze.html" onMouseOver="funcPopup(event,'rewrite_step_backup_file_for_legacy_freeze')">rewrite_step_backup_file_for_legacy_freeze</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>);
<a name="l137"><span class="linenum"> 137</span></a>          }
<a name="l138"><span class="linenum"> 138</span></a>  
<a name="l139"><span class="linenum"> 139</span></a>  <span class="comment">        // Arrived here, execute the step</span>
<a name="l140"><span class="linenum"> 140</span></a>          return true;
<a name="l141"><span class="linenum"> 141</span></a>       }
<a name="l142"><span class="linenum"> 142</span></a>  
<a name="l143"><span class="linenum"> 143</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l144"><span class="linenum"> 144</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array();
<a name="l145"><span class="linenum"> 145</span></a>          <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('userinfo')" href="../../_variables/userinfo.html">$userinfo</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('users');
<a name="l146"><span class="linenum"> 146</span></a>  
<a name="l147"><span class="linenum"> 147</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('attributes', '/gradebook/attributes');
<a name="l148"><span class="linenum"> 148</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('grade_category', '/gradebook/grade_categories/grade_category');
<a name="l149"><span class="linenum"> 149</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('grade_item', '/gradebook/grade_items/grade_item');
<a name="l150"><span class="linenum"> 150</span></a>          if (<a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('userinfo')" href="../../_variables/userinfo.html">$userinfo</a>) {
<a name="l151"><span class="linenum"> 151</span></a>              <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('grade_grade', '/gradebook/grade_items/grade_item/grade_grades/grade_grade');
<a name="l152"><span class="linenum"> 152</span></a>          }
<a name="l153"><span class="linenum"> 153</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('grade_letter', '/gradebook/grade_letters/grade_letter');
<a name="l154"><span class="linenum"> 154</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('grade_setting', '/gradebook/grade_settings/grade_setting');
<a name="l155"><span class="linenum"> 155</span></a>  
<a name="l156"><span class="linenum"> 156</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l157"><span class="linenum"> 157</span></a>      }
<a name="l158"><span class="linenum"> 158</span></a>  
<a name="l159"><span class="linenum"> 159</span></a>      protected function <a class="function" onClick="logFunction('process_attributes')" href="../../_functions/process_attributes.html" onMouseOver="funcPopup(event,'process_attributes')">process_attributes</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l160"><span class="linenum"> 160</span></a>  <span class="comment">        // For non-merge restore types:</span>
<a name="l161"><span class="linenum"> 161</span></a>  <span class="comment">        // Unset 'gradebook_calculations_freeze_' in the course and replace with the one from the backup.</span>
<a name="l162"><span class="linenum"> 162</span></a>          <a class="var it713" onMouseOver="hilite(713)" onMouseOut="lolite()" onClick="logVariable('target')" href="../../_variables/target.html">$target</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_task')" href="../../_functions/get_task.html" onMouseOver="funcPopup(event,'get_task')">get_task</a>()-&gt;<a class="function" onClick="logFunction('get_target')" href="../../_functions/get_target.html" onMouseOver="funcPopup(event,'get_target')">get_target</a>();
<a name="l163"><span class="linenum"> 163</span></a>          if (<a class="var it713" onMouseOver="hilite(713)" onMouseOut="lolite()" onClick="logVariable('target')" href="../../_variables/target.html">$target</a> == backup::TARGET_CURRENT_DELETING || <a class="var it713" onMouseOver="hilite(713)" onMouseOut="lolite()" onClick="logVariable('target')" href="../../_variables/target.html">$target</a> == backup::TARGET_EXISTING_DELETING) {
<a name="l164"><span class="linenum"> 164</span></a>              <a class="function" onClick="logFunction('set_config')" href="../../_functions/set_config.html" onMouseOver="funcPopup(event,'set_config')">set_config</a>('gradebook_calculations_freeze_' . <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(), null);
<a name="l165"><span class="linenum"> 165</span></a>          }
<a name="l166"><span class="linenum"> 166</span></a>          if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>['calculations_freeze'])) {
<a name="l167"><span class="linenum"> 167</span></a>              if (<a class="var it713" onMouseOver="hilite(713)" onMouseOut="lolite()" onClick="logVariable('target')" href="../../_variables/target.html">$target</a> == backup::TARGET_NEW_COURSE || <a class="var it713" onMouseOver="hilite(713)" onMouseOut="lolite()" onClick="logVariable('target')" href="../../_variables/target.html">$target</a> == backup::TARGET_CURRENT_DELETING ||
<a name="l168"><span class="linenum"> 168</span></a>                      <a class="var it713" onMouseOver="hilite(713)" onMouseOut="lolite()" onClick="logVariable('target')" href="../../_variables/target.html">$target</a> == backup::TARGET_EXISTING_DELETING) {
<a name="l169"><span class="linenum"> 169</span></a>                  <a class="function" onClick="logFunction('set_config')" href="../../_functions/set_config.html" onMouseOver="funcPopup(event,'set_config')">set_config</a>('gradebook_calculations_freeze_' . <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(), <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>['calculations_freeze']);
<a name="l170"><span class="linenum"> 170</span></a>              }
<a name="l171"><span class="linenum"> 171</span></a>          }
<a name="l172"><span class="linenum"> 172</span></a>      }
<a name="l173"><span class="linenum"> 173</span></a>  
<a name="l174"><span class="linenum"> 174</span></a>      protected function <a class="function" onClick="logFunction('process_grade_item')" href="../../_functions/process_grade_item.html" onMouseOver="funcPopup(event,'process_grade_item')">process_grade_item</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l175"><span class="linenum"> 175</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l176"><span class="linenum"> 176</span></a>  
<a name="l177"><span class="linenum"> 177</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l178"><span class="linenum"> 178</span></a>  
<a name="l179"><span class="linenum"> 179</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l180"><span class="linenum"> 180</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('course')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/course.html">course</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l181"><span class="linenum"> 181</span></a>  
<a name="l182"><span class="linenum"> 182</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l183"><span class="linenum"> 183</span></a>  
<a name="l184"><span class="linenum"> 184</span></a>          if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemtype.html">itemtype</a>=='manual') {
<a name="l185"><span class="linenum"> 185</span></a>  <span class="comment">            // manual grade items store category id in categoryid</span>
<a name="l186"><span class="linenum"> 186</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('categoryid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/categoryid.html">categoryid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('grade_category', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('categoryid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/categoryid.html">categoryid</a>, NULL);
<a name="l187"><span class="linenum"> 187</span></a>  <span class="comment">            // if mapping failed put in course's grade category</span>
<a name="l188"><span class="linenum"> 188</span></a>              if (NULL == <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('categoryid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/categoryid.html">categoryid</a>) {
<a name="l189"><span class="linenum"> 189</span></a>                  <a class="var it15348" onMouseOver="hilite(15348)" onMouseOut="lolite()" onClick="logVariable('coursecat')" href="../../_variables/coursecat.html">$coursecat</a> = <a class="class" onClick="logClass('grade_category')" href="../../_classes/grade_category.html" onMouseOver="classPopup(event,'grade_category')">grade_category</a>::<a class="function" onClick="logFunction('fetch_course_category')" href="../../_functions/fetch_course_category.html" onMouseOver="funcPopup(event,'fetch_course_category')">fetch_course_category</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>());
<a name="l190"><span class="linenum"> 190</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('categoryid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/categoryid.html">categoryid</a> = <a class="var it15348" onMouseOver="hilite(15348)" onMouseOut="lolite()" onClick="logVariable('coursecat')" href="../../_variables/coursecat.html">$coursecat</a>-&gt;<a onClick="logVariable('id')" class="var it43720" onMouseOver="hilite(43720)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l191"><span class="linenum"> 191</span></a>              }
<a name="l192"><span class="linenum"> 192</span></a>          } else if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemtype.html">itemtype</a>=='course') {
<a name="l193"><span class="linenum"> 193</span></a>  <span class="comment">            // course grade item stores their category id in iteminstance</span>
<a name="l194"><span class="linenum"> 194</span></a>              <a class="var it15348" onMouseOver="hilite(15348)" onMouseOut="lolite()" onClick="logVariable('coursecat')" href="../../_variables/coursecat.html">$coursecat</a> = <a class="class" onClick="logClass('grade_category')" href="../../_classes/grade_category.html" onMouseOver="classPopup(event,'grade_category')">grade_category</a>::<a class="function" onClick="logFunction('fetch_course_category')" href="../../_functions/fetch_course_category.html" onMouseOver="funcPopup(event,'fetch_course_category')">fetch_course_category</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>());
<a name="l195"><span class="linenum"> 195</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('iteminstance')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/iteminstance.html">iteminstance</a> = <a class="var it15348" onMouseOver="hilite(15348)" onMouseOut="lolite()" onClick="logVariable('coursecat')" href="../../_variables/coursecat.html">$coursecat</a>-&gt;<a onClick="logVariable('id')" class="var it43720" onMouseOver="hilite(43720)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l196"><span class="linenum"> 196</span></a>          } else if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemtype.html">itemtype</a>=='category') {
<a name="l197"><span class="linenum"> 197</span></a>  <span class="comment">            // category grade items store their category id in iteminstance</span>
<a name="l198"><span class="linenum"> 198</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('iteminstance')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/iteminstance.html">iteminstance</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('grade_category', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('iteminstance')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/iteminstance.html">iteminstance</a>, NULL);
<a name="l199"><span class="linenum"> 199</span></a>          } else {
<a name="l200"><span class="linenum"> 200</span></a>              throw <span class="keyword">new </span><a class="class" onClick="logClass('restore_step_exception')" href="../../_classes/restore_step_exception.html" onMouseOver="classPopup(event,'restore_step_exception')">restore_step_exception</a>('unexpected_grade_item_type', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemtype.html">itemtype</a>);
<a name="l201"><span class="linenum"> 201</span></a>          }
<a name="l202"><span class="linenum"> 202</span></a>  
<a name="l203"><span class="linenum"> 203</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('scaleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/scaleid.html">scaleid</a>   = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('scale', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('scaleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/scaleid.html">scaleid</a>, NULL);
<a name="l204"><span class="linenum"> 204</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('outcomeid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/outcomeid.html">outcomeid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('outcome', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('outcomeid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/outcomeid.html">outcomeid</a>, NULL);
<a name="l205"><span class="linenum"> 205</span></a>  
<a name="l206"><span class="linenum"> 206</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('locktime')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/locktime.html">locktime</a>     = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('locktime')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/locktime.html">locktime</a>);
<a name="l207"><span class="linenum"> 207</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timecreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timecreated.html">timecreated</a>  = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timecreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timecreated.html">timecreated</a>);
<a name="l208"><span class="linenum"> 208</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timemodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timemodified.html">timemodified</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timemodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timemodified.html">timemodified</a>);
<a name="l209"><span class="linenum"> 209</span></a>  
<a name="l210"><span class="linenum"> 210</span></a>          <a class="var it15349" onMouseOver="hilite(15349)" onMouseOut="lolite()" onClick="logVariable('coursecategory')" href="../../_variables/coursecategory.html">$coursecategory</a> = <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = null;
<a name="l211"><span class="linenum"> 211</span></a>  <span class="comment">        //course grade item should already exist so updating instead of inserting</span>
<a name="l212"><span class="linenum"> 212</span></a>          if(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemtype.html">itemtype</a>=='course') {
<a name="l213"><span class="linenum"> 213</span></a>  <span class="comment">            //get the ID of the already created grade item</span>
<a name="l214"><span class="linenum"> 214</span></a>              <a class="var it4755" onMouseOver="hilite(4755)" onMouseOut="lolite()" onClick="logVariable('gi')" href="../../_variables/gi.html">$gi</a> = new stdclass();
<a name="l215"><span class="linenum"> 215</span></a>              <a class="var it4755" onMouseOver="hilite(4755)" onMouseOut="lolite()" onClick="logVariable('gi')" href="../../_variables/gi.html">$gi</a>-&gt;<a onClick="logVariable('courseid')" class="var it43457" onMouseOver="hilite(43457)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a>  = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l216"><span class="linenum"> 216</span></a>              <a class="var it4755" onMouseOver="hilite(4755)" onMouseOut="lolite()" onClick="logVariable('gi')" href="../../_variables/gi.html">$gi</a>-&gt;<a onClick="logVariable('itemtype')" class="var it43457" onMouseOver="hilite(43457)" onMouseOut="lolite()" href="../../_variables/itemtype.html">itemtype</a>  = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemtype.html">itemtype</a>;
<a name="l217"><span class="linenum"> 217</span></a>  
<a name="l218"><span class="linenum"> 218</span></a>  <span class="comment">            //need to get the id of the grade_category that was automatically created for the course</span>
<a name="l219"><span class="linenum"> 219</span></a>              <a class="var it261" onMouseOver="hilite(261)" onMouseOut="lolite()" onClick="logVariable('category')" href="../../_variables/category.html">$category</a> = new stdclass();
<a name="l220"><span class="linenum"> 220</span></a>              <a class="var it261" onMouseOver="hilite(261)" onMouseOut="lolite()" onClick="logVariable('category')" href="../../_variables/category.html">$category</a>-&gt;<a onClick="logVariable('courseid')" class="var it42970" onMouseOver="hilite(42970)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a>  = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l221"><span class="linenum"> 221</span></a>              <a class="var it261" onMouseOver="hilite(261)" onMouseOut="lolite()" onClick="logVariable('category')" href="../../_variables/category.html">$category</a>-&gt;<a onClick="logVariable('parent')" class="var it42970" onMouseOver="hilite(42970)" onMouseOut="lolite()" href="../../_variables/parent.html">parent</a>  = null;
<a name="l222"><span class="linenum"> 222</span></a>  <span class="comment">            //course category fullname starts out as ? but may be edited</span>
<a name="l223"><span class="linenum"> 223</span></a>  <span class="comment">            //$category-&gt;fullname  = '?';</span>
<a name="l224"><span class="linenum"> 224</span></a>              <a class="var it15349" onMouseOver="hilite(15349)" onMouseOut="lolite()" onClick="logVariable('coursecategory')" href="../../_variables/coursecategory.html">$coursecategory</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('grade_categories', (array)<a class="var it261" onMouseOver="hilite(261)" onMouseOut="lolite()" onClick="logVariable('category')" href="../../_variables/category.html">$category</a>);
<a name="l225"><span class="linenum"> 225</span></a>              <a class="var it4755" onMouseOver="hilite(4755)" onMouseOut="lolite()" onClick="logVariable('gi')" href="../../_variables/gi.html">$gi</a>-&gt;<a onClick="logVariable('iteminstance')" class="var it43457" onMouseOver="hilite(43457)" onMouseOut="lolite()" href="../../_variables/iteminstance.html">iteminstance</a> = <a class="var it15349" onMouseOver="hilite(15349)" onMouseOut="lolite()" onClick="logVariable('coursecategory')" href="../../_variables/coursecategory.html">$coursecategory</a>-&gt;<a onClick="logVariable('id')" class="var it43065" onMouseOver="hilite(43065)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l226"><span class="linenum"> 226</span></a>  
<a name="l227"><span class="linenum"> 227</span></a>              <a class="var it15350" onMouseOver="hilite(15350)" onMouseOut="lolite()" onClick="logVariable('existinggradeitem')" href="../../_variables/existinggradeitem.html">$existinggradeitem</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('grade_items', (array)<a class="var it4755" onMouseOver="hilite(4755)" onMouseOut="lolite()" onClick="logVariable('gi')" href="../../_variables/gi.html">$gi</a>);
<a name="l228"><span class="linenum"> 228</span></a>              if (!empty(<a class="var it15350" onMouseOver="hilite(15350)" onMouseOut="lolite()" onClick="logVariable('existinggradeitem')" href="../../_variables/existinggradeitem.html">$existinggradeitem</a>)) {
<a name="l229"><span class="linenum"> 229</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a> = <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it15350" onMouseOver="hilite(15350)" onMouseOut="lolite()" onClick="logVariable('existinggradeitem')" href="../../_variables/existinggradeitem.html">$existinggradeitem</a>-&gt;<a onClick="logVariable('id')" class="var it45283" onMouseOver="hilite(45283)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l230"><span class="linenum"> 230</span></a>                  <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('update_record')" href="../../_functions/update_record.html" onMouseOver="funcPopup(event,'update_record')">update_record</a>('grade_items', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l231"><span class="linenum"> 231</span></a>              }
<a name="l232"><span class="linenum"> 232</span></a>          } else if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemtype.html">itemtype</a> == 'manual') {
<a name="l233"><span class="linenum"> 233</span></a>  <span class="comment">            // Manual items aren't assigned to a cm, so don't go duplicating them in the target if one exists.</span>
<a name="l234"><span class="linenum"> 234</span></a>              <a class="var it4755" onMouseOver="hilite(4755)" onMouseOut="lolite()" onClick="logVariable('gi')" href="../../_variables/gi.html">$gi</a> = array(
<a name="l235"><span class="linenum"> 235</span></a>                  'itemtype' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemtype.html">itemtype</a>,
<a name="l236"><span class="linenum"> 236</span></a>                  'courseid' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a>,
<a name="l237"><span class="linenum"> 237</span></a>                  'itemname' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemname')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemname.html">itemname</a>,
<a name="l238"><span class="linenum"> 238</span></a>                  'categoryid' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('categoryid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/categoryid.html">categoryid</a>,
<a name="l239"><span class="linenum"> 239</span></a>              );
<a name="l240"><span class="linenum"> 240</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('grade_items', 'id', <a class="var it4755" onMouseOver="hilite(4755)" onMouseOut="lolite()" onClick="logVariable('gi')" href="../../_variables/gi.html">$gi</a>);
<a name="l241"><span class="linenum"> 241</span></a>          }
<a name="l242"><span class="linenum"> 242</span></a>  
<a name="l243"><span class="linenum"> 243</span></a>          if (empty(<a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>)) {
<a name="l244"><span class="linenum"> 244</span></a>  <span class="comment">            //in case we found the course category but still need to insert the course grade item</span>
<a name="l245"><span class="linenum"> 245</span></a>              if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemtype.html">itemtype</a>=='course' &amp;&amp; !empty(<a class="var it15349" onMouseOver="hilite(15349)" onMouseOut="lolite()" onClick="logVariable('coursecategory')" href="../../_variables/coursecategory.html">$coursecategory</a>)) {
<a name="l246"><span class="linenum"> 246</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('iteminstance')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/iteminstance.html">iteminstance</a> = <a class="var it15349" onMouseOver="hilite(15349)" onMouseOut="lolite()" onClick="logVariable('coursecategory')" href="../../_variables/coursecategory.html">$coursecategory</a>-&gt;<a onClick="logVariable('id')" class="var it43065" onMouseOver="hilite(43065)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l247"><span class="linenum"> 247</span></a>              }
<a name="l248"><span class="linenum"> 248</span></a>  
<a name="l249"><span class="linenum"> 249</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('grade_items', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l250"><span class="linenum"> 250</span></a>          }
<a name="l251"><span class="linenum"> 251</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('grade_item', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>);
<a name="l252"><span class="linenum"> 252</span></a>      }
<a name="l253"><span class="linenum"> 253</span></a>  
<a name="l254"><span class="linenum"> 254</span></a>      protected function <a class="function" onClick="logFunction('process_grade_grade')" href="../../_functions/process_grade_grade.html" onMouseOver="funcPopup(event,'process_grade_grade')">process_grade_grade</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l255"><span class="linenum"> 255</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l256"><span class="linenum"> 256</span></a>  
<a name="l257"><span class="linenum"> 257</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l258"><span class="linenum"> 258</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l259"><span class="linenum"> 259</span></a>          <a class="var it15351" onMouseOver="hilite(15351)" onMouseOut="lolite()" onClick="logVariable('olduserid')" href="../../_variables/olduserid.html">$olduserid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>;
<a name="l260"><span class="linenum"> 260</span></a>  
<a name="l261"><span class="linenum"> 261</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_new_parentid')" href="../../_functions/get_new_parentid.html" onMouseOver="funcPopup(event,'get_new_parentid')">get_new_parentid</a>('grade_item');
<a name="l262"><span class="linenum"> 262</span></a>  
<a name="l263"><span class="linenum"> 263</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>, null);
<a name="l264"><span class="linenum"> 264</span></a>          if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>)) {
<a name="l265"><span class="linenum"> 265</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usermodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usermodified.html">usermodified</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usermodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usermodified.html">usermodified</a>, null);
<a name="l266"><span class="linenum"> 266</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('locktime')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/locktime.html">locktime</a>     = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('locktime')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/locktime.html">locktime</a>);
<a name="l267"><span class="linenum"> 267</span></a>  <span class="comment">            // TODO: Ask, all the rest of locktime/exported... work with time... to be rolled?</span>
<a name="l268"><span class="linenum"> 268</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('overridden')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/overridden.html">overridden</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('overridden')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/overridden.html">overridden</a>);
<a name="l269"><span class="linenum"> 269</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timecreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timecreated.html">timecreated</a>  = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timecreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timecreated.html">timecreated</a>);
<a name="l270"><span class="linenum"> 270</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timemodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timemodified.html">timemodified</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timemodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timemodified.html">timemodified</a>);
<a name="l271"><span class="linenum"> 271</span></a>  
<a name="l272"><span class="linenum"> 272</span></a>              <a class="var it15352" onMouseOver="hilite(15352)" onMouseOut="lolite()" onClick="logVariable('gradeexists')" href="../../_variables/gradeexists.html">$gradeexists</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists')" href="../../_functions/record_exists.html" onMouseOver="funcPopup(event,'record_exists')">record_exists</a>('grade_grades', array('userid' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>, 'itemid' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>));
<a name="l273"><span class="linenum"> 273</span></a>              if (<a class="var it15352" onMouseOver="hilite(15352)" onMouseOut="lolite()" onClick="logVariable('gradeexists')" href="../../_variables/gradeexists.html">$gradeexists</a>) {
<a name="l274"><span class="linenum"> 274</span></a>                  <a class="var it276" onMouseOver="hilite(276)" onMouseOut="lolite()" onClick="logVariable('message')" href="../../_variables/message.html">$message</a> = &quot;User id '{<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>}' already has a grade entry for grade item id '{<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>}'&quot;;
<a name="l275"><span class="linenum"> 275</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="phpfunction" onClick="logFunction('log')" href="../../_functions/log.html" onMouseOver="phpfuncPopup(event,'log')">log</a>(<a class="var it276" onMouseOver="hilite(276)" onMouseOut="lolite()" onClick="logVariable('message')" href="../../_variables/message.html">$message</a>, backup::LOG_DEBUG);
<a name="l276"><span class="linenum"> 276</span></a>              } else {
<a name="l277"><span class="linenum"> 277</span></a>                  <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('grade_grades', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l278"><span class="linenum"> 278</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('grade_grades', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>);
<a name="l279"><span class="linenum"> 279</span></a>              }
<a name="l280"><span class="linenum"> 280</span></a>          } else {
<a name="l281"><span class="linenum"> 281</span></a>              <a class="var it276" onMouseOver="hilite(276)" onMouseOut="lolite()" onClick="logVariable('message')" href="../../_variables/message.html">$message</a> = &quot;Mapped user id not found for user id '{<a class="var it15351" onMouseOver="hilite(15351)" onMouseOut="lolite()" onClick="logVariable('olduserid')" href="../../_variables/olduserid.html">$olduserid</a>}', grade item id '{<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>}'&quot;;
<a name="l282"><span class="linenum"> 282</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="phpfunction" onClick="logFunction('log')" href="../../_functions/log.html" onMouseOver="phpfuncPopup(event,'log')">log</a>(<a class="var it276" onMouseOver="hilite(276)" onMouseOut="lolite()" onClick="logVariable('message')" href="../../_variables/message.html">$message</a>, backup::LOG_DEBUG);
<a name="l283"><span class="linenum"> 283</span></a>          }
<a name="l284"><span class="linenum"> 284</span></a>      }
<a name="l285"><span class="linenum"> 285</span></a>  
<a name="l286"><span class="linenum"> 286</span></a>      protected function <a class="function" onClick="logFunction('process_grade_category')" href="../../_functions/process_grade_category.html" onMouseOver="funcPopup(event,'process_grade_category')">process_grade_category</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l287"><span class="linenum"> 287</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l288"><span class="linenum"> 288</span></a>  
<a name="l289"><span class="linenum"> 289</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l290"><span class="linenum"> 290</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l291"><span class="linenum"> 291</span></a>  
<a name="l292"><span class="linenum"> 292</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('course')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/course.html">course</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l293"><span class="linenum"> 293</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('course')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/course.html">course</a>;
<a name="l294"><span class="linenum"> 294</span></a>  
<a name="l295"><span class="linenum"> 295</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timecreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timecreated.html">timecreated</a>  = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timecreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timecreated.html">timecreated</a>);
<a name="l296"><span class="linenum"> 296</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timemodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timemodified.html">timemodified</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timemodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timemodified.html">timemodified</a>);
<a name="l297"><span class="linenum"> 297</span></a>  
<a name="l298"><span class="linenum"> 298</span></a>          <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = null;
<a name="l299"><span class="linenum"> 299</span></a>  <span class="comment">        //no parent means a course level grade category. That may have been created when the course was created</span>
<a name="l300"><span class="linenum"> 300</span></a>          if(empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('parent')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/parent.html">parent</a>)) {
<a name="l301"><span class="linenum"> 301</span></a>  <span class="comment">            //parent was being saved as 0 when it should be null</span>
<a name="l302"><span class="linenum"> 302</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('parent')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/parent.html">parent</a> = null;
<a name="l303"><span class="linenum"> 303</span></a>  
<a name="l304"><span class="linenum"> 304</span></a>  <span class="comment">            //get the already created course level grade category</span>
<a name="l305"><span class="linenum"> 305</span></a>              <a class="var it261" onMouseOver="hilite(261)" onMouseOut="lolite()" onClick="logVariable('category')" href="../../_variables/category.html">$category</a> = new stdclass();
<a name="l306"><span class="linenum"> 306</span></a>              <a class="var it261" onMouseOver="hilite(261)" onMouseOut="lolite()" onClick="logVariable('category')" href="../../_variables/category.html">$category</a>-&gt;<a onClick="logVariable('courseid')" class="var it42970" onMouseOver="hilite(42970)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l307"><span class="linenum"> 307</span></a>              <a class="var it261" onMouseOver="hilite(261)" onMouseOut="lolite()" onClick="logVariable('category')" href="../../_variables/category.html">$category</a>-&gt;<a onClick="logVariable('parent')" class="var it42970" onMouseOver="hilite(42970)" onMouseOut="lolite()" href="../../_variables/parent.html">parent</a> = null;
<a name="l308"><span class="linenum"> 308</span></a>  
<a name="l309"><span class="linenum"> 309</span></a>              <a class="var it15349" onMouseOver="hilite(15349)" onMouseOut="lolite()" onClick="logVariable('coursecategory')" href="../../_variables/coursecategory.html">$coursecategory</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('grade_categories', (array)<a class="var it261" onMouseOver="hilite(261)" onMouseOut="lolite()" onClick="logVariable('category')" href="../../_variables/category.html">$category</a>);
<a name="l310"><span class="linenum"> 310</span></a>              if (!empty(<a class="var it15349" onMouseOver="hilite(15349)" onMouseOut="lolite()" onClick="logVariable('coursecategory')" href="../../_variables/coursecategory.html">$coursecategory</a>)) {
<a name="l311"><span class="linenum"> 311</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a> = <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it15349" onMouseOver="hilite(15349)" onMouseOut="lolite()" onClick="logVariable('coursecategory')" href="../../_variables/coursecategory.html">$coursecategory</a>-&gt;<a onClick="logVariable('id')" class="var it43065" onMouseOver="hilite(43065)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l312"><span class="linenum"> 312</span></a>                  <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('update_record')" href="../../_functions/update_record.html" onMouseOver="funcPopup(event,'update_record')">update_record</a>('grade_categories', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l313"><span class="linenum"> 313</span></a>              }
<a name="l314"><span class="linenum"> 314</span></a>          }
<a name="l315"><span class="linenum"> 315</span></a>  
<a name="l316"><span class="linenum"> 316</span></a>  <span class="comment">        // Add a warning about a removed setting.</span>
<a name="l317"><span class="linenum"> 317</span></a>          if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('aggregatesubcats')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/aggregatesubcats.html">aggregatesubcats</a>)) {
<a name="l318"><span class="linenum"> 318</span></a>              <a class="function" onClick="logFunction('set_config')" href="../../_functions/set_config.html" onMouseOver="funcPopup(event,'set_config')">set_config</a>('show_aggregatesubcats_upgrade_' . <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a>, 1);
<a name="l319"><span class="linenum"> 319</span></a>          }
<a name="l320"><span class="linenum"> 320</span></a>  
<a name="l321"><span class="linenum"> 321</span></a>  <span class="comment">        //need to insert a course category</span>
<a name="l322"><span class="linenum"> 322</span></a>          if (empty(<a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>)) {
<a name="l323"><span class="linenum"> 323</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('grade_categories', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l324"><span class="linenum"> 324</span></a>          }
<a name="l325"><span class="linenum"> 325</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('grade_category', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>);
<a name="l326"><span class="linenum"> 326</span></a>      }
<a name="l327"><span class="linenum"> 327</span></a>      protected function <a class="function" onClick="logFunction('process_grade_letter')" href="../../_functions/process_grade_letter.html" onMouseOver="funcPopup(event,'process_grade_letter')">process_grade_letter</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l328"><span class="linenum"> 328</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l329"><span class="linenum"> 329</span></a>  
<a name="l330"><span class="linenum"> 330</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l331"><span class="linenum"> 331</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l332"><span class="linenum"> 332</span></a>  
<a name="l333"><span class="linenum"> 333</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('contextid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a> = <a class="class" onClick="logClass('context_course')" href="../../_classes/context_course.html" onMouseOver="classPopup(event,'context_course')">context_course</a>::<a class="function" onClick="logFunction('instance')" href="../../_functions/instance.html" onMouseOver="funcPopup(event,'instance')">instance</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>())-&gt;id;
<a name="l334"><span class="linenum"> 334</span></a>  
<a name="l335"><span class="linenum"> 335</span></a>          <a class="var it15354" onMouseOver="hilite(15354)" onMouseOut="lolite()" onClick="logVariable('gradeletter')" href="../../_variables/gradeletter.html">$gradeletter</a> = (array)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l336"><span class="linenum"> 336</span></a>          unset(<a class="var it15354" onMouseOver="hilite(15354)" onMouseOut="lolite()" onClick="logVariable('gradeletter')" href="../../_variables/gradeletter.html">$gradeletter</a>['id']);
<a name="l337"><span class="linenum"> 337</span></a>          if (!<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists')" href="../../_functions/record_exists.html" onMouseOver="funcPopup(event,'record_exists')">record_exists</a>('grade_letters', <a class="var it15354" onMouseOver="hilite(15354)" onMouseOut="lolite()" onClick="logVariable('gradeletter')" href="../../_variables/gradeletter.html">$gradeletter</a>)) {
<a name="l338"><span class="linenum"> 338</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('grade_letters', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l339"><span class="linenum"> 339</span></a>          } else {
<a name="l340"><span class="linenum"> 340</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l341"><span class="linenum"> 341</span></a>          }
<a name="l342"><span class="linenum"> 342</span></a>  
<a name="l343"><span class="linenum"> 343</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('grade_letter', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>);
<a name="l344"><span class="linenum"> 344</span></a>      }
<a name="l345"><span class="linenum"> 345</span></a>      protected function <a class="function" onClick="logFunction('process_grade_setting')" href="../../_functions/process_grade_setting.html" onMouseOver="funcPopup(event,'process_grade_setting')">process_grade_setting</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l346"><span class="linenum"> 346</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l347"><span class="linenum"> 347</span></a>  
<a name="l348"><span class="linenum"> 348</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l349"><span class="linenum"> 349</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l350"><span class="linenum"> 350</span></a>  
<a name="l351"><span class="linenum"> 351</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l352"><span class="linenum"> 352</span></a>  
<a name="l353"><span class="linenum"> 353</span></a>          <a class="var it713" onMouseOver="hilite(713)" onMouseOut="lolite()" onClick="logVariable('target')" href="../../_variables/target.html">$target</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_task')" href="../../_functions/get_task.html" onMouseOver="funcPopup(event,'get_task')">get_task</a>()-&gt;<a class="function" onClick="logFunction('get_target')" href="../../_functions/get_target.html" onMouseOver="funcPopup(event,'get_target')">get_target</a>();
<a name="l354"><span class="linenum"> 354</span></a>          if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('name')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/name.html">name</a> == 'minmaxtouse' &amp;&amp;
<a name="l355"><span class="linenum"> 355</span></a>                  (<a class="var it713" onMouseOver="hilite(713)" onMouseOut="lolite()" onClick="logVariable('target')" href="../../_variables/target.html">$target</a> == backup::TARGET_CURRENT_ADDING || <a class="var it713" onMouseOver="hilite(713)" onMouseOut="lolite()" onClick="logVariable('target')" href="../../_variables/target.html">$target</a> == backup::TARGET_EXISTING_ADDING)) {
<a name="l356"><span class="linenum"> 356</span></a>  <span class="comment">            // We never restore minmaxtouse during merge.</span>
<a name="l357"><span class="linenum"> 357</span></a>              return;
<a name="l358"><span class="linenum"> 358</span></a>          }
<a name="l359"><span class="linenum"> 359</span></a>  
<a name="l360"><span class="linenum"> 360</span></a>          if (!<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists')" href="../../_functions/record_exists.html" onMouseOver="funcPopup(event,'record_exists')">record_exists</a>('grade_settings', array('courseid' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a>, 'name' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('name')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/name.html">name</a>))) {
<a name="l361"><span class="linenum"> 361</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('grade_settings', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l362"><span class="linenum"> 362</span></a>          } else {
<a name="l363"><span class="linenum"> 363</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l364"><span class="linenum"> 364</span></a>          }
<a name="l365"><span class="linenum"> 365</span></a>  
<a name="l366"><span class="linenum"> 366</span></a>          if (!empty(<a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>)) {
<a name="l367"><span class="linenum"> 367</span></a>  <span class="comment">            // In rare cases (minmaxtouse), it is possible that there wasn't any ID associated with the setting.</span>
<a name="l368"><span class="linenum"> 368</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('grade_setting', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>);
<a name="l369"><span class="linenum"> 369</span></a>          }
<a name="l370"><span class="linenum"> 370</span></a>      }
<a name="l371"><span class="linenum"> 371</span></a>  
<a name="l372"><span class="linenum"> 372</span></a>      <span class="comment">/**</span>
<a name="l373"><span class="linenum"> 373</span></a>  <span class="comment">     * put all activity grade items in the correct grade category and mark all for recalculation</span>
<a name="l374"><span class="linenum"> 374</span></a>  <span class="comment">     */</span>
<a name="l375"><span class="linenum"> 375</span></a>      protected function <a class="function" onClick="logFunction('after_execute')" href="../../_functions/after_execute.html" onMouseOver="funcPopup(event,'after_execute')">after_execute</a>() {
<a name="l376"><span class="linenum"> 376</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l377"><span class="linenum"> 377</span></a>  
<a name="l378"><span class="linenum"> 378</span></a>          <a class="var it1217" onMouseOver="hilite(1217)" onMouseOut="lolite()" onClick="logVariable('conditions')" href="../../_variables/conditions.html">$conditions</a> = array(
<a name="l379"><span class="linenum"> 379</span></a>              'backupid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(),
<a name="l380"><span class="linenum"> 380</span></a>              'itemname' =&gt; 'grade_item'//,
<a name="l381"><span class="linenum"> 381</span></a>  <span class="comment">            //'itemid'   =&gt; $itemid</span>
<a name="l382"><span class="linenum"> 382</span></a>          );
<a name="l383"><span class="linenum"> 383</span></a>          <a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_recordset')" href="../../_functions/get_recordset.html" onMouseOver="funcPopup(event,'get_recordset')">get_recordset</a>('backup_ids_temp', <a class="var it1217" onMouseOver="hilite(1217)" onMouseOut="lolite()" onClick="logVariable('conditions')" href="../../_variables/conditions.html">$conditions</a>);
<a name="l384"><span class="linenum"> 384</span></a>  
<a name="l385"><span class="linenum"> 385</span></a>  <span class="comment">        // We need this for calculation magic later on.</span>
<a name="l386"><span class="linenum"> 386</span></a>          <a class="var it672" onMouseOver="hilite(672)" onMouseOut="lolite()" onClick="logVariable('mappings')" href="../../_variables/mappings.html">$mappings</a> = array();
<a name="l387"><span class="linenum"> 387</span></a>  
<a name="l388"><span class="linenum"> 388</span></a>          if (!empty(<a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a>)) {
<a name="l389"><span class="linenum"> 389</span></a>              foreach(<a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a> as <a class="var it15355" onMouseOver="hilite(15355)" onMouseOut="lolite()" onClick="logVariable('grade_item_backup')" href="../../_variables/grade_item_backup.html">$grade_item_backup</a>) {
<a name="l390"><span class="linenum"> 390</span></a>  
<a name="l391"><span class="linenum"> 391</span></a>  <span class="comment">                // Store the oldid with the new id.</span>
<a name="l392"><span class="linenum"> 392</span></a>                  <a class="var it672" onMouseOver="hilite(672)" onMouseOut="lolite()" onClick="logVariable('mappings')" href="../../_variables/mappings.html">$mappings</a>[<a class="var it15355" onMouseOver="hilite(15355)" onMouseOut="lolite()" onClick="logVariable('grade_item_backup')" href="../../_variables/grade_item_backup.html">$grade_item_backup</a>-&gt;<a onClick="logVariable('itemid')" class="var it45284" onMouseOver="hilite(45284)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>] = <a class="var it15355" onMouseOver="hilite(15355)" onMouseOut="lolite()" onClick="logVariable('grade_item_backup')" href="../../_variables/grade_item_backup.html">$grade_item_backup</a>-&gt;<a onClick="logVariable('newitemid')" class="var it45284" onMouseOver="hilite(45284)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>;
<a name="l393"><span class="linenum"> 393</span></a>  
<a name="l394"><span class="linenum"> 394</span></a>                  <a class="var it15356" onMouseOver="hilite(15356)" onMouseOut="lolite()" onClick="logVariable('updateobj')" href="../../_variables/updateobj.html">$updateobj</a> = new stdclass();
<a name="l395"><span class="linenum"> 395</span></a>                  <a class="var it15356" onMouseOver="hilite(15356)" onMouseOut="lolite()" onClick="logVariable('updateobj')" href="../../_variables/updateobj.html">$updateobj</a>-&gt;<a onClick="logVariable('id')" class="var it45285" onMouseOver="hilite(45285)" onMouseOut="lolite()" href="../../_variables/id.html">id</a> = <a class="var it15355" onMouseOver="hilite(15355)" onMouseOut="lolite()" onClick="logVariable('grade_item_backup')" href="../../_variables/grade_item_backup.html">$grade_item_backup</a>-&gt;<a onClick="logVariable('newitemid')" class="var it45284" onMouseOver="hilite(45284)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>;
<a name="l396"><span class="linenum"> 396</span></a>  
<a name="l397"><span class="linenum"> 397</span></a>  <span class="comment">                //if this is an activity grade item that needs to be put back in its correct category</span>
<a name="l398"><span class="linenum"> 398</span></a>                  if (!empty(<a class="var it15355" onMouseOver="hilite(15355)" onMouseOut="lolite()" onClick="logVariable('grade_item_backup')" href="../../_variables/grade_item_backup.html">$grade_item_backup</a>-&gt;<a onClick="logVariable('parentitemid')" class="var it45284" onMouseOver="hilite(45284)" onMouseOut="lolite()" href="../../_variables/parentitemid.html">parentitemid</a>)) {
<a name="l399"><span class="linenum"> 399</span></a>                      <a class="var it15357" onMouseOver="hilite(15357)" onMouseOut="lolite()" onClick="logVariable('oldcategoryid')" href="../../_variables/oldcategoryid.html">$oldcategoryid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('grade_category', <a class="var it15355" onMouseOver="hilite(15355)" onMouseOut="lolite()" onClick="logVariable('grade_item_backup')" href="../../_variables/grade_item_backup.html">$grade_item_backup</a>-&gt;<a onClick="logVariable('parentitemid')" class="var it45284" onMouseOver="hilite(45284)" onMouseOut="lolite()" href="../../_variables/parentitemid.html">parentitemid</a>, null);
<a name="l400"><span class="linenum"> 400</span></a>                      if (!<a class="phpfunction" onClick="logFunction('is_null')" href="../../_functions/is_null.html" onMouseOver="phpfuncPopup(event,'is_null')">is_null</a>(<a class="var it15357" onMouseOver="hilite(15357)" onMouseOut="lolite()" onClick="logVariable('oldcategoryid')" href="../../_variables/oldcategoryid.html">$oldcategoryid</a>)) {
<a name="l401"><span class="linenum"> 401</span></a>                          <a class="var it15356" onMouseOver="hilite(15356)" onMouseOut="lolite()" onClick="logVariable('updateobj')" href="../../_variables/updateobj.html">$updateobj</a>-&gt;<a onClick="logVariable('categoryid')" class="var it45285" onMouseOver="hilite(45285)" onMouseOut="lolite()" href="../../_variables/categoryid.html">categoryid</a> = <a class="var it15357" onMouseOver="hilite(15357)" onMouseOut="lolite()" onClick="logVariable('oldcategoryid')" href="../../_variables/oldcategoryid.html">$oldcategoryid</a>;
<a name="l402"><span class="linenum"> 402</span></a>                          <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('update_record')" href="../../_functions/update_record.html" onMouseOver="funcPopup(event,'update_record')">update_record</a>('grade_items', <a class="var it15356" onMouseOver="hilite(15356)" onMouseOut="lolite()" onClick="logVariable('updateobj')" href="../../_variables/updateobj.html">$updateobj</a>);
<a name="l403"><span class="linenum"> 403</span></a>                      }
<a name="l404"><span class="linenum"> 404</span></a>                  } else {
<a name="l405"><span class="linenum"> 405</span></a>  <span class="comment">                    //mark course and category items as needing to be recalculated</span>
<a name="l406"><span class="linenum"> 406</span></a>                      <a class="var it15356" onMouseOver="hilite(15356)" onMouseOut="lolite()" onClick="logVariable('updateobj')" href="../../_variables/updateobj.html">$updateobj</a>-&gt;<a onClick="logVariable('needsupdate')" class="var it45285" onMouseOver="hilite(45285)" onMouseOut="lolite()" href="../../_variables/needsupdate.html">needsupdate</a>=1;
<a name="l407"><span class="linenum"> 407</span></a>                      <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('update_record')" href="../../_functions/update_record.html" onMouseOver="funcPopup(event,'update_record')">update_record</a>('grade_items', <a class="var it15356" onMouseOver="hilite(15356)" onMouseOut="lolite()" onClick="logVariable('updateobj')" href="../../_variables/updateobj.html">$updateobj</a>);
<a name="l408"><span class="linenum"> 408</span></a>                  }
<a name="l409"><span class="linenum"> 409</span></a>              }
<a name="l410"><span class="linenum"> 410</span></a>          }
<a name="l411"><span class="linenum"> 411</span></a>          <a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a>-&gt;<a class="function" onClick="logFunction('close')" href="../../_functions/close.html" onMouseOver="funcPopup(event,'close')">close</a>();
<a name="l412"><span class="linenum"> 412</span></a>  
<a name="l413"><span class="linenum"> 413</span></a>  <span class="comment">        // We need to update the calculations for calculated grade items that may reference old</span>
<a name="l414"><span class="linenum"> 414</span></a>  <span class="comment">        // grade item ids using ##gi\d+##.</span>
<a name="l415"><span class="linenum"> 415</span></a>  <span class="comment">        // $mappings can be empty, use 0 if so (won't match ever)</span>
<a name="l416"><span class="linenum"> 416</span></a>          <a class="function" onClick="logFunction('list')" href="../../_functions/list.html" onMouseOver="funcPopup(event,'list')">list</a>(<a class="var it64" onMouseOver="hilite(64)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a>, <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>) = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_in_or_equal')" href="../../_functions/get_in_or_equal.html" onMouseOver="funcPopup(event,'get_in_or_equal')">get_in_or_equal</a>(<a class="phpfunction" onClick="logFunction('array_values')" href="../../_functions/array_values.html" onMouseOver="phpfuncPopup(event,'array_values')">array_values</a>(<a class="var it672" onMouseOver="hilite(672)" onMouseOut="lolite()" onClick="logVariable('mappings')" href="../../_variables/mappings.html">$mappings</a>), <a class="constant" onClick="logConstant('SQL_PARAMS_NAMED')" href="../../_constants/SQL_PARAMS_NAMED.html" onMouseOver="constPopup(event,'SQL_PARAMS_NAMED')">SQL_PARAMS_NAMED</a>, 'param', true, 0);
<a name="l417"><span class="linenum"> 417</span></a>          <a class="var it64" onMouseOver="hilite(64)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a> = &quot;SELECT gi.id, gi.calculation
<a name="l418"><span class="linenum"> 418</span></a>                    FROM {grade_items} gi
<a name="l419"><span class="linenum"> 419</span></a>                   WHERE gi.id {<a class="var it64" onMouseOver="hilite(64)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a>} AND
<a name="l420"><span class="linenum"> 420</span></a>                         calculation IS NOT NULL&quot;;
<a name="l421"><span class="linenum"> 421</span></a>          <a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_recordset_sql')" href="../../_functions/get_recordset_sql.html" onMouseOver="funcPopup(event,'get_recordset_sql')">get_recordset_sql</a>(<a class="var it64" onMouseOver="hilite(64)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a>, <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l422"><span class="linenum"> 422</span></a>          foreach (<a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a> as <a class="var it2470" onMouseOver="hilite(2470)" onMouseOut="lolite()" onClick="logVariable('gradeitem')" href="../../_variables/gradeitem.html">$gradeitem</a>) {
<a name="l423"><span class="linenum"> 423</span></a>  <span class="comment">            // Collect all of the used grade item id references</span>
<a name="l424"><span class="linenum"> 424</span></a>              if (<a class="phpfunction" onClick="logFunction('preg_match_all')" href="../../_functions/preg_match_all.html" onMouseOver="phpfuncPopup(event,'preg_match_all')">preg_match_all</a>('/##gi(\d+)##/', <a class="var it2470" onMouseOver="hilite(2470)" onMouseOut="lolite()" onClick="logVariable('gradeitem')" href="../../_variables/gradeitem.html">$gradeitem</a>-&gt;<a onClick="logVariable('calculation')" class="var it42964" onMouseOver="hilite(42964)" onMouseOut="lolite()" href="../../_variables/calculation.html">calculation</a>, <a class="var it161" onMouseOver="hilite(161)" onMouseOut="lolite()" onClick="logVariable('matches')" href="../../_variables/matches.html">$matches</a>) &lt; 1) {
<a name="l425"><span class="linenum"> 425</span></a>  <span class="comment">                // This calculation doesn't reference any other grade items... EASY!</span>
<a name="l426"><span class="linenum"> 426</span></a>                  continue;
<a name="l427"><span class="linenum"> 427</span></a>              }
<a name="l428"><span class="linenum"> 428</span></a>  <span class="comment">            // For this next bit we are going to do the replacement of id's in two steps:</span>
<a name="l429"><span class="linenum"> 429</span></a>  <span class="comment">            // 1. We will replace all old id references with a special mapping reference.</span>
<a name="l430"><span class="linenum"> 430</span></a>  <span class="comment">            // 2. We will replace all mapping references with id's</span>
<a name="l431"><span class="linenum"> 431</span></a>  <span class="comment">            // Why do we do this?</span>
<a name="l432"><span class="linenum"> 432</span></a>  <span class="comment">            // Because there potentially there will be an overlap of ids within the query and we</span>
<a name="l433"><span class="linenum"> 433</span></a>  <span class="comment">            // we substitute the wrong id.. safest way around this is the two step system</span>
<a name="l434"><span class="linenum"> 434</span></a>              <a class="var it15358" onMouseOver="hilite(15358)" onMouseOut="lolite()" onClick="logVariable('calculationmap')" href="../../_variables/calculationmap.html">$calculationmap</a> = array();
<a name="l435"><span class="linenum"> 435</span></a>              <a class="var it15359" onMouseOver="hilite(15359)" onMouseOut="lolite()" onClick="logVariable('mapcount')" href="../../_variables/mapcount.html">$mapcount</a> = 0;
<a name="l436"><span class="linenum"> 436</span></a>              foreach (<a class="var it161" onMouseOver="hilite(161)" onMouseOut="lolite()" onClick="logVariable('matches')" href="../../_variables/matches.html">$matches</a>[1] as <a class="var it149" onMouseOver="hilite(149)" onMouseOut="lolite()" onClick="logVariable('match')" href="../../_variables/match.html">$match</a>) {
<a name="l437"><span class="linenum"> 437</span></a>  <span class="comment">                // Check that the old id is known to us, if not it was broken to begin with and will</span>
<a name="l438"><span class="linenum"> 438</span></a>  <span class="comment">                // continue to be broken.</span>
<a name="l439"><span class="linenum"> 439</span></a>                  if (!<a class="phpfunction" onClick="logFunction('array_key_exists')" href="../../_functions/array_key_exists.html" onMouseOver="phpfuncPopup(event,'array_key_exists')">array_key_exists</a>(<a class="var it149" onMouseOver="hilite(149)" onMouseOut="lolite()" onClick="logVariable('match')" href="../../_variables/match.html">$match</a>, <a class="var it672" onMouseOver="hilite(672)" onMouseOut="lolite()" onClick="logVariable('mappings')" href="../../_variables/mappings.html">$mappings</a>)) {
<a name="l440"><span class="linenum"> 440</span></a>                      continue;
<a name="l441"><span class="linenum"> 441</span></a>                  }
<a name="l442"><span class="linenum"> 442</span></a>  <span class="comment">                // Our special mapping key</span>
<a name="l443"><span class="linenum"> 443</span></a>                  <a class="var it679" onMouseOver="hilite(679)" onMouseOut="lolite()" onClick="logVariable('mapping')" href="../../_variables/mapping.html">$mapping</a> = '##MAPPING'.<a class="var it15359" onMouseOver="hilite(15359)" onMouseOut="lolite()" onClick="logVariable('mapcount')" href="../../_variables/mapcount.html">$mapcount</a>.'##';
<a name="l444"><span class="linenum"> 444</span></a>  <span class="comment">                // The old id that exists within the calculation now</span>
<a name="l445"><span class="linenum"> 445</span></a>                  <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = '##gi'.<a class="var it149" onMouseOver="hilite(149)" onMouseOut="lolite()" onClick="logVariable('match')" href="../../_variables/match.html">$match</a>.'##';
<a name="l446"><span class="linenum"> 446</span></a>  <span class="comment">                // The new id that we want to replace the old one with.</span>
<a name="l447"><span class="linenum"> 447</span></a>                  <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a> = '##gi'.<a class="var it672" onMouseOver="hilite(672)" onMouseOut="lolite()" onClick="logVariable('mappings')" href="../../_variables/mappings.html">$mappings</a>[<a class="var it149" onMouseOver="hilite(149)" onMouseOut="lolite()" onClick="logVariable('match')" href="../../_variables/match.html">$match</a>].'##';
<a name="l448"><span class="linenum"> 448</span></a>  <span class="comment">                // Replace in the special mapping key</span>
<a name="l449"><span class="linenum"> 449</span></a>                  <a class="var it2470" onMouseOver="hilite(2470)" onMouseOut="lolite()" onClick="logVariable('gradeitem')" href="../../_variables/gradeitem.html">$gradeitem</a>-&gt;<a onClick="logVariable('calculation')" class="var it42964" onMouseOver="hilite(42964)" onMouseOut="lolite()" href="../../_variables/calculation.html">calculation</a> = <a class="phpfunction" onClick="logFunction('str_replace')" href="../../_functions/str_replace.html" onMouseOver="phpfuncPopup(event,'str_replace')">str_replace</a>(<a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it679" onMouseOver="hilite(679)" onMouseOut="lolite()" onClick="logVariable('mapping')" href="../../_variables/mapping.html">$mapping</a>, <a class="var it2470" onMouseOver="hilite(2470)" onMouseOut="lolite()" onClick="logVariable('gradeitem')" href="../../_variables/gradeitem.html">$gradeitem</a>-&gt;<a onClick="logVariable('calculation')" class="var it42964" onMouseOver="hilite(42964)" onMouseOut="lolite()" href="../../_variables/calculation.html">calculation</a>);
<a name="l450"><span class="linenum"> 450</span></a>  <span class="comment">                // And record the mapping</span>
<a name="l451"><span class="linenum"> 451</span></a>                  <a class="var it15358" onMouseOver="hilite(15358)" onMouseOut="lolite()" onClick="logVariable('calculationmap')" href="../../_variables/calculationmap.html">$calculationmap</a>[<a class="var it679" onMouseOver="hilite(679)" onMouseOut="lolite()" onClick="logVariable('mapping')" href="../../_variables/mapping.html">$mapping</a>] = <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a>;
<a name="l452"><span class="linenum"> 452</span></a>                  <a class="var it15359" onMouseOver="hilite(15359)" onMouseOut="lolite()" onClick="logVariable('mapcount')" href="../../_variables/mapcount.html">$mapcount</a>++;
<a name="l453"><span class="linenum"> 453</span></a>              }
<a name="l454"><span class="linenum"> 454</span></a>  <span class="comment">            // Iterate all special mappings for this calculation and replace in the new id's</span>
<a name="l455"><span class="linenum"> 455</span></a>              foreach (<a class="var it15358" onMouseOver="hilite(15358)" onMouseOut="lolite()" onClick="logVariable('calculationmap')" href="../../_variables/calculationmap.html">$calculationmap</a> as <a class="var it679" onMouseOver="hilite(679)" onMouseOut="lolite()" onClick="logVariable('mapping')" href="../../_variables/mapping.html">$mapping</a> =&gt; <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a>) {
<a name="l456"><span class="linenum"> 456</span></a>                  <a class="var it2470" onMouseOver="hilite(2470)" onMouseOut="lolite()" onClick="logVariable('gradeitem')" href="../../_variables/gradeitem.html">$gradeitem</a>-&gt;<a onClick="logVariable('calculation')" class="var it42964" onMouseOver="hilite(42964)" onMouseOut="lolite()" href="../../_variables/calculation.html">calculation</a> = <a class="phpfunction" onClick="logFunction('str_replace')" href="../../_functions/str_replace.html" onMouseOver="phpfuncPopup(event,'str_replace')">str_replace</a>(<a class="var it679" onMouseOver="hilite(679)" onMouseOut="lolite()" onClick="logVariable('mapping')" href="../../_variables/mapping.html">$mapping</a>, <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a>, <a class="var it2470" onMouseOver="hilite(2470)" onMouseOut="lolite()" onClick="logVariable('gradeitem')" href="../../_variables/gradeitem.html">$gradeitem</a>-&gt;<a onClick="logVariable('calculation')" class="var it42964" onMouseOver="hilite(42964)" onMouseOut="lolite()" href="../../_variables/calculation.html">calculation</a>);
<a name="l457"><span class="linenum"> 457</span></a>              }
<a name="l458"><span class="linenum"> 458</span></a>  <span class="comment">            // Update the calculation now that its being remapped</span>
<a name="l459"><span class="linenum"> 459</span></a>              <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('update_record')" href="../../_functions/update_record.html" onMouseOver="funcPopup(event,'update_record')">update_record</a>('grade_items', <a class="var it2470" onMouseOver="hilite(2470)" onMouseOut="lolite()" onClick="logVariable('gradeitem')" href="../../_variables/gradeitem.html">$gradeitem</a>);
<a name="l460"><span class="linenum"> 460</span></a>          }
<a name="l461"><span class="linenum"> 461</span></a>          <a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a>-&gt;<a class="function" onClick="logFunction('close')" href="../../_functions/close.html" onMouseOver="funcPopup(event,'close')">close</a>();
<a name="l462"><span class="linenum"> 462</span></a>  
<a name="l463"><span class="linenum"> 463</span></a>  <span class="comment">        // Need to correct the grade category path and parent</span>
<a name="l464"><span class="linenum"> 464</span></a>          <a class="var it1217" onMouseOver="hilite(1217)" onMouseOut="lolite()" onClick="logVariable('conditions')" href="../../_variables/conditions.html">$conditions</a> = array(
<a name="l465"><span class="linenum"> 465</span></a>              'courseid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>()
<a name="l466"><span class="linenum"> 466</span></a>          );
<a name="l467"><span class="linenum"> 467</span></a>  
<a name="l468"><span class="linenum"> 468</span></a>          <a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_recordset')" href="../../_functions/get_recordset.html" onMouseOver="funcPopup(event,'get_recordset')">get_recordset</a>('grade_categories', <a class="var it1217" onMouseOver="hilite(1217)" onMouseOut="lolite()" onClick="logVariable('conditions')" href="../../_variables/conditions.html">$conditions</a>);
<a name="l469"><span class="linenum"> 469</span></a>  <span class="comment">        // Get all the parents correct first as grade_category::build_path() loads category parents from the DB</span>
<a name="l470"><span class="linenum"> 470</span></a>          foreach (<a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a> as <a class="var it15360" onMouseOver="hilite(15360)" onMouseOut="lolite()" onClick="logVariable('gc')" href="../../_variables/gc.html">$gc</a>) {
<a name="l471"><span class="linenum"> 471</span></a>              if (!empty(<a class="var it15360" onMouseOver="hilite(15360)" onMouseOut="lolite()" onClick="logVariable('gc')" href="../../_variables/gc.html">$gc</a>-&gt;<a onClick="logVariable('parent')" class="var it45286" onMouseOver="hilite(45286)" onMouseOut="lolite()" href="../../_variables/parent.html">parent</a>)) {
<a name="l472"><span class="linenum"> 472</span></a>                  <a class="var it969" onMouseOver="hilite(969)" onMouseOut="lolite()" onClick="logVariable('grade_category')" href="../../_variables/grade_category.html">$grade_category</a> = new stdClass();
<a name="l473"><span class="linenum"> 473</span></a>                  <a class="var it969" onMouseOver="hilite(969)" onMouseOut="lolite()" onClick="logVariable('grade_category')" href="../../_variables/grade_category.html">$grade_category</a>-&gt;<a onClick="logVariable('id')" class="var it43448" onMouseOver="hilite(43448)" onMouseOut="lolite()" href="../../_variables/id.html">id</a> = <a class="var it15360" onMouseOver="hilite(15360)" onMouseOut="lolite()" onClick="logVariable('gc')" href="../../_variables/gc.html">$gc</a>-&gt;<a onClick="logVariable('id')" class="var it45286" onMouseOver="hilite(45286)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l474"><span class="linenum"> 474</span></a>                  <a class="var it969" onMouseOver="hilite(969)" onMouseOut="lolite()" onClick="logVariable('grade_category')" href="../../_variables/grade_category.html">$grade_category</a>-&gt;<a onClick="logVariable('parent')" class="var it43448" onMouseOver="hilite(43448)" onMouseOut="lolite()" href="../../_variables/parent.html">parent</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('grade_category', <a class="var it15360" onMouseOver="hilite(15360)" onMouseOut="lolite()" onClick="logVariable('gc')" href="../../_variables/gc.html">$gc</a>-&gt;<a onClick="logVariable('parent')" class="var it45286" onMouseOver="hilite(45286)" onMouseOut="lolite()" href="../../_variables/parent.html">parent</a>);
<a name="l475"><span class="linenum"> 475</span></a>                  <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('update_record')" href="../../_functions/update_record.html" onMouseOver="funcPopup(event,'update_record')">update_record</a>('grade_categories', <a class="var it969" onMouseOver="hilite(969)" onMouseOut="lolite()" onClick="logVariable('grade_category')" href="../../_variables/grade_category.html">$grade_category</a>);
<a name="l476"><span class="linenum"> 476</span></a>              }
<a name="l477"><span class="linenum"> 477</span></a>          }
<a name="l478"><span class="linenum"> 478</span></a>          <a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a>-&gt;<a class="function" onClick="logFunction('close')" href="../../_functions/close.html" onMouseOver="funcPopup(event,'close')">close</a>();
<a name="l479"><span class="linenum"> 479</span></a>  
<a name="l480"><span class="linenum"> 480</span></a>  <span class="comment">        // Now we can rebuild all the paths</span>
<a name="l481"><span class="linenum"> 481</span></a>          <a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_recordset')" href="../../_functions/get_recordset.html" onMouseOver="funcPopup(event,'get_recordset')">get_recordset</a>('grade_categories', <a class="var it1217" onMouseOver="hilite(1217)" onMouseOut="lolite()" onClick="logVariable('conditions')" href="../../_variables/conditions.html">$conditions</a>);
<a name="l482"><span class="linenum"> 482</span></a>          foreach (<a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a> as <a class="var it15360" onMouseOver="hilite(15360)" onMouseOut="lolite()" onClick="logVariable('gc')" href="../../_variables/gc.html">$gc</a>) {
<a name="l483"><span class="linenum"> 483</span></a>              <a class="var it969" onMouseOver="hilite(969)" onMouseOut="lolite()" onClick="logVariable('grade_category')" href="../../_variables/grade_category.html">$grade_category</a> = new stdClass();
<a name="l484"><span class="linenum"> 484</span></a>              <a class="var it969" onMouseOver="hilite(969)" onMouseOut="lolite()" onClick="logVariable('grade_category')" href="../../_variables/grade_category.html">$grade_category</a>-&gt;<a onClick="logVariable('id')" class="var it43448" onMouseOver="hilite(43448)" onMouseOut="lolite()" href="../../_variables/id.html">id</a> = <a class="var it15360" onMouseOver="hilite(15360)" onMouseOut="lolite()" onClick="logVariable('gc')" href="../../_variables/gc.html">$gc</a>-&gt;<a onClick="logVariable('id')" class="var it45286" onMouseOver="hilite(45286)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l485"><span class="linenum"> 485</span></a>              <a class="var it969" onMouseOver="hilite(969)" onMouseOut="lolite()" onClick="logVariable('grade_category')" href="../../_variables/grade_category.html">$grade_category</a>-&gt;<a onClick="logVariable('path')" class="var it43448" onMouseOver="hilite(43448)" onMouseOut="lolite()" href="../../_variables/path.html">path</a> = <a class="class" onClick="logClass('grade_category')" href="../../_classes/grade_category.html" onMouseOver="classPopup(event,'grade_category')">grade_category</a>::<a class="function" onClick="logFunction('build_path')" href="../../_functions/build_path.html" onMouseOver="funcPopup(event,'build_path')">build_path</a>(<a class="var it15360" onMouseOver="hilite(15360)" onMouseOut="lolite()" onClick="logVariable('gc')" href="../../_variables/gc.html">$gc</a>);
<a name="l486"><span class="linenum"> 486</span></a>              <a class="var it969" onMouseOver="hilite(969)" onMouseOut="lolite()" onClick="logVariable('grade_category')" href="../../_variables/grade_category.html">$grade_category</a>-&gt;<a onClick="logVariable('depth')" class="var it43448" onMouseOver="hilite(43448)" onMouseOut="lolite()" href="../../_variables/depth.html">depth</a> = <a class="phpfunction" onClick="logFunction('substr_count')" href="../../_functions/substr_count.html" onMouseOver="phpfuncPopup(event,'substr_count')">substr_count</a>(<a class="var it969" onMouseOver="hilite(969)" onMouseOut="lolite()" onClick="logVariable('grade_category')" href="../../_variables/grade_category.html">$grade_category</a>-&gt;<a onClick="logVariable('path')" class="var it43448" onMouseOver="hilite(43448)" onMouseOut="lolite()" href="../../_variables/path.html">path</a>, '/') - 1;
<a name="l487"><span class="linenum"> 487</span></a>              <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('update_record')" href="../../_functions/update_record.html" onMouseOver="funcPopup(event,'update_record')">update_record</a>('grade_categories', <a class="var it969" onMouseOver="hilite(969)" onMouseOut="lolite()" onClick="logVariable('grade_category')" href="../../_variables/grade_category.html">$grade_category</a>);
<a name="l488"><span class="linenum"> 488</span></a>          }
<a name="l489"><span class="linenum"> 489</span></a>          <a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a>-&gt;<a class="function" onClick="logFunction('close')" href="../../_functions/close.html" onMouseOver="funcPopup(event,'close')">close</a>();
<a name="l490"><span class="linenum"> 490</span></a>  
<a name="l491"><span class="linenum"> 491</span></a>  <span class="comment">        // Check what to do with the minmaxtouse setting.</span>
<a name="l492"><span class="linenum"> 492</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('check_minmaxtouse')" href="../../_functions/check_minmaxtouse.html" onMouseOver="funcPopup(event,'check_minmaxtouse')">check_minmaxtouse</a>();
<a name="l493"><span class="linenum"> 493</span></a>  
<a name="l494"><span class="linenum"> 494</span></a>  <span class="comment">        // Freeze gradebook calculations if needed.</span>
<a name="l495"><span class="linenum"> 495</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('gradebook_calculation_freeze')" href="../../_functions/gradebook_calculation_freeze.html" onMouseOver="funcPopup(event,'gradebook_calculation_freeze')">gradebook_calculation_freeze</a>();
<a name="l496"><span class="linenum"> 496</span></a>  
<a name="l497"><span class="linenum"> 497</span></a>  <span class="comment">        // Restore marks items as needing update. Update everything now.</span>
<a name="l498"><span class="linenum"> 498</span></a>          <a class="function" onClick="logFunction('grade_regrade_final_grades')" href="../../_functions/grade_regrade_final_grades.html" onMouseOver="funcPopup(event,'grade_regrade_final_grades')">grade_regrade_final_grades</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>());
<a name="l499"><span class="linenum"> 499</span></a>      }
<a name="l500"><span class="linenum"> 500</span></a>  
<a name="l501"><span class="linenum"> 501</span></a>      <span class="comment">/**</span>
<a name="l502"><span class="linenum"> 502</span></a>  <span class="comment">     * Freeze gradebook calculation if needed.</span>
<a name="l503"><span class="linenum"> 503</span></a>  <span class="comment">     *</span>
<a name="l504"><span class="linenum"> 504</span></a>  <span class="comment">     * This is similar to various upgrade scripts that check if the freeze is needed.</span>
<a name="l505"><span class="linenum"> 505</span></a>  <span class="comment">     */</span>
<a name="l506"><span class="linenum"> 506</span></a>      protected function <a class="function" onClick="logFunction('gradebook_calculation_freeze')" href="../../_functions/gradebook_calculation_freeze.html" onMouseOver="funcPopup(event,'gradebook_calculation_freeze')">gradebook_calculation_freeze</a>() {
<a name="l507"><span class="linenum"> 507</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>;
<a name="l508"><span class="linenum"> 508</span></a>          <a class="var it5334" onMouseOver="hilite(5334)" onMouseOut="lolite()" onClick="logVariable('gradebookcalculationsfreeze')" href="../../_variables/gradebookcalculationsfreeze.html">$gradebookcalculationsfreeze</a> = <a class="function" onClick="logFunction('get_config')" href="../../_functions/get_config.html" onMouseOver="funcPopup(event,'get_config')">get_config</a>('core', 'gradebook_calculations_freeze_' . <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>());
<a name="l509"><span class="linenum"> 509</span></a>          <a class="phpfunction" onClick="logFunction('preg_match')" href="../../_functions/preg_match.html" onMouseOver="phpfuncPopup(event,'preg_match')">preg_match</a>('/(\d{8})/', <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_task')" href="../../_functions/get_task.html" onMouseOver="funcPopup(event,'get_task')">get_task</a>()-&gt;<a class="function" onClick="logFunction('get_info')" href="../../_functions/get_info.html" onMouseOver="funcPopup(event,'get_info')">get_info</a>()-&gt;moodle_release, <a class="var it161" onMouseOver="hilite(161)" onMouseOut="lolite()" onClick="logVariable('matches')" href="../../_variables/matches.html">$matches</a>);
<a name="l510"><span class="linenum"> 510</span></a>          <a class="var it15347" onMouseOver="hilite(15347)" onMouseOut="lolite()" onClick="logVariable('backupbuild')" href="../../_variables/backupbuild.html">$backupbuild</a> = (int)<a class="var it161" onMouseOver="hilite(161)" onMouseOut="lolite()" onClick="logVariable('matches')" href="../../_variables/matches.html">$matches</a>[1];
<a name="l511"><span class="linenum"> 511</span></a>  <span class="comment">        // The function floatval will return a float even if there is text mixed with the release number.</span>
<a name="l512"><span class="linenum"> 512</span></a>          <a class="var it10723" onMouseOver="hilite(10723)" onMouseOut="lolite()" onClick="logVariable('backuprelease')" href="../../_variables/backuprelease.html">$backuprelease</a> = <a class="phpfunction" onClick="logFunction('floatval')" href="../../_functions/floatval.html" onMouseOver="phpfuncPopup(event,'floatval')">floatval</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_task')" href="../../_functions/get_task.html" onMouseOver="funcPopup(event,'get_task')">get_task</a>()-&gt;<a class="function" onClick="logFunction('get_info')" href="../../_functions/get_info.html" onMouseOver="funcPopup(event,'get_info')">get_info</a>()-&gt;backup_release);
<a name="l513"><span class="linenum"> 513</span></a>  
<a name="l514"><span class="linenum"> 514</span></a>  <span class="comment">        // Extra credits need adjustments only for backups made between 2.8 release (20141110) and the fix release (20150619).</span>
<a name="l515"><span class="linenum"> 515</span></a>          if (!<a class="var it5334" onMouseOver="hilite(5334)" onMouseOut="lolite()" onClick="logVariable('gradebookcalculationsfreeze')" href="../../_variables/gradebookcalculationsfreeze.html">$gradebookcalculationsfreeze</a> &amp;&amp; <a class="var it15347" onMouseOver="hilite(15347)" onMouseOut="lolite()" onClick="logVariable('backupbuild')" href="../../_variables/backupbuild.html">$backupbuild</a> &gt;= 20141110 &amp;&amp; <a class="var it15347" onMouseOver="hilite(15347)" onMouseOut="lolite()" onClick="logVariable('backupbuild')" href="../../_variables/backupbuild.html">$backupbuild</a> &lt; 20150619) {
<a name="l516"><span class="linenum"> 516</span></a>              require_once(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('libdir')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/libdir.html">libdir</a> . '/db/upgradelib.php');
<a name="l517"><span class="linenum"> 517</span></a>              <a class="function" onClick="logFunction('upgrade_extra_credit_weightoverride')" href="../../_functions/upgrade_extra_credit_weightoverride.html" onMouseOver="funcPopup(event,'upgrade_extra_credit_weightoverride')">upgrade_extra_credit_weightoverride</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>());
<a name="l518"><span class="linenum"> 518</span></a>          }
<a name="l519"><span class="linenum"> 519</span></a>  <span class="comment">        // Calculated grade items need recalculating for backups made between 2.8 release (20141110) and the fix release (20150627).</span>
<a name="l520"><span class="linenum"> 520</span></a>          if (!<a class="var it5334" onMouseOver="hilite(5334)" onMouseOut="lolite()" onClick="logVariable('gradebookcalculationsfreeze')" href="../../_variables/gradebookcalculationsfreeze.html">$gradebookcalculationsfreeze</a> &amp;&amp; <a class="var it15347" onMouseOver="hilite(15347)" onMouseOut="lolite()" onClick="logVariable('backupbuild')" href="../../_variables/backupbuild.html">$backupbuild</a> &gt;= 20141110 &amp;&amp; <a class="var it15347" onMouseOver="hilite(15347)" onMouseOut="lolite()" onClick="logVariable('backupbuild')" href="../../_variables/backupbuild.html">$backupbuild</a> &lt; 20150627) {
<a name="l521"><span class="linenum"> 521</span></a>              require_once(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('libdir')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/libdir.html">libdir</a> . '/db/upgradelib.php');
<a name="l522"><span class="linenum"> 522</span></a>              <a class="function" onClick="logFunction('upgrade_calculated_grade_items')" href="../../_functions/upgrade_calculated_grade_items.html" onMouseOver="funcPopup(event,'upgrade_calculated_grade_items')">upgrade_calculated_grade_items</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>());
<a name="l523"><span class="linenum"> 523</span></a>          }
<a name="l524"><span class="linenum"> 524</span></a>  <span class="comment">        // Courses from before 3.1 (20160518) may have a letter boundary problem and should be checked for this issue.</span>
<a name="l525"><span class="linenum"> 525</span></a>  <span class="comment">        // Backups from before and including 2.9 could have a build number that is greater than 20160518 and should</span>
<a name="l526"><span class="linenum"> 526</span></a>  <span class="comment">        // be checked for this problem.</span>
<a name="l527"><span class="linenum"> 527</span></a>          if (!<a class="var it5334" onMouseOver="hilite(5334)" onMouseOut="lolite()" onClick="logVariable('gradebookcalculationsfreeze')" href="../../_variables/gradebookcalculationsfreeze.html">$gradebookcalculationsfreeze</a> &amp;&amp; (<a class="var it15347" onMouseOver="hilite(15347)" onMouseOut="lolite()" onClick="logVariable('backupbuild')" href="../../_variables/backupbuild.html">$backupbuild</a> &lt; 20160518 || <a class="var it10723" onMouseOver="hilite(10723)" onMouseOut="lolite()" onClick="logVariable('backuprelease')" href="../../_variables/backuprelease.html">$backuprelease</a> &lt;= 2.9)) {
<a name="l528"><span class="linenum"> 528</span></a>              require_once(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('libdir')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/libdir.html">libdir</a> . '/db/upgradelib.php');
<a name="l529"><span class="linenum"> 529</span></a>              <a class="function" onClick="logFunction('upgrade_course_letter_boundary')" href="../../_functions/upgrade_course_letter_boundary.html" onMouseOver="funcPopup(event,'upgrade_course_letter_boundary')">upgrade_course_letter_boundary</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>());
<a name="l530"><span class="linenum"> 530</span></a>          }
<a name="l531"><span class="linenum"> 531</span></a>  
<a name="l532"><span class="linenum"> 532</span></a>      }
<a name="l533"><span class="linenum"> 533</span></a>  
<a name="l534"><span class="linenum"> 534</span></a>      <span class="comment">/**</span>
<a name="l535"><span class="linenum"> 535</span></a>  <span class="comment">     * Checks what should happen with the course grade setting minmaxtouse.</span>
<a name="l536"><span class="linenum"> 536</span></a>  <span class="comment">     *</span>
<a name="l537"><span class="linenum"> 537</span></a>  <span class="comment">     * This is related to the upgrade step at the time the setting was added.</span>
<a name="l538"><span class="linenum"> 538</span></a>  <span class="comment">     *</span>
<a name="l539"><span class="linenum"> 539</span></a>  <span class="comment">     * @see MDL-48618</span>
<a name="l540"><span class="linenum"> 540</span></a>  <span class="comment">     * @return void</span>
<a name="l541"><span class="linenum"> 541</span></a>  <span class="comment">     */</span>
<a name="l542"><span class="linenum"> 542</span></a>      protected function <a class="function" onClick="logFunction('check_minmaxtouse')" href="../../_functions/check_minmaxtouse.html" onMouseOver="funcPopup(event,'check_minmaxtouse')">check_minmaxtouse</a>() {
<a name="l543"><span class="linenum"> 543</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l544"><span class="linenum"> 544</span></a>          require_once(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('libdir')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/libdir.html">libdir</a> . '/gradelib.php');
<a name="l545"><span class="linenum"> 545</span></a>  
<a name="l546"><span class="linenum"> 546</span></a>          <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('userinfo')" href="../../_variables/userinfo.html">$userinfo</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('users');
<a name="l547"><span class="linenum"> 547</span></a>          <a class="var it9397" onMouseOver="hilite(9397)" onMouseOut="lolite()" onClick="logVariable('settingname')" href="../../_variables/settingname.html">$settingname</a> = 'minmaxtouse';
<a name="l548"><span class="linenum"> 548</span></a>          <a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l549"><span class="linenum"> 549</span></a>          <a class="var it14625" onMouseOver="hilite(14625)" onMouseOut="lolite()" onClick="logVariable('minmaxtouse')" href="../../_variables/minmaxtouse.html">$minmaxtouse</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('grade_settings', 'value', array('courseid' =&gt; <a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>, 'name' =&gt; <a class="var it9397" onMouseOver="hilite(9397)" onMouseOut="lolite()" onClick="logVariable('settingname')" href="../../_variables/settingname.html">$settingname</a>));
<a name="l550"><span class="linenum"> 550</span></a>          <a class="var it15361" onMouseOver="hilite(15361)" onMouseOut="lolite()" onClick="logVariable('version28start')" href="../../_variables/version28start.html">$version28start</a> = 2014111000.00;
<a name="l551"><span class="linenum"> 551</span></a>          <a class="var it15362" onMouseOver="hilite(15362)" onMouseOut="lolite()" onClick="logVariable('version28last')" href="../../_variables/version28last.html">$version28last</a> = 2014111006.05;
<a name="l552"><span class="linenum"> 552</span></a>          <a class="var it15363" onMouseOver="hilite(15363)" onMouseOut="lolite()" onClick="logVariable('version29start')" href="../../_variables/version29start.html">$version29start</a> = 2015051100.00;
<a name="l553"><span class="linenum"> 553</span></a>          <a class="var it15364" onMouseOver="hilite(15364)" onMouseOut="lolite()" onClick="logVariable('version29last')" href="../../_variables/version29last.html">$version29last</a> = 2015060400.02;
<a name="l554"><span class="linenum"> 554</span></a>  
<a name="l555"><span class="linenum"> 555</span></a>          <a class="var it713" onMouseOver="hilite(713)" onMouseOut="lolite()" onClick="logVariable('target')" href="../../_variables/target.html">$target</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_task')" href="../../_functions/get_task.html" onMouseOver="funcPopup(event,'get_task')">get_task</a>()-&gt;<a class="function" onClick="logFunction('get_target')" href="../../_functions/get_target.html" onMouseOver="funcPopup(event,'get_target')">get_target</a>();
<a name="l556"><span class="linenum"> 556</span></a>          if (<a class="var it14625" onMouseOver="hilite(14625)" onMouseOut="lolite()" onClick="logVariable('minmaxtouse')" href="../../_variables/minmaxtouse.html">$minmaxtouse</a> === false &amp;&amp;
<a name="l557"><span class="linenum"> 557</span></a>                  (<a class="var it713" onMouseOver="hilite(713)" onMouseOut="lolite()" onClick="logVariable('target')" href="../../_variables/target.html">$target</a> != backup::TARGET_CURRENT_ADDING &amp;&amp; <a class="var it713" onMouseOver="hilite(713)" onMouseOut="lolite()" onClick="logVariable('target')" href="../../_variables/target.html">$target</a> != backup::TARGET_EXISTING_ADDING)) {
<a name="l558"><span class="linenum"> 558</span></a>  <span class="comment">            // The setting was not found because this setting did not exist at the time the backup was made.</span>
<a name="l559"><span class="linenum"> 559</span></a>  <span class="comment">            // And we are not restoring as merge, in which case we leave the course as it was.</span>
<a name="l560"><span class="linenum"> 560</span></a>              <a class="var it347" onMouseOver="hilite(347)" onMouseOut="lolite()" onClick="logVariable('version')" href="../../_variables/version.html">$version</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_task')" href="../../_functions/get_task.html" onMouseOver="funcPopup(event,'get_task')">get_task</a>()-&gt;<a class="function" onClick="logFunction('get_info')" href="../../_functions/get_info.html" onMouseOver="funcPopup(event,'get_info')">get_info</a>()-&gt;moodle_version;
<a name="l561"><span class="linenum"> 561</span></a>  
<a name="l562"><span class="linenum"> 562</span></a>              if (<a class="var it347" onMouseOver="hilite(347)" onMouseOut="lolite()" onClick="logVariable('version')" href="../../_variables/version.html">$version</a> &lt; <a class="var it15361" onMouseOver="hilite(15361)" onMouseOut="lolite()" onClick="logVariable('version28start')" href="../../_variables/version28start.html">$version28start</a>) {
<a name="l563"><span class="linenum"> 563</span></a>  <span class="comment">                // We need to set it to use grade_item, but only if the site-wide setting is different. No need to notice them.</span>
<a name="l564"><span class="linenum"> 564</span></a>                  if (<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('grade_minmaxtouse')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/grade_minmaxtouse.html">grade_minmaxtouse</a> != <a class="constant" onClick="logConstant('GRADE_MIN_MAX_FROM_GRADE_ITEM')" href="../../_constants/GRADE_MIN_MAX_FROM_GRADE_ITEM.html" onMouseOver="constPopup(event,'GRADE_MIN_MAX_FROM_GRADE_ITEM')">GRADE_MIN_MAX_FROM_GRADE_ITEM</a>) {
<a name="l565"><span class="linenum"> 565</span></a>                      <a class="function" onClick="logFunction('grade_set_setting')" href="../../_functions/grade_set_setting.html" onMouseOver="funcPopup(event,'grade_set_setting')">grade_set_setting</a>(<a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>, <a class="var it9397" onMouseOver="hilite(9397)" onMouseOut="lolite()" onClick="logVariable('settingname')" href="../../_variables/settingname.html">$settingname</a>, <a class="constant" onClick="logConstant('GRADE_MIN_MAX_FROM_GRADE_ITEM')" href="../../_constants/GRADE_MIN_MAX_FROM_GRADE_ITEM.html" onMouseOver="constPopup(event,'GRADE_MIN_MAX_FROM_GRADE_ITEM')">GRADE_MIN_MAX_FROM_GRADE_ITEM</a>);
<a name="l566"><span class="linenum"> 566</span></a>                  }
<a name="l567"><span class="linenum"> 567</span></a>  
<a name="l568"><span class="linenum"> 568</span></a>              } else if ((<a class="var it347" onMouseOver="hilite(347)" onMouseOut="lolite()" onClick="logVariable('version')" href="../../_variables/version.html">$version</a> &gt;= <a class="var it15361" onMouseOver="hilite(15361)" onMouseOut="lolite()" onClick="logVariable('version28start')" href="../../_variables/version28start.html">$version28start</a> &amp;&amp; <a class="var it347" onMouseOver="hilite(347)" onMouseOut="lolite()" onClick="logVariable('version')" href="../../_variables/version.html">$version</a> &lt; <a class="var it15362" onMouseOver="hilite(15362)" onMouseOut="lolite()" onClick="logVariable('version28last')" href="../../_variables/version28last.html">$version28last</a>) ||
<a name="l569"><span class="linenum"> 569</span></a>                      (<a class="var it347" onMouseOver="hilite(347)" onMouseOut="lolite()" onClick="logVariable('version')" href="../../_variables/version.html">$version</a> &gt;= <a class="var it15363" onMouseOver="hilite(15363)" onMouseOut="lolite()" onClick="logVariable('version29start')" href="../../_variables/version29start.html">$version29start</a> &amp;&amp; <a class="var it347" onMouseOver="hilite(347)" onMouseOut="lolite()" onClick="logVariable('version')" href="../../_variables/version.html">$version</a> &lt; <a class="var it15364" onMouseOver="hilite(15364)" onMouseOut="lolite()" onClick="logVariable('version29last')" href="../../_variables/version29last.html">$version29last</a>)) {
<a name="l570"><span class="linenum"> 570</span></a>  <span class="comment">                // They should be using grade_grade when the course has inconsistencies.</span>
<a name="l571"><span class="linenum"> 571</span></a>  
<a name="l572"><span class="linenum"> 572</span></a>                  <a class="var it64" onMouseOver="hilite(64)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a> = &quot;SELECT gi.id
<a name="l573"><span class="linenum"> 573</span></a>                            FROM {grade_items} gi
<a name="l574"><span class="linenum"> 574</span></a>                            JOIN {grade_grades} gg
<a name="l575"><span class="linenum"> 575</span></a>                              ON gg.itemid = gi.id
<a name="l576"><span class="linenum"> 576</span></a>                           WHERE gi.courseid = ?
<a name="l577"><span class="linenum"> 577</span></a>                             AND (gi.itemtype != ? AND gi.itemtype != ?)
<a name="l578"><span class="linenum"> 578</span></a>                             AND (gg.rawgrademax != gi.grademax OR gg.rawgrademin != gi.grademin)&quot;;
<a name="l579"><span class="linenum"> 579</span></a>  
<a name="l580"><span class="linenum"> 580</span></a>  <span class="comment">                // The course can only have inconsistencies when we restore the user info,</span>
<a name="l581"><span class="linenum"> 581</span></a>  <span class="comment">                // we do not need to act on existing grades that were not restored as part of this backup.</span>
<a name="l582"><span class="linenum"> 582</span></a>                  if (<a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('userinfo')" href="../../_variables/userinfo.html">$userinfo</a> &amp;&amp; <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists_sql')" href="../../_functions/record_exists_sql.html" onMouseOver="funcPopup(event,'record_exists_sql')">record_exists_sql</a>(<a class="var it64" onMouseOver="hilite(64)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a>, array(<a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>, 'course', 'category'))) {
<a name="l583"><span class="linenum"> 583</span></a>  
<a name="l584"><span class="linenum"> 584</span></a>  <span class="comment">                    // Display the notice as we do during upgrade.</span>
<a name="l585"><span class="linenum"> 585</span></a>                      <a class="function" onClick="logFunction('set_config')" href="../../_functions/set_config.html" onMouseOver="funcPopup(event,'set_config')">set_config</a>('show_min_max_grades_changed_' . <a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>, 1);
<a name="l586"><span class="linenum"> 586</span></a>  
<a name="l587"><span class="linenum"> 587</span></a>                      if (<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('grade_minmaxtouse')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/grade_minmaxtouse.html">grade_minmaxtouse</a> != <a class="constant" onClick="logConstant('GRADE_MIN_MAX_FROM_GRADE_GRADE')" href="../../_constants/GRADE_MIN_MAX_FROM_GRADE_GRADE.html" onMouseOver="constPopup(event,'GRADE_MIN_MAX_FROM_GRADE_GRADE')">GRADE_MIN_MAX_FROM_GRADE_GRADE</a>) {
<a name="l588"><span class="linenum"> 588</span></a>  <span class="comment">                        // We need set the setting as their site-wise setting is not GRADE_MIN_MAX_FROM_GRADE_GRADE.</span>
<a name="l589"><span class="linenum"> 589</span></a>  <span class="comment">                        // If they are using the site-wide grade_grade setting, we only want to notice them.</span>
<a name="l590"><span class="linenum"> 590</span></a>                          <a class="function" onClick="logFunction('grade_set_setting')" href="../../_functions/grade_set_setting.html" onMouseOver="funcPopup(event,'grade_set_setting')">grade_set_setting</a>(<a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>, <a class="var it9397" onMouseOver="hilite(9397)" onMouseOut="lolite()" onClick="logVariable('settingname')" href="../../_variables/settingname.html">$settingname</a>, <a class="constant" onClick="logConstant('GRADE_MIN_MAX_FROM_GRADE_GRADE')" href="../../_constants/GRADE_MIN_MAX_FROM_GRADE_GRADE.html" onMouseOver="constPopup(event,'GRADE_MIN_MAX_FROM_GRADE_GRADE')">GRADE_MIN_MAX_FROM_GRADE_GRADE</a>);
<a name="l591"><span class="linenum"> 591</span></a>                      }
<a name="l592"><span class="linenum"> 592</span></a>                  }
<a name="l593"><span class="linenum"> 593</span></a>  
<a name="l594"><span class="linenum"> 594</span></a>              } else {
<a name="l595"><span class="linenum"> 595</span></a>  <span class="comment">                // This should never happen because from now on minmaxtouse is always saved in backups.</span>
<a name="l596"><span class="linenum"> 596</span></a>              }
<a name="l597"><span class="linenum"> 597</span></a>          }
<a name="l598"><span class="linenum"> 598</span></a>      }
<a name="l599"><span class="linenum"> 599</span></a>  
<a name="l600"><span class="linenum"> 600</span></a>      <span class="comment">/**</span>
<a name="l601"><span class="linenum"> 601</span></a>  <span class="comment">     * Rewrite step definition to handle the legacy freeze attribute.</span>
<a name="l602"><span class="linenum"> 602</span></a>  <span class="comment">     *</span>
<a name="l603"><span class="linenum"> 603</span></a>  <span class="comment">     * In previous backups the calculations_freeze property was stored as an attribute of the</span>
<a name="l604"><span class="linenum"> 604</span></a>  <span class="comment">     * top level node &lt;gradebook&gt;. The backup API, however, do not process grandparent nodes.</span>
<a name="l605"><span class="linenum"> 605</span></a>  <span class="comment">     * It only processes definitive children, and their parent attributes.</span>
<a name="l606"><span class="linenum"> 606</span></a>  <span class="comment">     *</span>
<a name="l607"><span class="linenum"> 607</span></a>  <span class="comment">     * We had:</span>
<a name="l608"><span class="linenum"> 608</span></a>  <span class="comment">     *</span>
<a name="l609"><span class="linenum"> 609</span></a>  <span class="comment">     * &lt;gradebook calculations_freeze=&quot;20160511&quot;&gt;</span>
<a name="l610"><span class="linenum"> 610</span></a>  <span class="comment">     *   &lt;grade_categories&gt;</span>
<a name="l611"><span class="linenum"> 611</span></a>  <span class="comment">     *     &lt;grade_category id=&quot;10&quot;&gt;</span>
<a name="l612"><span class="linenum"> 612</span></a>  <span class="comment">     *       &lt;depth&gt;1&lt;/depth&gt;</span>
<a name="l613"><span class="linenum"> 613</span></a>  <span class="comment">     *       ...</span>
<a name="l614"><span class="linenum"> 614</span></a>  <span class="comment">     *     &lt;/grade_category&gt;</span>
<a name="l615"><span class="linenum"> 615</span></a>  <span class="comment">     *   &lt;/grade_categories&gt;</span>
<a name="l616"><span class="linenum"> 616</span></a>  <span class="comment">     *   ...</span>
<a name="l617"><span class="linenum"> 617</span></a>  <span class="comment">     * &lt;/gradebook&gt;</span>
<a name="l618"><span class="linenum"> 618</span></a>  <span class="comment">     *</span>
<a name="l619"><span class="linenum"> 619</span></a>  <span class="comment">     * And this method will convert it to:</span>
<a name="l620"><span class="linenum"> 620</span></a>  <span class="comment">     *</span>
<a name="l621"><span class="linenum"> 621</span></a>  <span class="comment">     * &lt;gradebook &gt;</span>
<a name="l622"><span class="linenum"> 622</span></a>  <span class="comment">     *   &lt;attributes&gt;</span>
<a name="l623"><span class="linenum"> 623</span></a>  <span class="comment">     *     &lt;calculations_freeze&gt;20160511&lt;/calculations_freeze&gt;</span>
<a name="l624"><span class="linenum"> 624</span></a>  <span class="comment">     *   &lt;/attributes&gt;</span>
<a name="l625"><span class="linenum"> 625</span></a>  <span class="comment">     *   &lt;grade_categories&gt;</span>
<a name="l626"><span class="linenum"> 626</span></a>  <span class="comment">     *     &lt;grade_category id=&quot;10&quot;&gt;</span>
<a name="l627"><span class="linenum"> 627</span></a>  <span class="comment">     *       &lt;depth&gt;1&lt;/depth&gt;</span>
<a name="l628"><span class="linenum"> 628</span></a>  <span class="comment">     *       ...</span>
<a name="l629"><span class="linenum"> 629</span></a>  <span class="comment">     *     &lt;/grade_category&gt;</span>
<a name="l630"><span class="linenum"> 630</span></a>  <span class="comment">     *   &lt;/grade_categories&gt;</span>
<a name="l631"><span class="linenum"> 631</span></a>  <span class="comment">     *   ...</span>
<a name="l632"><span class="linenum"> 632</span></a>  <span class="comment">     * &lt;/gradebook&gt;</span>
<a name="l633"><span class="linenum"> 633</span></a>  <span class="comment">     *</span>
<a name="l634"><span class="linenum"> 634</span></a>  <span class="comment">     * Note that we cannot just load the XML file in memory as it could potentially be huge.</span>
<a name="l635"><span class="linenum"> 635</span></a>  <span class="comment">     * We can also completely ignore if the node &lt;attributes&gt; is already in the backup</span>
<a name="l636"><span class="linenum"> 636</span></a>  <span class="comment">     * file as it never existed before.</span>
<a name="l637"><span class="linenum"> 637</span></a>  <span class="comment">     *</span>
<a name="l638"><span class="linenum"> 638</span></a>  <span class="comment">     * @param string $filepath The absolute path to the XML file.</span>
<a name="l639"><span class="linenum"> 639</span></a>  <span class="comment">     * @return void</span>
<a name="l640"><span class="linenum"> 640</span></a>  <span class="comment">     */</span>
<a name="l641"><span class="linenum"> 641</span></a>      protected function <a class="function" onClick="logFunction('rewrite_step_backup_file_for_legacy_freeze')" href="../../_functions/rewrite_step_backup_file_for_legacy_freeze.html" onMouseOver="funcPopup(event,'rewrite_step_backup_file_for_legacy_freeze')">rewrite_step_backup_file_for_legacy_freeze</a>(<a class="var it886" onMouseOver="hilite(886)" onMouseOut="lolite()" onClick="logVariable('filepath')" href="../../_variables/filepath.html">$filepath</a>) {
<a name="l642"><span class="linenum"> 642</span></a>          <a class="var it15365" onMouseOver="hilite(15365)" onMouseOut="lolite()" onClick="logVariable('foundnode')" href="../../_variables/foundnode.html">$foundnode</a> = false;
<a name="l643"><span class="linenum"> 643</span></a>          <a class="var it2113" onMouseOver="hilite(2113)" onMouseOut="lolite()" onClick="logVariable('newfile')" href="../../_variables/newfile.html">$newfile</a> = <a class="function" onClick="logFunction('make_request_directory')" href="../../_functions/make_request_directory.html" onMouseOver="funcPopup(event,'make_request_directory')">make_request_directory</a>(true) . DIRECTORY_SEPARATOR . 'file.xml';
<a name="l644"><span class="linenum"> 644</span></a>          <a class="var it7235" onMouseOver="hilite(7235)" onMouseOut="lolite()" onClick="logVariable('fr')" href="../../_variables/fr.html">$fr</a> = <a class="function" onClick="logFunction('fopen')" href="../../_functions/fopen.html" onMouseOver="funcPopup(event,'fopen')">fopen</a>(<a class="var it886" onMouseOver="hilite(886)" onMouseOut="lolite()" onClick="logVariable('filepath')" href="../../_variables/filepath.html">$filepath</a>, 'r');
<a name="l645"><span class="linenum"> 645</span></a>          <a class="var it4154" onMouseOver="hilite(4154)" onMouseOut="lolite()" onClick="logVariable('fw')" href="../../_variables/fw.html">$fw</a> = <a class="function" onClick="logFunction('fopen')" href="../../_functions/fopen.html" onMouseOver="funcPopup(event,'fopen')">fopen</a>(<a class="var it2113" onMouseOver="hilite(2113)" onMouseOut="lolite()" onClick="logVariable('newfile')" href="../../_variables/newfile.html">$newfile</a>, 'w');
<a name="l646"><span class="linenum"> 646</span></a>          if (<a class="var it7235" onMouseOver="hilite(7235)" onMouseOut="lolite()" onClick="logVariable('fr')" href="../../_variables/fr.html">$fr</a> &amp;&amp; <a class="var it4154" onMouseOver="hilite(4154)" onMouseOut="lolite()" onClick="logVariable('fw')" href="../../_variables/fw.html">$fw</a>) {
<a name="l647"><span class="linenum"> 647</span></a>              while ((<a class="var it148" onMouseOver="hilite(148)" onMouseOut="lolite()" onClick="logVariable('line')" href="../../_variables/line.html">$line</a> = <a class="phpfunction" onClick="logFunction('fgets')" href="../../_functions/fgets.html" onMouseOver="phpfuncPopup(event,'fgets')">fgets</a>(<a class="var it7235" onMouseOver="hilite(7235)" onMouseOut="lolite()" onClick="logVariable('fr')" href="../../_variables/fr.html">$fr</a>, 4096)) !== false) {
<a name="l648"><span class="linenum"> 648</span></a>                  if (!<a class="var it15365" onMouseOver="hilite(15365)" onMouseOut="lolite()" onClick="logVariable('foundnode')" href="../../_variables/foundnode.html">$foundnode</a> &amp;&amp; <a class="phpfunction" onClick="logFunction('strpos')" href="../../_functions/strpos.html" onMouseOver="phpfuncPopup(event,'strpos')">strpos</a>(<a class="var it148" onMouseOver="hilite(148)" onMouseOut="lolite()" onClick="logVariable('line')" href="../../_variables/line.html">$line</a>, '&lt;gradebook ') === 0) {
<a name="l649"><span class="linenum"> 649</span></a>                      <a class="var it15365" onMouseOver="hilite(15365)" onMouseOut="lolite()" onClick="logVariable('foundnode')" href="../../_variables/foundnode.html">$foundnode</a> = true;
<a name="l650"><span class="linenum"> 650</span></a>                      <a class="var it161" onMouseOver="hilite(161)" onMouseOut="lolite()" onClick="logVariable('matches')" href="../../_variables/matches.html">$matches</a> = array();
<a name="l651"><span class="linenum"> 651</span></a>                      <a class="var it1833" onMouseOver="hilite(1833)" onMouseOut="lolite()" onClick="logVariable('pattern')" href="../../_variables/pattern.html">$pattern</a> = '@calculations_freeze=.([0-9]+).@';
<a name="l652"><span class="linenum"> 652</span></a>                      if (<a class="phpfunction" onClick="logFunction('preg_match')" href="../../_functions/preg_match.html" onMouseOver="phpfuncPopup(event,'preg_match')">preg_match</a>(<a class="var it1833" onMouseOver="hilite(1833)" onMouseOut="lolite()" onClick="logVariable('pattern')" href="../../_variables/pattern.html">$pattern</a>, <a class="var it148" onMouseOver="hilite(148)" onMouseOut="lolite()" onClick="logVariable('line')" href="../../_variables/line.html">$line</a>, <a class="var it161" onMouseOver="hilite(161)" onMouseOut="lolite()" onClick="logVariable('matches')" href="../../_variables/matches.html">$matches</a>)) {
<a name="l653"><span class="linenum"> 653</span></a>                          <a class="var it3918" onMouseOver="hilite(3918)" onMouseOut="lolite()" onClick="logVariable('freeze')" href="../../_variables/freeze.html">$freeze</a> = <a class="var it161" onMouseOver="hilite(161)" onMouseOut="lolite()" onClick="logVariable('matches')" href="../../_variables/matches.html">$matches</a>[1];
<a name="l654"><span class="linenum"> 654</span></a>                          <a class="var it148" onMouseOver="hilite(148)" onMouseOut="lolite()" onClick="logVariable('line')" href="../../_variables/line.html">$line</a> = <a class="phpfunction" onClick="logFunction('preg_replace')" href="../../_functions/preg_replace.html" onMouseOver="phpfuncPopup(event,'preg_replace')">preg_replace</a>(<a class="var it1833" onMouseOver="hilite(1833)" onMouseOut="lolite()" onClick="logVariable('pattern')" href="../../_variables/pattern.html">$pattern</a>, '', <a class="var it148" onMouseOver="hilite(148)" onMouseOut="lolite()" onClick="logVariable('line')" href="../../_variables/line.html">$line</a>);
<a name="l655"><span class="linenum"> 655</span></a>                          <a class="var it148" onMouseOver="hilite(148)" onMouseOut="lolite()" onClick="logVariable('line')" href="../../_variables/line.html">$line</a> .= &quot;  &lt;attributes&gt;\n    &lt;calculations_freeze&gt;<a class="var it3918" onMouseOver="hilite(3918)" onMouseOut="lolite()" onClick="logVariable('freeze')" href="../../_variables/freeze.html">$freeze</a>&lt;/calculations_freeze&gt;\n  &lt;/attributes&gt;\n&quot;;
<a name="l656"><span class="linenum"> 656</span></a>                      }
<a name="l657"><span class="linenum"> 657</span></a>                  }
<a name="l658"><span class="linenum"> 658</span></a>                  <a class="function" onClick="logFunction('fputs')" href="../../_functions/fputs.html" onMouseOver="funcPopup(event,'fputs')">fputs</a>(<a class="var it4154" onMouseOver="hilite(4154)" onMouseOut="lolite()" onClick="logVariable('fw')" href="../../_variables/fw.html">$fw</a>, <a class="var it148" onMouseOver="hilite(148)" onMouseOut="lolite()" onClick="logVariable('line')" href="../../_variables/line.html">$line</a>);
<a name="l659"><span class="linenum"> 659</span></a>              }
<a name="l660"><span class="linenum"> 660</span></a>              if (!<a class="phpfunction" onClick="logFunction('feof')" href="../../_functions/feof.html" onMouseOver="phpfuncPopup(event,'feof')">feof</a>(<a class="var it7235" onMouseOver="hilite(7235)" onMouseOut="lolite()" onClick="logVariable('fr')" href="../../_variables/fr.html">$fr</a>)) {
<a name="l661"><span class="linenum"> 661</span></a>                  throw <span class="keyword">new </span><a class="class" onClick="logClass('restore_step_exception')" href="../../_classes/restore_step_exception.html" onMouseOver="classPopup(event,'restore_step_exception')">restore_step_exception</a>('Error while attempting to rewrite the gradebook step file.');
<a name="l662"><span class="linenum"> 662</span></a>              }
<a name="l663"><span class="linenum"> 663</span></a>              <a class="phpfunction" onClick="logFunction('fclose')" href="../../_functions/fclose.html" onMouseOver="phpfuncPopup(event,'fclose')">fclose</a>(<a class="var it7235" onMouseOver="hilite(7235)" onMouseOut="lolite()" onClick="logVariable('fr')" href="../../_variables/fr.html">$fr</a>);
<a name="l664"><span class="linenum"> 664</span></a>              <a class="phpfunction" onClick="logFunction('fclose')" href="../../_functions/fclose.html" onMouseOver="phpfuncPopup(event,'fclose')">fclose</a>(<a class="var it4154" onMouseOver="hilite(4154)" onMouseOut="lolite()" onClick="logVariable('fw')" href="../../_variables/fw.html">$fw</a>);
<a name="l665"><span class="linenum"> 665</span></a>              if (!<a class="phpfunction" onClick="logFunction('rename')" href="../../_functions/rename.html" onMouseOver="phpfuncPopup(event,'rename')">rename</a>(<a class="var it2113" onMouseOver="hilite(2113)" onMouseOut="lolite()" onClick="logVariable('newfile')" href="../../_variables/newfile.html">$newfile</a>, <a class="var it886" onMouseOver="hilite(886)" onMouseOut="lolite()" onClick="logVariable('filepath')" href="../../_variables/filepath.html">$filepath</a>)) {
<a name="l666"><span class="linenum"> 666</span></a>                  throw <span class="keyword">new </span><a class="class" onClick="logClass('restore_step_exception')" href="../../_classes/restore_step_exception.html" onMouseOver="classPopup(event,'restore_step_exception')">restore_step_exception</a>('Error while attempting to rename the gradebook step file.');
<a name="l667"><span class="linenum"> 667</span></a>              }
<a name="l668"><span class="linenum"> 668</span></a>          } else {
<a name="l669"><span class="linenum"> 669</span></a>              if (<a class="var it7235" onMouseOver="hilite(7235)" onMouseOut="lolite()" onClick="logVariable('fr')" href="../../_variables/fr.html">$fr</a>) {
<a name="l670"><span class="linenum"> 670</span></a>                  <a class="phpfunction" onClick="logFunction('fclose')" href="../../_functions/fclose.html" onMouseOver="phpfuncPopup(event,'fclose')">fclose</a>(<a class="var it7235" onMouseOver="hilite(7235)" onMouseOut="lolite()" onClick="logVariable('fr')" href="../../_variables/fr.html">$fr</a>);
<a name="l671"><span class="linenum"> 671</span></a>              }
<a name="l672"><span class="linenum"> 672</span></a>              if (<a class="var it4154" onMouseOver="hilite(4154)" onMouseOut="lolite()" onClick="logVariable('fw')" href="../../_variables/fw.html">$fw</a>) {
<a name="l673"><span class="linenum"> 673</span></a>                  <a class="phpfunction" onClick="logFunction('fclose')" href="../../_functions/fclose.html" onMouseOver="phpfuncPopup(event,'fclose')">fclose</a>(<a class="var it4154" onMouseOver="hilite(4154)" onMouseOut="lolite()" onClick="logVariable('fw')" href="../../_variables/fw.html">$fw</a>);
<a name="l674"><span class="linenum"> 674</span></a>              }
<a name="l675"><span class="linenum"> 675</span></a>          }
<a name="l676"><span class="linenum"> 676</span></a>      }
<a name="l677"><span class="linenum"> 677</span></a>  
<a name="l678"><span class="linenum"> 678</span></a>  }
<a name="l679"><span class="linenum"> 679</span></a>  
<a name="l680"><span class="linenum"> 680</span></a>  <span class="comment">/**</span>
<a name="l681"><span class="linenum"> 681</span></a>  <span class="comment"> * Step in charge of restoring the grade history of a course.</span>
<a name="l682"><span class="linenum"> 682</span></a>  <span class="comment"> *</span>
<a name="l683"><span class="linenum"> 683</span></a>  <span class="comment"> * The execution conditions are itendical to {@link restore_gradebook_structure_step} because</span>
<a name="l684"><span class="linenum"> 684</span></a>  <span class="comment"> * we do not want to restore the history if the gradebook and its content has not been</span>
<a name="l685"><span class="linenum"> 685</span></a>  <span class="comment"> * restored. At least for now.</span>
<a name="l686"><span class="linenum"> 686</span></a>  <span class="comment"> */</span>
<a name="l687"><span class="linenum"> 687</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_grade_history_structure_step')" href="../../_classes/restore_grade_history_structure_step.html" onMouseOver="classPopup(event,'restore_grade_history_structure_step')">restore_grade_history_structure_step</a> extends restore_structure_step {
<a name="l688"><span class="linenum"> 688</span></a>  
<a name="l689"><span class="linenum"> 689</span></a>       protected function <a class="function" onClick="logFunction('execute_condition')" href="../../_functions/execute_condition.html" onMouseOver="funcPopup(event,'execute_condition')">execute_condition</a>() {
<a name="l690"><span class="linenum"> 690</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l691"><span class="linenum"> 691</span></a>  
<a name="l692"><span class="linenum"> 692</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>() == <a class="constant" onClick="logConstant('SITEID')" href="../../_constants/SITEID.html" onMouseOver="constPopup(event,'SITEID')">SITEID</a>) {
<a name="l693"><span class="linenum"> 693</span></a>              return false;
<a name="l694"><span class="linenum"> 694</span></a>          }
<a name="l695"><span class="linenum"> 695</span></a>  
<a name="l696"><span class="linenum"> 696</span></a>  <span class="comment">        // No gradebook info found, don't execute.</span>
<a name="l697"><span class="linenum"> 697</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_taskbasepath')" href="../../_functions/get_taskbasepath.html" onMouseOver="funcPopup(event,'get_taskbasepath')">get_taskbasepath</a>();
<a name="l698"><span class="linenum"> 698</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="phpfunction" onClick="logFunction('rtrim')" href="../../_functions/rtrim.html" onMouseOver="phpfuncPopup(event,'rtrim')">rtrim</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>, '/') . '/' . <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('filename')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/filename.html">filename</a>;
<a name="l699"><span class="linenum"> 699</span></a>          if (!<a class="phpfunction" onClick="logFunction('file_exists')" href="../../_functions/file_exists.html" onMouseOver="phpfuncPopup(event,'file_exists')">file_exists</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>)) {
<a name="l700"><span class="linenum"> 700</span></a>              return false;
<a name="l701"><span class="linenum"> 701</span></a>          }
<a name="l702"><span class="linenum"> 702</span></a>  
<a name="l703"><span class="linenum"> 703</span></a>  <span class="comment">        // Some module present in backup file isn't available to restore in this site, don't execute.</span>
<a name="l704"><span class="linenum"> 704</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('is_missing_modules')" href="../../_functions/is_missing_modules.html" onMouseOver="funcPopup(event,'is_missing_modules')">is_missing_modules</a>()) {
<a name="l705"><span class="linenum"> 705</span></a>              return false;
<a name="l706"><span class="linenum"> 706</span></a>          }
<a name="l707"><span class="linenum"> 707</span></a>  
<a name="l708"><span class="linenum"> 708</span></a>  <span class="comment">        // Some activity has been excluded to be restored, don't execute.</span>
<a name="l709"><span class="linenum"> 709</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('is_excluding_activities')" href="../../_functions/is_excluding_activities.html" onMouseOver="funcPopup(event,'is_excluding_activities')">is_excluding_activities</a>()) {
<a name="l710"><span class="linenum"> 710</span></a>              return false;
<a name="l711"><span class="linenum"> 711</span></a>          }
<a name="l712"><span class="linenum"> 712</span></a>  
<a name="l713"><span class="linenum"> 713</span></a>  <span class="comment">        // There should only be one grade category (the 1 associated with the course itself).</span>
<a name="l714"><span class="linenum"> 714</span></a>          <a class="var it261" onMouseOver="hilite(261)" onMouseOut="lolite()" onClick="logVariable('category')" href="../../_variables/category.html">$category</a> = new stdclass();
<a name="l715"><span class="linenum"> 715</span></a>          <a class="var it261" onMouseOver="hilite(261)" onMouseOut="lolite()" onClick="logVariable('category')" href="../../_variables/category.html">$category</a>-&gt;<a onClick="logVariable('courseid')" class="var it42970" onMouseOver="hilite(42970)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a>  = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l716"><span class="linenum"> 716</span></a>          <a class="var it15346" onMouseOver="hilite(15346)" onMouseOut="lolite()" onClick="logVariable('catcount')" href="../../_variables/catcount.html">$catcount</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('count_records')" href="../../_functions/count_records.html" onMouseOver="funcPopup(event,'count_records')">count_records</a>('grade_categories', (array)<a class="var it261" onMouseOver="hilite(261)" onMouseOut="lolite()" onClick="logVariable('category')" href="../../_variables/category.html">$category</a>);
<a name="l717"><span class="linenum"> 717</span></a>          if (<a class="var it15346" onMouseOver="hilite(15346)" onMouseOut="lolite()" onClick="logVariable('catcount')" href="../../_variables/catcount.html">$catcount</a> &gt; 1) {
<a name="l718"><span class="linenum"> 718</span></a>              return false;
<a name="l719"><span class="linenum"> 719</span></a>          }
<a name="l720"><span class="linenum"> 720</span></a>  
<a name="l721"><span class="linenum"> 721</span></a>  <span class="comment">        // Arrived here, execute the step.</span>
<a name="l722"><span class="linenum"> 722</span></a>          return true;
<a name="l723"><span class="linenum"> 723</span></a>       }
<a name="l724"><span class="linenum"> 724</span></a>  
<a name="l725"><span class="linenum"> 725</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l726"><span class="linenum"> 726</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array();
<a name="l727"><span class="linenum"> 727</span></a>  
<a name="l728"><span class="linenum"> 728</span></a>  <span class="comment">        // Settings to use.</span>
<a name="l729"><span class="linenum"> 729</span></a>          <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('userinfo')" href="../../_variables/userinfo.html">$userinfo</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('users');
<a name="l730"><span class="linenum"> 730</span></a>          <a class="var it15366" onMouseOver="hilite(15366)" onMouseOut="lolite()" onClick="logVariable('history')" href="../../_variables/history.html">$history</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('grade_histories');
<a name="l731"><span class="linenum"> 731</span></a>  
<a name="l732"><span class="linenum"> 732</span></a>          if (<a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('userinfo')" href="../../_variables/userinfo.html">$userinfo</a> &amp;&amp; <a class="var it15366" onMouseOver="hilite(15366)" onMouseOut="lolite()" onClick="logVariable('history')" href="../../_variables/history.html">$history</a>) {
<a name="l733"><span class="linenum"> 733</span></a>              <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('grade_grade',
<a name="l734"><span class="linenum"> 734</span></a>                 '/grade_history/grade_grades/grade_grade');
<a name="l735"><span class="linenum"> 735</span></a>          }
<a name="l736"><span class="linenum"> 736</span></a>  
<a name="l737"><span class="linenum"> 737</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l738"><span class="linenum"> 738</span></a>      }
<a name="l739"><span class="linenum"> 739</span></a>  
<a name="l740"><span class="linenum"> 740</span></a>      protected function <a class="function" onClick="logFunction('process_grade_grade')" href="../../_functions/process_grade_grade.html" onMouseOver="funcPopup(event,'process_grade_grade')">process_grade_grade</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l741"><span class="linenum"> 741</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l742"><span class="linenum"> 742</span></a>  
<a name="l743"><span class="linenum"> 743</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l744"><span class="linenum"> 744</span></a>          <a class="var it15351" onMouseOver="hilite(15351)" onMouseOut="lolite()" onClick="logVariable('olduserid')" href="../../_variables/olduserid.html">$olduserid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>;
<a name="l745"><span class="linenum"> 745</span></a>          unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>);
<a name="l746"><span class="linenum"> 746</span></a>  
<a name="l747"><span class="linenum"> 747</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>, null);
<a name="l748"><span class="linenum"> 748</span></a>          if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>)) {
<a name="l749"><span class="linenum"> 749</span></a>  <span class="comment">            // Do not apply the date offsets as this is history.</span>
<a name="l750"><span class="linenum"> 750</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('grade_item', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>);
<a name="l751"><span class="linenum"> 751</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('oldid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/oldid.html">oldid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('grade_grades', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('oldid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/oldid.html">oldid</a>);
<a name="l752"><span class="linenum"> 752</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usermodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usermodified.html">usermodified</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usermodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usermodified.html">usermodified</a>, null);
<a name="l753"><span class="linenum"> 753</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('rawscaleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/rawscaleid.html">rawscaleid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('scale', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('rawscaleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/rawscaleid.html">rawscaleid</a>);
<a name="l754"><span class="linenum"> 754</span></a>              <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('grade_grades_history', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l755"><span class="linenum"> 755</span></a>          } else {
<a name="l756"><span class="linenum"> 756</span></a>              <a class="var it276" onMouseOver="hilite(276)" onMouseOut="lolite()" onClick="logVariable('message')" href="../../_variables/message.html">$message</a> = &quot;Mapped user id not found for user id '{<a class="var it15351" onMouseOver="hilite(15351)" onMouseOut="lolite()" onClick="logVariable('olduserid')" href="../../_variables/olduserid.html">$olduserid</a>}', grade item id '{<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>}'&quot;;
<a name="l757"><span class="linenum"> 757</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="phpfunction" onClick="logFunction('log')" href="../../_functions/log.html" onMouseOver="phpfuncPopup(event,'log')">log</a>(<a class="var it276" onMouseOver="hilite(276)" onMouseOut="lolite()" onClick="logVariable('message')" href="../../_variables/message.html">$message</a>, backup::LOG_DEBUG);
<a name="l758"><span class="linenum"> 758</span></a>          }
<a name="l759"><span class="linenum"> 759</span></a>      }
<a name="l760"><span class="linenum"> 760</span></a>  
<a name="l761"><span class="linenum"> 761</span></a>  }
<a name="l762"><span class="linenum"> 762</span></a>  
<a name="l763"><span class="linenum"> 763</span></a>  <span class="comment">/**</span>
<a name="l764"><span class="linenum"> 764</span></a>  <span class="comment"> * decode all the interlinks present in restored content</span>
<a name="l765"><span class="linenum"> 765</span></a>  <span class="comment"> * relying 100% in the restore_decode_processor that handles</span>
<a name="l766"><span class="linenum"> 766</span></a>  <span class="comment"> * both the contents to modify and the rules to be applied</span>
<a name="l767"><span class="linenum"> 767</span></a>  <span class="comment"> */</span>
<a name="l768"><span class="linenum"> 768</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_decode_interlinks')" href="../../_classes/restore_decode_interlinks.html" onMouseOver="classPopup(event,'restore_decode_interlinks')">restore_decode_interlinks</a> extends restore_execution_step {
<a name="l769"><span class="linenum"> 769</span></a>  
<a name="l770"><span class="linenum"> 770</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l771"><span class="linenum"> 771</span></a>  <span class="comment">        // Get the decoder (from the plan)</span>
<a name="l772"><span class="linenum"> 772</span></a>          <a class="var it12733" onMouseOver="hilite(12733)" onMouseOut="lolite()" onClick="logVariable('decoder')" href="../../_variables/decoder.html">$decoder</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_decoder')" href="../../_functions/get_decoder.html" onMouseOver="funcPopup(event,'get_decoder')">get_decoder</a>();
<a name="l773"><span class="linenum"> 773</span></a>          <a class="class" onClick="logClass('restore_decode_processor')" href="../../_classes/restore_decode_processor.html" onMouseOver="classPopup(event,'restore_decode_processor')">restore_decode_processor</a>::<a class="function" onClick="logFunction('register_link_decoders')" href="../../_functions/register_link_decoders.html" onMouseOver="funcPopup(event,'register_link_decoders')">register_link_decoders</a>(<a class="var it12733" onMouseOver="hilite(12733)" onMouseOut="lolite()" onClick="logVariable('decoder')" href="../../_variables/decoder.html">$decoder</a>); <span class="comment">// Add decoder contents and rules</span>
<a name="l774"><span class="linenum"> 774</span></a>  <span class="comment">        // And launch it, everything will be processed</span>
<a name="l775"><span class="linenum"> 775</span></a>          <a class="var it12733" onMouseOver="hilite(12733)" onMouseOut="lolite()" onClick="logVariable('decoder')" href="../../_variables/decoder.html">$decoder</a>-&gt;<a class="function" onClick="logFunction('execute')" href="../../_functions/execute.html" onMouseOver="funcPopup(event,'execute')">execute</a>();
<a name="l776"><span class="linenum"> 776</span></a>      }
<a name="l777"><span class="linenum"> 777</span></a>  }
<a name="l778"><span class="linenum"> 778</span></a>  
<a name="l779"><span class="linenum"> 779</span></a>  <span class="comment">/**</span>
<a name="l780"><span class="linenum"> 780</span></a>  <span class="comment"> * first, ensure that we have no gaps in section numbers</span>
<a name="l781"><span class="linenum"> 781</span></a>  <span class="comment"> * and then, rebuid the course cache</span>
<a name="l782"><span class="linenum"> 782</span></a>  <span class="comment"> */</span>
<a name="l783"><span class="linenum"> 783</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_rebuild_course_cache')" href="../../_classes/restore_rebuild_course_cache.html" onMouseOver="classPopup(event,'restore_rebuild_course_cache')">restore_rebuild_course_cache</a> extends restore_execution_step {
<a name="l784"><span class="linenum"> 784</span></a>  
<a name="l785"><span class="linenum"> 785</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l786"><span class="linenum"> 786</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l787"><span class="linenum"> 787</span></a>  
<a name="l788"><span class="linenum"> 788</span></a>  <span class="comment">        // Although there is some sort of auto-recovery of missing sections</span>
<a name="l789"><span class="linenum"> 789</span></a>  <span class="comment">        // present in course/formats... here we check that all the sections</span>
<a name="l790"><span class="linenum"> 790</span></a>  <span class="comment">        // from 0 to MAX(section-&gt;section) exist, creating them if necessary</span>
<a name="l791"><span class="linenum"> 791</span></a>          <a class="var it9185" onMouseOver="hilite(9185)" onMouseOut="lolite()" onClick="logVariable('maxsection')" href="../../_variables/maxsection.html">$maxsection</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('course_sections', '<a class="phpfunction" onClick="logFunction('MAX')" href="../../_functions/max.html" onMouseOver="phpfuncPopup(event,'max')">MAX</a>(section)', array('course' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>()));
<a name="l792"><span class="linenum"> 792</span></a>  <span class="comment">        // Iterate over all sections</span>
<a name="l793"><span class="linenum"> 793</span></a>          for (<a class="var it107" onMouseOver="hilite(107)" onMouseOut="lolite()" onClick="logVariable('i')" href="../../_variables/i.html">$i</a> = 0; <a class="var it107" onMouseOver="hilite(107)" onMouseOut="lolite()" onClick="logVariable('i')" href="../../_variables/i.html">$i</a> &lt;= <a class="var it9185" onMouseOver="hilite(9185)" onMouseOut="lolite()" onClick="logVariable('maxsection')" href="../../_variables/maxsection.html">$maxsection</a>; <a class="var it107" onMouseOver="hilite(107)" onMouseOut="lolite()" onClick="logVariable('i')" href="../../_variables/i.html">$i</a>++) {
<a name="l794"><span class="linenum"> 794</span></a>  <span class="comment">            // If the section $i doesn't exist, create it</span>
<a name="l795"><span class="linenum"> 795</span></a>              if (!<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists')" href="../../_functions/record_exists.html" onMouseOver="funcPopup(event,'record_exists')">record_exists</a>('course_sections', array('course' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(), 'section' =&gt; <a class="var it107" onMouseOver="hilite(107)" onMouseOut="lolite()" onClick="logVariable('i')" href="../../_variables/i.html">$i</a>))) {
<a name="l796"><span class="linenum"> 796</span></a>                  <a class="var it15367" onMouseOver="hilite(15367)" onMouseOut="lolite()" onClick="logVariable('sectionrec')" href="../../_variables/sectionrec.html">$sectionrec</a> = array(
<a name="l797"><span class="linenum"> 797</span></a>                      'course' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(),
<a name="l798"><span class="linenum"> 798</span></a>                      'section' =&gt; <a class="var it107" onMouseOver="hilite(107)" onMouseOut="lolite()" onClick="logVariable('i')" href="../../_variables/i.html">$i</a>);
<a name="l799"><span class="linenum"> 799</span></a>                  <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('course_sections', <a class="var it15367" onMouseOver="hilite(15367)" onMouseOut="lolite()" onClick="logVariable('sectionrec')" href="../../_variables/sectionrec.html">$sectionrec</a>); <span class="comment">// missing section created</span>
<a name="l800"><span class="linenum"> 800</span></a>              }
<a name="l801"><span class="linenum"> 801</span></a>          }
<a name="l802"><span class="linenum"> 802</span></a>  
<a name="l803"><span class="linenum"> 803</span></a>  <span class="comment">        // Rebuild cache now that all sections are in place</span>
<a name="l804"><span class="linenum"> 804</span></a>          <a class="function" onClick="logFunction('rebuild_course_cache')" href="../../_functions/rebuild_course_cache.html" onMouseOver="funcPopup(event,'rebuild_course_cache')">rebuild_course_cache</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>());
<a name="l805"><span class="linenum"> 805</span></a>          <a class="class" onClick="logClass('cache_helper')" href="../../_classes/cache_helper.html" onMouseOver="classPopup(event,'cache_helper')">cache_helper</a>::<a class="function" onClick="logFunction('purge_by_event')" href="../../_functions/purge_by_event.html" onMouseOver="funcPopup(event,'purge_by_event')">purge_by_event</a>('changesincourse');
<a name="l806"><span class="linenum"> 806</span></a>          <a class="class" onClick="logClass('cache_helper')" href="../../_classes/cache_helper.html" onMouseOver="classPopup(event,'cache_helper')">cache_helper</a>::<a class="function" onClick="logFunction('purge_by_event')" href="../../_functions/purge_by_event.html" onMouseOver="funcPopup(event,'purge_by_event')">purge_by_event</a>('changesincoursecat');
<a name="l807"><span class="linenum"> 807</span></a>      }
<a name="l808"><span class="linenum"> 808</span></a>  }
<a name="l809"><span class="linenum"> 809</span></a>  
<a name="l810"><span class="linenum"> 810</span></a>  <span class="comment">/**</span>
<a name="l811"><span class="linenum"> 811</span></a>  <span class="comment"> * Review all the tasks having one after_restore method</span>
<a name="l812"><span class="linenum"> 812</span></a>  <span class="comment"> * executing it to perform some final adjustments of information</span>
<a name="l813"><span class="linenum"> 813</span></a>  <span class="comment"> * not available when the task was executed.</span>
<a name="l814"><span class="linenum"> 814</span></a>  <span class="comment"> */</span>
<a name="l815"><span class="linenum"> 815</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_execute_after_restore')" href="../../_classes/restore_execute_after_restore.html" onMouseOver="classPopup(event,'restore_execute_after_restore')">restore_execute_after_restore</a> extends restore_execution_step {
<a name="l816"><span class="linenum"> 816</span></a>  
<a name="l817"><span class="linenum"> 817</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l818"><span class="linenum"> 818</span></a>  
<a name="l819"><span class="linenum"> 819</span></a>  <span class="comment">        // Simply call to the execute_after_restore() method of the task</span>
<a name="l820"><span class="linenum"> 820</span></a>  <span class="comment">        // that always is the restore_final_task</span>
<a name="l821"><span class="linenum"> 821</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('launch_execute_after_restore')" href="../../_functions/launch_execute_after_restore.html" onMouseOver="funcPopup(event,'launch_execute_after_restore')">launch_execute_after_restore</a>();
<a name="l822"><span class="linenum"> 822</span></a>      }
<a name="l823"><span class="linenum"> 823</span></a>  }
<a name="l824"><span class="linenum"> 824</span></a>  
<a name="l825"><span class="linenum"> 825</span></a>  
<a name="l826"><span class="linenum"> 826</span></a>  <span class="comment">/**</span>
<a name="l827"><span class="linenum"> 827</span></a>  <span class="comment"> * Review all the (pending) block positions in backup_ids, matching by</span>
<a name="l828"><span class="linenum"> 828</span></a>  <span class="comment"> * contextid, creating positions as needed. This is executed by the</span>
<a name="l829"><span class="linenum"> 829</span></a>  <span class="comment"> * final task, once all the contexts have been created</span>
<a name="l830"><span class="linenum"> 830</span></a>  <span class="comment"> */</span>
<a name="l831"><span class="linenum"> 831</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_review_pending_block_positions')" href="../../_classes/restore_review_pending_block_positions.html" onMouseOver="classPopup(event,'restore_review_pending_block_positions')">restore_review_pending_block_positions</a> extends restore_execution_step {
<a name="l832"><span class="linenum"> 832</span></a>  
<a name="l833"><span class="linenum"> 833</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l834"><span class="linenum"> 834</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l835"><span class="linenum"> 835</span></a>  
<a name="l836"><span class="linenum"> 836</span></a>  <span class="comment">        // Get all the block_position objects pending to match</span>
<a name="l837"><span class="linenum"> 837</span></a>          <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array('backupid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'itemname' =&gt; 'block_position');
<a name="l838"><span class="linenum"> 838</span></a>          <a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_recordset')" href="../../_functions/get_recordset.html" onMouseOver="funcPopup(event,'get_recordset')">get_recordset</a>('backup_ids_temp', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>, '', 'itemid, info');
<a name="l839"><span class="linenum"> 839</span></a>  <span class="comment">        // Process block positions, creating them or accumulating for final step</span>
<a name="l840"><span class="linenum"> 840</span></a>          foreach(<a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a> as <a class="var it15368" onMouseOver="hilite(15368)" onMouseOut="lolite()" onClick="logVariable('posrec')" href="../../_variables/posrec.html">$posrec</a>) {
<a name="l841"><span class="linenum"> 841</span></a>  <span class="comment">            // Get the complete position object out of the info field.</span>
<a name="l842"><span class="linenum"> 842</span></a>              <a class="var it752" onMouseOver="hilite(752)" onMouseOut="lolite()" onClick="logVariable('position')" href="../../_variables/position.html">$position</a> = backup_controller_dbops::<a class="function" onClick="logFunction('decode_backup_temp_info')" href="../../_functions/decode_backup_temp_info.html" onMouseOver="funcPopup(event,'decode_backup_temp_info')">decode_backup_temp_info</a>(<a class="var it15368" onMouseOver="hilite(15368)" onMouseOut="lolite()" onClick="logVariable('posrec')" href="../../_variables/posrec.html">$posrec</a>-&gt;<a onClick="logVariable('info')" class="var it45287" onMouseOver="hilite(45287)" onMouseOut="lolite()" href="../../_variables/info.html">info</a>);
<a name="l843"><span class="linenum"> 843</span></a>  <span class="comment">            // If position is for one already mapped (known) contextid</span>
<a name="l844"><span class="linenum"> 844</span></a>  <span class="comment">            // process it now, creating the position, else nothing to</span>
<a name="l845"><span class="linenum"> 845</span></a>  <span class="comment">            // do, position finally discarded</span>
<a name="l846"><span class="linenum"> 846</span></a>              if (<a class="var it15369" onMouseOver="hilite(15369)" onMouseOut="lolite()" onClick="logVariable('newctx')" href="../../_variables/newctx.html">$newctx</a> = restore_dbops::<a class="function" onClick="logFunction('get_backup_ids_record')" href="../../_functions/get_backup_ids_record.html" onMouseOver="funcPopup(event,'get_backup_ids_record')">get_backup_ids_record</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'context', <a class="var it752" onMouseOver="hilite(752)" onMouseOut="lolite()" onClick="logVariable('position')" href="../../_variables/position.html">$position</a>-&gt;<a onClick="logVariable('contextid')" class="var it45288" onMouseOver="hilite(45288)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a>)) {
<a name="l847"><span class="linenum"> 847</span></a>                  <a class="var it752" onMouseOver="hilite(752)" onMouseOut="lolite()" onClick="logVariable('position')" href="../../_variables/position.html">$position</a>-&gt;<a onClick="logVariable('contextid')" class="var it45288" onMouseOver="hilite(45288)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a> = <a class="var it15369" onMouseOver="hilite(15369)" onMouseOut="lolite()" onClick="logVariable('newctx')" href="../../_variables/newctx.html">$newctx</a>-&gt;<a onClick="logVariable('newitemid')" class="var it45289" onMouseOver="hilite(45289)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>;
<a name="l848"><span class="linenum"> 848</span></a>  <span class="comment">                // Create the block position</span>
<a name="l849"><span class="linenum"> 849</span></a>                  <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('block_positions', <a class="var it752" onMouseOver="hilite(752)" onMouseOut="lolite()" onClick="logVariable('position')" href="../../_variables/position.html">$position</a>);
<a name="l850"><span class="linenum"> 850</span></a>              }
<a name="l851"><span class="linenum"> 851</span></a>          }
<a name="l852"><span class="linenum"> 852</span></a>          <a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a>-&gt;<a class="function" onClick="logFunction('close')" href="../../_functions/close.html" onMouseOver="funcPopup(event,'close')">close</a>();
<a name="l853"><span class="linenum"> 853</span></a>      }
<a name="l854"><span class="linenum"> 854</span></a>  }
<a name="l855"><span class="linenum"> 855</span></a>  
<a name="l856"><span class="linenum"> 856</span></a>  
<a name="l857"><span class="linenum"> 857</span></a>  <span class="comment">/**</span>
<a name="l858"><span class="linenum"> 858</span></a>  <span class="comment"> * Updates the availability data for course modules and sections.</span>
<a name="l859"><span class="linenum"> 859</span></a>  <span class="comment"> *</span>
<a name="l860"><span class="linenum"> 860</span></a>  <span class="comment"> * Runs after the restore of all course modules, sections, and grade items has</span>
<a name="l861"><span class="linenum"> 861</span></a>  <span class="comment"> * completed. This is necessary in order to update IDs that have changed during</span>
<a name="l862"><span class="linenum"> 862</span></a>  <span class="comment"> * restore.</span>
<a name="l863"><span class="linenum"> 863</span></a>  <span class="comment"> *</span>
<a name="l864"><span class="linenum"> 864</span></a>  <span class="comment"> * @package core_backup</span>
<a name="l865"><span class="linenum"> 865</span></a>  <span class="comment"> * @copyright 2014 The Open University</span>
<a name="l866"><span class="linenum"> 866</span></a>  <span class="comment"> * @license http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later</span>
<a name="l867"><span class="linenum"> 867</span></a>  <span class="comment"> */</span>
<a name="l868"><span class="linenum"> 868</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_update_availability')" href="../../_classes/restore_update_availability.html" onMouseOver="classPopup(event,'restore_update_availability')">restore_update_availability</a> extends restore_execution_step {
<a name="l869"><span class="linenum"> 869</span></a>  
<a name="l870"><span class="linenum"> 870</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l871"><span class="linenum"> 871</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l872"><span class="linenum"> 872</span></a>  
<a name="l873"><span class="linenum"> 873</span></a>  <span class="comment">        // Note: This code runs even if availability is disabled when restoring.</span>
<a name="l874"><span class="linenum"> 874</span></a>  <span class="comment">        // That will ensure that if you later turn availability on for the site,</span>
<a name="l875"><span class="linenum"> 875</span></a>  <span class="comment">        // there will be no incorrect IDs. (It doesn't take long if the restored</span>
<a name="l876"><span class="linenum"> 876</span></a>  <span class="comment">        // data does not contain any availability information.)</span>
<a name="l877"><span class="linenum"> 877</span></a>  
<a name="l878"><span class="linenum"> 878</span></a>  <span class="comment">        // Get modinfo with all data after resetting cache.</span>
<a name="l879"><span class="linenum"> 879</span></a>          <a class="function" onClick="logFunction('rebuild_course_cache')" href="../../_functions/rebuild_course_cache.html" onMouseOver="funcPopup(event,'rebuild_course_cache')">rebuild_course_cache</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(), true);
<a name="l880"><span class="linenum"> 880</span></a>          <a class="var it697" onMouseOver="hilite(697)" onMouseOut="lolite()" onClick="logVariable('modinfo')" href="../../_variables/modinfo.html">$modinfo</a> = <a class="function" onClick="logFunction('get_fast_modinfo')" href="../../_functions/get_fast_modinfo.html" onMouseOver="funcPopup(event,'get_fast_modinfo')">get_fast_modinfo</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>());
<a name="l881"><span class="linenum"> 881</span></a>  
<a name="l882"><span class="linenum"> 882</span></a>  <span class="comment">        // Get the date offset for this restore.</span>
<a name="l883"><span class="linenum"> 883</span></a>          <a class="var it15370" onMouseOver="hilite(15370)" onMouseOut="lolite()" onClick="logVariable('dateoffset')" href="../../_variables/dateoffset.html">$dateoffset</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(1) - 1;
<a name="l884"><span class="linenum"> 884</span></a>  
<a name="l885"><span class="linenum"> 885</span></a>  <span class="comment">        // Update all sections that were restored.</span>
<a name="l886"><span class="linenum"> 886</span></a>          <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array('backupid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'itemname' =&gt; 'course_section');
<a name="l887"><span class="linenum"> 887</span></a>          <a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_recordset')" href="../../_functions/get_recordset.html" onMouseOver="funcPopup(event,'get_recordset')">get_recordset</a>('backup_ids_temp', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>, '', 'newitemid');
<a name="l888"><span class="linenum"> 888</span></a>          <a class="var it15371" onMouseOver="hilite(15371)" onMouseOut="lolite()" onClick="logVariable('sectionsbyid')" href="../../_variables/sectionsbyid.html">$sectionsbyid</a> = null;
<a name="l889"><span class="linenum"> 889</span></a>          foreach (<a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a> as <a class="var it1069" onMouseOver="hilite(1069)" onMouseOut="lolite()" onClick="logVariable('rec')" href="../../_variables/rec.html">$rec</a>) {
<a name="l890"><span class="linenum"> 890</span></a>              if (<a class="phpfunction" onClick="logFunction('is_null')" href="../../_functions/is_null.html" onMouseOver="phpfuncPopup(event,'is_null')">is_null</a>(<a class="var it15371" onMouseOver="hilite(15371)" onMouseOut="lolite()" onClick="logVariable('sectionsbyid')" href="../../_variables/sectionsbyid.html">$sectionsbyid</a>)) {
<a name="l891"><span class="linenum"> 891</span></a>                  <a class="var it15371" onMouseOver="hilite(15371)" onMouseOut="lolite()" onClick="logVariable('sectionsbyid')" href="../../_variables/sectionsbyid.html">$sectionsbyid</a> = array();
<a name="l892"><span class="linenum"> 892</span></a>                  foreach (<a class="var it697" onMouseOver="hilite(697)" onMouseOut="lolite()" onClick="logVariable('modinfo')" href="../../_variables/modinfo.html">$modinfo</a>-&gt;<a class="function" onClick="logFunction('get_section_info_all')" href="../../_functions/get_section_info_all.html" onMouseOver="funcPopup(event,'get_section_info_all')">get_section_info_all</a>() as <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>) {
<a name="l893"><span class="linenum"> 893</span></a>                      <a class="var it15371" onMouseOver="hilite(15371)" onMouseOut="lolite()" onClick="logVariable('sectionsbyid')" href="../../_variables/sectionsbyid.html">$sectionsbyid</a>[<a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>-&gt;<a onClick="logVariable('id')" class="var it43306" onMouseOver="hilite(43306)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>] = <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>;
<a name="l894"><span class="linenum"> 894</span></a>                  }
<a name="l895"><span class="linenum"> 895</span></a>              }
<a name="l896"><span class="linenum"> 896</span></a>              if (!<a class="phpfunction" onClick="logFunction('array_key_exists')" href="../../_functions/array_key_exists.html" onMouseOver="phpfuncPopup(event,'array_key_exists')">array_key_exists</a>(<a class="var it1069" onMouseOver="hilite(1069)" onMouseOut="lolite()" onClick="logVariable('rec')" href="../../_variables/rec.html">$rec</a>-&gt;<a onClick="logVariable('newitemid')" class="var it43253" onMouseOver="hilite(43253)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>, <a class="var it15371" onMouseOver="hilite(15371)" onMouseOut="lolite()" onClick="logVariable('sectionsbyid')" href="../../_variables/sectionsbyid.html">$sectionsbyid</a>)) {
<a name="l897"><span class="linenum"> 897</span></a>  <span class="comment">                // If the section was not fully restored for some reason</span>
<a name="l898"><span class="linenum"> 898</span></a>  <span class="comment">                // (e.g. due to an earlier error), skip it.</span>
<a name="l899"><span class="linenum"> 899</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_logger')" href="../../_functions/get_logger.html" onMouseOver="funcPopup(event,'get_logger')">get_logger</a>()-&gt;<a class="function" onClick="logFunction('process')" href="../../_functions/process.html" onMouseOver="funcPopup(event,'process')">process</a>('Section not fully restored: id ' .
<a name="l900"><span class="linenum"> 900</span></a>                          <a class="var it1069" onMouseOver="hilite(1069)" onMouseOut="lolite()" onClick="logVariable('rec')" href="../../_variables/rec.html">$rec</a>-&gt;<a onClick="logVariable('newitemid')" class="var it43253" onMouseOver="hilite(43253)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>, backup::LOG_WARNING);
<a name="l901"><span class="linenum"> 901</span></a>                  continue;
<a name="l902"><span class="linenum"> 902</span></a>              }
<a name="l903"><span class="linenum"> 903</span></a>              <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a> = <a class="var it15371" onMouseOver="hilite(15371)" onMouseOut="lolite()" onClick="logVariable('sectionsbyid')" href="../../_variables/sectionsbyid.html">$sectionsbyid</a>[<a class="var it1069" onMouseOver="hilite(1069)" onMouseOut="lolite()" onClick="logVariable('rec')" href="../../_variables/rec.html">$rec</a>-&gt;<a onClick="logVariable('newitemid')" class="var it43253" onMouseOver="hilite(43253)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>];
<a name="l904"><span class="linenum"> 904</span></a>              if (!<a class="phpfunction" onClick="logFunction('is_null')" href="../../_functions/is_null.html" onMouseOver="phpfuncPopup(event,'is_null')">is_null</a>(<a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>-&gt;<a onClick="logVariable('availability')" class="var it43306" onMouseOver="hilite(43306)" onMouseOut="lolite()" href="../../_variables/availability.html">availability</a>)) {
<a name="l905"><span class="linenum"> 905</span></a>                  <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a> = new \core_availability\info_section(<a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>);
<a name="l906"><span class="linenum"> 906</span></a>                  <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a class="function" onClick="logFunction('update_after_restore')" href="../../_functions/update_after_restore.html" onMouseOver="funcPopup(event,'update_after_restore')">update_after_restore</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(),
<a name="l907"><span class="linenum"> 907</span></a>                          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_logger')" href="../../_functions/get_logger.html" onMouseOver="funcPopup(event,'get_logger')">get_logger</a>(), <a class="var it15370" onMouseOver="hilite(15370)" onMouseOut="lolite()" onClick="logVariable('dateoffset')" href="../../_variables/dateoffset.html">$dateoffset</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>);
<a name="l908"><span class="linenum"> 908</span></a>              }
<a name="l909"><span class="linenum"> 909</span></a>          }
<a name="l910"><span class="linenum"> 910</span></a>          <a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a>-&gt;<a class="function" onClick="logFunction('close')" href="../../_functions/close.html" onMouseOver="funcPopup(event,'close')">close</a>();
<a name="l911"><span class="linenum"> 911</span></a>  
<a name="l912"><span class="linenum"> 912</span></a>  <span class="comment">        // Update all modules that were restored.</span>
<a name="l913"><span class="linenum"> 913</span></a>          <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array('backupid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'itemname' =&gt; 'course_module');
<a name="l914"><span class="linenum"> 914</span></a>          <a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_recordset')" href="../../_functions/get_recordset.html" onMouseOver="funcPopup(event,'get_recordset')">get_recordset</a>('backup_ids_temp', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>, '', 'newitemid');
<a name="l915"><span class="linenum"> 915</span></a>          foreach (<a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a> as <a class="var it1069" onMouseOver="hilite(1069)" onMouseOut="lolite()" onClick="logVariable('rec')" href="../../_variables/rec.html">$rec</a>) {
<a name="l916"><span class="linenum"> 916</span></a>              if (!<a class="phpfunction" onClick="logFunction('array_key_exists')" href="../../_functions/array_key_exists.html" onMouseOver="phpfuncPopup(event,'array_key_exists')">array_key_exists</a>(<a class="var it1069" onMouseOver="hilite(1069)" onMouseOut="lolite()" onClick="logVariable('rec')" href="../../_variables/rec.html">$rec</a>-&gt;<a onClick="logVariable('newitemid')" class="var it43253" onMouseOver="hilite(43253)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>, <a class="var it697" onMouseOver="hilite(697)" onMouseOut="lolite()" onClick="logVariable('modinfo')" href="../../_variables/modinfo.html">$modinfo</a>-&gt;<a onClick="logVariable('cms')" class="var it43006" onMouseOver="hilite(43006)" onMouseOut="lolite()" href="../../_variables/cms.html">cms</a>)) {
<a name="l917"><span class="linenum"> 917</span></a>  <span class="comment">                // If the module was not fully restored for some reason</span>
<a name="l918"><span class="linenum"> 918</span></a>  <span class="comment">                // (e.g. due to an earlier error), skip it.</span>
<a name="l919"><span class="linenum"> 919</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_logger')" href="../../_functions/get_logger.html" onMouseOver="funcPopup(event,'get_logger')">get_logger</a>()-&gt;<a class="function" onClick="logFunction('process')" href="../../_functions/process.html" onMouseOver="funcPopup(event,'process')">process</a>('Module not fully restored: id ' .
<a name="l920"><span class="linenum"> 920</span></a>                          <a class="var it1069" onMouseOver="hilite(1069)" onMouseOut="lolite()" onClick="logVariable('rec')" href="../../_variables/rec.html">$rec</a>-&gt;<a onClick="logVariable('newitemid')" class="var it43253" onMouseOver="hilite(43253)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>, backup::LOG_WARNING);
<a name="l921"><span class="linenum"> 921</span></a>                  continue;
<a name="l922"><span class="linenum"> 922</span></a>              }
<a name="l923"><span class="linenum"> 923</span></a>              <a class="var it22" onMouseOver="hilite(22)" onMouseOut="lolite()" onClick="logVariable('cm')" href="../../_variables/cm.html">$cm</a> = <a class="var it697" onMouseOver="hilite(697)" onMouseOut="lolite()" onClick="logVariable('modinfo')" href="../../_variables/modinfo.html">$modinfo</a>-&gt;<a class="function" onClick="logFunction('get_cm')" href="../../_functions/get_cm.html" onMouseOver="funcPopup(event,'get_cm')">get_cm</a>(<a class="var it1069" onMouseOver="hilite(1069)" onMouseOut="lolite()" onClick="logVariable('rec')" href="../../_variables/rec.html">$rec</a>-&gt;<a onClick="logVariable('newitemid')" class="var it43253" onMouseOver="hilite(43253)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>);
<a name="l924"><span class="linenum"> 924</span></a>              if (!<a class="phpfunction" onClick="logFunction('is_null')" href="../../_functions/is_null.html" onMouseOver="phpfuncPopup(event,'is_null')">is_null</a>(<a class="var it22" onMouseOver="hilite(22)" onMouseOut="lolite()" onClick="logVariable('cm')" href="../../_variables/cm.html">$cm</a>-&gt;<a onClick="logVariable('availability')" class="var it42905" onMouseOver="hilite(42905)" onMouseOut="lolite()" href="../../_variables/availability.html">availability</a>)) {
<a name="l925"><span class="linenum"> 925</span></a>                  <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a> = new \core_availability\info_module(<a class="var it22" onMouseOver="hilite(22)" onMouseOut="lolite()" onClick="logVariable('cm')" href="../../_variables/cm.html">$cm</a>);
<a name="l926"><span class="linenum"> 926</span></a>                  <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a class="function" onClick="logFunction('update_after_restore')" href="../../_functions/update_after_restore.html" onMouseOver="funcPopup(event,'update_after_restore')">update_after_restore</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(),
<a name="l927"><span class="linenum"> 927</span></a>                          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_logger')" href="../../_functions/get_logger.html" onMouseOver="funcPopup(event,'get_logger')">get_logger</a>(), <a class="var it15370" onMouseOver="hilite(15370)" onMouseOut="lolite()" onClick="logVariable('dateoffset')" href="../../_variables/dateoffset.html">$dateoffset</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>);
<a name="l928"><span class="linenum"> 928</span></a>              }
<a name="l929"><span class="linenum"> 929</span></a>          }
<a name="l930"><span class="linenum"> 930</span></a>          <a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a>-&gt;<a class="function" onClick="logFunction('close')" href="../../_functions/close.html" onMouseOver="funcPopup(event,'close')">close</a>();
<a name="l931"><span class="linenum"> 931</span></a>      }
<a name="l932"><span class="linenum"> 932</span></a>  }
<a name="l933"><span class="linenum"> 933</span></a>  
<a name="l934"><span class="linenum"> 934</span></a>  
<a name="l935"><span class="linenum"> 935</span></a>  <span class="comment">/**</span>
<a name="l936"><span class="linenum"> 936</span></a>  <span class="comment"> * Process legacy module availability records in backup_ids.</span>
<a name="l937"><span class="linenum"> 937</span></a>  <span class="comment"> *</span>
<a name="l938"><span class="linenum"> 938</span></a>  <span class="comment"> * Matches course modules and grade item id once all them have been already restored.</span>
<a name="l939"><span class="linenum"> 939</span></a>  <span class="comment"> * Only if all matchings are satisfied the availability condition will be created.</span>
<a name="l940"><span class="linenum"> 940</span></a>  <span class="comment"> * At the same time, it is required for the site to have that functionality enabled.</span>
<a name="l941"><span class="linenum"> 941</span></a>  <span class="comment"> *</span>
<a name="l942"><span class="linenum"> 942</span></a>  <span class="comment"> * This step is included only to handle legacy backups (2.6 and before). It does not</span>
<a name="l943"><span class="linenum"> 943</span></a>  <span class="comment"> * do anything for newer backups.</span>
<a name="l944"><span class="linenum"> 944</span></a>  <span class="comment"> *</span>
<a name="l945"><span class="linenum"> 945</span></a>  <span class="comment"> * @copyright 2014 The Open University</span>
<a name="l946"><span class="linenum"> 946</span></a>  <span class="comment"> * @license http://www.gnu.org/copyleft/gpl.html GNU Public License</span>
<a name="l947"><span class="linenum"> 947</span></a>  <span class="comment"> */</span>
<a name="l948"><span class="linenum"> 948</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_process_course_modules_availability')" href="../../_classes/restore_process_course_modules_availability.html" onMouseOver="classPopup(event,'restore_process_course_modules_availability')">restore_process_course_modules_availability</a> extends restore_execution_step {
<a name="l949"><span class="linenum"> 949</span></a>  
<a name="l950"><span class="linenum"> 950</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l951"><span class="linenum"> 951</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l952"><span class="linenum"> 952</span></a>  
<a name="l953"><span class="linenum"> 953</span></a>  <span class="comment">        // Site hasn't availability enabled</span>
<a name="l954"><span class="linenum"> 954</span></a>          if (empty(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('enableavailability')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/enableavailability.html">enableavailability</a>)) {
<a name="l955"><span class="linenum"> 955</span></a>              return;
<a name="l956"><span class="linenum"> 956</span></a>          }
<a name="l957"><span class="linenum"> 957</span></a>  
<a name="l958"><span class="linenum"> 958</span></a>  <span class="comment">        // Do both modules and sections.</span>
<a name="l959"><span class="linenum"> 959</span></a>          foreach (array('module', 'section') as <a class="var it61" onMouseOver="hilite(61)" onMouseOut="lolite()" onClick="logVariable('table')" href="../../_variables/table.html">$table</a>) {
<a name="l960"><span class="linenum"> 960</span></a>  <span class="comment">            // Get all the availability objects to process.</span>
<a name="l961"><span class="linenum"> 961</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array('backupid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'itemname' =&gt; <a class="var it61" onMouseOver="hilite(61)" onMouseOut="lolite()" onClick="logVariable('table')" href="../../_variables/table.html">$table</a> . '_availability');
<a name="l962"><span class="linenum"> 962</span></a>              <a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_recordset')" href="../../_functions/get_recordset.html" onMouseOver="funcPopup(event,'get_recordset')">get_recordset</a>('backup_ids_temp', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>, '', 'itemid, info');
<a name="l963"><span class="linenum"> 963</span></a>  <span class="comment">            // Process availabilities, creating them if everything matches ok.</span>
<a name="l964"><span class="linenum"> 964</span></a>              foreach (<a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a> as <a class="var it15372" onMouseOver="hilite(15372)" onMouseOut="lolite()" onClick="logVariable('availrec')" href="../../_variables/availrec.html">$availrec</a>) {
<a name="l965"><span class="linenum"> 965</span></a>                  <a class="var it15373" onMouseOver="hilite(15373)" onMouseOut="lolite()" onClick="logVariable('allmatchesok')" href="../../_variables/allmatchesok.html">$allmatchesok</a> = true;
<a name="l966"><span class="linenum"> 966</span></a>  <span class="comment">                // Get the complete legacy availability object.</span>
<a name="l967"><span class="linenum"> 967</span></a>                  <a class="var it8486" onMouseOver="hilite(8486)" onMouseOut="lolite()" onClick="logVariable('availability')" href="../../_variables/availability.html">$availability</a> = backup_controller_dbops::<a class="function" onClick="logFunction('decode_backup_temp_info')" href="../../_functions/decode_backup_temp_info.html" onMouseOver="funcPopup(event,'decode_backup_temp_info')">decode_backup_temp_info</a>(<a class="var it15372" onMouseOver="hilite(15372)" onMouseOut="lolite()" onClick="logVariable('availrec')" href="../../_variables/availrec.html">$availrec</a>-&gt;<a onClick="logVariable('info')" class="var it45290" onMouseOver="hilite(45290)" onMouseOut="lolite()" href="../../_variables/info.html">info</a>);
<a name="l968"><span class="linenum"> 968</span></a>  
<a name="l969"><span class="linenum"> 969</span></a>  <span class="comment">                // Note: This code used to update IDs, but that is now handled by the</span>
<a name="l970"><span class="linenum"> 970</span></a>  <span class="comment">                // current code (after restore) instead of this legacy code.</span>
<a name="l971"><span class="linenum"> 971</span></a>  
<a name="l972"><span class="linenum"> 972</span></a>  <span class="comment">                // Get showavailability option.</span>
<a name="l973"><span class="linenum"> 973</span></a>                  <a class="var it2134" onMouseOver="hilite(2134)" onMouseOut="lolite()" onClick="logVariable('thingid')" href="../../_variables/thingid.html">$thingid</a> = (<a class="var it61" onMouseOver="hilite(61)" onMouseOut="lolite()" onClick="logVariable('table')" href="../../_variables/table.html">$table</a> === 'module') ? <a class="var it8486" onMouseOver="hilite(8486)" onMouseOut="lolite()" onClick="logVariable('availability')" href="../../_variables/availability.html">$availability</a>-&gt;<a onClick="logVariable('coursemoduleid')" class="var it45291" onMouseOver="hilite(45291)" onMouseOut="lolite()" href="../../_variables/coursemoduleid.html">coursemoduleid</a> :
<a name="l974"><span class="linenum"> 974</span></a>                          <a class="var it8486" onMouseOver="hilite(8486)" onMouseOut="lolite()" onClick="logVariable('availability')" href="../../_variables/availability.html">$availability</a>-&gt;<a onClick="logVariable('coursesectionid')" class="var it45291" onMouseOver="hilite(45291)" onMouseOut="lolite()" href="../../_variables/coursesectionid.html">coursesectionid</a>;
<a name="l975"><span class="linenum"> 975</span></a>                  <a class="var it15376" onMouseOver="hilite(15376)" onMouseOut="lolite()" onClick="logVariable('showrec')" href="../../_variables/showrec.html">$showrec</a> = restore_dbops::<a class="function" onClick="logFunction('get_backup_ids_record')" href="../../_functions/get_backup_ids_record.html" onMouseOver="funcPopup(event,'get_backup_ids_record')">get_backup_ids_record</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(),
<a name="l976"><span class="linenum"> 976</span></a>                          <a class="var it61" onMouseOver="hilite(61)" onMouseOut="lolite()" onClick="logVariable('table')" href="../../_variables/table.html">$table</a> . '_showavailability', <a class="var it2134" onMouseOver="hilite(2134)" onMouseOut="lolite()" onClick="logVariable('thingid')" href="../../_variables/thingid.html">$thingid</a>);
<a name="l977"><span class="linenum"> 977</span></a>                  if (!<a class="var it15376" onMouseOver="hilite(15376)" onMouseOut="lolite()" onClick="logVariable('showrec')" href="../../_variables/showrec.html">$showrec</a>) {
<a name="l978"><span class="linenum"> 978</span></a>  <span class="comment">                    // Should not happen.</span>
<a name="l979"><span class="linenum"> 979</span></a>                      throw <span class="keyword">new </span><a class="class" onClick="logClass('coding_exception')" href="../../_classes/coding_exception.html" onMouseOver="classPopup(event,'coding_exception')">coding_exception</a>('No matching showavailability record');
<a name="l980"><span class="linenum"> 980</span></a>                  }
<a name="l981"><span class="linenum"> 981</span></a>                  <a class="var it1794" onMouseOver="hilite(1794)" onMouseOut="lolite()" onClick="logVariable('show')" href="../../_variables/show.html">$show</a> = <a class="var it15376" onMouseOver="hilite(15376)" onMouseOut="lolite()" onClick="logVariable('showrec')" href="../../_variables/showrec.html">$showrec</a>-&gt;<a onClick="logVariable('info')" class="var it45292" onMouseOver="hilite(45292)" onMouseOut="lolite()" href="../../_variables/info.html">info</a>-&gt;showavailability;
<a name="l982"><span class="linenum"> 982</span></a>  
<a name="l983"><span class="linenum"> 983</span></a>  <span class="comment">                // The $availability object is now in the format used in the old</span>
<a name="l984"><span class="linenum"> 984</span></a>  <span class="comment">                // system. Interpret this and convert to new system.</span>
<a name="l985"><span class="linenum"> 985</span></a>                  <a class="var it15377" onMouseOver="hilite(15377)" onMouseOut="lolite()" onClick="logVariable('currentvalue')" href="../../_variables/currentvalue.html">$currentvalue</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('course_' . <a class="var it61" onMouseOver="hilite(61)" onMouseOut="lolite()" onClick="logVariable('table')" href="../../_variables/table.html">$table</a> . 's', 'availability',
<a name="l986"><span class="linenum"> 986</span></a>                          array('id' =&gt; <a class="var it2134" onMouseOver="hilite(2134)" onMouseOut="lolite()" onClick="logVariable('thingid')" href="../../_variables/thingid.html">$thingid</a>), <a class="constant" onClick="logConstant('MUST_EXIST')" href="../../_constants/MUST_EXIST.html" onMouseOver="constPopup(event,'MUST_EXIST')">MUST_EXIST</a>);
<a name="l987"><span class="linenum"> 987</span></a>                  <a class="var it3475" onMouseOver="hilite(3475)" onMouseOut="lolite()" onClick="logVariable('newvalue')" href="../../_variables/newvalue.html">$newvalue</a> = \core_availability\<a class="class" onClick="logClass('info')" href="../../_classes/info.html" onMouseOver="classPopup(event,'info')">info</a>::<a class="function" onClick="logFunction('add_legacy_availability_condition')" href="../../_functions/add_legacy_availability_condition.html" onMouseOver="funcPopup(event,'add_legacy_availability_condition')">add_legacy_availability_condition</a>(
<a name="l988"><span class="linenum"> 988</span></a>                          <a class="var it15377" onMouseOver="hilite(15377)" onMouseOut="lolite()" onClick="logVariable('currentvalue')" href="../../_variables/currentvalue.html">$currentvalue</a>, <a class="var it8486" onMouseOver="hilite(8486)" onMouseOut="lolite()" onClick="logVariable('availability')" href="../../_variables/availability.html">$availability</a>, <a class="var it1794" onMouseOver="hilite(1794)" onMouseOut="lolite()" onClick="logVariable('show')" href="../../_variables/show.html">$show</a>);
<a name="l989"><span class="linenum"> 989</span></a>                  <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('set_field')" href="../../_functions/set_field.html" onMouseOver="funcPopup(event,'set_field')">set_field</a>('course_' . <a class="var it61" onMouseOver="hilite(61)" onMouseOut="lolite()" onClick="logVariable('table')" href="../../_variables/table.html">$table</a> . 's', 'availability', <a class="var it3475" onMouseOver="hilite(3475)" onMouseOut="lolite()" onClick="logVariable('newvalue')" href="../../_variables/newvalue.html">$newvalue</a>,
<a name="l990"><span class="linenum"> 990</span></a>                          array('id' =&gt; <a class="var it2134" onMouseOver="hilite(2134)" onMouseOut="lolite()" onClick="logVariable('thingid')" href="../../_variables/thingid.html">$thingid</a>));
<a name="l991"><span class="linenum"> 991</span></a>              }
<a name="l992"><span class="linenum"> 992</span></a>          }
<a name="l993"><span class="linenum"> 993</span></a>          <a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a>-&gt;<a class="function" onClick="logFunction('close')" href="../../_functions/close.html" onMouseOver="funcPopup(event,'close')">close</a>();
<a name="l994"><span class="linenum"> 994</span></a>      }
<a name="l995"><span class="linenum"> 995</span></a>  }
<a name="l996"><span class="linenum"> 996</span></a>  
<a name="l997"><span class="linenum"> 997</span></a>  
<a name="l998"><span class="linenum"> 998</span></a>  <span class="comment">/*</span>
<a name="l999"><span class="linenum"> 999</span></a>  <span class="comment"> * Execution step that, *conditionally* (if there isn't preloaded information)</span>
<a name="l1000"><span class="linenum">1000</span></a>  <span class="comment"> * will load the inforef files for all the included course/section/activity tasks</span>
<a name="l1001"><span class="linenum">1001</span></a>  <span class="comment"> * to backup_temp_ids. They will be stored with &quot;xxxxref&quot; as itemname</span>
<a name="l1002"><span class="linenum">1002</span></a>  <span class="comment"> */</span>
<a name="l1003"><span class="linenum">1003</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_load_included_inforef_records')" href="../../_classes/restore_load_included_inforef_records.html" onMouseOver="classPopup(event,'restore_load_included_inforef_records')">restore_load_included_inforef_records</a> extends restore_execution_step {
<a name="l1004"><span class="linenum">1004</span></a>  
<a name="l1005"><span class="linenum">1005</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l1006"><span class="linenum">1006</span></a>  
<a name="l1007"><span class="linenum">1007</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_preloaded_information')" href="../../_functions/get_preloaded_information.html" onMouseOver="funcPopup(event,'get_preloaded_information')">get_preloaded_information</a>()) { // if info is already preloaded, nothing to do
<a name="l1008"><span class="linenum">1008</span></a>              return;
<a name="l1009"><span class="linenum">1009</span></a>          }
<a name="l1010"><span class="linenum">1010</span></a>  
<a name="l1011"><span class="linenum">1011</span></a>  <span class="comment">        // Get all the included tasks</span>
<a name="l1012"><span class="linenum">1012</span></a>          <a class="var it110" onMouseOver="hilite(110)" onMouseOut="lolite()" onClick="logVariable('tasks')" href="../../_variables/tasks.html">$tasks</a> = restore_dbops::<a class="function" onClick="logFunction('get_included_tasks')" href="../../_functions/get_included_tasks.html" onMouseOver="funcPopup(event,'get_included_tasks')">get_included_tasks</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>());
<a name="l1013"><span class="linenum">1013</span></a>          <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_progress')" href="../../_functions/get_progress.html" onMouseOver="funcPopup(event,'get_progress')">get_progress</a>();
<a name="l1014"><span class="linenum">1014</span></a>          <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>-&gt;<a class="function" onClick="logFunction('start_progress')" href="../../_functions/start_progress.html" onMouseOver="funcPopup(event,'start_progress')">start_progress</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_name')" href="../../_functions/get_name.html" onMouseOver="funcPopup(event,'get_name')">get_name</a>(), <a class="phpfunction" onClick="logFunction('count')" href="../../_functions/count.html" onMouseOver="phpfuncPopup(event,'count')">count</a>(<a class="var it110" onMouseOver="hilite(110)" onMouseOut="lolite()" onClick="logVariable('tasks')" href="../../_variables/tasks.html">$tasks</a>));
<a name="l1015"><span class="linenum">1015</span></a>          foreach (<a class="var it110" onMouseOver="hilite(110)" onMouseOut="lolite()" onClick="logVariable('tasks')" href="../../_variables/tasks.html">$tasks</a> as <a class="var it720" onMouseOver="hilite(720)" onMouseOut="lolite()" onClick="logVariable('task')" href="../../_variables/task.html">$task</a>) {
<a name="l1016"><span class="linenum">1016</span></a>  <span class="comment">            // Load the inforef.xml file if exists</span>
<a name="l1017"><span class="linenum">1017</span></a>              <a class="var it10894" onMouseOver="hilite(10894)" onMouseOut="lolite()" onClick="logVariable('inforefpath')" href="../../_variables/inforefpath.html">$inforefpath</a> = <a class="var it720" onMouseOver="hilite(720)" onMouseOut="lolite()" onClick="logVariable('task')" href="../../_variables/task.html">$task</a>-&gt;<a class="function" onClick="logFunction('get_taskbasepath')" href="../../_functions/get_taskbasepath.html" onMouseOver="funcPopup(event,'get_taskbasepath')">get_taskbasepath</a>() . '/inforef.xml';
<a name="l1018"><span class="linenum">1018</span></a>              if (<a class="phpfunction" onClick="logFunction('file_exists')" href="../../_functions/file_exists.html" onMouseOver="phpfuncPopup(event,'file_exists')">file_exists</a>(<a class="var it10894" onMouseOver="hilite(10894)" onMouseOut="lolite()" onClick="logVariable('inforefpath')" href="../../_variables/inforefpath.html">$inforefpath</a>)) {
<a name="l1019"><span class="linenum">1019</span></a>  <span class="comment">                // Load each inforef file to temp_ids.</span>
<a name="l1020"><span class="linenum">1020</span></a>                  restore_dbops::<a class="function" onClick="logFunction('load_inforef_to_tempids')" href="../../_functions/load_inforef_to_tempids.html" onMouseOver="funcPopup(event,'load_inforef_to_tempids')">load_inforef_to_tempids</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), <a class="var it10894" onMouseOver="hilite(10894)" onMouseOut="lolite()" onClick="logVariable('inforefpath')" href="../../_variables/inforefpath.html">$inforefpath</a>, <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>);
<a name="l1021"><span class="linenum">1021</span></a>              }
<a name="l1022"><span class="linenum">1022</span></a>          }
<a name="l1023"><span class="linenum">1023</span></a>          <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>-&gt;<a class="function" onClick="logFunction('end_progress')" href="../../_functions/end_progress.html" onMouseOver="funcPopup(event,'end_progress')">end_progress</a>();
<a name="l1024"><span class="linenum">1024</span></a>      }
<a name="l1025"><span class="linenum">1025</span></a>  }
<a name="l1026"><span class="linenum">1026</span></a>  
<a name="l1027"><span class="linenum">1027</span></a>  <span class="comment">/*</span>
<a name="l1028"><span class="linenum">1028</span></a>  <span class="comment"> * Execution step that will load all the needed files into backup_files_temp</span>
<a name="l1029"><span class="linenum">1029</span></a>  <span class="comment"> *   - info: contains the whole original object (times, names...)</span>
<a name="l1030"><span class="linenum">1030</span></a>  <span class="comment"> * (all them being original ids as loaded from xml)</span>
<a name="l1031"><span class="linenum">1031</span></a>  <span class="comment"> */</span>
<a name="l1032"><span class="linenum">1032</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_load_included_files')" href="../../_classes/restore_load_included_files.html" onMouseOver="classPopup(event,'restore_load_included_files')">restore_load_included_files</a> extends restore_structure_step {
<a name="l1033"><span class="linenum">1033</span></a>  
<a name="l1034"><span class="linenum">1034</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l1035"><span class="linenum">1035</span></a>  
<a name="l1036"><span class="linenum">1036</span></a>          <a class="var it297" onMouseOver="hilite(297)" onMouseOut="lolite()" onClick="logVariable('file')" href="../../_variables/file.html">$file</a> = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('file', '/files/file');
<a name="l1037"><span class="linenum">1037</span></a>  
<a name="l1038"><span class="linenum">1038</span></a>          return array(<a class="var it297" onMouseOver="hilite(297)" onMouseOut="lolite()" onClick="logVariable('file')" href="../../_variables/file.html">$file</a>);
<a name="l1039"><span class="linenum">1039</span></a>      }
<a name="l1040"><span class="linenum">1040</span></a>  
<a name="l1041"><span class="linenum">1041</span></a>      <span class="comment">/**</span>
<a name="l1042"><span class="linenum">1042</span></a>  <span class="comment">     * Process one &lt;file&gt; element from files.xml</span>
<a name="l1043"><span class="linenum">1043</span></a>  <span class="comment">     *</span>
<a name="l1044"><span class="linenum">1044</span></a>  <span class="comment">     * @param array $data the element data</span>
<a name="l1045"><span class="linenum">1045</span></a>  <span class="comment">     */</span>
<a name="l1046"><span class="linenum">1046</span></a>      public function <a class="function" onClick="logFunction('process_file')" href="../../_functions/process_file.html" onMouseOver="funcPopup(event,'process_file')">process_file</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l1047"><span class="linenum">1047</span></a>  
<a name="l1048"><span class="linenum">1048</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>; <span class="comment">// handy</span>
<a name="l1049"><span class="linenum">1049</span></a>  
<a name="l1050"><span class="linenum">1050</span></a>  <span class="comment">        // load it if needed:</span>
<a name="l1051"><span class="linenum">1051</span></a>  <span class="comment">        //   - it it is one of the annotated inforef files (course/section/activity/block)</span>
<a name="l1052"><span class="linenum">1052</span></a>  <span class="comment">        //   - it is one &quot;user&quot;, &quot;group&quot;, &quot;grouping&quot;, &quot;grade&quot;, &quot;question&quot; or &quot;qtype_xxxx&quot; component file (that aren't sent to inforef ever)</span>
<a name="l1053"><span class="linenum">1053</span></a>  <span class="comment">        // TODO: qtype_xxx should be replaced by proper backup_qtype_plugin::get_components_and_fileareas() use,</span>
<a name="l1054"><span class="linenum">1054</span></a>  <span class="comment">        //       but then we'll need to change it to load plugins itself (because this is executed too early in restore)</span>
<a name="l1055"><span class="linenum">1055</span></a>          <a class="var it15378" onMouseOver="hilite(15378)" onMouseOut="lolite()" onClick="logVariable('isfileref')" href="../../_variables/isfileref.html">$isfileref</a>   = restore_dbops::<a class="function" onClick="logFunction('get_backup_ids_record')" href="../../_functions/get_backup_ids_record.html" onMouseOver="funcPopup(event,'get_backup_ids_record')">get_backup_ids_record</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'fileref', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>);
<a name="l1056"><span class="linenum">1056</span></a>          <a class="var it15379" onMouseOver="hilite(15379)" onMouseOut="lolite()" onClick="logVariable('iscomponent')" href="../../_variables/iscomponent.html">$iscomponent</a> = (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('component')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/component.html">component</a> == 'user' || <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('component')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/component.html">component</a> == 'group' || <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('component')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/component.html">component</a> == 'badges' ||
<a name="l1057"><span class="linenum">1057</span></a>                          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('component')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/component.html">component</a> == 'grouping' || <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('component')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/component.html">component</a> == 'grade' ||
<a name="l1058"><span class="linenum">1058</span></a>                          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('component')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/component.html">component</a> == 'question' || <a class="phpfunction" onClick="logFunction('substr')" href="../../_functions/substr.html" onMouseOver="phpfuncPopup(event,'substr')">substr</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('component')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/component.html">component</a>, 0, 5) == 'qtype');
<a name="l1059"><span class="linenum">1059</span></a>          if (<a class="var it15378" onMouseOver="hilite(15378)" onMouseOut="lolite()" onClick="logVariable('isfileref')" href="../../_variables/isfileref.html">$isfileref</a> || <a class="var it15379" onMouseOver="hilite(15379)" onMouseOut="lolite()" onClick="logVariable('iscomponent')" href="../../_variables/iscomponent.html">$iscomponent</a>) {
<a name="l1060"><span class="linenum">1060</span></a>              restore_dbops::<a class="function" onClick="logFunction('set_backup_files_record')" href="../../_functions/set_backup_files_record.html" onMouseOver="funcPopup(event,'set_backup_files_record')">set_backup_files_record</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l1061"><span class="linenum">1061</span></a>          }
<a name="l1062"><span class="linenum">1062</span></a>      }
<a name="l1063"><span class="linenum">1063</span></a>  }
<a name="l1064"><span class="linenum">1064</span></a>  
<a name="l1065"><span class="linenum">1065</span></a>  <span class="comment">/**</span>
<a name="l1066"><span class="linenum">1066</span></a>  <span class="comment"> * Execution step that, *conditionally* (if there isn't preloaded information),</span>
<a name="l1067"><span class="linenum">1067</span></a>  <span class="comment"> * will load all the needed roles to backup_temp_ids. They will be stored with</span>
<a name="l1068"><span class="linenum">1068</span></a>  <span class="comment"> * &quot;role&quot; itemname. Also it will perform one automatic mapping to roles existing</span>
<a name="l1069"><span class="linenum">1069</span></a>  <span class="comment"> * in the target site, based in permissions of the user performing the restore,</span>
<a name="l1070"><span class="linenum">1070</span></a>  <span class="comment"> * archetypes and other bits. At the end, each original role will have its associated</span>
<a name="l1071"><span class="linenum">1071</span></a>  <span class="comment"> * target role or 0 if it's going to be skipped. Note we wrap everything over one</span>
<a name="l1072"><span class="linenum">1072</span></a>  <span class="comment"> * restore_dbops method, as far as the same stuff is going to be also executed</span>
<a name="l1073"><span class="linenum">1073</span></a>  <span class="comment"> * by restore prechecks</span>
<a name="l1074"><span class="linenum">1074</span></a>  <span class="comment"> */</span>
<a name="l1075"><span class="linenum">1075</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_load_and_map_roles')" href="../../_classes/restore_load_and_map_roles.html" onMouseOver="classPopup(event,'restore_load_and_map_roles')">restore_load_and_map_roles</a> extends restore_execution_step {
<a name="l1076"><span class="linenum">1076</span></a>  
<a name="l1077"><span class="linenum">1077</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l1078"><span class="linenum">1078</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_preloaded_information')" href="../../_functions/get_preloaded_information.html" onMouseOver="funcPopup(event,'get_preloaded_information')">get_preloaded_information</a>()) { // if info is already preloaded
<a name="l1079"><span class="linenum">1079</span></a>              return;
<a name="l1080"><span class="linenum">1080</span></a>          }
<a name="l1081"><span class="linenum">1081</span></a>  
<a name="l1082"><span class="linenum">1082</span></a>          <a class="var it297" onMouseOver="hilite(297)" onMouseOut="lolite()" onClick="logVariable('file')" href="../../_variables/file.html">$file</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_basepath')" href="../../_functions/get_basepath.html" onMouseOver="funcPopup(event,'get_basepath')">get_basepath</a>() . '/roles.xml';
<a name="l1083"><span class="linenum">1083</span></a>  <span class="comment">        // Load needed toles to temp_ids</span>
<a name="l1084"><span class="linenum">1084</span></a>          restore_dbops::<a class="function" onClick="logFunction('load_roles_to_tempids')" href="../../_functions/load_roles_to_tempids.html" onMouseOver="funcPopup(event,'load_roles_to_tempids')">load_roles_to_tempids</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), <a class="var it297" onMouseOver="hilite(297)" onMouseOut="lolite()" onClick="logVariable('file')" href="../../_variables/file.html">$file</a>);
<a name="l1085"><span class="linenum">1085</span></a>  
<a name="l1086"><span class="linenum">1086</span></a>  <span class="comment">        // Process roles, mapping/skipping. Any error throws exception</span>
<a name="l1087"><span class="linenum">1087</span></a>  <span class="comment">        // Note we pass controller's info because it can contain role mapping information</span>
<a name="l1088"><span class="linenum">1088</span></a>  <span class="comment">        // about manual mappings performed by UI</span>
<a name="l1089"><span class="linenum">1089</span></a>          restore_dbops::<a class="function" onClick="logFunction('process_included_roles')" href="../../_functions/process_included_roles.html" onMouseOver="funcPopup(event,'process_included_roles')">process_included_roles</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('is_samesite')" href="../../_functions/is_samesite.html" onMouseOver="funcPopup(event,'is_samesite')">is_samesite</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_info')" href="../../_functions/get_info.html" onMouseOver="funcPopup(event,'get_info')">get_info</a>()-&gt;role_mappings);
<a name="l1090"><span class="linenum">1090</span></a>      }
<a name="l1091"><span class="linenum">1091</span></a>  }
<a name="l1092"><span class="linenum">1092</span></a>  
<a name="l1093"><span class="linenum">1093</span></a>  <span class="comment">/**</span>
<a name="l1094"><span class="linenum">1094</span></a>  <span class="comment"> * Execution step that, *conditionally* (if there isn't preloaded information</span>
<a name="l1095"><span class="linenum">1095</span></a>  <span class="comment"> * and users have been selected in settings, will load all the needed users</span>
<a name="l1096"><span class="linenum">1096</span></a>  <span class="comment"> * to backup_temp_ids. They will be stored with &quot;user&quot; itemname and with</span>
<a name="l1097"><span class="linenum">1097</span></a>  <span class="comment"> * their original contextid as paremitemid</span>
<a name="l1098"><span class="linenum">1098</span></a>  <span class="comment"> */</span>
<a name="l1099"><span class="linenum">1099</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_load_included_users')" href="../../_classes/restore_load_included_users.html" onMouseOver="classPopup(event,'restore_load_included_users')">restore_load_included_users</a> extends restore_execution_step {
<a name="l1100"><span class="linenum">1100</span></a>  
<a name="l1101"><span class="linenum">1101</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l1102"><span class="linenum">1102</span></a>  
<a name="l1103"><span class="linenum">1103</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_preloaded_information')" href="../../_functions/get_preloaded_information.html" onMouseOver="funcPopup(event,'get_preloaded_information')">get_preloaded_information</a>()) { // if info is already preloaded, nothing to do
<a name="l1104"><span class="linenum">1104</span></a>              return;
<a name="l1105"><span class="linenum">1105</span></a>          }
<a name="l1106"><span class="linenum">1106</span></a>          if (!<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('users')) { // No userinfo being restored, nothing to do
<a name="l1107"><span class="linenum">1107</span></a>              return;
<a name="l1108"><span class="linenum">1108</span></a>          }
<a name="l1109"><span class="linenum">1109</span></a>          <a class="var it297" onMouseOver="hilite(297)" onMouseOut="lolite()" onClick="logVariable('file')" href="../../_variables/file.html">$file</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_basepath')" href="../../_functions/get_basepath.html" onMouseOver="funcPopup(event,'get_basepath')">get_basepath</a>() . '/users.xml';
<a name="l1110"><span class="linenum">1110</span></a>  <span class="comment">        // Load needed users to temp_ids.</span>
<a name="l1111"><span class="linenum">1111</span></a>          restore_dbops::<a class="function" onClick="logFunction('load_users_to_tempids')" href="../../_functions/load_users_to_tempids.html" onMouseOver="funcPopup(event,'load_users_to_tempids')">load_users_to_tempids</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), <a class="var it297" onMouseOver="hilite(297)" onMouseOut="lolite()" onClick="logVariable('file')" href="../../_variables/file.html">$file</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_progress')" href="../../_functions/get_progress.html" onMouseOver="funcPopup(event,'get_progress')">get_progress</a>());
<a name="l1112"><span class="linenum">1112</span></a>      }
<a name="l1113"><span class="linenum">1113</span></a>  }
<a name="l1114"><span class="linenum">1114</span></a>  
<a name="l1115"><span class="linenum">1115</span></a>  <span class="comment">/**</span>
<a name="l1116"><span class="linenum">1116</span></a>  <span class="comment"> * Execution step that, *conditionally* (if there isn't preloaded information</span>
<a name="l1117"><span class="linenum">1117</span></a>  <span class="comment"> * and users have been selected in settings, will process all the needed users</span>
<a name="l1118"><span class="linenum">1118</span></a>  <span class="comment"> * in order to decide and perform any action with them (create / map / error)</span>
<a name="l1119"><span class="linenum">1119</span></a>  <span class="comment"> * Note: Any error will cause exception, as far as this is the same processing</span>
<a name="l1120"><span class="linenum">1120</span></a>  <span class="comment"> * than the one into restore prechecks (that should have stopped process earlier)</span>
<a name="l1121"><span class="linenum">1121</span></a>  <span class="comment"> */</span>
<a name="l1122"><span class="linenum">1122</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_process_included_users')" href="../../_classes/restore_process_included_users.html" onMouseOver="classPopup(event,'restore_process_included_users')">restore_process_included_users</a> extends restore_execution_step {
<a name="l1123"><span class="linenum">1123</span></a>  
<a name="l1124"><span class="linenum">1124</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l1125"><span class="linenum">1125</span></a>  
<a name="l1126"><span class="linenum">1126</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_preloaded_information')" href="../../_functions/get_preloaded_information.html" onMouseOver="funcPopup(event,'get_preloaded_information')">get_preloaded_information</a>()) { // if info is already preloaded, nothing to do
<a name="l1127"><span class="linenum">1127</span></a>              return;
<a name="l1128"><span class="linenum">1128</span></a>          }
<a name="l1129"><span class="linenum">1129</span></a>          if (!<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('users')) { // No userinfo being restored, nothing to do
<a name="l1130"><span class="linenum">1130</span></a>              return;
<a name="l1131"><span class="linenum">1131</span></a>          }
<a name="l1132"><span class="linenum">1132</span></a>          restore_dbops::<a class="function" onClick="logFunction('process_included_users')" href="../../_functions/process_included_users.html" onMouseOver="funcPopup(event,'process_included_users')">process_included_users</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(),
<a name="l1133"><span class="linenum">1133</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('is_samesite')" href="../../_functions/is_samesite.html" onMouseOver="funcPopup(event,'is_samesite')">is_samesite</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_progress')" href="../../_functions/get_progress.html" onMouseOver="funcPopup(event,'get_progress')">get_progress</a>());
<a name="l1134"><span class="linenum">1134</span></a>      }
<a name="l1135"><span class="linenum">1135</span></a>  }
<a name="l1136"><span class="linenum">1136</span></a>  
<a name="l1137"><span class="linenum">1137</span></a>  <span class="comment">/**</span>
<a name="l1138"><span class="linenum">1138</span></a>  <span class="comment"> * Execution step that will create all the needed users as calculated</span>
<a name="l1139"><span class="linenum">1139</span></a>  <span class="comment"> * by @restore_process_included_users (those having newiteind = 0)</span>
<a name="l1140"><span class="linenum">1140</span></a>  <span class="comment"> */</span>
<a name="l1141"><span class="linenum">1141</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_create_included_users')" href="../../_classes/restore_create_included_users.html" onMouseOver="classPopup(event,'restore_create_included_users')">restore_create_included_users</a> extends restore_execution_step {
<a name="l1142"><span class="linenum">1142</span></a>  
<a name="l1143"><span class="linenum">1143</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l1144"><span class="linenum">1144</span></a>  
<a name="l1145"><span class="linenum">1145</span></a>          restore_dbops::<a class="function" onClick="logFunction('create_included_users')" href="../../_functions/create_included_users.html" onMouseOver="funcPopup(event,'create_included_users')">create_included_users</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_basepath')" href="../../_functions/get_basepath.html" onMouseOver="funcPopup(event,'get_basepath')">get_basepath</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(),
<a name="l1146"><span class="linenum">1146</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_progress')" href="../../_functions/get_progress.html" onMouseOver="funcPopup(event,'get_progress')">get_progress</a>());
<a name="l1147"><span class="linenum">1147</span></a>      }
<a name="l1148"><span class="linenum">1148</span></a>  }
<a name="l1149"><span class="linenum">1149</span></a>  
<a name="l1150"><span class="linenum">1150</span></a>  <span class="comment">/**</span>
<a name="l1151"><span class="linenum">1151</span></a>  <span class="comment"> * Structure step that will create all the needed groups and groupings</span>
<a name="l1152"><span class="linenum">1152</span></a>  <span class="comment"> * by loading them from the groups.xml file performing the required matches.</span>
<a name="l1153"><span class="linenum">1153</span></a>  <span class="comment"> * Note group members only will be added if restoring user info</span>
<a name="l1154"><span class="linenum">1154</span></a>  <span class="comment"> */</span>
<a name="l1155"><span class="linenum">1155</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_groups_structure_step')" href="../../_classes/restore_groups_structure_step.html" onMouseOver="classPopup(event,'restore_groups_structure_step')">restore_groups_structure_step</a> extends restore_structure_step {
<a name="l1156"><span class="linenum">1156</span></a>  
<a name="l1157"><span class="linenum">1157</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l1158"><span class="linenum">1158</span></a>  
<a name="l1159"><span class="linenum">1159</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array(); <span class="comment">// Add paths here</span>
<a name="l1160"><span class="linenum">1160</span></a>  
<a name="l1161"><span class="linenum">1161</span></a>  <span class="comment">        // Do not include group/groupings information if not requested.</span>
<a name="l1162"><span class="linenum">1162</span></a>          <a class="var it15380" onMouseOver="hilite(15380)" onMouseOut="lolite()" onClick="logVariable('groupinfo')" href="../../_variables/groupinfo.html">$groupinfo</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('groups');
<a name="l1163"><span class="linenum">1163</span></a>          if (<a class="var it15380" onMouseOver="hilite(15380)" onMouseOut="lolite()" onClick="logVariable('groupinfo')" href="../../_variables/groupinfo.html">$groupinfo</a>) {
<a name="l1164"><span class="linenum">1164</span></a>              <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('group', '/groups/group');
<a name="l1165"><span class="linenum">1165</span></a>              <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('grouping', '/groups/groupings/grouping');
<a name="l1166"><span class="linenum">1166</span></a>              <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('grouping_group', '/groups/groupings/grouping/grouping_groups/grouping_group');
<a name="l1167"><span class="linenum">1167</span></a>          }
<a name="l1168"><span class="linenum">1168</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l1169"><span class="linenum">1169</span></a>      }
<a name="l1170"><span class="linenum">1170</span></a>  
<a name="l1171"><span class="linenum">1171</span></a>  <span class="comment">    // Processing functions go here</span>
<a name="l1172"><span class="linenum">1172</span></a>      public function <a class="function" onClick="logFunction('process_group')" href="../../_functions/process_group.html" onMouseOver="funcPopup(event,'process_group')">process_group</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l1173"><span class="linenum">1173</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l1174"><span class="linenum">1174</span></a>  
<a name="l1175"><span class="linenum">1175</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>; <span class="comment">// handy</span>
<a name="l1176"><span class="linenum">1176</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l1177"><span class="linenum">1177</span></a>  
<a name="l1178"><span class="linenum">1178</span></a>  <span class="comment">        // Only allow the idnumber to be set if the user has permission and the idnumber is not already in use by</span>
<a name="l1179"><span class="linenum">1179</span></a>  <span class="comment">        // another a group in the same course</span>
<a name="l1180"><span class="linenum">1180</span></a>          <a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a> = <a class="class" onClick="logClass('context_course')" href="../../_classes/context_course.html" onMouseOver="classPopup(event,'context_course')">context_course</a>::<a class="function" onClick="logFunction('instance')" href="../../_functions/instance.html" onMouseOver="funcPopup(event,'instance')">instance</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a>);
<a name="l1181"><span class="linenum">1181</span></a>          if (isset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>) and <a class="function" onClick="logFunction('has_capability')" href="../../_functions/has_capability.html" onMouseOver="funcPopup(event,'has_capability')">has_capability</a>('moodle/course:changeidnumber', <a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>())) {
<a name="l1182"><span class="linenum">1182</span></a>              if (<a class="function" onClick="logFunction('groups_get_group_by_idnumber')" href="../../_functions/groups_get_group_by_idnumber.html" onMouseOver="funcPopup(event,'groups_get_group_by_idnumber')">groups_get_group_by_idnumber</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>)) {
<a name="l1183"><span class="linenum">1183</span></a>                  unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>);
<a name="l1184"><span class="linenum">1184</span></a>              }
<a name="l1185"><span class="linenum">1185</span></a>          } else {
<a name="l1186"><span class="linenum">1186</span></a>              unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>);
<a name="l1187"><span class="linenum">1187</span></a>          }
<a name="l1188"><span class="linenum">1188</span></a>  
<a name="l1189"><span class="linenum">1189</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;    <span class="comment">// need this saved for later</span>
<a name="l1190"><span class="linenum">1190</span></a>  
<a name="l1191"><span class="linenum">1191</span></a>          <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a> = false; <span class="comment">// Only if we end creating the group</span>
<a name="l1192"><span class="linenum">1192</span></a>  
<a name="l1193"><span class="linenum">1193</span></a>  <span class="comment">        // Search if the group already exists (by name &amp; description) in the target course</span>
<a name="l1194"><span class="linenum">1194</span></a>          <a class="var it15382" onMouseOver="hilite(15382)" onMouseOut="lolite()" onClick="logVariable('description_clause')" href="../../_variables/description_clause.html">$description_clause</a> = '';
<a name="l1195"><span class="linenum">1195</span></a>          <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array('courseid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(), 'grname' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('name')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/name.html">name</a>);
<a name="l1196"><span class="linenum">1196</span></a>          if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('description')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/description.html">description</a>)) {
<a name="l1197"><span class="linenum">1197</span></a>              <a class="var it15382" onMouseOver="hilite(15382)" onMouseOut="lolite()" onClick="logVariable('description_clause')" href="../../_variables/description_clause.html">$description_clause</a> = ' AND ' .
<a name="l1198"><span class="linenum">1198</span></a>                                    <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_compare_text')" href="../../_functions/sql_compare_text.html" onMouseOver="funcPopup(event,'sql_compare_text')">sql_compare_text</a>('description') . ' = ' . <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_compare_text')" href="../../_functions/sql_compare_text.html" onMouseOver="funcPopup(event,'sql_compare_text')">sql_compare_text</a>(':description');
<a name="l1199"><span class="linenum">1199</span></a>             <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['description'] = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('description')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/description.html">description</a>;
<a name="l1200"><span class="linenum">1200</span></a>          }
<a name="l1201"><span class="linenum">1201</span></a>          if (!<a class="var it15383" onMouseOver="hilite(15383)" onMouseOut="lolite()" onClick="logVariable('groupdb')" href="../../_variables/groupdb.html">$groupdb</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record_sql')" href="../../_functions/get_record_sql.html" onMouseOver="funcPopup(event,'get_record_sql')">get_record_sql</a>(&quot;SELECT *
<a name="l1202"><span class="linenum">1202</span></a>                                                 FROM {groups}
<a name="l1203"><span class="linenum">1203</span></a>                                                WHERE courseid = :courseid
<a name="l1204"><span class="linenum">1204</span></a>                                                  AND name = :grname <a class="var it15382" onMouseOver="hilite(15382)" onMouseOut="lolite()" onClick="logVariable('description_clause')" href="../../_variables/description_clause.html">$description_clause</a>&quot;, <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>)) {
<a name="l1205"><span class="linenum">1205</span></a>  <span class="comment">            // group doesn't exist, create</span>
<a name="l1206"><span class="linenum">1206</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('groups', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l1207"><span class="linenum">1207</span></a>              <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a> = true; <span class="comment">// We'll restore the files</span>
<a name="l1208"><span class="linenum">1208</span></a>          } else {
<a name="l1209"><span class="linenum">1209</span></a>  <span class="comment">            // group exists, use it</span>
<a name="l1210"><span class="linenum">1210</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it15383" onMouseOver="hilite(15383)" onMouseOut="lolite()" onClick="logVariable('groupdb')" href="../../_variables/groupdb.html">$groupdb</a>-&gt;<a onClick="logVariable('id')" class="var it45293" onMouseOver="hilite(45293)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l1211"><span class="linenum">1211</span></a>          }
<a name="l1212"><span class="linenum">1212</span></a>  <span class="comment">        // Save the id mapping</span>
<a name="l1213"><span class="linenum">1213</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('group', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>, <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a>);
<a name="l1214"><span class="linenum">1214</span></a>  <span class="comment">        // Invalidate the course group data cache just in case.</span>
<a name="l1215"><span class="linenum">1215</span></a>          <a class="class" onClick="logClass('cache_helper')" href="../../_classes/cache_helper.html" onMouseOver="classPopup(event,'cache_helper')">cache_helper</a>::<a class="function" onClick="logFunction('invalidate_by_definition')" href="../../_functions/invalidate_by_definition.html" onMouseOver="funcPopup(event,'invalidate_by_definition')">invalidate_by_definition</a>('core', 'groupdata', array(), array(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a>));
<a name="l1216"><span class="linenum">1216</span></a>      }
<a name="l1217"><span class="linenum">1217</span></a>  
<a name="l1218"><span class="linenum">1218</span></a>      public function <a class="function" onClick="logFunction('process_grouping')" href="../../_functions/process_grouping.html" onMouseOver="funcPopup(event,'process_grouping')">process_grouping</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l1219"><span class="linenum">1219</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l1220"><span class="linenum">1220</span></a>  
<a name="l1221"><span class="linenum">1221</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>; <span class="comment">// handy</span>
<a name="l1222"><span class="linenum">1222</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l1223"><span class="linenum">1223</span></a>  
<a name="l1224"><span class="linenum">1224</span></a>  <span class="comment">        // Only allow the idnumber to be set if the user has permission and the idnumber is not already in use by</span>
<a name="l1225"><span class="linenum">1225</span></a>  <span class="comment">        // another a grouping in the same course</span>
<a name="l1226"><span class="linenum">1226</span></a>          <a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a> = <a class="class" onClick="logClass('context_course')" href="../../_classes/context_course.html" onMouseOver="classPopup(event,'context_course')">context_course</a>::<a class="function" onClick="logFunction('instance')" href="../../_functions/instance.html" onMouseOver="funcPopup(event,'instance')">instance</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a>);
<a name="l1227"><span class="linenum">1227</span></a>          if (isset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>) and <a class="function" onClick="logFunction('has_capability')" href="../../_functions/has_capability.html" onMouseOver="funcPopup(event,'has_capability')">has_capability</a>('moodle/course:changeidnumber', <a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>())) {
<a name="l1228"><span class="linenum">1228</span></a>              if (<a class="function" onClick="logFunction('groups_get_grouping_by_idnumber')" href="../../_functions/groups_get_grouping_by_idnumber.html" onMouseOver="funcPopup(event,'groups_get_grouping_by_idnumber')">groups_get_grouping_by_idnumber</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>)) {
<a name="l1229"><span class="linenum">1229</span></a>                  unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>);
<a name="l1230"><span class="linenum">1230</span></a>              }
<a name="l1231"><span class="linenum">1231</span></a>          } else {
<a name="l1232"><span class="linenum">1232</span></a>              unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>);
<a name="l1233"><span class="linenum">1233</span></a>          }
<a name="l1234"><span class="linenum">1234</span></a>  
<a name="l1235"><span class="linenum">1235</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;    <span class="comment">// need this saved for later</span>
<a name="l1236"><span class="linenum">1236</span></a>          <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a> = false; <span class="comment">// Only if we end creating the grouping</span>
<a name="l1237"><span class="linenum">1237</span></a>  
<a name="l1238"><span class="linenum">1238</span></a>  <span class="comment">        // Search if the grouping already exists (by name &amp; description) in the target course</span>
<a name="l1239"><span class="linenum">1239</span></a>          <a class="var it15382" onMouseOver="hilite(15382)" onMouseOut="lolite()" onClick="logVariable('description_clause')" href="../../_variables/description_clause.html">$description_clause</a> = '';
<a name="l1240"><span class="linenum">1240</span></a>          <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array('courseid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(), 'grname' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('name')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/name.html">name</a>);
<a name="l1241"><span class="linenum">1241</span></a>          if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('description')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/description.html">description</a>)) {
<a name="l1242"><span class="linenum">1242</span></a>              <a class="var it15382" onMouseOver="hilite(15382)" onMouseOut="lolite()" onClick="logVariable('description_clause')" href="../../_variables/description_clause.html">$description_clause</a> = ' AND ' .
<a name="l1243"><span class="linenum">1243</span></a>                                    <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_compare_text')" href="../../_functions/sql_compare_text.html" onMouseOver="funcPopup(event,'sql_compare_text')">sql_compare_text</a>('description') . ' = ' . <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_compare_text')" href="../../_functions/sql_compare_text.html" onMouseOver="funcPopup(event,'sql_compare_text')">sql_compare_text</a>(':description');
<a name="l1244"><span class="linenum">1244</span></a>             <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['description'] = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('description')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/description.html">description</a>;
<a name="l1245"><span class="linenum">1245</span></a>          }
<a name="l1246"><span class="linenum">1246</span></a>          if (!<a class="var it15384" onMouseOver="hilite(15384)" onMouseOut="lolite()" onClick="logVariable('groupingdb')" href="../../_variables/groupingdb.html">$groupingdb</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record_sql')" href="../../_functions/get_record_sql.html" onMouseOver="funcPopup(event,'get_record_sql')">get_record_sql</a>(&quot;SELECT *
<a name="l1247"><span class="linenum">1247</span></a>                                                    FROM {groupings}
<a name="l1248"><span class="linenum">1248</span></a>                                                   WHERE courseid = :courseid
<a name="l1249"><span class="linenum">1249</span></a>                                                     AND name = :grname <a class="var it15382" onMouseOver="hilite(15382)" onMouseOut="lolite()" onClick="logVariable('description_clause')" href="../../_variables/description_clause.html">$description_clause</a>&quot;, <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>)) {
<a name="l1250"><span class="linenum">1250</span></a>  <span class="comment">            // grouping doesn't exist, create</span>
<a name="l1251"><span class="linenum">1251</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('groupings', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l1252"><span class="linenum">1252</span></a>              <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a> = true; <span class="comment">// We'll restore the files</span>
<a name="l1253"><span class="linenum">1253</span></a>          } else {
<a name="l1254"><span class="linenum">1254</span></a>  <span class="comment">            // grouping exists, use it</span>
<a name="l1255"><span class="linenum">1255</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it15384" onMouseOver="hilite(15384)" onMouseOut="lolite()" onClick="logVariable('groupingdb')" href="../../_variables/groupingdb.html">$groupingdb</a>-&gt;<a onClick="logVariable('id')" class="var it45294" onMouseOver="hilite(45294)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l1256"><span class="linenum">1256</span></a>          }
<a name="l1257"><span class="linenum">1257</span></a>  <span class="comment">        // Save the id mapping</span>
<a name="l1258"><span class="linenum">1258</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('grouping', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>, <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a>);
<a name="l1259"><span class="linenum">1259</span></a>  <span class="comment">        // Invalidate the course group data cache just in case.</span>
<a name="l1260"><span class="linenum">1260</span></a>          <a class="class" onClick="logClass('cache_helper')" href="../../_classes/cache_helper.html" onMouseOver="classPopup(event,'cache_helper')">cache_helper</a>::<a class="function" onClick="logFunction('invalidate_by_definition')" href="../../_functions/invalidate_by_definition.html" onMouseOver="funcPopup(event,'invalidate_by_definition')">invalidate_by_definition</a>('core', 'groupdata', array(), array(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a>));
<a name="l1261"><span class="linenum">1261</span></a>      }
<a name="l1262"><span class="linenum">1262</span></a>  
<a name="l1263"><span class="linenum">1263</span></a>      public function <a class="function" onClick="logFunction('process_grouping_group')" href="../../_functions/process_grouping_group.html" onMouseOver="funcPopup(event,'process_grouping_group')">process_grouping_group</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l1264"><span class="linenum">1264</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>;
<a name="l1265"><span class="linenum">1265</span></a>  
<a name="l1266"><span class="linenum">1266</span></a>          require_once(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('dirroot')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/dirroot.html">dirroot</a>.'<a class="filename" href="../../group/lib.php.html">/group/lib.php</a>');
<a name="l1267"><span class="linenum">1267</span></a>  
<a name="l1268"><span class="linenum">1268</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l1269"><span class="linenum">1269</span></a>          <a class="function" onClick="logFunction('groups_assign_grouping')" href="../../_functions/groups_assign_grouping.html" onMouseOver="funcPopup(event,'groups_assign_grouping')">groups_assign_grouping</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_new_parentid')" href="../../_functions/get_new_parentid.html" onMouseOver="funcPopup(event,'get_new_parentid')">get_new_parentid</a>('grouping'), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('group', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('groupid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/groupid.html">groupid</a>), <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timeadded')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timeadded.html">timeadded</a>);
<a name="l1270"><span class="linenum">1270</span></a>      }
<a name="l1271"><span class="linenum">1271</span></a>  
<a name="l1272"><span class="linenum">1272</span></a>      protected function <a class="function" onClick="logFunction('after_execute')" href="../../_functions/after_execute.html" onMouseOver="funcPopup(event,'after_execute')">after_execute</a>() {
<a name="l1273"><span class="linenum">1273</span></a>  <span class="comment">        // Add group related files, matching with &quot;group&quot; mappings</span>
<a name="l1274"><span class="linenum">1274</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_related_files')" href="../../_functions/add_related_files.html" onMouseOver="funcPopup(event,'add_related_files')">add_related_files</a>('group', 'icon', 'group');
<a name="l1275"><span class="linenum">1275</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_related_files')" href="../../_functions/add_related_files.html" onMouseOver="funcPopup(event,'add_related_files')">add_related_files</a>('group', 'description', 'group');
<a name="l1276"><span class="linenum">1276</span></a>  <span class="comment">        // Add grouping related files, matching with &quot;grouping&quot; mappings</span>
<a name="l1277"><span class="linenum">1277</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_related_files')" href="../../_functions/add_related_files.html" onMouseOver="funcPopup(event,'add_related_files')">add_related_files</a>('grouping', 'description', 'grouping');
<a name="l1278"><span class="linenum">1278</span></a>  <span class="comment">        // Invalidate the course group data.</span>
<a name="l1279"><span class="linenum">1279</span></a>          <a class="class" onClick="logClass('cache_helper')" href="../../_classes/cache_helper.html" onMouseOver="classPopup(event,'cache_helper')">cache_helper</a>::<a class="function" onClick="logFunction('invalidate_by_definition')" href="../../_functions/invalidate_by_definition.html" onMouseOver="funcPopup(event,'invalidate_by_definition')">invalidate_by_definition</a>('core', 'groupdata', array(), array(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>()));
<a name="l1280"><span class="linenum">1280</span></a>      }
<a name="l1281"><span class="linenum">1281</span></a>  
<a name="l1282"><span class="linenum">1282</span></a>  }
<a name="l1283"><span class="linenum">1283</span></a>  
<a name="l1284"><span class="linenum">1284</span></a>  <span class="comment">/**</span>
<a name="l1285"><span class="linenum">1285</span></a>  <span class="comment"> * Structure step that will create all the needed group memberships</span>
<a name="l1286"><span class="linenum">1286</span></a>  <span class="comment"> * by loading them from the groups.xml file performing the required matches.</span>
<a name="l1287"><span class="linenum">1287</span></a>  <span class="comment"> */</span>
<a name="l1288"><span class="linenum">1288</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_groups_members_structure_step')" href="../../_classes/restore_groups_members_structure_step.html" onMouseOver="classPopup(event,'restore_groups_members_structure_step')">restore_groups_members_structure_step</a> extends restore_structure_step {
<a name="l1289"><span class="linenum">1289</span></a>  
<a name="l1290"><span class="linenum">1290</span></a>      protected <a class="var it3924" onMouseOver="hilite(3924)" onMouseOut="lolite()" onClick="logVariable('plugins')" href="../../_variables/plugins.html">$plugins</a> = null;
<a name="l1291"><span class="linenum">1291</span></a>  
<a name="l1292"><span class="linenum">1292</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l1293"><span class="linenum">1293</span></a>  
<a name="l1294"><span class="linenum">1294</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array(); <span class="comment">// Add paths here</span>
<a name="l1295"><span class="linenum">1295</span></a>  
<a name="l1296"><span class="linenum">1296</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('groups') &amp;&amp; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('users')) {
<a name="l1297"><span class="linenum">1297</span></a>              <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('group', '/groups/group');
<a name="l1298"><span class="linenum">1298</span></a>              <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('member', '/groups/group/group_members/group_member');
<a name="l1299"><span class="linenum">1299</span></a>          }
<a name="l1300"><span class="linenum">1300</span></a>  
<a name="l1301"><span class="linenum">1301</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l1302"><span class="linenum">1302</span></a>      }
<a name="l1303"><span class="linenum">1303</span></a>  
<a name="l1304"><span class="linenum">1304</span></a>      public function <a class="function" onClick="logFunction('process_group')" href="../../_functions/process_group.html" onMouseOver="funcPopup(event,'process_group')">process_group</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l1305"><span class="linenum">1305</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>; <span class="comment">// handy</span>
<a name="l1306"><span class="linenum">1306</span></a>  
<a name="l1307"><span class="linenum">1307</span></a>  <span class="comment">        // HACK ALERT!</span>
<a name="l1308"><span class="linenum">1308</span></a>  <span class="comment">        // Not much to do here, this groups mapping should be already done from restore_groups_structure_step.</span>
<a name="l1309"><span class="linenum">1309</span></a>  <span class="comment">        // Let's fake internal state to make $this-&gt;get_new_parentid('group') work.</span>
<a name="l1310"><span class="linenum">1310</span></a>  
<a name="l1311"><span class="linenum">1311</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('group', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('group', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>));
<a name="l1312"><span class="linenum">1312</span></a>      }
<a name="l1313"><span class="linenum">1313</span></a>  
<a name="l1314"><span class="linenum">1314</span></a>      public function <a class="function" onClick="logFunction('process_member')" href="../../_functions/process_member.html" onMouseOver="funcPopup(event,'process_member')">process_member</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l1315"><span class="linenum">1315</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>, <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>;
<a name="l1316"><span class="linenum">1316</span></a>          require_once(&quot;<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('dirroot')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/dirroot.html">dirroot</a>/group/lib.php&quot;);
<a name="l1317"><span class="linenum">1317</span></a>  
<a name="l1318"><span class="linenum">1318</span></a>  <span class="comment">        // NOTE: Always use groups_add_member() because it triggers events and verifies if user is enrolled.</span>
<a name="l1319"><span class="linenum">1319</span></a>  
<a name="l1320"><span class="linenum">1320</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>; <span class="comment">// handy</span>
<a name="l1321"><span class="linenum">1321</span></a>  
<a name="l1322"><span class="linenum">1322</span></a>  <span class="comment">        // get parent group-&gt;id</span>
<a name="l1323"><span class="linenum">1323</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('groupid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/groupid.html">groupid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_new_parentid')" href="../../_functions/get_new_parentid.html" onMouseOver="funcPopup(event,'get_new_parentid')">get_new_parentid</a>('group');
<a name="l1324"><span class="linenum">1324</span></a>  
<a name="l1325"><span class="linenum">1325</span></a>  <span class="comment">        // map user newitemid and insert if not member already</span>
<a name="l1326"><span class="linenum">1326</span></a>          if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>)) {
<a name="l1327"><span class="linenum">1327</span></a>              if (!<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists')" href="../../_functions/record_exists.html" onMouseOver="funcPopup(event,'record_exists')">record_exists</a>('groups_members', array('groupid' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('groupid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/groupid.html">groupid</a>, 'userid' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>))) {
<a name="l1328"><span class="linenum">1328</span></a>  <span class="comment">                // Check the component, if any, exists.</span>
<a name="l1329"><span class="linenum">1329</span></a>                  if (empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('component')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/component.html">component</a>)) {
<a name="l1330"><span class="linenum">1330</span></a>                      <a class="function" onClick="logFunction('groups_add_member')" href="../../_functions/groups_add_member.html" onMouseOver="funcPopup(event,'groups_add_member')">groups_add_member</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('groupid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/groupid.html">groupid</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>);
<a name="l1331"><span class="linenum">1331</span></a>  
<a name="l1332"><span class="linenum">1332</span></a>                  } else if ((<a class="phpfunction" onClick="logFunction('strpos')" href="../../_functions/strpos.html" onMouseOver="phpfuncPopup(event,'strpos')">strpos</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('component')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/component.html">component</a>, 'enrol_') === 0)) {
<a name="l1333"><span class="linenum">1333</span></a>  <span class="comment">                    // Deal with enrolment groups - ignore the component and just find out the instance via new id,</span>
<a name="l1334"><span class="linenum">1334</span></a>  <span class="comment">                    // it is possible that enrolment was restored using different plugin type.</span>
<a name="l1335"><span class="linenum">1335</span></a>                      if (!isset(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a>)) {
<a name="l1336"><span class="linenum">1336</span></a>                          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a> = <a class="function" onClick="logFunction('enrol_get_plugins')" href="../../_functions/enrol_get_plugins.html" onMouseOver="funcPopup(event,'enrol_get_plugins')">enrol_get_plugins</a>(true);
<a name="l1337"><span class="linenum">1337</span></a>                      }
<a name="l1338"><span class="linenum">1338</span></a>                      if (<a class="var it1439" onMouseOver="hilite(1439)" onMouseOut="lolite()" onClick="logVariable('enrolid')" href="../../_variables/enrolid.html">$enrolid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('enrol', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>)) {
<a name="l1339"><span class="linenum">1339</span></a>                          if (<a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('instance')" href="../../_variables/instance.html">$instance</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('enrol', array('id'=&gt;<a class="var it1439" onMouseOver="hilite(1439)" onMouseOut="lolite()" onClick="logVariable('enrolid')" href="../../_variables/enrolid.html">$enrolid</a>))) {
<a name="l1340"><span class="linenum">1340</span></a>                              if (isset(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a>[<a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('instance')" href="../../_variables/instance.html">$instance</a>-&gt;<a onClick="logVariable('enrol')" class="var it43004" onMouseOver="hilite(43004)" onMouseOut="lolite()" href="../../_variables/enrol.html">enrol</a>])) {
<a name="l1341"><span class="linenum">1341</span></a>                                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a>[<a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('instance')" href="../../_variables/instance.html">$instance</a>-&gt;<a onClick="logVariable('enrol')" class="var it43004" onMouseOver="hilite(43004)" onMouseOut="lolite()" href="../../_variables/enrol.html">enrol</a>]-&gt;<a class="function" onClick="logFunction('restore_group_member')" href="../../_functions/restore_group_member.html" onMouseOver="funcPopup(event,'restore_group_member')">restore_group_member</a>(<a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('instance')" href="../../_variables/instance.html">$instance</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('groupid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/groupid.html">groupid</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>);
<a name="l1342"><span class="linenum">1342</span></a>                              }
<a name="l1343"><span class="linenum">1343</span></a>                          }
<a name="l1344"><span class="linenum">1344</span></a>                      }
<a name="l1345"><span class="linenum">1345</span></a>  
<a name="l1346"><span class="linenum">1346</span></a>                  } else {
<a name="l1347"><span class="linenum">1347</span></a>                      <a class="var it1519" onMouseOver="hilite(1519)" onMouseOut="lolite()" onClick="logVariable('dir')" href="../../_variables/dir.html">$dir</a> = <a class="class" onClick="logClass('core_component')" href="../../_classes/core_component.html" onMouseOver="classPopup(event,'core_component')">core_component</a>::<a class="function" onClick="logFunction('get_component_directory')" href="../../_functions/get_component_directory.html" onMouseOver="funcPopup(event,'get_component_directory')">get_component_directory</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('component')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/component.html">component</a>);
<a name="l1348"><span class="linenum">1348</span></a>                      if (<a class="var it1519" onMouseOver="hilite(1519)" onMouseOut="lolite()" onClick="logVariable('dir')" href="../../_variables/dir.html">$dir</a> and <a class="phpfunction" onClick="logFunction('is_dir')" href="../../_functions/is_dir.html" onMouseOver="phpfuncPopup(event,'is_dir')">is_dir</a>(<a class="var it1519" onMouseOver="hilite(1519)" onMouseOut="lolite()" onClick="logVariable('dir')" href="../../_variables/dir.html">$dir</a>)) {
<a name="l1349"><span class="linenum">1349</span></a>                          if (<a class="function" onClick="logFunction('component_callback')" href="../../_functions/component_callback.html" onMouseOver="funcPopup(event,'component_callback')">component_callback</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('component')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/component.html">component</a>, 'restore_group_member', array(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>), true)) {
<a name="l1350"><span class="linenum">1350</span></a>                              return;
<a name="l1351"><span class="linenum">1351</span></a>                          }
<a name="l1352"><span class="linenum">1352</span></a>                      }
<a name="l1353"><span class="linenum">1353</span></a>  <span class="comment">                    // Bad luck, plugin could not restore the data, let's add normal membership.</span>
<a name="l1354"><span class="linenum">1354</span></a>                      <a class="function" onClick="logFunction('groups_add_member')" href="../../_functions/groups_add_member.html" onMouseOver="funcPopup(event,'groups_add_member')">groups_add_member</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('groupid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/groupid.html">groupid</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>);
<a name="l1355"><span class="linenum">1355</span></a>                      <a class="var it276" onMouseOver="hilite(276)" onMouseOut="lolite()" onClick="logVariable('message')" href="../../_variables/message.html">$message</a> = &quot;Restore of '<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('component')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/component.html">component</a>/<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>' group membership is not supported, using standard group membership instead.&quot;;
<a name="l1356"><span class="linenum">1356</span></a>                      <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="phpfunction" onClick="logFunction('log')" href="../../_functions/log.html" onMouseOver="phpfuncPopup(event,'log')">log</a>(<a class="var it276" onMouseOver="hilite(276)" onMouseOut="lolite()" onClick="logVariable('message')" href="../../_variables/message.html">$message</a>, backup::LOG_WARNING);
<a name="l1357"><span class="linenum">1357</span></a>                  }
<a name="l1358"><span class="linenum">1358</span></a>              }
<a name="l1359"><span class="linenum">1359</span></a>          }
<a name="l1360"><span class="linenum">1360</span></a>      }
<a name="l1361"><span class="linenum">1361</span></a>  }
<a name="l1362"><span class="linenum">1362</span></a>  
<a name="l1363"><span class="linenum">1363</span></a>  <span class="comment">/**</span>
<a name="l1364"><span class="linenum">1364</span></a>  <span class="comment"> * Structure step that will create all the needed scales</span>
<a name="l1365"><span class="linenum">1365</span></a>  <span class="comment"> * by loading them from the scales.xml</span>
<a name="l1366"><span class="linenum">1366</span></a>  <span class="comment"> */</span>
<a name="l1367"><span class="linenum">1367</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_scales_structure_step')" href="../../_classes/restore_scales_structure_step.html" onMouseOver="classPopup(event,'restore_scales_structure_step')">restore_scales_structure_step</a> extends restore_structure_step {
<a name="l1368"><span class="linenum">1368</span></a>  
<a name="l1369"><span class="linenum">1369</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l1370"><span class="linenum">1370</span></a>  
<a name="l1371"><span class="linenum">1371</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array(); <span class="comment">// Add paths here</span>
<a name="l1372"><span class="linenum">1372</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('scale', '/scales_definition/scale');
<a name="l1373"><span class="linenum">1373</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l1374"><span class="linenum">1374</span></a>      }
<a name="l1375"><span class="linenum">1375</span></a>  
<a name="l1376"><span class="linenum">1376</span></a>      protected function <a class="function" onClick="logFunction('process_scale')" href="../../_functions/process_scale.html" onMouseOver="funcPopup(event,'process_scale')">process_scale</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l1377"><span class="linenum">1377</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l1378"><span class="linenum">1378</span></a>  
<a name="l1379"><span class="linenum">1379</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l1380"><span class="linenum">1380</span></a>  
<a name="l1381"><span class="linenum">1381</span></a>          <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a> = false; <span class="comment">// Only if we end creating the group</span>
<a name="l1382"><span class="linenum">1382</span></a>  
<a name="l1383"><span class="linenum">1383</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;    <span class="comment">// need this saved for later</span>
<a name="l1384"><span class="linenum">1384</span></a>  
<a name="l1385"><span class="linenum">1385</span></a>  <span class="comment">        // Look for scale (by 'scale' both in standard (course=0) and current course</span>
<a name="l1386"><span class="linenum">1386</span></a>  <span class="comment">        // with priority to standard scales (ORDER clause)</span>
<a name="l1387"><span class="linenum">1387</span></a>  <span class="comment">        // scale is not course unique, use get_record_sql to suppress warning</span>
<a name="l1388"><span class="linenum">1388</span></a>  <span class="comment">        // Going to compare LOB columns so, use the cross-db sql_compare_text() in both sides</span>
<a name="l1389"><span class="linenum">1389</span></a>          <a class="var it15385" onMouseOver="hilite(15385)" onMouseOut="lolite()" onClick="logVariable('compare_scale_clause')" href="../../_variables/compare_scale_clause.html">$compare_scale_clause</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_compare_text')" href="../../_functions/sql_compare_text.html" onMouseOver="funcPopup(event,'sql_compare_text')">sql_compare_text</a>('scale')  . ' = ' . <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_compare_text')" href="../../_functions/sql_compare_text.html" onMouseOver="funcPopup(event,'sql_compare_text')">sql_compare_text</a>(':scaledesc');
<a name="l1390"><span class="linenum">1390</span></a>          <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array('courseid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(), 'scaledesc' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('scale')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/scale.html">scale</a>);
<a name="l1391"><span class="linenum">1391</span></a>          if (!<a class="var it15386" onMouseOver="hilite(15386)" onMouseOut="lolite()" onClick="logVariable('scadb')" href="../../_variables/scadb.html">$scadb</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record_sql')" href="../../_functions/get_record_sql.html" onMouseOver="funcPopup(event,'get_record_sql')">get_record_sql</a>(&quot;SELECT *
<a name="l1392"><span class="linenum">1392</span></a>                                              FROM {scale}
<a name="l1393"><span class="linenum">1393</span></a>                                             WHERE courseid IN (0, :courseid)
<a name="l1394"><span class="linenum">1394</span></a>                                               AND <a class="var it15385" onMouseOver="hilite(15385)" onMouseOut="lolite()" onClick="logVariable('compare_scale_clause')" href="../../_variables/compare_scale_clause.html">$compare_scale_clause</a>
<a name="l1395"><span class="linenum">1395</span></a>                                          ORDER BY courseid&quot;, <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>, <a class="constant" onClick="logConstant('IGNORE_MULTIPLE')" href="../../_constants/IGNORE_MULTIPLE.html" onMouseOver="constPopup(event,'IGNORE_MULTIPLE')">IGNORE_MULTIPLE</a>)) {
<a name="l1396"><span class="linenum">1396</span></a>  <span class="comment">            // Remap the user if possible, defaut to user performing the restore if not</span>
<a name="l1397"><span class="linenum">1397</span></a>              <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>);
<a name="l1398"><span class="linenum">1398</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> = <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> ? <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> : <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>();
<a name="l1399"><span class="linenum">1399</span></a>  <span class="comment">            // Remap the course if course scale</span>
<a name="l1400"><span class="linenum">1400</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a> ? <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>() : 0;
<a name="l1401"><span class="linenum">1401</span></a>  <span class="comment">            // If global scale (course=0), check the user has perms to create it</span>
<a name="l1402"><span class="linenum">1402</span></a>  <span class="comment">            // falling to course scale if not</span>
<a name="l1403"><span class="linenum">1403</span></a>              <a class="var it15387" onMouseOver="hilite(15387)" onMouseOut="lolite()" onClick="logVariable('systemctx')" href="../../_variables/systemctx.html">$systemctx</a> = <a class="class" onClick="logClass('context_system')" href="../../_classes/context_system.html" onMouseOver="classPopup(event,'context_system')">context_system</a>::<a class="function" onClick="logFunction('instance')" href="../../_functions/instance.html" onMouseOver="funcPopup(event,'instance')">instance</a>();
<a name="l1404"><span class="linenum">1404</span></a>              if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a> == 0 &amp;&amp; !<a class="function" onClick="logFunction('has_capability')" href="../../_functions/has_capability.html" onMouseOver="funcPopup(event,'has_capability')">has_capability</a>('moodle/course:managescales', <a class="var it15387" onMouseOver="hilite(15387)" onMouseOut="lolite()" onClick="logVariable('systemctx')" href="../../_variables/systemctx.html">$systemctx</a> , <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>())) {
<a name="l1405"><span class="linenum">1405</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l1406"><span class="linenum">1406</span></a>              }
<a name="l1407"><span class="linenum">1407</span></a>  <span class="comment">            // scale doesn't exist, create</span>
<a name="l1408"><span class="linenum">1408</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('scale', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l1409"><span class="linenum">1409</span></a>              <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a> = true; <span class="comment">// We'll restore the files</span>
<a name="l1410"><span class="linenum">1410</span></a>          } else {
<a name="l1411"><span class="linenum">1411</span></a>  <span class="comment">            // scale exists, use it</span>
<a name="l1412"><span class="linenum">1412</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it15386" onMouseOver="hilite(15386)" onMouseOut="lolite()" onClick="logVariable('scadb')" href="../../_variables/scadb.html">$scadb</a>-&gt;<a onClick="logVariable('id')" class="var it45295" onMouseOver="hilite(45295)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l1413"><span class="linenum">1413</span></a>          }
<a name="l1414"><span class="linenum">1414</span></a>  <span class="comment">        // Save the id mapping (with files support at system context)</span>
<a name="l1415"><span class="linenum">1415</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('scale', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>, <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_old_system_contextid')" href="../../_functions/get_old_system_contextid.html" onMouseOver="funcPopup(event,'get_old_system_contextid')">get_old_system_contextid</a>());
<a name="l1416"><span class="linenum">1416</span></a>      }
<a name="l1417"><span class="linenum">1417</span></a>  
<a name="l1418"><span class="linenum">1418</span></a>      protected function <a class="function" onClick="logFunction('after_execute')" href="../../_functions/after_execute.html" onMouseOver="funcPopup(event,'after_execute')">after_execute</a>() {
<a name="l1419"><span class="linenum">1419</span></a>  <span class="comment">        // Add scales related files, matching with &quot;scale&quot; mappings</span>
<a name="l1420"><span class="linenum">1420</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_related_files')" href="../../_functions/add_related_files.html" onMouseOver="funcPopup(event,'add_related_files')">add_related_files</a>('grade', 'scale', 'scale', <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_old_system_contextid')" href="../../_functions/get_old_system_contextid.html" onMouseOver="funcPopup(event,'get_old_system_contextid')">get_old_system_contextid</a>());
<a name="l1421"><span class="linenum">1421</span></a>      }
<a name="l1422"><span class="linenum">1422</span></a>  }
<a name="l1423"><span class="linenum">1423</span></a>  
<a name="l1424"><span class="linenum">1424</span></a>  
<a name="l1425"><span class="linenum">1425</span></a>  <span class="comment">/**</span>
<a name="l1426"><span class="linenum">1426</span></a>  <span class="comment"> * Structure step that will create all the needed outocomes</span>
<a name="l1427"><span class="linenum">1427</span></a>  <span class="comment"> * by loading them from the outcomes.xml</span>
<a name="l1428"><span class="linenum">1428</span></a>  <span class="comment"> */</span>
<a name="l1429"><span class="linenum">1429</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_outcomes_structure_step')" href="../../_classes/restore_outcomes_structure_step.html" onMouseOver="classPopup(event,'restore_outcomes_structure_step')">restore_outcomes_structure_step</a> extends restore_structure_step {
<a name="l1430"><span class="linenum">1430</span></a>  
<a name="l1431"><span class="linenum">1431</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l1432"><span class="linenum">1432</span></a>  
<a name="l1433"><span class="linenum">1433</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array(); <span class="comment">// Add paths here</span>
<a name="l1434"><span class="linenum">1434</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('outcome', '/outcomes_definition/outcome');
<a name="l1435"><span class="linenum">1435</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l1436"><span class="linenum">1436</span></a>      }
<a name="l1437"><span class="linenum">1437</span></a>  
<a name="l1438"><span class="linenum">1438</span></a>      protected function <a class="function" onClick="logFunction('process_outcome')" href="../../_functions/process_outcome.html" onMouseOver="funcPopup(event,'process_outcome')">process_outcome</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l1439"><span class="linenum">1439</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l1440"><span class="linenum">1440</span></a>  
<a name="l1441"><span class="linenum">1441</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l1442"><span class="linenum">1442</span></a>  
<a name="l1443"><span class="linenum">1443</span></a>          <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a> = false; <span class="comment">// Only if we end creating the group</span>
<a name="l1444"><span class="linenum">1444</span></a>  
<a name="l1445"><span class="linenum">1445</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;    <span class="comment">// need this saved for later</span>
<a name="l1446"><span class="linenum">1446</span></a>  
<a name="l1447"><span class="linenum">1447</span></a>  <span class="comment">        // Look for outcome (by shortname both in standard (courseid=null) and current course</span>
<a name="l1448"><span class="linenum">1448</span></a>  <span class="comment">        // with priority to standard outcomes (ORDER clause)</span>
<a name="l1449"><span class="linenum">1449</span></a>  <span class="comment">        // outcome is not course unique, use get_record_sql to suppress warning</span>
<a name="l1450"><span class="linenum">1450</span></a>          <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array('courseid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(), 'shortname' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('shortname')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/shortname.html">shortname</a>);
<a name="l1451"><span class="linenum">1451</span></a>          if (!<a class="var it15388" onMouseOver="hilite(15388)" onMouseOut="lolite()" onClick="logVariable('outdb')" href="../../_variables/outdb.html">$outdb</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record_sql')" href="../../_functions/get_record_sql.html" onMouseOver="funcPopup(event,'get_record_sql')">get_record_sql</a>('SELECT *
<a name="l1452"><span class="linenum">1452</span></a>                                               FROM {grade_outcomes}
<a name="l1453"><span class="linenum">1453</span></a>                                              WHERE shortname = :shortname
<a name="l1454"><span class="linenum">1454</span></a>                                                AND (courseid = :courseid OR courseid IS NULL)
<a name="l1455"><span class="linenum">1455</span></a>                                           ORDER BY COALESCE(courseid, 0)', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>, <a class="constant" onClick="logConstant('IGNORE_MULTIPLE')" href="../../_constants/IGNORE_MULTIPLE.html" onMouseOver="constPopup(event,'IGNORE_MULTIPLE')">IGNORE_MULTIPLE</a>)) {
<a name="l1456"><span class="linenum">1456</span></a>  <span class="comment">            // Remap the user</span>
<a name="l1457"><span class="linenum">1457</span></a>              <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usermodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usermodified.html">usermodified</a>);
<a name="l1458"><span class="linenum">1458</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usermodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usermodified.html">usermodified</a> = <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> ? <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> : <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>();
<a name="l1459"><span class="linenum">1459</span></a>  <span class="comment">            // Remap the scale</span>
<a name="l1460"><span class="linenum">1460</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('scaleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/scaleid.html">scaleid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('scale', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('scaleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/scaleid.html">scaleid</a>);
<a name="l1461"><span class="linenum">1461</span></a>  <span class="comment">            // Remap the course if course outcome</span>
<a name="l1462"><span class="linenum">1462</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a> ? <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>() : null;
<a name="l1463"><span class="linenum">1463</span></a>  <span class="comment">            // If global outcome (course=null), check the user has perms to create it</span>
<a name="l1464"><span class="linenum">1464</span></a>  <span class="comment">            // falling to course outcome if not</span>
<a name="l1465"><span class="linenum">1465</span></a>              <a class="var it15387" onMouseOver="hilite(15387)" onMouseOut="lolite()" onClick="logVariable('systemctx')" href="../../_variables/systemctx.html">$systemctx</a> = <a class="class" onClick="logClass('context_system')" href="../../_classes/context_system.html" onMouseOver="classPopup(event,'context_system')">context_system</a>::<a class="function" onClick="logFunction('instance')" href="../../_functions/instance.html" onMouseOver="funcPopup(event,'instance')">instance</a>();
<a name="l1466"><span class="linenum">1466</span></a>              if (<a class="phpfunction" onClick="logFunction('is_null')" href="../../_functions/is_null.html" onMouseOver="phpfuncPopup(event,'is_null')">is_null</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a>) &amp;&amp; !<a class="function" onClick="logFunction('has_capability')" href="../../_functions/has_capability.html" onMouseOver="funcPopup(event,'has_capability')">has_capability</a>('moodle/grade:manageoutcomes', <a class="var it15387" onMouseOver="hilite(15387)" onMouseOut="lolite()" onClick="logVariable('systemctx')" href="../../_variables/systemctx.html">$systemctx</a> , <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>())) {
<a name="l1467"><span class="linenum">1467</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l1468"><span class="linenum">1468</span></a>              }
<a name="l1469"><span class="linenum">1469</span></a>  <span class="comment">            // outcome doesn't exist, create</span>
<a name="l1470"><span class="linenum">1470</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('grade_outcomes', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l1471"><span class="linenum">1471</span></a>              <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a> = true; <span class="comment">// We'll restore the files</span>
<a name="l1472"><span class="linenum">1472</span></a>          } else {
<a name="l1473"><span class="linenum">1473</span></a>  <span class="comment">            // scale exists, use it</span>
<a name="l1474"><span class="linenum">1474</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it15388" onMouseOver="hilite(15388)" onMouseOut="lolite()" onClick="logVariable('outdb')" href="../../_variables/outdb.html">$outdb</a>-&gt;<a onClick="logVariable('id')" class="var it45296" onMouseOver="hilite(45296)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l1475"><span class="linenum">1475</span></a>          }
<a name="l1476"><span class="linenum">1476</span></a>  <span class="comment">        // Set the corresponding grade_outcomes_courses record</span>
<a name="l1477"><span class="linenum">1477</span></a>          <a class="var it15389" onMouseOver="hilite(15389)" onMouseOut="lolite()" onClick="logVariable('outcourserec')" href="../../_variables/outcourserec.html">$outcourserec</a> = new stdclass();
<a name="l1478"><span class="linenum">1478</span></a>          <a class="var it15389" onMouseOver="hilite(15389)" onMouseOut="lolite()" onClick="logVariable('outcourserec')" href="../../_variables/outcourserec.html">$outcourserec</a>-&gt;<a onClick="logVariable('courseid')" class="var it45297" onMouseOver="hilite(45297)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a>  = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l1479"><span class="linenum">1479</span></a>          <a class="var it15389" onMouseOver="hilite(15389)" onMouseOut="lolite()" onClick="logVariable('outcourserec')" href="../../_variables/outcourserec.html">$outcourserec</a>-&gt;<a onClick="logVariable('outcomeid')" class="var it45297" onMouseOver="hilite(45297)" onMouseOut="lolite()" href="../../_variables/outcomeid.html">outcomeid</a> = <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>;
<a name="l1480"><span class="linenum">1480</span></a>          if (!<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists')" href="../../_functions/record_exists.html" onMouseOver="funcPopup(event,'record_exists')">record_exists</a>('grade_outcomes_courses', (array)<a class="var it15389" onMouseOver="hilite(15389)" onMouseOut="lolite()" onClick="logVariable('outcourserec')" href="../../_variables/outcourserec.html">$outcourserec</a>)) {
<a name="l1481"><span class="linenum">1481</span></a>              <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('grade_outcomes_courses', <a class="var it15389" onMouseOver="hilite(15389)" onMouseOut="lolite()" onClick="logVariable('outcourserec')" href="../../_variables/outcourserec.html">$outcourserec</a>);
<a name="l1482"><span class="linenum">1482</span></a>          }
<a name="l1483"><span class="linenum">1483</span></a>  <span class="comment">        // Save the id mapping (with files support at system context)</span>
<a name="l1484"><span class="linenum">1484</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('outcome', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>, <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_old_system_contextid')" href="../../_functions/get_old_system_contextid.html" onMouseOver="funcPopup(event,'get_old_system_contextid')">get_old_system_contextid</a>());
<a name="l1485"><span class="linenum">1485</span></a>      }
<a name="l1486"><span class="linenum">1486</span></a>  
<a name="l1487"><span class="linenum">1487</span></a>      protected function <a class="function" onClick="logFunction('after_execute')" href="../../_functions/after_execute.html" onMouseOver="funcPopup(event,'after_execute')">after_execute</a>() {
<a name="l1488"><span class="linenum">1488</span></a>  <span class="comment">        // Add outcomes related files, matching with &quot;outcome&quot; mappings</span>
<a name="l1489"><span class="linenum">1489</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_related_files')" href="../../_functions/add_related_files.html" onMouseOver="funcPopup(event,'add_related_files')">add_related_files</a>('grade', 'outcome', 'outcome', <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_old_system_contextid')" href="../../_functions/get_old_system_contextid.html" onMouseOver="funcPopup(event,'get_old_system_contextid')">get_old_system_contextid</a>());
<a name="l1490"><span class="linenum">1490</span></a>      }
<a name="l1491"><span class="linenum">1491</span></a>  }
<a name="l1492"><span class="linenum">1492</span></a>  
<a name="l1493"><span class="linenum">1493</span></a>  <span class="comment">/**</span>
<a name="l1494"><span class="linenum">1494</span></a>  <span class="comment"> * Execution step that, *conditionally* (if there isn't preloaded information</span>
<a name="l1495"><span class="linenum">1495</span></a>  <span class="comment"> * will load all the question categories and questions (header info only)</span>
<a name="l1496"><span class="linenum">1496</span></a>  <span class="comment"> * to backup_temp_ids. They will be stored with &quot;question_category&quot; and</span>
<a name="l1497"><span class="linenum">1497</span></a>  <span class="comment"> * &quot;question&quot; itemnames and with their original contextid and question category</span>
<a name="l1498"><span class="linenum">1498</span></a>  <span class="comment"> * id as paremitemids</span>
<a name="l1499"><span class="linenum">1499</span></a>  <span class="comment"> */</span>
<a name="l1500"><span class="linenum">1500</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_load_categories_and_questions')" href="../../_classes/restore_load_categories_and_questions.html" onMouseOver="classPopup(event,'restore_load_categories_and_questions')">restore_load_categories_and_questions</a> extends restore_execution_step {
<a name="l1501"><span class="linenum">1501</span></a>  
<a name="l1502"><span class="linenum">1502</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l1503"><span class="linenum">1503</span></a>  
<a name="l1504"><span class="linenum">1504</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_preloaded_information')" href="../../_functions/get_preloaded_information.html" onMouseOver="funcPopup(event,'get_preloaded_information')">get_preloaded_information</a>()) { // if info is already preloaded, nothing to do
<a name="l1505"><span class="linenum">1505</span></a>              return;
<a name="l1506"><span class="linenum">1506</span></a>          }
<a name="l1507"><span class="linenum">1507</span></a>          <a class="var it297" onMouseOver="hilite(297)" onMouseOut="lolite()" onClick="logVariable('file')" href="../../_variables/file.html">$file</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_basepath')" href="../../_functions/get_basepath.html" onMouseOver="funcPopup(event,'get_basepath')">get_basepath</a>() . '/questions.xml';
<a name="l1508"><span class="linenum">1508</span></a>          restore_dbops::<a class="function" onClick="logFunction('load_categories_and_questions_to_tempids')" href="../../_functions/load_categories_and_questions_to_tempids.html" onMouseOver="funcPopup(event,'load_categories_and_questions_to_tempids')">load_categories_and_questions_to_tempids</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), <a class="var it297" onMouseOver="hilite(297)" onMouseOut="lolite()" onClick="logVariable('file')" href="../../_variables/file.html">$file</a>);
<a name="l1509"><span class="linenum">1509</span></a>      }
<a name="l1510"><span class="linenum">1510</span></a>  }
<a name="l1511"><span class="linenum">1511</span></a>  
<a name="l1512"><span class="linenum">1512</span></a>  <span class="comment">/**</span>
<a name="l1513"><span class="linenum">1513</span></a>  <span class="comment"> * Execution step that, *conditionally* (if there isn't preloaded information)</span>
<a name="l1514"><span class="linenum">1514</span></a>  <span class="comment"> * will process all the needed categories and questions</span>
<a name="l1515"><span class="linenum">1515</span></a>  <span class="comment"> * in order to decide and perform any action with them (create / map / error)</span>
<a name="l1516"><span class="linenum">1516</span></a>  <span class="comment"> * Note: Any error will cause exception, as far as this is the same processing</span>
<a name="l1517"><span class="linenum">1517</span></a>  <span class="comment"> * than the one into restore prechecks (that should have stopped process earlier)</span>
<a name="l1518"><span class="linenum">1518</span></a>  <span class="comment"> */</span>
<a name="l1519"><span class="linenum">1519</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_process_categories_and_questions')" href="../../_classes/restore_process_categories_and_questions.html" onMouseOver="classPopup(event,'restore_process_categories_and_questions')">restore_process_categories_and_questions</a> extends restore_execution_step {
<a name="l1520"><span class="linenum">1520</span></a>  
<a name="l1521"><span class="linenum">1521</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l1522"><span class="linenum">1522</span></a>  
<a name="l1523"><span class="linenum">1523</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_preloaded_information')" href="../../_functions/get_preloaded_information.html" onMouseOver="funcPopup(event,'get_preloaded_information')">get_preloaded_information</a>()) { // if info is already preloaded, nothing to do
<a name="l1524"><span class="linenum">1524</span></a>              return;
<a name="l1525"><span class="linenum">1525</span></a>          }
<a name="l1526"><span class="linenum">1526</span></a>          restore_dbops::<a class="function" onClick="logFunction('process_categories_and_questions')" href="../../_functions/process_categories_and_questions.html" onMouseOver="funcPopup(event,'process_categories_and_questions')">process_categories_and_questions</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('is_samesite')" href="../../_functions/is_samesite.html" onMouseOver="funcPopup(event,'is_samesite')">is_samesite</a>());
<a name="l1527"><span class="linenum">1527</span></a>      }
<a name="l1528"><span class="linenum">1528</span></a>  }
<a name="l1529"><span class="linenum">1529</span></a>  
<a name="l1530"><span class="linenum">1530</span></a>  <span class="comment">/**</span>
<a name="l1531"><span class="linenum">1531</span></a>  <span class="comment"> * Structure step that will read the section.xml creating/updating sections</span>
<a name="l1532"><span class="linenum">1532</span></a>  <span class="comment"> * as needed, rebuilding course cache and other friends</span>
<a name="l1533"><span class="linenum">1533</span></a>  <span class="comment"> */</span>
<a name="l1534"><span class="linenum">1534</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_section_structure_step')" href="../../_classes/restore_section_structure_step.html" onMouseOver="classPopup(event,'restore_section_structure_step')">restore_section_structure_step</a> extends restore_structure_step {
<a name="l1535"><span class="linenum">1535</span></a>  <span class="comment">    /** @var array Cache: Array of id =&gt; course format */</span>
<a name="l1536"><span class="linenum">1536</span></a>      private static <a class="var it3117" onMouseOver="hilite(3117)" onMouseOut="lolite()" onClick="logVariable('courseformats')" href="../../_variables/courseformats.html">$courseformats</a> = array();
<a name="l1537"><span class="linenum">1537</span></a>  
<a name="l1538"><span class="linenum">1538</span></a>      <span class="comment">/**</span>
<a name="l1539"><span class="linenum">1539</span></a>  <span class="comment">     * Resets a static cache of course formats. Required for unit testing.</span>
<a name="l1540"><span class="linenum">1540</span></a>  <span class="comment">     */</span>
<a name="l1541"><span class="linenum">1541</span></a>      public static function <a class="function" onClick="logFunction('reset_caches')" href="../../_functions/reset_caches.html" onMouseOver="funcPopup(event,'reset_caches')">reset_caches</a>() {
<a name="l1542"><span class="linenum">1542</span></a>          self::<a class="var it3117" onMouseOver="hilite(3117)" onMouseOut="lolite()" onClick="logVariable('courseformats')" href="../../_variables/courseformats.html">$courseformats</a> = array();
<a name="l1543"><span class="linenum">1543</span></a>      }
<a name="l1544"><span class="linenum">1544</span></a>  
<a name="l1545"><span class="linenum">1545</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l1546"><span class="linenum">1546</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>;
<a name="l1547"><span class="linenum">1547</span></a>  
<a name="l1548"><span class="linenum">1548</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array();
<a name="l1549"><span class="linenum">1549</span></a>  
<a name="l1550"><span class="linenum">1550</span></a>          <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a> = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('section', '/section');
<a name="l1551"><span class="linenum">1551</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>;
<a name="l1552"><span class="linenum">1552</span></a>          if (<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('enableavailability')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/enableavailability.html">enableavailability</a>) {
<a name="l1553"><span class="linenum">1553</span></a>              <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('availability', '/section/availability');
<a name="l1554"><span class="linenum">1554</span></a>              <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('availability_field', '/section/availability_field');
<a name="l1555"><span class="linenum">1555</span></a>          }
<a name="l1556"><span class="linenum">1556</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('course_format_options', '/section/course_format_options');
<a name="l1557"><span class="linenum">1557</span></a>  
<a name="l1558"><span class="linenum">1558</span></a>  <span class="comment">        // Apply for 'format' plugins optional paths at section level</span>
<a name="l1559"><span class="linenum">1559</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('format', <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>);
<a name="l1560"><span class="linenum">1560</span></a>  
<a name="l1561"><span class="linenum">1561</span></a>  <span class="comment">        // Apply for 'local' plugins optional paths at section level</span>
<a name="l1562"><span class="linenum">1562</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('local', <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>);
<a name="l1563"><span class="linenum">1563</span></a>  
<a name="l1564"><span class="linenum">1564</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l1565"><span class="linenum">1565</span></a>      }
<a name="l1566"><span class="linenum">1566</span></a>  
<a name="l1567"><span class="linenum">1567</span></a>      public function <a class="function" onClick="logFunction('process_section')" href="../../_functions/process_section.html" onMouseOver="funcPopup(event,'process_section')">process_section</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l1568"><span class="linenum">1568</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l1569"><span class="linenum">1569</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l1570"><span class="linenum">1570</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>; <span class="comment">// We'll need this later</span>
<a name="l1571"><span class="linenum">1571</span></a>  
<a name="l1572"><span class="linenum">1572</span></a>          <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a> = false;
<a name="l1573"><span class="linenum">1573</span></a>  
<a name="l1574"><span class="linenum">1574</span></a>  <span class="comment">        // Look for the section</span>
<a name="l1575"><span class="linenum">1575</span></a>          <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a> = new stdclass();
<a name="l1576"><span class="linenum">1576</span></a>          <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>-&gt;<a onClick="logVariable('course')" class="var it43306" onMouseOver="hilite(43306)" onMouseOut="lolite()" href="../../_variables/course.html">course</a>  = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l1577"><span class="linenum">1577</span></a>          <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>-&gt;<a onClick="logVariable('section')" class="var it43306" onMouseOver="hilite(43306)" onMouseOut="lolite()" href="../../_variables/section.html">section</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('number')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/number.html">number</a>;
<a name="l1578"><span class="linenum">1578</span></a>  <span class="comment">        // Section doesn't exist, create it with all the info from backup</span>
<a name="l1579"><span class="linenum">1579</span></a>          if (!<a class="var it15339" onMouseOver="hilite(15339)" onMouseOut="lolite()" onClick="logVariable('secrec')" href="../../_variables/secrec.html">$secrec</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('course_sections', (array)<a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>)) {
<a name="l1580"><span class="linenum">1580</span></a>              <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>-&gt;<a onClick="logVariable('name')" class="var it43306" onMouseOver="hilite(43306)" onMouseOut="lolite()" href="../../_variables/name.html">name</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('name')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/name.html">name</a>;
<a name="l1581"><span class="linenum">1581</span></a>              <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>-&gt;<a onClick="logVariable('summary')" class="var it43306" onMouseOver="hilite(43306)" onMouseOut="lolite()" href="../../_variables/summary.html">summary</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('summary')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/summary.html">summary</a>;
<a name="l1582"><span class="linenum">1582</span></a>              <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>-&gt;<a onClick="logVariable('summaryformat')" class="var it43306" onMouseOver="hilite(43306)" onMouseOut="lolite()" href="../../_variables/summaryformat.html">summaryformat</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('summaryformat')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/summaryformat.html">summaryformat</a>;
<a name="l1583"><span class="linenum">1583</span></a>              <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>-&gt;<a onClick="logVariable('sequence')" class="var it43306" onMouseOver="hilite(43306)" onMouseOut="lolite()" href="../../_variables/sequence.html">sequence</a> = '';
<a name="l1584"><span class="linenum">1584</span></a>              <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>-&gt;<a onClick="logVariable('visible')" class="var it43306" onMouseOver="hilite(43306)" onMouseOut="lolite()" href="../../_variables/visible.html">visible</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('visible')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/visible.html">visible</a>;
<a name="l1585"><span class="linenum">1585</span></a>              if (empty(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('enableavailability')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/enableavailability.html">enableavailability</a>)) { // Process availability information only if enabled.
<a name="l1586"><span class="linenum">1586</span></a>                  <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>-&gt;<a onClick="logVariable('availability')" class="var it43306" onMouseOver="hilite(43306)" onMouseOut="lolite()" href="../../_variables/availability.html">availability</a> = null;
<a name="l1587"><span class="linenum">1587</span></a>              } else {
<a name="l1588"><span class="linenum">1588</span></a>                  <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>-&gt;<a onClick="logVariable('availability')" class="var it43306" onMouseOver="hilite(43306)" onMouseOut="lolite()" href="../../_variables/availability.html">availability</a> = isset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('availabilityjson')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/availabilityjson.html">availabilityjson</a>) ? <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('availabilityjson')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/availabilityjson.html">availabilityjson</a> : null;
<a name="l1589"><span class="linenum">1589</span></a>  <span class="comment">                // Include legacy [&lt;2.7] availability data if provided.</span>
<a name="l1590"><span class="linenum">1590</span></a>                  if (<a class="phpfunction" onClick="logFunction('is_null')" href="../../_functions/is_null.html" onMouseOver="phpfuncPopup(event,'is_null')">is_null</a>(<a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>-&gt;<a onClick="logVariable('availability')" class="var it43306" onMouseOver="hilite(43306)" onMouseOut="lolite()" href="../../_variables/availability.html">availability</a>)) {
<a name="l1591"><span class="linenum">1591</span></a>                      <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>-&gt;<a onClick="logVariable('availability')" class="var it43306" onMouseOver="hilite(43306)" onMouseOut="lolite()" href="../../_variables/availability.html">availability</a> = \core_availability\<a class="class" onClick="logClass('info')" href="../../_classes/info.html" onMouseOver="classPopup(event,'info')">info</a>::<a class="function" onClick="logFunction('convert_legacy_fields')" href="../../_functions/convert_legacy_fields.html" onMouseOver="funcPopup(event,'convert_legacy_fields')">convert_legacy_fields</a>(
<a name="l1592"><span class="linenum">1592</span></a>                              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, true);
<a name="l1593"><span class="linenum">1593</span></a>                  }
<a name="l1594"><span class="linenum">1594</span></a>              }
<a name="l1595"><span class="linenum">1595</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('course_sections', <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>);
<a name="l1596"><span class="linenum">1596</span></a>              <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a> = true;
<a name="l1597"><span class="linenum">1597</span></a>  
<a name="l1598"><span class="linenum">1598</span></a>  <span class="comment">        // Section exists, update non-empty information</span>
<a name="l1599"><span class="linenum">1599</span></a>          } else {
<a name="l1600"><span class="linenum">1600</span></a>              <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>-&gt;<a onClick="logVariable('id')" class="var it43306" onMouseOver="hilite(43306)" onMouseOut="lolite()" href="../../_variables/id.html">id</a> = <a class="var it15339" onMouseOver="hilite(15339)" onMouseOut="lolite()" onClick="logVariable('secrec')" href="../../_variables/secrec.html">$secrec</a>-&gt;<a onClick="logVariable('id')" class="var it45164" onMouseOver="hilite(45164)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l1601"><span class="linenum">1601</span></a>              if ((string)<a class="var it15339" onMouseOver="hilite(15339)" onMouseOut="lolite()" onClick="logVariable('secrec')" href="../../_variables/secrec.html">$secrec</a>-&gt;<a onClick="logVariable('name')" class="var it45164" onMouseOver="hilite(45164)" onMouseOut="lolite()" href="../../_variables/name.html">name</a> === '') {
<a name="l1602"><span class="linenum">1602</span></a>                  <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>-&gt;<a onClick="logVariable('name')" class="var it43306" onMouseOver="hilite(43306)" onMouseOut="lolite()" href="../../_variables/name.html">name</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('name')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/name.html">name</a>;
<a name="l1603"><span class="linenum">1603</span></a>              }
<a name="l1604"><span class="linenum">1604</span></a>              if (empty(<a class="var it15339" onMouseOver="hilite(15339)" onMouseOut="lolite()" onClick="logVariable('secrec')" href="../../_variables/secrec.html">$secrec</a>-&gt;<a onClick="logVariable('summary')" class="var it45164" onMouseOver="hilite(45164)" onMouseOut="lolite()" href="../../_variables/summary.html">summary</a>)) {
<a name="l1605"><span class="linenum">1605</span></a>                  <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>-&gt;<a onClick="logVariable('summary')" class="var it43306" onMouseOver="hilite(43306)" onMouseOut="lolite()" href="../../_variables/summary.html">summary</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('summary')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/summary.html">summary</a>;
<a name="l1606"><span class="linenum">1606</span></a>                  <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>-&gt;<a onClick="logVariable('summaryformat')" class="var it43306" onMouseOver="hilite(43306)" onMouseOut="lolite()" href="../../_variables/summaryformat.html">summaryformat</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('summaryformat')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/summaryformat.html">summaryformat</a>;
<a name="l1607"><span class="linenum">1607</span></a>                  <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a> = true;
<a name="l1608"><span class="linenum">1608</span></a>              }
<a name="l1609"><span class="linenum">1609</span></a>  
<a name="l1610"><span class="linenum">1610</span></a>  <span class="comment">            // Don't update availability (I didn't see a useful way to define</span>
<a name="l1611"><span class="linenum">1611</span></a>  <span class="comment">            // whether existing or new one should take precedence).</span>
<a name="l1612"><span class="linenum">1612</span></a>  
<a name="l1613"><span class="linenum">1613</span></a>              <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('update_record')" href="../../_functions/update_record.html" onMouseOver="funcPopup(event,'update_record')">update_record</a>('course_sections', <a class="var it989" onMouseOver="hilite(989)" onMouseOut="lolite()" onClick="logVariable('section')" href="../../_variables/section.html">$section</a>);
<a name="l1614"><span class="linenum">1614</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it15339" onMouseOver="hilite(15339)" onMouseOut="lolite()" onClick="logVariable('secrec')" href="../../_variables/secrec.html">$secrec</a>-&gt;<a onClick="logVariable('id')" class="var it45164" onMouseOver="hilite(45164)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l1615"><span class="linenum">1615</span></a>          }
<a name="l1616"><span class="linenum">1616</span></a>  
<a name="l1617"><span class="linenum">1617</span></a>  <span class="comment">        // Annotate the section mapping, with restorefiles option if needed</span>
<a name="l1618"><span class="linenum">1618</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('course_section', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>, <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a>);
<a name="l1619"><span class="linenum">1619</span></a>  
<a name="l1620"><span class="linenum">1620</span></a>  <span class="comment">        // set the new course_section id in the task</span>
<a name="l1621"><span class="linenum">1621</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('set_sectionid')" href="../../_functions/set_sectionid.html" onMouseOver="funcPopup(event,'set_sectionid')">set_sectionid</a>(<a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>);
<a name="l1622"><span class="linenum">1622</span></a>  
<a name="l1623"><span class="linenum">1623</span></a>  <span class="comment">        // If there is the legacy showavailability data, store this for later use.</span>
<a name="l1624"><span class="linenum">1624</span></a>  <span class="comment">        // (This data is not present when restoring 'new' backups.)</span>
<a name="l1625"><span class="linenum">1625</span></a>          if (isset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('showavailability')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/showavailability.html">showavailability</a>)) {
<a name="l1626"><span class="linenum">1626</span></a>  <span class="comment">            // Cache the showavailability flag using the backup_ids data field.</span>
<a name="l1627"><span class="linenum">1627</span></a>              restore_dbops::<a class="function" onClick="logFunction('set_backup_ids_record')" href="../../_functions/set_backup_ids_record.html" onMouseOver="funcPopup(event,'set_backup_ids_record')">set_backup_ids_record</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(),
<a name="l1628"><span class="linenum">1628</span></a>                      'section_showavailability', <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>, 0, null,
<a name="l1629"><span class="linenum">1629</span></a>                      (object)array('showavailability' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('showavailability')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/showavailability.html">showavailability</a>));
<a name="l1630"><span class="linenum">1630</span></a>          }
<a name="l1631"><span class="linenum">1631</span></a>  
<a name="l1632"><span class="linenum">1632</span></a>  <span class="comment">        // Commented out. We never modify course-&gt;numsections as far as that is used</span>
<a name="l1633"><span class="linenum">1633</span></a>  <span class="comment">        // by a lot of people to &quot;hide&quot; sections on purpose (so this remains as used to be in Moodle 1.x)</span>
<a name="l1634"><span class="linenum">1634</span></a>  <span class="comment">        // Note: We keep the code here, to know about and because of the possibility of making this</span>
<a name="l1635"><span class="linenum">1635</span></a>  <span class="comment">        // optional based on some setting/attribute in the future</span>
<a name="l1636"><span class="linenum">1636</span></a>  <span class="comment">        // If needed, adjust course-&gt;numsections</span>
<a name="l1637"><span class="linenum">1637</span></a>  <span class="comment">        //if ($numsections = $DB-&gt;get_field('course', 'numsections', array('id' =&gt; $this-&gt;get_courseid()))) {</span>
<a name="l1638"><span class="linenum">1638</span></a>  <span class="comment">        //    if ($numsections &lt; $section-&gt;section) {</span>
<a name="l1639"><span class="linenum">1639</span></a>  <span class="comment">        //        $DB-&gt;set_field('course', 'numsections', $section-&gt;section, array('id' =&gt; $this-&gt;get_courseid()));</span>
<a name="l1640"><span class="linenum">1640</span></a>  <span class="comment">        //    }</span>
<a name="l1641"><span class="linenum">1641</span></a>  <span class="comment">        //}</span>
<a name="l1642"><span class="linenum">1642</span></a>      }
<a name="l1643"><span class="linenum">1643</span></a>  
<a name="l1644"><span class="linenum">1644</span></a>      <span class="comment">/**</span>
<a name="l1645"><span class="linenum">1645</span></a>  <span class="comment">     * Process the legacy availability table record. This table does not exist</span>
<a name="l1646"><span class="linenum">1646</span></a>  <span class="comment">     * in Moodle 2.7+ but we still support restore.</span>
<a name="l1647"><span class="linenum">1647</span></a>  <span class="comment">     *</span>
<a name="l1648"><span class="linenum">1648</span></a>  <span class="comment">     * @param stdClass $data Record data</span>
<a name="l1649"><span class="linenum">1649</span></a>  <span class="comment">     */</span>
<a name="l1650"><span class="linenum">1650</span></a>      public function <a class="function" onClick="logFunction('process_availability')" href="../../_functions/process_availability.html" onMouseOver="funcPopup(event,'process_availability')">process_availability</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l1651"><span class="linenum">1651</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l1652"><span class="linenum">1652</span></a>  <span class="comment">        // Simply going to store the whole availability record now, we'll process</span>
<a name="l1653"><span class="linenum">1653</span></a>  <span class="comment">        // all them later in the final task (once all activities have been restored)</span>
<a name="l1654"><span class="linenum">1654</span></a>  <span class="comment">        // Let's call the low level one to be able to store the whole object.</span>
<a name="l1655"><span class="linenum">1655</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('coursesectionid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/coursesectionid.html">coursesectionid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_sectionid')" href="../../_functions/get_sectionid.html" onMouseOver="funcPopup(event,'get_sectionid')">get_sectionid</a>();
<a name="l1656"><span class="linenum">1656</span></a>          restore_dbops::<a class="function" onClick="logFunction('set_backup_ids_record')" href="../../_functions/set_backup_ids_record.html" onMouseOver="funcPopup(event,'set_backup_ids_record')">set_backup_ids_record</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(),
<a name="l1657"><span class="linenum">1657</span></a>                  'section_availability', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, 0, null, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l1658"><span class="linenum">1658</span></a>      }
<a name="l1659"><span class="linenum">1659</span></a>  
<a name="l1660"><span class="linenum">1660</span></a>      <span class="comment">/**</span>
<a name="l1661"><span class="linenum">1661</span></a>  <span class="comment">     * Process the legacy availability fields table record. This table does not</span>
<a name="l1662"><span class="linenum">1662</span></a>  <span class="comment">     * exist in Moodle 2.7+ but we still support restore.</span>
<a name="l1663"><span class="linenum">1663</span></a>  <span class="comment">     *</span>
<a name="l1664"><span class="linenum">1664</span></a>  <span class="comment">     * @param stdClass $data Record data</span>
<a name="l1665"><span class="linenum">1665</span></a>  <span class="comment">     */</span>
<a name="l1666"><span class="linenum">1666</span></a>      public function <a class="function" onClick="logFunction('process_availability_field')" href="../../_functions/process_availability_field.html" onMouseOver="funcPopup(event,'process_availability_field')">process_availability_field</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l1667"><span class="linenum">1667</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l1668"><span class="linenum">1668</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l1669"><span class="linenum">1669</span></a>  <span class="comment">        // Mark it is as passed by default</span>
<a name="l1670"><span class="linenum">1670</span></a>          <a class="var it15392" onMouseOver="hilite(15392)" onMouseOut="lolite()" onClick="logVariable('passed')" href="../../_variables/passed.html">$passed</a> = true;
<a name="l1671"><span class="linenum">1671</span></a>          <a class="var it15393" onMouseOver="hilite(15393)" onMouseOut="lolite()" onClick="logVariable('customfieldid')" href="../../_variables/customfieldid.html">$customfieldid</a> = null;
<a name="l1672"><span class="linenum">1672</span></a>  
<a name="l1673"><span class="linenum">1673</span></a>  <span class="comment">        // If a customfield has been used in order to pass we must be able to match an existing</span>
<a name="l1674"><span class="linenum">1674</span></a>  <span class="comment">        // customfield by name (data-&gt;customfield) and type (data-&gt;customfieldtype)</span>
<a name="l1675"><span class="linenum">1675</span></a>          if (<a class="phpfunction" onClick="logFunction('is_null')" href="../../_functions/is_null.html" onMouseOver="phpfuncPopup(event,'is_null')">is_null</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('customfield')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/customfield.html">customfield</a>) xor <a class="phpfunction" onClick="logFunction('is_null')" href="../../_functions/is_null.html" onMouseOver="phpfuncPopup(event,'is_null')">is_null</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('customfieldtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/customfieldtype.html">customfieldtype</a>)) {
<a name="l1676"><span class="linenum">1676</span></a>  <span class="comment">            // xor is sort of uncommon. If either customfield is null or customfieldtype is null BUT not both.</span>
<a name="l1677"><span class="linenum">1677</span></a>  <span class="comment">            // If one is null but the other isn't something clearly went wrong and we'll skip this condition.</span>
<a name="l1678"><span class="linenum">1678</span></a>              <a class="var it15392" onMouseOver="hilite(15392)" onMouseOut="lolite()" onClick="logVariable('passed')" href="../../_variables/passed.html">$passed</a> = false;
<a name="l1679"><span class="linenum">1679</span></a>          } else if (!<a class="phpfunction" onClick="logFunction('is_null')" href="../../_functions/is_null.html" onMouseOver="phpfuncPopup(event,'is_null')">is_null</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('customfield')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/customfield.html">customfield</a>)) {
<a name="l1680"><span class="linenum">1680</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array('shortname' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('customfield')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/customfield.html">customfield</a>, 'datatype' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('customfieldtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/customfieldtype.html">customfieldtype</a>);
<a name="l1681"><span class="linenum">1681</span></a>              <a class="var it15393" onMouseOver="hilite(15393)" onMouseOut="lolite()" onClick="logVariable('customfieldid')" href="../../_variables/customfieldid.html">$customfieldid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('user_info_field', 'id', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l1682"><span class="linenum">1682</span></a>              <a class="var it15392" onMouseOver="hilite(15392)" onMouseOut="lolite()" onClick="logVariable('passed')" href="../../_variables/passed.html">$passed</a> = (<a class="var it15393" onMouseOver="hilite(15393)" onMouseOut="lolite()" onClick="logVariable('customfieldid')" href="../../_variables/customfieldid.html">$customfieldid</a> !== false);
<a name="l1683"><span class="linenum">1683</span></a>          }
<a name="l1684"><span class="linenum">1684</span></a>  
<a name="l1685"><span class="linenum">1685</span></a>          if (<a class="var it15392" onMouseOver="hilite(15392)" onMouseOut="lolite()" onClick="logVariable('passed')" href="../../_variables/passed.html">$passed</a>) {
<a name="l1686"><span class="linenum">1686</span></a>  <span class="comment">            // Create the object to insert into the database</span>
<a name="l1687"><span class="linenum">1687</span></a>              <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a> = new stdClass();
<a name="l1688"><span class="linenum">1688</span></a>              <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a>-&gt;<a onClick="logVariable('coursesectionid')" class="var it45298" onMouseOver="hilite(45298)" onMouseOut="lolite()" href="../../_variables/coursesectionid.html">coursesectionid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_sectionid')" href="../../_functions/get_sectionid.html" onMouseOver="funcPopup(event,'get_sectionid')">get_sectionid</a>();
<a name="l1689"><span class="linenum">1689</span></a>              <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a>-&gt;<a onClick="logVariable('userfield')" class="var it45298" onMouseOver="hilite(45298)" onMouseOut="lolite()" href="../../_variables/userfield.html">userfield</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userfield')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userfield.html">userfield</a>;
<a name="l1690"><span class="linenum">1690</span></a>              <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a>-&gt;<a onClick="logVariable('customfieldid')" class="var it45298" onMouseOver="hilite(45298)" onMouseOut="lolite()" href="../../_variables/customfieldid.html">customfieldid</a> = <a class="var it15393" onMouseOver="hilite(15393)" onMouseOut="lolite()" onClick="logVariable('customfieldid')" href="../../_variables/customfieldid.html">$customfieldid</a>;
<a name="l1691"><span class="linenum">1691</span></a>              <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a>-&gt;<a onClick="logVariable('operator')" class="var it45298" onMouseOver="hilite(45298)" onMouseOut="lolite()" href="../../_variables/operator.html">operator</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('operator')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/operator.html">operator</a>;
<a name="l1692"><span class="linenum">1692</span></a>              <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a>-&gt;<a onClick="logVariable('value')" class="var it45298" onMouseOver="hilite(45298)" onMouseOut="lolite()" href="../../_variables/value.html">value</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('value')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/value.html">value</a>;
<a name="l1693"><span class="linenum">1693</span></a>  
<a name="l1694"><span class="linenum">1694</span></a>  <span class="comment">            // Get showavailability option.</span>
<a name="l1695"><span class="linenum">1695</span></a>              <a class="var it15376" onMouseOver="hilite(15376)" onMouseOut="lolite()" onClick="logVariable('showrec')" href="../../_variables/showrec.html">$showrec</a> = restore_dbops::<a class="function" onClick="logFunction('get_backup_ids_record')" href="../../_functions/get_backup_ids_record.html" onMouseOver="funcPopup(event,'get_backup_ids_record')">get_backup_ids_record</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(),
<a name="l1696"><span class="linenum">1696</span></a>                      'section_showavailability', <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a>-&gt;<a onClick="logVariable('coursesectionid')" class="var it45298" onMouseOver="hilite(45298)" onMouseOut="lolite()" href="../../_variables/coursesectionid.html">coursesectionid</a>);
<a name="l1697"><span class="linenum">1697</span></a>              if (!<a class="var it15376" onMouseOver="hilite(15376)" onMouseOut="lolite()" onClick="logVariable('showrec')" href="../../_variables/showrec.html">$showrec</a>) {
<a name="l1698"><span class="linenum">1698</span></a>  <span class="comment">                // Should not happen.</span>
<a name="l1699"><span class="linenum">1699</span></a>                  throw <span class="keyword">new </span><a class="class" onClick="logClass('coding_exception')" href="../../_classes/coding_exception.html" onMouseOver="classPopup(event,'coding_exception')">coding_exception</a>('No matching showavailability record');
<a name="l1700"><span class="linenum">1700</span></a>              }
<a name="l1701"><span class="linenum">1701</span></a>              <a class="var it1794" onMouseOver="hilite(1794)" onMouseOut="lolite()" onClick="logVariable('show')" href="../../_variables/show.html">$show</a> = <a class="var it15376" onMouseOver="hilite(15376)" onMouseOut="lolite()" onClick="logVariable('showrec')" href="../../_variables/showrec.html">$showrec</a>-&gt;<a onClick="logVariable('info')" class="var it45292" onMouseOver="hilite(45292)" onMouseOut="lolite()" href="../../_variables/info.html">info</a>-&gt;showavailability;
<a name="l1702"><span class="linenum">1702</span></a>  
<a name="l1703"><span class="linenum">1703</span></a>  <span class="comment">            // The $availfield object is now in the format used in the old</span>
<a name="l1704"><span class="linenum">1704</span></a>  <span class="comment">            // system. Interpret this and convert to new system.</span>
<a name="l1705"><span class="linenum">1705</span></a>              <a class="var it15377" onMouseOver="hilite(15377)" onMouseOut="lolite()" onClick="logVariable('currentvalue')" href="../../_variables/currentvalue.html">$currentvalue</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('course_sections', 'availability',
<a name="l1706"><span class="linenum">1706</span></a>                      array('id' =&gt; <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a>-&gt;<a onClick="logVariable('coursesectionid')" class="var it45298" onMouseOver="hilite(45298)" onMouseOut="lolite()" href="../../_variables/coursesectionid.html">coursesectionid</a>), <a class="constant" onClick="logConstant('MUST_EXIST')" href="../../_constants/MUST_EXIST.html" onMouseOver="constPopup(event,'MUST_EXIST')">MUST_EXIST</a>);
<a name="l1707"><span class="linenum">1707</span></a>              <a class="var it3475" onMouseOver="hilite(3475)" onMouseOut="lolite()" onClick="logVariable('newvalue')" href="../../_variables/newvalue.html">$newvalue</a> = \core_availability\<a class="class" onClick="logClass('info')" href="../../_classes/info.html" onMouseOver="classPopup(event,'info')">info</a>::<a class="function" onClick="logFunction('add_legacy_availability_field_condition')" href="../../_functions/add_legacy_availability_field_condition.html" onMouseOver="funcPopup(event,'add_legacy_availability_field_condition')">add_legacy_availability_field_condition</a>(
<a name="l1708"><span class="linenum">1708</span></a>                      <a class="var it15377" onMouseOver="hilite(15377)" onMouseOut="lolite()" onClick="logVariable('currentvalue')" href="../../_variables/currentvalue.html">$currentvalue</a>, <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a>, <a class="var it1794" onMouseOver="hilite(1794)" onMouseOut="lolite()" onClick="logVariable('show')" href="../../_variables/show.html">$show</a>);
<a name="l1709"><span class="linenum">1709</span></a>              <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('set_field')" href="../../_functions/set_field.html" onMouseOver="funcPopup(event,'set_field')">set_field</a>('course_sections', 'availability', <a class="var it3475" onMouseOver="hilite(3475)" onMouseOut="lolite()" onClick="logVariable('newvalue')" href="../../_variables/newvalue.html">$newvalue</a>,
<a name="l1710"><span class="linenum">1710</span></a>                      array('id' =&gt; <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a>-&gt;<a onClick="logVariable('coursesectionid')" class="var it45298" onMouseOver="hilite(45298)" onMouseOut="lolite()" href="../../_variables/coursesectionid.html">coursesectionid</a>));
<a name="l1711"><span class="linenum">1711</span></a>          }
<a name="l1712"><span class="linenum">1712</span></a>      }
<a name="l1713"><span class="linenum">1713</span></a>  
<a name="l1714"><span class="linenum">1714</span></a>      public function <a class="function" onClick="logFunction('process_course_format_options')" href="../../_functions/process_course_format_options.html" onMouseOver="funcPopup(event,'process_course_format_options')">process_course_format_options</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l1715"><span class="linenum">1715</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l1716"><span class="linenum">1716</span></a>          <a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l1717"><span class="linenum">1717</span></a>          if (!<a class="phpfunction" onClick="logFunction('array_key_exists')" href="../../_functions/array_key_exists.html" onMouseOver="phpfuncPopup(event,'array_key_exists')">array_key_exists</a>(<a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>, self::<a class="var it3117" onMouseOver="hilite(3117)" onMouseOut="lolite()" onClick="logVariable('courseformats')" href="../../_variables/courseformats.html">$courseformats</a>)) {
<a name="l1718"><span class="linenum">1718</span></a>  <span class="comment">            // It is safe to have a static cache of course formats because format can not be changed after this point.</span>
<a name="l1719"><span class="linenum">1719</span></a>              self::<a class="var it3117" onMouseOver="hilite(3117)" onMouseOut="lolite()" onClick="logVariable('courseformats')" href="../../_variables/courseformats.html">$courseformats</a>[<a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>] = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('course', 'format', array('id' =&gt; <a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>));
<a name="l1720"><span class="linenum">1720</span></a>          }
<a name="l1721"><span class="linenum">1721</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (array)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l1722"><span class="linenum">1722</span></a>          if (self::<a class="var it3117" onMouseOver="hilite(3117)" onMouseOut="lolite()" onClick="logVariable('courseformats')" href="../../_variables/courseformats.html">$courseformats</a>[<a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>] === <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>['format']) {
<a name="l1723"><span class="linenum">1723</span></a>  <span class="comment">            // Import section format options only if both courses (the one that was backed up</span>
<a name="l1724"><span class="linenum">1724</span></a>  <span class="comment">            // and the one we are restoring into) have same formats.</span>
<a name="l1725"><span class="linenum">1725</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array(
<a name="l1726"><span class="linenum">1726</span></a>                  'courseid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(),
<a name="l1727"><span class="linenum">1727</span></a>                  'sectionid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_sectionid')" href="../../_functions/get_sectionid.html" onMouseOver="funcPopup(event,'get_sectionid')">get_sectionid</a>(),
<a name="l1728"><span class="linenum">1728</span></a>                  'format' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>['format'],
<a name="l1729"><span class="linenum">1729</span></a>                  'name' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>['name']
<a name="l1730"><span class="linenum">1730</span></a>              );
<a name="l1731"><span class="linenum">1731</span></a>              if (<a class="var it699" onMouseOver="hilite(699)" onMouseOut="lolite()" onClick="logVariable('record')" href="../../_variables/record.html">$record</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('course_format_options', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>, 'id, value')) {
<a name="l1732"><span class="linenum">1732</span></a>  <span class="comment">                // Do not overwrite existing information.</span>
<a name="l1733"><span class="linenum">1733</span></a>                  <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a> = <a class="var it699" onMouseOver="hilite(699)" onMouseOut="lolite()" onClick="logVariable('record')" href="../../_variables/record.html">$record</a>-&gt;<a onClick="logVariable('id')" class="var it42976" onMouseOver="hilite(42976)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l1734"><span class="linenum">1734</span></a>              } else {
<a name="l1735"><span class="linenum">1735</span></a>                  <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['value'] = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>['value'];
<a name="l1736"><span class="linenum">1736</span></a>                  <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('course_format_options', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l1737"><span class="linenum">1737</span></a>              }
<a name="l1738"><span class="linenum">1738</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('course_format_options', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>['id'], <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a>);
<a name="l1739"><span class="linenum">1739</span></a>          }
<a name="l1740"><span class="linenum">1740</span></a>      }
<a name="l1741"><span class="linenum">1741</span></a>  
<a name="l1742"><span class="linenum">1742</span></a>      protected function <a class="function" onClick="logFunction('after_execute')" href="../../_functions/after_execute.html" onMouseOver="funcPopup(event,'after_execute')">after_execute</a>() {
<a name="l1743"><span class="linenum">1743</span></a>  <span class="comment">        // Add section related files, with 'course_section' itemid to match</span>
<a name="l1744"><span class="linenum">1744</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_related_files')" href="../../_functions/add_related_files.html" onMouseOver="funcPopup(event,'add_related_files')">add_related_files</a>('course', 'section', 'course_section');
<a name="l1745"><span class="linenum">1745</span></a>      }
<a name="l1746"><span class="linenum">1746</span></a>  }
<a name="l1747"><span class="linenum">1747</span></a>  
<a name="l1748"><span class="linenum">1748</span></a>  <span class="comment">/**</span>
<a name="l1749"><span class="linenum">1749</span></a>  <span class="comment"> * Structure step that will read the course.xml file, loading it and performing</span>
<a name="l1750"><span class="linenum">1750</span></a>  <span class="comment"> * various actions depending of the site/restore settings. Note that target</span>
<a name="l1751"><span class="linenum">1751</span></a>  <span class="comment"> * course always exist before arriving here so this step will be updating</span>
<a name="l1752"><span class="linenum">1752</span></a>  <span class="comment"> * the course record (never inserting)</span>
<a name="l1753"><span class="linenum">1753</span></a>  <span class="comment"> */</span>
<a name="l1754"><span class="linenum">1754</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_course_structure_step')" href="../../_classes/restore_course_structure_step.html" onMouseOver="classPopup(event,'restore_course_structure_step')">restore_course_structure_step</a> extends restore_structure_step {
<a name="l1755"><span class="linenum">1755</span></a>      <span class="comment">/**</span>
<a name="l1756"><span class="linenum">1756</span></a>  <span class="comment">     * @var bool this gets set to true by {@link process_course()} if we are</span>
<a name="l1757"><span class="linenum">1757</span></a>  <span class="comment">     * restoring an old coures that used the legacy 'module security' feature.</span>
<a name="l1758"><span class="linenum">1758</span></a>  <span class="comment">     * If so, we have to do more work in {@link after_execute()}.</span>
<a name="l1759"><span class="linenum">1759</span></a>  <span class="comment">     */</span>
<a name="l1760"><span class="linenum">1760</span></a>      protected <a class="var it15397" onMouseOver="hilite(15397)" onMouseOut="lolite()" onClick="logVariable('legacyrestrictmodules')" href="../../_variables/legacyrestrictmodules.html">$legacyrestrictmodules</a> = false;
<a name="l1761"><span class="linenum">1761</span></a>  
<a name="l1762"><span class="linenum">1762</span></a>      <span class="comment">/**</span>
<a name="l1763"><span class="linenum">1763</span></a>  <span class="comment">     * @var array Used when {@link $legacyrestrictmodules} is true. This is an</span>
<a name="l1764"><span class="linenum">1764</span></a>  <span class="comment">     * array with array keys the module names ('forum', 'quiz', etc.). These are</span>
<a name="l1765"><span class="linenum">1765</span></a>  <span class="comment">     * the modules that are allowed according to the data in the backup file.</span>
<a name="l1766"><span class="linenum">1766</span></a>  <span class="comment">     * In {@link after_execute()} we then have to prevent adding of all the other</span>
<a name="l1767"><span class="linenum">1767</span></a>  <span class="comment">     * types of activity.</span>
<a name="l1768"><span class="linenum">1768</span></a>  <span class="comment">     */</span>
<a name="l1769"><span class="linenum">1769</span></a>      protected <a class="var it15398" onMouseOver="hilite(15398)" onMouseOut="lolite()" onClick="logVariable('legacyallowedmodules')" href="../../_variables/legacyallowedmodules.html">$legacyallowedmodules</a> = array();
<a name="l1770"><span class="linenum">1770</span></a>  
<a name="l1771"><span class="linenum">1771</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l1772"><span class="linenum">1772</span></a>  
<a name="l1773"><span class="linenum">1773</span></a>          <a class="var it8" onMouseOver="hilite(8)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a> = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('course', '/course');
<a name="l1774"><span class="linenum">1774</span></a>          <a class="var it261" onMouseOver="hilite(261)" onMouseOut="lolite()" onClick="logVariable('category')" href="../../_variables/category.html">$category</a> = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('category', '/course/category');
<a name="l1775"><span class="linenum">1775</span></a>          <a class="var it20" onMouseOver="hilite(20)" onMouseOut="lolite()" onClick="logVariable('tag')" href="../../_variables/tag.html">$tag</a> = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('tag', '/course/tags/tag');
<a name="l1776"><span class="linenum">1776</span></a>          <a class="var it15399" onMouseOver="hilite(15399)" onMouseOut="lolite()" onClick="logVariable('allowed_module')" href="../../_variables/allowed_module.html">$allowed_module</a> = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('allowed_module', '/course/allowed_modules/module');
<a name="l1777"><span class="linenum">1777</span></a>  
<a name="l1778"><span class="linenum">1778</span></a>  <span class="comment">        // Apply for 'format' plugins optional paths at course level</span>
<a name="l1779"><span class="linenum">1779</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('format', <a class="var it8" onMouseOver="hilite(8)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>);
<a name="l1780"><span class="linenum">1780</span></a>  
<a name="l1781"><span class="linenum">1781</span></a>  <span class="comment">        // Apply for 'theme' plugins optional paths at course level</span>
<a name="l1782"><span class="linenum">1782</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('theme', <a class="var it8" onMouseOver="hilite(8)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>);
<a name="l1783"><span class="linenum">1783</span></a>  
<a name="l1784"><span class="linenum">1784</span></a>  <span class="comment">        // Apply for 'report' plugins optional paths at course level</span>
<a name="l1785"><span class="linenum">1785</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('report', <a class="var it8" onMouseOver="hilite(8)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>);
<a name="l1786"><span class="linenum">1786</span></a>  
<a name="l1787"><span class="linenum">1787</span></a>  <span class="comment">        // Apply for 'course report' plugins optional paths at course level</span>
<a name="l1788"><span class="linenum">1788</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('coursereport', <a class="var it8" onMouseOver="hilite(8)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>);
<a name="l1789"><span class="linenum">1789</span></a>  
<a name="l1790"><span class="linenum">1790</span></a>  <span class="comment">        // Apply for plagiarism plugins optional paths at course level</span>
<a name="l1791"><span class="linenum">1791</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('plagiarism', <a class="var it8" onMouseOver="hilite(8)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>);
<a name="l1792"><span class="linenum">1792</span></a>  
<a name="l1793"><span class="linenum">1793</span></a>  <span class="comment">        // Apply for local plugins optional paths at course level</span>
<a name="l1794"><span class="linenum">1794</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('local', <a class="var it8" onMouseOver="hilite(8)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>);
<a name="l1795"><span class="linenum">1795</span></a>  
<a name="l1796"><span class="linenum">1796</span></a>  <span class="comment">        // Apply for admin tool plugins optional paths at course level.</span>
<a name="l1797"><span class="linenum">1797</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('tool', <a class="var it8" onMouseOver="hilite(8)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>);
<a name="l1798"><span class="linenum">1798</span></a>  
<a name="l1799"><span class="linenum">1799</span></a>          return array(<a class="var it8" onMouseOver="hilite(8)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>, <a class="var it261" onMouseOver="hilite(261)" onMouseOut="lolite()" onClick="logVariable('category')" href="../../_variables/category.html">$category</a>, <a class="var it20" onMouseOver="hilite(20)" onMouseOut="lolite()" onClick="logVariable('tag')" href="../../_variables/tag.html">$tag</a>, <a class="var it15399" onMouseOver="hilite(15399)" onMouseOut="lolite()" onClick="logVariable('allowed_module')" href="../../_variables/allowed_module.html">$allowed_module</a>);
<a name="l1800"><span class="linenum">1800</span></a>      }
<a name="l1801"><span class="linenum">1801</span></a>  
<a name="l1802"><span class="linenum">1802</span></a>      <span class="comment">/**</span>
<a name="l1803"><span class="linenum">1803</span></a>  <span class="comment">     * Processing functions go here</span>
<a name="l1804"><span class="linenum">1804</span></a>  <span class="comment">     *</span>
<a name="l1805"><span class="linenum">1805</span></a>  <span class="comment">     * @global moodledatabase $DB</span>
<a name="l1806"><span class="linenum">1806</span></a>  <span class="comment">     * @param stdClass $data</span>
<a name="l1807"><span class="linenum">1807</span></a>  <span class="comment">     */</span>
<a name="l1808"><span class="linenum">1808</span></a>      public function <a class="function" onClick="logFunction('process_course')" href="../../_functions/process_course.html" onMouseOver="funcPopup(event,'process_course')">process_course</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l1809"><span class="linenum">1809</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l1810"><span class="linenum">1810</span></a>          <a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a> = context::<a class="function" onClick="logFunction('instance_by_id')" href="../../_functions/instance_by_id.html" onMouseOver="funcPopup(event,'instance_by_id')">instance_by_id</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_contextid')" href="../../_functions/get_contextid.html" onMouseOver="funcPopup(event,'get_contextid')">get_contextid</a>());
<a name="l1811"><span class="linenum">1811</span></a>          <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>();
<a name="l1812"><span class="linenum">1812</span></a>          <a class="var it713" onMouseOver="hilite(713)" onMouseOut="lolite()" onClick="logVariable('target')" href="../../_variables/target.html">$target</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_task')" href="../../_functions/get_task.html" onMouseOver="funcPopup(event,'get_task')">get_task</a>()-&gt;<a class="function" onClick="logFunction('get_target')" href="../../_functions/get_target.html" onMouseOver="funcPopup(event,'get_target')">get_target</a>();
<a name="l1813"><span class="linenum">1813</span></a>          <a class="var it15400" onMouseOver="hilite(15400)" onMouseOut="lolite()" onClick="logVariable('isnewcourse')" href="../../_variables/isnewcourse.html">$isnewcourse</a> = <a class="var it713" onMouseOver="hilite(713)" onMouseOut="lolite()" onClick="logVariable('target')" href="../../_variables/target.html">$target</a> != backup::TARGET_CURRENT_ADDING &amp;&amp; <a class="var it713" onMouseOver="hilite(713)" onMouseOut="lolite()" onClick="logVariable('target')" href="../../_variables/target.html">$target</a> != backup::TARGET_EXISTING_ADDING;
<a name="l1814"><span class="linenum">1814</span></a>  
<a name="l1815"><span class="linenum">1815</span></a>  <span class="comment">        // When restoring to a new course we can set all the things except for the ID number.</span>
<a name="l1816"><span class="linenum">1816</span></a>          <a class="var it15401" onMouseOver="hilite(15401)" onMouseOut="lolite()" onClick="logVariable('canchangeidnumber')" href="../../_variables/canchangeidnumber.html">$canchangeidnumber</a> = <a class="var it15400" onMouseOver="hilite(15400)" onMouseOut="lolite()" onClick="logVariable('isnewcourse')" href="../../_variables/isnewcourse.html">$isnewcourse</a> || <a class="function" onClick="logFunction('has_capability')" href="../../_functions/has_capability.html" onMouseOver="funcPopup(event,'has_capability')">has_capability</a>('moodle/course:changeidnumber', <a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a>, <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>);
<a name="l1817"><span class="linenum">1817</span></a>          <a class="var it15402" onMouseOver="hilite(15402)" onMouseOut="lolite()" onClick="logVariable('canchangeshortname')" href="../../_variables/canchangeshortname.html">$canchangeshortname</a> = <a class="var it15400" onMouseOver="hilite(15400)" onMouseOut="lolite()" onClick="logVariable('isnewcourse')" href="../../_variables/isnewcourse.html">$isnewcourse</a> || <a class="function" onClick="logFunction('has_capability')" href="../../_functions/has_capability.html" onMouseOver="funcPopup(event,'has_capability')">has_capability</a>('moodle/course:changeshortname', <a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a>, <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>);
<a name="l1818"><span class="linenum">1818</span></a>          <a class="var it15403" onMouseOver="hilite(15403)" onMouseOut="lolite()" onClick="logVariable('canchangefullname')" href="../../_variables/canchangefullname.html">$canchangefullname</a> = <a class="var it15400" onMouseOver="hilite(15400)" onMouseOut="lolite()" onClick="logVariable('isnewcourse')" href="../../_variables/isnewcourse.html">$isnewcourse</a> || <a class="function" onClick="logFunction('has_capability')" href="../../_functions/has_capability.html" onMouseOver="funcPopup(event,'has_capability')">has_capability</a>('moodle/course:changefullname', <a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a>, <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>);
<a name="l1819"><span class="linenum">1819</span></a>          <a class="var it15404" onMouseOver="hilite(15404)" onMouseOut="lolite()" onClick="logVariable('canchangesummary')" href="../../_variables/canchangesummary.html">$canchangesummary</a> = <a class="var it15400" onMouseOver="hilite(15400)" onMouseOut="lolite()" onClick="logVariable('isnewcourse')" href="../../_variables/isnewcourse.html">$isnewcourse</a> || <a class="function" onClick="logFunction('has_capability')" href="../../_functions/has_capability.html" onMouseOver="funcPopup(event,'has_capability')">has_capability</a>('moodle/course:changesummary', <a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a>, <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>);
<a name="l1820"><span class="linenum">1820</span></a>  
<a name="l1821"><span class="linenum">1821</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l1822"><span class="linenum">1822</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l1823"><span class="linenum">1823</span></a>  
<a name="l1824"><span class="linenum">1824</span></a>          <a class="var it370" onMouseOver="hilite(370)" onMouseOut="lolite()" onClick="logVariable('fullname')" href="../../_variables/fullname.html">$fullname</a>  = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('course_fullname');
<a name="l1825"><span class="linenum">1825</span></a>          <a class="var it911" onMouseOver="hilite(911)" onMouseOut="lolite()" onClick="logVariable('shortname')" href="../../_variables/shortname.html">$shortname</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('course_shortname');
<a name="l1826"><span class="linenum">1826</span></a>          <a class="var it3592" onMouseOver="hilite(3592)" onMouseOut="lolite()" onClick="logVariable('startdate')" href="../../_variables/startdate.html">$startdate</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('course_startdate');
<a name="l1827"><span class="linenum">1827</span></a>  
<a name="l1828"><span class="linenum">1828</span></a>  <span class="comment">        // Calculate final course names, to avoid dupes.</span>
<a name="l1829"><span class="linenum">1829</span></a>          <a class="function" onClick="logFunction('list')" href="../../_functions/list.html" onMouseOver="funcPopup(event,'list')">list</a>(<a class="var it370" onMouseOver="hilite(370)" onMouseOut="lolite()" onClick="logVariable('fullname')" href="../../_variables/fullname.html">$fullname</a>, <a class="var it911" onMouseOver="hilite(911)" onMouseOut="lolite()" onClick="logVariable('shortname')" href="../../_variables/shortname.html">$shortname</a>) = restore_dbops::<a class="function" onClick="logFunction('calculate_course_names')" href="../../_functions/calculate_course_names.html" onMouseOver="funcPopup(event,'calculate_course_names')">calculate_course_names</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(), <a class="var it370" onMouseOver="hilite(370)" onMouseOut="lolite()" onClick="logVariable('fullname')" href="../../_variables/fullname.html">$fullname</a>, <a class="var it911" onMouseOver="hilite(911)" onMouseOut="lolite()" onClick="logVariable('shortname')" href="../../_variables/shortname.html">$shortname</a>);
<a name="l1830"><span class="linenum">1830</span></a>  
<a name="l1831"><span class="linenum">1831</span></a>          if (<a class="var it15403" onMouseOver="hilite(15403)" onMouseOut="lolite()" onClick="logVariable('canchangefullname')" href="../../_variables/canchangefullname.html">$canchangefullname</a>) {
<a name="l1832"><span class="linenum">1832</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('fullname')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/fullname.html">fullname</a> = <a class="var it370" onMouseOver="hilite(370)" onMouseOut="lolite()" onClick="logVariable('fullname')" href="../../_variables/fullname.html">$fullname</a>;
<a name="l1833"><span class="linenum">1833</span></a>          } else {
<a name="l1834"><span class="linenum">1834</span></a>              unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('fullname')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/fullname.html">fullname</a>);
<a name="l1835"><span class="linenum">1835</span></a>          }
<a name="l1836"><span class="linenum">1836</span></a>  
<a name="l1837"><span class="linenum">1837</span></a>          if (<a class="var it15402" onMouseOver="hilite(15402)" onMouseOut="lolite()" onClick="logVariable('canchangeshortname')" href="../../_variables/canchangeshortname.html">$canchangeshortname</a>) {
<a name="l1838"><span class="linenum">1838</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('shortname')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/shortname.html">shortname</a> = <a class="var it911" onMouseOver="hilite(911)" onMouseOut="lolite()" onClick="logVariable('shortname')" href="../../_variables/shortname.html">$shortname</a>;
<a name="l1839"><span class="linenum">1839</span></a>          } else {
<a name="l1840"><span class="linenum">1840</span></a>              unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('shortname')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/shortname.html">shortname</a>);
<a name="l1841"><span class="linenum">1841</span></a>          }
<a name="l1842"><span class="linenum">1842</span></a>  
<a name="l1843"><span class="linenum">1843</span></a>          if (!<a class="var it15404" onMouseOver="hilite(15404)" onMouseOut="lolite()" onClick="logVariable('canchangesummary')" href="../../_variables/canchangesummary.html">$canchangesummary</a>) {
<a name="l1844"><span class="linenum">1844</span></a>              unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('summary')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/summary.html">summary</a>);
<a name="l1845"><span class="linenum">1845</span></a>              unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('summaryformat')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/summaryformat.html">summaryformat</a>);
<a name="l1846"><span class="linenum">1846</span></a>          }
<a name="l1847"><span class="linenum">1847</span></a>  
<a name="l1848"><span class="linenum">1848</span></a>  <span class="comment">        // Only allow the idnumber to be set if the user has permission and the idnumber is not already in use by</span>
<a name="l1849"><span class="linenum">1849</span></a>  <span class="comment">        // another course on this site.</span>
<a name="l1850"><span class="linenum">1850</span></a>          if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>) &amp;&amp; <a class="var it15401" onMouseOver="hilite(15401)" onMouseOut="lolite()" onClick="logVariable('canchangeidnumber')" href="../../_variables/canchangeidnumber.html">$canchangeidnumber</a> &amp;&amp; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('is_samesite')" href="../../_functions/is_samesite.html" onMouseOver="funcPopup(event,'is_samesite')">is_samesite</a>()
<a name="l1851"><span class="linenum">1851</span></a>                  &amp;&amp; !<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists')" href="../../_functions/record_exists.html" onMouseOver="funcPopup(event,'record_exists')">record_exists</a>('course', array('idnumber' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>))) {
<a name="l1852"><span class="linenum">1852</span></a>  <span class="comment">            // Do not reset idnumber.</span>
<a name="l1853"><span class="linenum">1853</span></a>  
<a name="l1854"><span class="linenum">1854</span></a>          } else if (!<a class="var it15400" onMouseOver="hilite(15400)" onMouseOut="lolite()" onClick="logVariable('isnewcourse')" href="../../_variables/isnewcourse.html">$isnewcourse</a>) {
<a name="l1855"><span class="linenum">1855</span></a>  <span class="comment">            // Prevent override when restoring as merge.</span>
<a name="l1856"><span class="linenum">1856</span></a>              unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>);
<a name="l1857"><span class="linenum">1857</span></a>  
<a name="l1858"><span class="linenum">1858</span></a>          } else {
<a name="l1859"><span class="linenum">1859</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a> = '';
<a name="l1860"><span class="linenum">1860</span></a>          }
<a name="l1861"><span class="linenum">1861</span></a>  
<a name="l1862"><span class="linenum">1862</span></a>  <span class="comment">        // Any empty value for course-&gt;hiddensections will lead to 0 (default, show collapsed).</span>
<a name="l1863"><span class="linenum">1863</span></a>  <span class="comment">        // It has been reported that some old 1.9 courses may have it null leading to DB error. MDL-31532</span>
<a name="l1864"><span class="linenum">1864</span></a>          if (empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('hiddensections')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/hiddensections.html">hiddensections</a>)) {
<a name="l1865"><span class="linenum">1865</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('hiddensections')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/hiddensections.html">hiddensections</a> = 0;
<a name="l1866"><span class="linenum">1866</span></a>          }
<a name="l1867"><span class="linenum">1867</span></a>  
<a name="l1868"><span class="linenum">1868</span></a>  <span class="comment">        // Set legacyrestrictmodules to true if the course was resticting modules. If so</span>
<a name="l1869"><span class="linenum">1869</span></a>  <span class="comment">        // then we will need to process restricted modules after execution.</span>
<a name="l1870"><span class="linenum">1870</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('legacyrestrictmodules')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/legacyrestrictmodules.html">legacyrestrictmodules</a> = !empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('restrictmodules')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/restrictmodules.html">restrictmodules</a>);
<a name="l1871"><span class="linenum">1871</span></a>  
<a name="l1872"><span class="linenum">1872</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('startdate')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/startdate.html">startdate</a>= <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('startdate')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/startdate.html">startdate</a>);
<a name="l1873"><span class="linenum">1873</span></a>          if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('defaultgroupingid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/defaultgroupingid.html">defaultgroupingid</a>) {
<a name="l1874"><span class="linenum">1874</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('defaultgroupingid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/defaultgroupingid.html">defaultgroupingid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('grouping', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('defaultgroupingid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/defaultgroupingid.html">defaultgroupingid</a>);
<a name="l1875"><span class="linenum">1875</span></a>          }
<a name="l1876"><span class="linenum">1876</span></a>          if (empty(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('enablecompletion')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/enablecompletion.html">enablecompletion</a>)) {
<a name="l1877"><span class="linenum">1877</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('enablecompletion')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/enablecompletion.html">enablecompletion</a> = 0;
<a name="l1878"><span class="linenum">1878</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('completionstartonenrol')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/completionstartonenrol.html">completionstartonenrol</a> = 0;
<a name="l1879"><span class="linenum">1879</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('completionnotify')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/completionnotify.html">completionnotify</a> = 0;
<a name="l1880"><span class="linenum">1880</span></a>          }
<a name="l1881"><span class="linenum">1881</span></a>          <a class="var it3124" onMouseOver="hilite(3124)" onMouseOut="lolite()" onClick="logVariable('languages')" href="../../_variables/languages.html">$languages</a> = <a class="function" onClick="logFunction('get_string_manager')" href="../../_functions/get_string_manager.html" onMouseOver="funcPopup(event,'get_string_manager')">get_string_manager</a>()-&gt;<a class="function" onClick="logFunction('get_list_of_translations')" href="../../_functions/get_list_of_translations.html" onMouseOver="funcPopup(event,'get_list_of_translations')">get_list_of_translations</a>(); <span class="comment">// Get languages for quick search</span>
<a name="l1882"><span class="linenum">1882</span></a>          if (!<a class="phpfunction" onClick="logFunction('array_key_exists')" href="../../_functions/array_key_exists.html" onMouseOver="phpfuncPopup(event,'array_key_exists')">array_key_exists</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('lang')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/lang.html">lang</a>, <a class="var it3124" onMouseOver="hilite(3124)" onMouseOut="lolite()" onClick="logVariable('languages')" href="../../_variables/languages.html">$languages</a>)) {
<a name="l1883"><span class="linenum">1883</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('lang')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/lang.html">lang</a> = '';
<a name="l1884"><span class="linenum">1884</span></a>          }
<a name="l1885"><span class="linenum">1885</span></a>  
<a name="l1886"><span class="linenum">1886</span></a>          <a class="var it3122" onMouseOver="hilite(3122)" onMouseOut="lolite()" onClick="logVariable('themes')" href="../../_variables/themes.html">$themes</a> = <a class="function" onClick="logFunction('get_list_of_themes')" href="../../_functions/get_list_of_themes.html" onMouseOver="funcPopup(event,'get_list_of_themes')">get_list_of_themes</a>(); <span class="comment">// Get themes for quick search later</span>
<a name="l1887"><span class="linenum">1887</span></a>          if (!<a class="phpfunction" onClick="logFunction('array_key_exists')" href="../../_functions/array_key_exists.html" onMouseOver="phpfuncPopup(event,'array_key_exists')">array_key_exists</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('theme')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/theme.html">theme</a>, <a class="var it3122" onMouseOver="hilite(3122)" onMouseOut="lolite()" onClick="logVariable('themes')" href="../../_variables/themes.html">$themes</a>) || empty(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('allowcoursethemes')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/allowcoursethemes.html">allowcoursethemes</a>)) {
<a name="l1888"><span class="linenum">1888</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('theme')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/theme.html">theme</a> = '';
<a name="l1889"><span class="linenum">1889</span></a>          }
<a name="l1890"><span class="linenum">1890</span></a>  
<a name="l1891"><span class="linenum">1891</span></a>  <span class="comment">        // Check if this is an old SCORM course format.</span>
<a name="l1892"><span class="linenum">1892</span></a>          if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('format')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/format.html">format</a> == 'scorm') {
<a name="l1893"><span class="linenum">1893</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('format')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/format.html">format</a> = 'singleactivity';
<a name="l1894"><span class="linenum">1894</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('activitytype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/activitytype.html">activitytype</a> = 'scorm';
<a name="l1895"><span class="linenum">1895</span></a>          }
<a name="l1896"><span class="linenum">1896</span></a>  
<a name="l1897"><span class="linenum">1897</span></a>  <span class="comment">        // Course record ready, update it</span>
<a name="l1898"><span class="linenum">1898</span></a>          <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('update_record')" href="../../_functions/update_record.html" onMouseOver="funcPopup(event,'update_record')">update_record</a>('course', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l1899"><span class="linenum">1899</span></a>  
<a name="l1900"><span class="linenum">1900</span></a>          <a class="function" onClick="logFunction('course_get_format')" href="../../_functions/course_get_format.html" onMouseOver="funcPopup(event,'course_get_format')">course_get_format</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>)-&gt;<a class="function" onClick="logFunction('update_course_format_options')" href="../../_functions/update_course_format_options.html" onMouseOver="funcPopup(event,'update_course_format_options')">update_course_format_options</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l1901"><span class="linenum">1901</span></a>  
<a name="l1902"><span class="linenum">1902</span></a>  <span class="comment">        // Role name aliases</span>
<a name="l1903"><span class="linenum">1903</span></a>          restore_dbops::<a class="function" onClick="logFunction('set_course_role_names')" href="../../_functions/set_course_role_names.html" onMouseOver="funcPopup(event,'set_course_role_names')">set_course_role_names</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>());
<a name="l1904"><span class="linenum">1904</span></a>      }
<a name="l1905"><span class="linenum">1905</span></a>  
<a name="l1906"><span class="linenum">1906</span></a>      public function <a class="function" onClick="logFunction('process_category')" href="../../_functions/process_category.html" onMouseOver="funcPopup(event,'process_category')">process_category</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l1907"><span class="linenum">1907</span></a>  <span class="comment">        // Nothing to do with the category. UI sets it before restore starts</span>
<a name="l1908"><span class="linenum">1908</span></a>      }
<a name="l1909"><span class="linenum">1909</span></a>  
<a name="l1910"><span class="linenum">1910</span></a>      public function <a class="function" onClick="logFunction('process_tag')" href="../../_functions/process_tag.html" onMouseOver="funcPopup(event,'process_tag')">process_tag</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l1911"><span class="linenum">1911</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l1912"><span class="linenum">1912</span></a>  
<a name="l1913"><span class="linenum">1913</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l1914"><span class="linenum">1914</span></a>  
<a name="l1915"><span class="linenum">1915</span></a>          <a class="class" onClick="logClass('core_tag_tag')" href="../../_classes/core_tag_tag.html" onMouseOver="classPopup(event,'core_tag_tag')">core_tag_tag</a>::<a class="function" onClick="logFunction('add_item_tag')" href="../../_functions/add_item_tag.html" onMouseOver="funcPopup(event,'add_item_tag')">add_item_tag</a>('core', 'course', <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(),
<a name="l1916"><span class="linenum">1916</span></a>                  <a class="class" onClick="logClass('context_course')" href="../../_classes/context_course.html" onMouseOver="classPopup(event,'context_course')">context_course</a>::<a class="function" onClick="logFunction('instance')" href="../../_functions/instance.html" onMouseOver="funcPopup(event,'instance')">instance</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>()), <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('rawname')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/rawname.html">rawname</a>);
<a name="l1917"><span class="linenum">1917</span></a>      }
<a name="l1918"><span class="linenum">1918</span></a>  
<a name="l1919"><span class="linenum">1919</span></a>      public function <a class="function" onClick="logFunction('process_allowed_module')" href="../../_functions/process_allowed_module.html" onMouseOver="funcPopup(event,'process_allowed_module')">process_allowed_module</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l1920"><span class="linenum">1920</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l1921"><span class="linenum">1921</span></a>  
<a name="l1922"><span class="linenum">1922</span></a>  <span class="comment">        // Backwards compatiblity support for the data that used to be in the</span>
<a name="l1923"><span class="linenum">1923</span></a>  <span class="comment">        // course_allowed_modules table.</span>
<a name="l1924"><span class="linenum">1924</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('legacyrestrictmodules')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/legacyrestrictmodules.html">legacyrestrictmodules</a>) {
<a name="l1925"><span class="linenum">1925</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('legacyallowedmodules')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/legacyallowedmodules.html">legacyallowedmodules</a>[<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('modulename')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/modulename.html">modulename</a>] = 1;
<a name="l1926"><span class="linenum">1926</span></a>          }
<a name="l1927"><span class="linenum">1927</span></a>      }
<a name="l1928"><span class="linenum">1928</span></a>  
<a name="l1929"><span class="linenum">1929</span></a>      protected function <a class="function" onClick="logFunction('after_execute')" href="../../_functions/after_execute.html" onMouseOver="funcPopup(event,'after_execute')">after_execute</a>() {
<a name="l1930"><span class="linenum">1930</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l1931"><span class="linenum">1931</span></a>  
<a name="l1932"><span class="linenum">1932</span></a>  <span class="comment">        // Add course related files, without itemid to match</span>
<a name="l1933"><span class="linenum">1933</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_related_files')" href="../../_functions/add_related_files.html" onMouseOver="funcPopup(event,'add_related_files')">add_related_files</a>('course', 'summary', null);
<a name="l1934"><span class="linenum">1934</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_related_files')" href="../../_functions/add_related_files.html" onMouseOver="funcPopup(event,'add_related_files')">add_related_files</a>('course', 'overviewfiles', null);
<a name="l1935"><span class="linenum">1935</span></a>  
<a name="l1936"><span class="linenum">1936</span></a>  <span class="comment">        // Deal with legacy allowed modules.</span>
<a name="l1937"><span class="linenum">1937</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('legacyrestrictmodules')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/legacyrestrictmodules.html">legacyrestrictmodules</a>) {
<a name="l1938"><span class="linenum">1938</span></a>              <a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a> = <a class="class" onClick="logClass('context_course')" href="../../_classes/context_course.html" onMouseOver="classPopup(event,'context_course')">context_course</a>::<a class="function" onClick="logFunction('instance')" href="../../_functions/instance.html" onMouseOver="funcPopup(event,'instance')">instance</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>());
<a name="l1939"><span class="linenum">1939</span></a>  
<a name="l1940"><span class="linenum">1940</span></a>              <a class="function" onClick="logFunction('list')" href="../../_functions/list.html" onMouseOver="funcPopup(event,'list')">list</a>(<a class="var it7901" onMouseOver="hilite(7901)" onMouseOut="lolite()" onClick="logVariable('roleids')" href="../../_variables/roleids.html">$roleids</a>) = <a class="function" onClick="logFunction('get_roles_with_cap_in_context')" href="../../_functions/get_roles_with_cap_in_context.html" onMouseOver="funcPopup(event,'get_roles_with_cap_in_context')">get_roles_with_cap_in_context</a>(<a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a>, 'moodle/course:manageactivities');
<a name="l1941"><span class="linenum">1941</span></a>              <a class="function" onClick="logFunction('list')" href="../../_functions/list.html" onMouseOver="funcPopup(event,'list')">list</a>(<a class="var it15408" onMouseOver="hilite(15408)" onMouseOut="lolite()" onClick="logVariable('managerroleids')" href="../../_variables/managerroleids.html">$managerroleids</a>) = <a class="function" onClick="logFunction('get_roles_with_cap_in_context')" href="../../_functions/get_roles_with_cap_in_context.html" onMouseOver="funcPopup(event,'get_roles_with_cap_in_context')">get_roles_with_cap_in_context</a>(<a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a>, 'moodle/site:config');
<a name="l1942"><span class="linenum">1942</span></a>              foreach (<a class="var it15408" onMouseOver="hilite(15408)" onMouseOut="lolite()" onClick="logVariable('managerroleids')" href="../../_variables/managerroleids.html">$managerroleids</a> as <a class="var it788" onMouseOver="hilite(788)" onMouseOut="lolite()" onClick="logVariable('roleid')" href="../../_variables/roleid.html">$roleid</a>) {
<a name="l1943"><span class="linenum">1943</span></a>                  unset(<a class="var it7901" onMouseOver="hilite(7901)" onMouseOut="lolite()" onClick="logVariable('roleids')" href="../../_variables/roleids.html">$roleids</a>[<a class="var it788" onMouseOver="hilite(788)" onMouseOut="lolite()" onClick="logVariable('roleid')" href="../../_variables/roleid.html">$roleid</a>]);
<a name="l1944"><span class="linenum">1944</span></a>              }
<a name="l1945"><span class="linenum">1945</span></a>  
<a name="l1946"><span class="linenum">1946</span></a>              foreach (<a class="class" onClick="logClass('core_component')" href="../../_classes/core_component.html" onMouseOver="classPopup(event,'core_component')">core_component</a>::<a class="function" onClick="logFunction('get_plugin_list')" href="../../_functions/get_plugin_list.html" onMouseOver="funcPopup(event,'get_plugin_list')">get_plugin_list</a>('mod') as <a class="var it2355" onMouseOver="hilite(2355)" onMouseOut="lolite()" onClick="logVariable('modname')" href="../../_variables/modname.html">$modname</a> =&gt; <a class="var it2687" onMouseOver="hilite(2687)" onMouseOut="lolite()" onClick="logVariable('notused')" href="../../_variables/notused.html">$notused</a>) {
<a name="l1947"><span class="linenum">1947</span></a>                  if (isset(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('legacyallowedmodules')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/legacyallowedmodules.html">legacyallowedmodules</a>[<a class="var it2355" onMouseOver="hilite(2355)" onMouseOut="lolite()" onClick="logVariable('modname')" href="../../_variables/modname.html">$modname</a>])) {
<a name="l1948"><span class="linenum">1948</span></a>  <span class="comment">                    // Module is allowed, no worries.</span>
<a name="l1949"><span class="linenum">1949</span></a>                      continue;
<a name="l1950"><span class="linenum">1950</span></a>                  }
<a name="l1951"><span class="linenum">1951</span></a>  
<a name="l1952"><span class="linenum">1952</span></a>                  <a class="var it787" onMouseOver="hilite(787)" onMouseOut="lolite()" onClick="logVariable('capability')" href="../../_variables/capability.html">$capability</a> = 'mod/' . <a class="var it2355" onMouseOver="hilite(2355)" onMouseOut="lolite()" onClick="logVariable('modname')" href="../../_variables/modname.html">$modname</a> . ':addinstance';
<a name="l1953"><span class="linenum">1953</span></a>                  foreach (<a class="var it7901" onMouseOver="hilite(7901)" onMouseOut="lolite()" onClick="logVariable('roleids')" href="../../_variables/roleids.html">$roleids</a> as <a class="var it788" onMouseOver="hilite(788)" onMouseOut="lolite()" onClick="logVariable('roleid')" href="../../_variables/roleid.html">$roleid</a>) {
<a name="l1954"><span class="linenum">1954</span></a>                      <a class="function" onClick="logFunction('assign_capability')" href="../../_functions/assign_capability.html" onMouseOver="funcPopup(event,'assign_capability')">assign_capability</a>(<a class="var it787" onMouseOver="hilite(787)" onMouseOut="lolite()" onClick="logVariable('capability')" href="../../_variables/capability.html">$capability</a>, <a class="constant" onClick="logConstant('CAP_PREVENT')" href="../../_constants/CAP_PREVENT.html" onMouseOver="constPopup(event,'CAP_PREVENT')">CAP_PREVENT</a>, <a class="var it788" onMouseOver="hilite(788)" onMouseOut="lolite()" onClick="logVariable('roleid')" href="../../_variables/roleid.html">$roleid</a>, <a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a>);
<a name="l1955"><span class="linenum">1955</span></a>                  }
<a name="l1956"><span class="linenum">1956</span></a>              }
<a name="l1957"><span class="linenum">1957</span></a>          }
<a name="l1958"><span class="linenum">1958</span></a>      }
<a name="l1959"><span class="linenum">1959</span></a>  }
<a name="l1960"><span class="linenum">1960</span></a>  
<a name="l1961"><span class="linenum">1961</span></a>  <span class="comment">/**</span>
<a name="l1962"><span class="linenum">1962</span></a>  <span class="comment"> * Execution step that will migrate legacy files if present.</span>
<a name="l1963"><span class="linenum">1963</span></a>  <span class="comment"> */</span>
<a name="l1964"><span class="linenum">1964</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_course_legacy_files_step')" href="../../_classes/restore_course_legacy_files_step.html" onMouseOver="classPopup(event,'restore_course_legacy_files_step')">restore_course_legacy_files_step</a> extends restore_execution_step {
<a name="l1965"><span class="linenum">1965</span></a>      public function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l1966"><span class="linenum">1966</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l1967"><span class="linenum">1967</span></a>  
<a name="l1968"><span class="linenum">1968</span></a>  <span class="comment">        // Do a check for legacy files and skip if there are none.</span>
<a name="l1969"><span class="linenum">1969</span></a>          <a class="var it64" onMouseOver="hilite(64)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a> = 'SELECT <a class="phpfunction" onClick="logFunction('count')" href="../../_functions/count.html" onMouseOver="phpfuncPopup(event,'count')">count</a>(*)
<a name="l1970"><span class="linenum">1970</span></a>                    FROM {backup_files_temp}
<a name="l1971"><span class="linenum">1971</span></a>                   WHERE backupid = ?
<a name="l1972"><span class="linenum">1972</span></a>                     AND contextid = ?
<a name="l1973"><span class="linenum">1973</span></a>                     AND component = ?
<a name="l1974"><span class="linenum">1974</span></a>                     AND filearea  = ?';
<a name="l1975"><span class="linenum">1975</span></a>          <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_old_contextid')" href="../../_functions/get_old_contextid.html" onMouseOver="funcPopup(event,'get_old_contextid')">get_old_contextid</a>(), 'course', 'legacy');
<a name="l1976"><span class="linenum">1976</span></a>  
<a name="l1977"><span class="linenum">1977</span></a>          if (<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('count_records_sql')" href="../../_functions/count_records_sql.html" onMouseOver="funcPopup(event,'count_records_sql')">count_records_sql</a>(<a class="var it64" onMouseOver="hilite(64)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a>, <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>)) {
<a name="l1978"><span class="linenum">1978</span></a>              <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('set_field')" href="../../_functions/set_field.html" onMouseOver="funcPopup(event,'set_field')">set_field</a>('course', 'legacyfiles', 2, array('id' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>()));
<a name="l1979"><span class="linenum">1979</span></a>              restore_dbops::<a class="function" onClick="logFunction('send_files_to_pool')" href="../../_functions/send_files_to_pool.html" onMouseOver="funcPopup(event,'send_files_to_pool')">send_files_to_pool</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_basepath')" href="../../_functions/get_basepath.html" onMouseOver="funcPopup(event,'get_basepath')">get_basepath</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'course',
<a name="l1980"><span class="linenum">1980</span></a>                  'legacy', <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_old_contextid')" href="../../_functions/get_old_contextid.html" onMouseOver="funcPopup(event,'get_old_contextid')">get_old_contextid</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>());
<a name="l1981"><span class="linenum">1981</span></a>          }
<a name="l1982"><span class="linenum">1982</span></a>      }
<a name="l1983"><span class="linenum">1983</span></a>  }
<a name="l1984"><span class="linenum">1984</span></a>  
<a name="l1985"><span class="linenum">1985</span></a>  <span class="comment">/*</span>
<a name="l1986"><span class="linenum">1986</span></a>  <span class="comment"> * Structure step that will read the roles.xml file (at course/activity/block levels)</span>
<a name="l1987"><span class="linenum">1987</span></a>  <span class="comment"> * containing all the role_assignments and overrides for that context. If corresponding to</span>
<a name="l1988"><span class="linenum">1988</span></a>  <span class="comment"> * one mapped role, they will be applied to target context. Will observe the role_assignments</span>
<a name="l1989"><span class="linenum">1989</span></a>  <span class="comment"> * setting to decide if ras are restored.</span>
<a name="l1990"><span class="linenum">1990</span></a>  <span class="comment"> *</span>
<a name="l1991"><span class="linenum">1991</span></a>  <span class="comment"> * Note: this needs to be executed after all users are enrolled.</span>
<a name="l1992"><span class="linenum">1992</span></a>  <span class="comment"> */</span>
<a name="l1993"><span class="linenum">1993</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_ras_and_caps_structure_step')" href="../../_classes/restore_ras_and_caps_structure_step.html" onMouseOver="classPopup(event,'restore_ras_and_caps_structure_step')">restore_ras_and_caps_structure_step</a> extends restore_structure_step {
<a name="l1994"><span class="linenum">1994</span></a>      protected <a class="var it3924" onMouseOver="hilite(3924)" onMouseOut="lolite()" onClick="logVariable('plugins')" href="../../_variables/plugins.html">$plugins</a> = null;
<a name="l1995"><span class="linenum">1995</span></a>  
<a name="l1996"><span class="linenum">1996</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l1997"><span class="linenum">1997</span></a>  
<a name="l1998"><span class="linenum">1998</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array();
<a name="l1999"><span class="linenum">1999</span></a>  
<a name="l2000"><span class="linenum">2000</span></a>  <span class="comment">        // Observe the role_assignments setting</span>
<a name="l2001"><span class="linenum">2001</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('role_assignments')) {
<a name="l2002"><span class="linenum">2002</span></a>              <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('assignment', '/roles/role_assignments/assignment');
<a name="l2003"><span class="linenum">2003</span></a>          }
<a name="l2004"><span class="linenum">2004</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('override', '/roles/role_overrides/override');
<a name="l2005"><span class="linenum">2005</span></a>  
<a name="l2006"><span class="linenum">2006</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l2007"><span class="linenum">2007</span></a>      }
<a name="l2008"><span class="linenum">2008</span></a>  
<a name="l2009"><span class="linenum">2009</span></a>      <span class="comment">/**</span>
<a name="l2010"><span class="linenum">2010</span></a>  <span class="comment">     * Assign roles</span>
<a name="l2011"><span class="linenum">2011</span></a>  <span class="comment">     *</span>
<a name="l2012"><span class="linenum">2012</span></a>  <span class="comment">     * This has to be called after enrolments processing.</span>
<a name="l2013"><span class="linenum">2013</span></a>  <span class="comment">     *</span>
<a name="l2014"><span class="linenum">2014</span></a>  <span class="comment">     * @param mixed $data</span>
<a name="l2015"><span class="linenum">2015</span></a>  <span class="comment">     * @return void</span>
<a name="l2016"><span class="linenum">2016</span></a>  <span class="comment">     */</span>
<a name="l2017"><span class="linenum">2017</span></a>      public function <a class="function" onClick="logFunction('process_assignment')" href="../../_functions/process_assignment.html" onMouseOver="funcPopup(event,'process_assignment')">process_assignment</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l2018"><span class="linenum">2018</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l2019"><span class="linenum">2019</span></a>  
<a name="l2020"><span class="linenum">2020</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l2021"><span class="linenum">2021</span></a>  
<a name="l2022"><span class="linenum">2022</span></a>  <span class="comment">        // Check roleid, userid are one of the mapped ones</span>
<a name="l2023"><span class="linenum">2023</span></a>          if (!<a class="var it15409" onMouseOver="hilite(15409)" onMouseOut="lolite()" onClick="logVariable('newroleid')" href="../../_variables/newroleid.html">$newroleid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('role', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('roleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/roleid.html">roleid</a>)) {
<a name="l2024"><span class="linenum">2024</span></a>              return;
<a name="l2025"><span class="linenum">2025</span></a>          }
<a name="l2026"><span class="linenum">2026</span></a>          if (!<a class="var it15410" onMouseOver="hilite(15410)" onMouseOut="lolite()" onClick="logVariable('newuserid')" href="../../_variables/newuserid.html">$newuserid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>)) {
<a name="l2027"><span class="linenum">2027</span></a>              return;
<a name="l2028"><span class="linenum">2028</span></a>          }
<a name="l2029"><span class="linenum">2029</span></a>          if (!<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists')" href="../../_functions/record_exists.html" onMouseOver="funcPopup(event,'record_exists')">record_exists</a>('user', array('id' =&gt; <a class="var it15410" onMouseOver="hilite(15410)" onMouseOut="lolite()" onClick="logVariable('newuserid')" href="../../_variables/newuserid.html">$newuserid</a>, 'deleted' =&gt; 0))) {
<a name="l2030"><span class="linenum">2030</span></a>  <span class="comment">            // Only assign roles to not deleted users</span>
<a name="l2031"><span class="linenum">2031</span></a>              return;
<a name="l2032"><span class="linenum">2032</span></a>          }
<a name="l2033"><span class="linenum">2033</span></a>          if (!<a class="var it782" onMouseOver="hilite(782)" onMouseOut="lolite()" onClick="logVariable('contextid')" href="../../_variables/contextid.html">$contextid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_contextid')" href="../../_functions/get_contextid.html" onMouseOver="funcPopup(event,'get_contextid')">get_contextid</a>()) {
<a name="l2034"><span class="linenum">2034</span></a>              return;
<a name="l2035"><span class="linenum">2035</span></a>          }
<a name="l2036"><span class="linenum">2036</span></a>  
<a name="l2037"><span class="linenum">2037</span></a>          if (empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('component')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/component.html">component</a>)) {
<a name="l2038"><span class="linenum">2038</span></a>  <span class="comment">            // assign standard manual roles</span>
<a name="l2039"><span class="linenum">2039</span></a>  <span class="comment">            // TODO: role_assign() needs one userid param to be able to specify our restore userid</span>
<a name="l2040"><span class="linenum">2040</span></a>              <a class="function" onClick="logFunction('role_assign')" href="../../_functions/role_assign.html" onMouseOver="funcPopup(event,'role_assign')">role_assign</a>(<a class="var it15409" onMouseOver="hilite(15409)" onMouseOut="lolite()" onClick="logVariable('newroleid')" href="../../_variables/newroleid.html">$newroleid</a>, <a class="var it15410" onMouseOver="hilite(15410)" onMouseOut="lolite()" onClick="logVariable('newuserid')" href="../../_variables/newuserid.html">$newuserid</a>, <a class="var it782" onMouseOver="hilite(782)" onMouseOut="lolite()" onClick="logVariable('contextid')" href="../../_variables/contextid.html">$contextid</a>);
<a name="l2041"><span class="linenum">2041</span></a>  
<a name="l2042"><span class="linenum">2042</span></a>          } else if ((<a class="phpfunction" onClick="logFunction('strpos')" href="../../_functions/strpos.html" onMouseOver="phpfuncPopup(event,'strpos')">strpos</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('component')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/component.html">component</a>, 'enrol_') === 0)) {
<a name="l2043"><span class="linenum">2043</span></a>  <span class="comment">            // Deal with enrolment roles - ignore the component and just find out the instance via new id,</span>
<a name="l2044"><span class="linenum">2044</span></a>  <span class="comment">            // it is possible that enrolment was restored using different plugin type.</span>
<a name="l2045"><span class="linenum">2045</span></a>              if (!isset(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a>)) {
<a name="l2046"><span class="linenum">2046</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a> = <a class="function" onClick="logFunction('enrol_get_plugins')" href="../../_functions/enrol_get_plugins.html" onMouseOver="funcPopup(event,'enrol_get_plugins')">enrol_get_plugins</a>(true);
<a name="l2047"><span class="linenum">2047</span></a>              }
<a name="l2048"><span class="linenum">2048</span></a>              if (<a class="var it1439" onMouseOver="hilite(1439)" onMouseOut="lolite()" onClick="logVariable('enrolid')" href="../../_variables/enrolid.html">$enrolid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('enrol', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>)) {
<a name="l2049"><span class="linenum">2049</span></a>                  if (<a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('instance')" href="../../_variables/instance.html">$instance</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('enrol', array('id'=&gt;<a class="var it1439" onMouseOver="hilite(1439)" onMouseOut="lolite()" onClick="logVariable('enrolid')" href="../../_variables/enrolid.html">$enrolid</a>))) {
<a name="l2050"><span class="linenum">2050</span></a>                      if (isset(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a>[<a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('instance')" href="../../_variables/instance.html">$instance</a>-&gt;<a onClick="logVariable('enrol')" class="var it43004" onMouseOver="hilite(43004)" onMouseOut="lolite()" href="../../_variables/enrol.html">enrol</a>])) {
<a name="l2051"><span class="linenum">2051</span></a>                          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a>[<a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('instance')" href="../../_variables/instance.html">$instance</a>-&gt;<a onClick="logVariable('enrol')" class="var it43004" onMouseOver="hilite(43004)" onMouseOut="lolite()" href="../../_variables/enrol.html">enrol</a>]-&gt;<a class="function" onClick="logFunction('restore_role_assignment')" href="../../_functions/restore_role_assignment.html" onMouseOver="funcPopup(event,'restore_role_assignment')">restore_role_assignment</a>(<a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('instance')" href="../../_variables/instance.html">$instance</a>, <a class="var it15409" onMouseOver="hilite(15409)" onMouseOut="lolite()" onClick="logVariable('newroleid')" href="../../_variables/newroleid.html">$newroleid</a>, <a class="var it15410" onMouseOver="hilite(15410)" onMouseOut="lolite()" onClick="logVariable('newuserid')" href="../../_variables/newuserid.html">$newuserid</a>, <a class="var it782" onMouseOver="hilite(782)" onMouseOut="lolite()" onClick="logVariable('contextid')" href="../../_variables/contextid.html">$contextid</a>);
<a name="l2052"><span class="linenum">2052</span></a>                      }
<a name="l2053"><span class="linenum">2053</span></a>                  }
<a name="l2054"><span class="linenum">2054</span></a>              }
<a name="l2055"><span class="linenum">2055</span></a>  
<a name="l2056"><span class="linenum">2056</span></a>          } else {
<a name="l2057"><span class="linenum">2057</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('roleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/roleid.html">roleid</a>    = <a class="var it15409" onMouseOver="hilite(15409)" onMouseOut="lolite()" onClick="logVariable('newroleid')" href="../../_variables/newroleid.html">$newroleid</a>;
<a name="l2058"><span class="linenum">2058</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>    = <a class="var it15410" onMouseOver="hilite(15410)" onMouseOut="lolite()" onClick="logVariable('newuserid')" href="../../_variables/newuserid.html">$newuserid</a>;
<a name="l2059"><span class="linenum">2059</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('contextid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a> = <a class="var it782" onMouseOver="hilite(782)" onMouseOut="lolite()" onClick="logVariable('contextid')" href="../../_variables/contextid.html">$contextid</a>;
<a name="l2060"><span class="linenum">2060</span></a>              <a class="var it1519" onMouseOver="hilite(1519)" onMouseOut="lolite()" onClick="logVariable('dir')" href="../../_variables/dir.html">$dir</a> = <a class="class" onClick="logClass('core_component')" href="../../_classes/core_component.html" onMouseOver="classPopup(event,'core_component')">core_component</a>::<a class="function" onClick="logFunction('get_component_directory')" href="../../_functions/get_component_directory.html" onMouseOver="funcPopup(event,'get_component_directory')">get_component_directory</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('component')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/component.html">component</a>);
<a name="l2061"><span class="linenum">2061</span></a>              if (<a class="var it1519" onMouseOver="hilite(1519)" onMouseOut="lolite()" onClick="logVariable('dir')" href="../../_variables/dir.html">$dir</a> and <a class="phpfunction" onClick="logFunction('is_dir')" href="../../_functions/is_dir.html" onMouseOver="phpfuncPopup(event,'is_dir')">is_dir</a>(<a class="var it1519" onMouseOver="hilite(1519)" onMouseOut="lolite()" onClick="logVariable('dir')" href="../../_variables/dir.html">$dir</a>)) {
<a name="l2062"><span class="linenum">2062</span></a>                  if (<a class="function" onClick="logFunction('component_callback')" href="../../_functions/component_callback.html" onMouseOver="funcPopup(event,'component_callback')">component_callback</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('component')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/component.html">component</a>, 'restore_role_assignment', array(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>), true)) {
<a name="l2063"><span class="linenum">2063</span></a>                      return;
<a name="l2064"><span class="linenum">2064</span></a>                  }
<a name="l2065"><span class="linenum">2065</span></a>              }
<a name="l2066"><span class="linenum">2066</span></a>  <span class="comment">            // Bad luck, plugin could not restore the data, let's add normal membership.</span>
<a name="l2067"><span class="linenum">2067</span></a>              <a class="function" onClick="logFunction('role_assign')" href="../../_functions/role_assign.html" onMouseOver="funcPopup(event,'role_assign')">role_assign</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('roleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/roleid.html">roleid</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('contextid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a>);
<a name="l2068"><span class="linenum">2068</span></a>              <a class="var it276" onMouseOver="hilite(276)" onMouseOut="lolite()" onClick="logVariable('message')" href="../../_variables/message.html">$message</a> = &quot;Restore of '<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('component')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/component.html">component</a>/<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>' role assignments is not supported, using manual role assignments instead.&quot;;
<a name="l2069"><span class="linenum">2069</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="phpfunction" onClick="logFunction('log')" href="../../_functions/log.html" onMouseOver="phpfuncPopup(event,'log')">log</a>(<a class="var it276" onMouseOver="hilite(276)" onMouseOut="lolite()" onClick="logVariable('message')" href="../../_variables/message.html">$message</a>, backup::LOG_WARNING);
<a name="l2070"><span class="linenum">2070</span></a>          }
<a name="l2071"><span class="linenum">2071</span></a>      }
<a name="l2072"><span class="linenum">2072</span></a>  
<a name="l2073"><span class="linenum">2073</span></a>      public function <a class="function" onClick="logFunction('process_override')" href="../../_functions/process_override.html" onMouseOver="funcPopup(event,'process_override')">process_override</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l2074"><span class="linenum">2074</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l2075"><span class="linenum">2075</span></a>  
<a name="l2076"><span class="linenum">2076</span></a>  <span class="comment">        // Check roleid is one of the mapped ones</span>
<a name="l2077"><span class="linenum">2077</span></a>          <a class="var it15409" onMouseOver="hilite(15409)" onMouseOut="lolite()" onClick="logVariable('newroleid')" href="../../_variables/newroleid.html">$newroleid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('role', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('roleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/roleid.html">roleid</a>);
<a name="l2078"><span class="linenum">2078</span></a>  <span class="comment">        // If newroleid and context are valid assign it via API (it handles dupes and so on)</span>
<a name="l2079"><span class="linenum">2079</span></a>          if (<a class="var it15409" onMouseOver="hilite(15409)" onMouseOut="lolite()" onClick="logVariable('newroleid')" href="../../_variables/newroleid.html">$newroleid</a> &amp;&amp; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_contextid')" href="../../_functions/get_contextid.html" onMouseOver="funcPopup(event,'get_contextid')">get_contextid</a>()) {
<a name="l2080"><span class="linenum">2080</span></a>  <span class="comment">            // TODO: assign_capability() needs one userid param to be able to specify our restore userid</span>
<a name="l2081"><span class="linenum">2081</span></a>  <span class="comment">            // TODO: it seems that assign_capability() doesn't check for valid capabilities at all ???</span>
<a name="l2082"><span class="linenum">2082</span></a>              <a class="function" onClick="logFunction('assign_capability')" href="../../_functions/assign_capability.html" onMouseOver="funcPopup(event,'assign_capability')">assign_capability</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('capability')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/capability.html">capability</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('permission')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/permission.html">permission</a>, <a class="var it15409" onMouseOver="hilite(15409)" onMouseOut="lolite()" onClick="logVariable('newroleid')" href="../../_variables/newroleid.html">$newroleid</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_contextid')" href="../../_functions/get_contextid.html" onMouseOver="funcPopup(event,'get_contextid')">get_contextid</a>());
<a name="l2083"><span class="linenum">2083</span></a>          }
<a name="l2084"><span class="linenum">2084</span></a>      }
<a name="l2085"><span class="linenum">2085</span></a>  }
<a name="l2086"><span class="linenum">2086</span></a>  
<a name="l2087"><span class="linenum">2087</span></a>  <span class="comment">/**</span>
<a name="l2088"><span class="linenum">2088</span></a>  <span class="comment"> * If no instances yet add default enrol methods the same way as when creating new course in UI.</span>
<a name="l2089"><span class="linenum">2089</span></a>  <span class="comment"> */</span>
<a name="l2090"><span class="linenum">2090</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_default_enrolments_step')" href="../../_classes/restore_default_enrolments_step.html" onMouseOver="classPopup(event,'restore_default_enrolments_step')">restore_default_enrolments_step</a> extends restore_execution_step {
<a name="l2091"><span class="linenum">2091</span></a>  
<a name="l2092"><span class="linenum">2092</span></a>      public function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l2093"><span class="linenum">2093</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l2094"><span class="linenum">2094</span></a>  
<a name="l2095"><span class="linenum">2095</span></a>  <span class="comment">        // No enrolments in front page.</span>
<a name="l2096"><span class="linenum">2096</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>() == <a class="constant" onClick="logConstant('SITEID')" href="../../_constants/SITEID.html" onMouseOver="constPopup(event,'SITEID')">SITEID</a>) {
<a name="l2097"><span class="linenum">2097</span></a>              return;
<a name="l2098"><span class="linenum">2098</span></a>          }
<a name="l2099"><span class="linenum">2099</span></a>  
<a name="l2100"><span class="linenum">2100</span></a>          <a class="var it8" onMouseOver="hilite(8)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('course', array('id'=&gt;<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>()), '*', <a class="constant" onClick="logConstant('MUST_EXIST')" href="../../_constants/MUST_EXIST.html" onMouseOver="constPopup(event,'MUST_EXIST')">MUST_EXIST</a>);
<a name="l2101"><span class="linenum">2101</span></a>  
<a name="l2102"><span class="linenum">2102</span></a>          if (<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists')" href="../../_functions/record_exists.html" onMouseOver="funcPopup(event,'record_exists')">record_exists</a>('enrol', array('courseid'=&gt;<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(), 'enrol'=&gt;'manual'))) {
<a name="l2103"><span class="linenum">2103</span></a>  <span class="comment">            // Something already added instances, do not add default instances.</span>
<a name="l2104"><span class="linenum">2104</span></a>              <a class="var it3924" onMouseOver="hilite(3924)" onMouseOut="lolite()" onClick="logVariable('plugins')" href="../../_variables/plugins.html">$plugins</a> = <a class="function" onClick="logFunction('enrol_get_plugins')" href="../../_functions/enrol_get_plugins.html" onMouseOver="funcPopup(event,'enrol_get_plugins')">enrol_get_plugins</a>(true);
<a name="l2105"><span class="linenum">2105</span></a>              foreach (<a class="var it3924" onMouseOver="hilite(3924)" onMouseOut="lolite()" onClick="logVariable('plugins')" href="../../_variables/plugins.html">$plugins</a> as <a class="var it265" onMouseOver="hilite(265)" onMouseOut="lolite()" onClick="logVariable('plugin')" href="../../_variables/plugin.html">$plugin</a>) {
<a name="l2106"><span class="linenum">2106</span></a>                  <a class="var it265" onMouseOver="hilite(265)" onMouseOut="lolite()" onClick="logVariable('plugin')" href="../../_variables/plugin.html">$plugin</a>-&gt;<a class="function" onClick="logFunction('restore_sync_course')" href="../../_functions/restore_sync_course.html" onMouseOver="funcPopup(event,'restore_sync_course')">restore_sync_course</a>(<a class="var it8" onMouseOver="hilite(8)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>);
<a name="l2107"><span class="linenum">2107</span></a>              }
<a name="l2108"><span class="linenum">2108</span></a>  
<a name="l2109"><span class="linenum">2109</span></a>          } else {
<a name="l2110"><span class="linenum">2110</span></a>  <span class="comment">            // Looks like a newly created course.</span>
<a name="l2111"><span class="linenum">2111</span></a>              <a class="function" onClick="logFunction('enrol_course_updated')" href="../../_functions/enrol_course_updated.html" onMouseOver="funcPopup(event,'enrol_course_updated')">enrol_course_updated</a>(true, <a class="var it8" onMouseOver="hilite(8)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>, null);
<a name="l2112"><span class="linenum">2112</span></a>          }
<a name="l2113"><span class="linenum">2113</span></a>      }
<a name="l2114"><span class="linenum">2114</span></a>  }
<a name="l2115"><span class="linenum">2115</span></a>  
<a name="l2116"><span class="linenum">2116</span></a>  <span class="comment">/**</span>
<a name="l2117"><span class="linenum">2117</span></a>  <span class="comment"> * This structure steps restores the enrol plugins and their underlying</span>
<a name="l2118"><span class="linenum">2118</span></a>  <span class="comment"> * enrolments, performing all the mappings and/or movements required</span>
<a name="l2119"><span class="linenum">2119</span></a>  <span class="comment"> */</span>
<a name="l2120"><span class="linenum">2120</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_enrolments_structure_step')" href="../../_classes/restore_enrolments_structure_step.html" onMouseOver="classPopup(event,'restore_enrolments_structure_step')">restore_enrolments_structure_step</a> extends restore_structure_step {
<a name="l2121"><span class="linenum">2121</span></a>      protected <a class="var it15411" onMouseOver="hilite(15411)" onMouseOut="lolite()" onClick="logVariable('enrolsynced')" href="../../_variables/enrolsynced.html">$enrolsynced</a> = false;
<a name="l2122"><span class="linenum">2122</span></a>      protected <a class="var it3924" onMouseOver="hilite(3924)" onMouseOut="lolite()" onClick="logVariable('plugins')" href="../../_variables/plugins.html">$plugins</a> = null;
<a name="l2123"><span class="linenum">2123</span></a>      protected <a class="var it15412" onMouseOver="hilite(15412)" onMouseOut="lolite()" onClick="logVariable('originalstatus')" href="../../_variables/originalstatus.html">$originalstatus</a> = array();
<a name="l2124"><span class="linenum">2124</span></a>  
<a name="l2125"><span class="linenum">2125</span></a>      <span class="comment">/**</span>
<a name="l2126"><span class="linenum">2126</span></a>  <span class="comment">     * Conditionally decide if this step should be executed.</span>
<a name="l2127"><span class="linenum">2127</span></a>  <span class="comment">     *</span>
<a name="l2128"><span class="linenum">2128</span></a>  <span class="comment">     * This function checks the following parameter:</span>
<a name="l2129"><span class="linenum">2129</span></a>  <span class="comment">     *</span>
<a name="l2130"><span class="linenum">2130</span></a>  <span class="comment">     *   1. the course/enrolments.xml file exists</span>
<a name="l2131"><span class="linenum">2131</span></a>  <span class="comment">     *</span>
<a name="l2132"><span class="linenum">2132</span></a>  <span class="comment">     * @return bool true is safe to execute, false otherwise</span>
<a name="l2133"><span class="linenum">2133</span></a>  <span class="comment">     */</span>
<a name="l2134"><span class="linenum">2134</span></a>      protected function <a class="function" onClick="logFunction('execute_condition')" href="../../_functions/execute_condition.html" onMouseOver="funcPopup(event,'execute_condition')">execute_condition</a>() {
<a name="l2135"><span class="linenum">2135</span></a>  
<a name="l2136"><span class="linenum">2136</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>() == <a class="constant" onClick="logConstant('SITEID')" href="../../_constants/SITEID.html" onMouseOver="constPopup(event,'SITEID')">SITEID</a>) {
<a name="l2137"><span class="linenum">2137</span></a>              return false;
<a name="l2138"><span class="linenum">2138</span></a>          }
<a name="l2139"><span class="linenum">2139</span></a>  
<a name="l2140"><span class="linenum">2140</span></a>  <span class="comment">        // Check it is included in the backup</span>
<a name="l2141"><span class="linenum">2141</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_taskbasepath')" href="../../_functions/get_taskbasepath.html" onMouseOver="funcPopup(event,'get_taskbasepath')">get_taskbasepath</a>();
<a name="l2142"><span class="linenum">2142</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="phpfunction" onClick="logFunction('rtrim')" href="../../_functions/rtrim.html" onMouseOver="phpfuncPopup(event,'rtrim')">rtrim</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>, '/') . '/' . <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('filename')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/filename.html">filename</a>;
<a name="l2143"><span class="linenum">2143</span></a>          if (!<a class="phpfunction" onClick="logFunction('file_exists')" href="../../_functions/file_exists.html" onMouseOver="phpfuncPopup(event,'file_exists')">file_exists</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>)) {
<a name="l2144"><span class="linenum">2144</span></a>  <span class="comment">            // Not found, can't restore enrolments info</span>
<a name="l2145"><span class="linenum">2145</span></a>              return false;
<a name="l2146"><span class="linenum">2146</span></a>          }
<a name="l2147"><span class="linenum">2147</span></a>  
<a name="l2148"><span class="linenum">2148</span></a>          return true;
<a name="l2149"><span class="linenum">2149</span></a>      }
<a name="l2150"><span class="linenum">2150</span></a>  
<a name="l2151"><span class="linenum">2151</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l2152"><span class="linenum">2152</span></a>  
<a name="l2153"><span class="linenum">2153</span></a>          <a class="var it747" onMouseOver="hilite(747)" onMouseOut="lolite()" onClick="logVariable('enrol')" href="../../_variables/enrol.html">$enrol</a> = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('enrol', '/enrolments/enrols/enrol');
<a name="l2154"><span class="linenum">2154</span></a>          <a class="var it15413" onMouseOver="hilite(15413)" onMouseOut="lolite()" onClick="logVariable('enrolment')" href="../../_variables/enrolment.html">$enrolment</a> = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('enrolment', '/enrolments/enrols/enrol/user_enrolments/enrolment');
<a name="l2155"><span class="linenum">2155</span></a>  <span class="comment">        // Attach local plugin stucture to enrol element.</span>
<a name="l2156"><span class="linenum">2156</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('enrol', <a class="var it747" onMouseOver="hilite(747)" onMouseOut="lolite()" onClick="logVariable('enrol')" href="../../_variables/enrol.html">$enrol</a>);
<a name="l2157"><span class="linenum">2157</span></a>  
<a name="l2158"><span class="linenum">2158</span></a>          return array(<a class="var it747" onMouseOver="hilite(747)" onMouseOut="lolite()" onClick="logVariable('enrol')" href="../../_variables/enrol.html">$enrol</a>, <a class="var it15413" onMouseOver="hilite(15413)" onMouseOut="lolite()" onClick="logVariable('enrolment')" href="../../_variables/enrolment.html">$enrolment</a>);
<a name="l2159"><span class="linenum">2159</span></a>      }
<a name="l2160"><span class="linenum">2160</span></a>  
<a name="l2161"><span class="linenum">2161</span></a>      <span class="comment">/**</span>
<a name="l2162"><span class="linenum">2162</span></a>  <span class="comment">     * Create enrolment instances.</span>
<a name="l2163"><span class="linenum">2163</span></a>  <span class="comment">     *</span>
<a name="l2164"><span class="linenum">2164</span></a>  <span class="comment">     * This has to be called after creation of roles</span>
<a name="l2165"><span class="linenum">2165</span></a>  <span class="comment">     * and before adding of role assignments.</span>
<a name="l2166"><span class="linenum">2166</span></a>  <span class="comment">     *</span>
<a name="l2167"><span class="linenum">2167</span></a>  <span class="comment">     * @param mixed $data</span>
<a name="l2168"><span class="linenum">2168</span></a>  <span class="comment">     * @return void</span>
<a name="l2169"><span class="linenum">2169</span></a>  <span class="comment">     */</span>
<a name="l2170"><span class="linenum">2170</span></a>      public function <a class="function" onClick="logFunction('process_enrol')" href="../../_functions/process_enrol.html" onMouseOver="funcPopup(event,'process_enrol')">process_enrol</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l2171"><span class="linenum">2171</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l2172"><span class="linenum">2172</span></a>  
<a name="l2173"><span class="linenum">2173</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l2174"><span class="linenum">2174</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>; <span class="comment">// We'll need this later.</span>
<a name="l2175"><span class="linenum">2175</span></a>          unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>);
<a name="l2176"><span class="linenum">2176</span></a>  
<a name="l2177"><span class="linenum">2177</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('originalstatus')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/originalstatus.html">originalstatus</a>[<a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>] = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('status')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/status.html">status</a>;
<a name="l2178"><span class="linenum">2178</span></a>  
<a name="l2179"><span class="linenum">2179</span></a>          if (!<a class="var it15414" onMouseOver="hilite(15414)" onMouseOut="lolite()" onClick="logVariable('courserec')" href="../../_variables/courserec.html">$courserec</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('course', array('id' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>()))) {
<a name="l2180"><span class="linenum">2180</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('enrol', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, 0);
<a name="l2181"><span class="linenum">2181</span></a>              return;
<a name="l2182"><span class="linenum">2182</span></a>          }
<a name="l2183"><span class="linenum">2183</span></a>  
<a name="l2184"><span class="linenum">2184</span></a>          if (!isset(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a>)) {
<a name="l2185"><span class="linenum">2185</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a> = <a class="function" onClick="logFunction('enrol_get_plugins')" href="../../_functions/enrol_get_plugins.html" onMouseOver="funcPopup(event,'enrol_get_plugins')">enrol_get_plugins</a>(true);
<a name="l2186"><span class="linenum">2186</span></a>          }
<a name="l2187"><span class="linenum">2187</span></a>  
<a name="l2188"><span class="linenum">2188</span></a>          if (!<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('enrolsynced')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/enrolsynced.html">enrolsynced</a>) {
<a name="l2189"><span class="linenum">2189</span></a>  <span class="comment">            // Make sure that all plugin may create instances and enrolments automatically</span>
<a name="l2190"><span class="linenum">2190</span></a>  <span class="comment">            // before the first instance restore - this is suitable especially for plugins</span>
<a name="l2191"><span class="linenum">2191</span></a>  <span class="comment">            // that synchronise data automatically using course-&gt;idnumber or by course categories.</span>
<a name="l2192"><span class="linenum">2192</span></a>              foreach (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a> as <a class="var it265" onMouseOver="hilite(265)" onMouseOut="lolite()" onClick="logVariable('plugin')" href="../../_variables/plugin.html">$plugin</a>) {
<a name="l2193"><span class="linenum">2193</span></a>                  <a class="var it265" onMouseOver="hilite(265)" onMouseOut="lolite()" onClick="logVariable('plugin')" href="../../_variables/plugin.html">$plugin</a>-&gt;<a class="function" onClick="logFunction('restore_sync_course')" href="../../_functions/restore_sync_course.html" onMouseOver="funcPopup(event,'restore_sync_course')">restore_sync_course</a>(<a class="var it15414" onMouseOver="hilite(15414)" onMouseOut="lolite()" onClick="logVariable('courserec')" href="../../_variables/courserec.html">$courserec</a>);
<a name="l2194"><span class="linenum">2194</span></a>              }
<a name="l2195"><span class="linenum">2195</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('enrolsynced')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/enrolsynced.html">enrolsynced</a> = true;
<a name="l2196"><span class="linenum">2196</span></a>          }
<a name="l2197"><span class="linenum">2197</span></a>  
<a name="l2198"><span class="linenum">2198</span></a>  <span class="comment">        // Map standard fields - plugin has to process custom fields manually.</span>
<a name="l2199"><span class="linenum">2199</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('roleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/roleid.html">roleid</a>   = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('role', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('roleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/roleid.html">roleid</a>);
<a name="l2200"><span class="linenum">2200</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a> = <a class="var it15414" onMouseOver="hilite(15414)" onMouseOut="lolite()" onClick="logVariable('courserec')" href="../../_variables/courserec.html">$courserec</a>-&gt;<a onClick="logVariable('id')" class="var it45276" onMouseOver="hilite(45276)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l2201"><span class="linenum">2201</span></a>  
<a name="l2202"><span class="linenum">2202</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('enrol_migratetomanual')) {
<a name="l2203"><span class="linenum">2203</span></a>              unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('sortorder')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/sortorder.html">sortorder</a>); <span class="comment">// Remove useless sortorder from &lt;2.4 backups.</span>
<a name="l2204"><span class="linenum">2204</span></a>              if (!<a class="function" onClick="logFunction('enrol_is_enabled')" href="../../_functions/enrol_is_enabled.html" onMouseOver="funcPopup(event,'enrol_is_enabled')">enrol_is_enabled</a>('manual')) {
<a name="l2205"><span class="linenum">2205</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('enrol', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, 0);
<a name="l2206"><span class="linenum">2206</span></a>                  return;
<a name="l2207"><span class="linenum">2207</span></a>              }
<a name="l2208"><span class="linenum">2208</span></a>              if (<a class="var it1025" onMouseOver="hilite(1025)" onMouseOut="lolite()" onClick="logVariable('instances')" href="../../_variables/instances.html">$instances</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records')" href="../../_functions/get_records.html" onMouseOver="funcPopup(event,'get_records')">get_records</a>('enrol', array('courseid'=&gt;<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a>, 'enrol'=&gt;'manual'), 'id')) {
<a name="l2209"><span class="linenum">2209</span></a>                  <a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('instance')" href="../../_variables/instance.html">$instance</a> = <a class="phpfunction" onClick="logFunction('reset')" href="../../_functions/reset.html" onMouseOver="phpfuncPopup(event,'reset')">reset</a>(<a class="var it1025" onMouseOver="hilite(1025)" onMouseOut="lolite()" onClick="logVariable('instances')" href="../../_variables/instances.html">$instances</a>);
<a name="l2210"><span class="linenum">2210</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('enrol', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('instance')" href="../../_variables/instance.html">$instance</a>-&gt;<a onClick="logVariable('id')" class="var it43004" onMouseOver="hilite(43004)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>);
<a name="l2211"><span class="linenum">2211</span></a>              } else {
<a name="l2212"><span class="linenum">2212</span></a>                  if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('enrol')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/enrol.html">enrol</a> === 'manual') {
<a name="l2213"><span class="linenum">2213</span></a>                      <a class="var it1184" onMouseOver="hilite(1184)" onMouseOut="lolite()" onClick="logVariable('instanceid')" href="../../_variables/instanceid.html">$instanceid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a>['manual']-&gt;<a class="function" onClick="logFunction('add_instance')" href="../../_functions/add_instance.html" onMouseOver="funcPopup(event,'add_instance')">add_instance</a>(<a class="var it15414" onMouseOver="hilite(15414)" onMouseOut="lolite()" onClick="logVariable('courserec')" href="../../_variables/courserec.html">$courserec</a>, (array)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l2214"><span class="linenum">2214</span></a>                  } else {
<a name="l2215"><span class="linenum">2215</span></a>                      <a class="var it1184" onMouseOver="hilite(1184)" onMouseOut="lolite()" onClick="logVariable('instanceid')" href="../../_variables/instanceid.html">$instanceid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a>['manual']-&gt;<a class="function" onClick="logFunction('add_default_instance')" href="../../_functions/add_default_instance.html" onMouseOver="funcPopup(event,'add_default_instance')">add_default_instance</a>(<a class="var it15414" onMouseOver="hilite(15414)" onMouseOut="lolite()" onClick="logVariable('courserec')" href="../../_variables/courserec.html">$courserec</a>);
<a name="l2216"><span class="linenum">2216</span></a>                  }
<a name="l2217"><span class="linenum">2217</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('enrol', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it1184" onMouseOver="hilite(1184)" onMouseOut="lolite()" onClick="logVariable('instanceid')" href="../../_variables/instanceid.html">$instanceid</a>);
<a name="l2218"><span class="linenum">2218</span></a>              }
<a name="l2219"><span class="linenum">2219</span></a>  
<a name="l2220"><span class="linenum">2220</span></a>          } else {
<a name="l2221"><span class="linenum">2221</span></a>              if (!<a class="function" onClick="logFunction('enrol_is_enabled')" href="../../_functions/enrol_is_enabled.html" onMouseOver="funcPopup(event,'enrol_is_enabled')">enrol_is_enabled</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('enrol')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/enrol.html">enrol</a>) or !isset(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a>[<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('enrol')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/enrol.html">enrol</a>])) {
<a name="l2222"><span class="linenum">2222</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('enrol', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, 0);
<a name="l2223"><span class="linenum">2223</span></a>                  <a class="var it276" onMouseOver="hilite(276)" onMouseOut="lolite()" onClick="logVariable('message')" href="../../_variables/message.html">$message</a> = &quot;Enrol plugin '<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('enrol')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/enrol.html">enrol</a>' data can not be restored because it is not enabled, use migration to manual enrolments&quot;;
<a name="l2224"><span class="linenum">2224</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="phpfunction" onClick="logFunction('log')" href="../../_functions/log.html" onMouseOver="phpfuncPopup(event,'log')">log</a>(<a class="var it276" onMouseOver="hilite(276)" onMouseOut="lolite()" onClick="logVariable('message')" href="../../_variables/message.html">$message</a>, backup::LOG_WARNING);
<a name="l2225"><span class="linenum">2225</span></a>                  return;
<a name="l2226"><span class="linenum">2226</span></a>              }
<a name="l2227"><span class="linenum">2227</span></a>              if (<a class="var it720" onMouseOver="hilite(720)" onMouseOut="lolite()" onClick="logVariable('task')" href="../../_variables/task.html">$task</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_task')" href="../../_functions/get_task.html" onMouseOver="funcPopup(event,'get_task')">get_task</a>() and <a class="var it720" onMouseOver="hilite(720)" onMouseOut="lolite()" onClick="logVariable('task')" href="../../_variables/task.html">$task</a>-&gt;<a class="function" onClick="logFunction('get_target')" href="../../_functions/get_target.html" onMouseOver="funcPopup(event,'get_target')">get_target</a>() == backup::TARGET_NEW_COURSE) {
<a name="l2228"><span class="linenum">2228</span></a>  <span class="comment">                // Let's keep the sortorder in old backups.</span>
<a name="l2229"><span class="linenum">2229</span></a>              } else {
<a name="l2230"><span class="linenum">2230</span></a>  <span class="comment">                // Prevent problems with colliding sortorders in old backups,</span>
<a name="l2231"><span class="linenum">2231</span></a>  <span class="comment">                // new 2.4 backups do not need sortorder because xml elements are ordered properly.</span>
<a name="l2232"><span class="linenum">2232</span></a>                  unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('sortorder')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/sortorder.html">sortorder</a>);
<a name="l2233"><span class="linenum">2233</span></a>              }
<a name="l2234"><span class="linenum">2234</span></a>  <span class="comment">            // Note: plugin is responsible for setting up the mapping, it may also decide to migrate to different type.</span>
<a name="l2235"><span class="linenum">2235</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a>[<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('enrol')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/enrol.html">enrol</a>]-&gt;<a class="function" onClick="logFunction('restore_instance')" href="../../_functions/restore_instance.html" onMouseOver="funcPopup(event,'restore_instance')">restore_instance</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, <a class="var it15414" onMouseOver="hilite(15414)" onMouseOut="lolite()" onClick="logVariable('courserec')" href="../../_variables/courserec.html">$courserec</a>, <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>);
<a name="l2236"><span class="linenum">2236</span></a>          }
<a name="l2237"><span class="linenum">2237</span></a>      }
<a name="l2238"><span class="linenum">2238</span></a>  
<a name="l2239"><span class="linenum">2239</span></a>      <span class="comment">/**</span>
<a name="l2240"><span class="linenum">2240</span></a>  <span class="comment">     * Create user enrolments.</span>
<a name="l2241"><span class="linenum">2241</span></a>  <span class="comment">     *</span>
<a name="l2242"><span class="linenum">2242</span></a>  <span class="comment">     * This has to be called after creation of enrolment instances</span>
<a name="l2243"><span class="linenum">2243</span></a>  <span class="comment">     * and before adding of role assignments.</span>
<a name="l2244"><span class="linenum">2244</span></a>  <span class="comment">     *</span>
<a name="l2245"><span class="linenum">2245</span></a>  <span class="comment">     * Roles are assigned in restore_ras_and_caps_structure_step::process_assignment() processing afterwards.</span>
<a name="l2246"><span class="linenum">2246</span></a>  <span class="comment">     *</span>
<a name="l2247"><span class="linenum">2247</span></a>  <span class="comment">     * @param mixed $data</span>
<a name="l2248"><span class="linenum">2248</span></a>  <span class="comment">     * @return void</span>
<a name="l2249"><span class="linenum">2249</span></a>  <span class="comment">     */</span>
<a name="l2250"><span class="linenum">2250</span></a>      public function <a class="function" onClick="logFunction('process_enrolment')" href="../../_functions/process_enrolment.html" onMouseOver="funcPopup(event,'process_enrolment')">process_enrolment</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l2251"><span class="linenum">2251</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l2252"><span class="linenum">2252</span></a>  
<a name="l2253"><span class="linenum">2253</span></a>          if (!isset(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a>)) {
<a name="l2254"><span class="linenum">2254</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a> = <a class="function" onClick="logFunction('enrol_get_plugins')" href="../../_functions/enrol_get_plugins.html" onMouseOver="funcPopup(event,'enrol_get_plugins')">enrol_get_plugins</a>(true);
<a name="l2255"><span class="linenum">2255</span></a>          }
<a name="l2256"><span class="linenum">2256</span></a>  
<a name="l2257"><span class="linenum">2257</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l2258"><span class="linenum">2258</span></a>  
<a name="l2259"><span class="linenum">2259</span></a>  <span class="comment">        // Process only if parent instance have been mapped.</span>
<a name="l2260"><span class="linenum">2260</span></a>          if (<a class="var it1439" onMouseOver="hilite(1439)" onMouseOut="lolite()" onClick="logVariable('enrolid')" href="../../_variables/enrolid.html">$enrolid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_new_parentid')" href="../../_functions/get_new_parentid.html" onMouseOver="funcPopup(event,'get_new_parentid')">get_new_parentid</a>('enrol')) {
<a name="l2261"><span class="linenum">2261</span></a>              <a class="var it4197" onMouseOver="hilite(4197)" onMouseOut="lolite()" onClick="logVariable('oldinstancestatus')" href="../../_variables/oldinstancestatus.html">$oldinstancestatus</a> = <a class="constant" onClick="logConstant('ENROL_INSTANCE_ENABLED')" href="../../_constants/ENROL_INSTANCE_ENABLED.html" onMouseOver="constPopup(event,'ENROL_INSTANCE_ENABLED')">ENROL_INSTANCE_ENABLED</a>;
<a name="l2262"><span class="linenum">2262</span></a>              <a class="var it15415" onMouseOver="hilite(15415)" onMouseOut="lolite()" onClick="logVariable('oldenrolid')" href="../../_variables/oldenrolid.html">$oldenrolid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_old_parentid')" href="../../_functions/get_old_parentid.html" onMouseOver="funcPopup(event,'get_old_parentid')">get_old_parentid</a>('enrol');
<a name="l2263"><span class="linenum">2263</span></a>              if (isset(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('originalstatus')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/originalstatus.html">originalstatus</a>[<a class="var it15415" onMouseOver="hilite(15415)" onMouseOut="lolite()" onClick="logVariable('oldenrolid')" href="../../_variables/oldenrolid.html">$oldenrolid</a>])) {
<a name="l2264"><span class="linenum">2264</span></a>                  <a class="var it4197" onMouseOver="hilite(4197)" onMouseOut="lolite()" onClick="logVariable('oldinstancestatus')" href="../../_variables/oldinstancestatus.html">$oldinstancestatus</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('originalstatus')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/originalstatus.html">originalstatus</a>[<a class="var it15415" onMouseOver="hilite(15415)" onMouseOut="lolite()" onClick="logVariable('oldenrolid')" href="../../_variables/oldenrolid.html">$oldenrolid</a>];
<a name="l2265"><span class="linenum">2265</span></a>              }
<a name="l2266"><span class="linenum">2266</span></a>              if (<a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('instance')" href="../../_variables/instance.html">$instance</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('enrol', array('id'=&gt;<a class="var it1439" onMouseOver="hilite(1439)" onMouseOut="lolite()" onClick="logVariable('enrolid')" href="../../_variables/enrolid.html">$enrolid</a>))) {
<a name="l2267"><span class="linenum">2267</span></a>  <span class="comment">                // And only if user is a mapped one.</span>
<a name="l2268"><span class="linenum">2268</span></a>                  if (<a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>)) {
<a name="l2269"><span class="linenum">2269</span></a>                      if (isset(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a>[<a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('instance')" href="../../_variables/instance.html">$instance</a>-&gt;<a onClick="logVariable('enrol')" class="var it43004" onMouseOver="hilite(43004)" onMouseOut="lolite()" href="../../_variables/enrol.html">enrol</a>])) {
<a name="l2270"><span class="linenum">2270</span></a>                          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('plugins')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/plugins.html">plugins</a>[<a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('instance')" href="../../_variables/instance.html">$instance</a>-&gt;<a onClick="logVariable('enrol')" class="var it43004" onMouseOver="hilite(43004)" onMouseOut="lolite()" href="../../_variables/enrol.html">enrol</a>]-&gt;<a class="function" onClick="logFunction('restore_user_enrolment')" href="../../_functions/restore_user_enrolment.html" onMouseOver="funcPopup(event,'restore_user_enrolment')">restore_user_enrolment</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, <a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('instance')" href="../../_variables/instance.html">$instance</a>, <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>, <a class="var it4197" onMouseOver="hilite(4197)" onMouseOut="lolite()" onClick="logVariable('oldinstancestatus')" href="../../_variables/oldinstancestatus.html">$oldinstancestatus</a>);
<a name="l2271"><span class="linenum">2271</span></a>                      }
<a name="l2272"><span class="linenum">2272</span></a>                  }
<a name="l2273"><span class="linenum">2273</span></a>              }
<a name="l2274"><span class="linenum">2274</span></a>          }
<a name="l2275"><span class="linenum">2275</span></a>      }
<a name="l2276"><span class="linenum">2276</span></a>  }
<a name="l2277"><span class="linenum">2277</span></a>  
<a name="l2278"><span class="linenum">2278</span></a>  
<a name="l2279"><span class="linenum">2279</span></a>  <span class="comment">/**</span>
<a name="l2280"><span class="linenum">2280</span></a>  <span class="comment"> * Make sure the user restoring the course can actually access it.</span>
<a name="l2281"><span class="linenum">2281</span></a>  <span class="comment"> */</span>
<a name="l2282"><span class="linenum">2282</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_fix_restorer_access_step')" href="../../_classes/restore_fix_restorer_access_step.html" onMouseOver="classPopup(event,'restore_fix_restorer_access_step')">restore_fix_restorer_access_step</a> extends restore_execution_step {
<a name="l2283"><span class="linenum">2283</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l2284"><span class="linenum">2284</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l2285"><span class="linenum">2285</span></a>  
<a name="l2286"><span class="linenum">2286</span></a>          if (!<a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>()) {
<a name="l2287"><span class="linenum">2287</span></a>              return;
<a name="l2288"><span class="linenum">2288</span></a>          }
<a name="l2289"><span class="linenum">2289</span></a>  
<a name="l2290"><span class="linenum">2290</span></a>          if (empty(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('restorernewroleid')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/restorernewroleid.html">restorernewroleid</a>)) {
<a name="l2291"><span class="linenum">2291</span></a>  <span class="comment">            // Bad luck, no fallback role for restorers specified</span>
<a name="l2292"><span class="linenum">2292</span></a>              return;
<a name="l2293"><span class="linenum">2293</span></a>          }
<a name="l2294"><span class="linenum">2294</span></a>  
<a name="l2295"><span class="linenum">2295</span></a>          <a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l2296"><span class="linenum">2296</span></a>          <a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a> = <a class="class" onClick="logClass('context_course')" href="../../_classes/context_course.html" onMouseOver="classPopup(event,'context_course')">context_course</a>::<a class="function" onClick="logFunction('instance')" href="../../_functions/instance.html" onMouseOver="funcPopup(event,'instance')">instance</a>(<a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>);
<a name="l2297"><span class="linenum">2297</span></a>  
<a name="l2298"><span class="linenum">2298</span></a>          if (<a class="function" onClick="logFunction('is_enrolled')" href="../../_functions/is_enrolled.html" onMouseOver="funcPopup(event,'is_enrolled')">is_enrolled</a>(<a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a>, <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>, 'moodle/course:update', true) or <a class="function" onClick="logFunction('is_viewing')" href="../../_functions/is_viewing.html" onMouseOver="funcPopup(event,'is_viewing')">is_viewing</a>(<a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a>, <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>, 'moodle/course:update')) {
<a name="l2299"><span class="linenum">2299</span></a>  <span class="comment">            // Current user may access the course (admin, category manager or restored teacher enrolment usually)</span>
<a name="l2300"><span class="linenum">2300</span></a>              return;
<a name="l2301"><span class="linenum">2301</span></a>          }
<a name="l2302"><span class="linenum">2302</span></a>  
<a name="l2303"><span class="linenum">2303</span></a>  <span class="comment">        // Try to add role only - we do not need enrolment if user has moodle/course:view or is already enrolled</span>
<a name="l2304"><span class="linenum">2304</span></a>          <a class="function" onClick="logFunction('role_assign')" href="../../_functions/role_assign.html" onMouseOver="funcPopup(event,'role_assign')">role_assign</a>(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('restorernewroleid')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/restorernewroleid.html">restorernewroleid</a>, <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>, <a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a>);
<a name="l2305"><span class="linenum">2305</span></a>  
<a name="l2306"><span class="linenum">2306</span></a>          if (<a class="function" onClick="logFunction('is_enrolled')" href="../../_functions/is_enrolled.html" onMouseOver="funcPopup(event,'is_enrolled')">is_enrolled</a>(<a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a>, <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>, 'moodle/course:update', true) or <a class="function" onClick="logFunction('is_viewing')" href="../../_functions/is_viewing.html" onMouseOver="funcPopup(event,'is_viewing')">is_viewing</a>(<a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a>, <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>, 'moodle/course:update')) {
<a name="l2307"><span class="linenum">2307</span></a>  <span class="comment">            // Extra role is enough, yay!</span>
<a name="l2308"><span class="linenum">2308</span></a>              return;
<a name="l2309"><span class="linenum">2309</span></a>          }
<a name="l2310"><span class="linenum">2310</span></a>  
<a name="l2311"><span class="linenum">2311</span></a>  <span class="comment">        // The last chance is to create manual enrol if it does not exist and and try to enrol the current user,</span>
<a name="l2312"><span class="linenum">2312</span></a>  <span class="comment">        // hopefully admin selected suitable $CFG-&gt;restorernewroleid ...</span>
<a name="l2313"><span class="linenum">2313</span></a>          if (!<a class="function" onClick="logFunction('enrol_is_enabled')" href="../../_functions/enrol_is_enabled.html" onMouseOver="funcPopup(event,'enrol_is_enabled')">enrol_is_enabled</a>('manual')) {
<a name="l2314"><span class="linenum">2314</span></a>              return;
<a name="l2315"><span class="linenum">2315</span></a>          }
<a name="l2316"><span class="linenum">2316</span></a>          if (!<a class="var it747" onMouseOver="hilite(747)" onMouseOut="lolite()" onClick="logVariable('enrol')" href="../../_variables/enrol.html">$enrol</a> = <a class="function" onClick="logFunction('enrol_get_plugin')" href="../../_functions/enrol_get_plugin.html" onMouseOver="funcPopup(event,'enrol_get_plugin')">enrol_get_plugin</a>('manual')) {
<a name="l2317"><span class="linenum">2317</span></a>              return;
<a name="l2318"><span class="linenum">2318</span></a>          }
<a name="l2319"><span class="linenum">2319</span></a>          if (!<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists')" href="../../_functions/record_exists.html" onMouseOver="funcPopup(event,'record_exists')">record_exists</a>('enrol', array('enrol'=&gt;'manual', 'courseid'=&gt;<a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>))) {
<a name="l2320"><span class="linenum">2320</span></a>              <a class="var it8" onMouseOver="hilite(8)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('course', array('id'=&gt;<a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>), '*', <a class="constant" onClick="logConstant('MUST_EXIST')" href="../../_constants/MUST_EXIST.html" onMouseOver="constPopup(event,'MUST_EXIST')">MUST_EXIST</a>);
<a name="l2321"><span class="linenum">2321</span></a>              <a class="var it89" onMouseOver="hilite(89)" onMouseOut="lolite()" onClick="logVariable('fields')" href="../../_variables/fields.html">$fields</a> = array('status'=&gt;<a class="constant" onClick="logConstant('ENROL_INSTANCE_ENABLED')" href="../../_constants/ENROL_INSTANCE_ENABLED.html" onMouseOver="constPopup(event,'ENROL_INSTANCE_ENABLED')">ENROL_INSTANCE_ENABLED</a>, 'enrolperiod'=&gt;<a class="var it747" onMouseOver="hilite(747)" onMouseOut="lolite()" onClick="logVariable('enrol')" href="../../_variables/enrol.html">$enrol</a>-&gt;<a class="function" onClick="logFunction('get_config')" href="../../_functions/get_config.html" onMouseOver="funcPopup(event,'get_config')">get_config</a>('enrolperiod', 0), 'roleid'=&gt;<a class="var it747" onMouseOver="hilite(747)" onMouseOut="lolite()" onClick="logVariable('enrol')" href="../../_variables/enrol.html">$enrol</a>-&gt;<a class="function" onClick="logFunction('get_config')" href="../../_functions/get_config.html" onMouseOver="funcPopup(event,'get_config')">get_config</a>('roleid', 0));
<a name="l2322"><span class="linenum">2322</span></a>              <a class="var it747" onMouseOver="hilite(747)" onMouseOut="lolite()" onClick="logVariable('enrol')" href="../../_variables/enrol.html">$enrol</a>-&gt;<a class="function" onClick="logFunction('add_instance')" href="../../_functions/add_instance.html" onMouseOver="funcPopup(event,'add_instance')">add_instance</a>(<a class="var it8" onMouseOver="hilite(8)" onMouseOut="lolite()" onClick="logVariable('course')" href="../../_variables/course.html">$course</a>, <a class="var it89" onMouseOver="hilite(89)" onMouseOut="lolite()" onClick="logVariable('fields')" href="../../_variables/fields.html">$fields</a>);
<a name="l2323"><span class="linenum">2323</span></a>          }
<a name="l2324"><span class="linenum">2324</span></a>  
<a name="l2325"><span class="linenum">2325</span></a>          <a class="function" onClick="logFunction('enrol_try_internal_enrol')" href="../../_functions/enrol_try_internal_enrol.html" onMouseOver="funcPopup(event,'enrol_try_internal_enrol')">enrol_try_internal_enrol</a>(<a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>, <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a>);
<a name="l2326"><span class="linenum">2326</span></a>      }
<a name="l2327"><span class="linenum">2327</span></a>  }
<a name="l2328"><span class="linenum">2328</span></a>  
<a name="l2329"><span class="linenum">2329</span></a>  
<a name="l2330"><span class="linenum">2330</span></a>  <span class="comment">/**</span>
<a name="l2331"><span class="linenum">2331</span></a>  <span class="comment"> * This structure steps restores the filters and their configs</span>
<a name="l2332"><span class="linenum">2332</span></a>  <span class="comment"> */</span>
<a name="l2333"><span class="linenum">2333</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_filters_structure_step')" href="../../_classes/restore_filters_structure_step.html" onMouseOver="classPopup(event,'restore_filters_structure_step')">restore_filters_structure_step</a> extends restore_structure_step {
<a name="l2334"><span class="linenum">2334</span></a>  
<a name="l2335"><span class="linenum">2335</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l2336"><span class="linenum">2336</span></a>  
<a name="l2337"><span class="linenum">2337</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array();
<a name="l2338"><span class="linenum">2338</span></a>  
<a name="l2339"><span class="linenum">2339</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('active', '/filters/filter_actives/filter_active');
<a name="l2340"><span class="linenum">2340</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('config', '/filters/filter_configs/filter_config');
<a name="l2341"><span class="linenum">2341</span></a>  
<a name="l2342"><span class="linenum">2342</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l2343"><span class="linenum">2343</span></a>      }
<a name="l2344"><span class="linenum">2344</span></a>  
<a name="l2345"><span class="linenum">2345</span></a>      public function <a class="function" onClick="logFunction('process_active')" href="../../_functions/process_active.html" onMouseOver="funcPopup(event,'process_active')">process_active</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l2346"><span class="linenum">2346</span></a>  
<a name="l2347"><span class="linenum">2347</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l2348"><span class="linenum">2348</span></a>  
<a name="l2349"><span class="linenum">2349</span></a>          if (<a class="phpfunction" onClick="logFunction('strpos')" href="../../_functions/strpos.html" onMouseOver="phpfuncPopup(event,'strpos')">strpos</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('filter')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/filter.html">filter</a>, 'filter/') === 0) {
<a name="l2350"><span class="linenum">2350</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('filter')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/filter.html">filter</a> = <a class="phpfunction" onClick="logFunction('substr')" href="../../_functions/substr.html" onMouseOver="phpfuncPopup(event,'substr')">substr</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('filter')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/filter.html">filter</a>, 7);
<a name="l2351"><span class="linenum">2351</span></a>  
<a name="l2352"><span class="linenum">2352</span></a>          } else if (<a class="phpfunction" onClick="logFunction('strpos')" href="../../_functions/strpos.html" onMouseOver="phpfuncPopup(event,'strpos')">strpos</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('filter')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/filter.html">filter</a>, '/') !== false) {
<a name="l2353"><span class="linenum">2353</span></a>  <span class="comment">            // Unsupported old filter.</span>
<a name="l2354"><span class="linenum">2354</span></a>              return;
<a name="l2355"><span class="linenum">2355</span></a>          }
<a name="l2356"><span class="linenum">2356</span></a>  
<a name="l2357"><span class="linenum">2357</span></a>          if (!<a class="function" onClick="logFunction('filter_is_enabled')" href="../../_functions/filter_is_enabled.html" onMouseOver="funcPopup(event,'filter_is_enabled')">filter_is_enabled</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('filter')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/filter.html">filter</a>)) { // Not installed or not enabled, nothing to do
<a name="l2358"><span class="linenum">2358</span></a>              return;
<a name="l2359"><span class="linenum">2359</span></a>          }
<a name="l2360"><span class="linenum">2360</span></a>          <a class="function" onClick="logFunction('filter_set_local_state')" href="../../_functions/filter_set_local_state.html" onMouseOver="funcPopup(event,'filter_set_local_state')">filter_set_local_state</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('filter')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/filter.html">filter</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_contextid')" href="../../_functions/get_contextid.html" onMouseOver="funcPopup(event,'get_contextid')">get_contextid</a>(), <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('active')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/active.html">active</a>);
<a name="l2361"><span class="linenum">2361</span></a>      }
<a name="l2362"><span class="linenum">2362</span></a>  
<a name="l2363"><span class="linenum">2363</span></a>      public function <a class="function" onClick="logFunction('process_config')" href="../../_functions/process_config.html" onMouseOver="funcPopup(event,'process_config')">process_config</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l2364"><span class="linenum">2364</span></a>  
<a name="l2365"><span class="linenum">2365</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l2366"><span class="linenum">2366</span></a>  
<a name="l2367"><span class="linenum">2367</span></a>          if (<a class="phpfunction" onClick="logFunction('strpos')" href="../../_functions/strpos.html" onMouseOver="phpfuncPopup(event,'strpos')">strpos</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('filter')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/filter.html">filter</a>, 'filter/') === 0) {
<a name="l2368"><span class="linenum">2368</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('filter')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/filter.html">filter</a> = <a class="phpfunction" onClick="logFunction('substr')" href="../../_functions/substr.html" onMouseOver="phpfuncPopup(event,'substr')">substr</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('filter')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/filter.html">filter</a>, 7);
<a name="l2369"><span class="linenum">2369</span></a>  
<a name="l2370"><span class="linenum">2370</span></a>          } else if (<a class="phpfunction" onClick="logFunction('strpos')" href="../../_functions/strpos.html" onMouseOver="phpfuncPopup(event,'strpos')">strpos</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('filter')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/filter.html">filter</a>, '/') !== false) {
<a name="l2371"><span class="linenum">2371</span></a>  <span class="comment">            // Unsupported old filter.</span>
<a name="l2372"><span class="linenum">2372</span></a>              return;
<a name="l2373"><span class="linenum">2373</span></a>          }
<a name="l2374"><span class="linenum">2374</span></a>  
<a name="l2375"><span class="linenum">2375</span></a>          if (!<a class="function" onClick="logFunction('filter_is_enabled')" href="../../_functions/filter_is_enabled.html" onMouseOver="funcPopup(event,'filter_is_enabled')">filter_is_enabled</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('filter')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/filter.html">filter</a>)) { // Not installed or not enabled, nothing to do
<a name="l2376"><span class="linenum">2376</span></a>              return;
<a name="l2377"><span class="linenum">2377</span></a>          }
<a name="l2378"><span class="linenum">2378</span></a>          <a class="function" onClick="logFunction('filter_set_local_config')" href="../../_functions/filter_set_local_config.html" onMouseOver="funcPopup(event,'filter_set_local_config')">filter_set_local_config</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('filter')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/filter.html">filter</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_contextid')" href="../../_functions/get_contextid.html" onMouseOver="funcPopup(event,'get_contextid')">get_contextid</a>(), <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('name')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/name.html">name</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('value')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/value.html">value</a>);
<a name="l2379"><span class="linenum">2379</span></a>      }
<a name="l2380"><span class="linenum">2380</span></a>  }
<a name="l2381"><span class="linenum">2381</span></a>  
<a name="l2382"><span class="linenum">2382</span></a>  
<a name="l2383"><span class="linenum">2383</span></a>  <span class="comment">/**</span>
<a name="l2384"><span class="linenum">2384</span></a>  <span class="comment"> * This structure steps restores the comments</span>
<a name="l2385"><span class="linenum">2385</span></a>  <span class="comment"> * Note: Cannot use the comments API because defaults to USER-&gt;id.</span>
<a name="l2386"><span class="linenum">2386</span></a>  <span class="comment"> * That should change allowing to pass $userid</span>
<a name="l2387"><span class="linenum">2387</span></a>  <span class="comment"> */</span>
<a name="l2388"><span class="linenum">2388</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_comments_structure_step')" href="../../_classes/restore_comments_structure_step.html" onMouseOver="classPopup(event,'restore_comments_structure_step')">restore_comments_structure_step</a> extends restore_structure_step {
<a name="l2389"><span class="linenum">2389</span></a>  
<a name="l2390"><span class="linenum">2390</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l2391"><span class="linenum">2391</span></a>  
<a name="l2392"><span class="linenum">2392</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array();
<a name="l2393"><span class="linenum">2393</span></a>  
<a name="l2394"><span class="linenum">2394</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('comment', '/comments/comment');
<a name="l2395"><span class="linenum">2395</span></a>  
<a name="l2396"><span class="linenum">2396</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l2397"><span class="linenum">2397</span></a>      }
<a name="l2398"><span class="linenum">2398</span></a>  
<a name="l2399"><span class="linenum">2399</span></a>      public function <a class="function" onClick="logFunction('process_comment')" href="../../_functions/process_comment.html" onMouseOver="funcPopup(event,'process_comment')">process_comment</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l2400"><span class="linenum">2400</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l2401"><span class="linenum">2401</span></a>  
<a name="l2402"><span class="linenum">2402</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l2403"><span class="linenum">2403</span></a>  
<a name="l2404"><span class="linenum">2404</span></a>  <span class="comment">        // First of all, if the comment has some itemid, ask to the task what to map</span>
<a name="l2405"><span class="linenum">2405</span></a>          <a class="var it679" onMouseOver="hilite(679)" onMouseOut="lolite()" onClick="logVariable('mapping')" href="../../_variables/mapping.html">$mapping</a> = false;
<a name="l2406"><span class="linenum">2406</span></a>          if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>) {
<a name="l2407"><span class="linenum">2407</span></a>              <a class="var it679" onMouseOver="hilite(679)" onMouseOut="lolite()" onClick="logVariable('mapping')" href="../../_variables/mapping.html">$mapping</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_comment_mapping_itemname')" href="../../_functions/get_comment_mapping_itemname.html" onMouseOver="funcPopup(event,'get_comment_mapping_itemname')">get_comment_mapping_itemname</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('commentarea')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/commentarea.html">commentarea</a>);
<a name="l2408"><span class="linenum">2408</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>(<a class="var it679" onMouseOver="hilite(679)" onMouseOut="lolite()" onClick="logVariable('mapping')" href="../../_variables/mapping.html">$mapping</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>);
<a name="l2409"><span class="linenum">2409</span></a>          }
<a name="l2410"><span class="linenum">2410</span></a>  <span class="comment">        // Only restore the comment if has no mapping OR we have found the matching mapping</span>
<a name="l2411"><span class="linenum">2411</span></a>          if (!<a class="var it679" onMouseOver="hilite(679)" onMouseOut="lolite()" onClick="logVariable('mapping')" href="../../_variables/mapping.html">$mapping</a> || <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>) {
<a name="l2412"><span class="linenum">2412</span></a>  <span class="comment">            // Only if user mapping and context</span>
<a name="l2413"><span class="linenum">2413</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>);
<a name="l2414"><span class="linenum">2414</span></a>              if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> &amp;&amp; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_contextid')" href="../../_functions/get_contextid.html" onMouseOver="funcPopup(event,'get_contextid')">get_contextid</a>()) {
<a name="l2415"><span class="linenum">2415</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('contextid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_contextid')" href="../../_functions/get_contextid.html" onMouseOver="funcPopup(event,'get_contextid')">get_contextid</a>();
<a name="l2416"><span class="linenum">2416</span></a>  <span class="comment">                // Only if there is another comment with same context/user/timecreated</span>
<a name="l2417"><span class="linenum">2417</span></a>                  <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array('contextid' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('contextid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a>, 'userid' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>, 'timecreated' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timecreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timecreated.html">timecreated</a>);
<a name="l2418"><span class="linenum">2418</span></a>                  if (!<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists')" href="../../_functions/record_exists.html" onMouseOver="funcPopup(event,'record_exists')">record_exists</a>('comments', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>)) {
<a name="l2419"><span class="linenum">2419</span></a>                      <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('comments', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l2420"><span class="linenum">2420</span></a>                  }
<a name="l2421"><span class="linenum">2421</span></a>              }
<a name="l2422"><span class="linenum">2422</span></a>          }
<a name="l2423"><span class="linenum">2423</span></a>      }
<a name="l2424"><span class="linenum">2424</span></a>  }
<a name="l2425"><span class="linenum">2425</span></a>  
<a name="l2426"><span class="linenum">2426</span></a>  <span class="comment">/**</span>
<a name="l2427"><span class="linenum">2427</span></a>  <span class="comment"> * This structure steps restores the badges and their configs</span>
<a name="l2428"><span class="linenum">2428</span></a>  <span class="comment"> */</span>
<a name="l2429"><span class="linenum">2429</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_badges_structure_step')" href="../../_classes/restore_badges_structure_step.html" onMouseOver="classPopup(event,'restore_badges_structure_step')">restore_badges_structure_step</a> extends restore_structure_step {
<a name="l2430"><span class="linenum">2430</span></a>  
<a name="l2431"><span class="linenum">2431</span></a>      <span class="comment">/**</span>
<a name="l2432"><span class="linenum">2432</span></a>  <span class="comment">     * Conditionally decide if this step should be executed.</span>
<a name="l2433"><span class="linenum">2433</span></a>  <span class="comment">     *</span>
<a name="l2434"><span class="linenum">2434</span></a>  <span class="comment">     * This function checks the following parameters:</span>
<a name="l2435"><span class="linenum">2435</span></a>  <span class="comment">     *</span>
<a name="l2436"><span class="linenum">2436</span></a>  <span class="comment">     *   1. Badges and course badges are enabled on the site.</span>
<a name="l2437"><span class="linenum">2437</span></a>  <span class="comment">     *   2. The course/badges.xml file exists.</span>
<a name="l2438"><span class="linenum">2438</span></a>  <span class="comment">     *   3. All modules are restorable.</span>
<a name="l2439"><span class="linenum">2439</span></a>  <span class="comment">     *   4. All modules are marked for restore.</span>
<a name="l2440"><span class="linenum">2440</span></a>  <span class="comment">     *</span>
<a name="l2441"><span class="linenum">2441</span></a>  <span class="comment">     * @return bool True is safe to execute, false otherwise</span>
<a name="l2442"><span class="linenum">2442</span></a>  <span class="comment">     */</span>
<a name="l2443"><span class="linenum">2443</span></a>      protected function <a class="function" onClick="logFunction('execute_condition')" href="../../_functions/execute_condition.html" onMouseOver="funcPopup(event,'execute_condition')">execute_condition</a>() {
<a name="l2444"><span class="linenum">2444</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>;
<a name="l2445"><span class="linenum">2445</span></a>  
<a name="l2446"><span class="linenum">2446</span></a>  <span class="comment">        // First check is badges and course level badges are enabled on this site.</span>
<a name="l2447"><span class="linenum">2447</span></a>          if (empty(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('enablebadges')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/enablebadges.html">enablebadges</a>) || empty(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('badges_allowcoursebadges')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/badges_allowcoursebadges.html">badges_allowcoursebadges</a>)) {
<a name="l2448"><span class="linenum">2448</span></a>  <span class="comment">            // Disabled, don't restore course badges.</span>
<a name="l2449"><span class="linenum">2449</span></a>              return false;
<a name="l2450"><span class="linenum">2450</span></a>          }
<a name="l2451"><span class="linenum">2451</span></a>  
<a name="l2452"><span class="linenum">2452</span></a>  <span class="comment">        // Check if badges.xml is included in the backup.</span>
<a name="l2453"><span class="linenum">2453</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_taskbasepath')" href="../../_functions/get_taskbasepath.html" onMouseOver="funcPopup(event,'get_taskbasepath')">get_taskbasepath</a>();
<a name="l2454"><span class="linenum">2454</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="phpfunction" onClick="logFunction('rtrim')" href="../../_functions/rtrim.html" onMouseOver="phpfuncPopup(event,'rtrim')">rtrim</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>, '/') . '/' . <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('filename')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/filename.html">filename</a>;
<a name="l2455"><span class="linenum">2455</span></a>          if (!<a class="phpfunction" onClick="logFunction('file_exists')" href="../../_functions/file_exists.html" onMouseOver="phpfuncPopup(event,'file_exists')">file_exists</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>)) {
<a name="l2456"><span class="linenum">2456</span></a>  <span class="comment">            // Not found, can't restore course badges.</span>
<a name="l2457"><span class="linenum">2457</span></a>              return false;
<a name="l2458"><span class="linenum">2458</span></a>          }
<a name="l2459"><span class="linenum">2459</span></a>  
<a name="l2460"><span class="linenum">2460</span></a>  <span class="comment">        // Check we are able to restore all backed up modules.</span>
<a name="l2461"><span class="linenum">2461</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('is_missing_modules')" href="../../_functions/is_missing_modules.html" onMouseOver="funcPopup(event,'is_missing_modules')">is_missing_modules</a>()) {
<a name="l2462"><span class="linenum">2462</span></a>              return false;
<a name="l2463"><span class="linenum">2463</span></a>          }
<a name="l2464"><span class="linenum">2464</span></a>  
<a name="l2465"><span class="linenum">2465</span></a>  <span class="comment">        // Finally check all modules within the backup are being restored.</span>
<a name="l2466"><span class="linenum">2466</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('is_excluding_activities')" href="../../_functions/is_excluding_activities.html" onMouseOver="funcPopup(event,'is_excluding_activities')">is_excluding_activities</a>()) {
<a name="l2467"><span class="linenum">2467</span></a>              return false;
<a name="l2468"><span class="linenum">2468</span></a>          }
<a name="l2469"><span class="linenum">2469</span></a>  
<a name="l2470"><span class="linenum">2470</span></a>          return true;
<a name="l2471"><span class="linenum">2471</span></a>      }
<a name="l2472"><span class="linenum">2472</span></a>  
<a name="l2473"><span class="linenum">2473</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l2474"><span class="linenum">2474</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array();
<a name="l2475"><span class="linenum">2475</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('badge', '/badges/badge');
<a name="l2476"><span class="linenum">2476</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('criterion', '/badges/badge/criteria/criterion');
<a name="l2477"><span class="linenum">2477</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('parameter', '/badges/badge/criteria/criterion/parameters/parameter');
<a name="l2478"><span class="linenum">2478</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('manual_award', '/badges/badge/manual_awards/manual_award');
<a name="l2479"><span class="linenum">2479</span></a>  
<a name="l2480"><span class="linenum">2480</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l2481"><span class="linenum">2481</span></a>      }
<a name="l2482"><span class="linenum">2482</span></a>  
<a name="l2483"><span class="linenum">2483</span></a>      public function <a class="function" onClick="logFunction('process_badge')" href="../../_functions/process_badge.html" onMouseOver="funcPopup(event,'process_badge')">process_badge</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l2484"><span class="linenum">2484</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>, <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>;
<a name="l2485"><span class="linenum">2485</span></a>  
<a name="l2486"><span class="linenum">2486</span></a>          require_once(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('libdir')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/libdir.html">libdir</a> . '/badgeslib.php');
<a name="l2487"><span class="linenum">2487</span></a>  
<a name="l2488"><span class="linenum">2488</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l2489"><span class="linenum">2489</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usercreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usercreated.html">usercreated</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usercreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usercreated.html">usercreated</a>);
<a name="l2490"><span class="linenum">2490</span></a>          if (empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usercreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usercreated.html">usercreated</a>)) {
<a name="l2491"><span class="linenum">2491</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usercreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usercreated.html">usercreated</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>();
<a name="l2492"><span class="linenum">2492</span></a>          }
<a name="l2493"><span class="linenum">2493</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usermodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usermodified.html">usermodified</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usermodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usermodified.html">usermodified</a>);
<a name="l2494"><span class="linenum">2494</span></a>          if (empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usermodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usermodified.html">usermodified</a>)) {
<a name="l2495"><span class="linenum">2495</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usermodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usermodified.html">usermodified</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>();
<a name="l2496"><span class="linenum">2496</span></a>          }
<a name="l2497"><span class="linenum">2497</span></a>  
<a name="l2498"><span class="linenum">2498</span></a>  <span class="comment">        // We'll restore the badge image.</span>
<a name="l2499"><span class="linenum">2499</span></a>          <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a> = true;
<a name="l2500"><span class="linenum">2500</span></a>  
<a name="l2501"><span class="linenum">2501</span></a>          <a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l2502"><span class="linenum">2502</span></a>  
<a name="l2503"><span class="linenum">2503</span></a>          <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array(
<a name="l2504"><span class="linenum">2504</span></a>                  'name'           =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('name')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/name.html">name</a>,
<a name="l2505"><span class="linenum">2505</span></a>                  'description'    =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('description')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/description.html">description</a>,
<a name="l2506"><span class="linenum">2506</span></a>                  'timecreated'    =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timecreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timecreated.html">timecreated</a>),
<a name="l2507"><span class="linenum">2507</span></a>                  'timemodified'   =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timemodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timemodified.html">timemodified</a>),
<a name="l2508"><span class="linenum">2508</span></a>                  'usercreated'    =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usercreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usercreated.html">usercreated</a>,
<a name="l2509"><span class="linenum">2509</span></a>                  'usermodified'   =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usermodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usermodified.html">usermodified</a>,
<a name="l2510"><span class="linenum">2510</span></a>                  'issuername'     =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('issuername')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/issuername.html">issuername</a>,
<a name="l2511"><span class="linenum">2511</span></a>                  'issuerurl'      =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('issuerurl')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/issuerurl.html">issuerurl</a>,
<a name="l2512"><span class="linenum">2512</span></a>                  'issuercontact'  =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('issuercontact')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/issuercontact.html">issuercontact</a>,
<a name="l2513"><span class="linenum">2513</span></a>                  'expiredate'     =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('expiredate')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/expiredate.html">expiredate</a>),
<a name="l2514"><span class="linenum">2514</span></a>                  'expireperiod'   =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('expireperiod')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/expireperiod.html">expireperiod</a>,
<a name="l2515"><span class="linenum">2515</span></a>                  'type'           =&gt; <a class="constant" onClick="logConstant('BADGE_TYPE_COURSE')" href="../../_constants/BADGE_TYPE_COURSE.html" onMouseOver="constPopup(event,'BADGE_TYPE_COURSE')">BADGE_TYPE_COURSE</a>,
<a name="l2516"><span class="linenum">2516</span></a>                  'courseid'       =&gt; <a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>,
<a name="l2517"><span class="linenum">2517</span></a>                  'message'        =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('message')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/message.html">message</a>,
<a name="l2518"><span class="linenum">2518</span></a>                  'messagesubject' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('messagesubject')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/messagesubject.html">messagesubject</a>,
<a name="l2519"><span class="linenum">2519</span></a>                  'attachment'     =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('attachment')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/attachment.html">attachment</a>,
<a name="l2520"><span class="linenum">2520</span></a>                  'notification'   =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('notification')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/notification.html">notification</a>,
<a name="l2521"><span class="linenum">2521</span></a>                  'status'         =&gt; <a class="constant" onClick="logConstant('BADGE_STATUS_INACTIVE')" href="../../_constants/BADGE_STATUS_INACTIVE.html" onMouseOver="constPopup(event,'BADGE_STATUS_INACTIVE')">BADGE_STATUS_INACTIVE</a>,
<a name="l2522"><span class="linenum">2522</span></a>                  'nextcron'       =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('nextcron')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/nextcron.html">nextcron</a>)
<a name="l2523"><span class="linenum">2523</span></a>          );
<a name="l2524"><span class="linenum">2524</span></a>  
<a name="l2525"><span class="linenum">2525</span></a>          <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('badge', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l2526"><span class="linenum">2526</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('badge', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a>, <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a>);
<a name="l2527"><span class="linenum">2527</span></a>      }
<a name="l2528"><span class="linenum">2528</span></a>  
<a name="l2529"><span class="linenum">2529</span></a>      public function <a class="function" onClick="logFunction('process_criterion')" href="../../_functions/process_criterion.html" onMouseOver="funcPopup(event,'process_criterion')">process_criterion</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l2530"><span class="linenum">2530</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l2531"><span class="linenum">2531</span></a>  
<a name="l2532"><span class="linenum">2532</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l2533"><span class="linenum">2533</span></a>  
<a name="l2534"><span class="linenum">2534</span></a>          <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array(
<a name="l2535"><span class="linenum">2535</span></a>                  'badgeid'           =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_new_parentid')" href="../../_functions/get_new_parentid.html" onMouseOver="funcPopup(event,'get_new_parentid')">get_new_parentid</a>('badge'),
<a name="l2536"><span class="linenum">2536</span></a>                  'criteriatype'      =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('criteriatype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/criteriatype.html">criteriatype</a>,
<a name="l2537"><span class="linenum">2537</span></a>                  'method'            =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('method')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/method.html">method</a>,
<a name="l2538"><span class="linenum">2538</span></a>                  'description'       =&gt; isset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('description')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/description.html">description</a>) ? <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('description')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/description.html">description</a> : '',
<a name="l2539"><span class="linenum">2539</span></a>                  'descriptionformat' =&gt; isset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('descriptionformat')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/descriptionformat.html">descriptionformat</a>) ? <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('descriptionformat')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/descriptionformat.html">descriptionformat</a> : 0,
<a name="l2540"><span class="linenum">2540</span></a>          );
<a name="l2541"><span class="linenum">2541</span></a>          <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('badge_criteria', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l2542"><span class="linenum">2542</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('criterion', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a>);
<a name="l2543"><span class="linenum">2543</span></a>      }
<a name="l2544"><span class="linenum">2544</span></a>  
<a name="l2545"><span class="linenum">2545</span></a>      public function <a class="function" onClick="logFunction('process_parameter')" href="../../_functions/process_parameter.html" onMouseOver="funcPopup(event,'process_parameter')">process_parameter</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l2546"><span class="linenum">2546</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>, <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>;
<a name="l2547"><span class="linenum">2547</span></a>  
<a name="l2548"><span class="linenum">2548</span></a>          require_once(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('libdir')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/libdir.html">libdir</a> . '/badgeslib.php');
<a name="l2549"><span class="linenum">2549</span></a>  
<a name="l2550"><span class="linenum">2550</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l2551"><span class="linenum">2551</span></a>          <a class="var it15418" onMouseOver="hilite(15418)" onMouseOut="lolite()" onClick="logVariable('criteriaid')" href="../../_variables/criteriaid.html">$criteriaid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_new_parentid')" href="../../_functions/get_new_parentid.html" onMouseOver="funcPopup(event,'get_new_parentid')">get_new_parentid</a>('criterion');
<a name="l2552"><span class="linenum">2552</span></a>  
<a name="l2553"><span class="linenum">2553</span></a>  <span class="comment">        // Parameter array that will go to database.</span>
<a name="l2554"><span class="linenum">2554</span></a>          <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array();
<a name="l2555"><span class="linenum">2555</span></a>          <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['critid'] = <a class="var it15418" onMouseOver="hilite(15418)" onMouseOut="lolite()" onClick="logVariable('criteriaid')" href="../../_variables/criteriaid.html">$criteriaid</a>;
<a name="l2556"><span class="linenum">2556</span></a>  
<a name="l2557"><span class="linenum">2557</span></a>          <a class="var it15419" onMouseOver="hilite(15419)" onMouseOut="lolite()" onClick="logVariable('oldparam')" href="../../_variables/oldparam.html">$oldparam</a> = <a class="phpfunction" onClick="logFunction('explode')" href="../../_functions/explode.html" onMouseOver="phpfuncPopup(event,'explode')">explode</a>('_', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('name')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/name.html">name</a>);
<a name="l2558"><span class="linenum">2558</span></a>  
<a name="l2559"><span class="linenum">2559</span></a>          if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('criteriatype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/criteriatype.html">criteriatype</a> == <a class="constant" onClick="logConstant('BADGE_CRITERIA_TYPE_ACTIVITY')" href="../../_constants/BADGE_CRITERIA_TYPE_ACTIVITY.html" onMouseOver="constPopup(event,'BADGE_CRITERIA_TYPE_ACTIVITY')">BADGE_CRITERIA_TYPE_ACTIVITY</a>) {
<a name="l2560"><span class="linenum">2560</span></a>              <a class="var it994" onMouseOver="hilite(994)" onMouseOut="lolite()" onClick="logVariable('module')" href="../../_variables/module.html">$module</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('course_module', <a class="var it15419" onMouseOver="hilite(15419)" onMouseOut="lolite()" onClick="logVariable('oldparam')" href="../../_variables/oldparam.html">$oldparam</a>[1]);
<a name="l2561"><span class="linenum">2561</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['name'] = <a class="var it15419" onMouseOver="hilite(15419)" onMouseOut="lolite()" onClick="logVariable('oldparam')" href="../../_variables/oldparam.html">$oldparam</a>[0] . '_' . <a class="var it994" onMouseOver="hilite(994)" onMouseOut="lolite()" onClick="logVariable('module')" href="../../_variables/module.html">$module</a>;
<a name="l2562"><span class="linenum">2562</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['value'] = <a class="var it15419" onMouseOver="hilite(15419)" onMouseOut="lolite()" onClick="logVariable('oldparam')" href="../../_variables/oldparam.html">$oldparam</a>[0] == 'module' ? <a class="var it994" onMouseOver="hilite(994)" onMouseOut="lolite()" onClick="logVariable('module')" href="../../_variables/module.html">$module</a> : <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('value')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/value.html">value</a>;
<a name="l2563"><span class="linenum">2563</span></a>          } else if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('criteriatype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/criteriatype.html">criteriatype</a> == <a class="constant" onClick="logConstant('BADGE_CRITERIA_TYPE_COURSE')" href="../../_constants/BADGE_CRITERIA_TYPE_COURSE.html" onMouseOver="constPopup(event,'BADGE_CRITERIA_TYPE_COURSE')">BADGE_CRITERIA_TYPE_COURSE</a>) {
<a name="l2564"><span class="linenum">2564</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['name'] = <a class="var it15419" onMouseOver="hilite(15419)" onMouseOut="lolite()" onClick="logVariable('oldparam')" href="../../_variables/oldparam.html">$oldparam</a>[0] . '_' . <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l2565"><span class="linenum">2565</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['value'] = <a class="var it15419" onMouseOver="hilite(15419)" onMouseOut="lolite()" onClick="logVariable('oldparam')" href="../../_variables/oldparam.html">$oldparam</a>[0] == 'course' ? <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>() : <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('value')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/value.html">value</a>;
<a name="l2566"><span class="linenum">2566</span></a>          } else if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('criteriatype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/criteriatype.html">criteriatype</a> == <a class="constant" onClick="logConstant('BADGE_CRITERIA_TYPE_MANUAL')" href="../../_constants/BADGE_CRITERIA_TYPE_MANUAL.html" onMouseOver="constPopup(event,'BADGE_CRITERIA_TYPE_MANUAL')">BADGE_CRITERIA_TYPE_MANUAL</a>) {
<a name="l2567"><span class="linenum">2567</span></a>              <a class="var it573" onMouseOver="hilite(573)" onMouseOut="lolite()" onClick="logVariable('role')" href="../../_variables/role.html">$role</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('role', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('value')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/value.html">value</a>);
<a name="l2568"><span class="linenum">2568</span></a>              if (!empty(<a class="var it573" onMouseOver="hilite(573)" onMouseOut="lolite()" onClick="logVariable('role')" href="../../_variables/role.html">$role</a>)) {
<a name="l2569"><span class="linenum">2569</span></a>                  <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['name'] = 'role_' . <a class="var it573" onMouseOver="hilite(573)" onMouseOut="lolite()" onClick="logVariable('role')" href="../../_variables/role.html">$role</a>;
<a name="l2570"><span class="linenum">2570</span></a>                  <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['value'] = <a class="var it573" onMouseOver="hilite(573)" onMouseOut="lolite()" onClick="logVariable('role')" href="../../_variables/role.html">$role</a>;
<a name="l2571"><span class="linenum">2571</span></a>              } else {
<a name="l2572"><span class="linenum">2572</span></a>                  return;
<a name="l2573"><span class="linenum">2573</span></a>              }
<a name="l2574"><span class="linenum">2574</span></a>          }
<a name="l2575"><span class="linenum">2575</span></a>  
<a name="l2576"><span class="linenum">2576</span></a>          if (!<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists')" href="../../_functions/record_exists.html" onMouseOver="funcPopup(event,'record_exists')">record_exists</a>('badge_criteria_param', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>)) {
<a name="l2577"><span class="linenum">2577</span></a>              <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('badge_criteria_param', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l2578"><span class="linenum">2578</span></a>          }
<a name="l2579"><span class="linenum">2579</span></a>      }
<a name="l2580"><span class="linenum">2580</span></a>  
<a name="l2581"><span class="linenum">2581</span></a>      public function <a class="function" onClick="logFunction('process_manual_award')" href="../../_functions/process_manual_award.html" onMouseOver="funcPopup(event,'process_manual_award')">process_manual_award</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l2582"><span class="linenum">2582</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l2583"><span class="linenum">2583</span></a>  
<a name="l2584"><span class="linenum">2584</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l2585"><span class="linenum">2585</span></a>          <a class="var it573" onMouseOver="hilite(573)" onMouseOut="lolite()" onClick="logVariable('role')" href="../../_variables/role.html">$role</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('role', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('issuerrole')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/issuerrole.html">issuerrole</a>);
<a name="l2586"><span class="linenum">2586</span></a>  
<a name="l2587"><span class="linenum">2587</span></a>          if (!empty(<a class="var it573" onMouseOver="hilite(573)" onMouseOut="lolite()" onClick="logVariable('role')" href="../../_variables/role.html">$role</a>)) {
<a name="l2588"><span class="linenum">2588</span></a>              <a class="var it12461" onMouseOver="hilite(12461)" onMouseOut="lolite()" onClick="logVariable('award')" href="../../_variables/award.html">$award</a> = array(
<a name="l2589"><span class="linenum">2589</span></a>                  'badgeid'     =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_new_parentid')" href="../../_functions/get_new_parentid.html" onMouseOver="funcPopup(event,'get_new_parentid')">get_new_parentid</a>('badge'),
<a name="l2590"><span class="linenum">2590</span></a>                  'recipientid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('recipientid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/recipientid.html">recipientid</a>),
<a name="l2591"><span class="linenum">2591</span></a>                  'issuerid'    =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('issuerid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/issuerid.html">issuerid</a>),
<a name="l2592"><span class="linenum">2592</span></a>                  'issuerrole'  =&gt; <a class="var it573" onMouseOver="hilite(573)" onMouseOut="lolite()" onClick="logVariable('role')" href="../../_variables/role.html">$role</a>,
<a name="l2593"><span class="linenum">2593</span></a>                  'datemet'     =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('datemet')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/datemet.html">datemet</a>)
<a name="l2594"><span class="linenum">2594</span></a>              );
<a name="l2595"><span class="linenum">2595</span></a>  
<a name="l2596"><span class="linenum">2596</span></a>  <span class="comment">            // Skip the manual award if recipient or issuer can not be mapped to.</span>
<a name="l2597"><span class="linenum">2597</span></a>              if (empty(<a class="var it12461" onMouseOver="hilite(12461)" onMouseOut="lolite()" onClick="logVariable('award')" href="../../_variables/award.html">$award</a>['recipientid']) || empty(<a class="var it12461" onMouseOver="hilite(12461)" onMouseOut="lolite()" onClick="logVariable('award')" href="../../_variables/award.html">$award</a>['issuerid'])) {
<a name="l2598"><span class="linenum">2598</span></a>                  return;
<a name="l2599"><span class="linenum">2599</span></a>              }
<a name="l2600"><span class="linenum">2600</span></a>  
<a name="l2601"><span class="linenum">2601</span></a>              <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('badge_manual_award', <a class="var it12461" onMouseOver="hilite(12461)" onMouseOut="lolite()" onClick="logVariable('award')" href="../../_variables/award.html">$award</a>);
<a name="l2602"><span class="linenum">2602</span></a>          }
<a name="l2603"><span class="linenum">2603</span></a>      }
<a name="l2604"><span class="linenum">2604</span></a>  
<a name="l2605"><span class="linenum">2605</span></a>      protected function <a class="function" onClick="logFunction('after_execute')" href="../../_functions/after_execute.html" onMouseOver="funcPopup(event,'after_execute')">after_execute</a>() {
<a name="l2606"><span class="linenum">2606</span></a>  <span class="comment">        // Add related files.</span>
<a name="l2607"><span class="linenum">2607</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_related_files')" href="../../_functions/add_related_files.html" onMouseOver="funcPopup(event,'add_related_files')">add_related_files</a>('badges', 'badgeimage', 'badge');
<a name="l2608"><span class="linenum">2608</span></a>      }
<a name="l2609"><span class="linenum">2609</span></a>  }
<a name="l2610"><span class="linenum">2610</span></a>  
<a name="l2611"><span class="linenum">2611</span></a>  <span class="comment">/**</span>
<a name="l2612"><span class="linenum">2612</span></a>  <span class="comment"> * This structure steps restores the calendar events</span>
<a name="l2613"><span class="linenum">2613</span></a>  <span class="comment"> */</span>
<a name="l2614"><span class="linenum">2614</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_calendarevents_structure_step')" href="../../_classes/restore_calendarevents_structure_step.html" onMouseOver="classPopup(event,'restore_calendarevents_structure_step')">restore_calendarevents_structure_step</a> extends restore_structure_step {
<a name="l2615"><span class="linenum">2615</span></a>  
<a name="l2616"><span class="linenum">2616</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l2617"><span class="linenum">2617</span></a>  
<a name="l2618"><span class="linenum">2618</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array();
<a name="l2619"><span class="linenum">2619</span></a>  
<a name="l2620"><span class="linenum">2620</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('calendarevents', '/events/event');
<a name="l2621"><span class="linenum">2621</span></a>  
<a name="l2622"><span class="linenum">2622</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l2623"><span class="linenum">2623</span></a>      }
<a name="l2624"><span class="linenum">2624</span></a>  
<a name="l2625"><span class="linenum">2625</span></a>      public function <a class="function" onClick="logFunction('process_calendarevents')" href="../../_functions/process_calendarevents.html" onMouseOver="funcPopup(event,'process_calendarevents')">process_calendarevents</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l2626"><span class="linenum">2626</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>, <a class="var it940" onMouseOver="hilite(940)" onMouseOut="lolite()" onClick="logVariable('SITE')" href="../../_variables/SITE.html">$SITE</a>, <a class="var it354" onMouseOver="hilite(354)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>;
<a name="l2627"><span class="linenum">2627</span></a>  
<a name="l2628"><span class="linenum">2628</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l2629"><span class="linenum">2629</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l2630"><span class="linenum">2630</span></a>          <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a> = true; <span class="comment">// We'll restore the files</span>
<a name="l2631"><span class="linenum">2631</span></a>  <span class="comment">        // Find the userid and the groupid associated with the event.</span>
<a name="l2632"><span class="linenum">2632</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>);
<a name="l2633"><span class="linenum">2633</span></a>          if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> === false) {
<a name="l2634"><span class="linenum">2634</span></a>  <span class="comment">            // Blank user ID means that we are dealing with module generated events such as quiz starting times.</span>
<a name="l2635"><span class="linenum">2635</span></a>  <span class="comment">            // Use the current user ID for these events.</span>
<a name="l2636"><span class="linenum">2636</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> = <a class="var it354" onMouseOver="hilite(354)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>-&gt;<a onClick="logVariable('id')" class="var it42989" onMouseOver="hilite(42989)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l2637"><span class="linenum">2637</span></a>          }
<a name="l2638"><span class="linenum">2638</span></a>          if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('groupid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/groupid.html">groupid</a>)) {
<a name="l2639"><span class="linenum">2639</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('groupid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/groupid.html">groupid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('group', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('groupid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/groupid.html">groupid</a>);
<a name="l2640"><span class="linenum">2640</span></a>              if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('groupid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/groupid.html">groupid</a> === false) {
<a name="l2641"><span class="linenum">2641</span></a>                  return;
<a name="l2642"><span class="linenum">2642</span></a>              }
<a name="l2643"><span class="linenum">2643</span></a>          }
<a name="l2644"><span class="linenum">2644</span></a>  <span class="comment">        // Handle events with empty eventtype //MDL-32827</span>
<a name="l2645"><span class="linenum">2645</span></a>          if(empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('eventtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/eventtype.html">eventtype</a>)) {
<a name="l2646"><span class="linenum">2646</span></a>              if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a> == <a class="var it940" onMouseOver="hilite(940)" onMouseOut="lolite()" onClick="logVariable('SITE')" href="../../_variables/SITE.html">$SITE</a>-&gt;<a onClick="logVariable('id')" class="var it43008" onMouseOver="hilite(43008)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>) {                                // Site event
<a name="l2647"><span class="linenum">2647</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('eventtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/eventtype.html">eventtype</a> = &quot;site&quot;;
<a name="l2648"><span class="linenum">2648</span></a>              } else if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a> != 0 &amp;&amp; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('groupid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/groupid.html">groupid</a> == 0 &amp;&amp; (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('modulename')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/modulename.html">modulename</a> == 'assignment' || <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('modulename')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/modulename.html">modulename</a> == 'assign')) {
<a name="l2649"><span class="linenum">2649</span></a>  <span class="comment">                // Course assingment event</span>
<a name="l2650"><span class="linenum">2650</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('eventtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/eventtype.html">eventtype</a> = &quot;due&quot;;
<a name="l2651"><span class="linenum">2651</span></a>              } else if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a> != 0 &amp;&amp; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('groupid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/groupid.html">groupid</a> == 0) {      // Course event
<a name="l2652"><span class="linenum">2652</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('eventtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/eventtype.html">eventtype</a> = &quot;course&quot;;
<a name="l2653"><span class="linenum">2653</span></a>              } else if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('groupid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/groupid.html">groupid</a>) {                                      // Group event
<a name="l2654"><span class="linenum">2654</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('eventtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/eventtype.html">eventtype</a> = &quot;group&quot;;
<a name="l2655"><span class="linenum">2655</span></a>              } else if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>) {                                       // User event
<a name="l2656"><span class="linenum">2656</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('eventtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/eventtype.html">eventtype</a> = &quot;user&quot;;
<a name="l2657"><span class="linenum">2657</span></a>              } else {
<a name="l2658"><span class="linenum">2658</span></a>                  return;
<a name="l2659"><span class="linenum">2659</span></a>              }
<a name="l2660"><span class="linenum">2660</span></a>          }
<a name="l2661"><span class="linenum">2661</span></a>  
<a name="l2662"><span class="linenum">2662</span></a>          <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array(
<a name="l2663"><span class="linenum">2663</span></a>                  'name'           =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('name')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/name.html">name</a>,
<a name="l2664"><span class="linenum">2664</span></a>                  'description'    =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('description')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/description.html">description</a>,
<a name="l2665"><span class="linenum">2665</span></a>                  'format'         =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('format')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/format.html">format</a>,
<a name="l2666"><span class="linenum">2666</span></a>                  'courseid'       =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(),
<a name="l2667"><span class="linenum">2667</span></a>                  'groupid'        =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('groupid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/groupid.html">groupid</a>,
<a name="l2668"><span class="linenum">2668</span></a>                  'userid'         =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>,
<a name="l2669"><span class="linenum">2669</span></a>                  'repeatid'       =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('repeatid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/repeatid.html">repeatid</a>,
<a name="l2670"><span class="linenum">2670</span></a>                  'modulename'     =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('modulename')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/modulename.html">modulename</a>,
<a name="l2671"><span class="linenum">2671</span></a>                  'eventtype'      =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('eventtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/eventtype.html">eventtype</a>,
<a name="l2672"><span class="linenum">2672</span></a>                  'timestart'      =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timestart')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timestart.html">timestart</a>),
<a name="l2673"><span class="linenum">2673</span></a>                  'timeduration'   =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timeduration')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timeduration.html">timeduration</a>,
<a name="l2674"><span class="linenum">2674</span></a>                  'visible'        =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('visible')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/visible.html">visible</a>,
<a name="l2675"><span class="linenum">2675</span></a>                  'uuid'           =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('uuid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/uuid.html">uuid</a>,
<a name="l2676"><span class="linenum">2676</span></a>                  'sequence'       =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('sequence')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/sequence.html">sequence</a>,
<a name="l2677"><span class="linenum">2677</span></a>                  'timemodified'    =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timemodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timemodified.html">timemodified</a>));
<a name="l2678"><span class="linenum">2678</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('name')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/name.html">name</a> == 'activity_calendar') {
<a name="l2679"><span class="linenum">2679</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['instance'] = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_activityid')" href="../../_functions/get_activityid.html" onMouseOver="funcPopup(event,'get_activityid')">get_activityid</a>();
<a name="l2680"><span class="linenum">2680</span></a>          } else {
<a name="l2681"><span class="linenum">2681</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['instance'] = 0;
<a name="l2682"><span class="linenum">2682</span></a>          }
<a name="l2683"><span class="linenum">2683</span></a>          <a class="var it64" onMouseOver="hilite(64)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a> = &quot;SELECT id
<a name="l2684"><span class="linenum">2684</span></a>                    FROM {event}
<a name="l2685"><span class="linenum">2685</span></a>                   WHERE &quot; . <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_compare_text')" href="../../_functions/sql_compare_text.html" onMouseOver="funcPopup(event,'sql_compare_text')">sql_compare_text</a>('name', 255) . &quot; = &quot; . <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_compare_text')" href="../../_functions/sql_compare_text.html" onMouseOver="funcPopup(event,'sql_compare_text')">sql_compare_text</a>('?', 255) . &quot;
<a name="l2686"><span class="linenum">2686</span></a>                     AND courseid = ?
<a name="l2687"><span class="linenum">2687</span></a>                     AND repeatid = ?
<a name="l2688"><span class="linenum">2688</span></a>                     AND modulename = ?
<a name="l2689"><span class="linenum">2689</span></a>                     AND timestart = ?
<a name="l2690"><span class="linenum">2690</span></a>                     AND timeduration = ?
<a name="l2691"><span class="linenum">2691</span></a>                     AND &quot; . <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_compare_text')" href="../../_functions/sql_compare_text.html" onMouseOver="funcPopup(event,'sql_compare_text')">sql_compare_text</a>('description', 255) . &quot; = &quot; . <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_compare_text')" href="../../_functions/sql_compare_text.html" onMouseOver="funcPopup(event,'sql_compare_text')">sql_compare_text</a>('?', 255);
<a name="l2692"><span class="linenum">2692</span></a>          <a class="var it332" onMouseOver="hilite(332)" onMouseOut="lolite()" onClick="logVariable('arg')" href="../../_variables/arg.html">$arg</a> = array (<a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['name'], <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['courseid'], <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['repeatid'], <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['modulename'], <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['timestart'], <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['timeduration'], <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['description']);
<a name="l2693"><span class="linenum">2693</span></a>          <a class="var it157" onMouseOver="hilite(157)" onMouseOut="lolite()" onClick="logVariable('result')" href="../../_variables/result.html">$result</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists_sql')" href="../../_functions/record_exists_sql.html" onMouseOver="funcPopup(event,'record_exists_sql')">record_exists_sql</a>(<a class="var it64" onMouseOver="hilite(64)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a>, <a class="var it332" onMouseOver="hilite(332)" onMouseOut="lolite()" onClick="logVariable('arg')" href="../../_variables/arg.html">$arg</a>);
<a name="l2694"><span class="linenum">2694</span></a>          if (empty(<a class="var it157" onMouseOver="hilite(157)" onMouseOut="lolite()" onClick="logVariable('result')" href="../../_variables/result.html">$result</a>)) {
<a name="l2695"><span class="linenum">2695</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('event', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l2696"><span class="linenum">2696</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('event', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>);
<a name="l2697"><span class="linenum">2697</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('event_description', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>, <a class="var it15381" onMouseOver="hilite(15381)" onMouseOut="lolite()" onClick="logVariable('restorefiles')" href="../../_variables/restorefiles.html">$restorefiles</a>);
<a name="l2698"><span class="linenum">2698</span></a>          }
<a name="l2699"><span class="linenum">2699</span></a>  
<a name="l2700"><span class="linenum">2700</span></a>      }
<a name="l2701"><span class="linenum">2701</span></a>      protected function <a class="function" onClick="logFunction('after_execute')" href="../../_functions/after_execute.html" onMouseOver="funcPopup(event,'after_execute')">after_execute</a>() {
<a name="l2702"><span class="linenum">2702</span></a>  <span class="comment">        // Add related files</span>
<a name="l2703"><span class="linenum">2703</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_related_files')" href="../../_functions/add_related_files.html" onMouseOver="funcPopup(event,'add_related_files')">add_related_files</a>('calendar', 'event_description', 'event_description');
<a name="l2704"><span class="linenum">2704</span></a>      }
<a name="l2705"><span class="linenum">2705</span></a>  }
<a name="l2706"><span class="linenum">2706</span></a>  
<a name="l2707"><span class="linenum">2707</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_course_completion_structure_step')" href="../../_classes/restore_course_completion_structure_step.html" onMouseOver="classPopup(event,'restore_course_completion_structure_step')">restore_course_completion_structure_step</a> extends restore_structure_step {
<a name="l2708"><span class="linenum">2708</span></a>  
<a name="l2709"><span class="linenum">2709</span></a>      <span class="comment">/**</span>
<a name="l2710"><span class="linenum">2710</span></a>  <span class="comment">     * Conditionally decide if this step should be executed.</span>
<a name="l2711"><span class="linenum">2711</span></a>  <span class="comment">     *</span>
<a name="l2712"><span class="linenum">2712</span></a>  <span class="comment">     * This function checks parameters that are not immediate settings to ensure</span>
<a name="l2713"><span class="linenum">2713</span></a>  <span class="comment">     * that the enviroment is suitable for the restore of course completion info.</span>
<a name="l2714"><span class="linenum">2714</span></a>  <span class="comment">     *</span>
<a name="l2715"><span class="linenum">2715</span></a>  <span class="comment">     * This function checks the following four parameters:</span>
<a name="l2716"><span class="linenum">2716</span></a>  <span class="comment">     *</span>
<a name="l2717"><span class="linenum">2717</span></a>  <span class="comment">     *   1. Course completion is enabled on the site</span>
<a name="l2718"><span class="linenum">2718</span></a>  <span class="comment">     *   2. The backup includes course completion information</span>
<a name="l2719"><span class="linenum">2719</span></a>  <span class="comment">     *   3. All modules are restorable</span>
<a name="l2720"><span class="linenum">2720</span></a>  <span class="comment">     *   4. All modules are marked for restore.</span>
<a name="l2721"><span class="linenum">2721</span></a>  <span class="comment">     *   5. No completion criteria already exist for the course.</span>
<a name="l2722"><span class="linenum">2722</span></a>  <span class="comment">     *</span>
<a name="l2723"><span class="linenum">2723</span></a>  <span class="comment">     * @return bool True is safe to execute, false otherwise</span>
<a name="l2724"><span class="linenum">2724</span></a>  <span class="comment">     */</span>
<a name="l2725"><span class="linenum">2725</span></a>      protected function <a class="function" onClick="logFunction('execute_condition')" href="../../_functions/execute_condition.html" onMouseOver="funcPopup(event,'execute_condition')">execute_condition</a>() {
<a name="l2726"><span class="linenum">2726</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l2727"><span class="linenum">2727</span></a>  
<a name="l2728"><span class="linenum">2728</span></a>  <span class="comment">        // First check course completion is enabled on this site</span>
<a name="l2729"><span class="linenum">2729</span></a>          if (empty(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('enablecompletion')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/enablecompletion.html">enablecompletion</a>)) {
<a name="l2730"><span class="linenum">2730</span></a>  <span class="comment">            // Disabled, don't restore course completion</span>
<a name="l2731"><span class="linenum">2731</span></a>              return false;
<a name="l2732"><span class="linenum">2732</span></a>          }
<a name="l2733"><span class="linenum">2733</span></a>  
<a name="l2734"><span class="linenum">2734</span></a>  <span class="comment">        // No course completion on the front page.</span>
<a name="l2735"><span class="linenum">2735</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>() == <a class="constant" onClick="logConstant('SITEID')" href="../../_constants/SITEID.html" onMouseOver="constPopup(event,'SITEID')">SITEID</a>) {
<a name="l2736"><span class="linenum">2736</span></a>              return false;
<a name="l2737"><span class="linenum">2737</span></a>          }
<a name="l2738"><span class="linenum">2738</span></a>  
<a name="l2739"><span class="linenum">2739</span></a>  <span class="comment">        // Check it is included in the backup</span>
<a name="l2740"><span class="linenum">2740</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_taskbasepath')" href="../../_functions/get_taskbasepath.html" onMouseOver="funcPopup(event,'get_taskbasepath')">get_taskbasepath</a>();
<a name="l2741"><span class="linenum">2741</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="phpfunction" onClick="logFunction('rtrim')" href="../../_functions/rtrim.html" onMouseOver="phpfuncPopup(event,'rtrim')">rtrim</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>, '/') . '/' . <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('filename')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/filename.html">filename</a>;
<a name="l2742"><span class="linenum">2742</span></a>          if (!<a class="phpfunction" onClick="logFunction('file_exists')" href="../../_functions/file_exists.html" onMouseOver="phpfuncPopup(event,'file_exists')">file_exists</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>)) {
<a name="l2743"><span class="linenum">2743</span></a>  <span class="comment">            // Not found, can't restore course completion</span>
<a name="l2744"><span class="linenum">2744</span></a>              return false;
<a name="l2745"><span class="linenum">2745</span></a>          }
<a name="l2746"><span class="linenum">2746</span></a>  
<a name="l2747"><span class="linenum">2747</span></a>  <span class="comment">        // Check we are able to restore all backed up modules</span>
<a name="l2748"><span class="linenum">2748</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('is_missing_modules')" href="../../_functions/is_missing_modules.html" onMouseOver="funcPopup(event,'is_missing_modules')">is_missing_modules</a>()) {
<a name="l2749"><span class="linenum">2749</span></a>              return false;
<a name="l2750"><span class="linenum">2750</span></a>          }
<a name="l2751"><span class="linenum">2751</span></a>  
<a name="l2752"><span class="linenum">2752</span></a>  <span class="comment">        // Check all modules within the backup are being restored.</span>
<a name="l2753"><span class="linenum">2753</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('is_excluding_activities')" href="../../_functions/is_excluding_activities.html" onMouseOver="funcPopup(event,'is_excluding_activities')">is_excluding_activities</a>()) {
<a name="l2754"><span class="linenum">2754</span></a>              return false;
<a name="l2755"><span class="linenum">2755</span></a>          }
<a name="l2756"><span class="linenum">2756</span></a>  
<a name="l2757"><span class="linenum">2757</span></a>  <span class="comment">        // Check that no completion criteria is already set for the course.</span>
<a name="l2758"><span class="linenum">2758</span></a>          if (<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists')" href="../../_functions/record_exists.html" onMouseOver="funcPopup(event,'record_exists')">record_exists</a>('course_completion_criteria', array('course' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>()))) {
<a name="l2759"><span class="linenum">2759</span></a>              return false;
<a name="l2760"><span class="linenum">2760</span></a>          }
<a name="l2761"><span class="linenum">2761</span></a>  
<a name="l2762"><span class="linenum">2762</span></a>          return true;
<a name="l2763"><span class="linenum">2763</span></a>      }
<a name="l2764"><span class="linenum">2764</span></a>  
<a name="l2765"><span class="linenum">2765</span></a>      <span class="comment">/**</span>
<a name="l2766"><span class="linenum">2766</span></a>  <span class="comment">     * Define the course completion structure</span>
<a name="l2767"><span class="linenum">2767</span></a>  <span class="comment">     *</span>
<a name="l2768"><span class="linenum">2768</span></a>  <span class="comment">     * @return array Array of restore_path_element</span>
<a name="l2769"><span class="linenum">2769</span></a>  <span class="comment">     */</span>
<a name="l2770"><span class="linenum">2770</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l2771"><span class="linenum">2771</span></a>  
<a name="l2772"><span class="linenum">2772</span></a>  <span class="comment">        // To know if we are including user completion info</span>
<a name="l2773"><span class="linenum">2773</span></a>          <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('userinfo')" href="../../_variables/userinfo.html">$userinfo</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('userscompletion');
<a name="l2774"><span class="linenum">2774</span></a>  
<a name="l2775"><span class="linenum">2775</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array();
<a name="l2776"><span class="linenum">2776</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('course_completion_criteria', '/course_completion/course_completion_criteria');
<a name="l2777"><span class="linenum">2777</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('course_completion_aggr_methd', '/course_completion/course_completion_aggr_methd');
<a name="l2778"><span class="linenum">2778</span></a>  
<a name="l2779"><span class="linenum">2779</span></a>          if (<a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('userinfo')" href="../../_variables/userinfo.html">$userinfo</a>) {
<a name="l2780"><span class="linenum">2780</span></a>              <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('course_completion_crit_compl', '/course_completion/course_completion_criteria/course_completion_crit_completions/course_completion_crit_compl');
<a name="l2781"><span class="linenum">2781</span></a>              <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('course_completions', '/course_completion/course_completions');
<a name="l2782"><span class="linenum">2782</span></a>          }
<a name="l2783"><span class="linenum">2783</span></a>  
<a name="l2784"><span class="linenum">2784</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l2785"><span class="linenum">2785</span></a>  
<a name="l2786"><span class="linenum">2786</span></a>      }
<a name="l2787"><span class="linenum">2787</span></a>  
<a name="l2788"><span class="linenum">2788</span></a>      <span class="comment">/**</span>
<a name="l2789"><span class="linenum">2789</span></a>  <span class="comment">     * Process course completion criteria</span>
<a name="l2790"><span class="linenum">2790</span></a>  <span class="comment">     *</span>
<a name="l2791"><span class="linenum">2791</span></a>  <span class="comment">     * @global moodle_database $DB</span>
<a name="l2792"><span class="linenum">2792</span></a>  <span class="comment">     * @param stdClass $data</span>
<a name="l2793"><span class="linenum">2793</span></a>  <span class="comment">     */</span>
<a name="l2794"><span class="linenum">2794</span></a>      public function <a class="function" onClick="logFunction('process_course_completion_criteria')" href="../../_functions/process_course_completion_criteria.html" onMouseOver="funcPopup(event,'process_course_completion_criteria')">process_course_completion_criteria</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l2795"><span class="linenum">2795</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l2796"><span class="linenum">2796</span></a>  
<a name="l2797"><span class="linenum">2797</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l2798"><span class="linenum">2798</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('course')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/course.html">course</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l2799"><span class="linenum">2799</span></a>  
<a name="l2800"><span class="linenum">2800</span></a>  <span class="comment">        // Apply the date offset to the time end field</span>
<a name="l2801"><span class="linenum">2801</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timeend')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timeend.html">timeend</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timeend')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timeend.html">timeend</a>);
<a name="l2802"><span class="linenum">2802</span></a>  
<a name="l2803"><span class="linenum">2803</span></a>  <span class="comment">        // Map the role from the criteria</span>
<a name="l2804"><span class="linenum">2804</span></a>          if (isset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('role')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/role.html">role</a>) &amp;&amp; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('role')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/role.html">role</a> != '') {
<a name="l2805"><span class="linenum">2805</span></a>  <span class="comment">            // Newer backups should include roleshortname, which makes this much easier.</span>
<a name="l2806"><span class="linenum">2806</span></a>              if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('roleshortname')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/roleshortname.html">roleshortname</a>)) {
<a name="l2807"><span class="linenum">2807</span></a>                  <a class="var it15426" onMouseOver="hilite(15426)" onMouseOut="lolite()" onClick="logVariable('roleinstanceid')" href="../../_variables/roleinstanceid.html">$roleinstanceid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('role', 'id', array('shortname' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('roleshortname')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/roleshortname.html">roleshortname</a>));
<a name="l2808"><span class="linenum">2808</span></a>                  if (!<a class="var it15426" onMouseOver="hilite(15426)" onMouseOut="lolite()" onClick="logVariable('roleinstanceid')" href="../../_variables/roleinstanceid.html">$roleinstanceid</a>) {
<a name="l2809"><span class="linenum">2809</span></a>                      <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="phpfunction" onClick="logFunction('log')" href="../../_functions/log.html" onMouseOver="phpfuncPopup(event,'log')">log</a>(
<a name="l2810"><span class="linenum">2810</span></a>                          'Could not match the role shortname in course_completion_criteria, so skipping',
<a name="l2811"><span class="linenum">2811</span></a>                          backup::LOG_DEBUG
<a name="l2812"><span class="linenum">2812</span></a>                      );
<a name="l2813"><span class="linenum">2813</span></a>                      return;
<a name="l2814"><span class="linenum">2814</span></a>                  }
<a name="l2815"><span class="linenum">2815</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('role')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/role.html">role</a> = <a class="var it15426" onMouseOver="hilite(15426)" onMouseOut="lolite()" onClick="logVariable('roleinstanceid')" href="../../_variables/roleinstanceid.html">$roleinstanceid</a>;
<a name="l2816"><span class="linenum">2816</span></a>              } else {
<a name="l2817"><span class="linenum">2817</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('role')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/role.html">role</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('role', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('role')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/role.html">role</a>);
<a name="l2818"><span class="linenum">2818</span></a>              }
<a name="l2819"><span class="linenum">2819</span></a>  
<a name="l2820"><span class="linenum">2820</span></a>  <span class="comment">            // Check we have an id, otherwise it causes all sorts of bugs.</span>
<a name="l2821"><span class="linenum">2821</span></a>              if (!<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('role')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/role.html">role</a>) {
<a name="l2822"><span class="linenum">2822</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="phpfunction" onClick="logFunction('log')" href="../../_functions/log.html" onMouseOver="phpfuncPopup(event,'log')">log</a>(
<a name="l2823"><span class="linenum">2823</span></a>                      'Could not match role in course_completion_criteria, so skipping',
<a name="l2824"><span class="linenum">2824</span></a>                      backup::LOG_DEBUG
<a name="l2825"><span class="linenum">2825</span></a>                  );
<a name="l2826"><span class="linenum">2826</span></a>                  return;
<a name="l2827"><span class="linenum">2827</span></a>              }
<a name="l2828"><span class="linenum">2828</span></a>          }
<a name="l2829"><span class="linenum">2829</span></a>  
<a name="l2830"><span class="linenum">2830</span></a>  <span class="comment">        // If the completion criteria is for a module we need to map the module instance</span>
<a name="l2831"><span class="linenum">2831</span></a>  <span class="comment">        // to the new module id.</span>
<a name="l2832"><span class="linenum">2832</span></a>          if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('moduleinstance')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/moduleinstance.html">moduleinstance</a>) &amp;&amp; !empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('module')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/module.html">module</a>)) {
<a name="l2833"><span class="linenum">2833</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('moduleinstance')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/moduleinstance.html">moduleinstance</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('course_module', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('moduleinstance')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/moduleinstance.html">moduleinstance</a>);
<a name="l2834"><span class="linenum">2834</span></a>              if (empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('moduleinstance')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/moduleinstance.html">moduleinstance</a>)) {
<a name="l2835"><span class="linenum">2835</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="phpfunction" onClick="logFunction('log')" href="../../_functions/log.html" onMouseOver="phpfuncPopup(event,'log')">log</a>(
<a name="l2836"><span class="linenum">2836</span></a>                      'Could not match the module instance in course_completion_criteria, so skipping',
<a name="l2837"><span class="linenum">2837</span></a>                      backup::LOG_DEBUG
<a name="l2838"><span class="linenum">2838</span></a>                  );
<a name="l2839"><span class="linenum">2839</span></a>                  return;
<a name="l2840"><span class="linenum">2840</span></a>              }
<a name="l2841"><span class="linenum">2841</span></a>          } else {
<a name="l2842"><span class="linenum">2842</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('module')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/module.html">module</a> = null;
<a name="l2843"><span class="linenum">2843</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('moduleinstance')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/moduleinstance.html">moduleinstance</a> = null;
<a name="l2844"><span class="linenum">2844</span></a>          }
<a name="l2845"><span class="linenum">2845</span></a>  
<a name="l2846"><span class="linenum">2846</span></a>  <span class="comment">        // We backup the course shortname rather than the ID so that we can match back to the course</span>
<a name="l2847"><span class="linenum">2847</span></a>          if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseinstanceshortname')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseinstanceshortname.html">courseinstanceshortname</a>)) {
<a name="l2848"><span class="linenum">2848</span></a>              <a class="var it15428" onMouseOver="hilite(15428)" onMouseOut="lolite()" onClick="logVariable('courseinstanceid')" href="../../_variables/courseinstanceid.html">$courseinstanceid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('course', 'id', array('shortname'=&gt;<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseinstanceshortname')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseinstanceshortname.html">courseinstanceshortname</a>));
<a name="l2849"><span class="linenum">2849</span></a>              if (!<a class="var it15428" onMouseOver="hilite(15428)" onMouseOut="lolite()" onClick="logVariable('courseinstanceid')" href="../../_variables/courseinstanceid.html">$courseinstanceid</a>) {
<a name="l2850"><span class="linenum">2850</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="phpfunction" onClick="logFunction('log')" href="../../_functions/log.html" onMouseOver="phpfuncPopup(event,'log')">log</a>(
<a name="l2851"><span class="linenum">2851</span></a>                      'Could not match the course instance in course_completion_criteria, so skipping',
<a name="l2852"><span class="linenum">2852</span></a>                      backup::LOG_DEBUG
<a name="l2853"><span class="linenum">2853</span></a>                  );
<a name="l2854"><span class="linenum">2854</span></a>                  return;
<a name="l2855"><span class="linenum">2855</span></a>              }
<a name="l2856"><span class="linenum">2856</span></a>          } else {
<a name="l2857"><span class="linenum">2857</span></a>              <a class="var it15428" onMouseOver="hilite(15428)" onMouseOut="lolite()" onClick="logVariable('courseinstanceid')" href="../../_variables/courseinstanceid.html">$courseinstanceid</a> = null;
<a name="l2858"><span class="linenum">2858</span></a>          }
<a name="l2859"><span class="linenum">2859</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseinstance')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseinstance.html">courseinstance</a> = <a class="var it15428" onMouseOver="hilite(15428)" onMouseOut="lolite()" onClick="logVariable('courseinstanceid')" href="../../_variables/courseinstanceid.html">$courseinstanceid</a>;
<a name="l2860"><span class="linenum">2860</span></a>  
<a name="l2861"><span class="linenum">2861</span></a>          <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array(
<a name="l2862"><span class="linenum">2862</span></a>              'course'         =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('course')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/course.html">course</a>,
<a name="l2863"><span class="linenum">2863</span></a>              'criteriatype'   =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('criteriatype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/criteriatype.html">criteriatype</a>,
<a name="l2864"><span class="linenum">2864</span></a>              'enrolperiod'    =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('enrolperiod')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/enrolperiod.html">enrolperiod</a>,
<a name="l2865"><span class="linenum">2865</span></a>              'courseinstance' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseinstance')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseinstance.html">courseinstance</a>,
<a name="l2866"><span class="linenum">2866</span></a>              'module'         =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('module')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/module.html">module</a>,
<a name="l2867"><span class="linenum">2867</span></a>              'moduleinstance' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('moduleinstance')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/moduleinstance.html">moduleinstance</a>,
<a name="l2868"><span class="linenum">2868</span></a>              'timeend'        =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timeend')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timeend.html">timeend</a>,
<a name="l2869"><span class="linenum">2869</span></a>              'gradepass'      =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('gradepass')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/gradepass.html">gradepass</a>,
<a name="l2870"><span class="linenum">2870</span></a>              'role'           =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;role
<a name="l2871"><span class="linenum">2871</span></a>          );
<a name="l2872"><span class="linenum">2872</span></a>          <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('course_completion_criteria', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l2873"><span class="linenum">2873</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('course_completion_criteria', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a>);
<a name="l2874"><span class="linenum">2874</span></a>      }
<a name="l2875"><span class="linenum">2875</span></a>  
<a name="l2876"><span class="linenum">2876</span></a>      <span class="comment">/**</span>
<a name="l2877"><span class="linenum">2877</span></a>  <span class="comment">     * Processes course compltion criteria complete records</span>
<a name="l2878"><span class="linenum">2878</span></a>  <span class="comment">     *</span>
<a name="l2879"><span class="linenum">2879</span></a>  <span class="comment">     * @global moodle_database $DB</span>
<a name="l2880"><span class="linenum">2880</span></a>  <span class="comment">     * @param stdClass $data</span>
<a name="l2881"><span class="linenum">2881</span></a>  <span class="comment">     */</span>
<a name="l2882"><span class="linenum">2882</span></a>      public function <a class="function" onClick="logFunction('process_course_completion_crit_compl')" href="../../_functions/process_course_completion_crit_compl.html" onMouseOver="funcPopup(event,'process_course_completion_crit_compl')">process_course_completion_crit_compl</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l2883"><span class="linenum">2883</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l2884"><span class="linenum">2884</span></a>  
<a name="l2885"><span class="linenum">2885</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l2886"><span class="linenum">2886</span></a>  
<a name="l2887"><span class="linenum">2887</span></a>  <span class="comment">        // This may be empty if criteria could not be restored</span>
<a name="l2888"><span class="linenum">2888</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('criteriaid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/criteriaid.html">criteriaid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('course_completion_criteria', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('criteriaid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/criteriaid.html">criteriaid</a>);
<a name="l2889"><span class="linenum">2889</span></a>  
<a name="l2890"><span class="linenum">2890</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('course')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/course.html">course</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l2891"><span class="linenum">2891</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>);
<a name="l2892"><span class="linenum">2892</span></a>  
<a name="l2893"><span class="linenum">2893</span></a>          if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('criteriaid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/criteriaid.html">criteriaid</a>) &amp;&amp; !empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>)) {
<a name="l2894"><span class="linenum">2894</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array(
<a name="l2895"><span class="linenum">2895</span></a>                  'userid' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>,
<a name="l2896"><span class="linenum">2896</span></a>                  'course' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('course')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/course.html">course</a>,
<a name="l2897"><span class="linenum">2897</span></a>                  'criteriaid' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('criteriaid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/criteriaid.html">criteriaid</a>,
<a name="l2898"><span class="linenum">2898</span></a>                  'timecompleted' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timecompleted')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timecompleted.html">timecompleted</a>)
<a name="l2899"><span class="linenum">2899</span></a>              );
<a name="l2900"><span class="linenum">2900</span></a>              if (isset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('gradefinal')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/gradefinal.html">gradefinal</a>)) {
<a name="l2901"><span class="linenum">2901</span></a>                  <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['gradefinal'] = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('gradefinal')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/gradefinal.html">gradefinal</a>;
<a name="l2902"><span class="linenum">2902</span></a>              }
<a name="l2903"><span class="linenum">2903</span></a>              if (isset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('unenroled')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/unenroled.html">unenroled</a>)) {
<a name="l2904"><span class="linenum">2904</span></a>                  <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['unenroled'] = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('unenroled')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/unenroled.html">unenroled</a>;
<a name="l2905"><span class="linenum">2905</span></a>              }
<a name="l2906"><span class="linenum">2906</span></a>              <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('course_completion_crit_compl', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l2907"><span class="linenum">2907</span></a>          }
<a name="l2908"><span class="linenum">2908</span></a>      }
<a name="l2909"><span class="linenum">2909</span></a>  
<a name="l2910"><span class="linenum">2910</span></a>      <span class="comment">/**</span>
<a name="l2911"><span class="linenum">2911</span></a>  <span class="comment">     * Process course completions</span>
<a name="l2912"><span class="linenum">2912</span></a>  <span class="comment">     *</span>
<a name="l2913"><span class="linenum">2913</span></a>  <span class="comment">     * @global moodle_database $DB</span>
<a name="l2914"><span class="linenum">2914</span></a>  <span class="comment">     * @param stdClass $data</span>
<a name="l2915"><span class="linenum">2915</span></a>  <span class="comment">     */</span>
<a name="l2916"><span class="linenum">2916</span></a>      public function <a class="function" onClick="logFunction('process_course_completions')" href="../../_functions/process_course_completions.html" onMouseOver="funcPopup(event,'process_course_completions')">process_course_completions</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l2917"><span class="linenum">2917</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l2918"><span class="linenum">2918</span></a>  
<a name="l2919"><span class="linenum">2919</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l2920"><span class="linenum">2920</span></a>  
<a name="l2921"><span class="linenum">2921</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('course')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/course.html">course</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l2922"><span class="linenum">2922</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>);
<a name="l2923"><span class="linenum">2923</span></a>  
<a name="l2924"><span class="linenum">2924</span></a>          if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>)) {
<a name="l2925"><span class="linenum">2925</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array(
<a name="l2926"><span class="linenum">2926</span></a>                  'userid' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>,
<a name="l2927"><span class="linenum">2927</span></a>                  'course' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('course')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/course.html">course</a>,
<a name="l2928"><span class="linenum">2928</span></a>                  'timeenrolled' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timeenrolled')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timeenrolled.html">timeenrolled</a>),
<a name="l2929"><span class="linenum">2929</span></a>                  'timestarted' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timestarted')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timestarted.html">timestarted</a>),
<a name="l2930"><span class="linenum">2930</span></a>                  'timecompleted' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timecompleted')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timecompleted.html">timecompleted</a>),
<a name="l2931"><span class="linenum">2931</span></a>                  'reaggregate' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;reaggregate
<a name="l2932"><span class="linenum">2932</span></a>              );
<a name="l2933"><span class="linenum">2933</span></a>  
<a name="l2934"><span class="linenum">2934</span></a>              <a class="var it10898" onMouseOver="hilite(10898)" onMouseOut="lolite()" onClick="logVariable('existing')" href="../../_variables/existing.html">$existing</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('course_completions', array(
<a name="l2935"><span class="linenum">2935</span></a>                  'userid' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>,
<a name="l2936"><span class="linenum">2936</span></a>                  'course' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;course
<a name="l2937"><span class="linenum">2937</span></a>              ));
<a name="l2938"><span class="linenum">2938</span></a>  
<a name="l2939"><span class="linenum">2939</span></a>  <span class="comment">            // MDL-46651 - If cron writes out a new record before we get to it</span>
<a name="l2940"><span class="linenum">2940</span></a>  <span class="comment">            // then we should replace it with the Truth data from the backup.</span>
<a name="l2941"><span class="linenum">2941</span></a>  <span class="comment">            // This may be obsolete after MDL-48518 is resolved</span>
<a name="l2942"><span class="linenum">2942</span></a>              if (<a class="var it10898" onMouseOver="hilite(10898)" onMouseOut="lolite()" onClick="logVariable('existing')" href="../../_variables/existing.html">$existing</a>) {
<a name="l2943"><span class="linenum">2943</span></a>                  <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['id'] = <a class="var it10898" onMouseOver="hilite(10898)" onMouseOut="lolite()" onClick="logVariable('existing')" href="../../_variables/existing.html">$existing</a>-&gt;<a onClick="logVariable('id')" class="var it43440" onMouseOver="hilite(43440)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l2944"><span class="linenum">2944</span></a>                  <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('update_record')" href="../../_functions/update_record.html" onMouseOver="funcPopup(event,'update_record')">update_record</a>('course_completions', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l2945"><span class="linenum">2945</span></a>              } else {
<a name="l2946"><span class="linenum">2946</span></a>                  <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('course_completions', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l2947"><span class="linenum">2947</span></a>              }
<a name="l2948"><span class="linenum">2948</span></a>          }
<a name="l2949"><span class="linenum">2949</span></a>      }
<a name="l2950"><span class="linenum">2950</span></a>  
<a name="l2951"><span class="linenum">2951</span></a>      <span class="comment">/**</span>
<a name="l2952"><span class="linenum">2952</span></a>  <span class="comment">     * Process course completion aggregate methods</span>
<a name="l2953"><span class="linenum">2953</span></a>  <span class="comment">     *</span>
<a name="l2954"><span class="linenum">2954</span></a>  <span class="comment">     * @global moodle_database $DB</span>
<a name="l2955"><span class="linenum">2955</span></a>  <span class="comment">     * @param stdClass $data</span>
<a name="l2956"><span class="linenum">2956</span></a>  <span class="comment">     */</span>
<a name="l2957"><span class="linenum">2957</span></a>      public function <a class="function" onClick="logFunction('process_course_completion_aggr_methd')" href="../../_functions/process_course_completion_aggr_methd.html" onMouseOver="funcPopup(event,'process_course_completion_aggr_methd')">process_course_completion_aggr_methd</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l2958"><span class="linenum">2958</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l2959"><span class="linenum">2959</span></a>  
<a name="l2960"><span class="linenum">2960</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l2961"><span class="linenum">2961</span></a>  
<a name="l2962"><span class="linenum">2962</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('course')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/course.html">course</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l2963"><span class="linenum">2963</span></a>  
<a name="l2964"><span class="linenum">2964</span></a>  <span class="comment">        // Only create the course_completion_aggr_methd records if</span>
<a name="l2965"><span class="linenum">2965</span></a>  <span class="comment">        // the target course has not them defined. MDL-28180</span>
<a name="l2966"><span class="linenum">2966</span></a>          if (!<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists')" href="../../_functions/record_exists.html" onMouseOver="funcPopup(event,'record_exists')">record_exists</a>('course_completion_aggr_methd', array(
<a name="l2967"><span class="linenum">2967</span></a>                      'course' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('course')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/course.html">course</a>,
<a name="l2968"><span class="linenum">2968</span></a>                      'criteriatype' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('criteriatype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/criteriatype.html">criteriatype</a>))) {
<a name="l2969"><span class="linenum">2969</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array(
<a name="l2970"><span class="linenum">2970</span></a>                  'course' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('course')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/course.html">course</a>,
<a name="l2971"><span class="linenum">2971</span></a>                  'criteriatype' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('criteriatype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/criteriatype.html">criteriatype</a>,
<a name="l2972"><span class="linenum">2972</span></a>                  'method' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('method')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/method.html">method</a>,
<a name="l2973"><span class="linenum">2973</span></a>                  'value' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('value')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/value.html">value</a>,
<a name="l2974"><span class="linenum">2974</span></a>              );
<a name="l2975"><span class="linenum">2975</span></a>              <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('course_completion_aggr_methd', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l2976"><span class="linenum">2976</span></a>          }
<a name="l2977"><span class="linenum">2977</span></a>      }
<a name="l2978"><span class="linenum">2978</span></a>  }
<a name="l2979"><span class="linenum">2979</span></a>  
<a name="l2980"><span class="linenum">2980</span></a>  
<a name="l2981"><span class="linenum">2981</span></a>  <span class="comment">/**</span>
<a name="l2982"><span class="linenum">2982</span></a>  <span class="comment"> * This structure step restores course logs (cmid = 0), delegating</span>
<a name="l2983"><span class="linenum">2983</span></a>  <span class="comment"> * the hard work to the corresponding {@link restore_logs_processor} passing the</span>
<a name="l2984"><span class="linenum">2984</span></a>  <span class="comment"> * collection of {@link restore_log_rule} rules to be observed as they are defined</span>
<a name="l2985"><span class="linenum">2985</span></a>  <span class="comment"> * by the task. Note this is only executed based in the 'logs' setting.</span>
<a name="l2986"><span class="linenum">2986</span></a>  <span class="comment"> *</span>
<a name="l2987"><span class="linenum">2987</span></a>  <span class="comment"> * NOTE: This is executed by final task, to have all the activities already restored</span>
<a name="l2988"><span class="linenum">2988</span></a>  <span class="comment"> *</span>
<a name="l2989"><span class="linenum">2989</span></a>  <span class="comment"> * NOTE: Not all course logs are being restored. For now only 'course' and 'user'</span>
<a name="l2990"><span class="linenum">2990</span></a>  <span class="comment"> * records are. There are others like 'calendar' and 'upload' that will be handled</span>
<a name="l2991"><span class="linenum">2991</span></a>  <span class="comment"> * later.</span>
<a name="l2992"><span class="linenum">2992</span></a>  <span class="comment"> *</span>
<a name="l2993"><span class="linenum">2993</span></a>  <span class="comment"> * NOTE: All the missing actions (not able to be restored) are sent to logs for</span>
<a name="l2994"><span class="linenum">2994</span></a>  <span class="comment"> * debugging purposes</span>
<a name="l2995"><span class="linenum">2995</span></a>  <span class="comment"> */</span>
<a name="l2996"><span class="linenum">2996</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_course_logs_structure_step')" href="../../_classes/restore_course_logs_structure_step.html" onMouseOver="classPopup(event,'restore_course_logs_structure_step')">restore_course_logs_structure_step</a> extends restore_structure_step {
<a name="l2997"><span class="linenum">2997</span></a>  
<a name="l2998"><span class="linenum">2998</span></a>      <span class="comment">/**</span>
<a name="l2999"><span class="linenum">2999</span></a>  <span class="comment">     * Conditionally decide if this step should be executed.</span>
<a name="l3000"><span class="linenum">3000</span></a>  <span class="comment">     *</span>
<a name="l3001"><span class="linenum">3001</span></a>  <span class="comment">     * This function checks the following parameter:</span>
<a name="l3002"><span class="linenum">3002</span></a>  <span class="comment">     *</span>
<a name="l3003"><span class="linenum">3003</span></a>  <span class="comment">     *   1. the course/logs.xml file exists</span>
<a name="l3004"><span class="linenum">3004</span></a>  <span class="comment">     *</span>
<a name="l3005"><span class="linenum">3005</span></a>  <span class="comment">     * @return bool true is safe to execute, false otherwise</span>
<a name="l3006"><span class="linenum">3006</span></a>  <span class="comment">     */</span>
<a name="l3007"><span class="linenum">3007</span></a>      protected function <a class="function" onClick="logFunction('execute_condition')" href="../../_functions/execute_condition.html" onMouseOver="funcPopup(event,'execute_condition')">execute_condition</a>() {
<a name="l3008"><span class="linenum">3008</span></a>  
<a name="l3009"><span class="linenum">3009</span></a>  <span class="comment">        // Check it is included in the backup</span>
<a name="l3010"><span class="linenum">3010</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_taskbasepath')" href="../../_functions/get_taskbasepath.html" onMouseOver="funcPopup(event,'get_taskbasepath')">get_taskbasepath</a>();
<a name="l3011"><span class="linenum">3011</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="phpfunction" onClick="logFunction('rtrim')" href="../../_functions/rtrim.html" onMouseOver="phpfuncPopup(event,'rtrim')">rtrim</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>, '/') . '/' . <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('filename')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/filename.html">filename</a>;
<a name="l3012"><span class="linenum">3012</span></a>          if (!<a class="phpfunction" onClick="logFunction('file_exists')" href="../../_functions/file_exists.html" onMouseOver="phpfuncPopup(event,'file_exists')">file_exists</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>)) {
<a name="l3013"><span class="linenum">3013</span></a>  <span class="comment">            // Not found, can't restore course logs</span>
<a name="l3014"><span class="linenum">3014</span></a>              return false;
<a name="l3015"><span class="linenum">3015</span></a>          }
<a name="l3016"><span class="linenum">3016</span></a>  
<a name="l3017"><span class="linenum">3017</span></a>          return true;
<a name="l3018"><span class="linenum">3018</span></a>      }
<a name="l3019"><span class="linenum">3019</span></a>  
<a name="l3020"><span class="linenum">3020</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l3021"><span class="linenum">3021</span></a>  
<a name="l3022"><span class="linenum">3022</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array();
<a name="l3023"><span class="linenum">3023</span></a>  
<a name="l3024"><span class="linenum">3024</span></a>  <span class="comment">        // Simple, one plain level of information contains them</span>
<a name="l3025"><span class="linenum">3025</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('log', '/logs/log');
<a name="l3026"><span class="linenum">3026</span></a>  
<a name="l3027"><span class="linenum">3027</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l3028"><span class="linenum">3028</span></a>      }
<a name="l3029"><span class="linenum">3029</span></a>  
<a name="l3030"><span class="linenum">3030</span></a>      protected function <a class="function" onClick="logFunction('process_log')" href="../../_functions/process_log.html" onMouseOver="funcPopup(event,'process_log')">process_log</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l3031"><span class="linenum">3031</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l3032"><span class="linenum">3032</span></a>  
<a name="l3033"><span class="linenum">3033</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l3034"><span class="linenum">3034</span></a>  
<a name="l3035"><span class="linenum">3035</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('time')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/time.html">time</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('time')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/time.html">time</a>);
<a name="l3036"><span class="linenum">3036</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>);
<a name="l3037"><span class="linenum">3037</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('course')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/course.html">course</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l3038"><span class="linenum">3038</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('cmid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/cmid.html">cmid</a> = 0;
<a name="l3039"><span class="linenum">3039</span></a>  
<a name="l3040"><span class="linenum">3040</span></a>  <span class="comment">        // For any reason user wasn't remapped ok, stop processing this</span>
<a name="l3041"><span class="linenum">3041</span></a>          if (empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>)) {
<a name="l3042"><span class="linenum">3042</span></a>              return;
<a name="l3043"><span class="linenum">3043</span></a>          }
<a name="l3044"><span class="linenum">3044</span></a>  
<a name="l3045"><span class="linenum">3045</span></a>  <span class="comment">        // Everything ready, let's delegate to the restore_logs_processor</span>
<a name="l3046"><span class="linenum">3046</span></a>  
<a name="l3047"><span class="linenum">3047</span></a>  <span class="comment">        // Set some fixed values that will save tons of DB requests</span>
<a name="l3048"><span class="linenum">3048</span></a>          <a class="var it753" onMouseOver="hilite(753)" onMouseOut="lolite()" onClick="logVariable('values')" href="../../_variables/values.html">$values</a> = array(
<a name="l3049"><span class="linenum">3049</span></a>              'course' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>());
<a name="l3050"><span class="linenum">3050</span></a>  <span class="comment">        // Get instance and process log record</span>
<a name="l3051"><span class="linenum">3051</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = <a class="class" onClick="logClass('restore_logs_processor')" href="../../_classes/restore_logs_processor.html" onMouseOver="classPopup(event,'restore_logs_processor')">restore_logs_processor</a>::<a class="function" onClick="logFunction('get_instance')" href="../../_functions/get_instance.html" onMouseOver="funcPopup(event,'get_instance')">get_instance</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>, <a class="var it753" onMouseOver="hilite(753)" onMouseOut="lolite()" onClick="logVariable('values')" href="../../_variables/values.html">$values</a>)-&gt;<a class="function" onClick="logFunction('process_log_record')" href="../../_functions/process_log_record.html" onMouseOver="funcPopup(event,'process_log_record')">process_log_record</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l3052"><span class="linenum">3052</span></a>  
<a name="l3053"><span class="linenum">3053</span></a>  <span class="comment">        // If we have data, insert it, else something went wrong in the restore_logs_processor</span>
<a name="l3054"><span class="linenum">3054</span></a>          if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l3055"><span class="linenum">3055</span></a>              if (empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('url')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/url.html">url</a>)) {
<a name="l3056"><span class="linenum">3056</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('url')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/url.html">url</a> = '';
<a name="l3057"><span class="linenum">3057</span></a>              }
<a name="l3058"><span class="linenum">3058</span></a>              if (empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('info')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/info.html">info</a>)) {
<a name="l3059"><span class="linenum">3059</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('info')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/info.html">info</a> = '';
<a name="l3060"><span class="linenum">3060</span></a>              }
<a name="l3061"><span class="linenum">3061</span></a>  <span class="comment">            // Store the data in the legacy log table if we are still using it.</span>
<a name="l3062"><span class="linenum">3062</span></a>              <a class="var it1045" onMouseOver="hilite(1045)" onMouseOut="lolite()" onClick="logVariable('manager')" href="../../_variables/manager.html">$manager</a> = <a class="function" onClick="logFunction('get_log_manager')" href="../../_functions/get_log_manager.html" onMouseOver="funcPopup(event,'get_log_manager')">get_log_manager</a>();
<a name="l3063"><span class="linenum">3063</span></a>              if (<a class="phpfunction" onClick="logFunction('method_exists')" href="../../_functions/method_exists.html" onMouseOver="phpfuncPopup(event,'method_exists')">method_exists</a>(<a class="var it1045" onMouseOver="hilite(1045)" onMouseOut="lolite()" onClick="logVariable('manager')" href="../../_variables/manager.html">$manager</a>, 'legacy_add_to_log')) {
<a name="l3064"><span class="linenum">3064</span></a>                  <a class="var it1045" onMouseOver="hilite(1045)" onMouseOut="lolite()" onClick="logVariable('manager')" href="../../_variables/manager.html">$manager</a>-&gt;<a class="function" onClick="logFunction('legacy_add_to_log')" href="../../_functions/legacy_add_to_log.html" onMouseOver="funcPopup(event,'legacy_add_to_log')">legacy_add_to_log</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('course')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/course.html">course</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('module')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/module.html">module</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('action')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/action.html">action</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('url')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/url.html">url</a>,
<a name="l3065"><span class="linenum">3065</span></a>                      <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('info')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/info.html">info</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('cmid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/cmid.html">cmid</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('ip')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/ip.html">ip</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('time')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/time.html">time</a>);
<a name="l3066"><span class="linenum">3066</span></a>              }
<a name="l3067"><span class="linenum">3067</span></a>          }
<a name="l3068"><span class="linenum">3068</span></a>      }
<a name="l3069"><span class="linenum">3069</span></a>  }
<a name="l3070"><span class="linenum">3070</span></a>  
<a name="l3071"><span class="linenum">3071</span></a>  <span class="comment">/**</span>
<a name="l3072"><span class="linenum">3072</span></a>  <span class="comment"> * This structure step restores activity logs, extending {@link restore_course_logs_structure_step}</span>
<a name="l3073"><span class="linenum">3073</span></a>  <span class="comment"> * sharing its same structure but modifying the way records are handled</span>
<a name="l3074"><span class="linenum">3074</span></a>  <span class="comment"> */</span>
<a name="l3075"><span class="linenum">3075</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_activity_logs_structure_step')" href="../../_classes/restore_activity_logs_structure_step.html" onMouseOver="classPopup(event,'restore_activity_logs_structure_step')">restore_activity_logs_structure_step</a> <span class="keyword">extends</span> <a class="class" onClick="logClass('restore_course_logs_structure_step')" href="../../_classes/restore_course_logs_structure_step.html" onMouseOver="classPopup(event,'restore_course_logs_structure_step')">restore_course_logs_structure_step</a> {
<a name="l3076"><span class="linenum">3076</span></a>  
<a name="l3077"><span class="linenum">3077</span></a>      protected function <a class="function" onClick="logFunction('process_log')" href="../../_functions/process_log.html" onMouseOver="funcPopup(event,'process_log')">process_log</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l3078"><span class="linenum">3078</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l3079"><span class="linenum">3079</span></a>  
<a name="l3080"><span class="linenum">3080</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l3081"><span class="linenum">3081</span></a>  
<a name="l3082"><span class="linenum">3082</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('time')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/time.html">time</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('time')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/time.html">time</a>);
<a name="l3083"><span class="linenum">3083</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>);
<a name="l3084"><span class="linenum">3084</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('course')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/course.html">course</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l3085"><span class="linenum">3085</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('cmid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/cmid.html">cmid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_moduleid')" href="../../_functions/get_moduleid.html" onMouseOver="funcPopup(event,'get_moduleid')">get_moduleid</a>();
<a name="l3086"><span class="linenum">3086</span></a>  
<a name="l3087"><span class="linenum">3087</span></a>  <span class="comment">        // For any reason user wasn't remapped ok, stop processing this</span>
<a name="l3088"><span class="linenum">3088</span></a>          if (empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>)) {
<a name="l3089"><span class="linenum">3089</span></a>              return;
<a name="l3090"><span class="linenum">3090</span></a>          }
<a name="l3091"><span class="linenum">3091</span></a>  
<a name="l3092"><span class="linenum">3092</span></a>  <span class="comment">        // Everything ready, let's delegate to the restore_logs_processor</span>
<a name="l3093"><span class="linenum">3093</span></a>  
<a name="l3094"><span class="linenum">3094</span></a>  <span class="comment">        // Set some fixed values that will save tons of DB requests</span>
<a name="l3095"><span class="linenum">3095</span></a>          <a class="var it753" onMouseOver="hilite(753)" onMouseOut="lolite()" onClick="logVariable('values')" href="../../_variables/values.html">$values</a> = array(
<a name="l3096"><span class="linenum">3096</span></a>              'course' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(),
<a name="l3097"><span class="linenum">3097</span></a>              'course_module' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_moduleid')" href="../../_functions/get_moduleid.html" onMouseOver="funcPopup(event,'get_moduleid')">get_moduleid</a>(),
<a name="l3098"><span class="linenum">3098</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_modulename')" href="../../_functions/get_modulename.html" onMouseOver="funcPopup(event,'get_modulename')">get_modulename</a>() =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_activityid')" href="../../_functions/get_activityid.html" onMouseOver="funcPopup(event,'get_activityid')">get_activityid</a>());
<a name="l3099"><span class="linenum">3099</span></a>  <span class="comment">        // Get instance and process log record</span>
<a name="l3100"><span class="linenum">3100</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = <a class="class" onClick="logClass('restore_logs_processor')" href="../../_classes/restore_logs_processor.html" onMouseOver="classPopup(event,'restore_logs_processor')">restore_logs_processor</a>::<a class="function" onClick="logFunction('get_instance')" href="../../_functions/get_instance.html" onMouseOver="funcPopup(event,'get_instance')">get_instance</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>, <a class="var it753" onMouseOver="hilite(753)" onMouseOut="lolite()" onClick="logVariable('values')" href="../../_variables/values.html">$values</a>)-&gt;<a class="function" onClick="logFunction('process_log_record')" href="../../_functions/process_log_record.html" onMouseOver="funcPopup(event,'process_log_record')">process_log_record</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l3101"><span class="linenum">3101</span></a>  
<a name="l3102"><span class="linenum">3102</span></a>  <span class="comment">        // If we have data, insert it, else something went wrong in the restore_logs_processor</span>
<a name="l3103"><span class="linenum">3103</span></a>          if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l3104"><span class="linenum">3104</span></a>              if (empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('url')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/url.html">url</a>)) {
<a name="l3105"><span class="linenum">3105</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('url')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/url.html">url</a> = '';
<a name="l3106"><span class="linenum">3106</span></a>              }
<a name="l3107"><span class="linenum">3107</span></a>              if (empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('info')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/info.html">info</a>)) {
<a name="l3108"><span class="linenum">3108</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('info')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/info.html">info</a> = '';
<a name="l3109"><span class="linenum">3109</span></a>              }
<a name="l3110"><span class="linenum">3110</span></a>  <span class="comment">            // Store the data in the legacy log table if we are still using it.</span>
<a name="l3111"><span class="linenum">3111</span></a>              <a class="var it1045" onMouseOver="hilite(1045)" onMouseOut="lolite()" onClick="logVariable('manager')" href="../../_variables/manager.html">$manager</a> = <a class="function" onClick="logFunction('get_log_manager')" href="../../_functions/get_log_manager.html" onMouseOver="funcPopup(event,'get_log_manager')">get_log_manager</a>();
<a name="l3112"><span class="linenum">3112</span></a>              if (<a class="phpfunction" onClick="logFunction('method_exists')" href="../../_functions/method_exists.html" onMouseOver="phpfuncPopup(event,'method_exists')">method_exists</a>(<a class="var it1045" onMouseOver="hilite(1045)" onMouseOut="lolite()" onClick="logVariable('manager')" href="../../_variables/manager.html">$manager</a>, 'legacy_add_to_log')) {
<a name="l3113"><span class="linenum">3113</span></a>                  <a class="var it1045" onMouseOver="hilite(1045)" onMouseOut="lolite()" onClick="logVariable('manager')" href="../../_variables/manager.html">$manager</a>-&gt;<a class="function" onClick="logFunction('legacy_add_to_log')" href="../../_functions/legacy_add_to_log.html" onMouseOver="funcPopup(event,'legacy_add_to_log')">legacy_add_to_log</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('course')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/course.html">course</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('module')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/module.html">module</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('action')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/action.html">action</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('url')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/url.html">url</a>,
<a name="l3114"><span class="linenum">3114</span></a>                      <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('info')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/info.html">info</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('cmid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/cmid.html">cmid</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('ip')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/ip.html">ip</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('time')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/time.html">time</a>);
<a name="l3115"><span class="linenum">3115</span></a>              }
<a name="l3116"><span class="linenum">3116</span></a>          }
<a name="l3117"><span class="linenum">3117</span></a>      }
<a name="l3118"><span class="linenum">3118</span></a>  }
<a name="l3119"><span class="linenum">3119</span></a>  
<a name="l3120"><span class="linenum">3120</span></a>  <span class="comment">/**</span>
<a name="l3121"><span class="linenum">3121</span></a>  <span class="comment"> * Structure step in charge of restoring the logstores.xml file for the course logs.</span>
<a name="l3122"><span class="linenum">3122</span></a>  <span class="comment"> *</span>
<a name="l3123"><span class="linenum">3123</span></a>  <span class="comment"> * This restore step will rebuild the logs for all the enabled logstore subplugins supporting</span>
<a name="l3124"><span class="linenum">3124</span></a>  <span class="comment"> * it, for logs belonging to the course level.</span>
<a name="l3125"><span class="linenum">3125</span></a>  <span class="comment"> */</span>
<a name="l3126"><span class="linenum">3126</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_course_logstores_structure_step')" href="../../_classes/restore_course_logstores_structure_step.html" onMouseOver="classPopup(event,'restore_course_logstores_structure_step')">restore_course_logstores_structure_step</a> extends restore_structure_step {
<a name="l3127"><span class="linenum">3127</span></a>  
<a name="l3128"><span class="linenum">3128</span></a>      <span class="comment">/**</span>
<a name="l3129"><span class="linenum">3129</span></a>  <span class="comment">     * Conditionally decide if this step should be executed.</span>
<a name="l3130"><span class="linenum">3130</span></a>  <span class="comment">     *</span>
<a name="l3131"><span class="linenum">3131</span></a>  <span class="comment">     * This function checks the following parameter:</span>
<a name="l3132"><span class="linenum">3132</span></a>  <span class="comment">     *</span>
<a name="l3133"><span class="linenum">3133</span></a>  <span class="comment">     *   1. the logstores.xml file exists</span>
<a name="l3134"><span class="linenum">3134</span></a>  <span class="comment">     *</span>
<a name="l3135"><span class="linenum">3135</span></a>  <span class="comment">     * @return bool true is safe to execute, false otherwise</span>
<a name="l3136"><span class="linenum">3136</span></a>  <span class="comment">     */</span>
<a name="l3137"><span class="linenum">3137</span></a>      protected function <a class="function" onClick="logFunction('execute_condition')" href="../../_functions/execute_condition.html" onMouseOver="funcPopup(event,'execute_condition')">execute_condition</a>() {
<a name="l3138"><span class="linenum">3138</span></a>  
<a name="l3139"><span class="linenum">3139</span></a>  <span class="comment">        // Check it is included in the backup.</span>
<a name="l3140"><span class="linenum">3140</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_taskbasepath')" href="../../_functions/get_taskbasepath.html" onMouseOver="funcPopup(event,'get_taskbasepath')">get_taskbasepath</a>();
<a name="l3141"><span class="linenum">3141</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="phpfunction" onClick="logFunction('rtrim')" href="../../_functions/rtrim.html" onMouseOver="phpfuncPopup(event,'rtrim')">rtrim</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>, '/') . '/' . <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('filename')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/filename.html">filename</a>;
<a name="l3142"><span class="linenum">3142</span></a>          if (!<a class="phpfunction" onClick="logFunction('file_exists')" href="../../_functions/file_exists.html" onMouseOver="phpfuncPopup(event,'file_exists')">file_exists</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>)) {
<a name="l3143"><span class="linenum">3143</span></a>  <span class="comment">            // Not found, can't restore logstores.xml information.</span>
<a name="l3144"><span class="linenum">3144</span></a>              return false;
<a name="l3145"><span class="linenum">3145</span></a>          }
<a name="l3146"><span class="linenum">3146</span></a>  
<a name="l3147"><span class="linenum">3147</span></a>          return true;
<a name="l3148"><span class="linenum">3148</span></a>      }
<a name="l3149"><span class="linenum">3149</span></a>  
<a name="l3150"><span class="linenum">3150</span></a>      <span class="comment">/**</span>
<a name="l3151"><span class="linenum">3151</span></a>  <span class="comment">     * Return the elements to be processed on restore of logstores.</span>
<a name="l3152"><span class="linenum">3152</span></a>  <span class="comment">     *</span>
<a name="l3153"><span class="linenum">3153</span></a>  <span class="comment">     * @return restore_path_element[] array of elements to be processed on restore.</span>
<a name="l3154"><span class="linenum">3154</span></a>  <span class="comment">     */</span>
<a name="l3155"><span class="linenum">3155</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l3156"><span class="linenum">3156</span></a>  
<a name="l3157"><span class="linenum">3157</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array();
<a name="l3158"><span class="linenum">3158</span></a>  
<a name="l3159"><span class="linenum">3159</span></a>          <a class="var it15431" onMouseOver="hilite(15431)" onMouseOut="lolite()" onClick="logVariable('logstore')" href="../../_variables/logstore.html">$logstore</a> = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('logstore', '/logstores/logstore');
<a name="l3160"><span class="linenum">3160</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <a class="var it15431" onMouseOver="hilite(15431)" onMouseOut="lolite()" onClick="logVariable('logstore')" href="../../_variables/logstore.html">$logstore</a>;
<a name="l3161"><span class="linenum">3161</span></a>  
<a name="l3162"><span class="linenum">3162</span></a>  <span class="comment">        // Add logstore subplugin support to the 'logstore' element.</span>
<a name="l3163"><span class="linenum">3163</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_subplugin_structure')" href="../../_functions/add_subplugin_structure.html" onMouseOver="funcPopup(event,'add_subplugin_structure')">add_subplugin_structure</a>('logstore', <a class="var it15431" onMouseOver="hilite(15431)" onMouseOut="lolite()" onClick="logVariable('logstore')" href="../../_variables/logstore.html">$logstore</a>, 'tool', 'log');
<a name="l3164"><span class="linenum">3164</span></a>  
<a name="l3165"><span class="linenum">3165</span></a>          return array(<a class="var it15431" onMouseOver="hilite(15431)" onMouseOut="lolite()" onClick="logVariable('logstore')" href="../../_variables/logstore.html">$logstore</a>);
<a name="l3166"><span class="linenum">3166</span></a>      }
<a name="l3167"><span class="linenum">3167</span></a>  
<a name="l3168"><span class="linenum">3168</span></a>      <span class="comment">/**</span>
<a name="l3169"><span class="linenum">3169</span></a>  <span class="comment">     * Process the 'logstore' element,</span>
<a name="l3170"><span class="linenum">3170</span></a>  <span class="comment">     *</span>
<a name="l3171"><span class="linenum">3171</span></a>  <span class="comment">     * Note: This is empty by definition in backup, because stores do not share any</span>
<a name="l3172"><span class="linenum">3172</span></a>  <span class="comment">     * data between them, so there is nothing to process here.</span>
<a name="l3173"><span class="linenum">3173</span></a>  <span class="comment">     *</span>
<a name="l3174"><span class="linenum">3174</span></a>  <span class="comment">     * @param array $data element data</span>
<a name="l3175"><span class="linenum">3175</span></a>  <span class="comment">     */</span>
<a name="l3176"><span class="linenum">3176</span></a>      protected function <a class="function" onClick="logFunction('process_logstore')" href="../../_functions/process_logstore.html" onMouseOver="funcPopup(event,'process_logstore')">process_logstore</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l3177"><span class="linenum">3177</span></a>          return;
<a name="l3178"><span class="linenum">3178</span></a>      }
<a name="l3179"><span class="linenum">3179</span></a>  }
<a name="l3180"><span class="linenum">3180</span></a>  
<a name="l3181"><span class="linenum">3181</span></a>  <span class="comment">/**</span>
<a name="l3182"><span class="linenum">3182</span></a>  <span class="comment"> * Structure step in charge of restoring the logstores.xml file for the activity logs.</span>
<a name="l3183"><span class="linenum">3183</span></a>  <span class="comment"> *</span>
<a name="l3184"><span class="linenum">3184</span></a>  <span class="comment"> * Note: Activity structure is completely equivalent to the course one, so just extend it.</span>
<a name="l3185"><span class="linenum">3185</span></a>  <span class="comment"> */</span>
<a name="l3186"><span class="linenum">3186</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_activity_logstores_structure_step')" href="../../_classes/restore_activity_logstores_structure_step.html" onMouseOver="classPopup(event,'restore_activity_logstores_structure_step')">restore_activity_logstores_structure_step</a> <span class="keyword">extends</span> <a class="class" onClick="logClass('restore_course_logstores_structure_step')" href="../../_classes/restore_course_logstores_structure_step.html" onMouseOver="classPopup(event,'restore_course_logstores_structure_step')">restore_course_logstores_structure_step</a> {
<a name="l3187"><span class="linenum">3187</span></a>  }
<a name="l3188"><span class="linenum">3188</span></a>  
<a name="l3189"><span class="linenum">3189</span></a>  <span class="comment">/**</span>
<a name="l3190"><span class="linenum">3190</span></a>  <span class="comment"> * Restore course competencies structure step.</span>
<a name="l3191"><span class="linenum">3191</span></a>  <span class="comment"> */</span>
<a name="l3192"><span class="linenum">3192</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_course_competencies_structure_step')" href="../../_classes/restore_course_competencies_structure_step.html" onMouseOver="classPopup(event,'restore_course_competencies_structure_step')">restore_course_competencies_structure_step</a> extends restore_structure_step {
<a name="l3193"><span class="linenum">3193</span></a>  
<a name="l3194"><span class="linenum">3194</span></a>      <span class="comment">/**</span>
<a name="l3195"><span class="linenum">3195</span></a>  <span class="comment">     * Returns the structure.</span>
<a name="l3196"><span class="linenum">3196</span></a>  <span class="comment">     *</span>
<a name="l3197"><span class="linenum">3197</span></a>  <span class="comment">     * @return array</span>
<a name="l3198"><span class="linenum">3198</span></a>  <span class="comment">     */</span>
<a name="l3199"><span class="linenum">3199</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l3200"><span class="linenum">3200</span></a>          <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('userinfo')" href="../../_variables/userinfo.html">$userinfo</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('users');
<a name="l3201"><span class="linenum">3201</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array(
<a name="l3202"><span class="linenum">3202</span></a>              <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('course_competency', '/course_competencies/competencies/competency'),
<a name="l3203"><span class="linenum">3203</span></a>              <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('course_competency_settings', '/course_competencies/settings'),
<a name="l3204"><span class="linenum">3204</span></a>          );
<a name="l3205"><span class="linenum">3205</span></a>          if (<a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('userinfo')" href="../../_variables/userinfo.html">$userinfo</a>) {
<a name="l3206"><span class="linenum">3206</span></a>              <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('user_competency_course',
<a name="l3207"><span class="linenum">3207</span></a>                  '/course_competencies/user_competencies/user_competency');
<a name="l3208"><span class="linenum">3208</span></a>          }
<a name="l3209"><span class="linenum">3209</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l3210"><span class="linenum">3210</span></a>      }
<a name="l3211"><span class="linenum">3211</span></a>  
<a name="l3212"><span class="linenum">3212</span></a>      <span class="comment">/**</span>
<a name="l3213"><span class="linenum">3213</span></a>  <span class="comment">     * Process a course competency settings.</span>
<a name="l3214"><span class="linenum">3214</span></a>  <span class="comment">     *</span>
<a name="l3215"><span class="linenum">3215</span></a>  <span class="comment">     * @param array $data The data.</span>
<a name="l3216"><span class="linenum">3216</span></a>  <span class="comment">     */</span>
<a name="l3217"><span class="linenum">3217</span></a>      public function <a class="function" onClick="logFunction('process_course_competency_settings')" href="../../_functions/process_course_competency_settings.html" onMouseOver="funcPopup(event,'process_course_competency_settings')">process_course_competency_settings</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l3218"><span class="linenum">3218</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l3219"><span class="linenum">3219</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object) <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l3220"><span class="linenum">3220</span></a>  
<a name="l3221"><span class="linenum">3221</span></a>  <span class="comment">        // We do not restore the course settings during merge.</span>
<a name="l3222"><span class="linenum">3222</span></a>          <a class="var it713" onMouseOver="hilite(713)" onMouseOut="lolite()" onClick="logVariable('target')" href="../../_variables/target.html">$target</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_task')" href="../../_functions/get_task.html" onMouseOver="funcPopup(event,'get_task')">get_task</a>()-&gt;<a class="function" onClick="logFunction('get_target')" href="../../_functions/get_target.html" onMouseOver="funcPopup(event,'get_target')">get_target</a>();
<a name="l3223"><span class="linenum">3223</span></a>          if (<a class="var it713" onMouseOver="hilite(713)" onMouseOut="lolite()" onClick="logVariable('target')" href="../../_variables/target.html">$target</a> == backup::TARGET_CURRENT_ADDING || <a class="var it713" onMouseOver="hilite(713)" onMouseOut="lolite()" onClick="logVariable('target')" href="../../_variables/target.html">$target</a> == backup::TARGET_EXISTING_ADDING) {
<a name="l3224"><span class="linenum">3224</span></a>              return;
<a name="l3225"><span class="linenum">3225</span></a>          }
<a name="l3226"><span class="linenum">3226</span></a>  
<a name="l3227"><span class="linenum">3227</span></a>          <a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l3228"><span class="linenum">3228</span></a>          <a class="var it2527" onMouseOver="hilite(2527)" onMouseOut="lolite()" onClick="logVariable('exists')" href="../../_variables/exists.html">$exists</a> = \core_competency\<a class="class" onClick="logClass('course_competency_settings')" href="../../_classes/course_competency_settings.html" onMouseOver="classPopup(event,'course_competency_settings')">course_competency_settings</a>::<a class="function" onClick="logFunction('record_exists_select')" href="../../_functions/record_exists_select.html" onMouseOver="funcPopup(event,'record_exists_select')">record_exists_select</a>('courseid = :courseid',
<a name="l3229"><span class="linenum">3229</span></a>              array('courseid' =&gt; <a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>));
<a name="l3230"><span class="linenum">3230</span></a>  
<a name="l3231"><span class="linenum">3231</span></a>  <span class="comment">        // Strangely the course settings already exist, let's just leave them as is then.</span>
<a name="l3232"><span class="linenum">3232</span></a>          if (<a class="var it2527" onMouseOver="hilite(2527)" onMouseOut="lolite()" onClick="logVariable('exists')" href="../../_variables/exists.html">$exists</a>) {
<a name="l3233"><span class="linenum">3233</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="phpfunction" onClick="logFunction('log')" href="../../_functions/log.html" onMouseOver="phpfuncPopup(event,'log')">log</a>('Course competency settings not restored, existing settings have been found.', backup::LOG_WARNING);
<a name="l3234"><span class="linenum">3234</span></a>              return;
<a name="l3235"><span class="linenum">3235</span></a>          }
<a name="l3236"><span class="linenum">3236</span></a>  
<a name="l3237"><span class="linenum">3237</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object) array('courseid' =&gt; <a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>, 'pushratingstouserplans' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('pushratingstouserplans')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/pushratingstouserplans.html">pushratingstouserplans</a>);
<a name="l3238"><span class="linenum">3238</span></a>          <a class="var it18" onMouseOver="hilite(18)" onMouseOut="lolite()" onClick="logVariable('settings')" href="../../_variables/settings.html">$settings</a> = new \core_competency\course_competency_settings(0, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l3239"><span class="linenum">3239</span></a>          <a class="var it18" onMouseOver="hilite(18)" onMouseOut="lolite()" onClick="logVariable('settings')" href="../../_variables/settings.html">$settings</a>-&gt;<a class="function" onClick="logFunction('create')" href="../../_functions/create.html" onMouseOver="funcPopup(event,'create')">create</a>();
<a name="l3240"><span class="linenum">3240</span></a>      }
<a name="l3241"><span class="linenum">3241</span></a>  
<a name="l3242"><span class="linenum">3242</span></a>      <span class="comment">/**</span>
<a name="l3243"><span class="linenum">3243</span></a>  <span class="comment">     * Process a course competency.</span>
<a name="l3244"><span class="linenum">3244</span></a>  <span class="comment">     *</span>
<a name="l3245"><span class="linenum">3245</span></a>  <span class="comment">     * @param array $data The data.</span>
<a name="l3246"><span class="linenum">3246</span></a>  <span class="comment">     */</span>
<a name="l3247"><span class="linenum">3247</span></a>      public function <a class="function" onClick="logFunction('process_course_competency')" href="../../_functions/process_course_competency.html" onMouseOver="funcPopup(event,'process_course_competency')">process_course_competency</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l3248"><span class="linenum">3248</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object) <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l3249"><span class="linenum">3249</span></a>  
<a name="l3250"><span class="linenum">3250</span></a>  <span class="comment">        // Mapping the competency by ID numbers.</span>
<a name="l3251"><span class="linenum">3251</span></a>          <a class="var it2285" onMouseOver="hilite(2285)" onMouseOut="lolite()" onClick="logVariable('framework')" href="../../_variables/framework.html">$framework</a> = \core_competency\<a class="class" onClick="logClass('competency_framework')" href="../../_classes/competency_framework.html" onMouseOver="classPopup(event,'competency_framework')">competency_framework</a>::<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>(array('idnumber' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('frameworkidnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/frameworkidnumber.html">frameworkidnumber</a>));
<a name="l3252"><span class="linenum">3252</span></a>          if (!<a class="var it2285" onMouseOver="hilite(2285)" onMouseOut="lolite()" onClick="logVariable('framework')" href="../../_variables/framework.html">$framework</a>) {
<a name="l3253"><span class="linenum">3253</span></a>              return;
<a name="l3254"><span class="linenum">3254</span></a>          }
<a name="l3255"><span class="linenum">3255</span></a>          <a class="var it2286" onMouseOver="hilite(2286)" onMouseOut="lolite()" onClick="logVariable('competency')" href="../../_variables/competency.html">$competency</a> = \core_competency\<a class="class" onClick="logClass('competency')" href="../../_classes/competency.html" onMouseOver="classPopup(event,'competency')">competency</a>::<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>(array('idnumber' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>,
<a name="l3256"><span class="linenum">3256</span></a>              'competencyframeworkid' =&gt; <a class="var it2285" onMouseOver="hilite(2285)" onMouseOut="lolite()" onClick="logVariable('framework')" href="../../_variables/framework.html">$framework</a>-&gt;<a class="function" onClick="logFunction('get_id')" href="../../_functions/get_id.html" onMouseOver="funcPopup(event,'get_id')">get_id</a>()));
<a name="l3257"><span class="linenum">3257</span></a>          if (!<a class="var it2286" onMouseOver="hilite(2286)" onMouseOut="lolite()" onClick="logVariable('competency')" href="../../_variables/competency.html">$competency</a>) {
<a name="l3258"><span class="linenum">3258</span></a>              return;
<a name="l3259"><span class="linenum">3259</span></a>          }
<a name="l3260"><span class="linenum">3260</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>(\core_competency\<a class="class" onClick="logClass('competency')" href="../../_classes/competency.html" onMouseOver="classPopup(event,'competency')">competency</a>::TABLE, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, <a class="var it2286" onMouseOver="hilite(2286)" onMouseOut="lolite()" onClick="logVariable('competency')" href="../../_variables/competency.html">$competency</a>-&gt;<a class="function" onClick="logFunction('get_id')" href="../../_functions/get_id.html" onMouseOver="funcPopup(event,'get_id')">get_id</a>());
<a name="l3261"><span class="linenum">3261</span></a>  
<a name="l3262"><span class="linenum">3262</span></a>          <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array(
<a name="l3263"><span class="linenum">3263</span></a>              'competencyid' =&gt; <a class="var it2286" onMouseOver="hilite(2286)" onMouseOut="lolite()" onClick="logVariable('competency')" href="../../_variables/competency.html">$competency</a>-&gt;<a class="function" onClick="logFunction('get_id')" href="../../_functions/get_id.html" onMouseOver="funcPopup(event,'get_id')">get_id</a>(),
<a name="l3264"><span class="linenum">3264</span></a>              'courseid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>()
<a name="l3265"><span class="linenum">3265</span></a>          );
<a name="l3266"><span class="linenum">3266</span></a>          <a class="var it249" onMouseOver="hilite(249)" onMouseOut="lolite()" onClick="logVariable('query')" href="../../_variables/query.html">$query</a> = 'competencyid = :competencyid AND courseid = :courseid';
<a name="l3267"><span class="linenum">3267</span></a>          <a class="var it10898" onMouseOver="hilite(10898)" onMouseOut="lolite()" onClick="logVariable('existing')" href="../../_variables/existing.html">$existing</a> = \core_competency\<a class="class" onClick="logClass('course_competency')" href="../../_classes/course_competency.html" onMouseOver="classPopup(event,'course_competency')">course_competency</a>::<a class="function" onClick="logFunction('record_exists_select')" href="../../_functions/record_exists_select.html" onMouseOver="funcPopup(event,'record_exists_select')">record_exists_select</a>(<a class="var it249" onMouseOver="hilite(249)" onMouseOut="lolite()" onClick="logVariable('query')" href="../../_variables/query.html">$query</a>, <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l3268"><span class="linenum">3268</span></a>  
<a name="l3269"><span class="linenum">3269</span></a>          if (!<a class="var it10898" onMouseOver="hilite(10898)" onMouseOut="lolite()" onClick="logVariable('existing')" href="../../_variables/existing.html">$existing</a>) {
<a name="l3270"><span class="linenum">3270</span></a>  <span class="comment">            // Sortorder is ignored by precaution, anyway we should walk through the records in the right order.</span>
<a name="l3271"><span class="linenum">3271</span></a>              <a class="var it699" onMouseOver="hilite(699)" onMouseOut="lolite()" onClick="logVariable('record')" href="../../_variables/record.html">$record</a> = (object) <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>;
<a name="l3272"><span class="linenum">3272</span></a>              <a class="var it699" onMouseOver="hilite(699)" onMouseOut="lolite()" onClick="logVariable('record')" href="../../_variables/record.html">$record</a>-&gt;<a onClick="logVariable('ruleoutcome')" class="var it42976" onMouseOver="hilite(42976)" onMouseOut="lolite()" href="../../_variables/ruleoutcome.html">ruleoutcome</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('ruleoutcome')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/ruleoutcome.html">ruleoutcome</a>;
<a name="l3273"><span class="linenum">3273</span></a>              <a class="var it9654" onMouseOver="hilite(9654)" onMouseOut="lolite()" onClick="logVariable('coursecompetency')" href="../../_variables/coursecompetency.html">$coursecompetency</a> = new \core_competency\course_competency(0, <a class="var it699" onMouseOver="hilite(699)" onMouseOut="lolite()" onClick="logVariable('record')" href="../../_variables/record.html">$record</a>);
<a name="l3274"><span class="linenum">3274</span></a>              <a class="var it9654" onMouseOver="hilite(9654)" onMouseOut="lolite()" onClick="logVariable('coursecompetency')" href="../../_variables/coursecompetency.html">$coursecompetency</a>-&gt;<a class="function" onClick="logFunction('create')" href="../../_functions/create.html" onMouseOver="funcPopup(event,'create')">create</a>();
<a name="l3275"><span class="linenum">3275</span></a>          }
<a name="l3276"><span class="linenum">3276</span></a>      }
<a name="l3277"><span class="linenum">3277</span></a>  
<a name="l3278"><span class="linenum">3278</span></a>      <span class="comment">/**</span>
<a name="l3279"><span class="linenum">3279</span></a>  <span class="comment">     * Process the user competency course.</span>
<a name="l3280"><span class="linenum">3280</span></a>  <span class="comment">     *</span>
<a name="l3281"><span class="linenum">3281</span></a>  <span class="comment">     * @param array $data The data.</span>
<a name="l3282"><span class="linenum">3282</span></a>  <span class="comment">     */</span>
<a name="l3283"><span class="linenum">3283</span></a>      public function <a class="function" onClick="logFunction('process_user_competency_course')" href="../../_functions/process_user_competency_course.html" onMouseOver="funcPopup(event,'process_user_competency_course')">process_user_competency_course</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l3284"><span class="linenum">3284</span></a>          global <a class="var it354" onMouseOver="hilite(354)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>, <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l3285"><span class="linenum">3285</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object) <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l3286"><span class="linenum">3286</span></a>  
<a name="l3287"><span class="linenum">3287</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('competencyid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/competencyid.html">competencyid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>(\core_competency\<a class="class" onClick="logClass('competency')" href="../../_classes/competency.html" onMouseOver="classPopup(event,'competency')">competency</a>::TABLE, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('competencyid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/competencyid.html">competencyid</a>);
<a name="l3288"><span class="linenum">3288</span></a>          if (!<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('competencyid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/competencyid.html">competencyid</a>) {
<a name="l3289"><span class="linenum">3289</span></a>  <span class="comment">            // This is strange, the competency does not belong to the course.</span>
<a name="l3290"><span class="linenum">3290</span></a>              return;
<a name="l3291"><span class="linenum">3291</span></a>          } else if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('grade')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/grade.html">grade</a> === null) {
<a name="l3292"><span class="linenum">3292</span></a>  <span class="comment">            // We do not need to do anything when there is no grade.</span>
<a name="l3293"><span class="linenum">3293</span></a>              return;
<a name="l3294"><span class="linenum">3294</span></a>          }
<a name="l3295"><span class="linenum">3295</span></a>  
<a name="l3296"><span class="linenum">3296</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>);
<a name="l3297"><span class="linenum">3297</span></a>          <a class="var it911" onMouseOver="hilite(911)" onMouseOut="lolite()" onClick="logVariable('shortname')" href="../../_variables/shortname.html">$shortname</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('course', 'shortname', array('id' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>()), <a class="constant" onClick="logConstant('MUST_EXIST')" href="../../_constants/MUST_EXIST.html" onMouseOver="constPopup(event,'MUST_EXIST')">MUST_EXIST</a>);
<a name="l3298"><span class="linenum">3298</span></a>  
<a name="l3299"><span class="linenum">3299</span></a>  <span class="comment">        // The method add_evidence also sets the course rating.</span>
<a name="l3300"><span class="linenum">3300</span></a>          \core_competency\<a class="class" onClick="logClass('api')" href="../../_classes/api.html" onMouseOver="classPopup(event,'api')">api</a>::<a class="function" onClick="logFunction('add_evidence')" href="../../_functions/add_evidence.html" onMouseOver="funcPopup(event,'add_evidence')">add_evidence</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>,
<a name="l3301"><span class="linenum">3301</span></a>                                             <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('competencyid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/competencyid.html">competencyid</a>,
<a name="l3302"><span class="linenum">3302</span></a>                                             <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_contextid')" href="../../_functions/get_contextid.html" onMouseOver="funcPopup(event,'get_contextid')">get_contextid</a>(),
<a name="l3303"><span class="linenum">3303</span></a>                                             \core_competency\<a class="class" onClick="logClass('evidence')" href="../../_classes/evidence.html" onMouseOver="classPopup(event,'evidence')">evidence</a>::ACTION_OVERRIDE,
<a name="l3304"><span class="linenum">3304</span></a>                                             'evidence_courserestored',
<a name="l3305"><span class="linenum">3305</span></a>                                             'core_competency',
<a name="l3306"><span class="linenum">3306</span></a>                                             <a class="var it911" onMouseOver="hilite(911)" onMouseOut="lolite()" onClick="logVariable('shortname')" href="../../_variables/shortname.html">$shortname</a>,
<a name="l3307"><span class="linenum">3307</span></a>                                             false,
<a name="l3308"><span class="linenum">3308</span></a>                                             null,
<a name="l3309"><span class="linenum">3309</span></a>                                             <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('grade')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/grade.html">grade</a>,
<a name="l3310"><span class="linenum">3310</span></a>                                             <a class="var it354" onMouseOver="hilite(354)" onMouseOut="lolite()" onClick="logVariable('USER')" href="../../_variables/USER.html">$USER</a>-&gt;<a onClick="logVariable('id')" class="var it42989" onMouseOver="hilite(42989)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>);
<a name="l3311"><span class="linenum">3311</span></a>      }
<a name="l3312"><span class="linenum">3312</span></a>  
<a name="l3313"><span class="linenum">3313</span></a>      <span class="comment">/**</span>
<a name="l3314"><span class="linenum">3314</span></a>  <span class="comment">     * Execute conditions.</span>
<a name="l3315"><span class="linenum">3315</span></a>  <span class="comment">     *</span>
<a name="l3316"><span class="linenum">3316</span></a>  <span class="comment">     * @return bool</span>
<a name="l3317"><span class="linenum">3317</span></a>  <span class="comment">     */</span>
<a name="l3318"><span class="linenum">3318</span></a>      protected function <a class="function" onClick="logFunction('execute_condition')" href="../../_functions/execute_condition.html" onMouseOver="funcPopup(event,'execute_condition')">execute_condition</a>() {
<a name="l3319"><span class="linenum">3319</span></a>  
<a name="l3320"><span class="linenum">3320</span></a>  <span class="comment">        // Do not execute if competencies are not included.</span>
<a name="l3321"><span class="linenum">3321</span></a>          if (!<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('competencies')) {
<a name="l3322"><span class="linenum">3322</span></a>              return false;
<a name="l3323"><span class="linenum">3323</span></a>          }
<a name="l3324"><span class="linenum">3324</span></a>  
<a name="l3325"><span class="linenum">3325</span></a>  <span class="comment">        // Do not execute if the competencies XML file is not found.</span>
<a name="l3326"><span class="linenum">3326</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_taskbasepath')" href="../../_functions/get_taskbasepath.html" onMouseOver="funcPopup(event,'get_taskbasepath')">get_taskbasepath</a>();
<a name="l3327"><span class="linenum">3327</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="phpfunction" onClick="logFunction('rtrim')" href="../../_functions/rtrim.html" onMouseOver="phpfuncPopup(event,'rtrim')">rtrim</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>, '/') . '/' . <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('filename')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/filename.html">filename</a>;
<a name="l3328"><span class="linenum">3328</span></a>          if (!<a class="phpfunction" onClick="logFunction('file_exists')" href="../../_functions/file_exists.html" onMouseOver="phpfuncPopup(event,'file_exists')">file_exists</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>)) {
<a name="l3329"><span class="linenum">3329</span></a>              return false;
<a name="l3330"><span class="linenum">3330</span></a>          }
<a name="l3331"><span class="linenum">3331</span></a>  
<a name="l3332"><span class="linenum">3332</span></a>          return true;
<a name="l3333"><span class="linenum">3333</span></a>      }
<a name="l3334"><span class="linenum">3334</span></a>  }
<a name="l3335"><span class="linenum">3335</span></a>  
<a name="l3336"><span class="linenum">3336</span></a>  <span class="comment">/**</span>
<a name="l3337"><span class="linenum">3337</span></a>  <span class="comment"> * Restore activity competencies structure step.</span>
<a name="l3338"><span class="linenum">3338</span></a>  <span class="comment"> */</span>
<a name="l3339"><span class="linenum">3339</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_activity_competencies_structure_step')" href="../../_classes/restore_activity_competencies_structure_step.html" onMouseOver="classPopup(event,'restore_activity_competencies_structure_step')">restore_activity_competencies_structure_step</a> extends restore_structure_step {
<a name="l3340"><span class="linenum">3340</span></a>  
<a name="l3341"><span class="linenum">3341</span></a>      <span class="comment">/**</span>
<a name="l3342"><span class="linenum">3342</span></a>  <span class="comment">     * Defines the structure.</span>
<a name="l3343"><span class="linenum">3343</span></a>  <span class="comment">     *</span>
<a name="l3344"><span class="linenum">3344</span></a>  <span class="comment">     * @return array</span>
<a name="l3345"><span class="linenum">3345</span></a>  <span class="comment">     */</span>
<a name="l3346"><span class="linenum">3346</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l3347"><span class="linenum">3347</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array(
<a name="l3348"><span class="linenum">3348</span></a>              <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('course_module_competency', '/course_module_competencies/competencies/competency')
<a name="l3349"><span class="linenum">3349</span></a>          );
<a name="l3350"><span class="linenum">3350</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l3351"><span class="linenum">3351</span></a>      }
<a name="l3352"><span class="linenum">3352</span></a>  
<a name="l3353"><span class="linenum">3353</span></a>      <span class="comment">/**</span>
<a name="l3354"><span class="linenum">3354</span></a>  <span class="comment">     * Process a course module competency.</span>
<a name="l3355"><span class="linenum">3355</span></a>  <span class="comment">     *</span>
<a name="l3356"><span class="linenum">3356</span></a>  <span class="comment">     * @param array $data The data.</span>
<a name="l3357"><span class="linenum">3357</span></a>  <span class="comment">     */</span>
<a name="l3358"><span class="linenum">3358</span></a>      public function <a class="function" onClick="logFunction('process_course_module_competency')" href="../../_functions/process_course_module_competency.html" onMouseOver="funcPopup(event,'process_course_module_competency')">process_course_module_competency</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l3359"><span class="linenum">3359</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object) <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l3360"><span class="linenum">3360</span></a>  
<a name="l3361"><span class="linenum">3361</span></a>  <span class="comment">        // Mapping the competency by ID numbers.</span>
<a name="l3362"><span class="linenum">3362</span></a>          <a class="var it2285" onMouseOver="hilite(2285)" onMouseOut="lolite()" onClick="logVariable('framework')" href="../../_variables/framework.html">$framework</a> = \core_competency\<a class="class" onClick="logClass('competency_framework')" href="../../_classes/competency_framework.html" onMouseOver="classPopup(event,'competency_framework')">competency_framework</a>::<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>(array('idnumber' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('frameworkidnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/frameworkidnumber.html">frameworkidnumber</a>));
<a name="l3363"><span class="linenum">3363</span></a>          if (!<a class="var it2285" onMouseOver="hilite(2285)" onMouseOut="lolite()" onClick="logVariable('framework')" href="../../_variables/framework.html">$framework</a>) {
<a name="l3364"><span class="linenum">3364</span></a>              return;
<a name="l3365"><span class="linenum">3365</span></a>          }
<a name="l3366"><span class="linenum">3366</span></a>          <a class="var it2286" onMouseOver="hilite(2286)" onMouseOut="lolite()" onClick="logVariable('competency')" href="../../_variables/competency.html">$competency</a> = \core_competency\<a class="class" onClick="logClass('competency')" href="../../_classes/competency.html" onMouseOver="classPopup(event,'competency')">competency</a>::<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>(array('idnumber' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>,
<a name="l3367"><span class="linenum">3367</span></a>              'competencyframeworkid' =&gt; <a class="var it2285" onMouseOver="hilite(2285)" onMouseOut="lolite()" onClick="logVariable('framework')" href="../../_variables/framework.html">$framework</a>-&gt;<a class="function" onClick="logFunction('get_id')" href="../../_functions/get_id.html" onMouseOver="funcPopup(event,'get_id')">get_id</a>()));
<a name="l3368"><span class="linenum">3368</span></a>          if (!<a class="var it2286" onMouseOver="hilite(2286)" onMouseOut="lolite()" onClick="logVariable('competency')" href="../../_variables/competency.html">$competency</a>) {
<a name="l3369"><span class="linenum">3369</span></a>              return;
<a name="l3370"><span class="linenum">3370</span></a>          }
<a name="l3371"><span class="linenum">3371</span></a>  
<a name="l3372"><span class="linenum">3372</span></a>          <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array(
<a name="l3373"><span class="linenum">3373</span></a>              'competencyid' =&gt; <a class="var it2286" onMouseOver="hilite(2286)" onMouseOut="lolite()" onClick="logVariable('competency')" href="../../_variables/competency.html">$competency</a>-&gt;<a class="function" onClick="logFunction('get_id')" href="../../_functions/get_id.html" onMouseOver="funcPopup(event,'get_id')">get_id</a>(),
<a name="l3374"><span class="linenum">3374</span></a>              'cmid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_moduleid')" href="../../_functions/get_moduleid.html" onMouseOver="funcPopup(event,'get_moduleid')">get_moduleid</a>()
<a name="l3375"><span class="linenum">3375</span></a>          );
<a name="l3376"><span class="linenum">3376</span></a>          <a class="var it249" onMouseOver="hilite(249)" onMouseOut="lolite()" onClick="logVariable('query')" href="../../_variables/query.html">$query</a> = 'competencyid = :competencyid AND cmid = :cmid';
<a name="l3377"><span class="linenum">3377</span></a>          <a class="var it10898" onMouseOver="hilite(10898)" onMouseOut="lolite()" onClick="logVariable('existing')" href="../../_variables/existing.html">$existing</a> = \core_competency\<a class="class" onClick="logClass('course_module_competency')" href="../../_classes/course_module_competency.html" onMouseOver="classPopup(event,'course_module_competency')">course_module_competency</a>::<a class="function" onClick="logFunction('record_exists_select')" href="../../_functions/record_exists_select.html" onMouseOver="funcPopup(event,'record_exists_select')">record_exists_select</a>(<a class="var it249" onMouseOver="hilite(249)" onMouseOut="lolite()" onClick="logVariable('query')" href="../../_variables/query.html">$query</a>, <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l3378"><span class="linenum">3378</span></a>  
<a name="l3379"><span class="linenum">3379</span></a>          if (!<a class="var it10898" onMouseOver="hilite(10898)" onMouseOut="lolite()" onClick="logVariable('existing')" href="../../_variables/existing.html">$existing</a>) {
<a name="l3380"><span class="linenum">3380</span></a>  <span class="comment">            // Sortorder is ignored by precaution, anyway we should walk through the records in the right order.</span>
<a name="l3381"><span class="linenum">3381</span></a>              <a class="var it699" onMouseOver="hilite(699)" onMouseOut="lolite()" onClick="logVariable('record')" href="../../_variables/record.html">$record</a> = (object) <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>;
<a name="l3382"><span class="linenum">3382</span></a>              <a class="var it699" onMouseOver="hilite(699)" onMouseOut="lolite()" onClick="logVariable('record')" href="../../_variables/record.html">$record</a>-&gt;<a onClick="logVariable('ruleoutcome')" class="var it42976" onMouseOver="hilite(42976)" onMouseOut="lolite()" href="../../_variables/ruleoutcome.html">ruleoutcome</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('ruleoutcome')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/ruleoutcome.html">ruleoutcome</a>;
<a name="l3383"><span class="linenum">3383</span></a>              <a class="var it15433" onMouseOver="hilite(15433)" onMouseOut="lolite()" onClick="logVariable('coursemodulecompetency')" href="../../_variables/coursemodulecompetency.html">$coursemodulecompetency</a> = new \core_competency\course_module_competency(0, <a class="var it699" onMouseOver="hilite(699)" onMouseOut="lolite()" onClick="logVariable('record')" href="../../_variables/record.html">$record</a>);
<a name="l3384"><span class="linenum">3384</span></a>              <a class="var it15433" onMouseOver="hilite(15433)" onMouseOut="lolite()" onClick="logVariable('coursemodulecompetency')" href="../../_variables/coursemodulecompetency.html">$coursemodulecompetency</a>-&gt;<a class="function" onClick="logFunction('create')" href="../../_functions/create.html" onMouseOver="funcPopup(event,'create')">create</a>();
<a name="l3385"><span class="linenum">3385</span></a>          }
<a name="l3386"><span class="linenum">3386</span></a>      }
<a name="l3387"><span class="linenum">3387</span></a>  
<a name="l3388"><span class="linenum">3388</span></a>      <span class="comment">/**</span>
<a name="l3389"><span class="linenum">3389</span></a>  <span class="comment">     * Execute conditions.</span>
<a name="l3390"><span class="linenum">3390</span></a>  <span class="comment">     *</span>
<a name="l3391"><span class="linenum">3391</span></a>  <span class="comment">     * @return bool</span>
<a name="l3392"><span class="linenum">3392</span></a>  <span class="comment">     */</span>
<a name="l3393"><span class="linenum">3393</span></a>      protected function <a class="function" onClick="logFunction('execute_condition')" href="../../_functions/execute_condition.html" onMouseOver="funcPopup(event,'execute_condition')">execute_condition</a>() {
<a name="l3394"><span class="linenum">3394</span></a>  
<a name="l3395"><span class="linenum">3395</span></a>  <span class="comment">        // Do not execute if competencies are not included.</span>
<a name="l3396"><span class="linenum">3396</span></a>          if (!<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('competencies')) {
<a name="l3397"><span class="linenum">3397</span></a>              return false;
<a name="l3398"><span class="linenum">3398</span></a>          }
<a name="l3399"><span class="linenum">3399</span></a>  
<a name="l3400"><span class="linenum">3400</span></a>  <span class="comment">        // Do not execute if the competencies XML file is not found.</span>
<a name="l3401"><span class="linenum">3401</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_taskbasepath')" href="../../_functions/get_taskbasepath.html" onMouseOver="funcPopup(event,'get_taskbasepath')">get_taskbasepath</a>();
<a name="l3402"><span class="linenum">3402</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="phpfunction" onClick="logFunction('rtrim')" href="../../_functions/rtrim.html" onMouseOver="phpfuncPopup(event,'rtrim')">rtrim</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>, '/') . '/' . <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('filename')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/filename.html">filename</a>;
<a name="l3403"><span class="linenum">3403</span></a>          if (!<a class="phpfunction" onClick="logFunction('file_exists')" href="../../_functions/file_exists.html" onMouseOver="phpfuncPopup(event,'file_exists')">file_exists</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>)) {
<a name="l3404"><span class="linenum">3404</span></a>              return false;
<a name="l3405"><span class="linenum">3405</span></a>          }
<a name="l3406"><span class="linenum">3406</span></a>  
<a name="l3407"><span class="linenum">3407</span></a>          return true;
<a name="l3408"><span class="linenum">3408</span></a>      }
<a name="l3409"><span class="linenum">3409</span></a>  }
<a name="l3410"><span class="linenum">3410</span></a>  
<a name="l3411"><span class="linenum">3411</span></a>  <span class="comment">/**</span>
<a name="l3412"><span class="linenum">3412</span></a>  <span class="comment"> * Defines the restore step for advanced grading methods attached to the activity module</span>
<a name="l3413"><span class="linenum">3413</span></a>  <span class="comment"> */</span>
<a name="l3414"><span class="linenum">3414</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_activity_grading_structure_step')" href="../../_classes/restore_activity_grading_structure_step.html" onMouseOver="classPopup(event,'restore_activity_grading_structure_step')">restore_activity_grading_structure_step</a> extends restore_structure_step {
<a name="l3415"><span class="linenum">3415</span></a>  
<a name="l3416"><span class="linenum">3416</span></a>      <span class="comment">/**</span>
<a name="l3417"><span class="linenum">3417</span></a>  <span class="comment">     * This step is executed only if the grading file is present</span>
<a name="l3418"><span class="linenum">3418</span></a>  <span class="comment">     */</span>
<a name="l3419"><span class="linenum">3419</span></a>       protected function <a class="function" onClick="logFunction('execute_condition')" href="../../_functions/execute_condition.html" onMouseOver="funcPopup(event,'execute_condition')">execute_condition</a>() {
<a name="l3420"><span class="linenum">3420</span></a>  
<a name="l3421"><span class="linenum">3421</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>() == <a class="constant" onClick="logConstant('SITEID')" href="../../_constants/SITEID.html" onMouseOver="constPopup(event,'SITEID')">SITEID</a>) {
<a name="l3422"><span class="linenum">3422</span></a>              return false;
<a name="l3423"><span class="linenum">3423</span></a>          }
<a name="l3424"><span class="linenum">3424</span></a>  
<a name="l3425"><span class="linenum">3425</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_taskbasepath')" href="../../_functions/get_taskbasepath.html" onMouseOver="funcPopup(event,'get_taskbasepath')">get_taskbasepath</a>();
<a name="l3426"><span class="linenum">3426</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="phpfunction" onClick="logFunction('rtrim')" href="../../_functions/rtrim.html" onMouseOver="phpfuncPopup(event,'rtrim')">rtrim</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>, '/') . '/' . <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('filename')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/filename.html">filename</a>;
<a name="l3427"><span class="linenum">3427</span></a>          if (!<a class="phpfunction" onClick="logFunction('file_exists')" href="../../_functions/file_exists.html" onMouseOver="phpfuncPopup(event,'file_exists')">file_exists</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>)) {
<a name="l3428"><span class="linenum">3428</span></a>              return false;
<a name="l3429"><span class="linenum">3429</span></a>          }
<a name="l3430"><span class="linenum">3430</span></a>  
<a name="l3431"><span class="linenum">3431</span></a>          return true;
<a name="l3432"><span class="linenum">3432</span></a>      }
<a name="l3433"><span class="linenum">3433</span></a>  
<a name="l3434"><span class="linenum">3434</span></a>  
<a name="l3435"><span class="linenum">3435</span></a>      <span class="comment">/**</span>
<a name="l3436"><span class="linenum">3436</span></a>  <span class="comment">     * Declares paths in the grading.xml file we are interested in</span>
<a name="l3437"><span class="linenum">3437</span></a>  <span class="comment">     */</span>
<a name="l3438"><span class="linenum">3438</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l3439"><span class="linenum">3439</span></a>  
<a name="l3440"><span class="linenum">3440</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array();
<a name="l3441"><span class="linenum">3441</span></a>          <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('userinfo')" href="../../_variables/userinfo.html">$userinfo</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('userinfo');
<a name="l3442"><span class="linenum">3442</span></a>  
<a name="l3443"><span class="linenum">3443</span></a>          <a class="var it1044" onMouseOver="hilite(1044)" onMouseOut="lolite()" onClick="logVariable('area')" href="../../_variables/area.html">$area</a> = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('grading_area', '/areas/area');
<a name="l3444"><span class="linenum">3444</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <a class="var it1044" onMouseOver="hilite(1044)" onMouseOut="lolite()" onClick="logVariable('area')" href="../../_variables/area.html">$area</a>;
<a name="l3445"><span class="linenum">3445</span></a>  <span class="comment">        // attach local plugin stucture to $area element</span>
<a name="l3446"><span class="linenum">3446</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('local', <a class="var it1044" onMouseOver="hilite(1044)" onMouseOut="lolite()" onClick="logVariable('area')" href="../../_variables/area.html">$area</a>);
<a name="l3447"><span class="linenum">3447</span></a>  
<a name="l3448"><span class="linenum">3448</span></a>          <a class="var it407" onMouseOver="hilite(407)" onMouseOut="lolite()" onClick="logVariable('definition')" href="../../_variables/definition.html">$definition</a> = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('grading_definition', '/areas/area/definitions/definition');
<a name="l3449"><span class="linenum">3449</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <a class="var it407" onMouseOver="hilite(407)" onMouseOut="lolite()" onClick="logVariable('definition')" href="../../_variables/definition.html">$definition</a>;
<a name="l3450"><span class="linenum">3450</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('gradingform', <a class="var it407" onMouseOver="hilite(407)" onMouseOut="lolite()" onClick="logVariable('definition')" href="../../_variables/definition.html">$definition</a>);
<a name="l3451"><span class="linenum">3451</span></a>  <span class="comment">        // attach local plugin stucture to $definition element</span>
<a name="l3452"><span class="linenum">3452</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('local', <a class="var it407" onMouseOver="hilite(407)" onMouseOut="lolite()" onClick="logVariable('definition')" href="../../_variables/definition.html">$definition</a>);
<a name="l3453"><span class="linenum">3453</span></a>  
<a name="l3454"><span class="linenum">3454</span></a>  
<a name="l3455"><span class="linenum">3455</span></a>          if (<a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('userinfo')" href="../../_variables/userinfo.html">$userinfo</a>) {
<a name="l3456"><span class="linenum">3456</span></a>              <a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('instance')" href="../../_variables/instance.html">$instance</a> = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('grading_instance',
<a name="l3457"><span class="linenum">3457</span></a>                  '/areas/area/definitions/definition/instances/instance');
<a name="l3458"><span class="linenum">3458</span></a>              <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('instance')" href="../../_variables/instance.html">$instance</a>;
<a name="l3459"><span class="linenum">3459</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('gradingform', <a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('instance')" href="../../_variables/instance.html">$instance</a>);
<a name="l3460"><span class="linenum">3460</span></a>  <span class="comment">            // attach local plugin stucture to $intance element</span>
<a name="l3461"><span class="linenum">3461</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('local', <a class="var it427" onMouseOver="hilite(427)" onMouseOut="lolite()" onClick="logVariable('instance')" href="../../_variables/instance.html">$instance</a>);
<a name="l3462"><span class="linenum">3462</span></a>          }
<a name="l3463"><span class="linenum">3463</span></a>  
<a name="l3464"><span class="linenum">3464</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l3465"><span class="linenum">3465</span></a>      }
<a name="l3466"><span class="linenum">3466</span></a>  
<a name="l3467"><span class="linenum">3467</span></a>      <span class="comment">/**</span>
<a name="l3468"><span class="linenum">3468</span></a>  <span class="comment">     * Processes one grading area element</span>
<a name="l3469"><span class="linenum">3469</span></a>  <span class="comment">     *</span>
<a name="l3470"><span class="linenum">3470</span></a>  <span class="comment">     * @param array $data element data</span>
<a name="l3471"><span class="linenum">3471</span></a>  <span class="comment">     */</span>
<a name="l3472"><span class="linenum">3472</span></a>      protected function <a class="function" onClick="logFunction('process_grading_area')" href="../../_functions/process_grading_area.html" onMouseOver="funcPopup(event,'process_grading_area')">process_grading_area</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l3473"><span class="linenum">3473</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l3474"><span class="linenum">3474</span></a>  
<a name="l3475"><span class="linenum">3475</span></a>          <a class="var it720" onMouseOver="hilite(720)" onMouseOut="lolite()" onClick="logVariable('task')" href="../../_variables/task.html">$task</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_task')" href="../../_functions/get_task.html" onMouseOver="funcPopup(event,'get_task')">get_task</a>();
<a name="l3476"><span class="linenum">3476</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l3477"><span class="linenum">3477</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l3478"><span class="linenum">3478</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('component')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/component.html">component</a> = 'mod_'.<a class="var it720" onMouseOver="hilite(720)" onMouseOut="lolite()" onClick="logVariable('task')" href="../../_variables/task.html">$task</a>-&gt;<a class="function" onClick="logFunction('get_modulename')" href="../../_functions/get_modulename.html" onMouseOver="funcPopup(event,'get_modulename')">get_modulename</a>();
<a name="l3479"><span class="linenum">3479</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('contextid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a> = <a class="var it720" onMouseOver="hilite(720)" onMouseOut="lolite()" onClick="logVariable('task')" href="../../_variables/task.html">$task</a>-&gt;<a class="function" onClick="logFunction('get_contextid')" href="../../_functions/get_contextid.html" onMouseOver="funcPopup(event,'get_contextid')">get_contextid</a>();
<a name="l3480"><span class="linenum">3480</span></a>  
<a name="l3481"><span class="linenum">3481</span></a>          <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('grading_areas', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l3482"><span class="linenum">3482</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('grading_area', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a>);
<a name="l3483"><span class="linenum">3483</span></a>      }
<a name="l3484"><span class="linenum">3484</span></a>  
<a name="l3485"><span class="linenum">3485</span></a>      <span class="comment">/**</span>
<a name="l3486"><span class="linenum">3486</span></a>  <span class="comment">     * Processes one grading definition element</span>
<a name="l3487"><span class="linenum">3487</span></a>  <span class="comment">     *</span>
<a name="l3488"><span class="linenum">3488</span></a>  <span class="comment">     * @param array $data element data</span>
<a name="l3489"><span class="linenum">3489</span></a>  <span class="comment">     */</span>
<a name="l3490"><span class="linenum">3490</span></a>      protected function <a class="function" onClick="logFunction('process_grading_definition')" href="../../_functions/process_grading_definition.html" onMouseOver="funcPopup(event,'process_grading_definition')">process_grading_definition</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l3491"><span class="linenum">3491</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l3492"><span class="linenum">3492</span></a>  
<a name="l3493"><span class="linenum">3493</span></a>          <a class="var it720" onMouseOver="hilite(720)" onMouseOut="lolite()" onClick="logVariable('task')" href="../../_variables/task.html">$task</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_task')" href="../../_functions/get_task.html" onMouseOver="funcPopup(event,'get_task')">get_task</a>();
<a name="l3494"><span class="linenum">3494</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l3495"><span class="linenum">3495</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l3496"><span class="linenum">3496</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('areaid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/areaid.html">areaid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_new_parentid')" href="../../_functions/get_new_parentid.html" onMouseOver="funcPopup(event,'get_new_parentid')">get_new_parentid</a>('grading_area');
<a name="l3497"><span class="linenum">3497</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('copiedfromid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/copiedfromid.html">copiedfromid</a> = null;
<a name="l3498"><span class="linenum">3498</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timecreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timecreated.html">timecreated</a> = <a class="phpfunction" onClick="logFunction('time')" href="../../_functions/time.html" onMouseOver="phpfuncPopup(event,'time')">time</a>();
<a name="l3499"><span class="linenum">3499</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usercreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usercreated.html">usercreated</a> = <a class="var it720" onMouseOver="hilite(720)" onMouseOut="lolite()" onClick="logVariable('task')" href="../../_variables/task.html">$task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>();
<a name="l3500"><span class="linenum">3500</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timemodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timemodified.html">timemodified</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timecreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timecreated.html">timecreated</a>;
<a name="l3501"><span class="linenum">3501</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usermodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usermodified.html">usermodified</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usercreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usercreated.html">usercreated</a>;
<a name="l3502"><span class="linenum">3502</span></a>  
<a name="l3503"><span class="linenum">3503</span></a>          <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('grading_definitions', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l3504"><span class="linenum">3504</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('grading_definition', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a>, true);
<a name="l3505"><span class="linenum">3505</span></a>      }
<a name="l3506"><span class="linenum">3506</span></a>  
<a name="l3507"><span class="linenum">3507</span></a>      <span class="comment">/**</span>
<a name="l3508"><span class="linenum">3508</span></a>  <span class="comment">     * Processes one grading form instance element</span>
<a name="l3509"><span class="linenum">3509</span></a>  <span class="comment">     *</span>
<a name="l3510"><span class="linenum">3510</span></a>  <span class="comment">     * @param array $data element data</span>
<a name="l3511"><span class="linenum">3511</span></a>  <span class="comment">     */</span>
<a name="l3512"><span class="linenum">3512</span></a>      protected function <a class="function" onClick="logFunction('process_grading_instance')" href="../../_functions/process_grading_instance.html" onMouseOver="funcPopup(event,'process_grading_instance')">process_grading_instance</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l3513"><span class="linenum">3513</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l3514"><span class="linenum">3514</span></a>  
<a name="l3515"><span class="linenum">3515</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l3516"><span class="linenum">3516</span></a>  
<a name="l3517"><span class="linenum">3517</span></a>  <span class="comment">        // new form definition id</span>
<a name="l3518"><span class="linenum">3518</span></a>          <a class="var it15434" onMouseOver="hilite(15434)" onMouseOut="lolite()" onClick="logVariable('newformid')" href="../../_variables/newformid.html">$newformid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_new_parentid')" href="../../_functions/get_new_parentid.html" onMouseOver="funcPopup(event,'get_new_parentid')">get_new_parentid</a>('grading_definition');
<a name="l3519"><span class="linenum">3519</span></a>  
<a name="l3520"><span class="linenum">3520</span></a>  <span class="comment">        // get the name of the area we are restoring to</span>
<a name="l3521"><span class="linenum">3521</span></a>          <a class="var it64" onMouseOver="hilite(64)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a> = &quot;SELECT ga.areaname
<a name="l3522"><span class="linenum">3522</span></a>                    FROM {grading_definitions} gd
<a name="l3523"><span class="linenum">3523</span></a>                    JOIN {grading_areas} ga ON gd.areaid = ga.id
<a name="l3524"><span class="linenum">3524</span></a>                   WHERE gd.id = ?&quot;;
<a name="l3525"><span class="linenum">3525</span></a>          <a class="var it2225" onMouseOver="hilite(2225)" onMouseOut="lolite()" onClick="logVariable('areaname')" href="../../_variables/areaname.html">$areaname</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field_sql')" href="../../_functions/get_field_sql.html" onMouseOver="funcPopup(event,'get_field_sql')">get_field_sql</a>(<a class="var it64" onMouseOver="hilite(64)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a>, array(<a class="var it15434" onMouseOver="hilite(15434)" onMouseOut="lolite()" onClick="logVariable('newformid')" href="../../_variables/newformid.html">$newformid</a>), <a class="constant" onClick="logConstant('MUST_EXIST')" href="../../_constants/MUST_EXIST.html" onMouseOver="constPopup(event,'MUST_EXIST')">MUST_EXIST</a>);
<a name="l3526"><span class="linenum">3526</span></a>  
<a name="l3527"><span class="linenum">3527</span></a>  <span class="comment">        // get the mapped itemid - the activity module is expected to define the mappings</span>
<a name="l3528"><span class="linenum">3528</span></a>  <span class="comment">        // for each gradable area</span>
<a name="l3529"><span class="linenum">3529</span></a>          <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>(restore_gradingform_plugin::<a class="function" onClick="logFunction('itemid_mapping')" href="../../_functions/itemid_mapping.html" onMouseOver="funcPopup(event,'itemid_mapping')">itemid_mapping</a>(<a class="var it2225" onMouseOver="hilite(2225)" onMouseOut="lolite()" onClick="logVariable('areaname')" href="../../_variables/areaname.html">$areaname</a>), <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>);
<a name="l3530"><span class="linenum">3530</span></a>  
<a name="l3531"><span class="linenum">3531</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l3532"><span class="linenum">3532</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('definitionid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/definitionid.html">definitionid</a> = <a class="var it15434" onMouseOver="hilite(15434)" onMouseOut="lolite()" onClick="logVariable('newformid')" href="../../_variables/newformid.html">$newformid</a>;
<a name="l3533"><span class="linenum">3533</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('raterid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/raterid.html">raterid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('raterid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/raterid.html">raterid</a>);
<a name="l3534"><span class="linenum">3534</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a> = <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>;
<a name="l3535"><span class="linenum">3535</span></a>  
<a name="l3536"><span class="linenum">3536</span></a>          <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('grading_instances', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l3537"><span class="linenum">3537</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('grading_instance', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it3717" onMouseOver="hilite(3717)" onMouseOut="lolite()" onClick="logVariable('newid')" href="../../_variables/newid.html">$newid</a>);
<a name="l3538"><span class="linenum">3538</span></a>      }
<a name="l3539"><span class="linenum">3539</span></a>  
<a name="l3540"><span class="linenum">3540</span></a>      <span class="comment">/**</span>
<a name="l3541"><span class="linenum">3541</span></a>  <span class="comment">     * Final operations when the database records are inserted</span>
<a name="l3542"><span class="linenum">3542</span></a>  <span class="comment">     */</span>
<a name="l3543"><span class="linenum">3543</span></a>      protected function <a class="function" onClick="logFunction('after_execute')" href="../../_functions/after_execute.html" onMouseOver="funcPopup(event,'after_execute')">after_execute</a>() {
<a name="l3544"><span class="linenum">3544</span></a>  <span class="comment">        // Add files embedded into the definition description</span>
<a name="l3545"><span class="linenum">3545</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_related_files')" href="../../_functions/add_related_files.html" onMouseOver="funcPopup(event,'add_related_files')">add_related_files</a>('grading', 'description', 'grading_definition');
<a name="l3546"><span class="linenum">3546</span></a>      }
<a name="l3547"><span class="linenum">3547</span></a>  }
<a name="l3548"><span class="linenum">3548</span></a>  
<a name="l3549"><span class="linenum">3549</span></a>  
<a name="l3550"><span class="linenum">3550</span></a>  <span class="comment">/**</span>
<a name="l3551"><span class="linenum">3551</span></a>  <span class="comment"> * This structure step restores the grade items associated with one activity</span>
<a name="l3552"><span class="linenum">3552</span></a>  <span class="comment"> * All the grade items are made child of the &quot;course&quot; grade item but the original</span>
<a name="l3553"><span class="linenum">3553</span></a>  <span class="comment"> * categoryid is saved as parentitemid in the backup_ids table, so, when restoring</span>
<a name="l3554"><span class="linenum">3554</span></a>  <span class="comment"> * the complete gradebook (categories and calculations), that information is</span>
<a name="l3555"><span class="linenum">3555</span></a>  <span class="comment"> * available there</span>
<a name="l3556"><span class="linenum">3556</span></a>  <span class="comment"> */</span>
<a name="l3557"><span class="linenum">3557</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_activity_grades_structure_step')" href="../../_classes/restore_activity_grades_structure_step.html" onMouseOver="classPopup(event,'restore_activity_grades_structure_step')">restore_activity_grades_structure_step</a> extends restore_structure_step {
<a name="l3558"><span class="linenum">3558</span></a>  
<a name="l3559"><span class="linenum">3559</span></a>      <span class="comment">/**</span>
<a name="l3560"><span class="linenum">3560</span></a>  <span class="comment">     * No grades in front page.</span>
<a name="l3561"><span class="linenum">3561</span></a>  <span class="comment">     * @return bool</span>
<a name="l3562"><span class="linenum">3562</span></a>  <span class="comment">     */</span>
<a name="l3563"><span class="linenum">3563</span></a>      protected function <a class="function" onClick="logFunction('execute_condition')" href="../../_functions/execute_condition.html" onMouseOver="funcPopup(event,'execute_condition')">execute_condition</a>() {
<a name="l3564"><span class="linenum">3564</span></a>          return (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>() != <a class="constant" onClick="logConstant('SITEID')" href="../../_constants/SITEID.html" onMouseOver="constPopup(event,'SITEID')">SITEID</a>);
<a name="l3565"><span class="linenum">3565</span></a>      }
<a name="l3566"><span class="linenum">3566</span></a>  
<a name="l3567"><span class="linenum">3567</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l3568"><span class="linenum">3568</span></a>  
<a name="l3569"><span class="linenum">3569</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array();
<a name="l3570"><span class="linenum">3570</span></a>          <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('userinfo')" href="../../_variables/userinfo.html">$userinfo</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('userinfo');
<a name="l3571"><span class="linenum">3571</span></a>  
<a name="l3572"><span class="linenum">3572</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('grade_item', '/activity_gradebook/grade_items/grade_item');
<a name="l3573"><span class="linenum">3573</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('grade_letter', '/activity_gradebook/grade_letters/grade_letter');
<a name="l3574"><span class="linenum">3574</span></a>          if (<a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('userinfo')" href="../../_variables/userinfo.html">$userinfo</a>) {
<a name="l3575"><span class="linenum">3575</span></a>              <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('grade_grade',
<a name="l3576"><span class="linenum">3576</span></a>                             '/activity_gradebook/grade_items/grade_item/grade_grades/grade_grade');
<a name="l3577"><span class="linenum">3577</span></a>          }
<a name="l3578"><span class="linenum">3578</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l3579"><span class="linenum">3579</span></a>      }
<a name="l3580"><span class="linenum">3580</span></a>  
<a name="l3581"><span class="linenum">3581</span></a>      protected function <a class="function" onClick="logFunction('process_grade_item')" href="../../_functions/process_grade_item.html" onMouseOver="funcPopup(event,'process_grade_item')">process_grade_item</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l3582"><span class="linenum">3582</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l3583"><span class="linenum">3583</span></a>  
<a name="l3584"><span class="linenum">3584</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l3585"><span class="linenum">3585</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>       = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;        <span class="comment">// We'll need these later</span>
<a name="l3586"><span class="linenum">3586</span></a>          <a class="var it15436" onMouseOver="hilite(15436)" onMouseOut="lolite()" onClick="logVariable('oldparentid')" href="../../_variables/oldparentid.html">$oldparentid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('categoryid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/categoryid.html">categoryid</a>;
<a name="l3587"><span class="linenum">3587</span></a>          <a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l3588"><span class="linenum">3588</span></a>  
<a name="l3589"><span class="linenum">3589</span></a>          <a class="var it312" onMouseOver="hilite(312)" onMouseOut="lolite()" onClick="logVariable('idnumber')" href="../../_variables/idnumber.html">$idnumber</a> = null;
<a name="l3590"><span class="linenum">3590</span></a>          if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>)) {
<a name="l3591"><span class="linenum">3591</span></a>  <span class="comment">            // Don't get any idnumber from course module. Keep them as they are in grade_item-&gt;idnumber</span>
<a name="l3592"><span class="linenum">3592</span></a>  <span class="comment">            // Reason: it's not clear what happens with outcomes-&gt;idnumber or activities with multiple items (workshop)</span>
<a name="l3593"><span class="linenum">3593</span></a>  <span class="comment">            // so the best is to keep the ones already in the gradebook</span>
<a name="l3594"><span class="linenum">3594</span></a>  <span class="comment">            // Potential problem: duplicates if same items are restored more than once. :-(</span>
<a name="l3595"><span class="linenum">3595</span></a>  <span class="comment">            // This needs to be fixed in some way (outcomes &amp; activities with multiple items)</span>
<a name="l3596"><span class="linenum">3596</span></a>  <span class="comment">            // $data-&gt;idnumber     = get_coursemodule_from_instance($data-&gt;itemmodule, $data-&gt;iteminstance)-&gt;idnumber;</span>
<a name="l3597"><span class="linenum">3597</span></a>  <span class="comment">            // In any case, verify always for uniqueness</span>
<a name="l3598"><span class="linenum">3598</span></a>              <a class="var it64" onMouseOver="hilite(64)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a> = &quot;SELECT cm.id
<a name="l3599"><span class="linenum">3599</span></a>                        FROM {course_modules} cm
<a name="l3600"><span class="linenum">3600</span></a>                       WHERE cm.course = :courseid AND
<a name="l3601"><span class="linenum">3601</span></a>                             cm.idnumber = :idnumber AND
<a name="l3602"><span class="linenum">3602</span></a>                             cm.id &lt;&gt; :cmid&quot;;
<a name="l3603"><span class="linenum">3603</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array(
<a name="l3604"><span class="linenum">3604</span></a>                  'courseid' =&gt; <a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>,
<a name="l3605"><span class="linenum">3605</span></a>                  'idnumber' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>,
<a name="l3606"><span class="linenum">3606</span></a>                  'cmid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_moduleid')" href="../../_functions/get_moduleid.html" onMouseOver="funcPopup(event,'get_moduleid')">get_moduleid</a>()
<a name="l3607"><span class="linenum">3607</span></a>              );
<a name="l3608"><span class="linenum">3608</span></a>              if (!<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists_sql')" href="../../_functions/record_exists_sql.html" onMouseOver="funcPopup(event,'record_exists_sql')">record_exists_sql</a>(<a class="var it64" onMouseOver="hilite(64)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a>, <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>) &amp;&amp; !<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists')" href="../../_functions/record_exists.html" onMouseOver="funcPopup(event,'record_exists')">record_exists</a>('grade_items', array('courseid' =&gt; <a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>, 'idnumber' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>))) {
<a name="l3609"><span class="linenum">3609</span></a>                  <a class="var it312" onMouseOver="hilite(312)" onMouseOut="lolite()" onClick="logVariable('idnumber')" href="../../_variables/idnumber.html">$idnumber</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>;
<a name="l3610"><span class="linenum">3610</span></a>              }
<a name="l3611"><span class="linenum">3611</span></a>          }
<a name="l3612"><span class="linenum">3612</span></a>  
<a name="l3613"><span class="linenum">3613</span></a>          if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('categoryid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/categoryid.html">categoryid</a>)) {
<a name="l3614"><span class="linenum">3614</span></a>  <span class="comment">            // If the grade category id of the grade item being restored belongs to this course</span>
<a name="l3615"><span class="linenum">3615</span></a>  <span class="comment">            // then it is a fair assumption that this is the correct grade category for the activity</span>
<a name="l3616"><span class="linenum">3616</span></a>  <span class="comment">            // and we should leave it in place, if not then unset it.</span>
<a name="l3617"><span class="linenum">3617</span></a>  <span class="comment">            // TODO MDL-34790 Gradebook does not import if target course has gradebook categories.</span>
<a name="l3618"><span class="linenum">3618</span></a>              <a class="var it1217" onMouseOver="hilite(1217)" onMouseOut="lolite()" onClick="logVariable('conditions')" href="../../_variables/conditions.html">$conditions</a> = array('id' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('categoryid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/categoryid.html">categoryid</a>, 'courseid' =&gt; <a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>);
<a name="l3619"><span class="linenum">3619</span></a>              if (!<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('is_samesite')" href="../../_functions/is_samesite.html" onMouseOver="funcPopup(event,'is_samesite')">is_samesite</a>() || !<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists')" href="../../_functions/record_exists.html" onMouseOver="funcPopup(event,'record_exists')">record_exists</a>('grade_categories', <a class="var it1217" onMouseOver="hilite(1217)" onMouseOut="lolite()" onClick="logVariable('conditions')" href="../../_variables/conditions.html">$conditions</a>)) {
<a name="l3620"><span class="linenum">3620</span></a>                  unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('categoryid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/categoryid.html">categoryid</a>);
<a name="l3621"><span class="linenum">3621</span></a>              }
<a name="l3622"><span class="linenum">3622</span></a>          }
<a name="l3623"><span class="linenum">3623</span></a>  
<a name="l3624"><span class="linenum">3624</span></a>          unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>);
<a name="l3625"><span class="linenum">3625</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('courseid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/courseid.html">courseid</a>     = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l3626"><span class="linenum">3626</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('iteminstance')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/iteminstance.html">iteminstance</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_activityid')" href="../../_functions/get_activityid.html" onMouseOver="funcPopup(event,'get_activityid')">get_activityid</a>();
<a name="l3627"><span class="linenum">3627</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>     = <a class="var it312" onMouseOver="hilite(312)" onMouseOut="lolite()" onClick="logVariable('idnumber')" href="../../_variables/idnumber.html">$idnumber</a>;
<a name="l3628"><span class="linenum">3628</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('scaleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/scaleid.html">scaleid</a>      = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('scale', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('scaleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/scaleid.html">scaleid</a>);
<a name="l3629"><span class="linenum">3629</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('outcomeid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/outcomeid.html">outcomeid</a>    = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('outcome', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('outcomeid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/outcomeid.html">outcomeid</a>);
<a name="l3630"><span class="linenum">3630</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timecreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timecreated.html">timecreated</a>  = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timecreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timecreated.html">timecreated</a>);
<a name="l3631"><span class="linenum">3631</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timemodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timemodified.html">timemodified</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timemodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timemodified.html">timemodified</a>);
<a name="l3632"><span class="linenum">3632</span></a>  
<a name="l3633"><span class="linenum">3633</span></a>          <a class="var it2470" onMouseOver="hilite(2470)" onMouseOut="lolite()" onClick="logVariable('gradeitem')" href="../../_variables/gradeitem.html">$gradeitem</a> = <span class="keyword">new </span><a class="class" onClick="logClass('grade_item')" href="../../_classes/grade_item.html" onMouseOver="classPopup(event,'grade_item')">grade_item</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, false);
<a name="l3634"><span class="linenum">3634</span></a>          <a class="var it2470" onMouseOver="hilite(2470)" onMouseOut="lolite()" onClick="logVariable('gradeitem')" href="../../_variables/gradeitem.html">$gradeitem</a>-&gt;<a class="function" onClick="logFunction('insert')" href="../../_functions/insert.html" onMouseOver="funcPopup(event,'insert')">insert</a>('restore');
<a name="l3635"><span class="linenum">3635</span></a>  
<a name="l3636"><span class="linenum">3636</span></a>  <span class="comment">        //sortorder is automatically assigned when inserting. Re-instate the previous sortorder</span>
<a name="l3637"><span class="linenum">3637</span></a>          <a class="var it2470" onMouseOver="hilite(2470)" onMouseOut="lolite()" onClick="logVariable('gradeitem')" href="../../_variables/gradeitem.html">$gradeitem</a>-&gt;<a onClick="logVariable('sortorder')" class="var it42964" onMouseOver="hilite(42964)" onMouseOut="lolite()" href="../../_variables/sortorder.html">sortorder</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('sortorder')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/sortorder.html">sortorder</a>;
<a name="l3638"><span class="linenum">3638</span></a>          <a class="var it2470" onMouseOver="hilite(2470)" onMouseOut="lolite()" onClick="logVariable('gradeitem')" href="../../_variables/gradeitem.html">$gradeitem</a>-&gt;<a class="function" onClick="logFunction('update')" href="../../_functions/update.html" onMouseOver="funcPopup(event,'update')">update</a>('restore');
<a name="l3639"><span class="linenum">3639</span></a>  
<a name="l3640"><span class="linenum">3640</span></a>  <span class="comment">        // Set mapping, saving the original category id into parentitemid</span>
<a name="l3641"><span class="linenum">3641</span></a>  <span class="comment">        // gradebook restore (final task) will need it to reorganise items</span>
<a name="l3642"><span class="linenum">3642</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('grade_item', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it2470" onMouseOver="hilite(2470)" onMouseOut="lolite()" onClick="logVariable('gradeitem')" href="../../_variables/gradeitem.html">$gradeitem</a>-&gt;<a onClick="logVariable('id')" class="var it42964" onMouseOver="hilite(42964)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, false, null, <a class="var it15436" onMouseOver="hilite(15436)" onMouseOut="lolite()" onClick="logVariable('oldparentid')" href="../../_variables/oldparentid.html">$oldparentid</a>);
<a name="l3643"><span class="linenum">3643</span></a>      }
<a name="l3644"><span class="linenum">3644</span></a>  
<a name="l3645"><span class="linenum">3645</span></a>      protected function <a class="function" onClick="logFunction('process_grade_grade')" href="../../_functions/process_grade_grade.html" onMouseOver="funcPopup(event,'process_grade_grade')">process_grade_grade</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l3646"><span class="linenum">3646</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l3647"><span class="linenum">3647</span></a>          <a class="var it15351" onMouseOver="hilite(15351)" onMouseOut="lolite()" onClick="logVariable('olduserid')" href="../../_variables/olduserid.html">$olduserid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>;
<a name="l3648"><span class="linenum">3648</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l3649"><span class="linenum">3649</span></a>          unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>);
<a name="l3650"><span class="linenum">3650</span></a>  
<a name="l3651"><span class="linenum">3651</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_new_parentid')" href="../../_functions/get_new_parentid.html" onMouseOver="funcPopup(event,'get_new_parentid')">get_new_parentid</a>('grade_item');
<a name="l3652"><span class="linenum">3652</span></a>  
<a name="l3653"><span class="linenum">3653</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>, null);
<a name="l3654"><span class="linenum">3654</span></a>          if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>)) {
<a name="l3655"><span class="linenum">3655</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usermodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usermodified.html">usermodified</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usermodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usermodified.html">usermodified</a>, null);
<a name="l3656"><span class="linenum">3656</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('rawscaleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/rawscaleid.html">rawscaleid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('scale', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('rawscaleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/rawscaleid.html">rawscaleid</a>);
<a name="l3657"><span class="linenum">3657</span></a>  <span class="comment">            // TODO: Ask, all the rest of locktime/exported... work with time... to be rolled?</span>
<a name="l3658"><span class="linenum">3658</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('overridden')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/overridden.html">overridden</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('overridden')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/overridden.html">overridden</a>);
<a name="l3659"><span class="linenum">3659</span></a>  
<a name="l3660"><span class="linenum">3660</span></a>              <a class="var it288" onMouseOver="hilite(288)" onMouseOut="lolite()" onClick="logVariable('grade')" href="../../_variables/grade.html">$grade</a> = <span class="keyword">new </span><a class="class" onClick="logClass('grade_grade')" href="../../_classes/grade_grade.html" onMouseOver="classPopup(event,'grade_grade')">grade_grade</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, false);
<a name="l3661"><span class="linenum">3661</span></a>              <a class="var it288" onMouseOver="hilite(288)" onMouseOut="lolite()" onClick="logVariable('grade')" href="../../_variables/grade.html">$grade</a>-&gt;<a class="function" onClick="logFunction('insert')" href="../../_functions/insert.html" onMouseOver="funcPopup(event,'insert')">insert</a>('restore');
<a name="l3662"><span class="linenum">3662</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('grade_grades', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it288" onMouseOver="hilite(288)" onMouseOut="lolite()" onClick="logVariable('grade')" href="../../_variables/grade.html">$grade</a>-&gt;<a onClick="logVariable('id')" class="var it42963" onMouseOver="hilite(42963)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>);
<a name="l3663"><span class="linenum">3663</span></a>          } else {
<a name="l3664"><span class="linenum">3664</span></a>              <a class="function" onClick="logFunction('debugging')" href="../../_functions/debugging.html" onMouseOver="funcPopup(event,'debugging')">debugging</a>(&quot;Mapped user id not found for user id '{<a class="var it15351" onMouseOver="hilite(15351)" onMouseOut="lolite()" onClick="logVariable('olduserid')" href="../../_variables/olduserid.html">$olduserid</a>}', grade item id '{<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>}'&quot;);
<a name="l3665"><span class="linenum">3665</span></a>          }
<a name="l3666"><span class="linenum">3666</span></a>      }
<a name="l3667"><span class="linenum">3667</span></a>  
<a name="l3668"><span class="linenum">3668</span></a>      <span class="comment">/**</span>
<a name="l3669"><span class="linenum">3669</span></a>  <span class="comment">     * process activity grade_letters. Note that, while these are possible,</span>
<a name="l3670"><span class="linenum">3670</span></a>  <span class="comment">     * because grade_letters are contextid based, in practice, only course</span>
<a name="l3671"><span class="linenum">3671</span></a>  <span class="comment">     * context letters can be defined. So we keep here this method knowing</span>
<a name="l3672"><span class="linenum">3672</span></a>  <span class="comment">     * it won't be executed ever. gradebook restore will restore course letters.</span>
<a name="l3673"><span class="linenum">3673</span></a>  <span class="comment">     */</span>
<a name="l3674"><span class="linenum">3674</span></a>      protected function <a class="function" onClick="logFunction('process_grade_letter')" href="../../_functions/process_grade_letter.html" onMouseOver="funcPopup(event,'process_grade_letter')">process_grade_letter</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l3675"><span class="linenum">3675</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l3676"><span class="linenum">3676</span></a>  
<a name="l3677"><span class="linenum">3677</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>['contextid'] = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_contextid')" href="../../_functions/get_contextid.html" onMouseOver="funcPopup(event,'get_contextid')">get_contextid</a>();
<a name="l3678"><span class="linenum">3678</span></a>          <a class="var it15354" onMouseOver="hilite(15354)" onMouseOut="lolite()" onClick="logVariable('gradeletter')" href="../../_variables/gradeletter.html">$gradeletter</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l3679"><span class="linenum">3679</span></a>  
<a name="l3680"><span class="linenum">3680</span></a>  <span class="comment">        // Check if it exists before adding it</span>
<a name="l3681"><span class="linenum">3681</span></a>          unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>['id']);
<a name="l3682"><span class="linenum">3682</span></a>          if (!<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists')" href="../../_functions/record_exists.html" onMouseOver="funcPopup(event,'record_exists')">record_exists</a>('grade_letters', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>)) {
<a name="l3683"><span class="linenum">3683</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('grade_letters', <a class="var it15354" onMouseOver="hilite(15354)" onMouseOut="lolite()" onClick="logVariable('gradeletter')" href="../../_variables/gradeletter.html">$gradeletter</a>);
<a name="l3684"><span class="linenum">3684</span></a>          }
<a name="l3685"><span class="linenum">3685</span></a>  <span class="comment">        // no need to save any grade_letter mapping</span>
<a name="l3686"><span class="linenum">3686</span></a>      }
<a name="l3687"><span class="linenum">3687</span></a>  
<a name="l3688"><span class="linenum">3688</span></a>      public function <a class="function" onClick="logFunction('after_restore')" href="../../_functions/after_restore.html" onMouseOver="funcPopup(event,'after_restore')">after_restore</a>() {
<a name="l3689"><span class="linenum">3689</span></a>  <span class="comment">        // Fix grade item's sortorder after restore, as it might have duplicates.</span>
<a name="l3690"><span class="linenum">3690</span></a>          <a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_task')" href="../../_functions/get_task.html" onMouseOver="funcPopup(event,'get_task')">get_task</a>()-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l3691"><span class="linenum">3691</span></a>          <a class="class" onClick="logClass('grade_item')" href="../../_classes/grade_item.html" onMouseOver="classPopup(event,'grade_item')">grade_item</a>::<a class="function" onClick="logFunction('fix_duplicate_sortorder')" href="../../_functions/fix_duplicate_sortorder.html" onMouseOver="funcPopup(event,'fix_duplicate_sortorder')">fix_duplicate_sortorder</a>(<a class="var it700" onMouseOver="hilite(700)" onMouseOut="lolite()" onClick="logVariable('courseid')" href="../../_variables/courseid.html">$courseid</a>);
<a name="l3692"><span class="linenum">3692</span></a>      }
<a name="l3693"><span class="linenum">3693</span></a>  }
<a name="l3694"><span class="linenum">3694</span></a>  
<a name="l3695"><span class="linenum">3695</span></a>  <span class="comment">/**</span>
<a name="l3696"><span class="linenum">3696</span></a>  <span class="comment"> * Step in charge of restoring the grade history of an activity.</span>
<a name="l3697"><span class="linenum">3697</span></a>  <span class="comment"> *</span>
<a name="l3698"><span class="linenum">3698</span></a>  <span class="comment"> * This step is added to the task regardless of the setting 'grade_histories'.</span>
<a name="l3699"><span class="linenum">3699</span></a>  <span class="comment"> * The reason is to allow for a more flexible step in case the logic needs to be</span>
<a name="l3700"><span class="linenum">3700</span></a>  <span class="comment"> * split accross different settings to control the history of items and/or grades.</span>
<a name="l3701"><span class="linenum">3701</span></a>  <span class="comment"> */</span>
<a name="l3702"><span class="linenum">3702</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_activity_grade_history_structure_step')" href="../../_classes/restore_activity_grade_history_structure_step.html" onMouseOver="classPopup(event,'restore_activity_grade_history_structure_step')">restore_activity_grade_history_structure_step</a> extends restore_structure_step {
<a name="l3703"><span class="linenum">3703</span></a>  
<a name="l3704"><span class="linenum">3704</span></a>      <span class="comment">/**</span>
<a name="l3705"><span class="linenum">3705</span></a>  <span class="comment">     * This step is executed only if the grade history file is present.</span>
<a name="l3706"><span class="linenum">3706</span></a>  <span class="comment">     */</span>
<a name="l3707"><span class="linenum">3707</span></a>       protected function <a class="function" onClick="logFunction('execute_condition')" href="../../_functions/execute_condition.html" onMouseOver="funcPopup(event,'execute_condition')">execute_condition</a>() {
<a name="l3708"><span class="linenum">3708</span></a>  
<a name="l3709"><span class="linenum">3709</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>() == <a class="constant" onClick="logConstant('SITEID')" href="../../_constants/SITEID.html" onMouseOver="constPopup(event,'SITEID')">SITEID</a>) {
<a name="l3710"><span class="linenum">3710</span></a>              return false;
<a name="l3711"><span class="linenum">3711</span></a>          }
<a name="l3712"><span class="linenum">3712</span></a>  
<a name="l3713"><span class="linenum">3713</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_taskbasepath')" href="../../_functions/get_taskbasepath.html" onMouseOver="funcPopup(event,'get_taskbasepath')">get_taskbasepath</a>();
<a name="l3714"><span class="linenum">3714</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="phpfunction" onClick="logFunction('rtrim')" href="../../_functions/rtrim.html" onMouseOver="phpfuncPopup(event,'rtrim')">rtrim</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>, '/') . '/' . <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('filename')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/filename.html">filename</a>;
<a name="l3715"><span class="linenum">3715</span></a>          if (!<a class="phpfunction" onClick="logFunction('file_exists')" href="../../_functions/file_exists.html" onMouseOver="phpfuncPopup(event,'file_exists')">file_exists</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>)) {
<a name="l3716"><span class="linenum">3716</span></a>              return false;
<a name="l3717"><span class="linenum">3717</span></a>          }
<a name="l3718"><span class="linenum">3718</span></a>          return true;
<a name="l3719"><span class="linenum">3719</span></a>      }
<a name="l3720"><span class="linenum">3720</span></a>  
<a name="l3721"><span class="linenum">3721</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l3722"><span class="linenum">3722</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array();
<a name="l3723"><span class="linenum">3723</span></a>  
<a name="l3724"><span class="linenum">3724</span></a>  <span class="comment">        // Settings to use.</span>
<a name="l3725"><span class="linenum">3725</span></a>          <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('userinfo')" href="../../_variables/userinfo.html">$userinfo</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('userinfo');
<a name="l3726"><span class="linenum">3726</span></a>          <a class="var it15366" onMouseOver="hilite(15366)" onMouseOut="lolite()" onClick="logVariable('history')" href="../../_variables/history.html">$history</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_setting_value')" href="../../_functions/get_setting_value.html" onMouseOver="funcPopup(event,'get_setting_value')">get_setting_value</a>('grade_histories');
<a name="l3727"><span class="linenum">3727</span></a>  
<a name="l3728"><span class="linenum">3728</span></a>          if (<a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('userinfo')" href="../../_variables/userinfo.html">$userinfo</a> &amp;&amp; <a class="var it15366" onMouseOver="hilite(15366)" onMouseOut="lolite()" onClick="logVariable('history')" href="../../_variables/history.html">$history</a>) {
<a name="l3729"><span class="linenum">3729</span></a>              <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('grade_grade',
<a name="l3730"><span class="linenum">3730</span></a>                 '/grade_history/grade_grades/grade_grade');
<a name="l3731"><span class="linenum">3731</span></a>          }
<a name="l3732"><span class="linenum">3732</span></a>  
<a name="l3733"><span class="linenum">3733</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l3734"><span class="linenum">3734</span></a>      }
<a name="l3735"><span class="linenum">3735</span></a>  
<a name="l3736"><span class="linenum">3736</span></a>      protected function <a class="function" onClick="logFunction('process_grade_grade')" href="../../_functions/process_grade_grade.html" onMouseOver="funcPopup(event,'process_grade_grade')">process_grade_grade</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l3737"><span class="linenum">3737</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l3738"><span class="linenum">3738</span></a>  
<a name="l3739"><span class="linenum">3739</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object) <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l3740"><span class="linenum">3740</span></a>          <a class="var it15351" onMouseOver="hilite(15351)" onMouseOut="lolite()" onClick="logVariable('olduserid')" href="../../_variables/olduserid.html">$olduserid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>;
<a name="l3741"><span class="linenum">3741</span></a>          unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>);
<a name="l3742"><span class="linenum">3742</span></a>  
<a name="l3743"><span class="linenum">3743</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>, null);
<a name="l3744"><span class="linenum">3744</span></a>          if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>)) {
<a name="l3745"><span class="linenum">3745</span></a>  <span class="comment">            // Do not apply the date offsets as this is history.</span>
<a name="l3746"><span class="linenum">3746</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('grade_item', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>);
<a name="l3747"><span class="linenum">3747</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('oldid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/oldid.html">oldid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('grade_grades', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('oldid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/oldid.html">oldid</a>);
<a name="l3748"><span class="linenum">3748</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usermodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usermodified.html">usermodified</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('usermodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/usermodified.html">usermodified</a>, null);
<a name="l3749"><span class="linenum">3749</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('rawscaleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/rawscaleid.html">rawscaleid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('scale', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('rawscaleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/rawscaleid.html">rawscaleid</a>);
<a name="l3750"><span class="linenum">3750</span></a>              <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('grade_grades_history', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l3751"><span class="linenum">3751</span></a>          } else {
<a name="l3752"><span class="linenum">3752</span></a>              <a class="var it276" onMouseOver="hilite(276)" onMouseOut="lolite()" onClick="logVariable('message')" href="../../_variables/message.html">$message</a> = &quot;Mapped user id not found for user id '{<a class="var it15351" onMouseOver="hilite(15351)" onMouseOut="lolite()" onClick="logVariable('olduserid')" href="../../_variables/olduserid.html">$olduserid</a>}', grade item id '{<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('itemid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>}'&quot;;
<a name="l3753"><span class="linenum">3753</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="phpfunction" onClick="logFunction('log')" href="../../_functions/log.html" onMouseOver="phpfuncPopup(event,'log')">log</a>(<a class="var it276" onMouseOver="hilite(276)" onMouseOut="lolite()" onClick="logVariable('message')" href="../../_variables/message.html">$message</a>, backup::LOG_DEBUG);
<a name="l3754"><span class="linenum">3754</span></a>          }
<a name="l3755"><span class="linenum">3755</span></a>      }
<a name="l3756"><span class="linenum">3756</span></a>  
<a name="l3757"><span class="linenum">3757</span></a>  }
<a name="l3758"><span class="linenum">3758</span></a>  
<a name="l3759"><span class="linenum">3759</span></a>  <span class="comment">/**</span>
<a name="l3760"><span class="linenum">3760</span></a>  <span class="comment"> * This structure steps restores one instance + positions of one block</span>
<a name="l3761"><span class="linenum">3761</span></a>  <span class="comment"> * Note: Positions corresponding to one existing context are restored</span>
<a name="l3762"><span class="linenum">3762</span></a>  <span class="comment"> * here, but all the ones having unknown contexts are sent to backup_ids</span>
<a name="l3763"><span class="linenum">3763</span></a>  <span class="comment"> * for a later chance to be restored at the end (final task)</span>
<a name="l3764"><span class="linenum">3764</span></a>  <span class="comment"> */</span>
<a name="l3765"><span class="linenum">3765</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_block_instance_structure_step')" href="../../_classes/restore_block_instance_structure_step.html" onMouseOver="classPopup(event,'restore_block_instance_structure_step')">restore_block_instance_structure_step</a> extends restore_structure_step {
<a name="l3766"><span class="linenum">3766</span></a>  
<a name="l3767"><span class="linenum">3767</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l3768"><span class="linenum">3768</span></a>  
<a name="l3769"><span class="linenum">3769</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array();
<a name="l3770"><span class="linenum">3770</span></a>  
<a name="l3771"><span class="linenum">3771</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('block', '/block', true); <span class="comment">// Get the whole XML together</span>
<a name="l3772"><span class="linenum">3772</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('block_position', '/block/block_positions/block_position');
<a name="l3773"><span class="linenum">3773</span></a>  
<a name="l3774"><span class="linenum">3774</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l3775"><span class="linenum">3775</span></a>      }
<a name="l3776"><span class="linenum">3776</span></a>  
<a name="l3777"><span class="linenum">3777</span></a>      public function <a class="function" onClick="logFunction('process_block')" href="../../_functions/process_block.html" onMouseOver="funcPopup(event,'process_block')">process_block</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l3778"><span class="linenum">3778</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>, <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>;
<a name="l3779"><span class="linenum">3779</span></a>  
<a name="l3780"><span class="linenum">3780</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>; <span class="comment">// Handy</span>
<a name="l3781"><span class="linenum">3781</span></a>          <a class="var it5968" onMouseOver="hilite(5968)" onMouseOut="lolite()" onClick="logVariable('oldcontextid')" href="../../_variables/oldcontextid.html">$oldcontextid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('contextid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a>;
<a name="l3782"><span class="linenum">3782</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>        = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l3783"><span class="linenum">3783</span></a>          <a class="var it9140" onMouseOver="hilite(9140)" onMouseOut="lolite()" onClick="logVariable('positions')" href="../../_variables/positions.html">$positions</a> = isset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('block_positions')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/block_positions.html">block_positions</a>['block_position']) ? <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('block_positions')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/block_positions.html">block_positions</a>['block_position'] : array();
<a name="l3784"><span class="linenum">3784</span></a>  
<a name="l3785"><span class="linenum">3785</span></a>  <span class="comment">        // Look for the parent contextid</span>
<a name="l3786"><span class="linenum">3786</span></a>          if (!<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('parentcontextid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/parentcontextid.html">parentcontextid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('context', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('parentcontextid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/parentcontextid.html">parentcontextid</a>)) {
<a name="l3787"><span class="linenum">3787</span></a>              throw <span class="keyword">new </span><a class="class" onClick="logClass('restore_step_exception')" href="../../_classes/restore_step_exception.html" onMouseOver="classPopup(event,'restore_step_exception')">restore_step_exception</a>('restore_block_missing_parent_ctx', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('parentcontextid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/parentcontextid.html">parentcontextid</a>);
<a name="l3788"><span class="linenum">3788</span></a>          }
<a name="l3789"><span class="linenum">3789</span></a>  
<a name="l3790"><span class="linenum">3790</span></a>  <span class="comment">        // TODO: it would be nice to use standard plugin supports instead of this instance_allow_multiple()</span>
<a name="l3791"><span class="linenum">3791</span></a>  <span class="comment">        // If there is already one block of that type in the parent context</span>
<a name="l3792"><span class="linenum">3792</span></a>  <span class="comment">        // and the block is not multiple, stop processing</span>
<a name="l3793"><span class="linenum">3793</span></a>  <span class="comment">        // Use blockslib loader / method executor</span>
<a name="l3794"><span class="linenum">3794</span></a>          if (!<a class="var it15438" onMouseOver="hilite(15438)" onMouseOut="lolite()" onClick="logVariable('bi')" href="../../_variables/bi.html">$bi</a> = <a class="function" onClick="logFunction('block_instance')" href="../../_functions/block_instance.html" onMouseOver="funcPopup(event,'block_instance')">block_instance</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('blockname')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/blockname.html">blockname</a>)) {
<a name="l3795"><span class="linenum">3795</span></a>              return false;
<a name="l3796"><span class="linenum">3796</span></a>          }
<a name="l3797"><span class="linenum">3797</span></a>  
<a name="l3798"><span class="linenum">3798</span></a>          if (!<a class="var it15438" onMouseOver="hilite(15438)" onMouseOut="lolite()" onClick="logVariable('bi')" href="../../_variables/bi.html">$bi</a>-&gt;<a class="function" onClick="logFunction('instance_allow_multiple')" href="../../_functions/instance_allow_multiple.html" onMouseOver="funcPopup(event,'instance_allow_multiple')">instance_allow_multiple</a>()) {
<a name="l3799"><span class="linenum">3799</span></a>  <span class="comment">            // The block cannot be added twice, so we will check if the same block is already being</span>
<a name="l3800"><span class="linenum">3800</span></a>  <span class="comment">            // displayed on the same page. For this, rather than mocking a page and using the block_manager</span>
<a name="l3801"><span class="linenum">3801</span></a>  <span class="comment">            // we use a similar query to the one in block_manager::load_blocks(), this will give us</span>
<a name="l3802"><span class="linenum">3802</span></a>  <span class="comment">            // a very good idea of the blocks already displayed in the context.</span>
<a name="l3803"><span class="linenum">3803</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> =  array(
<a name="l3804"><span class="linenum">3804</span></a>                  'blockname' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;blockname
<a name="l3805"><span class="linenum">3805</span></a>              );
<a name="l3806"><span class="linenum">3806</span></a>  
<a name="l3807"><span class="linenum">3807</span></a>  <span class="comment">            // Context matching test.</span>
<a name="l3808"><span class="linenum">3808</span></a>              <a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a> = context::<a class="function" onClick="logFunction('instance_by_id')" href="../../_functions/instance_by_id.html" onMouseOver="funcPopup(event,'instance_by_id')">instance_by_id</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('parentcontextid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/parentcontextid.html">parentcontextid</a>);
<a name="l3809"><span class="linenum">3809</span></a>              <a class="var it15439" onMouseOver="hilite(15439)" onMouseOut="lolite()" onClick="logVariable('contextsql')" href="../../_variables/contextsql.html">$contextsql</a> = 'bi.parentcontextid = :contextid';
<a name="l3810"><span class="linenum">3810</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['contextid'] = <a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a>-&gt;<a onClick="logVariable('id')" class="var it42918" onMouseOver="hilite(42918)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l3811"><span class="linenum">3811</span></a>  
<a name="l3812"><span class="linenum">3812</span></a>              <a class="var it15440" onMouseOver="hilite(15440)" onMouseOut="lolite()" onClick="logVariable('parentcontextids')" href="../../_variables/parentcontextids.html">$parentcontextids</a> = <a class="var it23" onMouseOver="hilite(23)" onMouseOut="lolite()" onClick="logVariable('context')" href="../../_variables/context.html">$context</a>-&gt;<a class="function" onClick="logFunction('get_parent_context_ids')" href="../../_functions/get_parent_context_ids.html" onMouseOver="funcPopup(event,'get_parent_context_ids')">get_parent_context_ids</a>();
<a name="l3813"><span class="linenum">3813</span></a>              if (<a class="var it15440" onMouseOver="hilite(15440)" onMouseOut="lolite()" onClick="logVariable('parentcontextids')" href="../../_variables/parentcontextids.html">$parentcontextids</a>) {
<a name="l3814"><span class="linenum">3814</span></a>                  <a class="function" onClick="logFunction('list')" href="../../_functions/list.html" onMouseOver="funcPopup(event,'list')">list</a>(<a class="var it15441" onMouseOver="hilite(15441)" onMouseOut="lolite()" onClick="logVariable('parentcontextsql')" href="../../_variables/parentcontextsql.html">$parentcontextsql</a>, <a class="var it15442" onMouseOver="hilite(15442)" onMouseOut="lolite()" onClick="logVariable('parentcontextparams')" href="../../_variables/parentcontextparams.html">$parentcontextparams</a>) =
<a name="l3815"><span class="linenum">3815</span></a>                          <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_in_or_equal')" href="../../_functions/get_in_or_equal.html" onMouseOver="funcPopup(event,'get_in_or_equal')">get_in_or_equal</a>(<a class="var it15440" onMouseOver="hilite(15440)" onMouseOut="lolite()" onClick="logVariable('parentcontextids')" href="../../_variables/parentcontextids.html">$parentcontextids</a>, <a class="constant" onClick="logConstant('SQL_PARAMS_NAMED')" href="../../_constants/SQL_PARAMS_NAMED.html" onMouseOver="constPopup(event,'SQL_PARAMS_NAMED')">SQL_PARAMS_NAMED</a>);
<a name="l3816"><span class="linenum">3816</span></a>                  <a class="var it15439" onMouseOver="hilite(15439)" onMouseOut="lolite()" onClick="logVariable('contextsql')" href="../../_variables/contextsql.html">$contextsql</a> = &quot;(<a class="var it15439" onMouseOver="hilite(15439)" onMouseOut="lolite()" onClick="logVariable('contextsql')" href="../../_variables/contextsql.html">$contextsql</a> <a class="function" onClick="logFunction('OR')" href="../../_functions/or.html" onMouseOver="funcPopup(event,'or')">OR</a> (bi.showinsubcontexts = 1 AND bi.parentcontextid <a class="var it15441" onMouseOver="hilite(15441)" onMouseOut="lolite()" onClick="logVariable('parentcontextsql')" href="../../_variables/parentcontextsql.html">$parentcontextsql</a>))&quot;;
<a name="l3817"><span class="linenum">3817</span></a>                  <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = <a class="phpfunction" onClick="logFunction('array_merge')" href="../../_functions/array_merge.html" onMouseOver="phpfuncPopup(event,'array_merge')">array_merge</a>(<a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>, <a class="var it15442" onMouseOver="hilite(15442)" onMouseOut="lolite()" onClick="logVariable('parentcontextparams')" href="../../_variables/parentcontextparams.html">$parentcontextparams</a>);
<a name="l3818"><span class="linenum">3818</span></a>              }
<a name="l3819"><span class="linenum">3819</span></a>  
<a name="l3820"><span class="linenum">3820</span></a>  <span class="comment">            // Page type pattern test.</span>
<a name="l3821"><span class="linenum">3821</span></a>              <a class="var it15443" onMouseOver="hilite(15443)" onMouseOut="lolite()" onClick="logVariable('pagetypepatterns')" href="../../_variables/pagetypepatterns.html">$pagetypepatterns</a> = <a class="function" onClick="logFunction('matching_page_type_patterns_from_pattern')" href="../../_functions/matching_page_type_patterns_from_pattern.html" onMouseOver="funcPopup(event,'matching_page_type_patterns_from_pattern')">matching_page_type_patterns_from_pattern</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('pagetypepattern')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/pagetypepattern.html">pagetypepattern</a>);
<a name="l3822"><span class="linenum">3822</span></a>              <a class="function" onClick="logFunction('list')" href="../../_functions/list.html" onMouseOver="funcPopup(event,'list')">list</a>(<a class="var it15445" onMouseOver="hilite(15445)" onMouseOut="lolite()" onClick="logVariable('pagetypepatternsql')" href="../../_variables/pagetypepatternsql.html">$pagetypepatternsql</a>, <a class="var it15446" onMouseOver="hilite(15446)" onMouseOut="lolite()" onClick="logVariable('pagetypepatternparams')" href="../../_variables/pagetypepatternparams.html">$pagetypepatternparams</a>) =
<a name="l3823"><span class="linenum">3823</span></a>                  <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_in_or_equal')" href="../../_functions/get_in_or_equal.html" onMouseOver="funcPopup(event,'get_in_or_equal')">get_in_or_equal</a>(<a class="var it15443" onMouseOver="hilite(15443)" onMouseOut="lolite()" onClick="logVariable('pagetypepatterns')" href="../../_variables/pagetypepatterns.html">$pagetypepatterns</a>, <a class="constant" onClick="logConstant('SQL_PARAMS_NAMED')" href="../../_constants/SQL_PARAMS_NAMED.html" onMouseOver="constPopup(event,'SQL_PARAMS_NAMED')">SQL_PARAMS_NAMED</a>);
<a name="l3824"><span class="linenum">3824</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = <a class="phpfunction" onClick="logFunction('array_merge')" href="../../_functions/array_merge.html" onMouseOver="phpfuncPopup(event,'array_merge')">array_merge</a>(<a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>, <a class="var it15446" onMouseOver="hilite(15446)" onMouseOut="lolite()" onClick="logVariable('pagetypepatternparams')" href="../../_variables/pagetypepatternparams.html">$pagetypepatternparams</a>);
<a name="l3825"><span class="linenum">3825</span></a>  
<a name="l3826"><span class="linenum">3826</span></a>  <span class="comment">            // Sub page pattern test.</span>
<a name="l3827"><span class="linenum">3827</span></a>              <a class="var it15447" onMouseOver="hilite(15447)" onMouseOut="lolite()" onClick="logVariable('subpagepatternsql')" href="../../_variables/subpagepatternsql.html">$subpagepatternsql</a> = 'bi.subpagepattern IS NULL';
<a name="l3828"><span class="linenum">3828</span></a>              if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('subpagepattern')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/subpagepattern.html">subpagepattern</a> !== null) {
<a name="l3829"><span class="linenum">3829</span></a>                  <a class="var it15447" onMouseOver="hilite(15447)" onMouseOut="lolite()" onClick="logVariable('subpagepatternsql')" href="../../_variables/subpagepatternsql.html">$subpagepatternsql</a> = &quot;(<a class="var it15447" onMouseOver="hilite(15447)" onMouseOut="lolite()" onClick="logVariable('subpagepatternsql')" href="../../_variables/subpagepatternsql.html">$subpagepatternsql</a> OR bi.subpagepattern = :subpagepattern)&quot;;
<a name="l3830"><span class="linenum">3830</span></a>                  <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>['subpagepattern'] = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('subpagepattern')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/subpagepattern.html">subpagepattern</a>;
<a name="l3831"><span class="linenum">3831</span></a>              }
<a name="l3832"><span class="linenum">3832</span></a>  
<a name="l3833"><span class="linenum">3833</span></a>              <a class="var it2527" onMouseOver="hilite(2527)" onMouseOut="lolite()" onClick="logVariable('exists')" href="../../_variables/exists.html">$exists</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('record_exists_sql')" href="../../_functions/record_exists_sql.html" onMouseOver="funcPopup(event,'record_exists_sql')">record_exists_sql</a>(&quot;SELECT bi.id
<a name="l3834"><span class="linenum">3834</span></a>                                                  FROM {block_instances} bi
<a name="l3835"><span class="linenum">3835</span></a>                                                  JOIN {block} b ON b.name = bi.blockname
<a name="l3836"><span class="linenum">3836</span></a>                                                 WHERE bi.blockname = :blockname
<a name="l3837"><span class="linenum">3837</span></a>                                                   AND <a class="var it15439" onMouseOver="hilite(15439)" onMouseOut="lolite()" onClick="logVariable('contextsql')" href="../../_variables/contextsql.html">$contextsql</a>
<a name="l3838"><span class="linenum">3838</span></a>                                                   AND bi.pagetypepattern <a class="var it15445" onMouseOver="hilite(15445)" onMouseOut="lolite()" onClick="logVariable('pagetypepatternsql')" href="../../_variables/pagetypepatternsql.html">$pagetypepatternsql</a>
<a name="l3839"><span class="linenum">3839</span></a>                                                   AND <a class="var it15447" onMouseOver="hilite(15447)" onMouseOut="lolite()" onClick="logVariable('subpagepatternsql')" href="../../_variables/subpagepatternsql.html">$subpagepatternsql</a>&quot;, <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l3840"><span class="linenum">3840</span></a>              if (<a class="var it2527" onMouseOver="hilite(2527)" onMouseOut="lolite()" onClick="logVariable('exists')" href="../../_variables/exists.html">$exists</a>) {
<a name="l3841"><span class="linenum">3841</span></a>  <span class="comment">                // There is at least one very similar block visible on the page where we</span>
<a name="l3842"><span class="linenum">3842</span></a>  <span class="comment">                // are trying to restore the block. In these circumstances the block API</span>
<a name="l3843"><span class="linenum">3843</span></a>  <span class="comment">                // would not allow the user to add another instance of the block, so we</span>
<a name="l3844"><span class="linenum">3844</span></a>  <span class="comment">                // apply the same rule here.</span>
<a name="l3845"><span class="linenum">3845</span></a>                  return false;
<a name="l3846"><span class="linenum">3846</span></a>              }
<a name="l3847"><span class="linenum">3847</span></a>          }
<a name="l3848"><span class="linenum">3848</span></a>  
<a name="l3849"><span class="linenum">3849</span></a>  <span class="comment">        // If there is already one block of that type in the parent context</span>
<a name="l3850"><span class="linenum">3850</span></a>  <span class="comment">        // with the same showincontexts, pagetypepattern, subpagepattern, defaultregion and configdata</span>
<a name="l3851"><span class="linenum">3851</span></a>  <span class="comment">        // stop processing</span>
<a name="l3852"><span class="linenum">3852</span></a>          <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array(
<a name="l3853"><span class="linenum">3853</span></a>              'blockname' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('blockname')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/blockname.html">blockname</a>, 'parentcontextid' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('parentcontextid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/parentcontextid.html">parentcontextid</a>,
<a name="l3854"><span class="linenum">3854</span></a>              'showinsubcontexts' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('showinsubcontexts')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/showinsubcontexts.html">showinsubcontexts</a>, 'pagetypepattern' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('pagetypepattern')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/pagetypepattern.html">pagetypepattern</a>,
<a name="l3855"><span class="linenum">3855</span></a>              'subpagepattern' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('subpagepattern')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/subpagepattern.html">subpagepattern</a>, 'defaultregion' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('defaultregion')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/defaultregion.html">defaultregion</a>);
<a name="l3856"><span class="linenum">3856</span></a>          if (<a class="var it15449" onMouseOver="hilite(15449)" onMouseOut="lolite()" onClick="logVariable('birecs')" href="../../_variables/birecs.html">$birecs</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records')" href="../../_functions/get_records.html" onMouseOver="funcPopup(event,'get_records')">get_records</a>('block_instances', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>)) {
<a name="l3857"><span class="linenum">3857</span></a>              foreach(<a class="var it15449" onMouseOver="hilite(15449)" onMouseOut="lolite()" onClick="logVariable('birecs')" href="../../_variables/birecs.html">$birecs</a> as <a class="var it15450" onMouseOver="hilite(15450)" onMouseOut="lolite()" onClick="logVariable('birec')" href="../../_variables/birec.html">$birec</a>) {
<a name="l3858"><span class="linenum">3858</span></a>                  if (<a class="var it15450" onMouseOver="hilite(15450)" onMouseOut="lolite()" onClick="logVariable('birec')" href="../../_variables/birec.html">$birec</a>-&gt;<a onClick="logVariable('configdata')" class="var it45299" onMouseOver="hilite(45299)" onMouseOut="lolite()" href="../../_variables/configdata.html">configdata</a> == <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('configdata')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/configdata.html">configdata</a>) {
<a name="l3859"><span class="linenum">3859</span></a>                      return false;
<a name="l3860"><span class="linenum">3860</span></a>                  }
<a name="l3861"><span class="linenum">3861</span></a>              }
<a name="l3862"><span class="linenum">3862</span></a>          }
<a name="l3863"><span class="linenum">3863</span></a>  
<a name="l3864"><span class="linenum">3864</span></a>  <span class="comment">        // Set task old contextid, blockid and blockname once we know them</span>
<a name="l3865"><span class="linenum">3865</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('set_old_contextid')" href="../../_functions/set_old_contextid.html" onMouseOver="funcPopup(event,'set_old_contextid')">set_old_contextid</a>(<a class="var it5968" onMouseOver="hilite(5968)" onMouseOut="lolite()" onClick="logVariable('oldcontextid')" href="../../_variables/oldcontextid.html">$oldcontextid</a>);
<a name="l3866"><span class="linenum">3866</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('set_old_blockid')" href="../../_functions/set_old_blockid.html" onMouseOver="funcPopup(event,'set_old_blockid')">set_old_blockid</a>(<a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>);
<a name="l3867"><span class="linenum">3867</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('set_blockname')" href="../../_functions/set_blockname.html" onMouseOver="funcPopup(event,'set_blockname')">set_blockname</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('blockname')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/blockname.html">blockname</a>);
<a name="l3868"><span class="linenum">3868</span></a>  
<a name="l3869"><span class="linenum">3869</span></a>  <span class="comment">        // Let's look for anything within configdata neededing processing</span>
<a name="l3870"><span class="linenum">3870</span></a>  <span class="comment">        // (nulls and uses of legacy file.php)</span>
<a name="l3871"><span class="linenum">3871</span></a>          if (<a class="var it15451" onMouseOver="hilite(15451)" onMouseOut="lolite()" onClick="logVariable('attrstotransform')" href="../../_variables/attrstotransform.html">$attrstotransform</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_configdata_encoded_attributes')" href="../../_functions/get_configdata_encoded_attributes.html" onMouseOver="funcPopup(event,'get_configdata_encoded_attributes')">get_configdata_encoded_attributes</a>()) {
<a name="l3872"><span class="linenum">3872</span></a>              <a class="var it4997" onMouseOver="hilite(4997)" onMouseOut="lolite()" onClick="logVariable('configdata')" href="../../_variables/configdata.html">$configdata</a> = (array)<a class="phpfunction" onClick="logFunction('unserialize')" href="../../_functions/unserialize.html" onMouseOver="phpfuncPopup(event,'unserialize')">unserialize</a>(<a class="phpfunction" onClick="logFunction('base64_decode')" href="../../_functions/base64_decode.html" onMouseOver="phpfuncPopup(event,'base64_decode')">base64_decode</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('configdata')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/configdata.html">configdata</a>));
<a name="l3873"><span class="linenum">3873</span></a>              foreach (<a class="var it4997" onMouseOver="hilite(4997)" onMouseOut="lolite()" onClick="logVariable('configdata')" href="../../_variables/configdata.html">$configdata</a> as <a class="var it1927" onMouseOver="hilite(1927)" onMouseOut="lolite()" onClick="logVariable('attribute')" href="../../_variables/attribute.html">$attribute</a> =&gt; <a class="var it394" onMouseOver="hilite(394)" onMouseOut="lolite()" onClick="logVariable('value')" href="../../_variables/value.html">$value</a>) {
<a name="l3874"><span class="linenum">3874</span></a>                  if (<a class="phpfunction" onClick="logFunction('in_array')" href="../../_functions/in_array.html" onMouseOver="phpfuncPopup(event,'in_array')">in_array</a>(<a class="var it1927" onMouseOver="hilite(1927)" onMouseOut="lolite()" onClick="logVariable('attribute')" href="../../_variables/attribute.html">$attribute</a>, <a class="var it15451" onMouseOver="hilite(15451)" onMouseOut="lolite()" onClick="logVariable('attrstotransform')" href="../../_variables/attrstotransform.html">$attrstotransform</a>)) {
<a name="l3875"><span class="linenum">3875</span></a>                      <a class="var it4997" onMouseOver="hilite(4997)" onMouseOut="lolite()" onClick="logVariable('configdata')" href="../../_variables/configdata.html">$configdata</a>[<a class="var it1927" onMouseOver="hilite(1927)" onMouseOut="lolite()" onClick="logVariable('attribute')" href="../../_variables/attribute.html">$attribute</a>] = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('contentprocessor')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/contentprocessor.html">contentprocessor</a>-&gt;<a class="function" onClick="logFunction('process_cdata')" href="../../_functions/process_cdata.html" onMouseOver="funcPopup(event,'process_cdata')">process_cdata</a>(<a class="var it394" onMouseOver="hilite(394)" onMouseOut="lolite()" onClick="logVariable('value')" href="../../_variables/value.html">$value</a>);
<a name="l3876"><span class="linenum">3876</span></a>                  }
<a name="l3877"><span class="linenum">3877</span></a>              }
<a name="l3878"><span class="linenum">3878</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('configdata')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/configdata.html">configdata</a> = <a class="phpfunction" onClick="logFunction('base64_encode')" href="../../_functions/base64_encode.html" onMouseOver="phpfuncPopup(event,'base64_encode')">base64_encode</a>(<a class="phpfunction" onClick="logFunction('serialize')" href="../../_functions/serialize.html" onMouseOver="phpfuncPopup(event,'serialize')">serialize</a>((object)<a class="var it4997" onMouseOver="hilite(4997)" onMouseOut="lolite()" onClick="logVariable('configdata')" href="../../_variables/configdata.html">$configdata</a>));
<a name="l3879"><span class="linenum">3879</span></a>          }
<a name="l3880"><span class="linenum">3880</span></a>  
<a name="l3881"><span class="linenum">3881</span></a>  <span class="comment">        // Create the block instance</span>
<a name="l3882"><span class="linenum">3882</span></a>          <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('block_instances', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l3883"><span class="linenum">3883</span></a>  <span class="comment">        // Save the mapping (with restorefiles support)</span>
<a name="l3884"><span class="linenum">3884</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('block_instance', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>, true);
<a name="l3885"><span class="linenum">3885</span></a>  <span class="comment">        // Create the block context</span>
<a name="l3886"><span class="linenum">3886</span></a>          <a class="var it5969" onMouseOver="hilite(5969)" onMouseOut="lolite()" onClick="logVariable('newcontextid')" href="../../_variables/newcontextid.html">$newcontextid</a> = <a class="class" onClick="logClass('context_block')" href="../../_classes/context_block.html" onMouseOver="classPopup(event,'context_block')">context_block</a>::<a class="function" onClick="logFunction('instance')" href="../../_functions/instance.html" onMouseOver="funcPopup(event,'instance')">instance</a>(<a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>)-&gt;id;
<a name="l3887"><span class="linenum">3887</span></a>  <span class="comment">        // Save the block contexts mapping and sent it to task</span>
<a name="l3888"><span class="linenum">3888</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('context', <a class="var it5968" onMouseOver="hilite(5968)" onMouseOut="lolite()" onClick="logVariable('oldcontextid')" href="../../_variables/oldcontextid.html">$oldcontextid</a>, <a class="var it5969" onMouseOver="hilite(5969)" onMouseOut="lolite()" onClick="logVariable('newcontextid')" href="../../_variables/newcontextid.html">$newcontextid</a>);
<a name="l3889"><span class="linenum">3889</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('set_contextid')" href="../../_functions/set_contextid.html" onMouseOver="funcPopup(event,'set_contextid')">set_contextid</a>(<a class="var it5969" onMouseOver="hilite(5969)" onMouseOut="lolite()" onClick="logVariable('newcontextid')" href="../../_variables/newcontextid.html">$newcontextid</a>);
<a name="l3890"><span class="linenum">3890</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('set_blockid')" href="../../_functions/set_blockid.html" onMouseOver="funcPopup(event,'set_blockid')">set_blockid</a>(<a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>);
<a name="l3891"><span class="linenum">3891</span></a>  
<a name="l3892"><span class="linenum">3892</span></a>  <span class="comment">        // Restore block fileareas if declared</span>
<a name="l3893"><span class="linenum">3893</span></a>          <a class="var it227" onMouseOver="hilite(227)" onMouseOut="lolite()" onClick="logVariable('component')" href="../../_variables/component.html">$component</a> = 'block_' . <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_blockname')" href="../../_functions/get_blockname.html" onMouseOver="funcPopup(event,'get_blockname')">get_blockname</a>();
<a name="l3894"><span class="linenum">3894</span></a>          foreach (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_fileareas')" href="../../_functions/get_fileareas.html" onMouseOver="funcPopup(event,'get_fileareas')">get_fileareas</a>() as <a class="var it24" onMouseOver="hilite(24)" onMouseOut="lolite()" onClick="logVariable('filearea')" href="../../_variables/filearea.html">$filearea</a>) { // Simple match by contextid. No itemname needed
<a name="l3895"><span class="linenum">3895</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_related_files')" href="../../_functions/add_related_files.html" onMouseOver="funcPopup(event,'add_related_files')">add_related_files</a>(<a class="var it227" onMouseOver="hilite(227)" onMouseOut="lolite()" onClick="logVariable('component')" href="../../_variables/component.html">$component</a>, <a class="var it24" onMouseOver="hilite(24)" onMouseOut="lolite()" onClick="logVariable('filearea')" href="../../_variables/filearea.html">$filearea</a>, null);
<a name="l3896"><span class="linenum">3896</span></a>          }
<a name="l3897"><span class="linenum">3897</span></a>  
<a name="l3898"><span class="linenum">3898</span></a>  <span class="comment">        // Process block positions, creating them or accumulating for final step</span>
<a name="l3899"><span class="linenum">3899</span></a>          foreach(<a class="var it9140" onMouseOver="hilite(9140)" onMouseOut="lolite()" onClick="logVariable('positions')" href="../../_variables/positions.html">$positions</a> as <a class="var it752" onMouseOver="hilite(752)" onMouseOut="lolite()" onClick="logVariable('position')" href="../../_variables/position.html">$position</a>) {
<a name="l3900"><span class="linenum">3900</span></a>              <a class="var it752" onMouseOver="hilite(752)" onMouseOut="lolite()" onClick="logVariable('position')" href="../../_variables/position.html">$position</a> = (object)<a class="var it752" onMouseOver="hilite(752)" onMouseOut="lolite()" onClick="logVariable('position')" href="../../_variables/position.html">$position</a>;
<a name="l3901"><span class="linenum">3901</span></a>              <a class="var it752" onMouseOver="hilite(752)" onMouseOut="lolite()" onClick="logVariable('position')" href="../../_variables/position.html">$position</a>-&gt;<a onClick="logVariable('blockinstanceid')" class="var it45288" onMouseOver="hilite(45288)" onMouseOut="lolite()" href="../../_variables/blockinstanceid.html">blockinstanceid</a> = <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>; <span class="comment">// The instance is always the restored one</span>
<a name="l3902"><span class="linenum">3902</span></a>  <span class="comment">            // If position is for one already mapped (known) contextid</span>
<a name="l3903"><span class="linenum">3903</span></a>  <span class="comment">            // process it now, creating the position</span>
<a name="l3904"><span class="linenum">3904</span></a>              if (<a class="var it15454" onMouseOver="hilite(15454)" onMouseOut="lolite()" onClick="logVariable('newpositionctxid')" href="../../_variables/newpositionctxid.html">$newpositionctxid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('context', <a class="var it752" onMouseOver="hilite(752)" onMouseOut="lolite()" onClick="logVariable('position')" href="../../_variables/position.html">$position</a>-&gt;<a onClick="logVariable('contextid')" class="var it45288" onMouseOver="hilite(45288)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a>)) {
<a name="l3905"><span class="linenum">3905</span></a>                  <a class="var it752" onMouseOver="hilite(752)" onMouseOut="lolite()" onClick="logVariable('position')" href="../../_variables/position.html">$position</a>-&gt;<a onClick="logVariable('contextid')" class="var it45288" onMouseOver="hilite(45288)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a> = <a class="var it15454" onMouseOver="hilite(15454)" onMouseOut="lolite()" onClick="logVariable('newpositionctxid')" href="../../_variables/newpositionctxid.html">$newpositionctxid</a>;
<a name="l3906"><span class="linenum">3906</span></a>  <span class="comment">                // Create the block position</span>
<a name="l3907"><span class="linenum">3907</span></a>                  <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('block_positions', <a class="var it752" onMouseOver="hilite(752)" onMouseOut="lolite()" onClick="logVariable('position')" href="../../_variables/position.html">$position</a>);
<a name="l3908"><span class="linenum">3908</span></a>  
<a name="l3909"><span class="linenum">3909</span></a>  <span class="comment">            // The position belongs to an unknown context, send it to backup_ids</span>
<a name="l3910"><span class="linenum">3910</span></a>  <span class="comment">            // to process them as part of the final steps of restore. We send the</span>
<a name="l3911"><span class="linenum">3911</span></a>  <span class="comment">            // whole $position object there, hence use the low level method.</span>
<a name="l3912"><span class="linenum">3912</span></a>              } else {
<a name="l3913"><span class="linenum">3913</span></a>                  restore_dbops::<a class="function" onClick="logFunction('set_backup_ids_record')" href="../../_functions/set_backup_ids_record.html" onMouseOver="funcPopup(event,'set_backup_ids_record')">set_backup_ids_record</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'block_position', <a class="var it752" onMouseOver="hilite(752)" onMouseOut="lolite()" onClick="logVariable('position')" href="../../_variables/position.html">$position</a>-&gt;<a onClick="logVariable('id')" class="var it45288" onMouseOver="hilite(45288)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, 0, null, <a class="var it752" onMouseOver="hilite(752)" onMouseOut="lolite()" onClick="logVariable('position')" href="../../_variables/position.html">$position</a>);
<a name="l3914"><span class="linenum">3914</span></a>              }
<a name="l3915"><span class="linenum">3915</span></a>          }
<a name="l3916"><span class="linenum">3916</span></a>      }
<a name="l3917"><span class="linenum">3917</span></a>  }
<a name="l3918"><span class="linenum">3918</span></a>  
<a name="l3919"><span class="linenum">3919</span></a>  <span class="comment">/**</span>
<a name="l3920"><span class="linenum">3920</span></a>  <span class="comment"> * Structure step to restore common course_module information</span>
<a name="l3921"><span class="linenum">3921</span></a>  <span class="comment"> *</span>
<a name="l3922"><span class="linenum">3922</span></a>  <span class="comment"> * This step will process the module.xml file for one activity, in order to restore</span>
<a name="l3923"><span class="linenum">3923</span></a>  <span class="comment"> * the corresponding information to the course_modules table, skipping various bits</span>
<a name="l3924"><span class="linenum">3924</span></a>  <span class="comment"> * of information based on CFG settings (groupings, completion...) in order to fullfill</span>
<a name="l3925"><span class="linenum">3925</span></a>  <span class="comment"> * all the reqs to be able to create the context to be used by all the rest of steps</span>
<a name="l3926"><span class="linenum">3926</span></a>  <span class="comment"> * in the activity restore task</span>
<a name="l3927"><span class="linenum">3927</span></a>  <span class="comment"> */</span>
<a name="l3928"><span class="linenum">3928</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_module_structure_step')" href="../../_classes/restore_module_structure_step.html" onMouseOver="classPopup(event,'restore_module_structure_step')">restore_module_structure_step</a> extends restore_structure_step {
<a name="l3929"><span class="linenum">3929</span></a>  
<a name="l3930"><span class="linenum">3930</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l3931"><span class="linenum">3931</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>;
<a name="l3932"><span class="linenum">3932</span></a>  
<a name="l3933"><span class="linenum">3933</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array();
<a name="l3934"><span class="linenum">3934</span></a>  
<a name="l3935"><span class="linenum">3935</span></a>          <a class="var it994" onMouseOver="hilite(994)" onMouseOut="lolite()" onClick="logVariable('module')" href="../../_variables/module.html">$module</a> = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('module', '/module');
<a name="l3936"><span class="linenum">3936</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <a class="var it994" onMouseOver="hilite(994)" onMouseOut="lolite()" onClick="logVariable('module')" href="../../_variables/module.html">$module</a>;
<a name="l3937"><span class="linenum">3937</span></a>          if (<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('enableavailability')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/enableavailability.html">enableavailability</a>) {
<a name="l3938"><span class="linenum">3938</span></a>              <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('availability', '/module/availability_info/availability');
<a name="l3939"><span class="linenum">3939</span></a>              <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('availability_field', '/module/availability_info/availability_field');
<a name="l3940"><span class="linenum">3940</span></a>          }
<a name="l3941"><span class="linenum">3941</span></a>  
<a name="l3942"><span class="linenum">3942</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('tag', '/module/tags/tag');
<a name="l3943"><span class="linenum">3943</span></a>  
<a name="l3944"><span class="linenum">3944</span></a>  <span class="comment">        // Apply for 'format' plugins optional paths at module level</span>
<a name="l3945"><span class="linenum">3945</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('format', <a class="var it994" onMouseOver="hilite(994)" onMouseOut="lolite()" onClick="logVariable('module')" href="../../_variables/module.html">$module</a>);
<a name="l3946"><span class="linenum">3946</span></a>  
<a name="l3947"><span class="linenum">3947</span></a>  <span class="comment">        // Apply for 'plagiarism' plugins optional paths at module level</span>
<a name="l3948"><span class="linenum">3948</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('plagiarism', <a class="var it994" onMouseOver="hilite(994)" onMouseOut="lolite()" onClick="logVariable('module')" href="../../_variables/module.html">$module</a>);
<a name="l3949"><span class="linenum">3949</span></a>  
<a name="l3950"><span class="linenum">3950</span></a>  <span class="comment">        // Apply for 'local' plugins optional paths at module level</span>
<a name="l3951"><span class="linenum">3951</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('local', <a class="var it994" onMouseOver="hilite(994)" onMouseOut="lolite()" onClick="logVariable('module')" href="../../_variables/module.html">$module</a>);
<a name="l3952"><span class="linenum">3952</span></a>  
<a name="l3953"><span class="linenum">3953</span></a>  <span class="comment">        // Apply for 'admin tool' plugins optional paths at module level.</span>
<a name="l3954"><span class="linenum">3954</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('tool', <a class="var it994" onMouseOver="hilite(994)" onMouseOut="lolite()" onClick="logVariable('module')" href="../../_variables/module.html">$module</a>);
<a name="l3955"><span class="linenum">3955</span></a>  
<a name="l3956"><span class="linenum">3956</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l3957"><span class="linenum">3957</span></a>      }
<a name="l3958"><span class="linenum">3958</span></a>  
<a name="l3959"><span class="linenum">3959</span></a>      protected function <a class="function" onClick="logFunction('process_module')" href="../../_functions/process_module.html" onMouseOver="funcPopup(event,'process_module')">process_module</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l3960"><span class="linenum">3960</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l3961"><span class="linenum">3961</span></a>  
<a name="l3962"><span class="linenum">3962</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l3963"><span class="linenum">3963</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l3964"><span class="linenum">3964</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('set_old_moduleversion')" href="../../_functions/set_old_moduleversion.html" onMouseOver="funcPopup(event,'set_old_moduleversion')">set_old_moduleversion</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('version')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/version.html">version</a>);
<a name="l3965"><span class="linenum">3965</span></a>  
<a name="l3966"><span class="linenum">3966</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('course')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/course.html">course</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>();
<a name="l3967"><span class="linenum">3967</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('module')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/module.html">module</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('modules', 'id', array('name' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('modulename')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/modulename.html">modulename</a>));
<a name="l3968"><span class="linenum">3968</span></a>  <span class="comment">        // Map section (first try by course_section mapping match. Useful in course and section restores)</span>
<a name="l3969"><span class="linenum">3969</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('section')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/section.html">section</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('course_section', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('sectionid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/sectionid.html">sectionid</a>);
<a name="l3970"><span class="linenum">3970</span></a>          if (!<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('section')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/section.html">section</a>) { // mapping failed, try to get section by sectionnumber matching
<a name="l3971"><span class="linenum">3971</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array(
<a name="l3972"><span class="linenum">3972</span></a>                  'course' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(),
<a name="l3973"><span class="linenum">3973</span></a>                  'section' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('sectionnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/sectionnumber.html">sectionnumber</a>);
<a name="l3974"><span class="linenum">3974</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('section')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/section.html">section</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('course_sections', 'id', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l3975"><span class="linenum">3975</span></a>          }
<a name="l3976"><span class="linenum">3976</span></a>          if (!<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('section')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/section.html">section</a>) { // sectionnumber failed, try to get first section in course
<a name="l3977"><span class="linenum">3977</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array(
<a name="l3978"><span class="linenum">3978</span></a>                  'course' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>());
<a name="l3979"><span class="linenum">3979</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('section')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/section.html">section</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('course_sections', '<a class="phpfunction" onClick="logFunction('MIN')" href="../../_functions/min.html" onMouseOver="phpfuncPopup(event,'min')">MIN</a>(id)', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l3980"><span class="linenum">3980</span></a>          }
<a name="l3981"><span class="linenum">3981</span></a>          if (!<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('section')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/section.html">section</a>) { // no sections in course, create section 0 and 1 and assign module to 1
<a name="l3982"><span class="linenum">3982</span></a>              <a class="var it15367" onMouseOver="hilite(15367)" onMouseOut="lolite()" onClick="logVariable('sectionrec')" href="../../_variables/sectionrec.html">$sectionrec</a> = array(
<a name="l3983"><span class="linenum">3983</span></a>                  'course' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(),
<a name="l3984"><span class="linenum">3984</span></a>                  'section' =&gt; 0);
<a name="l3985"><span class="linenum">3985</span></a>              <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('course_sections', <a class="var it15367" onMouseOver="hilite(15367)" onMouseOut="lolite()" onClick="logVariable('sectionrec')" href="../../_variables/sectionrec.html">$sectionrec</a>); <span class="comment">// section 0</span>
<a name="l3986"><span class="linenum">3986</span></a>              <a class="var it15367" onMouseOver="hilite(15367)" onMouseOut="lolite()" onClick="logVariable('sectionrec')" href="../../_variables/sectionrec.html">$sectionrec</a> = array(
<a name="l3987"><span class="linenum">3987</span></a>                  'course' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>(),
<a name="l3988"><span class="linenum">3988</span></a>                  'section' =&gt; 1);
<a name="l3989"><span class="linenum">3989</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('section')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/section.html">section</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('course_sections', <a class="var it15367" onMouseOver="hilite(15367)" onMouseOut="lolite()" onClick="logVariable('sectionrec')" href="../../_variables/sectionrec.html">$sectionrec</a>); <span class="comment">// section 1</span>
<a name="l3990"><span class="linenum">3990</span></a>          }
<a name="l3991"><span class="linenum">3991</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('groupingid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/groupingid.html">groupingid</a>= <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('grouping', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('groupingid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/groupingid.html">groupingid</a>);      <span class="comment">// grouping</span>
<a name="l3992"><span class="linenum">3992</span></a>          if (!<a class="function" onClick="logFunction('grade_verify_idnumber')" href="../../_functions/grade_verify_idnumber.html" onMouseOver="funcPopup(event,'grade_verify_idnumber')">grade_verify_idnumber</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>())) {        // idnumber uniqueness
<a name="l3993"><span class="linenum">3993</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('idnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/idnumber.html">idnumber</a> = '';
<a name="l3994"><span class="linenum">3994</span></a>          }
<a name="l3995"><span class="linenum">3995</span></a>          if (empty(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('enablecompletion')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/enablecompletion.html">enablecompletion</a>)) { // completion
<a name="l3996"><span class="linenum">3996</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('completion')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/completion.html">completion</a> = 0;
<a name="l3997"><span class="linenum">3997</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('completiongradeitemnumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/completiongradeitemnumber.html">completiongradeitemnumber</a> = null;
<a name="l3998"><span class="linenum">3998</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('completionview')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/completionview.html">completionview</a> = 0;
<a name="l3999"><span class="linenum">3999</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('completionexpected')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/completionexpected.html">completionexpected</a> = 0;
<a name="l4000"><span class="linenum">4000</span></a>          } else {
<a name="l4001"><span class="linenum">4001</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('completionexpected')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/completionexpected.html">completionexpected</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('completionexpected')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/completionexpected.html">completionexpected</a>);
<a name="l4002"><span class="linenum">4002</span></a>          }
<a name="l4003"><span class="linenum">4003</span></a>          if (empty(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('enableavailability')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/enableavailability.html">enableavailability</a>)) {
<a name="l4004"><span class="linenum">4004</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('availability')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/availability.html">availability</a> = null;
<a name="l4005"><span class="linenum">4005</span></a>          }
<a name="l4006"><span class="linenum">4006</span></a>  <span class="comment">        // Backups that did not include showdescription, set it to default 0</span>
<a name="l4007"><span class="linenum">4007</span></a>  <span class="comment">        // (this is not totally necessary as it has a db default, but just to</span>
<a name="l4008"><span class="linenum">4008</span></a>  <span class="comment">        // be explicit).</span>
<a name="l4009"><span class="linenum">4009</span></a>          if (!isset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('showdescription')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/showdescription.html">showdescription</a>)) {
<a name="l4010"><span class="linenum">4010</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('showdescription')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/showdescription.html">showdescription</a> = 0;
<a name="l4011"><span class="linenum">4011</span></a>          }
<a name="l4012"><span class="linenum">4012</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('instance')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/instance.html">instance</a> = 0; <span class="comment">// Set to 0 for now, going to create it soon (next step)</span>
<a name="l4013"><span class="linenum">4013</span></a>  
<a name="l4014"><span class="linenum">4014</span></a>          if (empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('availability')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/availability.html">availability</a>)) {
<a name="l4015"><span class="linenum">4015</span></a>  <span class="comment">            // If there are legacy availablility data fields (and no new format data),</span>
<a name="l4016"><span class="linenum">4016</span></a>  <span class="comment">            // convert the old fields.</span>
<a name="l4017"><span class="linenum">4017</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('availability')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/availability.html">availability</a> = \core_availability\<a class="class" onClick="logClass('info')" href="../../_classes/info.html" onMouseOver="classPopup(event,'info')">info</a>::<a class="function" onClick="logFunction('convert_legacy_fields')" href="../../_functions/convert_legacy_fields.html" onMouseOver="funcPopup(event,'convert_legacy_fields')">convert_legacy_fields</a>(
<a name="l4018"><span class="linenum">4018</span></a>                      <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, false);
<a name="l4019"><span class="linenum">4019</span></a>          } else if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('groupmembersonly')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/groupmembersonly.html">groupmembersonly</a>)) {
<a name="l4020"><span class="linenum">4020</span></a>  <span class="comment">            // There is current availability data, but it still has groupmembersonly</span>
<a name="l4021"><span class="linenum">4021</span></a>  <span class="comment">            // as well (2.7 backups), convert just that part.</span>
<a name="l4022"><span class="linenum">4022</span></a>              require_once(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('dirroot')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/dirroot.html">dirroot</a> . '<a class="filename" href="../../lib/db/upgradelib.php.html">/lib/db/upgradelib.php</a>');
<a name="l4023"><span class="linenum">4023</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('availability')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/availability.html">availability</a> = <a class="function" onClick="logFunction('upgrade_group_members_only')" href="../../_functions/upgrade_group_members_only.html" onMouseOver="funcPopup(event,'upgrade_group_members_only')">upgrade_group_members_only</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('groupingid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/groupingid.html">groupingid</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('availability')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/availability.html">availability</a>);
<a name="l4024"><span class="linenum">4024</span></a>          }
<a name="l4025"><span class="linenum">4025</span></a>  
<a name="l4026"><span class="linenum">4026</span></a>  <span class="comment">        // course_module record ready, insert it</span>
<a name="l4027"><span class="linenum">4027</span></a>          <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('course_modules', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l4028"><span class="linenum">4028</span></a>  <span class="comment">        // save mapping</span>
<a name="l4029"><span class="linenum">4029</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('course_module', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>);
<a name="l4030"><span class="linenum">4030</span></a>  <span class="comment">        // set the new course_module id in the task</span>
<a name="l4031"><span class="linenum">4031</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('set_moduleid')" href="../../_functions/set_moduleid.html" onMouseOver="funcPopup(event,'set_moduleid')">set_moduleid</a>(<a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>);
<a name="l4032"><span class="linenum">4032</span></a>  <span class="comment">        // we can now create the context safely</span>
<a name="l4033"><span class="linenum">4033</span></a>          <a class="var it5403" onMouseOver="hilite(5403)" onMouseOut="lolite()" onClick="logVariable('ctxid')" href="../../_variables/ctxid.html">$ctxid</a> = <a class="class" onClick="logClass('context_module')" href="../../_classes/context_module.html" onMouseOver="classPopup(event,'context_module')">context_module</a>::<a class="function" onClick="logFunction('instance')" href="../../_functions/instance.html" onMouseOver="funcPopup(event,'instance')">instance</a>(<a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>)-&gt;id;
<a name="l4034"><span class="linenum">4034</span></a>  <span class="comment">        // set the new context id in the task</span>
<a name="l4035"><span class="linenum">4035</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('set_contextid')" href="../../_functions/set_contextid.html" onMouseOver="funcPopup(event,'set_contextid')">set_contextid</a>(<a class="var it5403" onMouseOver="hilite(5403)" onMouseOut="lolite()" onClick="logVariable('ctxid')" href="../../_variables/ctxid.html">$ctxid</a>);
<a name="l4036"><span class="linenum">4036</span></a>  <span class="comment">        // update sequence field in course_section</span>
<a name="l4037"><span class="linenum">4037</span></a>          if (<a class="var it5341" onMouseOver="hilite(5341)" onMouseOut="lolite()" onClick="logVariable('sequence')" href="../../_variables/sequence.html">$sequence</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('course_sections', 'sequence', array('id' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('section')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/section.html">section</a>))) {
<a name="l4038"><span class="linenum">4038</span></a>              <a class="var it5341" onMouseOver="hilite(5341)" onMouseOut="lolite()" onClick="logVariable('sequence')" href="../../_variables/sequence.html">$sequence</a> .= ',' . <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>;
<a name="l4039"><span class="linenum">4039</span></a>          } else {
<a name="l4040"><span class="linenum">4040</span></a>              <a class="var it5341" onMouseOver="hilite(5341)" onMouseOut="lolite()" onClick="logVariable('sequence')" href="../../_variables/sequence.html">$sequence</a> = <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>;
<a name="l4041"><span class="linenum">4041</span></a>          }
<a name="l4042"><span class="linenum">4042</span></a>          <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('set_field')" href="../../_functions/set_field.html" onMouseOver="funcPopup(event,'set_field')">set_field</a>('course_sections', 'sequence', <a class="var it5341" onMouseOver="hilite(5341)" onMouseOut="lolite()" onClick="logVariable('sequence')" href="../../_variables/sequence.html">$sequence</a>, array('id' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('section')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/section.html">section</a>));
<a name="l4043"><span class="linenum">4043</span></a>  
<a name="l4044"><span class="linenum">4044</span></a>  <span class="comment">        // If there is the legacy showavailability data, store this for later use.</span>
<a name="l4045"><span class="linenum">4045</span></a>  <span class="comment">        // (This data is not present when restoring 'new' backups.)</span>
<a name="l4046"><span class="linenum">4046</span></a>          if (isset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('showavailability')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/showavailability.html">showavailability</a>)) {
<a name="l4047"><span class="linenum">4047</span></a>  <span class="comment">            // Cache the showavailability flag using the backup_ids data field.</span>
<a name="l4048"><span class="linenum">4048</span></a>              restore_dbops::<a class="function" onClick="logFunction('set_backup_ids_record')" href="../../_functions/set_backup_ids_record.html" onMouseOver="funcPopup(event,'set_backup_ids_record')">set_backup_ids_record</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(),
<a name="l4049"><span class="linenum">4049</span></a>                      'module_showavailability', <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>, 0, null,
<a name="l4050"><span class="linenum">4050</span></a>                      (object)array('showavailability' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('showavailability')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/showavailability.html">showavailability</a>));
<a name="l4051"><span class="linenum">4051</span></a>          }
<a name="l4052"><span class="linenum">4052</span></a>      }
<a name="l4053"><span class="linenum">4053</span></a>  
<a name="l4054"><span class="linenum">4054</span></a>      <span class="comment">/**</span>
<a name="l4055"><span class="linenum">4055</span></a>  <span class="comment">     * Fetch all the existing because tag_set() deletes them</span>
<a name="l4056"><span class="linenum">4056</span></a>  <span class="comment">     * so everything must be reinserted on each call.</span>
<a name="l4057"><span class="linenum">4057</span></a>  <span class="comment">     *</span>
<a name="l4058"><span class="linenum">4058</span></a>  <span class="comment">     * @param stdClass $data Record data</span>
<a name="l4059"><span class="linenum">4059</span></a>  <span class="comment">     */</span>
<a name="l4060"><span class="linenum">4060</span></a>      protected function <a class="function" onClick="logFunction('process_tag')" href="../../_functions/process_tag.html" onMouseOver="funcPopup(event,'process_tag')">process_tag</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l4061"><span class="linenum">4061</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>;
<a name="l4062"><span class="linenum">4062</span></a>  
<a name="l4063"><span class="linenum">4063</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l4064"><span class="linenum">4064</span></a>  
<a name="l4065"><span class="linenum">4065</span></a>          if (<a class="class" onClick="logClass('core_tag_tag')" href="../../_classes/core_tag_tag.html" onMouseOver="classPopup(event,'core_tag_tag')">core_tag_tag</a>::<a class="function" onClick="logFunction('is_enabled')" href="../../_functions/is_enabled.html" onMouseOver="funcPopup(event,'is_enabled')">is_enabled</a>('core', 'course_modules')) {
<a name="l4066"><span class="linenum">4066</span></a>              <a class="var it2714" onMouseOver="hilite(2714)" onMouseOut="lolite()" onClick="logVariable('modcontext')" href="../../_variables/modcontext.html">$modcontext</a> = context::<a class="function" onClick="logFunction('instance_by_id')" href="../../_functions/instance_by_id.html" onMouseOver="funcPopup(event,'instance_by_id')">instance_by_id</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_contextid')" href="../../_functions/get_contextid.html" onMouseOver="funcPopup(event,'get_contextid')">get_contextid</a>());
<a name="l4067"><span class="linenum">4067</span></a>              <a class="var it1184" onMouseOver="hilite(1184)" onMouseOut="lolite()" onClick="logVariable('instanceid')" href="../../_variables/instanceid.html">$instanceid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_moduleid')" href="../../_functions/get_moduleid.html" onMouseOver="funcPopup(event,'get_moduleid')">get_moduleid</a>();
<a name="l4068"><span class="linenum">4068</span></a>  
<a name="l4069"><span class="linenum">4069</span></a>              <a class="class" onClick="logClass('core_tag_tag')" href="../../_classes/core_tag_tag.html" onMouseOver="classPopup(event,'core_tag_tag')">core_tag_tag</a>::<a class="function" onClick="logFunction('add_item_tag')" href="../../_functions/add_item_tag.html" onMouseOver="funcPopup(event,'add_item_tag')">add_item_tag</a>('core', 'course_modules', <a class="var it1184" onMouseOver="hilite(1184)" onMouseOut="lolite()" onClick="logVariable('instanceid')" href="../../_variables/instanceid.html">$instanceid</a>, <a class="var it2714" onMouseOver="hilite(2714)" onMouseOut="lolite()" onClick="logVariable('modcontext')" href="../../_variables/modcontext.html">$modcontext</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('rawname')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/rawname.html">rawname</a>);
<a name="l4070"><span class="linenum">4070</span></a>          }
<a name="l4071"><span class="linenum">4071</span></a>      }
<a name="l4072"><span class="linenum">4072</span></a>  
<a name="l4073"><span class="linenum">4073</span></a>      <span class="comment">/**</span>
<a name="l4074"><span class="linenum">4074</span></a>  <span class="comment">     * Process the legacy availability table record. This table does not exist</span>
<a name="l4075"><span class="linenum">4075</span></a>  <span class="comment">     * in Moodle 2.7+ but we still support restore.</span>
<a name="l4076"><span class="linenum">4076</span></a>  <span class="comment">     *</span>
<a name="l4077"><span class="linenum">4077</span></a>  <span class="comment">     * @param stdClass $data Record data</span>
<a name="l4078"><span class="linenum">4078</span></a>  <span class="comment">     */</span>
<a name="l4079"><span class="linenum">4079</span></a>      protected function <a class="function" onClick="logFunction('process_availability')" href="../../_functions/process_availability.html" onMouseOver="funcPopup(event,'process_availability')">process_availability</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l4080"><span class="linenum">4080</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l4081"><span class="linenum">4081</span></a>  <span class="comment">        // Simply going to store the whole availability record now, we'll process</span>
<a name="l4082"><span class="linenum">4082</span></a>  <span class="comment">        // all them later in the final task (once all activities have been restored)</span>
<a name="l4083"><span class="linenum">4083</span></a>  <span class="comment">        // Let's call the low level one to be able to store the whole object</span>
<a name="l4084"><span class="linenum">4084</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('coursemoduleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/coursemoduleid.html">coursemoduleid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_moduleid')" href="../../_functions/get_moduleid.html" onMouseOver="funcPopup(event,'get_moduleid')">get_moduleid</a>(); <span class="comment">// Let add the availability cmid</span>
<a name="l4085"><span class="linenum">4085</span></a>          restore_dbops::<a class="function" onClick="logFunction('set_backup_ids_record')" href="../../_functions/set_backup_ids_record.html" onMouseOver="funcPopup(event,'set_backup_ids_record')">set_backup_ids_record</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'module_availability', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, 0, null, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l4086"><span class="linenum">4086</span></a>      }
<a name="l4087"><span class="linenum">4087</span></a>  
<a name="l4088"><span class="linenum">4088</span></a>      <span class="comment">/**</span>
<a name="l4089"><span class="linenum">4089</span></a>  <span class="comment">     * Process the legacy availability fields table record. This table does not</span>
<a name="l4090"><span class="linenum">4090</span></a>  <span class="comment">     * exist in Moodle 2.7+ but we still support restore.</span>
<a name="l4091"><span class="linenum">4091</span></a>  <span class="comment">     *</span>
<a name="l4092"><span class="linenum">4092</span></a>  <span class="comment">     * @param stdClass $data Record data</span>
<a name="l4093"><span class="linenum">4093</span></a>  <span class="comment">     */</span>
<a name="l4094"><span class="linenum">4094</span></a>      protected function <a class="function" onClick="logFunction('process_availability_field')" href="../../_functions/process_availability_field.html" onMouseOver="funcPopup(event,'process_availability_field')">process_availability_field</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l4095"><span class="linenum">4095</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l4096"><span class="linenum">4096</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l4097"><span class="linenum">4097</span></a>  <span class="comment">        // Mark it is as passed by default</span>
<a name="l4098"><span class="linenum">4098</span></a>          <a class="var it15392" onMouseOver="hilite(15392)" onMouseOut="lolite()" onClick="logVariable('passed')" href="../../_variables/passed.html">$passed</a> = true;
<a name="l4099"><span class="linenum">4099</span></a>          <a class="var it15393" onMouseOver="hilite(15393)" onMouseOut="lolite()" onClick="logVariable('customfieldid')" href="../../_variables/customfieldid.html">$customfieldid</a> = null;
<a name="l4100"><span class="linenum">4100</span></a>  
<a name="l4101"><span class="linenum">4101</span></a>  <span class="comment">        // If a customfield has been used in order to pass we must be able to match an existing</span>
<a name="l4102"><span class="linenum">4102</span></a>  <span class="comment">        // customfield by name (data-&gt;customfield) and type (data-&gt;customfieldtype)</span>
<a name="l4103"><span class="linenum">4103</span></a>          if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('customfield')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/customfield.html">customfield</a>) xor !empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('customfieldtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/customfieldtype.html">customfieldtype</a>)) {
<a name="l4104"><span class="linenum">4104</span></a>  <span class="comment">            // xor is sort of uncommon. If either customfield is null or customfieldtype is null BUT not both.</span>
<a name="l4105"><span class="linenum">4105</span></a>  <span class="comment">            // If one is null but the other isn't something clearly went wrong and we'll skip this condition.</span>
<a name="l4106"><span class="linenum">4106</span></a>              <a class="var it15392" onMouseOver="hilite(15392)" onMouseOut="lolite()" onClick="logVariable('passed')" href="../../_variables/passed.html">$passed</a> = false;
<a name="l4107"><span class="linenum">4107</span></a>          } else if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('customfield')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/customfield.html">customfield</a>)) {
<a name="l4108"><span class="linenum">4108</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array('shortname' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('customfield')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/customfield.html">customfield</a>, 'datatype' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('customfieldtype')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/customfieldtype.html">customfieldtype</a>);
<a name="l4109"><span class="linenum">4109</span></a>              <a class="var it15393" onMouseOver="hilite(15393)" onMouseOut="lolite()" onClick="logVariable('customfieldid')" href="../../_variables/customfieldid.html">$customfieldid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('user_info_field', 'id', <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l4110"><span class="linenum">4110</span></a>              <a class="var it15392" onMouseOver="hilite(15392)" onMouseOut="lolite()" onClick="logVariable('passed')" href="../../_variables/passed.html">$passed</a> = (<a class="var it15393" onMouseOver="hilite(15393)" onMouseOut="lolite()" onClick="logVariable('customfieldid')" href="../../_variables/customfieldid.html">$customfieldid</a> !== false);
<a name="l4111"><span class="linenum">4111</span></a>          }
<a name="l4112"><span class="linenum">4112</span></a>  
<a name="l4113"><span class="linenum">4113</span></a>          if (<a class="var it15392" onMouseOver="hilite(15392)" onMouseOut="lolite()" onClick="logVariable('passed')" href="../../_variables/passed.html">$passed</a>) {
<a name="l4114"><span class="linenum">4114</span></a>  <span class="comment">            // Create the object to insert into the database</span>
<a name="l4115"><span class="linenum">4115</span></a>              <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a> = new stdClass();
<a name="l4116"><span class="linenum">4116</span></a>              <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a>-&gt;<a onClick="logVariable('coursemoduleid')" class="var it45298" onMouseOver="hilite(45298)" onMouseOut="lolite()" href="../../_variables/coursemoduleid.html">coursemoduleid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_moduleid')" href="../../_functions/get_moduleid.html" onMouseOver="funcPopup(event,'get_moduleid')">get_moduleid</a>(); <span class="comment">// Lets add the availability cmid</span>
<a name="l4117"><span class="linenum">4117</span></a>              <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a>-&gt;<a onClick="logVariable('userfield')" class="var it45298" onMouseOver="hilite(45298)" onMouseOut="lolite()" href="../../_variables/userfield.html">userfield</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userfield')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userfield.html">userfield</a>;
<a name="l4118"><span class="linenum">4118</span></a>              <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a>-&gt;<a onClick="logVariable('customfieldid')" class="var it45298" onMouseOver="hilite(45298)" onMouseOut="lolite()" href="../../_variables/customfieldid.html">customfieldid</a> = <a class="var it15393" onMouseOver="hilite(15393)" onMouseOut="lolite()" onClick="logVariable('customfieldid')" href="../../_variables/customfieldid.html">$customfieldid</a>;
<a name="l4119"><span class="linenum">4119</span></a>              <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a>-&gt;<a onClick="logVariable('operator')" class="var it45298" onMouseOver="hilite(45298)" onMouseOut="lolite()" href="../../_variables/operator.html">operator</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('operator')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/operator.html">operator</a>;
<a name="l4120"><span class="linenum">4120</span></a>              <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a>-&gt;<a onClick="logVariable('value')" class="var it45298" onMouseOver="hilite(45298)" onMouseOut="lolite()" href="../../_variables/value.html">value</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('value')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/value.html">value</a>;
<a name="l4121"><span class="linenum">4121</span></a>  
<a name="l4122"><span class="linenum">4122</span></a>  <span class="comment">            // Get showavailability option.</span>
<a name="l4123"><span class="linenum">4123</span></a>              <a class="var it15376" onMouseOver="hilite(15376)" onMouseOut="lolite()" onClick="logVariable('showrec')" href="../../_variables/showrec.html">$showrec</a> = restore_dbops::<a class="function" onClick="logFunction('get_backup_ids_record')" href="../../_functions/get_backup_ids_record.html" onMouseOver="funcPopup(event,'get_backup_ids_record')">get_backup_ids_record</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(),
<a name="l4124"><span class="linenum">4124</span></a>                      'module_showavailability', <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a>-&gt;<a onClick="logVariable('coursemoduleid')" class="var it45298" onMouseOver="hilite(45298)" onMouseOut="lolite()" href="../../_variables/coursemoduleid.html">coursemoduleid</a>);
<a name="l4125"><span class="linenum">4125</span></a>              if (!<a class="var it15376" onMouseOver="hilite(15376)" onMouseOut="lolite()" onClick="logVariable('showrec')" href="../../_variables/showrec.html">$showrec</a>) {
<a name="l4126"><span class="linenum">4126</span></a>  <span class="comment">                // Should not happen.</span>
<a name="l4127"><span class="linenum">4127</span></a>                  throw <span class="keyword">new </span><a class="class" onClick="logClass('coding_exception')" href="../../_classes/coding_exception.html" onMouseOver="classPopup(event,'coding_exception')">coding_exception</a>('No matching showavailability record');
<a name="l4128"><span class="linenum">4128</span></a>              }
<a name="l4129"><span class="linenum">4129</span></a>              <a class="var it1794" onMouseOver="hilite(1794)" onMouseOut="lolite()" onClick="logVariable('show')" href="../../_variables/show.html">$show</a> = <a class="var it15376" onMouseOver="hilite(15376)" onMouseOut="lolite()" onClick="logVariable('showrec')" href="../../_variables/showrec.html">$showrec</a>-&gt;<a onClick="logVariable('info')" class="var it45292" onMouseOver="hilite(45292)" onMouseOut="lolite()" href="../../_variables/info.html">info</a>-&gt;showavailability;
<a name="l4130"><span class="linenum">4130</span></a>  
<a name="l4131"><span class="linenum">4131</span></a>  <span class="comment">            // The $availfieldobject is now in the format used in the old</span>
<a name="l4132"><span class="linenum">4132</span></a>  <span class="comment">            // system. Interpret this and convert to new system.</span>
<a name="l4133"><span class="linenum">4133</span></a>              <a class="var it15377" onMouseOver="hilite(15377)" onMouseOut="lolite()" onClick="logVariable('currentvalue')" href="../../_variables/currentvalue.html">$currentvalue</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('course_modules', 'availability',
<a name="l4134"><span class="linenum">4134</span></a>                      array('id' =&gt; <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a>-&gt;<a onClick="logVariable('coursemoduleid')" class="var it45298" onMouseOver="hilite(45298)" onMouseOut="lolite()" href="../../_variables/coursemoduleid.html">coursemoduleid</a>), <a class="constant" onClick="logConstant('MUST_EXIST')" href="../../_constants/MUST_EXIST.html" onMouseOver="constPopup(event,'MUST_EXIST')">MUST_EXIST</a>);
<a name="l4135"><span class="linenum">4135</span></a>              <a class="var it3475" onMouseOver="hilite(3475)" onMouseOut="lolite()" onClick="logVariable('newvalue')" href="../../_variables/newvalue.html">$newvalue</a> = \core_availability\<a class="class" onClick="logClass('info')" href="../../_classes/info.html" onMouseOver="classPopup(event,'info')">info</a>::<a class="function" onClick="logFunction('add_legacy_availability_field_condition')" href="../../_functions/add_legacy_availability_field_condition.html" onMouseOver="funcPopup(event,'add_legacy_availability_field_condition')">add_legacy_availability_field_condition</a>(
<a name="l4136"><span class="linenum">4136</span></a>                      <a class="var it15377" onMouseOver="hilite(15377)" onMouseOut="lolite()" onClick="logVariable('currentvalue')" href="../../_variables/currentvalue.html">$currentvalue</a>, <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a>, <a class="var it1794" onMouseOver="hilite(1794)" onMouseOut="lolite()" onClick="logVariable('show')" href="../../_variables/show.html">$show</a>);
<a name="l4137"><span class="linenum">4137</span></a>              <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('set_field')" href="../../_functions/set_field.html" onMouseOver="funcPopup(event,'set_field')">set_field</a>('course_modules', 'availability', <a class="var it3475" onMouseOver="hilite(3475)" onMouseOut="lolite()" onClick="logVariable('newvalue')" href="../../_variables/newvalue.html">$newvalue</a>,
<a name="l4138"><span class="linenum">4138</span></a>                      array('id' =&gt; <a class="var it15396" onMouseOver="hilite(15396)" onMouseOut="lolite()" onClick="logVariable('availfield')" href="../../_variables/availfield.html">$availfield</a>-&gt;<a onClick="logVariable('coursemoduleid')" class="var it45298" onMouseOver="hilite(45298)" onMouseOut="lolite()" href="../../_variables/coursemoduleid.html">coursemoduleid</a>));
<a name="l4139"><span class="linenum">4139</span></a>          }
<a name="l4140"><span class="linenum">4140</span></a>      }
<a name="l4141"><span class="linenum">4141</span></a>      <span class="comment">/**</span>
<a name="l4142"><span class="linenum">4142</span></a>  <span class="comment">     * This method will be executed after the rest of the restore has been processed.</span>
<a name="l4143"><span class="linenum">4143</span></a>  <span class="comment">     *</span>
<a name="l4144"><span class="linenum">4144</span></a>  <span class="comment">     * Update old tag instance itemid(s).</span>
<a name="l4145"><span class="linenum">4145</span></a>  <span class="comment">     */</span>
<a name="l4146"><span class="linenum">4146</span></a>      protected function <a class="function" onClick="logFunction('after_restore')" href="../../_functions/after_restore.html" onMouseOver="funcPopup(event,'after_restore')">after_restore</a>() {
<a name="l4147"><span class="linenum">4147</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l4148"><span class="linenum">4148</span></a>  
<a name="l4149"><span class="linenum">4149</span></a>          <a class="var it782" onMouseOver="hilite(782)" onMouseOut="lolite()" onClick="logVariable('contextid')" href="../../_variables/contextid.html">$contextid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_contextid')" href="../../_functions/get_contextid.html" onMouseOver="funcPopup(event,'get_contextid')">get_contextid</a>();
<a name="l4150"><span class="linenum">4150</span></a>          <a class="var it1184" onMouseOver="hilite(1184)" onMouseOut="lolite()" onClick="logVariable('instanceid')" href="../../_variables/instanceid.html">$instanceid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_activityid')" href="../../_functions/get_activityid.html" onMouseOver="funcPopup(event,'get_activityid')">get_activityid</a>();
<a name="l4151"><span class="linenum">4151</span></a>          <a class="var it15456" onMouseOver="hilite(15456)" onMouseOut="lolite()" onClick="logVariable('olditemid')" href="../../_variables/olditemid.html">$olditemid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_old_activityid')" href="../../_functions/get_old_activityid.html" onMouseOver="funcPopup(event,'get_old_activityid')">get_old_activityid</a>();
<a name="l4152"><span class="linenum">4152</span></a>  
<a name="l4153"><span class="linenum">4153</span></a>          <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('set_field')" href="../../_functions/set_field.html" onMouseOver="funcPopup(event,'set_field')">set_field</a>('tag_instance', 'itemid', <a class="var it1184" onMouseOver="hilite(1184)" onMouseOut="lolite()" onClick="logVariable('instanceid')" href="../../_variables/instanceid.html">$instanceid</a>, array('contextid' =&gt; <a class="var it782" onMouseOver="hilite(782)" onMouseOut="lolite()" onClick="logVariable('contextid')" href="../../_variables/contextid.html">$contextid</a>, 'itemid' =&gt; <a class="var it15456" onMouseOver="hilite(15456)" onMouseOut="lolite()" onClick="logVariable('olditemid')" href="../../_variables/olditemid.html">$olditemid</a>));
<a name="l4154"><span class="linenum">4154</span></a>      }
<a name="l4155"><span class="linenum">4155</span></a>  }
<a name="l4156"><span class="linenum">4156</span></a>  
<a name="l4157"><span class="linenum">4157</span></a>  <span class="comment">/**</span>
<a name="l4158"><span class="linenum">4158</span></a>  <span class="comment"> * Structure step that will process the user activity completion</span>
<a name="l4159"><span class="linenum">4159</span></a>  <span class="comment"> * information if all these conditions are met:</span>
<a name="l4160"><span class="linenum">4160</span></a>  <span class="comment"> *  - Target site has completion enabled ($CFG-&gt;enablecompletion)</span>
<a name="l4161"><span class="linenum">4161</span></a>  <span class="comment"> *  - Activity includes completion info (file_exists)</span>
<a name="l4162"><span class="linenum">4162</span></a>  <span class="comment"> */</span>
<a name="l4163"><span class="linenum">4163</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_userscompletion_structure_step')" href="../../_classes/restore_userscompletion_structure_step.html" onMouseOver="classPopup(event,'restore_userscompletion_structure_step')">restore_userscompletion_structure_step</a> extends restore_structure_step {
<a name="l4164"><span class="linenum">4164</span></a>      <span class="comment">/**</span>
<a name="l4165"><span class="linenum">4165</span></a>  <span class="comment">     * To conditionally decide if this step must be executed</span>
<a name="l4166"><span class="linenum">4166</span></a>  <span class="comment">     * Note the &quot;settings&quot; conditions are evaluated in the</span>
<a name="l4167"><span class="linenum">4167</span></a>  <span class="comment">     * corresponding task. Here we check for other conditions</span>
<a name="l4168"><span class="linenum">4168</span></a>  <span class="comment">     * not being restore settings (files, site settings...)</span>
<a name="l4169"><span class="linenum">4169</span></a>  <span class="comment">     */</span>
<a name="l4170"><span class="linenum">4170</span></a>       protected function <a class="function" onClick="logFunction('execute_condition')" href="../../_functions/execute_condition.html" onMouseOver="funcPopup(event,'execute_condition')">execute_condition</a>() {
<a name="l4171"><span class="linenum">4171</span></a>           global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>;
<a name="l4172"><span class="linenum">4172</span></a>  
<a name="l4173"><span class="linenum">4173</span></a>  <span class="comment">         // Completion disabled in this site, don't execute</span>
<a name="l4174"><span class="linenum">4174</span></a>           if (empty(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('enablecompletion')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/enablecompletion.html">enablecompletion</a>)) {
<a name="l4175"><span class="linenum">4175</span></a>               return false;
<a name="l4176"><span class="linenum">4176</span></a>           }
<a name="l4177"><span class="linenum">4177</span></a>  
<a name="l4178"><span class="linenum">4178</span></a>  <span class="comment">        // No completion on the front page.</span>
<a name="l4179"><span class="linenum">4179</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_courseid')" href="../../_functions/get_courseid.html" onMouseOver="funcPopup(event,'get_courseid')">get_courseid</a>() == <a class="constant" onClick="logConstant('SITEID')" href="../../_constants/SITEID.html" onMouseOver="constPopup(event,'SITEID')">SITEID</a>) {
<a name="l4180"><span class="linenum">4180</span></a>              return false;
<a name="l4181"><span class="linenum">4181</span></a>          }
<a name="l4182"><span class="linenum">4182</span></a>  
<a name="l4183"><span class="linenum">4183</span></a>  <span class="comment">         // No user completion info found, don't execute</span>
<a name="l4184"><span class="linenum">4184</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_taskbasepath')" href="../../_functions/get_taskbasepath.html" onMouseOver="funcPopup(event,'get_taskbasepath')">get_taskbasepath</a>();
<a name="l4185"><span class="linenum">4185</span></a>          <a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a> = <a class="phpfunction" onClick="logFunction('rtrim')" href="../../_functions/rtrim.html" onMouseOver="phpfuncPopup(event,'rtrim')">rtrim</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>, '/') . '/' . <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('filename')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/filename.html">filename</a>;
<a name="l4186"><span class="linenum">4186</span></a>           if (!<a class="phpfunction" onClick="logFunction('file_exists')" href="../../_functions/file_exists.html" onMouseOver="phpfuncPopup(event,'file_exists')">file_exists</a>(<a class="var it241" onMouseOver="hilite(241)" onMouseOut="lolite()" onClick="logVariable('fullpath')" href="../../_variables/fullpath.html">$fullpath</a>)) {
<a name="l4187"><span class="linenum">4187</span></a>               return false;
<a name="l4188"><span class="linenum">4188</span></a>           }
<a name="l4189"><span class="linenum">4189</span></a>  
<a name="l4190"><span class="linenum">4190</span></a>  <span class="comment">         // Arrived here, execute the step</span>
<a name="l4191"><span class="linenum">4191</span></a>           return true;
<a name="l4192"><span class="linenum">4192</span></a>       }
<a name="l4193"><span class="linenum">4193</span></a>  
<a name="l4194"><span class="linenum">4194</span></a>       protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l4195"><span class="linenum">4195</span></a>  
<a name="l4196"><span class="linenum">4196</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a> = array();
<a name="l4197"><span class="linenum">4197</span></a>  
<a name="l4198"><span class="linenum">4198</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('completion', '/completions/completion');
<a name="l4199"><span class="linenum">4199</span></a>  
<a name="l4200"><span class="linenum">4200</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l4201"><span class="linenum">4201</span></a>      }
<a name="l4202"><span class="linenum">4202</span></a>  
<a name="l4203"><span class="linenum">4203</span></a>      protected function <a class="function" onClick="logFunction('process_completion')" href="../../_functions/process_completion.html" onMouseOver="funcPopup(event,'process_completion')">process_completion</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l4204"><span class="linenum">4204</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l4205"><span class="linenum">4205</span></a>  
<a name="l4206"><span class="linenum">4206</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l4207"><span class="linenum">4207</span></a>  
<a name="l4208"><span class="linenum">4208</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('coursemoduleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/coursemoduleid.html">coursemoduleid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_moduleid')" href="../../_functions/get_moduleid.html" onMouseOver="funcPopup(event,'get_moduleid')">get_moduleid</a>();
<a name="l4209"><span class="linenum">4209</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>);
<a name="l4210"><span class="linenum">4210</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timemodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timemodified.html">timemodified</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timemodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timemodified.html">timemodified</a>);
<a name="l4211"><span class="linenum">4211</span></a>  
<a name="l4212"><span class="linenum">4212</span></a>  <span class="comment">        // Find the existing record</span>
<a name="l4213"><span class="linenum">4213</span></a>          <a class="var it10898" onMouseOver="hilite(10898)" onMouseOut="lolite()" onClick="logVariable('existing')" href="../../_variables/existing.html">$existing</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('course_modules_completion', array(
<a name="l4214"><span class="linenum">4214</span></a>                  'coursemoduleid' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('coursemoduleid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/coursemoduleid.html">coursemoduleid</a>,
<a name="l4215"><span class="linenum">4215</span></a>                  'userid' =&gt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>), 'id, timemodified');
<a name="l4216"><span class="linenum">4216</span></a>  <span class="comment">        // Check we didn't already insert one for this cmid and userid</span>
<a name="l4217"><span class="linenum">4217</span></a>  <span class="comment">        // (there aren't supposed to be duplicates in that field, but</span>
<a name="l4218"><span class="linenum">4218</span></a>  <span class="comment">        // it was possible until MDL-28021 was fixed).</span>
<a name="l4219"><span class="linenum">4219</span></a>          if (<a class="var it10898" onMouseOver="hilite(10898)" onMouseOut="lolite()" onClick="logVariable('existing')" href="../../_variables/existing.html">$existing</a>) {
<a name="l4220"><span class="linenum">4220</span></a>  <span class="comment">            // Update it to these new values, but only if the time is newer</span>
<a name="l4221"><span class="linenum">4221</span></a>              if (<a class="var it10898" onMouseOver="hilite(10898)" onMouseOut="lolite()" onClick="logVariable('existing')" href="../../_variables/existing.html">$existing</a>-&gt;<a onClick="logVariable('timemodified')" class="var it43440" onMouseOver="hilite(43440)" onMouseOut="lolite()" href="../../_variables/timemodified.html">timemodified</a> &lt; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timemodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timemodified.html">timemodified</a>) {
<a name="l4222"><span class="linenum">4222</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a> = <a class="var it10898" onMouseOver="hilite(10898)" onMouseOut="lolite()" onClick="logVariable('existing')" href="../../_variables/existing.html">$existing</a>-&gt;<a onClick="logVariable('id')" class="var it43440" onMouseOver="hilite(43440)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l4223"><span class="linenum">4223</span></a>                  <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('update_record')" href="../../_functions/update_record.html" onMouseOver="funcPopup(event,'update_record')">update_record</a>('course_modules_completion', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l4224"><span class="linenum">4224</span></a>              }
<a name="l4225"><span class="linenum">4225</span></a>          } else {
<a name="l4226"><span class="linenum">4226</span></a>  <span class="comment">            // Normal entry where it doesn't exist already</span>
<a name="l4227"><span class="linenum">4227</span></a>              <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('course_modules_completion', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l4228"><span class="linenum">4228</span></a>          }
<a name="l4229"><span class="linenum">4229</span></a>      }
<a name="l4230"><span class="linenum">4230</span></a>  }
<a name="l4231"><span class="linenum">4231</span></a>  
<a name="l4232"><span class="linenum">4232</span></a>  <span class="comment">/**</span>
<a name="l4233"><span class="linenum">4233</span></a>  <span class="comment"> * Abstract structure step, parent of all the activity structure steps. Used to support</span>
<a name="l4234"><span class="linenum">4234</span></a>  <span class="comment"> * the main &lt;activity ...&gt; tag and process it.</span>
<a name="l4235"><span class="linenum">4235</span></a>  <span class="comment"> */</span>
<a name="l4236"><span class="linenum">4236</span></a>  abstract class restore_activity_structure_step extends restore_structure_step {
<a name="l4237"><span class="linenum">4237</span></a>  
<a name="l4238"><span class="linenum">4238</span></a>      <span class="comment">/**</span>
<a name="l4239"><span class="linenum">4239</span></a>  <span class="comment">     * Adds support for the 'activity' path that is common to all the activities</span>
<a name="l4240"><span class="linenum">4240</span></a>  <span class="comment">     * and will be processed globally here</span>
<a name="l4241"><span class="linenum">4241</span></a>  <span class="comment">     */</span>
<a name="l4242"><span class="linenum">4242</span></a>      protected function <a class="function" onClick="logFunction('prepare_activity_structure')" href="../../_functions/prepare_activity_structure.html" onMouseOver="funcPopup(event,'prepare_activity_structure')">prepare_activity_structure</a>(<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>) {
<a name="l4243"><span class="linenum">4243</span></a>  
<a name="l4244"><span class="linenum">4244</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('activity', '/activity');
<a name="l4245"><span class="linenum">4245</span></a>  
<a name="l4246"><span class="linenum">4246</span></a>          return <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>;
<a name="l4247"><span class="linenum">4247</span></a>      }
<a name="l4248"><span class="linenum">4248</span></a>  
<a name="l4249"><span class="linenum">4249</span></a>      <span class="comment">/**</span>
<a name="l4250"><span class="linenum">4250</span></a>  <span class="comment">     * Process the activity path, informing the task about various ids, needed later</span>
<a name="l4251"><span class="linenum">4251</span></a>  <span class="comment">     */</span>
<a name="l4252"><span class="linenum">4252</span></a>      protected function <a class="function" onClick="logFunction('process_activity')" href="../../_functions/process_activity.html" onMouseOver="funcPopup(event,'process_activity')">process_activity</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l4253"><span class="linenum">4253</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l4254"><span class="linenum">4254</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('set_old_contextid')" href="../../_functions/set_old_contextid.html" onMouseOver="funcPopup(event,'set_old_contextid')">set_old_contextid</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('contextid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a>); <span class="comment">// Save old contextid in task</span>
<a name="l4255"><span class="linenum">4255</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('context', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('contextid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_contextid')" href="../../_functions/get_contextid.html" onMouseOver="funcPopup(event,'get_contextid')">get_contextid</a>()); <span class="comment">// Set the mapping</span>
<a name="l4256"><span class="linenum">4256</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('set_old_activityid')" href="../../_functions/set_old_activityid.html" onMouseOver="funcPopup(event,'set_old_activityid')">set_old_activityid</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>); <span class="comment">// Save old activityid in task</span>
<a name="l4257"><span class="linenum">4257</span></a>      }
<a name="l4258"><span class="linenum">4258</span></a>  
<a name="l4259"><span class="linenum">4259</span></a>      <span class="comment">/**</span>
<a name="l4260"><span class="linenum">4260</span></a>  <span class="comment">     * This must be invoked immediately after creating the &quot;module&quot; activity record (forum, choice...)</span>
<a name="l4261"><span class="linenum">4261</span></a>  <span class="comment">     * and will adjust the new activity id (the instance) in various places</span>
<a name="l4262"><span class="linenum">4262</span></a>  <span class="comment">     */</span>
<a name="l4263"><span class="linenum">4263</span></a>      protected function <a class="function" onClick="logFunction('apply_activity_instance')" href="../../_functions/apply_activity_instance.html" onMouseOver="funcPopup(event,'apply_activity_instance')">apply_activity_instance</a>(<a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>) {
<a name="l4264"><span class="linenum">4264</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l4265"><span class="linenum">4265</span></a>  
<a name="l4266"><span class="linenum">4266</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('set_activityid')" href="../../_functions/set_activityid.html" onMouseOver="funcPopup(event,'set_activityid')">set_activityid</a>(<a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>); <span class="comment">// Save activity id in task</span>
<a name="l4267"><span class="linenum">4267</span></a>  <span class="comment">        // Apply the id to course_sections-&gt;instanceid</span>
<a name="l4268"><span class="linenum">4268</span></a>          <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('set_field')" href="../../_functions/set_field.html" onMouseOver="funcPopup(event,'set_field')">set_field</a>('course_modules', 'instance', <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>, array('id' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_moduleid')" href="../../_functions/get_moduleid.html" onMouseOver="funcPopup(event,'get_moduleid')">get_moduleid</a>()));
<a name="l4269"><span class="linenum">4269</span></a>  <span class="comment">        // Do the mapping for modulename, preparing it for files by oldcontext</span>
<a name="l4270"><span class="linenum">4270</span></a>          <a class="var it2353" onMouseOver="hilite(2353)" onMouseOut="lolite()" onClick="logVariable('modulename')" href="../../_variables/modulename.html">$modulename</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_modulename')" href="../../_functions/get_modulename.html" onMouseOver="funcPopup(event,'get_modulename')">get_modulename</a>();
<a name="l4271"><span class="linenum">4271</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_old_activityid')" href="../../_functions/get_old_activityid.html" onMouseOver="funcPopup(event,'get_old_activityid')">get_old_activityid</a>();
<a name="l4272"><span class="linenum">4272</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>(<a class="var it2353" onMouseOver="hilite(2353)" onMouseOut="lolite()" onClick="logVariable('modulename')" href="../../_variables/modulename.html">$modulename</a>, <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>, true);
<a name="l4273"><span class="linenum">4273</span></a>      }
<a name="l4274"><span class="linenum">4274</span></a>  }
<a name="l4275"><span class="linenum">4275</span></a>  
<a name="l4276"><span class="linenum">4276</span></a>  <span class="comment">/**</span>
<a name="l4277"><span class="linenum">4277</span></a>  <span class="comment"> * Structure step in charge of creating/mapping all the qcats and qs</span>
<a name="l4278"><span class="linenum">4278</span></a>  <span class="comment"> * by parsing the questions.xml file and checking it against the</span>
<a name="l4279"><span class="linenum">4279</span></a>  <span class="comment"> * results calculated by {@link restore_process_categories_and_questions}</span>
<a name="l4280"><span class="linenum">4280</span></a>  <span class="comment"> * and stored in backup_ids_temp</span>
<a name="l4281"><span class="linenum">4281</span></a>  <span class="comment"> */</span>
<a name="l4282"><span class="linenum">4282</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_create_categories_and_questions')" href="../../_classes/restore_create_categories_and_questions.html" onMouseOver="classPopup(event,'restore_create_categories_and_questions')">restore_create_categories_and_questions</a> extends restore_structure_step {
<a name="l4283"><span class="linenum">4283</span></a>  
<a name="l4284"><span class="linenum">4284</span></a>  <span class="comment">    /** @var array $cachecategory store a question category */</span>
<a name="l4285"><span class="linenum">4285</span></a>      protected <a class="var it15457" onMouseOver="hilite(15457)" onMouseOut="lolite()" onClick="logVariable('cachedcategory')" href="../../_variables/cachedcategory.html">$cachedcategory</a> = null;
<a name="l4286"><span class="linenum">4286</span></a>  
<a name="l4287"><span class="linenum">4287</span></a>      protected function <a class="function" onClick="logFunction('define_structure')" href="../../_functions/define_structure.html" onMouseOver="funcPopup(event,'define_structure')">define_structure</a>() {
<a name="l4288"><span class="linenum">4288</span></a>  
<a name="l4289"><span class="linenum">4289</span></a>          <a class="var it261" onMouseOver="hilite(261)" onMouseOut="lolite()" onClick="logVariable('category')" href="../../_variables/category.html">$category</a> = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('question_category', '/question_categories/question_category');
<a name="l4290"><span class="linenum">4290</span></a>          <a class="var it259" onMouseOver="hilite(259)" onMouseOut="lolite()" onClick="logVariable('question')" href="../../_variables/question.html">$question</a> = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('question', '/question_categories/question_category/questions/question');
<a name="l4291"><span class="linenum">4291</span></a>          <a class="var it467" onMouseOver="hilite(467)" onMouseOut="lolite()" onClick="logVariable('hint')" href="../../_variables/hint.html">$hint</a> = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('question_hint',
<a name="l4292"><span class="linenum">4292</span></a>                  '/question_categories/question_category/questions/question/question_hints/question_hint');
<a name="l4293"><span class="linenum">4293</span></a>  
<a name="l4294"><span class="linenum">4294</span></a>          <a class="var it20" onMouseOver="hilite(20)" onMouseOut="lolite()" onClick="logVariable('tag')" href="../../_variables/tag.html">$tag</a> = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('tag','/question_categories/question_category/questions/question/tags/tag');
<a name="l4295"><span class="linenum">4295</span></a>  
<a name="l4296"><span class="linenum">4296</span></a>  <span class="comment">        // Apply for 'qtype' plugins optional paths at question level</span>
<a name="l4297"><span class="linenum">4297</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('qtype', <a class="var it259" onMouseOver="hilite(259)" onMouseOut="lolite()" onClick="logVariable('question')" href="../../_variables/question.html">$question</a>);
<a name="l4298"><span class="linenum">4298</span></a>  
<a name="l4299"><span class="linenum">4299</span></a>  <span class="comment">        // Apply for 'local' plugins optional paths at question level</span>
<a name="l4300"><span class="linenum">4300</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_plugin_structure')" href="../../_functions/add_plugin_structure.html" onMouseOver="funcPopup(event,'add_plugin_structure')">add_plugin_structure</a>('local', <a class="var it259" onMouseOver="hilite(259)" onMouseOut="lolite()" onClick="logVariable('question')" href="../../_variables/question.html">$question</a>);
<a name="l4301"><span class="linenum">4301</span></a>  
<a name="l4302"><span class="linenum">4302</span></a>          return array(<a class="var it261" onMouseOver="hilite(261)" onMouseOut="lolite()" onClick="logVariable('category')" href="../../_variables/category.html">$category</a>, <a class="var it259" onMouseOver="hilite(259)" onMouseOut="lolite()" onClick="logVariable('question')" href="../../_variables/question.html">$question</a>, <a class="var it467" onMouseOver="hilite(467)" onMouseOut="lolite()" onClick="logVariable('hint')" href="../../_variables/hint.html">$hint</a>, <a class="var it20" onMouseOver="hilite(20)" onMouseOut="lolite()" onClick="logVariable('tag')" href="../../_variables/tag.html">$tag</a>);
<a name="l4303"><span class="linenum">4303</span></a>      }
<a name="l4304"><span class="linenum">4304</span></a>  
<a name="l4305"><span class="linenum">4305</span></a>      protected function <a class="function" onClick="logFunction('process_question_category')" href="../../_functions/process_question_category.html" onMouseOver="funcPopup(event,'process_question_category')">process_question_category</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l4306"><span class="linenum">4306</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l4307"><span class="linenum">4307</span></a>  
<a name="l4308"><span class="linenum">4308</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l4309"><span class="linenum">4309</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l4310"><span class="linenum">4310</span></a>  
<a name="l4311"><span class="linenum">4311</span></a>  <span class="comment">        // Check we have one mapping for this category</span>
<a name="l4312"><span class="linenum">4312</span></a>          if (!<a class="var it679" onMouseOver="hilite(679)" onMouseOut="lolite()" onClick="logVariable('mapping')" href="../../_variables/mapping.html">$mapping</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mapping')" href="../../_functions/get_mapping.html" onMouseOver="funcPopup(event,'get_mapping')">get_mapping</a>('question_category', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>)) {
<a name="l4313"><span class="linenum">4313</span></a>              return self::SKIP_ALL_CHILDREN; <span class="comment">// No mapping = this category doesn't need to be created/mapped</span>
<a name="l4314"><span class="linenum">4314</span></a>          }
<a name="l4315"><span class="linenum">4315</span></a>  
<a name="l4316"><span class="linenum">4316</span></a>  <span class="comment">        // Check we have to create the category (newitemid = 0)</span>
<a name="l4317"><span class="linenum">4317</span></a>          if (<a class="var it679" onMouseOver="hilite(679)" onMouseOut="lolite()" onClick="logVariable('mapping')" href="../../_variables/mapping.html">$mapping</a>-&gt;<a onClick="logVariable('newitemid')" class="var it43096" onMouseOver="hilite(43096)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>) {
<a name="l4318"><span class="linenum">4318</span></a>              return; <span class="comment">// newitemid != 0, this category is going to be mapped. Nothing to do</span>
<a name="l4319"><span class="linenum">4319</span></a>          }
<a name="l4320"><span class="linenum">4320</span></a>  
<a name="l4321"><span class="linenum">4321</span></a>  <span class="comment">        // Arrived here, newitemid = 0, we need to create the category</span>
<a name="l4322"><span class="linenum">4322</span></a>  <span class="comment">        // we'll do it at parentitemid context, but for CONTEXT_MODULE</span>
<a name="l4323"><span class="linenum">4323</span></a>  <span class="comment">        // categories, that will be created at CONTEXT_COURSE and moved</span>
<a name="l4324"><span class="linenum">4324</span></a>  <span class="comment">        // to module context later when the activity is created</span>
<a name="l4325"><span class="linenum">4325</span></a>          if (<a class="var it679" onMouseOver="hilite(679)" onMouseOut="lolite()" onClick="logVariable('mapping')" href="../../_variables/mapping.html">$mapping</a>-&gt;<a onClick="logVariable('info')" class="var it43096" onMouseOver="hilite(43096)" onMouseOut="lolite()" href="../../_variables/info.html">info</a>-&gt;contextlevel == <a class="constant" onClick="logConstant('CONTEXT_MODULE')" href="../../_constants/CONTEXT_MODULE.html" onMouseOver="constPopup(event,'CONTEXT_MODULE')">CONTEXT_MODULE</a>) {
<a name="l4326"><span class="linenum">4326</span></a>              <a class="var it679" onMouseOver="hilite(679)" onMouseOut="lolite()" onClick="logVariable('mapping')" href="../../_variables/mapping.html">$mapping</a>-&gt;<a onClick="logVariable('parentitemid')" class="var it43096" onMouseOver="hilite(43096)" onMouseOut="lolite()" href="../../_variables/parentitemid.html">parentitemid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('context', <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_old_contextid')" href="../../_functions/get_old_contextid.html" onMouseOver="funcPopup(event,'get_old_contextid')">get_old_contextid</a>());
<a name="l4327"><span class="linenum">4327</span></a>          }
<a name="l4328"><span class="linenum">4328</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('contextid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a> = <a class="var it679" onMouseOver="hilite(679)" onMouseOut="lolite()" onClick="logVariable('mapping')" href="../../_variables/mapping.html">$mapping</a>-&gt;<a onClick="logVariable('parentitemid')" class="var it43096" onMouseOver="hilite(43096)" onMouseOut="lolite()" href="../../_variables/parentitemid.html">parentitemid</a>;
<a name="l4329"><span class="linenum">4329</span></a>  
<a name="l4330"><span class="linenum">4330</span></a>  <span class="comment">        // Let's create the question_category and save mapping</span>
<a name="l4331"><span class="linenum">4331</span></a>          <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('question_categories', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l4332"><span class="linenum">4332</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('question_category', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>);
<a name="l4333"><span class="linenum">4333</span></a>  <span class="comment">        // Also annotate them as question_category_created, we need</span>
<a name="l4334"><span class="linenum">4334</span></a>  <span class="comment">        // that later when remapping parents</span>
<a name="l4335"><span class="linenum">4335</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('question_category_created', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>, false, null, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('contextid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a>);
<a name="l4336"><span class="linenum">4336</span></a>      }
<a name="l4337"><span class="linenum">4337</span></a>  
<a name="l4338"><span class="linenum">4338</span></a>      protected function <a class="function" onClick="logFunction('process_question')" href="../../_functions/process_question.html" onMouseOver="funcPopup(event,'process_question')">process_question</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l4339"><span class="linenum">4339</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l4340"><span class="linenum">4340</span></a>  
<a name="l4341"><span class="linenum">4341</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l4342"><span class="linenum">4342</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l4343"><span class="linenum">4343</span></a>  
<a name="l4344"><span class="linenum">4344</span></a>  <span class="comment">        // Check we have one mapping for this question</span>
<a name="l4345"><span class="linenum">4345</span></a>          if (!<a class="var it15458" onMouseOver="hilite(15458)" onMouseOut="lolite()" onClick="logVariable('questionmapping')" href="../../_variables/questionmapping.html">$questionmapping</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mapping')" href="../../_functions/get_mapping.html" onMouseOver="funcPopup(event,'get_mapping')">get_mapping</a>('question', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>)) {
<a name="l4346"><span class="linenum">4346</span></a>              return; <span class="comment">// No mapping = this question doesn't need to be created/mapped</span>
<a name="l4347"><span class="linenum">4347</span></a>          }
<a name="l4348"><span class="linenum">4348</span></a>  
<a name="l4349"><span class="linenum">4349</span></a>  <span class="comment">        // Get the mapped category (cannot use get_new_parentid() because not</span>
<a name="l4350"><span class="linenum">4350</span></a>  <span class="comment">        // all the categories have been created, so it is not always available</span>
<a name="l4351"><span class="linenum">4351</span></a>  <span class="comment">        // Instead we get the mapping for the question-&gt;parentitemid because</span>
<a name="l4352"><span class="linenum">4352</span></a>  <span class="comment">        // we have loaded qcatids there for all parsed questions</span>
<a name="l4353"><span class="linenum">4353</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('category')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/category.html">category</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('question_category', <a class="var it15458" onMouseOver="hilite(15458)" onMouseOut="lolite()" onClick="logVariable('questionmapping')" href="../../_variables/questionmapping.html">$questionmapping</a>-&gt;<a onClick="logVariable('parentitemid')" class="var it45300" onMouseOver="hilite(45300)" onMouseOut="lolite()" href="../../_variables/parentitemid.html">parentitemid</a>);
<a name="l4354"><span class="linenum">4354</span></a>  
<a name="l4355"><span class="linenum">4355</span></a>  <span class="comment">        // In the past, there were some very sloppy values of penalty. Fix them.</span>
<a name="l4356"><span class="linenum">4356</span></a>          if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('penalty')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/penalty.html">penalty</a> &gt;= 0.33 &amp;&amp; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('penalty')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/penalty.html">penalty</a> &lt;= 0.34) {
<a name="l4357"><span class="linenum">4357</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('penalty')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/penalty.html">penalty</a> = 0.3333333;
<a name="l4358"><span class="linenum">4358</span></a>          }
<a name="l4359"><span class="linenum">4359</span></a>          if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('penalty')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/penalty.html">penalty</a> &gt;= 0.66 &amp;&amp; <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('penalty')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/penalty.html">penalty</a> &lt;= 0.67) {
<a name="l4360"><span class="linenum">4360</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('penalty')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/penalty.html">penalty</a> = 0.6666667;
<a name="l4361"><span class="linenum">4361</span></a>          }
<a name="l4362"><span class="linenum">4362</span></a>          if (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('penalty')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/penalty.html">penalty</a> &gt;= 1) {
<a name="l4363"><span class="linenum">4363</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('penalty')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/penalty.html">penalty</a> = 1;
<a name="l4364"><span class="linenum">4364</span></a>          }
<a name="l4365"><span class="linenum">4365</span></a>  
<a name="l4366"><span class="linenum">4366</span></a>          <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('createdby')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/createdby.html">createdby</a>);
<a name="l4367"><span class="linenum">4367</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('createdby')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/createdby.html">createdby</a> = <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> ? <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> : <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>();
<a name="l4368"><span class="linenum">4368</span></a>  
<a name="l4369"><span class="linenum">4369</span></a>          <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('modifiedby')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/modifiedby.html">modifiedby</a>);
<a name="l4370"><span class="linenum">4370</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('modifiedby')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/modifiedby.html">modifiedby</a> = <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> ? <a class="var it13" onMouseOver="hilite(13)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../../_variables/userid.html">$userid</a> : <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>();
<a name="l4371"><span class="linenum">4371</span></a>  
<a name="l4372"><span class="linenum">4372</span></a>  <span class="comment">        // With newitemid = 0, let's create the question</span>
<a name="l4373"><span class="linenum">4373</span></a>          if (!<a class="var it15458" onMouseOver="hilite(15458)" onMouseOut="lolite()" onClick="logVariable('questionmapping')" href="../../_variables/questionmapping.html">$questionmapping</a>-&gt;<a onClick="logVariable('newitemid')" class="var it45300" onMouseOver="hilite(45300)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>) {
<a name="l4374"><span class="linenum">4374</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('question', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l4375"><span class="linenum">4375</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('question', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>);
<a name="l4376"><span class="linenum">4376</span></a>  <span class="comment">            // Also annotate them as question_created, we need</span>
<a name="l4377"><span class="linenum">4377</span></a>  <span class="comment">            // that later when remapping parents (keeping the old categoryid as parentid)</span>
<a name="l4378"><span class="linenum">4378</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('question_created', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>, false, null, <a class="var it15458" onMouseOver="hilite(15458)" onMouseOut="lolite()" onClick="logVariable('questionmapping')" href="../../_variables/questionmapping.html">$questionmapping</a>-&gt;<a onClick="logVariable('parentitemid')" class="var it45300" onMouseOver="hilite(45300)" onMouseOut="lolite()" href="../../_variables/parentitemid.html">parentitemid</a>);
<a name="l4379"><span class="linenum">4379</span></a>          } else {
<a name="l4380"><span class="linenum">4380</span></a>  <span class="comment">            // By performing this set_mapping() we make get_old/new_parentid() to work for all the</span>
<a name="l4381"><span class="linenum">4381</span></a>  <span class="comment">            // children elements of the 'question' one (so qtype plugins will know the question they belong to)</span>
<a name="l4382"><span class="linenum">4382</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('question', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it15458" onMouseOver="hilite(15458)" onMouseOut="lolite()" onClick="logVariable('questionmapping')" href="../../_variables/questionmapping.html">$questionmapping</a>-&gt;<a onClick="logVariable('newitemid')" class="var it45300" onMouseOver="hilite(45300)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>);
<a name="l4383"><span class="linenum">4383</span></a>          }
<a name="l4384"><span class="linenum">4384</span></a>  
<a name="l4385"><span class="linenum">4385</span></a>  <span class="comment">        // Note, we don't restore any question files yet</span>
<a name="l4386"><span class="linenum">4386</span></a>  <span class="comment">        // as far as the CONTEXT_MODULE categories still</span>
<a name="l4387"><span class="linenum">4387</span></a>  <span class="comment">        // haven't their contexts to be restored to</span>
<a name="l4388"><span class="linenum">4388</span></a>  <span class="comment">        // The {@link restore_create_question_files}, executed in the final step</span>
<a name="l4389"><span class="linenum">4389</span></a>  <span class="comment">        // step will be in charge of restoring all the question files</span>
<a name="l4390"><span class="linenum">4390</span></a>      }
<a name="l4391"><span class="linenum">4391</span></a>  
<a name="l4392"><span class="linenum">4392</span></a>      protected function <a class="function" onClick="logFunction('process_question_hint')" href="../../_functions/process_question_hint.html" onMouseOver="funcPopup(event,'process_question_hint')">process_question_hint</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l4393"><span class="linenum">4393</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l4394"><span class="linenum">4394</span></a>  
<a name="l4395"><span class="linenum">4395</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l4396"><span class="linenum">4396</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l4397"><span class="linenum">4397</span></a>  
<a name="l4398"><span class="linenum">4398</span></a>  <span class="comment">        // Detect if the question is created or mapped</span>
<a name="l4399"><span class="linenum">4399</span></a>          <a class="var it8593" onMouseOver="hilite(8593)" onMouseOut="lolite()" onClick="logVariable('oldquestionid')" href="../../_variables/oldquestionid.html">$oldquestionid</a>   = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_old_parentid')" href="../../_functions/get_old_parentid.html" onMouseOver="funcPopup(event,'get_old_parentid')">get_old_parentid</a>('question');
<a name="l4400"><span class="linenum">4400</span></a>          <a class="var it8594" onMouseOver="hilite(8594)" onMouseOut="lolite()" onClick="logVariable('newquestionid')" href="../../_variables/newquestionid.html">$newquestionid</a>   = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_new_parentid')" href="../../_functions/get_new_parentid.html" onMouseOver="funcPopup(event,'get_new_parentid')">get_new_parentid</a>('question');
<a name="l4401"><span class="linenum">4401</span></a>          <a class="var it8595" onMouseOver="hilite(8595)" onMouseOut="lolite()" onClick="logVariable('questioncreated')" href="../../_variables/questioncreated.html">$questioncreated</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('question_created', <a class="var it8593" onMouseOver="hilite(8593)" onMouseOut="lolite()" onClick="logVariable('oldquestionid')" href="../../_variables/oldquestionid.html">$oldquestionid</a>) ? true : false;
<a name="l4402"><span class="linenum">4402</span></a>  
<a name="l4403"><span class="linenum">4403</span></a>  <span class="comment">        // If the question has been created by restore, we need to create its question_answers too</span>
<a name="l4404"><span class="linenum">4404</span></a>          if (<a class="var it8595" onMouseOver="hilite(8595)" onMouseOut="lolite()" onClick="logVariable('questioncreated')" href="../../_variables/questioncreated.html">$questioncreated</a>) {
<a name="l4405"><span class="linenum">4405</span></a>  <span class="comment">            // Adjust some columns</span>
<a name="l4406"><span class="linenum">4406</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('questionid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/questionid.html">questionid</a> = <a class="var it8594" onMouseOver="hilite(8594)" onMouseOut="lolite()" onClick="logVariable('newquestionid')" href="../../_variables/newquestionid.html">$newquestionid</a>;
<a name="l4407"><span class="linenum">4407</span></a>  <span class="comment">            // Insert record</span>
<a name="l4408"><span class="linenum">4408</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('question_hints', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l4409"><span class="linenum">4409</span></a>  
<a name="l4410"><span class="linenum">4410</span></a>  <span class="comment">        // The question existed, we need to map the existing question_hints</span>
<a name="l4411"><span class="linenum">4411</span></a>          } else {
<a name="l4412"><span class="linenum">4412</span></a>  <span class="comment">            // Look in question_hints by hint text matching</span>
<a name="l4413"><span class="linenum">4413</span></a>              <a class="var it64" onMouseOver="hilite(64)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a> = 'SELECT id
<a name="l4414"><span class="linenum">4414</span></a>                        FROM {question_hints}
<a name="l4415"><span class="linenum">4415</span></a>                       WHERE questionid = ?
<a name="l4416"><span class="linenum">4416</span></a>                         AND ' . <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_compare_text')" href="../../_functions/sql_compare_text.html" onMouseOver="funcPopup(event,'sql_compare_text')">sql_compare_text</a>('hint', 255) . ' = ' . <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_compare_text')" href="../../_functions/sql_compare_text.html" onMouseOver="funcPopup(event,'sql_compare_text')">sql_compare_text</a>('?', 255);
<a name="l4417"><span class="linenum">4417</span></a>              <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a> = array(<a class="var it8594" onMouseOver="hilite(8594)" onMouseOut="lolite()" onClick="logVariable('newquestionid')" href="../../_variables/newquestionid.html">$newquestionid</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('hint')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/hint.html">hint</a>);
<a name="l4418"><span class="linenum">4418</span></a>              <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field_sql')" href="../../_functions/get_field_sql.html" onMouseOver="funcPopup(event,'get_field_sql')">get_field_sql</a>(<a class="var it64" onMouseOver="hilite(64)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a>, <a class="var it189" onMouseOver="hilite(189)" onMouseOut="lolite()" onClick="logVariable('params')" href="../../_variables/params.html">$params</a>);
<a name="l4419"><span class="linenum">4419</span></a>  
<a name="l4420"><span class="linenum">4420</span></a>  <span class="comment">            // Not able to find the hint, let's try cleaning the hint text</span>
<a name="l4421"><span class="linenum">4421</span></a>  <span class="comment">            // of all the question's hints in DB as slower fallback. MDL-33863.</span>
<a name="l4422"><span class="linenum">4422</span></a>              if (!<a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>) {
<a name="l4423"><span class="linenum">4423</span></a>                  <a class="var it15459" onMouseOver="hilite(15459)" onMouseOut="lolite()" onClick="logVariable('potentialhints')" href="../../_variables/potentialhints.html">$potentialhints</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records')" href="../../_functions/get_records.html" onMouseOver="funcPopup(event,'get_records')">get_records</a>('question_hints',
<a name="l4424"><span class="linenum">4424</span></a>                          array('questionid' =&gt; <a class="var it8594" onMouseOver="hilite(8594)" onMouseOut="lolite()" onClick="logVariable('newquestionid')" href="../../_variables/newquestionid.html">$newquestionid</a>), '', 'id, hint');
<a name="l4425"><span class="linenum">4425</span></a>                  foreach (<a class="var it15459" onMouseOver="hilite(15459)" onMouseOut="lolite()" onClick="logVariable('potentialhints')" href="../../_variables/potentialhints.html">$potentialhints</a> as <a class="var it15460" onMouseOver="hilite(15460)" onMouseOut="lolite()" onClick="logVariable('potentialhint')" href="../../_variables/potentialhint.html">$potentialhint</a>) {
<a name="l4426"><span class="linenum">4426</span></a>  <span class="comment">                    // Clean in the same way than {@link xml_writer::xml_safe_utf8()}.</span>
<a name="l4427"><span class="linenum">4427</span></a>                      <a class="var it15461" onMouseOver="hilite(15461)" onMouseOut="lolite()" onClick="logVariable('cleanhint')" href="../../_variables/cleanhint.html">$cleanhint</a> = <a class="phpfunction" onClick="logFunction('preg_replace')" href="../../_functions/preg_replace.html" onMouseOver="phpfuncPopup(event,'preg_replace')">preg_replace</a>('/[\x-\x8\xb-\xc\xe-\x1f\x7f]/is','', <a class="var it15460" onMouseOver="hilite(15460)" onMouseOut="lolite()" onClick="logVariable('potentialhint')" href="../../_variables/potentialhint.html">$potentialhint</a>-&gt;<a onClick="logVariable('hint')" class="var it45301" onMouseOver="hilite(45301)" onMouseOut="lolite()" href="../../_variables/hint.html">hint</a>); <span class="comment">// Clean CTRL chars.</span>
<a name="l4428"><span class="linenum">4428</span></a>                      <a class="var it15461" onMouseOver="hilite(15461)" onMouseOut="lolite()" onClick="logVariable('cleanhint')" href="../../_variables/cleanhint.html">$cleanhint</a> = <a class="phpfunction" onClick="logFunction('preg_replace')" href="../../_functions/preg_replace.html" onMouseOver="phpfuncPopup(event,'preg_replace')">preg_replace</a>(&quot;/\r\n|\r/&quot;, &quot;\n&quot;, <a class="var it15461" onMouseOver="hilite(15461)" onMouseOut="lolite()" onClick="logVariable('cleanhint')" href="../../_variables/cleanhint.html">$cleanhint</a>); <span class="comment">// Normalize line ending.</span>
<a name="l4429"><span class="linenum">4429</span></a>                      if (<a class="var it15461" onMouseOver="hilite(15461)" onMouseOut="lolite()" onClick="logVariable('cleanhint')" href="../../_variables/cleanhint.html">$cleanhint</a> === <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('hint')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/hint.html">hint</a>) {
<a name="l4430"><span class="linenum">4430</span></a>                          <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l4431"><span class="linenum">4431</span></a>                      }
<a name="l4432"><span class="linenum">4432</span></a>                  }
<a name="l4433"><span class="linenum">4433</span></a>              }
<a name="l4434"><span class="linenum">4434</span></a>  
<a name="l4435"><span class="linenum">4435</span></a>  <span class="comment">            // If we haven't found the newitemid, something has gone really wrong, question in DB</span>
<a name="l4436"><span class="linenum">4436</span></a>  <span class="comment">            // is missing hints, exception</span>
<a name="l4437"><span class="linenum">4437</span></a>              if (!<a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>) {
<a name="l4438"><span class="linenum">4438</span></a>                  <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a> = new stdClass();
<a name="l4439"><span class="linenum">4439</span></a>                  <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('filequestionid')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/filequestionid.html">filequestionid</a> = <a class="var it8593" onMouseOver="hilite(8593)" onMouseOut="lolite()" onClick="logVariable('oldquestionid')" href="../../_variables/oldquestionid.html">$oldquestionid</a>;
<a name="l4440"><span class="linenum">4440</span></a>                  <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('dbquestionid')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/dbquestionid.html">dbquestionid</a>   = <a class="var it8594" onMouseOver="hilite(8594)" onMouseOut="lolite()" onClick="logVariable('newquestionid')" href="../../_variables/newquestionid.html">$newquestionid</a>;
<a name="l4441"><span class="linenum">4441</span></a>                  <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('hint')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/hint.html">hint</a>           = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('hint')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/hint.html">hint</a>;
<a name="l4442"><span class="linenum">4442</span></a>                  throw <span class="keyword">new </span><a class="class" onClick="logClass('restore_step_exception')" href="../../_classes/restore_step_exception.html" onMouseOver="classPopup(event,'restore_step_exception')">restore_step_exception</a>('error_question_hint_missing_in_db', <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>);
<a name="l4443"><span class="linenum">4443</span></a>              }
<a name="l4444"><span class="linenum">4444</span></a>          }
<a name="l4445"><span class="linenum">4445</span></a>  <span class="comment">        // Create mapping (I'm not sure if this is really needed?)</span>
<a name="l4446"><span class="linenum">4446</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('question_hint', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>);
<a name="l4447"><span class="linenum">4447</span></a>      }
<a name="l4448"><span class="linenum">4448</span></a>  
<a name="l4449"><span class="linenum">4449</span></a>      protected function <a class="function" onClick="logFunction('process_tag')" href="../../_functions/process_tag.html" onMouseOver="funcPopup(event,'process_tag')">process_tag</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l4450"><span class="linenum">4450</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>, <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l4451"><span class="linenum">4451</span></a>  
<a name="l4452"><span class="linenum">4452</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l4453"><span class="linenum">4453</span></a>          <a class="var it15462" onMouseOver="hilite(15462)" onMouseOut="lolite()" onClick="logVariable('newquestion')" href="../../_variables/newquestion.html">$newquestion</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_new_parentid')" href="../../_functions/get_new_parentid.html" onMouseOver="funcPopup(event,'get_new_parentid')">get_new_parentid</a>('question');
<a name="l4454"><span class="linenum">4454</span></a>          <a class="var it8595" onMouseOver="hilite(8595)" onMouseOut="lolite()" onClick="logVariable('questioncreated')" href="../../_variables/questioncreated.html">$questioncreated</a> = (bool) <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('question_created', <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_old_parentid')" href="../../_functions/get_old_parentid.html" onMouseOver="funcPopup(event,'get_old_parentid')">get_old_parentid</a>('question'));
<a name="l4455"><span class="linenum">4455</span></a>          if (!<a class="var it8595" onMouseOver="hilite(8595)" onMouseOut="lolite()" onClick="logVariable('questioncreated')" href="../../_variables/questioncreated.html">$questioncreated</a>) {
<a name="l4456"><span class="linenum">4456</span></a>  <span class="comment">            // This question already exists in the question bank. Nothing for us to do.</span>
<a name="l4457"><span class="linenum">4457</span></a>              return;
<a name="l4458"><span class="linenum">4458</span></a>          }
<a name="l4459"><span class="linenum">4459</span></a>  
<a name="l4460"><span class="linenum">4460</span></a>          if (<a class="class" onClick="logClass('core_tag_tag')" href="../../_classes/core_tag_tag.html" onMouseOver="classPopup(event,'core_tag_tag')">core_tag_tag</a>::<a class="function" onClick="logFunction('is_enabled')" href="../../_functions/is_enabled.html" onMouseOver="funcPopup(event,'is_enabled')">is_enabled</a>('core_question', 'question')) {
<a name="l4461"><span class="linenum">4461</span></a>              <a class="var it2390" onMouseOver="hilite(2390)" onMouseOut="lolite()" onClick="logVariable('tagname')" href="../../_variables/tagname.html">$tagname</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('rawname')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/rawname.html">rawname</a>;
<a name="l4462"><span class="linenum">4462</span></a>  <span class="comment">            // Get the category, so we can then later get the context.</span>
<a name="l4463"><span class="linenum">4463</span></a>              <a class="var it904" onMouseOver="hilite(904)" onMouseOut="lolite()" onClick="logVariable('categoryid')" href="../../_variables/categoryid.html">$categoryid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_new_parentid')" href="../../_functions/get_new_parentid.html" onMouseOver="funcPopup(event,'get_new_parentid')">get_new_parentid</a>('question_category');
<a name="l4464"><span class="linenum">4464</span></a>              if (empty(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('cachedcategory')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/cachedcategory.html">cachedcategory</a>) || <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('cachedcategory')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/cachedcategory.html">cachedcategory</a>-&gt;id != <a class="var it904" onMouseOver="hilite(904)" onMouseOut="lolite()" onClick="logVariable('categoryid')" href="../../_variables/categoryid.html">$categoryid</a>) {
<a name="l4465"><span class="linenum">4465</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('cachedcategory')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/cachedcategory.html">cachedcategory</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('question_categories', array('id' =&gt; <a class="var it904" onMouseOver="hilite(904)" onMouseOut="lolite()" onClick="logVariable('categoryid')" href="../../_variables/categoryid.html">$categoryid</a>));
<a name="l4466"><span class="linenum">4466</span></a>              }
<a name="l4467"><span class="linenum">4467</span></a>  <span class="comment">            // Add the tag to the question.</span>
<a name="l4468"><span class="linenum">4468</span></a>              <a class="class" onClick="logClass('core_tag_tag')" href="../../_classes/core_tag_tag.html" onMouseOver="classPopup(event,'core_tag_tag')">core_tag_tag</a>::<a class="function" onClick="logFunction('add_item_tag')" href="../../_functions/add_item_tag.html" onMouseOver="funcPopup(event,'add_item_tag')">add_item_tag</a>('core_question', 'question', <a class="var it15462" onMouseOver="hilite(15462)" onMouseOut="lolite()" onClick="logVariable('newquestion')" href="../../_variables/newquestion.html">$newquestion</a>,
<a name="l4469"><span class="linenum">4469</span></a>                      context::<a class="function" onClick="logFunction('instance_by_id')" href="../../_functions/instance_by_id.html" onMouseOver="funcPopup(event,'instance_by_id')">instance_by_id</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('cachedcategory')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/cachedcategory.html">cachedcategory</a>-&gt;contextid),
<a name="l4470"><span class="linenum">4470</span></a>                      <a class="var it2390" onMouseOver="hilite(2390)" onMouseOut="lolite()" onClick="logVariable('tagname')" href="../../_variables/tagname.html">$tagname</a>);
<a name="l4471"><span class="linenum">4471</span></a>          }
<a name="l4472"><span class="linenum">4472</span></a>      }
<a name="l4473"><span class="linenum">4473</span></a>  
<a name="l4474"><span class="linenum">4474</span></a>      protected function <a class="function" onClick="logFunction('after_execute')" href="../../_functions/after_execute.html" onMouseOver="funcPopup(event,'after_execute')">after_execute</a>() {
<a name="l4475"><span class="linenum">4475</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l4476"><span class="linenum">4476</span></a>  
<a name="l4477"><span class="linenum">4477</span></a>  <span class="comment">        // First of all, recode all the created question_categories-&gt;parent fields</span>
<a name="l4478"><span class="linenum">4478</span></a>          <a class="var it15463" onMouseOver="hilite(15463)" onMouseOut="lolite()" onClick="logVariable('qcats')" href="../../_variables/qcats.html">$qcats</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records')" href="../../_functions/get_records.html" onMouseOver="funcPopup(event,'get_records')">get_records</a>('backup_ids_temp', array(
<a name="l4479"><span class="linenum">4479</span></a>                       'backupid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(),
<a name="l4480"><span class="linenum">4480</span></a>                       'itemname' =&gt; 'question_category_created'));
<a name="l4481"><span class="linenum">4481</span></a>          foreach (<a class="var it15463" onMouseOver="hilite(15463)" onMouseOut="lolite()" onClick="logVariable('qcats')" href="../../_variables/qcats.html">$qcats</a> as <a class="var it7673" onMouseOver="hilite(7673)" onMouseOut="lolite()" onClick="logVariable('qcat')" href="../../_variables/qcat.html">$qcat</a>) {
<a name="l4482"><span class="linenum">4482</span></a>              <a class="var it315" onMouseOver="hilite(315)" onMouseOut="lolite()" onClick="logVariable('newparent')" href="../../_variables/newparent.html">$newparent</a> = 0;
<a name="l4483"><span class="linenum">4483</span></a>              <a class="var it15464" onMouseOver="hilite(15464)" onMouseOut="lolite()" onClick="logVariable('dbcat')" href="../../_variables/dbcat.html">$dbcat</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('question_categories', array('id' =&gt; <a class="var it7673" onMouseOver="hilite(7673)" onMouseOut="lolite()" onClick="logVariable('qcat')" href="../../_variables/qcat.html">$qcat</a>-&gt;<a onClick="logVariable('newitemid')" class="var it43911" onMouseOver="hilite(43911)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>));
<a name="l4484"><span class="linenum">4484</span></a>  <span class="comment">            // Get new parent (mapped or created, so we look in quesiton_category mappings)</span>
<a name="l4485"><span class="linenum">4485</span></a>              if (<a class="var it315" onMouseOver="hilite(315)" onMouseOut="lolite()" onClick="logVariable('newparent')" href="../../_variables/newparent.html">$newparent</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('backup_ids_temp', 'newitemid', array(
<a name="l4486"><span class="linenum">4486</span></a>                                   'backupid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(),
<a name="l4487"><span class="linenum">4487</span></a>                                   'itemname' =&gt; 'question_category',
<a name="l4488"><span class="linenum">4488</span></a>                                   'itemid'   =&gt; <a class="var it15464" onMouseOver="hilite(15464)" onMouseOut="lolite()" onClick="logVariable('dbcat')" href="../../_variables/dbcat.html">$dbcat</a>-&gt;<a onClick="logVariable('parent')" class="var it44535" onMouseOver="hilite(44535)" onMouseOut="lolite()" href="../../_variables/parent.html">parent</a>))) {
<a name="l4489"><span class="linenum">4489</span></a>  <span class="comment">                // contextids must match always, as far as we always include complete qbanks, just check it</span>
<a name="l4490"><span class="linenum">4490</span></a>                  <a class="var it15465" onMouseOver="hilite(15465)" onMouseOut="lolite()" onClick="logVariable('newparentctxid')" href="../../_variables/newparentctxid.html">$newparentctxid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('question_categories', 'contextid', array('id' =&gt; <a class="var it315" onMouseOver="hilite(315)" onMouseOut="lolite()" onClick="logVariable('newparent')" href="../../_variables/newparent.html">$newparent</a>));
<a name="l4491"><span class="linenum">4491</span></a>                  if (<a class="var it15464" onMouseOver="hilite(15464)" onMouseOut="lolite()" onClick="logVariable('dbcat')" href="../../_variables/dbcat.html">$dbcat</a>-&gt;<a onClick="logVariable('contextid')" class="var it44535" onMouseOver="hilite(44535)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a> == <a class="var it15465" onMouseOver="hilite(15465)" onMouseOut="lolite()" onClick="logVariable('newparentctxid')" href="../../_variables/newparentctxid.html">$newparentctxid</a>) {
<a name="l4492"><span class="linenum">4492</span></a>                      <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('set_field')" href="../../_functions/set_field.html" onMouseOver="funcPopup(event,'set_field')">set_field</a>('question_categories', 'parent', <a class="var it315" onMouseOver="hilite(315)" onMouseOut="lolite()" onClick="logVariable('newparent')" href="../../_variables/newparent.html">$newparent</a>, array('id' =&gt; <a class="var it15464" onMouseOver="hilite(15464)" onMouseOut="lolite()" onClick="logVariable('dbcat')" href="../../_variables/dbcat.html">$dbcat</a>-&gt;<a onClick="logVariable('id')" class="var it44535" onMouseOver="hilite(44535)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>));
<a name="l4493"><span class="linenum">4493</span></a>                  } else {
<a name="l4494"><span class="linenum">4494</span></a>                      <a class="var it315" onMouseOver="hilite(315)" onMouseOut="lolite()" onClick="logVariable('newparent')" href="../../_variables/newparent.html">$newparent</a> = 0; <span class="comment">// No ctx match for both cats, no parent relationship</span>
<a name="l4495"><span class="linenum">4495</span></a>                  }
<a name="l4496"><span class="linenum">4496</span></a>              }
<a name="l4497"><span class="linenum">4497</span></a>  <span class="comment">            // Here with $newparent empty, problem with contexts or remapping, set it to top cat</span>
<a name="l4498"><span class="linenum">4498</span></a>              if (!<a class="var it315" onMouseOver="hilite(315)" onMouseOut="lolite()" onClick="logVariable('newparent')" href="../../_variables/newparent.html">$newparent</a>) {
<a name="l4499"><span class="linenum">4499</span></a>                  <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('set_field')" href="../../_functions/set_field.html" onMouseOver="funcPopup(event,'set_field')">set_field</a>('question_categories', 'parent', 0, array('id' =&gt; <a class="var it15464" onMouseOver="hilite(15464)" onMouseOut="lolite()" onClick="logVariable('dbcat')" href="../../_variables/dbcat.html">$dbcat</a>-&gt;<a onClick="logVariable('id')" class="var it44535" onMouseOver="hilite(44535)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>));
<a name="l4500"><span class="linenum">4500</span></a>              }
<a name="l4501"><span class="linenum">4501</span></a>          }
<a name="l4502"><span class="linenum">4502</span></a>  
<a name="l4503"><span class="linenum">4503</span></a>  <span class="comment">        // Now, recode all the created question-&gt;parent fields</span>
<a name="l4504"><span class="linenum">4504</span></a>          <a class="var it8185" onMouseOver="hilite(8185)" onMouseOut="lolite()" onClick="logVariable('qs')" href="../../_variables/qs.html">$qs</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records')" href="../../_functions/get_records.html" onMouseOver="funcPopup(event,'get_records')">get_records</a>('backup_ids_temp', array(
<a name="l4505"><span class="linenum">4505</span></a>                    'backupid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(),
<a name="l4506"><span class="linenum">4506</span></a>                    'itemname' =&gt; 'question_created'));
<a name="l4507"><span class="linenum">4507</span></a>          foreach (<a class="var it8185" onMouseOver="hilite(8185)" onMouseOut="lolite()" onClick="logVariable('qs')" href="../../_variables/qs.html">$qs</a> as <a class="var it445" onMouseOver="hilite(445)" onMouseOut="lolite()" onClick="logVariable('q')" href="../../_variables/q.html">$q</a>) {
<a name="l4508"><span class="linenum">4508</span></a>              <a class="var it315" onMouseOver="hilite(315)" onMouseOut="lolite()" onClick="logVariable('newparent')" href="../../_variables/newparent.html">$newparent</a> = 0;
<a name="l4509"><span class="linenum">4509</span></a>              <a class="var it15466" onMouseOver="hilite(15466)" onMouseOut="lolite()" onClick="logVariable('dbq')" href="../../_variables/dbq.html">$dbq</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('question', array('id' =&gt; <a class="var it445" onMouseOver="hilite(445)" onMouseOut="lolite()" onClick="logVariable('q')" href="../../_variables/q.html">$q</a>-&gt;<a onClick="logVariable('newitemid')" class="var it43090" onMouseOver="hilite(43090)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>));
<a name="l4510"><span class="linenum">4510</span></a>  <span class="comment">            // Get new parent (mapped or created, so we look in question mappings)</span>
<a name="l4511"><span class="linenum">4511</span></a>              if (<a class="var it315" onMouseOver="hilite(315)" onMouseOut="lolite()" onClick="logVariable('newparent')" href="../../_variables/newparent.html">$newparent</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_field')" href="../../_functions/get_field.html" onMouseOver="funcPopup(event,'get_field')">get_field</a>('backup_ids_temp', 'newitemid', array(
<a name="l4512"><span class="linenum">4512</span></a>                                   'backupid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(),
<a name="l4513"><span class="linenum">4513</span></a>                                   'itemname' =&gt; 'question',
<a name="l4514"><span class="linenum">4514</span></a>                                   'itemid'   =&gt; <a class="var it15466" onMouseOver="hilite(15466)" onMouseOut="lolite()" onClick="logVariable('dbq')" href="../../_variables/dbq.html">$dbq</a>-&gt;<a onClick="logVariable('parent')" class="var it45302" onMouseOver="hilite(45302)" onMouseOut="lolite()" href="../../_variables/parent.html">parent</a>))) {
<a name="l4515"><span class="linenum">4515</span></a>                  <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('set_field')" href="../../_functions/set_field.html" onMouseOver="funcPopup(event,'set_field')">set_field</a>('question', 'parent', <a class="var it315" onMouseOver="hilite(315)" onMouseOut="lolite()" onClick="logVariable('newparent')" href="../../_variables/newparent.html">$newparent</a>, array('id' =&gt; <a class="var it15466" onMouseOver="hilite(15466)" onMouseOut="lolite()" onClick="logVariable('dbq')" href="../../_variables/dbq.html">$dbq</a>-&gt;<a onClick="logVariable('id')" class="var it45302" onMouseOver="hilite(45302)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>));
<a name="l4516"><span class="linenum">4516</span></a>              }
<a name="l4517"><span class="linenum">4517</span></a>          }
<a name="l4518"><span class="linenum">4518</span></a>  
<a name="l4519"><span class="linenum">4519</span></a>  <span class="comment">        // Note, we don't restore any question files yet</span>
<a name="l4520"><span class="linenum">4520</span></a>  <span class="comment">        // as far as the CONTEXT_MODULE categories still</span>
<a name="l4521"><span class="linenum">4521</span></a>  <span class="comment">        // haven't their contexts to be restored to</span>
<a name="l4522"><span class="linenum">4522</span></a>  <span class="comment">        // The {@link restore_create_question_files}, executed in the final step</span>
<a name="l4523"><span class="linenum">4523</span></a>  <span class="comment">        // step will be in charge of restoring all the question files</span>
<a name="l4524"><span class="linenum">4524</span></a>      }
<a name="l4525"><span class="linenum">4525</span></a>  }
<a name="l4526"><span class="linenum">4526</span></a>  
<a name="l4527"><span class="linenum">4527</span></a>  <span class="comment">/**</span>
<a name="l4528"><span class="linenum">4528</span></a>  <span class="comment"> * Execution step that will move all the CONTEXT_MODULE question categories</span>
<a name="l4529"><span class="linenum">4529</span></a>  <span class="comment"> * created at early stages of restore in course context (because modules weren't</span>
<a name="l4530"><span class="linenum">4530</span></a>  <span class="comment"> * created yet) to their target module (matching by old-new-contextid mapping)</span>
<a name="l4531"><span class="linenum">4531</span></a>  <span class="comment"> */</span>
<a name="l4532"><span class="linenum">4532</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_move_module_questions_categories')" href="../../_classes/restore_move_module_questions_categories.html" onMouseOver="classPopup(event,'restore_move_module_questions_categories')">restore_move_module_questions_categories</a> extends restore_execution_step {
<a name="l4533"><span class="linenum">4533</span></a>  
<a name="l4534"><span class="linenum">4534</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l4535"><span class="linenum">4535</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l4536"><span class="linenum">4536</span></a>  
<a name="l4537"><span class="linenum">4537</span></a>          <a class="var it2537" onMouseOver="hilite(2537)" onMouseOut="lolite()" onClick="logVariable('contexts')" href="../../_variables/contexts.html">$contexts</a> = restore_dbops::<a class="function" onClick="logFunction('restore_get_question_banks')" href="../../_functions/restore_get_question_banks.html" onMouseOver="funcPopup(event,'restore_get_question_banks')">restore_get_question_banks</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), <a class="constant" onClick="logConstant('CONTEXT_MODULE')" href="../../_constants/CONTEXT_MODULE.html" onMouseOver="constPopup(event,'CONTEXT_MODULE')">CONTEXT_MODULE</a>);
<a name="l4538"><span class="linenum">4538</span></a>          foreach (<a class="var it2537" onMouseOver="hilite(2537)" onMouseOut="lolite()" onClick="logVariable('contexts')" href="../../_variables/contexts.html">$contexts</a> as <a class="var it782" onMouseOver="hilite(782)" onMouseOut="lolite()" onClick="logVariable('contextid')" href="../../_variables/contextid.html">$contextid</a> =&gt; <a class="var it28" onMouseOver="hilite(28)" onMouseOut="lolite()" onClick="logVariable('contextlevel')" href="../../_variables/contextlevel.html">$contextlevel</a>) {
<a name="l4539"><span class="linenum">4539</span></a>  <span class="comment">            // Only if context mapping exists (i.e. the module has been restored)</span>
<a name="l4540"><span class="linenum">4540</span></a>              if (<a class="var it12558" onMouseOver="hilite(12558)" onMouseOut="lolite()" onClick="logVariable('newcontext')" href="../../_variables/newcontext.html">$newcontext</a> = restore_dbops::<a class="function" onClick="logFunction('get_backup_ids_record')" href="../../_functions/get_backup_ids_record.html" onMouseOver="funcPopup(event,'get_backup_ids_record')">get_backup_ids_record</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'context', <a class="var it782" onMouseOver="hilite(782)" onMouseOut="lolite()" onClick="logVariable('contextid')" href="../../_variables/contextid.html">$contextid</a>)) {
<a name="l4541"><span class="linenum">4541</span></a>  <span class="comment">                // Update all the qcats having their parentitemid set to the original contextid</span>
<a name="l4542"><span class="linenum">4542</span></a>                  <a class="var it15467" onMouseOver="hilite(15467)" onMouseOut="lolite()" onClick="logVariable('modulecats')" href="../../_variables/modulecats.html">$modulecats</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records_sql')" href="../../_functions/get_records_sql.html" onMouseOver="funcPopup(event,'get_records_sql')">get_records_sql</a>(&quot;SELECT itemid, newitemid
<a name="l4543"><span class="linenum">4543</span></a>                                                        FROM {backup_ids_temp}
<a name="l4544"><span class="linenum">4544</span></a>                                                       WHERE backupid = ?
<a name="l4545"><span class="linenum">4545</span></a>                                                         AND itemname = 'question_category'
<a name="l4546"><span class="linenum">4546</span></a>                                                         AND parentitemid = ?&quot;, array(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), <a class="var it782" onMouseOver="hilite(782)" onMouseOut="lolite()" onClick="logVariable('contextid')" href="../../_variables/contextid.html">$contextid</a>));
<a name="l4547"><span class="linenum">4547</span></a>                  foreach (<a class="var it15467" onMouseOver="hilite(15467)" onMouseOut="lolite()" onClick="logVariable('modulecats')" href="../../_variables/modulecats.html">$modulecats</a> as <a class="var it15468" onMouseOver="hilite(15468)" onMouseOut="lolite()" onClick="logVariable('modulecat')" href="../../_variables/modulecat.html">$modulecat</a>) {
<a name="l4548"><span class="linenum">4548</span></a>                      <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('set_field')" href="../../_functions/set_field.html" onMouseOver="funcPopup(event,'set_field')">set_field</a>('question_categories', 'contextid', <a class="var it12558" onMouseOver="hilite(12558)" onMouseOut="lolite()" onClick="logVariable('newcontext')" href="../../_variables/newcontext.html">$newcontext</a>-&gt;<a onClick="logVariable('newitemid')" class="var it44345" onMouseOver="hilite(44345)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>, array('id' =&gt; <a class="var it15468" onMouseOver="hilite(15468)" onMouseOut="lolite()" onClick="logVariable('modulecat')" href="../../_variables/modulecat.html">$modulecat</a>-&gt;<a onClick="logVariable('newitemid')" class="var it45303" onMouseOver="hilite(45303)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>));
<a name="l4549"><span class="linenum">4549</span></a>  <span class="comment">                    // And set new contextid also in question_category mapping (will be</span>
<a name="l4550"><span class="linenum">4550</span></a>  <span class="comment">                    // used by {@link restore_create_question_files} later</span>
<a name="l4551"><span class="linenum">4551</span></a>                      restore_dbops::<a class="function" onClick="logFunction('set_backup_ids_record')" href="../../_functions/set_backup_ids_record.html" onMouseOver="funcPopup(event,'set_backup_ids_record')">set_backup_ids_record</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'question_category', <a class="var it15468" onMouseOver="hilite(15468)" onMouseOut="lolite()" onClick="logVariable('modulecat')" href="../../_variables/modulecat.html">$modulecat</a>-&gt;<a onClick="logVariable('itemid')" class="var it45303" onMouseOver="hilite(45303)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>, <a class="var it15468" onMouseOver="hilite(15468)" onMouseOut="lolite()" onClick="logVariable('modulecat')" href="../../_variables/modulecat.html">$modulecat</a>-&gt;<a onClick="logVariable('newitemid')" class="var it45303" onMouseOver="hilite(45303)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>, <a class="var it12558" onMouseOver="hilite(12558)" onMouseOut="lolite()" onClick="logVariable('newcontext')" href="../../_variables/newcontext.html">$newcontext</a>-&gt;<a onClick="logVariable('newitemid')" class="var it44345" onMouseOver="hilite(44345)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>);
<a name="l4552"><span class="linenum">4552</span></a>                  }
<a name="l4553"><span class="linenum">4553</span></a>              }
<a name="l4554"><span class="linenum">4554</span></a>          }
<a name="l4555"><span class="linenum">4555</span></a>      }
<a name="l4556"><span class="linenum">4556</span></a>  }
<a name="l4557"><span class="linenum">4557</span></a>  
<a name="l4558"><span class="linenum">4558</span></a>  <span class="comment">/**</span>
<a name="l4559"><span class="linenum">4559</span></a>  <span class="comment"> * Execution step that will create all the question/answers/qtype-specific files for the restored</span>
<a name="l4560"><span class="linenum">4560</span></a>  <span class="comment"> * questions. It must be executed after {@link restore_move_module_questions_categories}</span>
<a name="l4561"><span class="linenum">4561</span></a>  <span class="comment"> * because only then each question is in its final category and only then the</span>
<a name="l4562"><span class="linenum">4562</span></a>  <span class="comment"> * contexts can be determined.</span>
<a name="l4563"><span class="linenum">4563</span></a>  <span class="comment"> */</span>
<a name="l4564"><span class="linenum">4564</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_create_question_files')" href="../../_classes/restore_create_question_files.html" onMouseOver="classPopup(event,'restore_create_question_files')">restore_create_question_files</a> extends restore_execution_step {
<a name="l4565"><span class="linenum">4565</span></a>  
<a name="l4566"><span class="linenum">4566</span></a>  <span class="comment">    /** @var array Question-type specific component items cache. */</span>
<a name="l4567"><span class="linenum">4567</span></a>      private <a class="var it15469" onMouseOver="hilite(15469)" onMouseOut="lolite()" onClick="logVariable('qtypecomponentscache')" href="../../_variables/qtypecomponentscache.html">$qtypecomponentscache</a> = array();
<a name="l4568"><span class="linenum">4568</span></a>  
<a name="l4569"><span class="linenum">4569</span></a>      <span class="comment">/**</span>
<a name="l4570"><span class="linenum">4570</span></a>  <span class="comment">     * Preform the restore_create_question_files step.</span>
<a name="l4571"><span class="linenum">4571</span></a>  <span class="comment">     */</span>
<a name="l4572"><span class="linenum">4572</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l4573"><span class="linenum">4573</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l4574"><span class="linenum">4574</span></a>  
<a name="l4575"><span class="linenum">4575</span></a>  <span class="comment">        // Track progress, as this task can take a long time.</span>
<a name="l4576"><span class="linenum">4576</span></a>          <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_progress')" href="../../_functions/get_progress.html" onMouseOver="funcPopup(event,'get_progress')">get_progress</a>();
<a name="l4577"><span class="linenum">4577</span></a>          <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>-&gt;<a class="function" onClick="logFunction('start_progress')" href="../../_functions/start_progress.html" onMouseOver="funcPopup(event,'start_progress')">start_progress</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_name')" href="../../_functions/get_name.html" onMouseOver="funcPopup(event,'get_name')">get_name</a>(), \core\progress\base::INDETERMINATE);
<a name="l4578"><span class="linenum">4578</span></a>  
<a name="l4579"><span class="linenum">4579</span></a>  <span class="comment">        // Parentitemids of question_createds in backup_ids_temp are the category it is in.</span>
<a name="l4580"><span class="linenum">4580</span></a>  <span class="comment">        // MUST use a recordset, as there is no unique key in the first (or any) column.</span>
<a name="l4581"><span class="linenum">4581</span></a>          <a class="var it15470" onMouseOver="hilite(15470)" onMouseOut="lolite()" onClick="logVariable('catqtypes')" href="../../_variables/catqtypes.html">$catqtypes</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_recordset_sql')" href="../../_functions/get_recordset_sql.html" onMouseOver="funcPopup(event,'get_recordset_sql')">get_recordset_sql</a>(&quot;SELECT DISTINCT bi.parentitemid AS categoryid, q.qtype as qtype
<a name="l4582"><span class="linenum">4582</span></a>                                                 FROM {backup_ids_temp} bi
<a name="l4583"><span class="linenum">4583</span></a>                                                 JOIN {question} q ON q.id = bi.newitemid
<a name="l4584"><span class="linenum">4584</span></a>                                                WHERE bi.backupid = ?
<a name="l4585"><span class="linenum">4585</span></a>                                                  AND bi.itemname = 'question_created'
<a name="l4586"><span class="linenum">4586</span></a>                                             ORDER BY categoryid ASC&quot;, array(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>()));
<a name="l4587"><span class="linenum">4587</span></a>  
<a name="l4588"><span class="linenum">4588</span></a>          <a class="var it15471" onMouseOver="hilite(15471)" onMouseOut="lolite()" onClick="logVariable('currentcatid')" href="../../_variables/currentcatid.html">$currentcatid</a> = -1;
<a name="l4589"><span class="linenum">4589</span></a>          foreach (<a class="var it15470" onMouseOver="hilite(15470)" onMouseOut="lolite()" onClick="logVariable('catqtypes')" href="../../_variables/catqtypes.html">$catqtypes</a> as <a class="var it904" onMouseOver="hilite(904)" onMouseOut="lolite()" onClick="logVariable('categoryid')" href="../../_variables/categoryid.html">$categoryid</a> =&gt; <a class="var it57" onMouseOver="hilite(57)" onMouseOut="lolite()" onClick="logVariable('row')" href="../../_variables/row.html">$row</a>) {
<a name="l4590"><span class="linenum">4590</span></a>              <a class="var it260" onMouseOver="hilite(260)" onMouseOut="lolite()" onClick="logVariable('qtype')" href="../../_variables/qtype.html">$qtype</a> = <a class="var it57" onMouseOver="hilite(57)" onMouseOut="lolite()" onClick="logVariable('row')" href="../../_variables/row.html">$row</a>-&gt;<a onClick="logVariable('qtype')" class="var it42924" onMouseOver="hilite(42924)" onMouseOut="lolite()" href="../../_variables/qtype.html">qtype</a>;
<a name="l4591"><span class="linenum">4591</span></a>  
<a name="l4592"><span class="linenum">4592</span></a>  <span class="comment">            // Check if we are in a new category.</span>
<a name="l4593"><span class="linenum">4593</span></a>              if (<a class="var it15471" onMouseOver="hilite(15471)" onMouseOut="lolite()" onClick="logVariable('currentcatid')" href="../../_variables/currentcatid.html">$currentcatid</a> !== <a class="var it904" onMouseOver="hilite(904)" onMouseOut="lolite()" onClick="logVariable('categoryid')" href="../../_variables/categoryid.html">$categoryid</a>) {
<a name="l4594"><span class="linenum">4594</span></a>  <span class="comment">                // Report progress for each category.</span>
<a name="l4595"><span class="linenum">4595</span></a>                  <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>-&gt;<a class="function" onClick="logFunction('progress')" href="../../_functions/progress.html" onMouseOver="funcPopup(event,'progress')">progress</a>();
<a name="l4596"><span class="linenum">4596</span></a>  
<a name="l4597"><span class="linenum">4597</span></a>                  if (!<a class="var it15472" onMouseOver="hilite(15472)" onMouseOut="lolite()" onClick="logVariable('qcatmapping')" href="../../_variables/qcatmapping.html">$qcatmapping</a> = restore_dbops::<a class="function" onClick="logFunction('get_backup_ids_record')" href="../../_functions/get_backup_ids_record.html" onMouseOver="funcPopup(event,'get_backup_ids_record')">get_backup_ids_record</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(),
<a name="l4598"><span class="linenum">4598</span></a>                          'question_category', <a class="var it904" onMouseOver="hilite(904)" onMouseOut="lolite()" onClick="logVariable('categoryid')" href="../../_variables/categoryid.html">$categoryid</a>)) {
<a name="l4599"><span class="linenum">4599</span></a>  <span class="comment">                    // Something went really wrong, cannot find the question_category for the question_created records.</span>
<a name="l4600"><span class="linenum">4600</span></a>                      <a class="function" onClick="logFunction('debugging')" href="../../_functions/debugging.html" onMouseOver="funcPopup(event,'debugging')">debugging</a>('Error fetching target context for question', <a class="constant" onClick="logConstant('DEBUG_DEVELOPER')" href="../../_constants/DEBUG_DEVELOPER.html" onMouseOver="constPopup(event,'DEBUG_DEVELOPER')">DEBUG_DEVELOPER</a>);
<a name="l4601"><span class="linenum">4601</span></a>                      continue;
<a name="l4602"><span class="linenum">4602</span></a>                  }
<a name="l4603"><span class="linenum">4603</span></a>  
<a name="l4604"><span class="linenum">4604</span></a>  <span class="comment">                // Calculate source and target contexts.</span>
<a name="l4605"><span class="linenum">4605</span></a>                  <a class="var it15473" onMouseOver="hilite(15473)" onMouseOut="lolite()" onClick="logVariable('oldctxid')" href="../../_variables/oldctxid.html">$oldctxid</a> = <a class="var it15472" onMouseOver="hilite(15472)" onMouseOut="lolite()" onClick="logVariable('qcatmapping')" href="../../_variables/qcatmapping.html">$qcatmapping</a>-&gt;<a onClick="logVariable('info')" class="var it45304" onMouseOver="hilite(45304)" onMouseOut="lolite()" href="../../_variables/info.html">info</a>-&gt;contextid;
<a name="l4606"><span class="linenum">4606</span></a>                  <a class="var it15474" onMouseOver="hilite(15474)" onMouseOut="lolite()" onClick="logVariable('newctxid')" href="../../_variables/newctxid.html">$newctxid</a> = <a class="var it15472" onMouseOver="hilite(15472)" onMouseOut="lolite()" onClick="logVariable('qcatmapping')" href="../../_variables/qcatmapping.html">$qcatmapping</a>-&gt;<a onClick="logVariable('parentitemid')" class="var it45304" onMouseOver="hilite(45304)" onMouseOut="lolite()" href="../../_variables/parentitemid.html">parentitemid</a>;
<a name="l4607"><span class="linenum">4607</span></a>  
<a name="l4608"><span class="linenum">4608</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('send_common_files')" href="../../_functions/send_common_files.html" onMouseOver="funcPopup(event,'send_common_files')">send_common_files</a>(<a class="var it15473" onMouseOver="hilite(15473)" onMouseOut="lolite()" onClick="logVariable('oldctxid')" href="../../_variables/oldctxid.html">$oldctxid</a>, <a class="var it15474" onMouseOver="hilite(15474)" onMouseOut="lolite()" onClick="logVariable('newctxid')" href="../../_variables/newctxid.html">$newctxid</a>, <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>);
<a name="l4609"><span class="linenum">4609</span></a>                  <a class="var it15471" onMouseOver="hilite(15471)" onMouseOut="lolite()" onClick="logVariable('currentcatid')" href="../../_variables/currentcatid.html">$currentcatid</a> = <a class="var it904" onMouseOver="hilite(904)" onMouseOut="lolite()" onClick="logVariable('categoryid')" href="../../_variables/categoryid.html">$categoryid</a>;
<a name="l4610"><span class="linenum">4610</span></a>              }
<a name="l4611"><span class="linenum">4611</span></a>  
<a name="l4612"><span class="linenum">4612</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('send_qtype_files')" href="../../_functions/send_qtype_files.html" onMouseOver="funcPopup(event,'send_qtype_files')">send_qtype_files</a>(<a class="var it260" onMouseOver="hilite(260)" onMouseOut="lolite()" onClick="logVariable('qtype')" href="../../_variables/qtype.html">$qtype</a>, <a class="var it15473" onMouseOver="hilite(15473)" onMouseOut="lolite()" onClick="logVariable('oldctxid')" href="../../_variables/oldctxid.html">$oldctxid</a>, <a class="var it15474" onMouseOver="hilite(15474)" onMouseOut="lolite()" onClick="logVariable('newctxid')" href="../../_variables/newctxid.html">$newctxid</a>, <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>);
<a name="l4613"><span class="linenum">4613</span></a>          }
<a name="l4614"><span class="linenum">4614</span></a>          <a class="var it15470" onMouseOver="hilite(15470)" onMouseOut="lolite()" onClick="logVariable('catqtypes')" href="../../_variables/catqtypes.html">$catqtypes</a>-&gt;<a class="function" onClick="logFunction('close')" href="../../_functions/close.html" onMouseOver="funcPopup(event,'close')">close</a>();
<a name="l4615"><span class="linenum">4615</span></a>          <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>-&gt;<a class="function" onClick="logFunction('end_progress')" href="../../_functions/end_progress.html" onMouseOver="funcPopup(event,'end_progress')">end_progress</a>();
<a name="l4616"><span class="linenum">4616</span></a>      }
<a name="l4617"><span class="linenum">4617</span></a>  
<a name="l4618"><span class="linenum">4618</span></a>      <span class="comment">/**</span>
<a name="l4619"><span class="linenum">4619</span></a>  <span class="comment">     * Send the common question files to a new context.</span>
<a name="l4620"><span class="linenum">4620</span></a>  <span class="comment">     *</span>
<a name="l4621"><span class="linenum">4621</span></a>  <span class="comment">     * @param int             $oldctxid Old context id.</span>
<a name="l4622"><span class="linenum">4622</span></a>  <span class="comment">     * @param int             $newctxid New context id.</span>
<a name="l4623"><span class="linenum">4623</span></a>  <span class="comment">     * @param \core\progress  $progress Progress object to use.</span>
<a name="l4624"><span class="linenum">4624</span></a>  <span class="comment">     */</span>
<a name="l4625"><span class="linenum">4625</span></a>      private function <a class="function" onClick="logFunction('send_common_files')" href="../../_functions/send_common_files.html" onMouseOver="funcPopup(event,'send_common_files')">send_common_files</a>(<a class="var it15473" onMouseOver="hilite(15473)" onMouseOut="lolite()" onClick="logVariable('oldctxid')" href="../../_variables/oldctxid.html">$oldctxid</a>, <a class="var it15474" onMouseOver="hilite(15474)" onMouseOut="lolite()" onClick="logVariable('newctxid')" href="../../_variables/newctxid.html">$newctxid</a>, <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>) {
<a name="l4626"><span class="linenum">4626</span></a>  <span class="comment">        // Add common question files (question and question_answer ones).</span>
<a name="l4627"><span class="linenum">4627</span></a>          restore_dbops::<a class="function" onClick="logFunction('send_files_to_pool')" href="../../_functions/send_files_to_pool.html" onMouseOver="funcPopup(event,'send_files_to_pool')">send_files_to_pool</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_basepath')" href="../../_functions/get_basepath.html" onMouseOver="funcPopup(event,'get_basepath')">get_basepath</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'question', 'questiontext',
<a name="l4628"><span class="linenum">4628</span></a>                  <a class="var it15473" onMouseOver="hilite(15473)" onMouseOut="lolite()" onClick="logVariable('oldctxid')" href="../../_variables/oldctxid.html">$oldctxid</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>(), 'question_created', null, <a class="var it15474" onMouseOver="hilite(15474)" onMouseOut="lolite()" onClick="logVariable('newctxid')" href="../../_variables/newctxid.html">$newctxid</a>, true, <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>);
<a name="l4629"><span class="linenum">4629</span></a>          restore_dbops::<a class="function" onClick="logFunction('send_files_to_pool')" href="../../_functions/send_files_to_pool.html" onMouseOver="funcPopup(event,'send_files_to_pool')">send_files_to_pool</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_basepath')" href="../../_functions/get_basepath.html" onMouseOver="funcPopup(event,'get_basepath')">get_basepath</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'question', 'generalfeedback',
<a name="l4630"><span class="linenum">4630</span></a>                  <a class="var it15473" onMouseOver="hilite(15473)" onMouseOut="lolite()" onClick="logVariable('oldctxid')" href="../../_variables/oldctxid.html">$oldctxid</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>(), 'question_created', null, <a class="var it15474" onMouseOver="hilite(15474)" onMouseOut="lolite()" onClick="logVariable('newctxid')" href="../../_variables/newctxid.html">$newctxid</a>, true, <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>);
<a name="l4631"><span class="linenum">4631</span></a>          restore_dbops::<a class="function" onClick="logFunction('send_files_to_pool')" href="../../_functions/send_files_to_pool.html" onMouseOver="funcPopup(event,'send_files_to_pool')">send_files_to_pool</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_basepath')" href="../../_functions/get_basepath.html" onMouseOver="funcPopup(event,'get_basepath')">get_basepath</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'question', 'answer',
<a name="l4632"><span class="linenum">4632</span></a>                  <a class="var it15473" onMouseOver="hilite(15473)" onMouseOut="lolite()" onClick="logVariable('oldctxid')" href="../../_variables/oldctxid.html">$oldctxid</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>(), 'question_answer', null, <a class="var it15474" onMouseOver="hilite(15474)" onMouseOut="lolite()" onClick="logVariable('newctxid')" href="../../_variables/newctxid.html">$newctxid</a>, true, <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>);
<a name="l4633"><span class="linenum">4633</span></a>          restore_dbops::<a class="function" onClick="logFunction('send_files_to_pool')" href="../../_functions/send_files_to_pool.html" onMouseOver="funcPopup(event,'send_files_to_pool')">send_files_to_pool</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_basepath')" href="../../_functions/get_basepath.html" onMouseOver="funcPopup(event,'get_basepath')">get_basepath</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'question', 'answerfeedback',
<a name="l4634"><span class="linenum">4634</span></a>                  <a class="var it15473" onMouseOver="hilite(15473)" onMouseOut="lolite()" onClick="logVariable('oldctxid')" href="../../_variables/oldctxid.html">$oldctxid</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>(), 'question_answer', null, <a class="var it15474" onMouseOver="hilite(15474)" onMouseOut="lolite()" onClick="logVariable('newctxid')" href="../../_variables/newctxid.html">$newctxid</a>, true, <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>);
<a name="l4635"><span class="linenum">4635</span></a>          restore_dbops::<a class="function" onClick="logFunction('send_files_to_pool')" href="../../_functions/send_files_to_pool.html" onMouseOver="funcPopup(event,'send_files_to_pool')">send_files_to_pool</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_basepath')" href="../../_functions/get_basepath.html" onMouseOver="funcPopup(event,'get_basepath')">get_basepath</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'question', 'hint',
<a name="l4636"><span class="linenum">4636</span></a>                  <a class="var it15473" onMouseOver="hilite(15473)" onMouseOut="lolite()" onClick="logVariable('oldctxid')" href="../../_variables/oldctxid.html">$oldctxid</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>(), 'question_hint', null, <a class="var it15474" onMouseOver="hilite(15474)" onMouseOut="lolite()" onClick="logVariable('newctxid')" href="../../_variables/newctxid.html">$newctxid</a>, true, <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>);
<a name="l4637"><span class="linenum">4637</span></a>          restore_dbops::<a class="function" onClick="logFunction('send_files_to_pool')" href="../../_functions/send_files_to_pool.html" onMouseOver="funcPopup(event,'send_files_to_pool')">send_files_to_pool</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_basepath')" href="../../_functions/get_basepath.html" onMouseOver="funcPopup(event,'get_basepath')">get_basepath</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'question', 'correctfeedback',
<a name="l4638"><span class="linenum">4638</span></a>                  <a class="var it15473" onMouseOver="hilite(15473)" onMouseOut="lolite()" onClick="logVariable('oldctxid')" href="../../_variables/oldctxid.html">$oldctxid</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>(), 'question_created', null, <a class="var it15474" onMouseOver="hilite(15474)" onMouseOut="lolite()" onClick="logVariable('newctxid')" href="../../_variables/newctxid.html">$newctxid</a>, true, <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>);
<a name="l4639"><span class="linenum">4639</span></a>          restore_dbops::<a class="function" onClick="logFunction('send_files_to_pool')" href="../../_functions/send_files_to_pool.html" onMouseOver="funcPopup(event,'send_files_to_pool')">send_files_to_pool</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_basepath')" href="../../_functions/get_basepath.html" onMouseOver="funcPopup(event,'get_basepath')">get_basepath</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'question', 'partiallycorrectfeedback',
<a name="l4640"><span class="linenum">4640</span></a>                  <a class="var it15473" onMouseOver="hilite(15473)" onMouseOut="lolite()" onClick="logVariable('oldctxid')" href="../../_variables/oldctxid.html">$oldctxid</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>(), 'question_created', null, <a class="var it15474" onMouseOver="hilite(15474)" onMouseOut="lolite()" onClick="logVariable('newctxid')" href="../../_variables/newctxid.html">$newctxid</a>, true, <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>);
<a name="l4641"><span class="linenum">4641</span></a>          restore_dbops::<a class="function" onClick="logFunction('send_files_to_pool')" href="../../_functions/send_files_to_pool.html" onMouseOver="funcPopup(event,'send_files_to_pool')">send_files_to_pool</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_basepath')" href="../../_functions/get_basepath.html" onMouseOver="funcPopup(event,'get_basepath')">get_basepath</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'question', 'incorrectfeedback',
<a name="l4642"><span class="linenum">4642</span></a>                  <a class="var it15473" onMouseOver="hilite(15473)" onMouseOut="lolite()" onClick="logVariable('oldctxid')" href="../../_variables/oldctxid.html">$oldctxid</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>(), 'question_created', null, <a class="var it15474" onMouseOver="hilite(15474)" onMouseOut="lolite()" onClick="logVariable('newctxid')" href="../../_variables/newctxid.html">$newctxid</a>, true, <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>);
<a name="l4643"><span class="linenum">4643</span></a>      }
<a name="l4644"><span class="linenum">4644</span></a>  
<a name="l4645"><span class="linenum">4645</span></a>      <span class="comment">/**</span>
<a name="l4646"><span class="linenum">4646</span></a>  <span class="comment">     * Send the question type specific files to a new context.</span>
<a name="l4647"><span class="linenum">4647</span></a>  <span class="comment">     *</span>
<a name="l4648"><span class="linenum">4648</span></a>  <span class="comment">     * @param text            $qtype The qtype name to send.</span>
<a name="l4649"><span class="linenum">4649</span></a>  <span class="comment">     * @param int             $oldctxid Old context id.</span>
<a name="l4650"><span class="linenum">4650</span></a>  <span class="comment">     * @param int             $newctxid New context id.</span>
<a name="l4651"><span class="linenum">4651</span></a>  <span class="comment">     * @param \core\progress  $progress Progress object to use.</span>
<a name="l4652"><span class="linenum">4652</span></a>  <span class="comment">     */</span>
<a name="l4653"><span class="linenum">4653</span></a>      private function <a class="function" onClick="logFunction('send_qtype_files')" href="../../_functions/send_qtype_files.html" onMouseOver="funcPopup(event,'send_qtype_files')">send_qtype_files</a>(<a class="var it260" onMouseOver="hilite(260)" onMouseOut="lolite()" onClick="logVariable('qtype')" href="../../_variables/qtype.html">$qtype</a>, <a class="var it15473" onMouseOver="hilite(15473)" onMouseOut="lolite()" onClick="logVariable('oldctxid')" href="../../_variables/oldctxid.html">$oldctxid</a>, <a class="var it15474" onMouseOver="hilite(15474)" onMouseOut="lolite()" onClick="logVariable('newctxid')" href="../../_variables/newctxid.html">$newctxid</a>, <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>) {
<a name="l4654"><span class="linenum">4654</span></a>          if (!isset(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('qtypecomponentscache')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/qtypecomponentscache.html">qtypecomponentscache</a>[<a class="var it260" onMouseOver="hilite(260)" onMouseOut="lolite()" onClick="logVariable('qtype')" href="../../_variables/qtype.html">$qtype</a>])) {
<a name="l4655"><span class="linenum">4655</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('qtypecomponentscache')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/qtypecomponentscache.html">qtypecomponentscache</a>[<a class="var it260" onMouseOver="hilite(260)" onMouseOut="lolite()" onClick="logVariable('qtype')" href="../../_variables/qtype.html">$qtype</a>] = backup_qtype_plugin::<a class="function" onClick="logFunction('get_components_and_fileareas')" href="../../_functions/get_components_and_fileareas.html" onMouseOver="funcPopup(event,'get_components_and_fileareas')">get_components_and_fileareas</a>(<a class="var it260" onMouseOver="hilite(260)" onMouseOut="lolite()" onClick="logVariable('qtype')" href="../../_variables/qtype.html">$qtype</a>);
<a name="l4656"><span class="linenum">4656</span></a>          }
<a name="l4657"><span class="linenum">4657</span></a>          <a class="var it1417" onMouseOver="hilite(1417)" onMouseOut="lolite()" onClick="logVariable('components')" href="../../_variables/components.html">$components</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('qtypecomponentscache')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/qtypecomponentscache.html">qtypecomponentscache</a>[<a class="var it260" onMouseOver="hilite(260)" onMouseOut="lolite()" onClick="logVariable('qtype')" href="../../_variables/qtype.html">$qtype</a>];
<a name="l4658"><span class="linenum">4658</span></a>          foreach (<a class="var it1417" onMouseOver="hilite(1417)" onMouseOut="lolite()" onClick="logVariable('components')" href="../../_variables/components.html">$components</a> as <a class="var it227" onMouseOver="hilite(227)" onMouseOut="lolite()" onClick="logVariable('component')" href="../../_variables/component.html">$component</a> =&gt; <a class="var it9842" onMouseOver="hilite(9842)" onMouseOut="lolite()" onClick="logVariable('fileareas')" href="../../_variables/fileareas.html">$fileareas</a>) {
<a name="l4659"><span class="linenum">4659</span></a>              foreach (<a class="var it9842" onMouseOver="hilite(9842)" onMouseOut="lolite()" onClick="logVariable('fileareas')" href="../../_variables/fileareas.html">$fileareas</a> as <a class="var it24" onMouseOver="hilite(24)" onMouseOut="lolite()" onClick="logVariable('filearea')" href="../../_variables/filearea.html">$filearea</a> =&gt; <a class="var it679" onMouseOver="hilite(679)" onMouseOut="lolite()" onClick="logVariable('mapping')" href="../../_variables/mapping.html">$mapping</a>) {
<a name="l4660"><span class="linenum">4660</span></a>                  restore_dbops::<a class="function" onClick="logFunction('send_files_to_pool')" href="../../_functions/send_files_to_pool.html" onMouseOver="funcPopup(event,'send_files_to_pool')">send_files_to_pool</a>(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_basepath')" href="../../_functions/get_basepath.html" onMouseOver="funcPopup(event,'get_basepath')">get_basepath</a>(), <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), <a class="var it227" onMouseOver="hilite(227)" onMouseOut="lolite()" onClick="logVariable('component')" href="../../_variables/component.html">$component</a>, <a class="var it24" onMouseOver="hilite(24)" onMouseOut="lolite()" onClick="logVariable('filearea')" href="../../_variables/filearea.html">$filearea</a>,
<a name="l4661"><span class="linenum">4661</span></a>                          <a class="var it15473" onMouseOver="hilite(15473)" onMouseOut="lolite()" onClick="logVariable('oldctxid')" href="../../_variables/oldctxid.html">$oldctxid</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_userid')" href="../../_functions/get_userid.html" onMouseOver="funcPopup(event,'get_userid')">get_userid</a>(), <a class="var it679" onMouseOver="hilite(679)" onMouseOut="lolite()" onClick="logVariable('mapping')" href="../../_variables/mapping.html">$mapping</a>, null, <a class="var it15474" onMouseOver="hilite(15474)" onMouseOut="lolite()" onClick="logVariable('newctxid')" href="../../_variables/newctxid.html">$newctxid</a>, true, <a class="var it1049" onMouseOver="hilite(1049)" onMouseOut="lolite()" onClick="logVariable('progress')" href="../../_variables/progress.html">$progress</a>);
<a name="l4662"><span class="linenum">4662</span></a>              }
<a name="l4663"><span class="linenum">4663</span></a>          }
<a name="l4664"><span class="linenum">4664</span></a>      }
<a name="l4665"><span class="linenum">4665</span></a>  }
<a name="l4666"><span class="linenum">4666</span></a>  
<a name="l4667"><span class="linenum">4667</span></a>  <span class="comment">/**</span>
<a name="l4668"><span class="linenum">4668</span></a>  <span class="comment"> * Try to restore aliases and references to external files.</span>
<a name="l4669"><span class="linenum">4669</span></a>  <span class="comment"> *</span>
<a name="l4670"><span class="linenum">4670</span></a>  <span class="comment"> * The queue of these files was prepared for us in {@link restore_dbops::send_files_to_pool()}.</span>
<a name="l4671"><span class="linenum">4671</span></a>  <span class="comment"> * We expect that all regular (non-alias) files have already been restored. Make sure</span>
<a name="l4672"><span class="linenum">4672</span></a>  <span class="comment"> * there is no restore step executed after this one that would call send_files_to_pool() again.</span>
<a name="l4673"><span class="linenum">4673</span></a>  <span class="comment"> *</span>
<a name="l4674"><span class="linenum">4674</span></a>  <span class="comment"> * You may notice we have hardcoded support for Server files, Legacy course files</span>
<a name="l4675"><span class="linenum">4675</span></a>  <span class="comment"> * and user Private files here at the moment. This could be eventually replaced with a set of</span>
<a name="l4676"><span class="linenum">4676</span></a>  <span class="comment"> * callbacks in the future if needed.</span>
<a name="l4677"><span class="linenum">4677</span></a>  <span class="comment"> *</span>
<a name="l4678"><span class="linenum">4678</span></a>  <span class="comment"> * @copyright 2012 David Mudrak &lt;david@moodle.com&gt;</span>
<a name="l4679"><span class="linenum">4679</span></a>  <span class="comment"> * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later</span>
<a name="l4680"><span class="linenum">4680</span></a>  <span class="comment"> */</span>
<a name="l4681"><span class="linenum">4681</span></a>  <span class="keyword">class </span><a class="class" onClick="logClass('restore_process_file_aliases_queue')" href="../../_classes/restore_process_file_aliases_queue.html" onMouseOver="classPopup(event,'restore_process_file_aliases_queue')">restore_process_file_aliases_queue</a> extends restore_execution_step {
<a name="l4682"><span class="linenum">4682</span></a>  
<a name="l4683"><span class="linenum">4683</span></a>  <span class="comment">    /** @var array internal cache for {@link choose_repository()} */</span>
<a name="l4684"><span class="linenum">4684</span></a>      private <a class="var it15475" onMouseOver="hilite(15475)" onMouseOut="lolite()" onClick="logVariable('cachereposbyid')" href="../../_variables/cachereposbyid.html">$cachereposbyid</a> = array();
<a name="l4685"><span class="linenum">4685</span></a>  
<a name="l4686"><span class="linenum">4686</span></a>  <span class="comment">    /** @var array internal cache for {@link choose_repository()} */</span>
<a name="l4687"><span class="linenum">4687</span></a>      private <a class="var it15476" onMouseOver="hilite(15476)" onMouseOut="lolite()" onClick="logVariable('cachereposbytype')" href="../../_variables/cachereposbytype.html">$cachereposbytype</a> = array();
<a name="l4688"><span class="linenum">4688</span></a>  
<a name="l4689"><span class="linenum">4689</span></a>      <span class="comment">/**</span>
<a name="l4690"><span class="linenum">4690</span></a>  <span class="comment">     * What to do when this step is executed.</span>
<a name="l4691"><span class="linenum">4691</span></a>  <span class="comment">     */</span>
<a name="l4692"><span class="linenum">4692</span></a>      protected function <a class="function" onClick="logFunction('define_execution')" href="../../_functions/define_execution.html" onMouseOver="funcPopup(event,'define_execution')">define_execution</a>() {
<a name="l4693"><span class="linenum">4693</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l4694"><span class="linenum">4694</span></a>  
<a name="l4695"><span class="linenum">4695</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="phpfunction" onClick="logFunction('log')" href="../../_functions/log.html" onMouseOver="phpfuncPopup(event,'log')">log</a>('processing file aliases queue', backup::LOG_DEBUG);
<a name="l4696"><span class="linenum">4696</span></a>  
<a name="l4697"><span class="linenum">4697</span></a>          <a class="var it640" onMouseOver="hilite(640)" onMouseOut="lolite()" onClick="logVariable('fs')" href="../../_variables/fs.html">$fs</a> = <a class="function" onClick="logFunction('get_file_storage')" href="../../_functions/get_file_storage.html" onMouseOver="funcPopup(event,'get_file_storage')">get_file_storage</a>();
<a name="l4698"><span class="linenum">4698</span></a>  
<a name="l4699"><span class="linenum">4699</span></a>  <span class="comment">        // Load the queue.</span>
<a name="l4700"><span class="linenum">4700</span></a>          <a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_recordset')" href="../../_functions/get_recordset.html" onMouseOver="funcPopup(event,'get_recordset')">get_recordset</a>('backup_ids_temp',
<a name="l4701"><span class="linenum">4701</span></a>              array('backupid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(), 'itemname' =&gt; 'file_aliases_queue'),
<a name="l4702"><span class="linenum">4702</span></a>              '', 'info');
<a name="l4703"><span class="linenum">4703</span></a>  
<a name="l4704"><span class="linenum">4704</span></a>  <span class="comment">        // Iterate over aliases in the queue.</span>
<a name="l4705"><span class="linenum">4705</span></a>          foreach (<a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a> as <a class="var it699" onMouseOver="hilite(699)" onMouseOut="lolite()" onClick="logVariable('record')" href="../../_variables/record.html">$record</a>) {
<a name="l4706"><span class="linenum">4706</span></a>              <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a> = backup_controller_dbops::<a class="function" onClick="logFunction('decode_backup_temp_info')" href="../../_functions/decode_backup_temp_info.html" onMouseOver="funcPopup(event,'decode_backup_temp_info')">decode_backup_temp_info</a>(<a class="var it699" onMouseOver="hilite(699)" onMouseOut="lolite()" onClick="logVariable('record')" href="../../_variables/record.html">$record</a>-&gt;<a onClick="logVariable('info')" class="var it42976" onMouseOver="hilite(42976)" onMouseOut="lolite()" href="../../_variables/info.html">info</a>);
<a name="l4707"><span class="linenum">4707</span></a>  
<a name="l4708"><span class="linenum">4708</span></a>  <span class="comment">            // Try to pick a repository instance that should serve the alias.</span>
<a name="l4709"><span class="linenum">4709</span></a>              <a class="var it641" onMouseOver="hilite(641)" onMouseOut="lolite()" onClick="logVariable('repository')" href="../../_variables/repository.html">$repository</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('choose_repository')" href="../../_functions/choose_repository.html" onMouseOver="funcPopup(event,'choose_repository')">choose_repository</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>);
<a name="l4710"><span class="linenum">4710</span></a>  
<a name="l4711"><span class="linenum">4711</span></a>              if (<a class="phpfunction" onClick="logFunction('is_null')" href="../../_functions/is_null.html" onMouseOver="phpfuncPopup(event,'is_null')">is_null</a>(<a class="var it641" onMouseOver="hilite(641)" onMouseOut="lolite()" onClick="logVariable('repository')" href="../../_variables/repository.html">$repository</a>)) {
<a name="l4712"><span class="linenum">4712</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('notify_failure')" href="../../_functions/notify_failure.html" onMouseOver="funcPopup(event,'notify_failure')">notify_failure</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>, 'unable to find a matching repository instance');
<a name="l4713"><span class="linenum">4713</span></a>                  continue;
<a name="l4714"><span class="linenum">4714</span></a>              }
<a name="l4715"><span class="linenum">4715</span></a>  
<a name="l4716"><span class="linenum">4716</span></a>              if (<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositorytype === 'local' or <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositorytype === 'coursefiles') {
<a name="l4717"><span class="linenum">4717</span></a>  <span class="comment">                // Aliases to Server files and Legacy course files may refer to a file</span>
<a name="l4718"><span class="linenum">4718</span></a>  <span class="comment">                // contained in the backup file or to some existing file (if we are on the</span>
<a name="l4719"><span class="linenum">4719</span></a>  <span class="comment">                // same site).</span>
<a name="l4720"><span class="linenum">4720</span></a>                  try {
<a name="l4721"><span class="linenum">4721</span></a>                      <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a> = <a class="class" onClick="logClass('file_storage')" href="../../_classes/file_storage.html" onMouseOver="classPopup(event,'file_storage')">file_storage</a>::<a class="function" onClick="logFunction('unpack_reference')" href="../../_functions/unpack_reference.html" onMouseOver="funcPopup(event,'unpack_reference')">unpack_reference</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;reference);
<a name="l4722"><span class="linenum">4722</span></a>                  } catch (Exception <a class="var it122" onMouseOver="hilite(122)" onMouseOut="lolite()" onClick="logVariable('e')" href="../../_variables/e.html">$e</a>) {
<a name="l4723"><span class="linenum">4723</span></a>                      <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('notify_failure')" href="../../_functions/notify_failure.html" onMouseOver="funcPopup(event,'notify_failure')">notify_failure</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>, 'invalid reference field format');
<a name="l4724"><span class="linenum">4724</span></a>                      continue;
<a name="l4725"><span class="linenum">4725</span></a>                  }
<a name="l4726"><span class="linenum">4726</span></a>  
<a name="l4727"><span class="linenum">4727</span></a>  <span class="comment">                // Let's see if the referred source file was also included in the backup.</span>
<a name="l4728"><span class="linenum">4728</span></a>                  <a class="var it6539" onMouseOver="hilite(6539)" onMouseOut="lolite()" onClick="logVariable('candidates')" href="../../_variables/candidates.html">$candidates</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_recordset')" href="../../_functions/get_recordset.html" onMouseOver="funcPopup(event,'get_recordset')">get_recordset</a>('backup_files_temp', array(
<a name="l4729"><span class="linenum">4729</span></a>                          'backupid' =&gt; <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_restoreid')" href="../../_functions/get_restoreid.html" onMouseOver="funcPopup(event,'get_restoreid')">get_restoreid</a>(),
<a name="l4730"><span class="linenum">4730</span></a>                          'contextid' =&gt; <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>['contextid'],
<a name="l4731"><span class="linenum">4731</span></a>                          'component' =&gt; <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>['component'],
<a name="l4732"><span class="linenum">4732</span></a>                          'filearea' =&gt; <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>['filearea'],
<a name="l4733"><span class="linenum">4733</span></a>                          'itemid' =&gt; <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>['itemid'],
<a name="l4734"><span class="linenum">4734</span></a>                      ), '', 'info, newcontextid, newitemid');
<a name="l4735"><span class="linenum">4735</span></a>  
<a name="l4736"><span class="linenum">4736</span></a>                  <a class="var it1771" onMouseOver="hilite(1771)" onMouseOut="lolite()" onClick="logVariable('source')" href="../../_variables/source.html">$source</a> = null;
<a name="l4737"><span class="linenum">4737</span></a>  
<a name="l4738"><span class="linenum">4738</span></a>                  foreach (<a class="var it6539" onMouseOver="hilite(6539)" onMouseOut="lolite()" onClick="logVariable('candidates')" href="../../_variables/candidates.html">$candidates</a> as <a class="var it1856" onMouseOver="hilite(1856)" onMouseOut="lolite()" onClick="logVariable('candidate')" href="../../_variables/candidate.html">$candidate</a>) {
<a name="l4739"><span class="linenum">4739</span></a>                      <a class="var it15477" onMouseOver="hilite(15477)" onMouseOut="lolite()" onClick="logVariable('candidateinfo')" href="../../_variables/candidateinfo.html">$candidateinfo</a> = backup_controller_dbops::<a class="function" onClick="logFunction('decode_backup_temp_info')" href="../../_functions/decode_backup_temp_info.html" onMouseOver="funcPopup(event,'decode_backup_temp_info')">decode_backup_temp_info</a>(<a class="var it1856" onMouseOver="hilite(1856)" onMouseOut="lolite()" onClick="logVariable('candidate')" href="../../_variables/candidate.html">$candidate</a>-&gt;<a onClick="logVariable('info')" class="var it45305" onMouseOver="hilite(45305)" onMouseOut="lolite()" href="../../_variables/info.html">info</a>);
<a name="l4740"><span class="linenum">4740</span></a>                      if (<a class="var it15477" onMouseOver="hilite(15477)" onMouseOut="lolite()" onClick="logVariable('candidateinfo')" href="../../_variables/candidateinfo.html">$candidateinfo</a>-&gt;<a onClick="logVariable('filename')" class="var it45306" onMouseOver="hilite(45306)" onMouseOut="lolite()" href="../../_variables/filename.html">filename</a> === <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>['filename']
<a name="l4741"><span class="linenum">4741</span></a>                              and <a class="var it15477" onMouseOver="hilite(15477)" onMouseOut="lolite()" onClick="logVariable('candidateinfo')" href="../../_variables/candidateinfo.html">$candidateinfo</a>-&gt;<a onClick="logVariable('filepath')" class="var it45306" onMouseOver="hilite(45306)" onMouseOut="lolite()" href="../../_variables/filepath.html">filepath</a> === <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>['filepath']
<a name="l4742"><span class="linenum">4742</span></a>                              and !<a class="phpfunction" onClick="logFunction('is_null')" href="../../_functions/is_null.html" onMouseOver="phpfuncPopup(event,'is_null')">is_null</a>(<a class="var it1856" onMouseOver="hilite(1856)" onMouseOut="lolite()" onClick="logVariable('candidate')" href="../../_variables/candidate.html">$candidate</a>-&gt;<a onClick="logVariable('newcontextid')" class="var it45305" onMouseOver="hilite(45305)" onMouseOut="lolite()" href="../../_variables/newcontextid.html">newcontextid</a>)
<a name="l4743"><span class="linenum">4743</span></a>                              and !<a class="phpfunction" onClick="logFunction('is_null')" href="../../_functions/is_null.html" onMouseOver="phpfuncPopup(event,'is_null')">is_null</a>(<a class="var it1856" onMouseOver="hilite(1856)" onMouseOut="lolite()" onClick="logVariable('candidate')" href="../../_variables/candidate.html">$candidate</a>-&gt;<a onClick="logVariable('newitemid')" class="var it45305" onMouseOver="hilite(45305)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>) ) {
<a name="l4744"><span class="linenum">4744</span></a>                          <a class="var it1771" onMouseOver="hilite(1771)" onMouseOut="lolite()" onClick="logVariable('source')" href="../../_variables/source.html">$source</a> = <a class="var it15477" onMouseOver="hilite(15477)" onMouseOut="lolite()" onClick="logVariable('candidateinfo')" href="../../_variables/candidateinfo.html">$candidateinfo</a>;
<a name="l4745"><span class="linenum">4745</span></a>                          <a class="var it1771" onMouseOver="hilite(1771)" onMouseOut="lolite()" onClick="logVariable('source')" href="../../_variables/source.html">$source</a>-&gt;<a onClick="logVariable('contextid')" class="var it43338" onMouseOver="hilite(43338)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a> = <a class="var it1856" onMouseOver="hilite(1856)" onMouseOut="lolite()" onClick="logVariable('candidate')" href="../../_variables/candidate.html">$candidate</a>-&gt;<a onClick="logVariable('newcontextid')" class="var it45305" onMouseOver="hilite(45305)" onMouseOut="lolite()" href="../../_variables/newcontextid.html">newcontextid</a>;
<a name="l4746"><span class="linenum">4746</span></a>                          <a class="var it1771" onMouseOver="hilite(1771)" onMouseOut="lolite()" onClick="logVariable('source')" href="../../_variables/source.html">$source</a>-&gt;<a onClick="logVariable('itemid')" class="var it43338" onMouseOver="hilite(43338)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a> = <a class="var it1856" onMouseOver="hilite(1856)" onMouseOut="lolite()" onClick="logVariable('candidate')" href="../../_variables/candidate.html">$candidate</a>-&gt;<a onClick="logVariable('newitemid')" class="var it45305" onMouseOver="hilite(45305)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>;
<a name="l4747"><span class="linenum">4747</span></a>                          break;
<a name="l4748"><span class="linenum">4748</span></a>                      }
<a name="l4749"><span class="linenum">4749</span></a>                  }
<a name="l4750"><span class="linenum">4750</span></a>                  <a class="var it6539" onMouseOver="hilite(6539)" onMouseOut="lolite()" onClick="logVariable('candidates')" href="../../_variables/candidates.html">$candidates</a>-&gt;<a class="function" onClick="logFunction('close')" href="../../_functions/close.html" onMouseOver="funcPopup(event,'close')">close</a>();
<a name="l4751"><span class="linenum">4751</span></a>  
<a name="l4752"><span class="linenum">4752</span></a>                  if (<a class="var it1771" onMouseOver="hilite(1771)" onMouseOut="lolite()" onClick="logVariable('source')" href="../../_variables/source.html">$source</a>) {
<a name="l4753"><span class="linenum">4753</span></a>  <span class="comment">                    // We have an alias that refers to another file also included in</span>
<a name="l4754"><span class="linenum">4754</span></a>  <span class="comment">                    // the backup. Let us change the reference field so that it refers</span>
<a name="l4755"><span class="linenum">4755</span></a>  <span class="comment">                    // to the restored copy of the original file.</span>
<a name="l4756"><span class="linenum">4756</span></a>                      <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a> = <a class="class" onClick="logClass('file_storage')" href="../../_classes/file_storage.html" onMouseOver="classPopup(event,'file_storage')">file_storage</a>::<a class="function" onClick="logFunction('pack_reference')" href="../../_functions/pack_reference.html" onMouseOver="funcPopup(event,'pack_reference')">pack_reference</a>(<a class="var it1771" onMouseOver="hilite(1771)" onMouseOut="lolite()" onClick="logVariable('source')" href="../../_variables/source.html">$source</a>);
<a name="l4757"><span class="linenum">4757</span></a>  
<a name="l4758"><span class="linenum">4758</span></a>  <span class="comment">                    // Send the new alias to the filepool.</span>
<a name="l4759"><span class="linenum">4759</span></a>                      <a class="var it640" onMouseOver="hilite(640)" onMouseOut="lolite()" onClick="logVariable('fs')" href="../../_variables/fs.html">$fs</a>-&gt;<a class="function" onClick="logFunction('create_file_from_reference')" href="../../_functions/create_file_from_reference.html" onMouseOver="funcPopup(event,'create_file_from_reference')">create_file_from_reference</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('newfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/newfile.html">newfile</a>, <a class="var it641" onMouseOver="hilite(641)" onMouseOut="lolite()" onClick="logVariable('repository')" href="../../_variables/repository.html">$repository</a>-&gt;<a onClick="logVariable('id')" class="var it43843" onMouseOver="hilite(43843)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>);
<a name="l4760"><span class="linenum">4760</span></a>                      <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('notify_success')" href="../../_functions/notify_success.html" onMouseOver="funcPopup(event,'notify_success')">notify_success</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>);
<a name="l4761"><span class="linenum">4761</span></a>                      continue;
<a name="l4762"><span class="linenum">4762</span></a>  
<a name="l4763"><span class="linenum">4763</span></a>                  } else {
<a name="l4764"><span class="linenum">4764</span></a>  <span class="comment">                    // This is a reference to some moodle file that was not contained in the backup</span>
<a name="l4765"><span class="linenum">4765</span></a>  <span class="comment">                    // file. If we are restoring to the same site, keep the reference untouched</span>
<a name="l4766"><span class="linenum">4766</span></a>  <span class="comment">                    // and restore the alias as is if the referenced file exists.</span>
<a name="l4767"><span class="linenum">4767</span></a>                      if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('is_samesite')" href="../../_functions/is_samesite.html" onMouseOver="funcPopup(event,'is_samesite')">is_samesite</a>()) {
<a name="l4768"><span class="linenum">4768</span></a>                          if (<a class="var it640" onMouseOver="hilite(640)" onMouseOut="lolite()" onClick="logVariable('fs')" href="../../_variables/fs.html">$fs</a>-&gt;<a class="phpfunction" onClick="logFunction('file_exists')" href="../../_functions/file_exists.html" onMouseOver="phpfuncPopup(event,'file_exists')">file_exists</a>(<a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>['contextid'], <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>['component'], <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>['filearea'],
<a name="l4769"><span class="linenum">4769</span></a>                                  <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>['itemid'], <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>['filepath'], <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>['filename'])) {
<a name="l4770"><span class="linenum">4770</span></a>                              <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a> = <a class="class" onClick="logClass('file_storage')" href="../../_classes/file_storage.html" onMouseOver="classPopup(event,'file_storage')">file_storage</a>::<a class="function" onClick="logFunction('pack_reference')" href="../../_functions/pack_reference.html" onMouseOver="funcPopup(event,'pack_reference')">pack_reference</a>(<a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>);
<a name="l4771"><span class="linenum">4771</span></a>                              <a class="var it640" onMouseOver="hilite(640)" onMouseOut="lolite()" onClick="logVariable('fs')" href="../../_variables/fs.html">$fs</a>-&gt;<a class="function" onClick="logFunction('create_file_from_reference')" href="../../_functions/create_file_from_reference.html" onMouseOver="funcPopup(event,'create_file_from_reference')">create_file_from_reference</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('newfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/newfile.html">newfile</a>, <a class="var it641" onMouseOver="hilite(641)" onMouseOut="lolite()" onClick="logVariable('repository')" href="../../_variables/repository.html">$repository</a>-&gt;<a onClick="logVariable('id')" class="var it43843" onMouseOver="hilite(43843)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>);
<a name="l4772"><span class="linenum">4772</span></a>                              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('notify_success')" href="../../_functions/notify_success.html" onMouseOver="funcPopup(event,'notify_success')">notify_success</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>);
<a name="l4773"><span class="linenum">4773</span></a>                              continue;
<a name="l4774"><span class="linenum">4774</span></a>                          } else {
<a name="l4775"><span class="linenum">4775</span></a>                              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('notify_failure')" href="../../_functions/notify_failure.html" onMouseOver="funcPopup(event,'notify_failure')">notify_failure</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>, 'referenced file not found');
<a name="l4776"><span class="linenum">4776</span></a>                              continue;
<a name="l4777"><span class="linenum">4777</span></a>                          }
<a name="l4778"><span class="linenum">4778</span></a>  
<a name="l4779"><span class="linenum">4779</span></a>  <span class="comment">                    // If we are at other site, we can't restore this alias.</span>
<a name="l4780"><span class="linenum">4780</span></a>                      } else {
<a name="l4781"><span class="linenum">4781</span></a>                          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('notify_failure')" href="../../_functions/notify_failure.html" onMouseOver="funcPopup(event,'notify_failure')">notify_failure</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>, 'referenced file not included');
<a name="l4782"><span class="linenum">4782</span></a>                          continue;
<a name="l4783"><span class="linenum">4783</span></a>                      }
<a name="l4784"><span class="linenum">4784</span></a>                  }
<a name="l4785"><span class="linenum">4785</span></a>  
<a name="l4786"><span class="linenum">4786</span></a>              } else if (<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositorytype === 'user') {
<a name="l4787"><span class="linenum">4787</span></a>                  if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('is_samesite')" href="../../_functions/is_samesite.html" onMouseOver="funcPopup(event,'is_samesite')">is_samesite</a>()) {
<a name="l4788"><span class="linenum">4788</span></a>  <span class="comment">                    // For aliases to user Private files at the same site, we have a chance to check</span>
<a name="l4789"><span class="linenum">4789</span></a>  <span class="comment">                    // if the referenced file still exists.</span>
<a name="l4790"><span class="linenum">4790</span></a>                      try {
<a name="l4791"><span class="linenum">4791</span></a>                          <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a> = <a class="class" onClick="logClass('file_storage')" href="../../_classes/file_storage.html" onMouseOver="classPopup(event,'file_storage')">file_storage</a>::<a class="function" onClick="logFunction('unpack_reference')" href="../../_functions/unpack_reference.html" onMouseOver="funcPopup(event,'unpack_reference')">unpack_reference</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;reference);
<a name="l4792"><span class="linenum">4792</span></a>                      } catch (Exception <a class="var it122" onMouseOver="hilite(122)" onMouseOut="lolite()" onClick="logVariable('e')" href="../../_variables/e.html">$e</a>) {
<a name="l4793"><span class="linenum">4793</span></a>                          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('notify_failure')" href="../../_functions/notify_failure.html" onMouseOver="funcPopup(event,'notify_failure')">notify_failure</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>, 'invalid reference field format');
<a name="l4794"><span class="linenum">4794</span></a>                          continue;
<a name="l4795"><span class="linenum">4795</span></a>                      }
<a name="l4796"><span class="linenum">4796</span></a>                      if (<a class="var it640" onMouseOver="hilite(640)" onMouseOut="lolite()" onClick="logVariable('fs')" href="../../_variables/fs.html">$fs</a>-&gt;<a class="phpfunction" onClick="logFunction('file_exists')" href="../../_functions/file_exists.html" onMouseOver="phpfuncPopup(event,'file_exists')">file_exists</a>(<a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>['contextid'], <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>['component'], <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>['filearea'],
<a name="l4797"><span class="linenum">4797</span></a>                              <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>['itemid'], <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>['filepath'], <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>['filename'])) {
<a name="l4798"><span class="linenum">4798</span></a>                          <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a> = <a class="class" onClick="logClass('file_storage')" href="../../_classes/file_storage.html" onMouseOver="classPopup(event,'file_storage')">file_storage</a>::<a class="function" onClick="logFunction('pack_reference')" href="../../_functions/pack_reference.html" onMouseOver="funcPopup(event,'pack_reference')">pack_reference</a>(<a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>);
<a name="l4799"><span class="linenum">4799</span></a>                          <a class="var it640" onMouseOver="hilite(640)" onMouseOut="lolite()" onClick="logVariable('fs')" href="../../_variables/fs.html">$fs</a>-&gt;<a class="function" onClick="logFunction('create_file_from_reference')" href="../../_functions/create_file_from_reference.html" onMouseOver="funcPopup(event,'create_file_from_reference')">create_file_from_reference</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('newfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/newfile.html">newfile</a>, <a class="var it641" onMouseOver="hilite(641)" onMouseOut="lolite()" onClick="logVariable('repository')" href="../../_variables/repository.html">$repository</a>-&gt;<a onClick="logVariable('id')" class="var it43843" onMouseOver="hilite(43843)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, <a class="var it642" onMouseOver="hilite(642)" onMouseOut="lolite()" onClick="logVariable('reference')" href="../../_variables/reference.html">$reference</a>);
<a name="l4800"><span class="linenum">4800</span></a>                          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('notify_success')" href="../../_functions/notify_success.html" onMouseOver="funcPopup(event,'notify_success')">notify_success</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>);
<a name="l4801"><span class="linenum">4801</span></a>                          continue;
<a name="l4802"><span class="linenum">4802</span></a>                      } else {
<a name="l4803"><span class="linenum">4803</span></a>                          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('notify_failure')" href="../../_functions/notify_failure.html" onMouseOver="funcPopup(event,'notify_failure')">notify_failure</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>, 'referenced file not found');
<a name="l4804"><span class="linenum">4804</span></a>                          continue;
<a name="l4805"><span class="linenum">4805</span></a>                      }
<a name="l4806"><span class="linenum">4806</span></a>  
<a name="l4807"><span class="linenum">4807</span></a>  <span class="comment">                // If we are at other site, we can't restore this alias.</span>
<a name="l4808"><span class="linenum">4808</span></a>                  } else {
<a name="l4809"><span class="linenum">4809</span></a>                      <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('notify_failure')" href="../../_functions/notify_failure.html" onMouseOver="funcPopup(event,'notify_failure')">notify_failure</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>, 'restoring at another site');
<a name="l4810"><span class="linenum">4810</span></a>                      continue;
<a name="l4811"><span class="linenum">4811</span></a>                  }
<a name="l4812"><span class="linenum">4812</span></a>  
<a name="l4813"><span class="linenum">4813</span></a>              } else {
<a name="l4814"><span class="linenum">4814</span></a>  <span class="comment">                // This is a reference to some external file such as in boxnet or dropbox.</span>
<a name="l4815"><span class="linenum">4815</span></a>  <span class="comment">                // If we are restoring to the same site, keep the reference untouched and</span>
<a name="l4816"><span class="linenum">4816</span></a>  <span class="comment">                // restore the alias as is.</span>
<a name="l4817"><span class="linenum">4817</span></a>                  if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('is_samesite')" href="../../_functions/is_samesite.html" onMouseOver="funcPopup(event,'is_samesite')">is_samesite</a>()) {
<a name="l4818"><span class="linenum">4818</span></a>                      <a class="var it640" onMouseOver="hilite(640)" onMouseOut="lolite()" onClick="logVariable('fs')" href="../../_variables/fs.html">$fs</a>-&gt;<a class="function" onClick="logFunction('create_file_from_reference')" href="../../_functions/create_file_from_reference.html" onMouseOver="funcPopup(event,'create_file_from_reference')">create_file_from_reference</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('newfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/newfile.html">newfile</a>, <a class="var it641" onMouseOver="hilite(641)" onMouseOut="lolite()" onClick="logVariable('repository')" href="../../_variables/repository.html">$repository</a>-&gt;<a onClick="logVariable('id')" class="var it43843" onMouseOver="hilite(43843)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>, <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;reference);
<a name="l4819"><span class="linenum">4819</span></a>                      <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('notify_success')" href="../../_functions/notify_success.html" onMouseOver="funcPopup(event,'notify_success')">notify_success</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>);
<a name="l4820"><span class="linenum">4820</span></a>                      continue;
<a name="l4821"><span class="linenum">4821</span></a>  
<a name="l4822"><span class="linenum">4822</span></a>  <span class="comment">                // If we are at other site, we can't restore this alias.</span>
<a name="l4823"><span class="linenum">4823</span></a>                  } else {
<a name="l4824"><span class="linenum">4824</span></a>                      <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('notify_failure')" href="../../_functions/notify_failure.html" onMouseOver="funcPopup(event,'notify_failure')">notify_failure</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>, 'restoring at another site');
<a name="l4825"><span class="linenum">4825</span></a>                      continue;
<a name="l4826"><span class="linenum">4826</span></a>                  }
<a name="l4827"><span class="linenum">4827</span></a>              }
<a name="l4828"><span class="linenum">4828</span></a>          }
<a name="l4829"><span class="linenum">4829</span></a>          <a class="var it83" onMouseOver="hilite(83)" onMouseOut="lolite()" onClick="logVariable('rs')" href="../../_variables/rs.html">$rs</a>-&gt;<a class="function" onClick="logFunction('close')" href="../../_functions/close.html" onMouseOver="funcPopup(event,'close')">close</a>();
<a name="l4830"><span class="linenum">4830</span></a>      }
<a name="l4831"><span class="linenum">4831</span></a>  
<a name="l4832"><span class="linenum">4832</span></a>      <span class="comment">/**</span>
<a name="l4833"><span class="linenum">4833</span></a>  <span class="comment">     * Choose the repository instance that should handle the alias.</span>
<a name="l4834"><span class="linenum">4834</span></a>  <span class="comment">     *</span>
<a name="l4835"><span class="linenum">4835</span></a>  <span class="comment">     * At the same site, we can rely on repository instance id and we just</span>
<a name="l4836"><span class="linenum">4836</span></a>  <span class="comment">     * check it still exists. On other site, try to find matching Server files or</span>
<a name="l4837"><span class="linenum">4837</span></a>  <span class="comment">     * Legacy course files repository instance. Return null if no matching</span>
<a name="l4838"><span class="linenum">4838</span></a>  <span class="comment">     * repository instance can be found.</span>
<a name="l4839"><span class="linenum">4839</span></a>  <span class="comment">     *</span>
<a name="l4840"><span class="linenum">4840</span></a>  <span class="comment">     * @param stdClass $info</span>
<a name="l4841"><span class="linenum">4841</span></a>  <span class="comment">     * @return repository|null</span>
<a name="l4842"><span class="linenum">4842</span></a>  <span class="comment">     */</span>
<a name="l4843"><span class="linenum">4843</span></a>      private function <a class="function" onClick="logFunction('choose_repository')" href="../../_functions/choose_repository.html" onMouseOver="funcPopup(event,'choose_repository')">choose_repository</a>(stdClass <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>) {
<a name="l4844"><span class="linenum">4844</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>, <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>;
<a name="l4845"><span class="linenum">4845</span></a>          require_once(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('dirroot')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/dirroot.html">dirroot</a>.'<a class="filename" href="../../repository/lib.php.html">/repository/lib.php</a>');
<a name="l4846"><span class="linenum">4846</span></a>  
<a name="l4847"><span class="linenum">4847</span></a>          if (<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('is_samesite')" href="../../_functions/is_samesite.html" onMouseOver="funcPopup(event,'is_samesite')">is_samesite</a>()) {
<a name="l4848"><span class="linenum">4848</span></a>  <span class="comment">            // We can rely on repository instance id.</span>
<a name="l4849"><span class="linenum">4849</span></a>  
<a name="l4850"><span class="linenum">4850</span></a>              if (<a class="phpfunction" onClick="logFunction('array_key_exists')" href="../../_functions/array_key_exists.html" onMouseOver="phpfuncPopup(event,'array_key_exists')">array_key_exists</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositoryid, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('cachereposbyid')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/cachereposbyid.html">cachereposbyid</a>)) {
<a name="l4851"><span class="linenum">4851</span></a>                  return <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('cachereposbyid')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/cachereposbyid.html">cachereposbyid</a>[<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositoryid];
<a name="l4852"><span class="linenum">4852</span></a>              }
<a name="l4853"><span class="linenum">4853</span></a>  
<a name="l4854"><span class="linenum">4854</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="phpfunction" onClick="logFunction('log')" href="../../_functions/log.html" onMouseOver="phpfuncPopup(event,'log')">log</a>('looking for repository instance by id', backup::LOG_DEBUG, <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositoryid, 1);
<a name="l4855"><span class="linenum">4855</span></a>  
<a name="l4856"><span class="linenum">4856</span></a>              try {
<a name="l4857"><span class="linenum">4857</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('cachereposbyid')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/cachereposbyid.html">cachereposbyid</a>[<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositoryid] = <a class="class" onClick="logClass('repository')" href="../../_classes/repository.html" onMouseOver="classPopup(event,'repository')">repository</a>::<a class="function" onClick="logFunction('get_repository_by_id')" href="../../_functions/get_repository_by_id.html" onMouseOver="funcPopup(event,'get_repository_by_id')">get_repository_by_id</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositoryid, <a class="constant" onClick="logConstant('SYSCONTEXTID')" href="../../_constants/SYSCONTEXTID.html" onMouseOver="constPopup(event,'SYSCONTEXTID')">SYSCONTEXTID</a>);
<a name="l4858"><span class="linenum">4858</span></a>                  return <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('cachereposbyid')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/cachereposbyid.html">cachereposbyid</a>[<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositoryid];
<a name="l4859"><span class="linenum">4859</span></a>              } catch (Exception <a class="var it122" onMouseOver="hilite(122)" onMouseOut="lolite()" onClick="logVariable('e')" href="../../_variables/e.html">$e</a>) {
<a name="l4860"><span class="linenum">4860</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('cachereposbyid')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/cachereposbyid.html">cachereposbyid</a>[<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositoryid] = null;
<a name="l4861"><span class="linenum">4861</span></a>                  return null;
<a name="l4862"><span class="linenum">4862</span></a>              }
<a name="l4863"><span class="linenum">4863</span></a>  
<a name="l4864"><span class="linenum">4864</span></a>          } else {
<a name="l4865"><span class="linenum">4865</span></a>  <span class="comment">            // We can rely on repository type only.</span>
<a name="l4866"><span class="linenum">4866</span></a>  
<a name="l4867"><span class="linenum">4867</span></a>              if (empty(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositorytype)) {
<a name="l4868"><span class="linenum">4868</span></a>                  return null;
<a name="l4869"><span class="linenum">4869</span></a>              }
<a name="l4870"><span class="linenum">4870</span></a>  
<a name="l4871"><span class="linenum">4871</span></a>              if (<a class="phpfunction" onClick="logFunction('array_key_exists')" href="../../_functions/array_key_exists.html" onMouseOver="phpfuncPopup(event,'array_key_exists')">array_key_exists</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositorytype, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('cachereposbytype')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/cachereposbytype.html">cachereposbytype</a>)) {
<a name="l4872"><span class="linenum">4872</span></a>                  return <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('cachereposbytype')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/cachereposbytype.html">cachereposbytype</a>[<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositorytype];
<a name="l4873"><span class="linenum">4873</span></a>              }
<a name="l4874"><span class="linenum">4874</span></a>  
<a name="l4875"><span class="linenum">4875</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="phpfunction" onClick="logFunction('log')" href="../../_functions/log.html" onMouseOver="phpfuncPopup(event,'log')">log</a>('looking for repository instance by type', backup::LOG_DEBUG, <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositorytype, 1);
<a name="l4876"><span class="linenum">4876</span></a>  
<a name="l4877"><span class="linenum">4877</span></a>  <span class="comment">            // Both Server files and Legacy course files repositories have a single</span>
<a name="l4878"><span class="linenum">4878</span></a>  <span class="comment">            // instance at the system context to use. Let us try to find it.</span>
<a name="l4879"><span class="linenum">4879</span></a>              if (<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositorytype === 'local' or <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositorytype === 'coursefiles') {
<a name="l4880"><span class="linenum">4880</span></a>                  <a class="var it64" onMouseOver="hilite(64)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a> = &quot;SELECT ri.id
<a name="l4881"><span class="linenum">4881</span></a>                            FROM {repository} r
<a name="l4882"><span class="linenum">4882</span></a>                            JOIN {repository_instances} ri ON ri.typeid = r.id
<a name="l4883"><span class="linenum">4883</span></a>                           WHERE r.type = ? AND ri.contextid = ?&quot;;
<a name="l4884"><span class="linenum">4884</span></a>                  <a class="var it15478" onMouseOver="hilite(15478)" onMouseOut="lolite()" onClick="logVariable('ris')" href="../../_variables/ris.html">$ris</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records_sql')" href="../../_functions/get_records_sql.html" onMouseOver="funcPopup(event,'get_records_sql')">get_records_sql</a>(<a class="var it64" onMouseOver="hilite(64)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../../_variables/sql.html">$sql</a>, array(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositorytype, <a class="constant" onClick="logConstant('SYSCONTEXTID')" href="../../_constants/SYSCONTEXTID.html" onMouseOver="constPopup(event,'SYSCONTEXTID')">SYSCONTEXTID</a>));
<a name="l4885"><span class="linenum">4885</span></a>                  if (empty(<a class="var it15478" onMouseOver="hilite(15478)" onMouseOut="lolite()" onClick="logVariable('ris')" href="../../_variables/ris.html">$ris</a>)) {
<a name="l4886"><span class="linenum">4886</span></a>                      return null;
<a name="l4887"><span class="linenum">4887</span></a>                  }
<a name="l4888"><span class="linenum">4888</span></a>                  <a class="var it15479" onMouseOver="hilite(15479)" onMouseOut="lolite()" onClick="logVariable('repoids')" href="../../_variables/repoids.html">$repoids</a> = <a class="phpfunction" onClick="logFunction('array_keys')" href="../../_functions/array_keys.html" onMouseOver="phpfuncPopup(event,'array_keys')">array_keys</a>(<a class="var it15478" onMouseOver="hilite(15478)" onMouseOut="lolite()" onClick="logVariable('ris')" href="../../_variables/ris.html">$ris</a>);
<a name="l4889"><span class="linenum">4889</span></a>                  <a class="var it9437" onMouseOver="hilite(9437)" onMouseOut="lolite()" onClick="logVariable('repoid')" href="../../_variables/repoid.html">$repoid</a> = <a class="phpfunction" onClick="logFunction('reset')" href="../../_functions/reset.html" onMouseOver="phpfuncPopup(event,'reset')">reset</a>(<a class="var it15479" onMouseOver="hilite(15479)" onMouseOut="lolite()" onClick="logVariable('repoids')" href="../../_variables/repoids.html">$repoids</a>);
<a name="l4890"><span class="linenum">4890</span></a>                  try {
<a name="l4891"><span class="linenum">4891</span></a>                      <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('cachereposbytype')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/cachereposbytype.html">cachereposbytype</a>[<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositorytype] = <a class="class" onClick="logClass('repository')" href="../../_classes/repository.html" onMouseOver="classPopup(event,'repository')">repository</a>::<a class="function" onClick="logFunction('get_repository_by_id')" href="../../_functions/get_repository_by_id.html" onMouseOver="funcPopup(event,'get_repository_by_id')">get_repository_by_id</a>(<a class="var it9437" onMouseOver="hilite(9437)" onMouseOut="lolite()" onClick="logVariable('repoid')" href="../../_variables/repoid.html">$repoid</a>, <a class="constant" onClick="logConstant('SYSCONTEXTID')" href="../../_constants/SYSCONTEXTID.html" onMouseOver="constPopup(event,'SYSCONTEXTID')">SYSCONTEXTID</a>);
<a name="l4892"><span class="linenum">4892</span></a>                      return <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('cachereposbytype')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/cachereposbytype.html">cachereposbytype</a>[<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositorytype];
<a name="l4893"><span class="linenum">4893</span></a>                  } catch (Exception <a class="var it122" onMouseOver="hilite(122)" onMouseOut="lolite()" onClick="logVariable('e')" href="../../_variables/e.html">$e</a>) {
<a name="l4894"><span class="linenum">4894</span></a>                      <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('cachereposbytype')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/cachereposbytype.html">cachereposbytype</a>[<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositorytype] = null;
<a name="l4895"><span class="linenum">4895</span></a>                      return null;
<a name="l4896"><span class="linenum">4896</span></a>                  }
<a name="l4897"><span class="linenum">4897</span></a>              }
<a name="l4898"><span class="linenum">4898</span></a>  
<a name="l4899"><span class="linenum">4899</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('cachereposbytype')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/cachereposbytype.html">cachereposbytype</a>[<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;repositorytype] = null;
<a name="l4900"><span class="linenum">4900</span></a>              return null;
<a name="l4901"><span class="linenum">4901</span></a>          }
<a name="l4902"><span class="linenum">4902</span></a>      }
<a name="l4903"><span class="linenum">4903</span></a>  
<a name="l4904"><span class="linenum">4904</span></a>      <span class="comment">/**</span>
<a name="l4905"><span class="linenum">4905</span></a>  <span class="comment">     * Let the user know that the given alias was successfully restored</span>
<a name="l4906"><span class="linenum">4906</span></a>  <span class="comment">     *</span>
<a name="l4907"><span class="linenum">4907</span></a>  <span class="comment">     * @param stdClass $info</span>
<a name="l4908"><span class="linenum">4908</span></a>  <span class="comment">     */</span>
<a name="l4909"><span class="linenum">4909</span></a>      private function <a class="function" onClick="logFunction('notify_success')" href="../../_functions/notify_success.html" onMouseOver="funcPopup(event,'notify_success')">notify_success</a>(stdClass <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>) {
<a name="l4910"><span class="linenum">4910</span></a>          <a class="var it15480" onMouseOver="hilite(15480)" onMouseOut="lolite()" onClick="logVariable('filedesc')" href="../../_variables/filedesc.html">$filedesc</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('describe_alias')" href="../../_functions/describe_alias.html" onMouseOver="funcPopup(event,'describe_alias')">describe_alias</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>);
<a name="l4911"><span class="linenum">4911</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="phpfunction" onClick="logFunction('log')" href="../../_functions/log.html" onMouseOver="phpfuncPopup(event,'log')">log</a>('successfully restored alias', backup::LOG_DEBUG, <a class="var it15480" onMouseOver="hilite(15480)" onMouseOut="lolite()" onClick="logVariable('filedesc')" href="../../_variables/filedesc.html">$filedesc</a>, 1);
<a name="l4912"><span class="linenum">4912</span></a>      }
<a name="l4913"><span class="linenum">4913</span></a>  
<a name="l4914"><span class="linenum">4914</span></a>      <span class="comment">/**</span>
<a name="l4915"><span class="linenum">4915</span></a>  <span class="comment">     * Let the user know that the given alias can't be restored</span>
<a name="l4916"><span class="linenum">4916</span></a>  <span class="comment">     *</span>
<a name="l4917"><span class="linenum">4917</span></a>  <span class="comment">     * @param stdClass $info</span>
<a name="l4918"><span class="linenum">4918</span></a>  <span class="comment">     * @param string $reason detailed reason to be logged</span>
<a name="l4919"><span class="linenum">4919</span></a>  <span class="comment">     */</span>
<a name="l4920"><span class="linenum">4920</span></a>      private function <a class="function" onClick="logFunction('notify_failure')" href="../../_functions/notify_failure.html" onMouseOver="funcPopup(event,'notify_failure')">notify_failure</a>(stdClass <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>, <a class="var it838" onMouseOver="hilite(838)" onMouseOut="lolite()" onClick="logVariable('reason')" href="../../_variables/reason.html">$reason</a> = '') {
<a name="l4921"><span class="linenum">4921</span></a>          <a class="var it15480" onMouseOver="hilite(15480)" onMouseOut="lolite()" onClick="logVariable('filedesc')" href="../../_variables/filedesc.html">$filedesc</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('describe_alias')" href="../../_functions/describe_alias.html" onMouseOver="funcPopup(event,'describe_alias')">describe_alias</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>);
<a name="l4922"><span class="linenum">4922</span></a>          if (<a class="var it838" onMouseOver="hilite(838)" onMouseOut="lolite()" onClick="logVariable('reason')" href="../../_variables/reason.html">$reason</a>) {
<a name="l4923"><span class="linenum">4923</span></a>              <a class="var it838" onMouseOver="hilite(838)" onMouseOut="lolite()" onClick="logVariable('reason')" href="../../_variables/reason.html">$reason</a> = ' ('.<a class="var it838" onMouseOver="hilite(838)" onMouseOut="lolite()" onClick="logVariable('reason')" href="../../_variables/reason.html">$reason</a>.')';
<a name="l4924"><span class="linenum">4924</span></a>          }
<a name="l4925"><span class="linenum">4925</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="phpfunction" onClick="logFunction('log')" href="../../_functions/log.html" onMouseOver="phpfuncPopup(event,'log')">log</a>('unable to restore alias'.<a class="var it838" onMouseOver="hilite(838)" onMouseOut="lolite()" onClick="logVariable('reason')" href="../../_variables/reason.html">$reason</a>, backup::LOG_WARNING, <a class="var it15480" onMouseOver="hilite(15480)" onMouseOut="lolite()" onClick="logVariable('filedesc')" href="../../_variables/filedesc.html">$filedesc</a>, 1);
<a name="l4926"><span class="linenum">4926</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_result_item')" href="../../_functions/add_result_item.html" onMouseOver="funcPopup(event,'add_result_item')">add_result_item</a>('file_aliases_restore_failures', <a class="var it15480" onMouseOver="hilite(15480)" onMouseOut="lolite()" onClick="logVariable('filedesc')" href="../../_variables/filedesc.html">$filedesc</a>);
<a name="l4927"><span class="linenum">4927</span></a>      }
<a name="l4928"><span class="linenum">4928</span></a>  
<a name="l4929"><span class="linenum">4929</span></a>      <span class="comment">/**</span>
<a name="l4930"><span class="linenum">4930</span></a>  <span class="comment">     * Return a human readable description of the alias file</span>
<a name="l4931"><span class="linenum">4931</span></a>  <span class="comment">     *</span>
<a name="l4932"><span class="linenum">4932</span></a>  <span class="comment">     * @param stdClass $info</span>
<a name="l4933"><span class="linenum">4933</span></a>  <span class="comment">     * @return string</span>
<a name="l4934"><span class="linenum">4934</span></a>  <span class="comment">     */</span>
<a name="l4935"><span class="linenum">4935</span></a>      private function <a class="function" onClick="logFunction('describe_alias')" href="../../_functions/describe_alias.html" onMouseOver="funcPopup(event,'describe_alias')">describe_alias</a>(stdClass <a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>) {
<a name="l4936"><span class="linenum">4936</span></a>  
<a name="l4937"><span class="linenum">4937</span></a>          <a class="var it15480" onMouseOver="hilite(15480)" onMouseOut="lolite()" onClick="logVariable('filedesc')" href="../../_variables/filedesc.html">$filedesc</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('expected_alias_location')" href="../../_functions/expected_alias_location.html" onMouseOver="funcPopup(event,'expected_alias_location')">expected_alias_location</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('newfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/newfile.html">newfile</a>);
<a name="l4938"><span class="linenum">4938</span></a>  
<a name="l4939"><span class="linenum">4939</span></a>          if (!<a class="phpfunction" onClick="logFunction('is_null')" href="../../_functions/is_null.html" onMouseOver="phpfuncPopup(event,'is_null')">is_null</a>(<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;source)) {
<a name="l4940"><span class="linenum">4940</span></a>              <a class="var it15480" onMouseOver="hilite(15480)" onMouseOut="lolite()" onClick="logVariable('filedesc')" href="../../_variables/filedesc.html">$filedesc</a> .= ' ('.<a class="var it506" onMouseOver="hilite(506)" onMouseOut="lolite()" onClick="logVariable('info')" href="../../_variables/info.html">$info</a>-&gt;<a onClick="logVariable('oldfile')" class="var it42982" onMouseOver="hilite(42982)" onMouseOut="lolite()" href="../../_variables/oldfile.html">oldfile</a>-&gt;source.')';
<a name="l4941"><span class="linenum">4941</span></a>          }
<a name="l4942"><span class="linenum">4942</span></a>  
<a name="l4943"><span class="linenum">4943</span></a>          return <a class="var it15480" onMouseOver="hilite(15480)" onMouseOut="lolite()" onClick="logVariable('filedesc')" href="../../_variables/filedesc.html">$filedesc</a>;
<a name="l4944"><span class="linenum">4944</span></a>      }
<a name="l4945"><span class="linenum">4945</span></a>  
<a name="l4946"><span class="linenum">4946</span></a>      <span class="comment">/**</span>
<a name="l4947"><span class="linenum">4947</span></a>  <span class="comment">     * Return the expected location of a file</span>
<a name="l4948"><span class="linenum">4948</span></a>  <span class="comment">     *</span>
<a name="l4949"><span class="linenum">4949</span></a>  <span class="comment">     * Please note this may and may not work as a part of URL to pluginfile.php</span>
<a name="l4950"><span class="linenum">4950</span></a>  <span class="comment">     * (depends on how the given component/filearea deals with the itemid).</span>
<a name="l4951"><span class="linenum">4951</span></a>  <span class="comment">     *</span>
<a name="l4952"><span class="linenum">4952</span></a>  <span class="comment">     * @param stdClass $filerecord</span>
<a name="l4953"><span class="linenum">4953</span></a>  <span class="comment">     * @return string</span>
<a name="l4954"><span class="linenum">4954</span></a>  <span class="comment">     */</span>
<a name="l4955"><span class="linenum">4955</span></a>      private function <a class="function" onClick="logFunction('expected_alias_location')" href="../../_functions/expected_alias_location.html" onMouseOver="funcPopup(event,'expected_alias_location')">expected_alias_location</a>(<a class="var it833" onMouseOver="hilite(833)" onMouseOut="lolite()" onClick="logVariable('filerecord')" href="../../_variables/filerecord.html">$filerecord</a>) {
<a name="l4956"><span class="linenum">4956</span></a>  
<a name="l4957"><span class="linenum">4957</span></a>          <a class="var it15480" onMouseOver="hilite(15480)" onMouseOut="lolite()" onClick="logVariable('filedesc')" href="../../_variables/filedesc.html">$filedesc</a> = '/'.<a class="var it833" onMouseOver="hilite(833)" onMouseOut="lolite()" onClick="logVariable('filerecord')" href="../../_variables/filerecord.html">$filerecord</a>-&gt;<a onClick="logVariable('contextid')" class="var it42901" onMouseOver="hilite(42901)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a>.'/'.<a class="var it833" onMouseOver="hilite(833)" onMouseOut="lolite()" onClick="logVariable('filerecord')" href="../../_variables/filerecord.html">$filerecord</a>-&gt;<a onClick="logVariable('component')" class="var it42901" onMouseOver="hilite(42901)" onMouseOut="lolite()" href="../../_variables/component.html">component</a>.'/'.<a class="var it833" onMouseOver="hilite(833)" onMouseOut="lolite()" onClick="logVariable('filerecord')" href="../../_variables/filerecord.html">$filerecord</a>-&gt;<a onClick="logVariable('filearea')" class="var it42901" onMouseOver="hilite(42901)" onMouseOut="lolite()" href="../../_variables/filearea.html">filearea</a>;
<a name="l4958"><span class="linenum">4958</span></a>          if (!<a class="phpfunction" onClick="logFunction('is_null')" href="../../_functions/is_null.html" onMouseOver="phpfuncPopup(event,'is_null')">is_null</a>(<a class="var it833" onMouseOver="hilite(833)" onMouseOut="lolite()" onClick="logVariable('filerecord')" href="../../_variables/filerecord.html">$filerecord</a>-&gt;<a onClick="logVariable('itemid')" class="var it42901" onMouseOver="hilite(42901)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>)) {
<a name="l4959"><span class="linenum">4959</span></a>              <a class="var it15480" onMouseOver="hilite(15480)" onMouseOut="lolite()" onClick="logVariable('filedesc')" href="../../_variables/filedesc.html">$filedesc</a> .= '/'.<a class="var it833" onMouseOver="hilite(833)" onMouseOut="lolite()" onClick="logVariable('filerecord')" href="../../_variables/filerecord.html">$filerecord</a>-&gt;<a onClick="logVariable('itemid')" class="var it42901" onMouseOver="hilite(42901)" onMouseOut="lolite()" href="../../_variables/itemid.html">itemid</a>;
<a name="l4960"><span class="linenum">4960</span></a>          }
<a name="l4961"><span class="linenum">4961</span></a>          <a class="var it15480" onMouseOver="hilite(15480)" onMouseOut="lolite()" onClick="logVariable('filedesc')" href="../../_variables/filedesc.html">$filedesc</a> .= <a class="var it833" onMouseOver="hilite(833)" onMouseOut="lolite()" onClick="logVariable('filerecord')" href="../../_variables/filerecord.html">$filerecord</a>-&gt;<a onClick="logVariable('filepath')" class="var it42901" onMouseOver="hilite(42901)" onMouseOut="lolite()" href="../../_variables/filepath.html">filepath</a>.<a class="var it833" onMouseOver="hilite(833)" onMouseOut="lolite()" onClick="logVariable('filerecord')" href="../../_variables/filerecord.html">$filerecord</a>-&gt;<a onClick="logVariable('filename')" class="var it42901" onMouseOver="hilite(42901)" onMouseOut="lolite()" href="../../_variables/filename.html">filename</a>;
<a name="l4962"><span class="linenum">4962</span></a>  
<a name="l4963"><span class="linenum">4963</span></a>          return <a class="var it15480" onMouseOver="hilite(15480)" onMouseOut="lolite()" onClick="logVariable('filedesc')" href="../../_variables/filedesc.html">$filedesc</a>;
<a name="l4964"><span class="linenum">4964</span></a>      }
<a name="l4965"><span class="linenum">4965</span></a>  
<a name="l4966"><span class="linenum">4966</span></a>      <span class="comment">/**</span>
<a name="l4967"><span class="linenum">4967</span></a>  <span class="comment">     * Append a value to the given resultset</span>
<a name="l4968"><span class="linenum">4968</span></a>  <span class="comment">     *</span>
<a name="l4969"><span class="linenum">4969</span></a>  <span class="comment">     * @param string $name name of the result containing a list of values</span>
<a name="l4970"><span class="linenum">4970</span></a>  <span class="comment">     * @param mixed $value value to add as another item in that result</span>
<a name="l4971"><span class="linenum">4971</span></a>  <span class="comment">     */</span>
<a name="l4972"><span class="linenum">4972</span></a>      private function <a class="function" onClick="logFunction('add_result_item')" href="../../_functions/add_result_item.html" onMouseOver="funcPopup(event,'add_result_item')">add_result_item</a>(<a class="var it88" onMouseOver="hilite(88)" onMouseOut="lolite()" onClick="logVariable('name')" href="../../_variables/name.html">$name</a>, <a class="var it394" onMouseOver="hilite(394)" onMouseOut="lolite()" onClick="logVariable('value')" href="../../_variables/value.html">$value</a>) {
<a name="l4973"><span class="linenum">4973</span></a>  
<a name="l4974"><span class="linenum">4974</span></a>          <a class="var it4821" onMouseOver="hilite(4821)" onMouseOut="lolite()" onClick="logVariable('results')" href="../../_variables/results.html">$results</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_results')" href="../../_functions/get_results.html" onMouseOver="funcPopup(event,'get_results')">get_results</a>();
<a name="l4975"><span class="linenum">4975</span></a>  
<a name="l4976"><span class="linenum">4976</span></a>          if (isset(<a class="var it4821" onMouseOver="hilite(4821)" onMouseOut="lolite()" onClick="logVariable('results')" href="../../_variables/results.html">$results</a>[<a class="var it88" onMouseOver="hilite(88)" onMouseOut="lolite()" onClick="logVariable('name')" href="../../_variables/name.html">$name</a>])) {
<a name="l4977"><span class="linenum">4977</span></a>              if (!<a class="phpfunction" onClick="logFunction('is_array')" href="../../_functions/is_array.html" onMouseOver="phpfuncPopup(event,'is_array')">is_array</a>(<a class="var it4821" onMouseOver="hilite(4821)" onMouseOut="lolite()" onClick="logVariable('results')" href="../../_variables/results.html">$results</a>[<a class="var it88" onMouseOver="hilite(88)" onMouseOut="lolite()" onClick="logVariable('name')" href="../../_variables/name.html">$name</a>])) {
<a name="l4978"><span class="linenum">4978</span></a>                  throw <span class="keyword">new </span><a class="class" onClick="logClass('coding_exception')" href="../../_classes/coding_exception.html" onMouseOver="classPopup(event,'coding_exception')">coding_exception</a>('Unable to append a result item into a non-array structure.');
<a name="l4979"><span class="linenum">4979</span></a>              }
<a name="l4980"><span class="linenum">4980</span></a>              <a class="var it397" onMouseOver="hilite(397)" onMouseOut="lolite()" onClick="logVariable('current')" href="../../_variables/current.html">$current</a> = <a class="var it4821" onMouseOver="hilite(4821)" onMouseOut="lolite()" onClick="logVariable('results')" href="../../_variables/results.html">$results</a>[<a class="var it88" onMouseOver="hilite(88)" onMouseOut="lolite()" onClick="logVariable('name')" href="../../_variables/name.html">$name</a>];
<a name="l4981"><span class="linenum">4981</span></a>              <a class="var it397" onMouseOver="hilite(397)" onMouseOut="lolite()" onClick="logVariable('current')" href="../../_variables/current.html">$current</a>[] = <a class="var it394" onMouseOver="hilite(394)" onMouseOut="lolite()" onClick="logVariable('value')" href="../../_variables/value.html">$value</a>;
<a name="l4982"><span class="linenum">4982</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('add_result')" href="../../_functions/add_result.html" onMouseOver="funcPopup(event,'add_result')">add_result</a>(array(<a class="var it88" onMouseOver="hilite(88)" onMouseOut="lolite()" onClick="logVariable('name')" href="../../_variables/name.html">$name</a> =&gt; <a class="var it397" onMouseOver="hilite(397)" onMouseOut="lolite()" onClick="logVariable('current')" href="../../_variables/current.html">$current</a>));
<a name="l4983"><span class="linenum">4983</span></a>  
<a name="l4984"><span class="linenum">4984</span></a>          } else {
<a name="l4985"><span class="linenum">4985</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('add_result')" href="../../_functions/add_result.html" onMouseOver="funcPopup(event,'add_result')">add_result</a>(array(<a class="var it88" onMouseOver="hilite(88)" onMouseOut="lolite()" onClick="logVariable('name')" href="../../_variables/name.html">$name</a> =&gt; array(<a class="var it394" onMouseOver="hilite(394)" onMouseOut="lolite()" onClick="logVariable('value')" href="../../_variables/value.html">$value</a>)));
<a name="l4986"><span class="linenum">4986</span></a>          }
<a name="l4987"><span class="linenum">4987</span></a>      }
<a name="l4988"><span class="linenum">4988</span></a>  }
<a name="l4989"><span class="linenum">4989</span></a>  
<a name="l4990"><span class="linenum">4990</span></a>  
<a name="l4991"><span class="linenum">4991</span></a>  <span class="comment">/**</span>
<a name="l4992"><span class="linenum">4992</span></a>  <span class="comment"> * Abstract structure step, to be used by all the activities using core questions stuff</span>
<a name="l4993"><span class="linenum">4993</span></a>  <span class="comment"> * (like the quiz module), to support qtype plugins, states and sessions</span>
<a name="l4994"><span class="linenum">4994</span></a>  <span class="comment"> */</span>
<a name="l4995"><span class="linenum">4995</span></a>  abstract class restore_questions_activity_structure_step extends restore_activity_structure_step {
<a name="l4996"><span class="linenum">4996</span></a>  <span class="comment">    /** @var array question_attempt-&gt;id to qtype. */</span>
<a name="l4997"><span class="linenum">4997</span></a>      protected <a class="var it3962" onMouseOver="hilite(3962)" onMouseOut="lolite()" onClick="logVariable('qtypes')" href="../../_variables/qtypes.html">$qtypes</a> = array();
<a name="l4998"><span class="linenum">4998</span></a>  <span class="comment">    /** @var array question_attempt-&gt;id to questionid. */</span>
<a name="l4999"><span class="linenum">4999</span></a>      protected <a class="var it15481" onMouseOver="hilite(15481)" onMouseOut="lolite()" onClick="logVariable('newquestionids')" href="../../_variables/newquestionids.html">$newquestionids</a> = array();
<a name="l5000"><span class="linenum">5000</span></a>  
<a name="l5001"><span class="linenum">5001</span></a>      <span class="comment">/**</span>
<a name="l5002"><span class="linenum">5002</span></a>  <span class="comment">     * Attach below $element (usually attempts) the needed restore_path_elements</span>
<a name="l5003"><span class="linenum">5003</span></a>  <span class="comment">     * to restore question_usages and all they contain.</span>
<a name="l5004"><span class="linenum">5004</span></a>  <span class="comment">     *</span>
<a name="l5005"><span class="linenum">5005</span></a>  <span class="comment">     * If you use the $nameprefix parameter, then you will need to implement some</span>
<a name="l5006"><span class="linenum">5006</span></a>  <span class="comment">     * extra methods in your class, like</span>
<a name="l5007"><span class="linenum">5007</span></a>  <span class="comment">     *</span>
<a name="l5008"><span class="linenum">5008</span></a>  <span class="comment">     * protected function process_{nameprefix}question_attempt($data) {</span>
<a name="l5009"><span class="linenum">5009</span></a>  <span class="comment">     *     $this-&gt;restore_question_usage_worker($data, '{nameprefix}');</span>
<a name="l5010"><span class="linenum">5010</span></a>  <span class="comment">     * }</span>
<a name="l5011"><span class="linenum">5011</span></a>  <span class="comment">     * protected function process_{nameprefix}question_attempt($data) {</span>
<a name="l5012"><span class="linenum">5012</span></a>  <span class="comment">     *     $this-&gt;restore_question_attempt_worker($data, '{nameprefix}');</span>
<a name="l5013"><span class="linenum">5013</span></a>  <span class="comment">     * }</span>
<a name="l5014"><span class="linenum">5014</span></a>  <span class="comment">     * protected function process_{nameprefix}question_attempt_step($data) {</span>
<a name="l5015"><span class="linenum">5015</span></a>  <span class="comment">     *     $this-&gt;restore_question_attempt_step_worker($data, '{nameprefix}');</span>
<a name="l5016"><span class="linenum">5016</span></a>  <span class="comment">     * }</span>
<a name="l5017"><span class="linenum">5017</span></a>  <span class="comment">     *</span>
<a name="l5018"><span class="linenum">5018</span></a>  <span class="comment">     * @param restore_path_element $element the parent element that the usages are stored inside.</span>
<a name="l5019"><span class="linenum">5019</span></a>  <span class="comment">     * @param array $paths the paths array that is being built.</span>
<a name="l5020"><span class="linenum">5020</span></a>  <span class="comment">     * @param string $nameprefix should match the prefix passed to the corresponding</span>
<a name="l5021"><span class="linenum">5021</span></a>  <span class="comment">     *      backup_questions_activity_structure_step::add_question_usages call.</span>
<a name="l5022"><span class="linenum">5022</span></a>  <span class="comment">     */</span>
<a name="l5023"><span class="linenum">5023</span></a>      protected function <a class="function" onClick="logFunction('add_question_usages')" href="../../_functions/add_question_usages.html" onMouseOver="funcPopup(event,'add_question_usages')">add_question_usages</a>(<a class="var it634" onMouseOver="hilite(634)" onMouseOut="lolite()" onClick="logVariable('element')" href="../../_variables/element.html">$element</a>, &amp;<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>, <a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a> = '') {
<a name="l5024"><span class="linenum">5024</span></a>  <span class="comment">        // Check $element is restore_path_element</span>
<a name="l5025"><span class="linenum">5025</span></a>          if (! <a class="var it634" onMouseOver="hilite(634)" onMouseOut="lolite()" onClick="logVariable('element')" href="../../_variables/element.html">$element</a> instanceof restore_path_element) {
<a name="l5026"><span class="linenum">5026</span></a>              throw <span class="keyword">new </span><a class="class" onClick="logClass('restore_step_exception')" href="../../_classes/restore_step_exception.html" onMouseOver="classPopup(event,'restore_step_exception')">restore_step_exception</a>('element_must_be_restore_path_element', <a class="var it634" onMouseOver="hilite(634)" onMouseOut="lolite()" onClick="logVariable('element')" href="../../_variables/element.html">$element</a>);
<a name="l5027"><span class="linenum">5027</span></a>          }
<a name="l5028"><span class="linenum">5028</span></a>  
<a name="l5029"><span class="linenum">5029</span></a>  <span class="comment">        // Check $paths is one array</span>
<a name="l5030"><span class="linenum">5030</span></a>          if (!<a class="phpfunction" onClick="logFunction('is_array')" href="../../_functions/is_array.html" onMouseOver="phpfuncPopup(event,'is_array')">is_array</a>(<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>)) {
<a name="l5031"><span class="linenum">5031</span></a>              throw <span class="keyword">new </span><a class="class" onClick="logClass('restore_step_exception')" href="../../_classes/restore_step_exception.html" onMouseOver="classPopup(event,'restore_step_exception')">restore_step_exception</a>('paths_must_be_array', <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>);
<a name="l5032"><span class="linenum">5032</span></a>          }
<a name="l5033"><span class="linenum">5033</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>(<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a> . 'question_usage',
<a name="l5034"><span class="linenum">5034</span></a>                  <a class="var it634" onMouseOver="hilite(634)" onMouseOut="lolite()" onClick="logVariable('element')" href="../../_variables/element.html">$element</a>-&gt;<a class="function" onClick="logFunction('get_path')" href="../../_functions/get_path.html" onMouseOver="funcPopup(event,'get_path')">get_path</a>() . &quot;/{<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>}question_usage&quot;);
<a name="l5035"><span class="linenum">5035</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>(<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a> . 'question_attempt',
<a name="l5036"><span class="linenum">5036</span></a>                  <a class="var it634" onMouseOver="hilite(634)" onMouseOut="lolite()" onClick="logVariable('element')" href="../../_variables/element.html">$element</a>-&gt;<a class="function" onClick="logFunction('get_path')" href="../../_functions/get_path.html" onMouseOver="funcPopup(event,'get_path')">get_path</a>() . &quot;/{<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>}question_usage/{<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>}question_attempts/{<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>}question_attempt&quot;);
<a name="l5037"><span class="linenum">5037</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>(<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a> . 'question_attempt_step',
<a name="l5038"><span class="linenum">5038</span></a>                  <a class="var it634" onMouseOver="hilite(634)" onMouseOut="lolite()" onClick="logVariable('element')" href="../../_variables/element.html">$element</a>-&gt;<a class="function" onClick="logFunction('get_path')" href="../../_functions/get_path.html" onMouseOver="funcPopup(event,'get_path')">get_path</a>() . &quot;/{<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>}question_usage/{<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>}question_attempts/{<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>}question_attempt/{<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>}steps/{<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>}step&quot;,
<a name="l5039"><span class="linenum">5039</span></a>                  true);
<a name="l5040"><span class="linenum">5040</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>(<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a> . 'question_attempt_step_data',
<a name="l5041"><span class="linenum">5041</span></a>                  <a class="var it634" onMouseOver="hilite(634)" onMouseOut="lolite()" onClick="logVariable('element')" href="../../_variables/element.html">$element</a>-&gt;<a class="function" onClick="logFunction('get_path')" href="../../_functions/get_path.html" onMouseOver="funcPopup(event,'get_path')">get_path</a>() . &quot;/{<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>}question_usage/{<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>}question_attempts/{<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>}question_attempt/{<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>}steps/{<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>}step/{<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>}response/{<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>}variable&quot;);
<a name="l5042"><span class="linenum">5042</span></a>      }
<a name="l5043"><span class="linenum">5043</span></a>  
<a name="l5044"><span class="linenum">5044</span></a>      <span class="comment">/**</span>
<a name="l5045"><span class="linenum">5045</span></a>  <span class="comment">     * Process question_usages</span>
<a name="l5046"><span class="linenum">5046</span></a>  <span class="comment">     */</span>
<a name="l5047"><span class="linenum">5047</span></a>      protected function <a class="function" onClick="logFunction('process_question_usage')" href="../../_functions/process_question_usage.html" onMouseOver="funcPopup(event,'process_question_usage')">process_question_usage</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l5048"><span class="linenum">5048</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('restore_question_usage_worker')" href="../../_functions/restore_question_usage_worker.html" onMouseOver="funcPopup(event,'restore_question_usage_worker')">restore_question_usage_worker</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, '');
<a name="l5049"><span class="linenum">5049</span></a>      }
<a name="l5050"><span class="linenum">5050</span></a>  
<a name="l5051"><span class="linenum">5051</span></a>      <span class="comment">/**</span>
<a name="l5052"><span class="linenum">5052</span></a>  <span class="comment">     * Process question_attempts</span>
<a name="l5053"><span class="linenum">5053</span></a>  <span class="comment">     */</span>
<a name="l5054"><span class="linenum">5054</span></a>      protected function <a class="function" onClick="logFunction('process_question_attempt')" href="../../_functions/process_question_attempt.html" onMouseOver="funcPopup(event,'process_question_attempt')">process_question_attempt</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l5055"><span class="linenum">5055</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('restore_question_attempt_worker')" href="../../_functions/restore_question_attempt_worker.html" onMouseOver="funcPopup(event,'restore_question_attempt_worker')">restore_question_attempt_worker</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, '');
<a name="l5056"><span class="linenum">5056</span></a>      }
<a name="l5057"><span class="linenum">5057</span></a>  
<a name="l5058"><span class="linenum">5058</span></a>      <span class="comment">/**</span>
<a name="l5059"><span class="linenum">5059</span></a>  <span class="comment">     * Process question_attempt_steps</span>
<a name="l5060"><span class="linenum">5060</span></a>  <span class="comment">     */</span>
<a name="l5061"><span class="linenum">5061</span></a>      protected function <a class="function" onClick="logFunction('process_question_attempt_step')" href="../../_functions/process_question_attempt_step.html" onMouseOver="funcPopup(event,'process_question_attempt_step')">process_question_attempt_step</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>) {
<a name="l5062"><span class="linenum">5062</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('restore_question_attempt_step_worker')" href="../../_functions/restore_question_attempt_step_worker.html" onMouseOver="funcPopup(event,'restore_question_attempt_step_worker')">restore_question_attempt_step_worker</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, '');
<a name="l5063"><span class="linenum">5063</span></a>      }
<a name="l5064"><span class="linenum">5064</span></a>  
<a name="l5065"><span class="linenum">5065</span></a>      <span class="comment">/**</span>
<a name="l5066"><span class="linenum">5066</span></a>  <span class="comment">     * This method does the acutal work for process_question_usage or</span>
<a name="l5067"><span class="linenum">5067</span></a>  <span class="comment">     * process_{nameprefix}_question_usage.</span>
<a name="l5068"><span class="linenum">5068</span></a>  <span class="comment">     * @param array $data the data from the XML file.</span>
<a name="l5069"><span class="linenum">5069</span></a>  <span class="comment">     * @param string $nameprefix the element name prefix.</span>
<a name="l5070"><span class="linenum">5070</span></a>  <span class="comment">     */</span>
<a name="l5071"><span class="linenum">5071</span></a>      protected function <a class="function" onClick="logFunction('restore_question_usage_worker')" href="../../_functions/restore_question_usage_worker.html" onMouseOver="funcPopup(event,'restore_question_usage_worker')">restore_question_usage_worker</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, <a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>) {
<a name="l5072"><span class="linenum">5072</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l5073"><span class="linenum">5073</span></a>  
<a name="l5074"><span class="linenum">5074</span></a>  <span class="comment">        // Clear our caches.</span>
<a name="l5075"><span class="linenum">5075</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('qtypes')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/qtypes.html">qtypes</a> = array();
<a name="l5076"><span class="linenum">5076</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('newquestionids')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/newquestionids.html">newquestionids</a> = array();
<a name="l5077"><span class="linenum">5077</span></a>  
<a name="l5078"><span class="linenum">5078</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l5079"><span class="linenum">5079</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l5080"><span class="linenum">5080</span></a>  
<a name="l5081"><span class="linenum">5081</span></a>          <a class="var it5968" onMouseOver="hilite(5968)" onMouseOut="lolite()" onClick="logVariable('oldcontextid')" href="../../_variables/oldcontextid.html">$oldcontextid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_task')" href="../../_functions/get_task.html" onMouseOver="funcPopup(event,'get_task')">get_task</a>()-&gt;<a class="function" onClick="logFunction('get_old_contextid')" href="../../_functions/get_old_contextid.html" onMouseOver="funcPopup(event,'get_old_contextid')">get_old_contextid</a>();
<a name="l5082"><span class="linenum">5082</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('contextid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a>  = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('context', <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_old_contextid')" href="../../_functions/get_old_contextid.html" onMouseOver="funcPopup(event,'get_old_contextid')">get_old_contextid</a>());
<a name="l5083"><span class="linenum">5083</span></a>  
<a name="l5084"><span class="linenum">5084</span></a>  <span class="comment">        // Everything ready, insert (no mapping needed)</span>
<a name="l5085"><span class="linenum">5085</span></a>          <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('question_usages', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l5086"><span class="linenum">5086</span></a>  
<a name="l5087"><span class="linenum">5087</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('inform_new_usage_id')" href="../../_functions/inform_new_usage_id.html" onMouseOver="funcPopup(event,'inform_new_usage_id')">inform_new_usage_id</a>(<a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>);
<a name="l5088"><span class="linenum">5088</span></a>  
<a name="l5089"><span class="linenum">5089</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>(<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a> . 'question_usage', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>, false);
<a name="l5090"><span class="linenum">5090</span></a>      }
<a name="l5091"><span class="linenum">5091</span></a>  
<a name="l5092"><span class="linenum">5092</span></a>      <span class="comment">/**</span>
<a name="l5093"><span class="linenum">5093</span></a>  <span class="comment">     * When process_question_usage creates the new usage, it calls this method</span>
<a name="l5094"><span class="linenum">5094</span></a>  <span class="comment">     * to let the activity link to the new usage. For example, the quiz uses</span>
<a name="l5095"><span class="linenum">5095</span></a>  <span class="comment">     * this method to set quiz_attempts.uniqueid to the new usage id.</span>
<a name="l5096"><span class="linenum">5096</span></a>  <span class="comment">     * @param integer $newusageid</span>
<a name="l5097"><span class="linenum">5097</span></a>  <span class="comment">     */</span>
<a name="l5098"><span class="linenum">5098</span></a>      abstract protected function <a class="function" onClick="logFunction('inform_new_usage_id')" href="../../_functions/inform_new_usage_id.html" onMouseOver="funcPopup(event,'inform_new_usage_id')">inform_new_usage_id</a>(<a class="var it15483" onMouseOver="hilite(15483)" onMouseOut="lolite()" onClick="logVariable('newusageid')" href="../../_variables/newusageid.html">$newusageid</a>);
<a name="l5099"><span class="linenum">5099</span></a>  
<a name="l5100"><span class="linenum">5100</span></a>      <span class="comment">/**</span>
<a name="l5101"><span class="linenum">5101</span></a>  <span class="comment">     * This method does the acutal work for process_question_attempt or</span>
<a name="l5102"><span class="linenum">5102</span></a>  <span class="comment">     * process_{nameprefix}_question_attempt.</span>
<a name="l5103"><span class="linenum">5103</span></a>  <span class="comment">     * @param array $data the data from the XML file.</span>
<a name="l5104"><span class="linenum">5104</span></a>  <span class="comment">     * @param string $nameprefix the element name prefix.</span>
<a name="l5105"><span class="linenum">5105</span></a>  <span class="comment">     */</span>
<a name="l5106"><span class="linenum">5106</span></a>      protected function <a class="function" onClick="logFunction('restore_question_attempt_worker')" href="../../_functions/restore_question_attempt_worker.html" onMouseOver="funcPopup(event,'restore_question_attempt_worker')">restore_question_attempt_worker</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, <a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>) {
<a name="l5107"><span class="linenum">5107</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l5108"><span class="linenum">5108</span></a>  
<a name="l5109"><span class="linenum">5109</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l5110"><span class="linenum">5110</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l5111"><span class="linenum">5111</span></a>          <a class="var it259" onMouseOver="hilite(259)" onMouseOut="lolite()" onClick="logVariable('question')" href="../../_variables/question.html">$question</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mapping')" href="../../_functions/get_mapping.html" onMouseOver="funcPopup(event,'get_mapping')">get_mapping</a>('question', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('questionid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/questionid.html">questionid</a>);
<a name="l5112"><span class="linenum">5112</span></a>  
<a name="l5113"><span class="linenum">5113</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('questionusageid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/questionusageid.html">questionusageid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_new_parentid')" href="../../_functions/get_new_parentid.html" onMouseOver="funcPopup(event,'get_new_parentid')">get_new_parentid</a>(<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a> . 'question_usage');
<a name="l5114"><span class="linenum">5114</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('questionid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/questionid.html">questionid</a>      = <a class="var it259" onMouseOver="hilite(259)" onMouseOut="lolite()" onClick="logVariable('question')" href="../../_variables/question.html">$question</a>-&gt;<a onClick="logVariable('newitemid')" class="var it43018" onMouseOver="hilite(43018)" onMouseOut="lolite()" href="../../_variables/newitemid.html">newitemid</a>;
<a name="l5115"><span class="linenum">5115</span></a>          if (!property_exists(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, 'variant')) {
<a name="l5116"><span class="linenum">5116</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('variant')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/variant.html">variant</a> = 1;
<a name="l5117"><span class="linenum">5117</span></a>          }
<a name="l5118"><span class="linenum">5118</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timemodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timemodified.html">timemodified</a>    = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timemodified')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timemodified.html">timemodified</a>);
<a name="l5119"><span class="linenum">5119</span></a>  
<a name="l5120"><span class="linenum">5120</span></a>          if (!property_exists(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, 'maxfraction')) {
<a name="l5121"><span class="linenum">5121</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('maxfraction')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/maxfraction.html">maxfraction</a> = 1;
<a name="l5122"><span class="linenum">5122</span></a>          }
<a name="l5123"><span class="linenum">5123</span></a>  
<a name="l5124"><span class="linenum">5124</span></a>          <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('question_attempts', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l5125"><span class="linenum">5125</span></a>  
<a name="l5126"><span class="linenum">5126</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>(<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a> . 'question_attempt', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>);
<a name="l5127"><span class="linenum">5127</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('qtypes')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/qtypes.html">qtypes</a>[<a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>] = <a class="var it259" onMouseOver="hilite(259)" onMouseOut="lolite()" onClick="logVariable('question')" href="../../_variables/question.html">$question</a>-&gt;<a onClick="logVariable('info')" class="var it43018" onMouseOver="hilite(43018)" onMouseOut="lolite()" href="../../_variables/info.html">info</a>-&gt;qtype;
<a name="l5128"><span class="linenum">5128</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('newquestionids')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/newquestionids.html">newquestionids</a>[<a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>] = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('questionid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/questionid.html">questionid</a>;
<a name="l5129"><span class="linenum">5129</span></a>      }
<a name="l5130"><span class="linenum">5130</span></a>  
<a name="l5131"><span class="linenum">5131</span></a>      <span class="comment">/**</span>
<a name="l5132"><span class="linenum">5132</span></a>  <span class="comment">     * This method does the acutal work for process_question_attempt_step or</span>
<a name="l5133"><span class="linenum">5133</span></a>  <span class="comment">     * process_{nameprefix}_question_attempt_step.</span>
<a name="l5134"><span class="linenum">5134</span></a>  <span class="comment">     * @param array $data the data from the XML file.</span>
<a name="l5135"><span class="linenum">5135</span></a>  <span class="comment">     * @param string $nameprefix the element name prefix.</span>
<a name="l5136"><span class="linenum">5136</span></a>  <span class="comment">     */</span>
<a name="l5137"><span class="linenum">5137</span></a>      protected function <a class="function" onClick="logFunction('restore_question_attempt_step_worker')" href="../../_functions/restore_question_attempt_step_worker.html" onMouseOver="funcPopup(event,'restore_question_attempt_step_worker')">restore_question_attempt_step_worker</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, <a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a>) {
<a name="l5138"><span class="linenum">5138</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l5139"><span class="linenum">5139</span></a>  
<a name="l5140"><span class="linenum">5140</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l5141"><span class="linenum">5141</span></a>          <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a> = <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('id')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l5142"><span class="linenum">5142</span></a>  
<a name="l5143"><span class="linenum">5143</span></a>  <span class="comment">        // Pull out the response data.</span>
<a name="l5144"><span class="linenum">5144</span></a>          <a class="var it187" onMouseOver="hilite(187)" onMouseOut="lolite()" onClick="logVariable('response')" href="../../_variables/response.html">$response</a> = array();
<a name="l5145"><span class="linenum">5145</span></a>          if (!empty(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;{<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a> . 'response'}[<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a> . 'variable'])) {
<a name="l5146"><span class="linenum">5146</span></a>              foreach (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;{<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a> . 'response'}[<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a> . 'variable'] as <a class="var it3332" onMouseOver="hilite(3332)" onMouseOut="lolite()" onClick="logVariable('variable')" href="../../_variables/variable.html">$variable</a>) {
<a name="l5147"><span class="linenum">5147</span></a>                  <a class="var it187" onMouseOver="hilite(187)" onMouseOut="lolite()" onClick="logVariable('response')" href="../../_variables/response.html">$response</a>[<a class="var it3332" onMouseOver="hilite(3332)" onMouseOut="lolite()" onClick="logVariable('variable')" href="../../_variables/variable.html">$variable</a>['name']] = <a class="var it3332" onMouseOver="hilite(3332)" onMouseOut="lolite()" onClick="logVariable('variable')" href="../../_variables/variable.html">$variable</a>['value'];
<a name="l5148"><span class="linenum">5148</span></a>              }
<a name="l5149"><span class="linenum">5149</span></a>          }
<a name="l5150"><span class="linenum">5150</span></a>          unset(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('response')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/response.html">response</a>);
<a name="l5151"><span class="linenum">5151</span></a>  
<a name="l5152"><span class="linenum">5152</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('questionattemptid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/questionattemptid.html">questionattemptid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_new_parentid')" href="../../_functions/get_new_parentid.html" onMouseOver="funcPopup(event,'get_new_parentid')">get_new_parentid</a>(<a class="var it15482" onMouseOver="hilite(15482)" onMouseOut="lolite()" onClick="logVariable('nameprefix')" href="../../_variables/nameprefix.html">$nameprefix</a> . 'question_attempt');
<a name="l5153"><span class="linenum">5153</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timecreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timecreated.html">timecreated</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('apply_date_offset')" href="../../_functions/apply_date_offset.html" onMouseOver="funcPopup(event,'apply_date_offset')">apply_date_offset</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('timecreated')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/timecreated.html">timecreated</a>);
<a name="l5154"><span class="linenum">5154</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>      = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('user', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('userid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/userid.html">userid</a>);
<a name="l5155"><span class="linenum">5155</span></a>  
<a name="l5156"><span class="linenum">5156</span></a>  <span class="comment">        // Everything ready, insert and create mapping (needed by question_sessions)</span>
<a name="l5157"><span class="linenum">5157</span></a>          <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('question_attempt_steps', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>);
<a name="l5158"><span class="linenum">5158</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('set_mapping')" href="../../_functions/set_mapping.html" onMouseOver="funcPopup(event,'set_mapping')">set_mapping</a>('question_attempt_step', <a class="var it6" onMouseOver="hilite(6)" onMouseOut="lolite()" onClick="logVariable('oldid')" href="../../_variables/oldid.html">$oldid</a>, <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>, true);
<a name="l5159"><span class="linenum">5159</span></a>  
<a name="l5160"><span class="linenum">5160</span></a>  <span class="comment">        // Now process the response data.</span>
<a name="l5161"><span class="linenum">5161</span></a>          <a class="var it187" onMouseOver="hilite(187)" onMouseOut="lolite()" onClick="logVariable('response')" href="../../_variables/response.html">$response</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('questions_recode_response_data')" href="../../_functions/questions_recode_response_data.html" onMouseOver="funcPopup(event,'questions_recode_response_data')">questions_recode_response_data</a>(
<a name="l5162"><span class="linenum">5162</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('qtypes')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/qtypes.html">qtypes</a>[<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('questionattemptid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/questionattemptid.html">questionattemptid</a>],
<a name="l5163"><span class="linenum">5163</span></a>                  <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('newquestionids')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/newquestionids.html">newquestionids</a>[<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('questionattemptid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/questionattemptid.html">questionattemptid</a>],
<a name="l5164"><span class="linenum">5164</span></a>                  <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('sequencenumber')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/sequencenumber.html">sequencenumber</a>, <a class="var it187" onMouseOver="hilite(187)" onMouseOut="lolite()" onClick="logVariable('response')" href="../../_variables/response.html">$response</a>);
<a name="l5165"><span class="linenum">5165</span></a>  
<a name="l5166"><span class="linenum">5166</span></a>          foreach (<a class="var it187" onMouseOver="hilite(187)" onMouseOut="lolite()" onClick="logVariable('response')" href="../../_variables/response.html">$response</a> as <a class="var it88" onMouseOver="hilite(88)" onMouseOut="lolite()" onClick="logVariable('name')" href="../../_variables/name.html">$name</a> =&gt; <a class="var it394" onMouseOver="hilite(394)" onMouseOut="lolite()" onClick="logVariable('value')" href="../../_variables/value.html">$value</a>) {
<a name="l5167"><span class="linenum">5167</span></a>              <a class="var it57" onMouseOver="hilite(57)" onMouseOut="lolite()" onClick="logVariable('row')" href="../../_variables/row.html">$row</a> = new stdClass();
<a name="l5168"><span class="linenum">5168</span></a>              <a class="var it57" onMouseOver="hilite(57)" onMouseOut="lolite()" onClick="logVariable('row')" href="../../_variables/row.html">$row</a>-&gt;<a onClick="logVariable('attemptstepid')" class="var it42924" onMouseOver="hilite(42924)" onMouseOut="lolite()" href="../../_variables/attemptstepid.html">attemptstepid</a> = <a class="var it11" onMouseOver="hilite(11)" onMouseOut="lolite()" onClick="logVariable('newitemid')" href="../../_variables/newitemid.html">$newitemid</a>;
<a name="l5169"><span class="linenum">5169</span></a>              <a class="var it57" onMouseOver="hilite(57)" onMouseOut="lolite()" onClick="logVariable('row')" href="../../_variables/row.html">$row</a>-&gt;<a onClick="logVariable('name')" class="var it42924" onMouseOver="hilite(42924)" onMouseOut="lolite()" href="../../_variables/name.html">name</a> = <a class="var it88" onMouseOver="hilite(88)" onMouseOut="lolite()" onClick="logVariable('name')" href="../../_variables/name.html">$name</a>;
<a name="l5170"><span class="linenum">5170</span></a>              <a class="var it57" onMouseOver="hilite(57)" onMouseOut="lolite()" onClick="logVariable('row')" href="../../_variables/row.html">$row</a>-&gt;<a onClick="logVariable('value')" class="var it42924" onMouseOver="hilite(42924)" onMouseOut="lolite()" href="../../_variables/value.html">value</a> = <a class="var it394" onMouseOver="hilite(394)" onMouseOut="lolite()" onClick="logVariable('value')" href="../../_variables/value.html">$value</a>;
<a name="l5171"><span class="linenum">5171</span></a>              <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('question_attempt_step_data', <a class="var it57" onMouseOver="hilite(57)" onMouseOut="lolite()" onClick="logVariable('row')" href="../../_variables/row.html">$row</a>, false);
<a name="l5172"><span class="linenum">5172</span></a>          }
<a name="l5173"><span class="linenum">5173</span></a>      }
<a name="l5174"><span class="linenum">5174</span></a>  
<a name="l5175"><span class="linenum">5175</span></a>      <span class="comment">/**</span>
<a name="l5176"><span class="linenum">5176</span></a>  <span class="comment">     * Recode the respones data for a particular step of an attempt at at particular question.</span>
<a name="l5177"><span class="linenum">5177</span></a>  <span class="comment">     * @param string $qtype the question type.</span>
<a name="l5178"><span class="linenum">5178</span></a>  <span class="comment">     * @param int $newquestionid the question id.</span>
<a name="l5179"><span class="linenum">5179</span></a>  <span class="comment">     * @param int $sequencenumber the sequence number.</span>
<a name="l5180"><span class="linenum">5180</span></a>  <span class="comment">     * @param array $response the response data to recode.</span>
<a name="l5181"><span class="linenum">5181</span></a>  <span class="comment">     */</span>
<a name="l5182"><span class="linenum">5182</span></a>      public function <a class="function" onClick="logFunction('questions_recode_response_data')" href="../../_functions/questions_recode_response_data.html" onMouseOver="funcPopup(event,'questions_recode_response_data')">questions_recode_response_data</a>(
<a name="l5183"><span class="linenum">5183</span></a>              <a class="var it260" onMouseOver="hilite(260)" onMouseOut="lolite()" onClick="logVariable('qtype')" href="../../_variables/qtype.html">$qtype</a>, <a class="var it8594" onMouseOver="hilite(8594)" onMouseOut="lolite()" onClick="logVariable('newquestionid')" href="../../_variables/newquestionid.html">$newquestionid</a>, <a class="var it9203" onMouseOver="hilite(9203)" onMouseOut="lolite()" onClick="logVariable('sequencenumber')" href="../../_variables/sequencenumber.html">$sequencenumber</a>, array <a class="var it187" onMouseOver="hilite(187)" onMouseOut="lolite()" onClick="logVariable('response')" href="../../_variables/response.html">$response</a>) {
<a name="l5184"><span class="linenum">5184</span></a>          <a class="var it15484" onMouseOver="hilite(15484)" onMouseOut="lolite()" onClick="logVariable('qtyperestorer')" href="../../_variables/qtyperestorer.html">$qtyperestorer</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_qtype_restorer')" href="../../_functions/get_qtype_restorer.html" onMouseOver="funcPopup(event,'get_qtype_restorer')">get_qtype_restorer</a>(<a class="var it260" onMouseOver="hilite(260)" onMouseOut="lolite()" onClick="logVariable('qtype')" href="../../_variables/qtype.html">$qtype</a>);
<a name="l5185"><span class="linenum">5185</span></a>          if (<a class="var it15484" onMouseOver="hilite(15484)" onMouseOut="lolite()" onClick="logVariable('qtyperestorer')" href="../../_variables/qtyperestorer.html">$qtyperestorer</a>) {
<a name="l5186"><span class="linenum">5186</span></a>              <a class="var it187" onMouseOver="hilite(187)" onMouseOut="lolite()" onClick="logVariable('response')" href="../../_variables/response.html">$response</a> = <a class="var it15484" onMouseOver="hilite(15484)" onMouseOut="lolite()" onClick="logVariable('qtyperestorer')" href="../../_variables/qtyperestorer.html">$qtyperestorer</a>-&gt;<a class="function" onClick="logFunction('recode_response')" href="../../_functions/recode_response.html" onMouseOver="funcPopup(event,'recode_response')">recode_response</a>(<a class="var it8594" onMouseOver="hilite(8594)" onMouseOut="lolite()" onClick="logVariable('newquestionid')" href="../../_variables/newquestionid.html">$newquestionid</a>, <a class="var it9203" onMouseOver="hilite(9203)" onMouseOut="lolite()" onClick="logVariable('sequencenumber')" href="../../_variables/sequencenumber.html">$sequencenumber</a>, <a class="var it187" onMouseOver="hilite(187)" onMouseOut="lolite()" onClick="logVariable('response')" href="../../_variables/response.html">$response</a>);
<a name="l5187"><span class="linenum">5187</span></a>          }
<a name="l5188"><span class="linenum">5188</span></a>          return <a class="var it187" onMouseOver="hilite(187)" onMouseOut="lolite()" onClick="logVariable('response')" href="../../_variables/response.html">$response</a>;
<a name="l5189"><span class="linenum">5189</span></a>      }
<a name="l5190"><span class="linenum">5190</span></a>  
<a name="l5191"><span class="linenum">5191</span></a>      <span class="comment">/**</span>
<a name="l5192"><span class="linenum">5192</span></a>  <span class="comment">     * Given a list of question-&gt;ids, separated by commas, returns the</span>
<a name="l5193"><span class="linenum">5193</span></a>  <span class="comment">     * recoded list, with all the restore question mappings applied.</span>
<a name="l5194"><span class="linenum">5194</span></a>  <span class="comment">     * Note: Used by quiz-&gt;questions and quiz_attempts-&gt;layout</span>
<a name="l5195"><span class="linenum">5195</span></a>  <span class="comment">     * Note: 0 = page break (unconverted)</span>
<a name="l5196"><span class="linenum">5196</span></a>  <span class="comment">     */</span>
<a name="l5197"><span class="linenum">5197</span></a>      protected function <a class="function" onClick="logFunction('questions_recode_layout')" href="../../_functions/questions_recode_layout.html" onMouseOver="funcPopup(event,'questions_recode_layout')">questions_recode_layout</a>(<a class="var it459" onMouseOver="hilite(459)" onMouseOut="lolite()" onClick="logVariable('layout')" href="../../_variables/layout.html">$layout</a>) {
<a name="l5198"><span class="linenum">5198</span></a>  <span class="comment">        // Extracts question id from sequence</span>
<a name="l5199"><span class="linenum">5199</span></a>          if (<a class="var it5865" onMouseOver="hilite(5865)" onMouseOut="lolite()" onClick="logVariable('questionids')" href="../../_variables/questionids.html">$questionids</a> = <a class="phpfunction" onClick="logFunction('explode')" href="../../_functions/explode.html" onMouseOver="phpfuncPopup(event,'explode')">explode</a>(',', <a class="var it459" onMouseOver="hilite(459)" onMouseOut="lolite()" onClick="logVariable('layout')" href="../../_variables/layout.html">$layout</a>)) {
<a name="l5200"><span class="linenum">5200</span></a>              foreach (<a class="var it5865" onMouseOver="hilite(5865)" onMouseOut="lolite()" onClick="logVariable('questionids')" href="../../_variables/questionids.html">$questionids</a> as <a class="var it7" onMouseOver="hilite(7)" onMouseOut="lolite()" onClick="logVariable('id')" href="../../_variables/id.html">$id</a> =&gt; <a class="var it530" onMouseOver="hilite(530)" onMouseOut="lolite()" onClick="logVariable('questionid')" href="../../_variables/questionid.html">$questionid</a>) {
<a name="l5201"><span class="linenum">5201</span></a>                  if (<a class="var it530" onMouseOver="hilite(530)" onMouseOut="lolite()" onClick="logVariable('questionid')" href="../../_variables/questionid.html">$questionid</a>) { // If it is zero then this is a pagebreak, don't translate
<a name="l5202"><span class="linenum">5202</span></a>                      <a class="var it8594" onMouseOver="hilite(8594)" onMouseOut="lolite()" onClick="logVariable('newquestionid')" href="../../_variables/newquestionid.html">$newquestionid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('question', <a class="var it530" onMouseOver="hilite(530)" onMouseOut="lolite()" onClick="logVariable('questionid')" href="../../_variables/questionid.html">$questionid</a>);
<a name="l5203"><span class="linenum">5203</span></a>                      <a class="var it5865" onMouseOver="hilite(5865)" onMouseOut="lolite()" onClick="logVariable('questionids')" href="../../_variables/questionids.html">$questionids</a>[<a class="var it7" onMouseOver="hilite(7)" onMouseOut="lolite()" onClick="logVariable('id')" href="../../_variables/id.html">$id</a>] = <a class="var it8594" onMouseOver="hilite(8594)" onMouseOut="lolite()" onClick="logVariable('newquestionid')" href="../../_variables/newquestionid.html">$newquestionid</a>;
<a name="l5204"><span class="linenum">5204</span></a>                  }
<a name="l5205"><span class="linenum">5205</span></a>              }
<a name="l5206"><span class="linenum">5206</span></a>          }
<a name="l5207"><span class="linenum">5207</span></a>          return <a class="phpfunction" onClick="logFunction('implode')" href="../../_functions/implode.html" onMouseOver="phpfuncPopup(event,'implode')">implode</a>(',', <a class="var it5865" onMouseOver="hilite(5865)" onMouseOut="lolite()" onClick="logVariable('questionids')" href="../../_variables/questionids.html">$questionids</a>);
<a name="l5208"><span class="linenum">5208</span></a>      }
<a name="l5209"><span class="linenum">5209</span></a>  
<a name="l5210"><span class="linenum">5210</span></a>      <span class="comment">/**</span>
<a name="l5211"><span class="linenum">5211</span></a>  <span class="comment">     * Get the restore_qtype_plugin subclass for a specific question type.</span>
<a name="l5212"><span class="linenum">5212</span></a>  <span class="comment">     * @param string $qtype e.g. multichoice.</span>
<a name="l5213"><span class="linenum">5213</span></a>  <span class="comment">     * @return restore_qtype_plugin instance.</span>
<a name="l5214"><span class="linenum">5214</span></a>  <span class="comment">     */</span>
<a name="l5215"><span class="linenum">5215</span></a>      protected function <a class="function" onClick="logFunction('get_qtype_restorer')" href="../../_functions/get_qtype_restorer.html" onMouseOver="funcPopup(event,'get_qtype_restorer')">get_qtype_restorer</a>(<a class="var it260" onMouseOver="hilite(260)" onMouseOut="lolite()" onClick="logVariable('qtype')" href="../../_variables/qtype.html">$qtype</a>) {
<a name="l5216"><span class="linenum">5216</span></a>  <span class="comment">        // Build one static cache to store {@link restore_qtype_plugin}</span>
<a name="l5217"><span class="linenum">5217</span></a>  <span class="comment">        // while we are needing them, just to save zillions of instantiations</span>
<a name="l5218"><span class="linenum">5218</span></a>  <span class="comment">        // or using static stuff that will break our nice API</span>
<a name="l5219"><span class="linenum">5219</span></a>          static <a class="var it15485" onMouseOver="hilite(15485)" onMouseOut="lolite()" onClick="logVariable('qtypeplugins')" href="../../_variables/qtypeplugins.html">$qtypeplugins</a> = array();
<a name="l5220"><span class="linenum">5220</span></a>  
<a name="l5221"><span class="linenum">5221</span></a>          if (!isset(<a class="var it15485" onMouseOver="hilite(15485)" onMouseOut="lolite()" onClick="logVariable('qtypeplugins')" href="../../_variables/qtypeplugins.html">$qtypeplugins</a>[<a class="var it260" onMouseOver="hilite(260)" onMouseOut="lolite()" onClick="logVariable('qtype')" href="../../_variables/qtype.html">$qtype</a>])) {
<a name="l5222"><span class="linenum">5222</span></a>              <a class="var it202" onMouseOver="hilite(202)" onMouseOut="lolite()" onClick="logVariable('classname')" href="../../_variables/classname.html">$classname</a> = 'restore_qtype_' . <a class="var it260" onMouseOver="hilite(260)" onMouseOut="lolite()" onClick="logVariable('qtype')" href="../../_variables/qtype.html">$qtype</a> . '_plugin';
<a name="l5223"><span class="linenum">5223</span></a>              if (<a class="phpfunction" onClick="logFunction('class_exists')" href="../../_functions/class_exists.html" onMouseOver="phpfuncPopup(event,'class_exists')">class_exists</a>(<a class="var it202" onMouseOver="hilite(202)" onMouseOut="lolite()" onClick="logVariable('classname')" href="../../_variables/classname.html">$classname</a>)) {
<a name="l5224"><span class="linenum">5224</span></a>                  <a class="var it15485" onMouseOver="hilite(15485)" onMouseOut="lolite()" onClick="logVariable('qtypeplugins')" href="../../_variables/qtypeplugins.html">$qtypeplugins</a>[<a class="var it260" onMouseOver="hilite(260)" onMouseOut="lolite()" onClick="logVariable('qtype')" href="../../_variables/qtype.html">$qtype</a>] = new <a class="var it202" onMouseOver="hilite(202)" onMouseOut="lolite()" onClick="logVariable('classname')" href="../../_variables/classname.html">$classname</a>('qtype', <a class="var it260" onMouseOver="hilite(260)" onMouseOut="lolite()" onClick="logVariable('qtype')" href="../../_variables/qtype.html">$qtype</a>, <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>);
<a name="l5225"><span class="linenum">5225</span></a>              } else {
<a name="l5226"><span class="linenum">5226</span></a>                  <a class="var it15485" onMouseOver="hilite(15485)" onMouseOut="lolite()" onClick="logVariable('qtypeplugins')" href="../../_variables/qtypeplugins.html">$qtypeplugins</a>[<a class="var it260" onMouseOver="hilite(260)" onMouseOut="lolite()" onClick="logVariable('qtype')" href="../../_variables/qtype.html">$qtype</a>] = null;
<a name="l5227"><span class="linenum">5227</span></a>              }
<a name="l5228"><span class="linenum">5228</span></a>          }
<a name="l5229"><span class="linenum">5229</span></a>          return <a class="var it15485" onMouseOver="hilite(15485)" onMouseOut="lolite()" onClick="logVariable('qtypeplugins')" href="../../_variables/qtypeplugins.html">$qtypeplugins</a>[<a class="var it260" onMouseOver="hilite(260)" onMouseOut="lolite()" onClick="logVariable('qtype')" href="../../_variables/qtype.html">$qtype</a>];
<a name="l5230"><span class="linenum">5230</span></a>      }
<a name="l5231"><span class="linenum">5231</span></a>  
<a name="l5232"><span class="linenum">5232</span></a>      protected function <a class="function" onClick="logFunction('after_execute')" href="../../_functions/after_execute.html" onMouseOver="funcPopup(event,'after_execute')">after_execute</a>() {
<a name="l5233"><span class="linenum">5233</span></a>          parent::<a class="function" onClick="logFunction('after_execute')" href="../../_functions/after_execute.html" onMouseOver="funcPopup(event,'after_execute')">after_execute</a>();
<a name="l5234"><span class="linenum">5234</span></a>  
<a name="l5235"><span class="linenum">5235</span></a>  <span class="comment">        // Restore any files belonging to responses.</span>
<a name="l5236"><span class="linenum">5236</span></a>          foreach (question_engine::<a class="function" onClick="logFunction('get_all_response_file_areas')" href="../../_functions/get_all_response_file_areas.html" onMouseOver="funcPopup(event,'get_all_response_file_areas')">get_all_response_file_areas</a>() as <a class="var it24" onMouseOver="hilite(24)" onMouseOut="lolite()" onClick="logVariable('filearea')" href="../../_variables/filearea.html">$filearea</a>) {
<a name="l5237"><span class="linenum">5237</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('add_related_files')" href="../../_functions/add_related_files.html" onMouseOver="funcPopup(event,'add_related_files')">add_related_files</a>('question', <a class="var it24" onMouseOver="hilite(24)" onMouseOut="lolite()" onClick="logVariable('filearea')" href="../../_variables/filearea.html">$filearea</a>, 'question_attempt_step');
<a name="l5238"><span class="linenum">5238</span></a>          }
<a name="l5239"><span class="linenum">5239</span></a>      }
<a name="l5240"><span class="linenum">5240</span></a>  
<a name="l5241"><span class="linenum">5241</span></a>      <span class="comment">/**</span>
<a name="l5242"><span class="linenum">5242</span></a>  <span class="comment">     * Attach below $element (usually attempts) the needed restore_path_elements</span>
<a name="l5243"><span class="linenum">5243</span></a>  <span class="comment">     * to restore question attempt data from Moodle 2.0.</span>
<a name="l5244"><span class="linenum">5244</span></a>  <span class="comment">     *</span>
<a name="l5245"><span class="linenum">5245</span></a>  <span class="comment">     * When using this method, the parent element ($element) must be defined with</span>
<a name="l5246"><span class="linenum">5246</span></a>  <span class="comment">     * $grouped = true. Then, in that elements process method, you must call</span>
<a name="l5247"><span class="linenum">5247</span></a>  <span class="comment">     * {@link process_legacy_attempt_data()} with the groupded data. See, for</span>
<a name="l5248"><span class="linenum">5248</span></a>  <span class="comment">     * example, the usage of this method in {@link restore_quiz_activity_structure_step}.</span>
<a name="l5249"><span class="linenum">5249</span></a>  <span class="comment">     * @param restore_path_element $element the parent element. (E.g. a quiz attempt.)</span>
<a name="l5250"><span class="linenum">5250</span></a>  <span class="comment">     * @param array $paths the paths array that is being built to describe the</span>
<a name="l5251"><span class="linenum">5251</span></a>  <span class="comment">     *      structure.</span>
<a name="l5252"><span class="linenum">5252</span></a>  <span class="comment">     */</span>
<a name="l5253"><span class="linenum">5253</span></a>      protected function <a class="function" onClick="logFunction('add_legacy_question_attempt_data')" href="../../_functions/add_legacy_question_attempt_data.html" onMouseOver="funcPopup(event,'add_legacy_question_attempt_data')">add_legacy_question_attempt_data</a>(<a class="var it634" onMouseOver="hilite(634)" onMouseOut="lolite()" onClick="logVariable('element')" href="../../_variables/element.html">$element</a>, &amp;<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>) {
<a name="l5254"><span class="linenum">5254</span></a>          global <a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>;
<a name="l5255"><span class="linenum">5255</span></a>          require_once(<a class="var it31" onMouseOver="hilite(31)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('dirroot')" class="var it42902" onMouseOver="hilite(42902)" onMouseOut="lolite()" href="../../_variables/dirroot.html">dirroot</a> . '<a class="filename" href="../../question/engine/upgrade/upgradelib.php.html">/question/engine/upgrade/upgradelib.php</a>');
<a name="l5256"><span class="linenum">5256</span></a>  
<a name="l5257"><span class="linenum">5257</span></a>  <span class="comment">        // Check $element is restore_path_element</span>
<a name="l5258"><span class="linenum">5258</span></a>          if (!(<a class="var it634" onMouseOver="hilite(634)" onMouseOut="lolite()" onClick="logVariable('element')" href="../../_variables/element.html">$element</a> instanceof restore_path_element)) {
<a name="l5259"><span class="linenum">5259</span></a>              throw <span class="keyword">new </span><a class="class" onClick="logClass('restore_step_exception')" href="../../_classes/restore_step_exception.html" onMouseOver="classPopup(event,'restore_step_exception')">restore_step_exception</a>('element_must_be_restore_path_element', <a class="var it634" onMouseOver="hilite(634)" onMouseOut="lolite()" onClick="logVariable('element')" href="../../_variables/element.html">$element</a>);
<a name="l5260"><span class="linenum">5260</span></a>          }
<a name="l5261"><span class="linenum">5261</span></a>  <span class="comment">        // Check $paths is one array</span>
<a name="l5262"><span class="linenum">5262</span></a>          if (!<a class="phpfunction" onClick="logFunction('is_array')" href="../../_functions/is_array.html" onMouseOver="phpfuncPopup(event,'is_array')">is_array</a>(<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>)) {
<a name="l5263"><span class="linenum">5263</span></a>              throw <span class="keyword">new </span><a class="class" onClick="logClass('restore_step_exception')" href="../../_classes/restore_step_exception.html" onMouseOver="classPopup(event,'restore_step_exception')">restore_step_exception</a>('paths_must_be_array', <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>);
<a name="l5264"><span class="linenum">5264</span></a>          }
<a name="l5265"><span class="linenum">5265</span></a>  
<a name="l5266"><span class="linenum">5266</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('question_state',
<a name="l5267"><span class="linenum">5267</span></a>                  <a class="var it634" onMouseOver="hilite(634)" onMouseOut="lolite()" onClick="logVariable('element')" href="../../_variables/element.html">$element</a>-&gt;<a class="function" onClick="logFunction('get_path')" href="../../_functions/get_path.html" onMouseOver="funcPopup(event,'get_path')">get_path</a>() . '/states/state');
<a name="l5268"><span class="linenum">5268</span></a>          <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('paths')" href="../../_variables/paths.html">$paths</a>[] = <span class="keyword">new </span><a class="class" onClick="logClass('restore_path_element')" href="../../_classes/restore_path_element.html" onMouseOver="classPopup(event,'restore_path_element')">restore_path_element</a>('question_session',
<a name="l5269"><span class="linenum">5269</span></a>                  <a class="var it634" onMouseOver="hilite(634)" onMouseOut="lolite()" onClick="logVariable('element')" href="../../_variables/element.html">$element</a>-&gt;<a class="function" onClick="logFunction('get_path')" href="../../_functions/get_path.html" onMouseOver="funcPopup(event,'get_path')">get_path</a>() . '/sessions/session');
<a name="l5270"><span class="linenum">5270</span></a>      }
<a name="l5271"><span class="linenum">5271</span></a>  
<a name="l5272"><span class="linenum">5272</span></a>      protected function <a class="function" onClick="logFunction('get_attempt_upgrader')" href="../../_functions/get_attempt_upgrader.html" onMouseOver="funcPopup(event,'get_attempt_upgrader')">get_attempt_upgrader</a>() {
<a name="l5273"><span class="linenum">5273</span></a>          if (empty(<a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('attemptupgrader')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/attemptupgrader.html">attemptupgrader</a>)) {
<a name="l5274"><span class="linenum">5274</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('attemptupgrader')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/attemptupgrader.html">attemptupgrader</a> = <span class="keyword">new </span><a class="class" onClick="logClass('question_engine_attempt_upgrader')" href="../../_classes/question_engine_attempt_upgrader.html" onMouseOver="classPopup(event,'question_engine_attempt_upgrader')">question_engine_attempt_upgrader</a>();
<a name="l5275"><span class="linenum">5275</span></a>              <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('attemptupgrader')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/attemptupgrader.html">attemptupgrader</a>-&gt;<a class="function" onClick="logFunction('prepare_to_restore')" href="../../_functions/prepare_to_restore.html" onMouseOver="funcPopup(event,'prepare_to_restore')">prepare_to_restore</a>();
<a name="l5276"><span class="linenum">5276</span></a>          }
<a name="l5277"><span class="linenum">5277</span></a>          return <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('attemptupgrader')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/attemptupgrader.html">attemptupgrader</a>;
<a name="l5278"><span class="linenum">5278</span></a>      }
<a name="l5279"><span class="linenum">5279</span></a>  
<a name="l5280"><span class="linenum">5280</span></a>      <span class="comment">/**</span>
<a name="l5281"><span class="linenum">5281</span></a>  <span class="comment">     * Process the attempt data defined by {@link add_legacy_question_attempt_data()}.</span>
<a name="l5282"><span class="linenum">5282</span></a>  <span class="comment">     * @param object $data contains all the grouped attempt data to process.</span>
<a name="l5283"><span class="linenum">5283</span></a>  <span class="comment">     * @param pbject $quiz data about the activity the attempts belong to. Required</span>
<a name="l5284"><span class="linenum">5284</span></a>  <span class="comment">     * fields are (basically this only works for the quiz module):</span>
<a name="l5285"><span class="linenum">5285</span></a>  <span class="comment">     *      oldquestions =&gt; list of question ids in this activity - using old ids.</span>
<a name="l5286"><span class="linenum">5286</span></a>  <span class="comment">     *      preferredbehaviour =&gt; the behaviour to use for questionattempts.</span>
<a name="l5287"><span class="linenum">5287</span></a>  <span class="comment">     */</span>
<a name="l5288"><span class="linenum">5288</span></a>      protected function <a class="function" onClick="logFunction('process_legacy_quiz_attempt_data')" href="../../_functions/process_legacy_quiz_attempt_data.html" onMouseOver="funcPopup(event,'process_legacy_quiz_attempt_data')">process_legacy_quiz_attempt_data</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, <a class="var it538" onMouseOver="hilite(538)" onMouseOut="lolite()" onClick="logVariable('quiz')" href="../../_variables/quiz.html">$quiz</a>) {
<a name="l5289"><span class="linenum">5289</span></a>          global <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>;
<a name="l5290"><span class="linenum">5290</span></a>          <a class="var it15487" onMouseOver="hilite(15487)" onMouseOut="lolite()" onClick="logVariable('upgrader')" href="../../_variables/upgrader.html">$upgrader</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_attempt_upgrader')" href="../../_functions/get_attempt_upgrader.html" onMouseOver="funcPopup(event,'get_attempt_upgrader')">get_attempt_upgrader</a>();
<a name="l5291"><span class="linenum">5291</span></a>  
<a name="l5292"><span class="linenum">5292</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a> = (object)<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>;
<a name="l5293"><span class="linenum">5293</span></a>  
<a name="l5294"><span class="linenum">5294</span></a>          <a class="var it459" onMouseOver="hilite(459)" onMouseOut="lolite()" onClick="logVariable('layout')" href="../../_variables/layout.html">$layout</a> = <a class="phpfunction" onClick="logFunction('explode')" href="../../_functions/explode.html" onMouseOver="phpfuncPopup(event,'explode')">explode</a>(',', <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('layout')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/layout.html">layout</a>);
<a name="l5295"><span class="linenum">5295</span></a>          <a class="var it15488" onMouseOver="hilite(15488)" onMouseOut="lolite()" onClick="logVariable('newlayout')" href="../../_variables/newlayout.html">$newlayout</a> = <a class="var it459" onMouseOver="hilite(459)" onMouseOut="lolite()" onClick="logVariable('layout')" href="../../_variables/layout.html">$layout</a>;
<a name="l5296"><span class="linenum">5296</span></a>  
<a name="l5297"><span class="linenum">5297</span></a>  <span class="comment">        // Convert each old question_session into a question_attempt.</span>
<a name="l5298"><span class="linenum">5298</span></a>          <a class="var it15489" onMouseOver="hilite(15489)" onMouseOut="lolite()" onClick="logVariable('qas')" href="../../_variables/qas.html">$qas</a> = array();
<a name="l5299"><span class="linenum">5299</span></a>          foreach (<a class="phpfunction" onClick="logFunction('explode')" href="../../_functions/explode.html" onMouseOver="phpfuncPopup(event,'explode')">explode</a>(',', <a class="var it538" onMouseOver="hilite(538)" onMouseOut="lolite()" onClick="logVariable('quiz')" href="../../_variables/quiz.html">$quiz</a>-&gt;<a onClick="logVariable('oldquestions')" class="var it43017" onMouseOver="hilite(43017)" onMouseOut="lolite()" href="../../_variables/oldquestions.html">oldquestions</a>) as <a class="var it530" onMouseOver="hilite(530)" onMouseOut="lolite()" onClick="logVariable('questionid')" href="../../_variables/questionid.html">$questionid</a>) {
<a name="l5300"><span class="linenum">5300</span></a>              if (<a class="var it530" onMouseOver="hilite(530)" onMouseOut="lolite()" onClick="logVariable('questionid')" href="../../_variables/questionid.html">$questionid</a> == 0) {
<a name="l5301"><span class="linenum">5301</span></a>                  continue;
<a name="l5302"><span class="linenum">5302</span></a>              }
<a name="l5303"><span class="linenum">5303</span></a>  
<a name="l5304"><span class="linenum">5304</span></a>              <a class="var it8594" onMouseOver="hilite(8594)" onMouseOut="lolite()" onClick="logVariable('newquestionid')" href="../../_variables/newquestionid.html">$newquestionid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('question', <a class="var it530" onMouseOver="hilite(530)" onMouseOut="lolite()" onClick="logVariable('questionid')" href="../../_variables/questionid.html">$questionid</a>);
<a name="l5305"><span class="linenum">5305</span></a>              if (!<a class="var it8594" onMouseOver="hilite(8594)" onMouseOut="lolite()" onClick="logVariable('newquestionid')" href="../../_variables/newquestionid.html">$newquestionid</a>) {
<a name="l5306"><span class="linenum">5306</span></a>                  throw <span class="keyword">new </span><a class="class" onClick="logClass('restore_step_exception')" href="../../_classes/restore_step_exception.html" onMouseOver="classPopup(event,'restore_step_exception')">restore_step_exception</a>('questionattemptreferstomissingquestion',
<a name="l5307"><span class="linenum">5307</span></a>                          <a class="var it530" onMouseOver="hilite(530)" onMouseOut="lolite()" onClick="logVariable('questionid')" href="../../_variables/questionid.html">$questionid</a>, <a class="var it530" onMouseOver="hilite(530)" onMouseOut="lolite()" onClick="logVariable('questionid')" href="../../_variables/questionid.html">$questionid</a>);
<a name="l5308"><span class="linenum">5308</span></a>              }
<a name="l5309"><span class="linenum">5309</span></a>  
<a name="l5310"><span class="linenum">5310</span></a>              <a class="var it259" onMouseOver="hilite(259)" onMouseOut="lolite()" onClick="logVariable('question')" href="../../_variables/question.html">$question</a> = <a class="var it15487" onMouseOver="hilite(15487)" onMouseOut="lolite()" onClick="logVariable('upgrader')" href="../../_variables/upgrader.html">$upgrader</a>-&gt;<a class="function" onClick="logFunction('load_question')" href="../../_functions/load_question.html" onMouseOver="funcPopup(event,'load_question')">load_question</a>(<a class="var it8594" onMouseOver="hilite(8594)" onMouseOut="lolite()" onClick="logVariable('newquestionid')" href="../../_variables/newquestionid.html">$newquestionid</a>, <a class="var it538" onMouseOver="hilite(538)" onMouseOut="lolite()" onClick="logVariable('quiz')" href="../../_variables/quiz.html">$quiz</a>-&gt;<a onClick="logVariable('id')" class="var it43017" onMouseOver="hilite(43017)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>);
<a name="l5311"><span class="linenum">5311</span></a>  
<a name="l5312"><span class="linenum">5312</span></a>              foreach (<a class="var it459" onMouseOver="hilite(459)" onMouseOut="lolite()" onClick="logVariable('layout')" href="../../_variables/layout.html">$layout</a> as <a class="var it118" onMouseOver="hilite(118)" onMouseOut="lolite()" onClick="logVariable('key')" href="../../_variables/key.html">$key</a> =&gt; <a class="var it3832" onMouseOver="hilite(3832)" onMouseOut="lolite()" onClick="logVariable('qid')" href="../../_variables/qid.html">$qid</a>) {
<a name="l5313"><span class="linenum">5313</span></a>                  if (<a class="var it3832" onMouseOver="hilite(3832)" onMouseOut="lolite()" onClick="logVariable('qid')" href="../../_variables/qid.html">$qid</a> == <a class="var it530" onMouseOver="hilite(530)" onMouseOut="lolite()" onClick="logVariable('questionid')" href="../../_variables/questionid.html">$questionid</a>) {
<a name="l5314"><span class="linenum">5314</span></a>                      <a class="var it15488" onMouseOver="hilite(15488)" onMouseOut="lolite()" onClick="logVariable('newlayout')" href="../../_variables/newlayout.html">$newlayout</a>[<a class="var it118" onMouseOver="hilite(118)" onMouseOut="lolite()" onClick="logVariable('key')" href="../../_variables/key.html">$key</a>] = <a class="var it8594" onMouseOver="hilite(8594)" onMouseOut="lolite()" onClick="logVariable('newquestionid')" href="../../_variables/newquestionid.html">$newquestionid</a>;
<a name="l5315"><span class="linenum">5315</span></a>                  }
<a name="l5316"><span class="linenum">5316</span></a>              }
<a name="l5317"><span class="linenum">5317</span></a>  
<a name="l5318"><span class="linenum">5318</span></a>              <a class="function" onClick="logFunction('list')" href="../../_functions/list.html" onMouseOver="funcPopup(event,'list')">list</a>(<a class="var it2171" onMouseOver="hilite(2171)" onMouseOut="lolite()" onClick="logVariable('qsession')" href="../../_variables/qsession.html">$qsession</a>, <a class="var it2172" onMouseOver="hilite(2172)" onMouseOut="lolite()" onClick="logVariable('qstates')" href="../../_variables/qstates.html">$qstates</a>) = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('find_question_session_and_states')" href="../../_functions/find_question_session_and_states.html" onMouseOver="funcPopup(event,'find_question_session_and_states')">find_question_session_and_states</a>(
<a name="l5319"><span class="linenum">5319</span></a>                      <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, <a class="var it530" onMouseOver="hilite(530)" onMouseOut="lolite()" onClick="logVariable('questionid')" href="../../_variables/questionid.html">$questionid</a>);
<a name="l5320"><span class="linenum">5320</span></a>  
<a name="l5321"><span class="linenum">5321</span></a>              if (empty(<a class="var it2171" onMouseOver="hilite(2171)" onMouseOut="lolite()" onClick="logVariable('qsession')" href="../../_variables/qsession.html">$qsession</a>) || empty(<a class="var it2172" onMouseOver="hilite(2172)" onMouseOut="lolite()" onClick="logVariable('qstates')" href="../../_variables/qstates.html">$qstates</a>)) {
<a name="l5322"><span class="linenum">5322</span></a>                  throw <span class="keyword">new </span><a class="class" onClick="logClass('restore_step_exception')" href="../../_classes/restore_step_exception.html" onMouseOver="classPopup(event,'restore_step_exception')">restore_step_exception</a>('questionattemptdatamissing',
<a name="l5323"><span class="linenum">5323</span></a>                          <a class="var it530" onMouseOver="hilite(530)" onMouseOut="lolite()" onClick="logVariable('questionid')" href="../../_variables/questionid.html">$questionid</a>, <a class="var it530" onMouseOver="hilite(530)" onMouseOut="lolite()" onClick="logVariable('questionid')" href="../../_variables/questionid.html">$questionid</a>);
<a name="l5324"><span class="linenum">5324</span></a>              }
<a name="l5325"><span class="linenum">5325</span></a>  
<a name="l5326"><span class="linenum">5326</span></a>              <a class="function" onClick="logFunction('list')" href="../../_functions/list.html" onMouseOver="funcPopup(event,'list')">list</a>(<a class="var it2171" onMouseOver="hilite(2171)" onMouseOut="lolite()" onClick="logVariable('qsession')" href="../../_variables/qsession.html">$qsession</a>, <a class="var it2172" onMouseOver="hilite(2172)" onMouseOut="lolite()" onClick="logVariable('qstates')" href="../../_variables/qstates.html">$qstates</a>) = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('recode_legacy_response_data')" href="../../_functions/recode_legacy_response_data.html" onMouseOver="funcPopup(event,'recode_legacy_response_data')">recode_legacy_response_data</a>(
<a name="l5327"><span class="linenum">5327</span></a>                      <a class="var it259" onMouseOver="hilite(259)" onMouseOut="lolite()" onClick="logVariable('question')" href="../../_variables/question.html">$question</a>, <a class="var it2171" onMouseOver="hilite(2171)" onMouseOut="lolite()" onClick="logVariable('qsession')" href="../../_variables/qsession.html">$qsession</a>, <a class="var it2172" onMouseOver="hilite(2172)" onMouseOut="lolite()" onClick="logVariable('qstates')" href="../../_variables/qstates.html">$qstates</a>);
<a name="l5328"><span class="linenum">5328</span></a>  
<a name="l5329"><span class="linenum">5329</span></a>              <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('layout')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/layout.html">layout</a> = <a class="phpfunction" onClick="logFunction('implode')" href="../../_functions/implode.html" onMouseOver="phpfuncPopup(event,'implode')">implode</a>(',', <a class="var it15488" onMouseOver="hilite(15488)" onMouseOut="lolite()" onClick="logVariable('newlayout')" href="../../_variables/newlayout.html">$newlayout</a>);
<a name="l5330"><span class="linenum">5330</span></a>              <a class="var it15489" onMouseOver="hilite(15489)" onMouseOut="lolite()" onClick="logVariable('qas')" href="../../_variables/qas.html">$qas</a>[<a class="var it8594" onMouseOver="hilite(8594)" onMouseOut="lolite()" onClick="logVariable('newquestionid')" href="../../_variables/newquestionid.html">$newquestionid</a>] = <a class="var it15487" onMouseOver="hilite(15487)" onMouseOut="lolite()" onClick="logVariable('upgrader')" href="../../_variables/upgrader.html">$upgrader</a>-&gt;<a class="function" onClick="logFunction('convert_question_attempt')" href="../../_functions/convert_question_attempt.html" onMouseOver="funcPopup(event,'convert_question_attempt')">convert_question_attempt</a>(
<a name="l5331"><span class="linenum">5331</span></a>                      <a class="var it538" onMouseOver="hilite(538)" onMouseOut="lolite()" onClick="logVariable('quiz')" href="../../_variables/quiz.html">$quiz</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, <a class="var it259" onMouseOver="hilite(259)" onMouseOut="lolite()" onClick="logVariable('question')" href="../../_variables/question.html">$question</a>, <a class="var it2171" onMouseOver="hilite(2171)" onMouseOut="lolite()" onClick="logVariable('qsession')" href="../../_variables/qsession.html">$qsession</a>, <a class="var it2172" onMouseOver="hilite(2172)" onMouseOut="lolite()" onClick="logVariable('qstates')" href="../../_variables/qstates.html">$qstates</a>);
<a name="l5332"><span class="linenum">5332</span></a>          }
<a name="l5333"><span class="linenum">5333</span></a>  
<a name="l5334"><span class="linenum">5334</span></a>  <span class="comment">        // Now create a new question_usage.</span>
<a name="l5335"><span class="linenum">5335</span></a>          <a class="var it15491" onMouseOver="hilite(15491)" onMouseOut="lolite()" onClick="logVariable('usage')" href="../../_variables/usage.html">$usage</a> = new stdClass();
<a name="l5336"><span class="linenum">5336</span></a>          <a class="var it15491" onMouseOver="hilite(15491)" onMouseOut="lolite()" onClick="logVariable('usage')" href="../../_variables/usage.html">$usage</a>-&gt;<a onClick="logVariable('component')" class="var it45307" onMouseOver="hilite(45307)" onMouseOut="lolite()" href="../../_variables/component.html">component</a> = 'mod_quiz';
<a name="l5337"><span class="linenum">5337</span></a>          <a class="var it15491" onMouseOver="hilite(15491)" onMouseOut="lolite()" onClick="logVariable('usage')" href="../../_variables/usage.html">$usage</a>-&gt;<a onClick="logVariable('contextid')" class="var it45307" onMouseOver="hilite(45307)" onMouseOut="lolite()" href="../../_variables/contextid.html">contextid</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_mappingid')" href="../../_functions/get_mappingid.html" onMouseOver="funcPopup(event,'get_mappingid')">get_mappingid</a>('context', <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a onClick="logVariable('task')" class="var it42912" onMouseOver="hilite(42912)" onMouseOut="lolite()" href="../../_variables/task.html">task</a>-&gt;<a class="function" onClick="logFunction('get_old_contextid')" href="../../_functions/get_old_contextid.html" onMouseOver="funcPopup(event,'get_old_contextid')">get_old_contextid</a>());
<a name="l5338"><span class="linenum">5338</span></a>          <a class="var it15491" onMouseOver="hilite(15491)" onMouseOut="lolite()" onClick="logVariable('usage')" href="../../_variables/usage.html">$usage</a>-&gt;<a onClick="logVariable('preferredbehaviour')" class="var it45307" onMouseOver="hilite(45307)" onMouseOut="lolite()" href="../../_variables/preferredbehaviour.html">preferredbehaviour</a> = <a class="var it538" onMouseOver="hilite(538)" onMouseOut="lolite()" onClick="logVariable('quiz')" href="../../_variables/quiz.html">$quiz</a>-&gt;<a onClick="logVariable('preferredbehaviour')" class="var it43017" onMouseOver="hilite(43017)" onMouseOut="lolite()" href="../../_variables/preferredbehaviour.html">preferredbehaviour</a>;
<a name="l5339"><span class="linenum">5339</span></a>          <a class="var it15491" onMouseOver="hilite(15491)" onMouseOut="lolite()" onClick="logVariable('usage')" href="../../_variables/usage.html">$usage</a>-&gt;<a onClick="logVariable('id')" class="var it45307" onMouseOver="hilite(45307)" onMouseOut="lolite()" href="../../_variables/id.html">id</a> = <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('question_usages', <a class="var it15491" onMouseOver="hilite(15491)" onMouseOut="lolite()" onClick="logVariable('usage')" href="../../_variables/usage.html">$usage</a>);
<a name="l5340"><span class="linenum">5340</span></a>  
<a name="l5341"><span class="linenum">5341</span></a>          <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('inform_new_usage_id')" href="../../_functions/inform_new_usage_id.html" onMouseOver="funcPopup(event,'inform_new_usage_id')">inform_new_usage_id</a>(<a class="var it15491" onMouseOver="hilite(15491)" onMouseOut="lolite()" onClick="logVariable('usage')" href="../../_variables/usage.html">$usage</a>-&gt;<a onClick="logVariable('id')" class="var it45307" onMouseOver="hilite(45307)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>);
<a name="l5342"><span class="linenum">5342</span></a>  
<a name="l5343"><span class="linenum">5343</span></a>          <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('uniqueid')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/uniqueid.html">uniqueid</a> = <a class="var it15491" onMouseOver="hilite(15491)" onMouseOut="lolite()" onClick="logVariable('usage')" href="../../_variables/usage.html">$usage</a>-&gt;<a onClick="logVariable('id')" class="var it45307" onMouseOver="hilite(45307)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l5344"><span class="linenum">5344</span></a>          <a class="var it15487" onMouseOver="hilite(15487)" onMouseOut="lolite()" onClick="logVariable('upgrader')" href="../../_variables/upgrader.html">$upgrader</a>-&gt;<a class="function" onClick="logFunction('save_usage')" href="../../_functions/save_usage.html" onMouseOver="funcPopup(event,'save_usage')">save_usage</a>(<a class="var it538" onMouseOver="hilite(538)" onMouseOut="lolite()" onClick="logVariable('quiz')" href="../../_variables/quiz.html">$quiz</a>-&gt;<a onClick="logVariable('preferredbehaviour')" class="var it43017" onMouseOver="hilite(43017)" onMouseOut="lolite()" href="../../_variables/preferredbehaviour.html">preferredbehaviour</a>, <a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, <a class="var it15489" onMouseOver="hilite(15489)" onMouseOut="lolite()" onClick="logVariable('qas')" href="../../_variables/qas.html">$qas</a>,
<a name="l5345"><span class="linenum">5345</span></a>                   <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('questions_recode_layout')" href="../../_functions/questions_recode_layout.html" onMouseOver="funcPopup(event,'questions_recode_layout')">questions_recode_layout</a>(<a class="var it538" onMouseOver="hilite(538)" onMouseOut="lolite()" onClick="logVariable('quiz')" href="../../_variables/quiz.html">$quiz</a>-&gt;<a onClick="logVariable('oldquestions')" class="var it43017" onMouseOver="hilite(43017)" onMouseOut="lolite()" href="../../_variables/oldquestions.html">oldquestions</a>));
<a name="l5346"><span class="linenum">5346</span></a>      }
<a name="l5347"><span class="linenum">5347</span></a>  
<a name="l5348"><span class="linenum">5348</span></a>      protected function <a class="function" onClick="logFunction('find_question_session_and_states')" href="../../_functions/find_question_session_and_states.html" onMouseOver="funcPopup(event,'find_question_session_and_states')">find_question_session_and_states</a>(<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>, <a class="var it530" onMouseOver="hilite(530)" onMouseOut="lolite()" onClick="logVariable('questionid')" href="../../_variables/questionid.html">$questionid</a>) {
<a name="l5349"><span class="linenum">5349</span></a>          <a class="var it2171" onMouseOver="hilite(2171)" onMouseOut="lolite()" onClick="logVariable('qsession')" href="../../_variables/qsession.html">$qsession</a> = null;
<a name="l5350"><span class="linenum">5350</span></a>          foreach (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('sessions')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/sessions.html">sessions</a>['session'] as <a class="var it2387" onMouseOver="hilite(2387)" onMouseOut="lolite()" onClick="logVariable('session')" href="../../_variables/session.html">$session</a>) {
<a name="l5351"><span class="linenum">5351</span></a>              if (<a class="var it2387" onMouseOver="hilite(2387)" onMouseOut="lolite()" onClick="logVariable('session')" href="../../_variables/session.html">$session</a>['questionid'] == <a class="var it530" onMouseOver="hilite(530)" onMouseOut="lolite()" onClick="logVariable('questionid')" href="../../_variables/questionid.html">$questionid</a>) {
<a name="l5352"><span class="linenum">5352</span></a>                  <a class="var it2171" onMouseOver="hilite(2171)" onMouseOut="lolite()" onClick="logVariable('qsession')" href="../../_variables/qsession.html">$qsession</a> = (object) <a class="var it2387" onMouseOver="hilite(2387)" onMouseOut="lolite()" onClick="logVariable('session')" href="../../_variables/session.html">$session</a>;
<a name="l5353"><span class="linenum">5353</span></a>                  break;
<a name="l5354"><span class="linenum">5354</span></a>              }
<a name="l5355"><span class="linenum">5355</span></a>          }
<a name="l5356"><span class="linenum">5356</span></a>  
<a name="l5357"><span class="linenum">5357</span></a>          <a class="var it2172" onMouseOver="hilite(2172)" onMouseOut="lolite()" onClick="logVariable('qstates')" href="../../_variables/qstates.html">$qstates</a> = array();
<a name="l5358"><span class="linenum">5358</span></a>          foreach (<a class="var it4" onMouseOver="hilite(4)" onMouseOut="lolite()" onClick="logVariable('data')" href="../../_variables/data.html">$data</a>-&gt;<a onClick="logVariable('states')" class="var it42917" onMouseOver="hilite(42917)" onMouseOut="lolite()" href="../../_variables/states.html">states</a>['state'] as <a class="var it650" onMouseOver="hilite(650)" onMouseOut="lolite()" onClick="logVariable('state')" href="../../_variables/state.html">$state</a>) {
<a name="l5359"><span class="linenum">5359</span></a>              if (<a class="var it650" onMouseOver="hilite(650)" onMouseOut="lolite()" onClick="logVariable('state')" href="../../_variables/state.html">$state</a>['question'] == <a class="var it530" onMouseOver="hilite(530)" onMouseOut="lolite()" onClick="logVariable('questionid')" href="../../_variables/questionid.html">$questionid</a>) {
<a name="l5360"><span class="linenum">5360</span></a>  <span class="comment">                // It would be natural to use $state['seq_number'] as the array-key</span>
<a name="l5361"><span class="linenum">5361</span></a>  <span class="comment">                // here, but it seems that buggy behaviour in 2.0 and early can</span>
<a name="l5362"><span class="linenum">5362</span></a>  <span class="comment">                // mean that that is not unique, so we use id, which is guaranteed</span>
<a name="l5363"><span class="linenum">5363</span></a>  <span class="comment">                // to be unique.</span>
<a name="l5364"><span class="linenum">5364</span></a>                  <a class="var it2172" onMouseOver="hilite(2172)" onMouseOut="lolite()" onClick="logVariable('qstates')" href="../../_variables/qstates.html">$qstates</a>[<a class="var it650" onMouseOver="hilite(650)" onMouseOut="lolite()" onClick="logVariable('state')" href="../../_variables/state.html">$state</a>['id']] = (object) <a class="var it650" onMouseOver="hilite(650)" onMouseOut="lolite()" onClick="logVariable('state')" href="../../_variables/state.html">$state</a>;
<a name="l5365"><span class="linenum">5365</span></a>              }
<a name="l5366"><span class="linenum">5366</span></a>          }
<a name="l5367"><span class="linenum">5367</span></a>          <a class="phpfunction" onClick="logFunction('ksort')" href="../../_functions/ksort.html" onMouseOver="phpfuncPopup(event,'ksort')">ksort</a>(<a class="var it2172" onMouseOver="hilite(2172)" onMouseOut="lolite()" onClick="logVariable('qstates')" href="../../_variables/qstates.html">$qstates</a>);
<a name="l5368"><span class="linenum">5368</span></a>          <a class="var it2172" onMouseOver="hilite(2172)" onMouseOut="lolite()" onClick="logVariable('qstates')" href="../../_variables/qstates.html">$qstates</a> = <a class="phpfunction" onClick="logFunction('array_values')" href="../../_functions/array_values.html" onMouseOver="phpfuncPopup(event,'array_values')">array_values</a>(<a class="var it2172" onMouseOver="hilite(2172)" onMouseOut="lolite()" onClick="logVariable('qstates')" href="../../_variables/qstates.html">$qstates</a>);
<a name="l5369"><span class="linenum">5369</span></a>  
<a name="l5370"><span class="linenum">5370</span></a>          return array(<a class="var it2171" onMouseOver="hilite(2171)" onMouseOut="lolite()" onClick="logVariable('qsession')" href="../../_variables/qsession.html">$qsession</a>, <a class="var it2172" onMouseOver="hilite(2172)" onMouseOut="lolite()" onClick="logVariable('qstates')" href="../../_variables/qstates.html">$qstates</a>);
<a name="l5371"><span class="linenum">5371</span></a>      }
<a name="l5372"><span class="linenum">5372</span></a>  
<a name="l5373"><span class="linenum">5373</span></a>      <span class="comment">/**</span>
<a name="l5374"><span class="linenum">5374</span></a>  <span class="comment">     * Recode any ids in the response data</span>
<a name="l5375"><span class="linenum">5375</span></a>  <span class="comment">     * @param object $question the question data</span>
<a name="l5376"><span class="linenum">5376</span></a>  <span class="comment">     * @param object $qsession the question sessions.</span>
<a name="l5377"><span class="linenum">5377</span></a>  <span class="comment">     * @param array $qstates the question states.</span>
<a name="l5378"><span class="linenum">5378</span></a>  <span class="comment">     */</span>
<a name="l5379"><span class="linenum">5379</span></a>      protected function <a class="function" onClick="logFunction('recode_legacy_response_data')" href="../../_functions/recode_legacy_response_data.html" onMouseOver="funcPopup(event,'recode_legacy_response_data')">recode_legacy_response_data</a>(<a class="var it259" onMouseOver="hilite(259)" onMouseOut="lolite()" onClick="logVariable('question')" href="../../_variables/question.html">$question</a>, <a class="var it2171" onMouseOver="hilite(2171)" onMouseOut="lolite()" onClick="logVariable('qsession')" href="../../_variables/qsession.html">$qsession</a>, <a class="var it2172" onMouseOver="hilite(2172)" onMouseOut="lolite()" onClick="logVariable('qstates')" href="../../_variables/qstates.html">$qstates</a>) {
<a name="l5380"><span class="linenum">5380</span></a>          <a class="var it2171" onMouseOver="hilite(2171)" onMouseOut="lolite()" onClick="logVariable('qsession')" href="../../_variables/qsession.html">$qsession</a>-&gt;<a onClick="logVariable('questionid')" class="var it43710" onMouseOver="hilite(43710)" onMouseOut="lolite()" href="../../_variables/questionid.html">questionid</a> = <a class="var it259" onMouseOver="hilite(259)" onMouseOut="lolite()" onClick="logVariable('question')" href="../../_variables/question.html">$question</a>-&gt;<a onClick="logVariable('id')" class="var it43018" onMouseOver="hilite(43018)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l5381"><span class="linenum">5381</span></a>  
<a name="l5382"><span class="linenum">5382</span></a>          foreach (<a class="var it2172" onMouseOver="hilite(2172)" onMouseOut="lolite()" onClick="logVariable('qstates')" href="../../_variables/qstates.html">$qstates</a> as &amp;<a class="var it650" onMouseOver="hilite(650)" onMouseOut="lolite()" onClick="logVariable('state')" href="../../_variables/state.html">$state</a>) {
<a name="l5383"><span class="linenum">5383</span></a>              <a class="var it650" onMouseOver="hilite(650)" onMouseOut="lolite()" onClick="logVariable('state')" href="../../_variables/state.html">$state</a>-&gt;<a onClick="logVariable('question')" class="var it43230" onMouseOver="hilite(43230)" onMouseOut="lolite()" href="../../_variables/question.html">question</a> = <a class="var it259" onMouseOver="hilite(259)" onMouseOut="lolite()" onClick="logVariable('question')" href="../../_variables/question.html">$question</a>-&gt;<a onClick="logVariable('id')" class="var it43018" onMouseOver="hilite(43018)" onMouseOut="lolite()" href="../../_variables/id.html">id</a>;
<a name="l5384"><span class="linenum">5384</span></a>              <a class="var it650" onMouseOver="hilite(650)" onMouseOut="lolite()" onClick="logVariable('state')" href="../../_variables/state.html">$state</a>-&gt;<a onClick="logVariable('answer')" class="var it43230" onMouseOver="hilite(43230)" onMouseOut="lolite()" href="../../_variables/answer.html">answer</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('restore_recode_legacy_answer')" href="../../_functions/restore_recode_legacy_answer.html" onMouseOver="funcPopup(event,'restore_recode_legacy_answer')">restore_recode_legacy_answer</a>(<a class="var it650" onMouseOver="hilite(650)" onMouseOut="lolite()" onClick="logVariable('state')" href="../../_variables/state.html">$state</a>, <a class="var it259" onMouseOver="hilite(259)" onMouseOut="lolite()" onClick="logVariable('question')" href="../../_variables/question.html">$question</a>-&gt;<a onClick="logVariable('qtype')" class="var it43018" onMouseOver="hilite(43018)" onMouseOut="lolite()" href="../../_variables/qtype.html">qtype</a>);
<a name="l5385"><span class="linenum">5385</span></a>          }
<a name="l5386"><span class="linenum">5386</span></a>  
<a name="l5387"><span class="linenum">5387</span></a>          return array(<a class="var it2171" onMouseOver="hilite(2171)" onMouseOut="lolite()" onClick="logVariable('qsession')" href="../../_variables/qsession.html">$qsession</a>, <a class="var it2172" onMouseOver="hilite(2172)" onMouseOut="lolite()" onClick="logVariable('qstates')" href="../../_variables/qstates.html">$qstates</a>);
<a name="l5388"><span class="linenum">5388</span></a>      }
<a name="l5389"><span class="linenum">5389</span></a>  
<a name="l5390"><span class="linenum">5390</span></a>      <span class="comment">/**</span>
<a name="l5391"><span class="linenum">5391</span></a>  <span class="comment">     * Recode the legacy answer field.</span>
<a name="l5392"><span class="linenum">5392</span></a>  <span class="comment">     * @param object $state the state to recode the answer of.</span>
<a name="l5393"><span class="linenum">5393</span></a>  <span class="comment">     * @param string $qtype the question type.</span>
<a name="l5394"><span class="linenum">5394</span></a>  <span class="comment">     */</span>
<a name="l5395"><span class="linenum">5395</span></a>      public function <a class="function" onClick="logFunction('restore_recode_legacy_answer')" href="../../_functions/restore_recode_legacy_answer.html" onMouseOver="funcPopup(event,'restore_recode_legacy_answer')">restore_recode_legacy_answer</a>(<a class="var it650" onMouseOver="hilite(650)" onMouseOut="lolite()" onClick="logVariable('state')" href="../../_variables/state.html">$state</a>, <a class="var it260" onMouseOver="hilite(260)" onMouseOut="lolite()" onClick="logVariable('qtype')" href="../../_variables/qtype.html">$qtype</a>) {
<a name="l5396"><span class="linenum">5396</span></a>          <a class="var it15492" onMouseOver="hilite(15492)" onMouseOut="lolite()" onClick="logVariable('restorer')" href="../../_variables/restorer.html">$restorer</a> = <a class="var it3" onMouseOver="hilite(3)" onMouseOut="lolite()" onClick="logVariable('this')" href="../../_variables/this.html">$this</a>-&gt;<a class="function" onClick="logFunction('get_qtype_restorer')" href="../../_functions/get_qtype_restorer.html" onMouseOver="funcPopup(event,'get_qtype_restorer')">get_qtype_restorer</a>(<a class="var it260" onMouseOver="hilite(260)" onMouseOut="lolite()" onClick="logVariable('qtype')" href="../../_variables/qtype.html">$qtype</a>);
<a name="l5397"><span class="linenum">5397</span></a>          if (<a class="var it15492" onMouseOver="hilite(15492)" onMouseOut="lolite()" onClick="logVariable('restorer')" href="../../_variables/restorer.html">$restorer</a>) {
<a name="l5398"><span class="linenum">5398</span></a>              return <a class="var it15492" onMouseOver="hilite(15492)" onMouseOut="lolite()" onClick="logVariable('restorer')" href="../../_variables/restorer.html">$restorer</a>-&gt;<a class="function" onClick="logFunction('recode_legacy_state_answer')" href="../../_functions/recode_legacy_state_answer.html" onMouseOver="funcPopup(event,'recode_legacy_state_answer')">recode_legacy_state_answer</a>(<a class="var it650" onMouseOver="hilite(650)" onMouseOut="lolite()" onClick="logVariable('state')" href="../../_variables/state.html">$state</a>);
<a name="l5399"><span class="linenum">5399</span></a>          } else {
<a name="l5400"><span class="linenum">5400</span></a>              return <a class="var it650" onMouseOver="hilite(650)" onMouseOut="lolite()" onClick="logVariable('state')" href="../../_variables/state.html">$state</a>-&gt;<a onClick="logVariable('answer')" class="var it43230" onMouseOver="hilite(43230)" onMouseOut="lolite()" href="../../_variables/answer.html">answer</a>;
<a name="l5401"><span class="linenum">5401</span></a>          }
<a name="l5402"><span class="linenum">5402</span></a>      }
<a name="l5403"><span class="linenum">5403</span></a>  }
</pre>
</div>
<script language="JavaScript" type="text/javascript">
FUNC_DATA={
'get_qtype_restorer': ['get_qtype_restorer', 'Get the restore_qtype_plugin subclass for a specific question type. ', [['backup/moodle2','restore_stepslib.php',5210]], 2],
'get_records': ['get_records', 'Load a list of records. ', [['competency/classes','persistent.php',709],['mod/glossary/classes','entry_query_builder.php',295],['lib/dml','moodle_database.php',1285],['lib','coursecatlib.php',651],['question','category_class.php',63]], 965],
'process_file': ['process_file', 'Given the full path of a file, try to find the user the file corresponds to and assign him/her this file as his/her picture. Make extensive checks to make sure we don\'t open any security holes and report back any success/error. ', [['admin/tool/uploaduser','picture.php',185],['enrol/flatfile','lib.php',230],['backup/moodle2','restore_stepslib.php',1041]], 2],
'sql_compare_text': ['sql_compare_text', 'Returns the SQL text to be used to compare one TEXT (clob) column with one varchar column, because some RDBMS doesn\'t support such direct comparisons. ', [['lib/dml','moodle_database.php',2040]], 95],
'get_repository_by_id': ['get_repository_by_id', 'Get repository instance using repository id ', [['repository','lib.php',573]], 39],
'get_field_sql': ['get_field_sql', 'Get a single field value (first field) using a SQL statement. ', [['lib/dml','moodle_database.php',1588]], 138],
'grade_set_setting': ['grade_set_setting', 'Add, update or delete a course gradebook setting ', [['lib','gradelib.php',696]], 23],
'send_common_files': ['send_common_files', 'Send the common question files to a new context. ', [['backup/moodle2','restore_stepslib.php',4618]], 1],
'add_related_files': ['add_related_files', 'Add all the existing file, given their component and filearea and one backup_ids itemname to match with ', [['backup/moodle2','restore_plugin.class.php',214],['backup/moodle2','restore_subplugin.class.php',146],['backup/util/plan','restore_structure_step.class.php',222]], 86],
'process_parameter': ['process_parameter', '', [['backup/moodle2','restore_stepslib.php',2545]], 0],
'process_course_completion_aggr_methd': ['process_course_completion_aggr_methd', 'Process course completion aggregate methods ', [['backup/moodle2','restore_stepslib.php',2951]], 0],
'apply_date_offset': ['apply_date_offset', 'Apply course startdate offset based in original course startdate and course_offset_startdate setting Note we are using one static cache here, but *by restoreid*, so it\'s ok for concurrence/multiple executions in the same request ', [['backup/moodle2','restore_plugin.class.php',221],['backup/moodle2','restore_subplugin.class.php',153],['backup/util/plan','restore_step.class.php',49]], 148],
'execute': ['execute', 'Run langpack update ', [['admin/tool/langimport/classes/task','update_langpacks_task.php',44],['backup/converter/imscc1','lib.php',84],['lib/classes/task','blog_cron_task.php',40],['mod/workshop/allocation/scheduled','lib.php',128],['lib/classes/task','send_new_user_passwords_task.php',40],['admin/tool/log/store/standard/classes/task','cleanup_task.php',40],['lib/dml','pdo_moodle_database.php',227],['lib/classes/task','tag_cron_task.php',42],['enrol/imsenterprise/classes/task','cron_task.php',43],['lib/classes/task','completion_daily_task.php',42],['lib/google/src/Google/Http','Batch.php',61],['lib/dml','oci_native_moodle_database.php',1048],['lib/classes/task','context_cleanup_task.php',41],['backup/util/plan','backup_structure_step.class.php',50],['backup/util/ui','restore_ui.class.php',206],['webservice','lib.php',1319],['lib/classes/task','stats_cron_task.php',40],['lib/htmlpurifier/HTMLPurifier/Strategy','ValidateAttributes.php',16],['lib/htmlpurifier/HTMLPurifier/Strategy','RemoveForeignElements.php',20],['lib/classes/task','legacy_plugin_cron_task.php',42],['backup/moodle2','restore_activity_task.class.php',189],['lib/classes/task','portfolio_cron_task.php',40],['lib/google/src/Google/Http','REST.php',27],['lib/htmlpurifier/HTMLPurifier/Strategy','MakeWellFormed.php',66],['backup/converter/imscc11','backuplib.php',42],['lib/classes/task','question_cron_task.php',40],['lib/classes/task','cache_cron_task.php',40],['admin/tool/log/store/legacy/classes/task','cleanup_task.php',40],['mod/lti/service/memberships/classes/local/resource','linkmemberships.php',62],['admin/tool/messageinbound/classes/task','cleanup_task.php',47],['lib/adodb/drivers','adodb-pdo.inc.php',559],['lib/editor/atto/classes/task','autosave_cleanup_task.php',42],['admin/tool/recyclebin/classes/task','cleanup_category_bin.php',43],['lib/classes/task','completion_regular_task.php',42],['lib/adodb/drivers','adodb-oci8po.inc.php',54],['lib/classes/task','events_cron_task.php',40],['mod/workshop/allocation/random','lib.php',83],['mod/assign/feedback/editpdf/classes/task','convert_submissions.php',47],['auth/cas/classes/task','sync_task.php',43],['admin/tool/recyclebin/classes/task','cleanup_course_bin.php',43],['mod/lti/service/toolsettings/classes/local/resource','contextsettings.php',62],['backup/util/helper','restore_decode_processor.class.php',73],['lib/behat','behat_base.php',840],['enrol/flatfile/classes/task','flatfile_sync_task.php',46],['lib/classes/task','registration_cron_task.php',40],['backup/moodle2','backup_section_task.class.php',97],['lib/classes/task','check_for_updates_task.php',40],['backup/util/plan/tests/fixtures','plan_fixtures.php',48],['backup/util/plan/tests/fixtures','plan_fixtures.php',56],['mod/forum/classes/task','cron_task.php',39],['lib/classes/task','send_failed_login_notifications_task.php',43],['enrol/lti/classes/task','sync_grades.php',45],['lib/dml','pgsql_native_moodle_database.php',665],['lib/htmlpurifier/HTMLPurifier/Strategy','Composite.php',21],['lib/classes/update','validator.php',117],['lib/google/src/Google','Client.php',574],['lib/dml','mssql_native_moodle_database.php',711],['mod/lti/service/profile/classes/local/resource','profile.php',76],['backup/util/plan','backup_plan.class.php',112],['lib/dml','mysqli_native_moodle_database.php',963],['backup/util/ui','backup_ui.class.php',122],['admin/tool/monitor/classes/task','clean_events.php',41],['backup/converter/moodle1','backuplib.php',10],['backup/converter/imscc11','lib.php',85],['lib/classes/task','grade_cron_task.php',40],['lib/classes/task','file_temp_cleanup_task.php',40],['backup/moodle2','restore_section_task.class.php',87],['mod/lti/service/toolsettings/classes/local/resource','linksettings.php',63],['filter/tex','latex.php',70],['lib/adodb','adodb.inc.php',1088],['lib/classes/task','plagiarism_cron_task.php',40],['mod/lti/service/toolproxy/classes/local/resource','toolproxy.php',62],['backup/converter/moodle1','lib.php',142],['backup/util/plan','restore_structure_step.class.php',62],['lib/classes/task','search_index_task.php',44],['enrol/lti/classes/task','sync_members.php',55],['lib/classes/task','session_cleanup_task.php',40],['mod/lti/service/toolsettings/classes/local/resource','systemsettings.php',61],['lib/classes/task','backup_cleanup_task.php',40],['lib/classes/task','delete_unconfirmed_users_task.php',40],['backup/converter/imscc1','backuplib.php',10],['lib/classes/task','badges_cron_task.php',40],['admin/tool/uploadcourse/classes','processor.php',174],['lib/classes/task','calendar_cron_task.php',40],['backup/util/plan','base_plan.class.php',158],['auth/ldap/classes/task','sync_task.php',43],['lib/adodb/drivers','adodb-oci8.inc.php',920],['backup/util/plan','restore_plan.class.php',159],['lib/tests/fixtures','task_fixtures.php',30],['lib/tests/fixtures','task_fixtures.php',39],['lib/tests/fixtures','task_fixtures.php',48],['lib/tests/fixtures','task_fixtures.php',57],['lib/dml','sqlsrv_native_moodle_database.php',795],['lib/classes/task','create_contexts_task.php',40],['lib/classes/task','file_trash_cleanup_task.php',40],['admin/tool/cohortroles/classes/task','cohort_role_sync.php',46],['lib/classes/task','complete_plans_task.php',52],['lib/classes/task','messaging_cleanup_task.php',40],['backup/util/plan','backup_execution_step.class.php',25],['lib/classes/task','cache_cleanup_task.php',40],['backup/moodle2','backup_activity_task.class.php',211],['filter/tex','texdebug.php',287],['lib/classes/task','password_reset_cleanup_task.php',40],['lib/classes/task','search_optimize_task.php',47],['mod/assign','adminlib.php',342],['lib/classes/task','delete_incomplete_users_task.php',40],['lib/classes/task','automated_backup_task.php',40],['admin/tool/messageinbound/classes/task','pickup_task.php',47],['backup/util/plan','restore_execution_step.class.php',25],['lib/classes/task','sync_plans_from_template_cohorts_task.php',50],['admin/tool/monitor/classes','notification_task.php',39],['lib/dml/tests','dml_test.php',5543],['lib/htmlpurifier/HTMLPurifier/Strategy','FixNesting.php',41],['mod/lti/service/memberships/classes/local/resource','contextmemberships.php',60],['admin/tool/monitor/classes/task','check_subscriptions.php',60],['backup/util/interfaces','executable.class.php',32],['backup/util/plan','base_task.class.php',162]], 1058],
'choose_repository': ['choose_repository', 'Choose the repository instance that should handle the alias. ', [['backup/moodle2','restore_stepslib.php',4832]], 1],
'process_course': ['process_course', 'Processing functions go here ', [['backup/moodle2','restore_stepslib.php',1802]], 0],
'get_roles_with_cap_in_context': ['get_roles_with_cap_in_context', 'Returns two lists, this can be used to find out if user has capability. Having any needed role and no forbidden role in this context means user has this capability in this context. Use get_role_names_with_cap_in_context() if you need role names to display in the UI ', [['lib','accesslib.php',4841]], 8],
'process_scale': ['process_scale', '', [['backup/moodle2','restore_stepslib.php',1376],['backup/converter/moodle1','handlerlib.php',1402]], 0],
'process_activity': ['process_activity', 'Process the activity path, informing the task about various ids, needed later ', [['backup/moodle2','restore_stepslib.php',4249],['lib/tests/behat','behat_data_generators.php',307]], 0],
'is_missing_modules': ['is_missing_modules', '', [['backup/util/plan','restore_task.class.php',66],['backup/util/plan','restore_plan.class.php',127]], 5],
'process_grade_setting': ['process_grade_setting', '', [['backup/moodle2','restore_stepslib.php',345]], 0],
'update': ['update', 'In addition to update() as defined in grade_object, handle the grade_outcome and grade_scale objects. Force regrading if necessary, rounds the float numbers using php function, the reason is we need to compare the db value with computed number to skip regrading if possible. ', [['lib/grade','grade_item.php',274],['lib/google/src/Google/Service','Tasks.php',386],['lib/google/src/Google/Service','Tasks.php',556],['lib/google/src/Google/Service','AndroidPublisher.php',1413],['lib/google/src/Google/Service','AndroidPublisher.php',1545],['lib/google/src/Google/Service','AndroidPublisher.php',1615],['lib/google/src/Google/Service','AndroidPublisher.php',1853],['lib/google/src/Google/Service','AndroidPublisher.php',1919],['lib/google/src/Google/Service','AndroidPublisher.php',2003],['lib/google/src/Google/Service','AndroidPublisher.php',2177],['lib/google/src/Google/Service','Reseller.php',344],['lib/grade','grade_category.php',226],['lib/grade','grade_scale.php',125],['lib/adodb','adodb-active-record.inc.php',1004],['lib/grade','grade_object.php',238],['lib/google/src/Google/Service','YouTubeAnalytics.php',534],['completion','data_object.php',252],['mod/lesson/pagetypes','matching.php',308],['tag/classes','collection.php',215],['lib/google/src/Google/Service','AdExchangeBuyer.php',802],['lib/google/src/Google/Service','AdExchangeBuyer.php',906],['lib/google/src/Google/Service','AdExchangeBuyer.php',1013],['lib/google/src/Google/Service','AdExchangeBuyer.php',1181],['lib/google/src/Google/Service','AdExchangeBuyer.php',1357],['lib/google/src/Google/Service','AdExchangeBuyer.php',1640],['lib/google/src/Google/Service','Books.php',2025],['lib/grade','grade_grade.php',1009],['lib/grade','grade_outcome.php',144],['lib/google/src/Google/Service','Analytics.php',2215],['lib/google/src/Google/Service','Analytics.php',2388],['lib/google/src/Google/Service','Analytics.php',2501],['lib/google/src/Google/Service','Analytics.php',2626],['lib/google/src/Google/Service','Analytics.php',2736],['lib/google/src/Google/Service','Analytics.php',2843],['lib/google/src/Google/Service','Analytics.php',2971],['lib/google/src/Google/Service','Analytics.php',3062],['lib/google/src/Google/Service','Analytics.php',3185],['lib/google/src/Google/Service','Analytics.php',3502],['lib/google/src/Google/Service','Analytics.php',3604],['lib/google/src/Google/Service','Analytics.php',3686],['lib/google/src/Google/Service','Coordinate.php',611],['lib/google/src/Google/Service','Coordinate.php',727],['lib/google/src/Google/Service','DeploymentManager.php',589],['tag/classes/output','tagareacollection.php',68],['lib','weblib.php',3312],['lib/google/src/Google/Service','Blogger.php',1349],['lib/google/src/Google/Service','Blogger.php',1647],['lib/google/src/Google/Service','Dataflow.php',350],['tag/classes/output','tagcollname.php',58],['competency/classes','persistent.php',452],['lib/google/src/Google/Service','Cloudresourcemanager.php',344],['lib/google/src/Google/Service','Cloudresourcemanager.php',555],['lib/google/src/Google/Service','TagManager.php',977],['lib/google/src/Google/Service','TagManager.php',1066],['lib/google/src/Google/Service','TagManager.php',1159],['lib/google/src/Google/Service','TagManager.php',1219],['lib/google/src/Google/Service','TagManager.php',1311],['lib/google/src/Google/Service','TagManager.php',1405],['lib/google/src/Google/Service','TagManager.php',1499],['lib/google/src/Google/Service','TagManager.php',1650],['lib/google/src/Google/Service','TagManager.php',1743],['mod/lesson','locallib.php',2691],['lib/google/src/Google/Service','Bigquery.php',621],['lib/google/src/Google/Service','Bigquery.php',953],['lib/google/src/Google/Service','ShoppingContent.php',1136],['lib/google/src/Google/Service','ShoppingContent.php',1238],['lib/google/src/Google/Service','ShoppingContent.php',1401],['lib/google/src/Google/Service','ShoppingContent.php',1534],['mod/lesson/pagetypes','truefalse.php',163],['lib/google/src/Google/Service','Clouddebugger.php',307],['lib/filestorage','stored_file.php',103],['lib/google/src/Google/Service','Container.php',366],['lib/horde/framework/Horde/Support','Array.php',70],['lib/google/src/Google/Service','Storage.php',1127],['lib/google/src/Google/Service','Storage.php',1268],['lib/google/src/Google/Service','Storage.php',1423],['lib/google/src/Google/Service','Storage.php',1564],['lib/google/src/Google/Service','Storage.php',1904],['tag/classes/output','tagname.php',56],['tag/classes/output','tagcollsearchable.php',72],['lib/google/src/Google/Service','Games.php',1508],['lib/google/src/Google/Service','Licensing.php',335],['lib/google/src/Google/Service','Fitness.php',478],['lib/google/src/Google/Service','Fitness.php',691],['lib/google/src/Google/Service','Gmail.php',833],['lib/google/src/Google/Service','Gmail.php',986],['lib/google/src/Google/Service','Taskqueue.php',398],['lib/adodb','adodb-active-recordx.inc.php',1136],['grade/grading/form','lib.php',905],['lib/google/src/Google/Service','Doubleclicksearch.php',326],['lib/google/src/Google/Service','Autoscaler.php',400],['tag/classes/output','tagisstandard.php',70],['lib/google/src/Google/Service','Prediction.php',339],['lib/google/src/Google/Service','SiteVerification.php',227],['lib/google/src/Google/Service','Drive.php',1691],['lib/google/src/Google/Service','Drive.php',1961],['lib/google/src/Google/Service','Drive.php',2208],['lib/google/src/Google/Service','Drive.php',2320],['lib/google/src/Google/Service','Drive.php',2370],['lib/google/src/Google/Service','Drive.php',2494],['lib/google/src/Google/Service','Drive.php',2582],['tag/classes/output','tagflag.php',71],['lib/google/src/Google/Service','Proximitybeacon.php',440],['lib/google/src/Google/Service','Groupssettings.php',138],['lib/google/src/Google/Service','Directory.php',1829],['lib/google/src/Google/Service','Directory.php',1889],['lib/google/src/Google/Service','Directory.php',2141],['lib/google/src/Google/Service','Directory.php',2306],['lib/google/src/Google/Service','Directory.php',2489],['lib/google/src/Google/Service','Directory.php',2597],['lib/google/src/Google/Service','Directory.php',2808],['lib/google/src/Google/Service','Directory.php',2910],['lib/google/src/Google/Service','Directory.php',3131],['lib/google/src/Google/Service','Directory.php',3317],['lib/google/src/Google/Service','Fusiontables.php',727],['lib/google/src/Google/Service','Fusiontables.php',892],['lib/google/src/Google/Service','Fusiontables.php',1094],['lib/google/src/Google/Service','Fusiontables.php',1269],['lib/google/src/Google/Service','AdSenseHost.php',846],['lib/google/src/Google/Service','AdSenseHost.php',1097],['course/classes/output','course_module_name.php',81],['lib/google/src/Google/Service','Mirror.php',496],['lib/google/src/Google/Service','Mirror.php',634],['lib/google/src/Google/Service','Mirror.php',745],['tag/classes','area.php',226],['lib/google/src/Google/Service','AndroidEnterprise.php',1064],['lib/google/src/Google/Service','AndroidEnterprise.php',1165],['lib/google/src/Google/Service','AndroidEnterprise.php',1489],['lib/google/src/Google/Service','AndroidEnterprise.php',1672],['grade/grading/form/rubric','lib.php',828],['lib/xhprof/xhprof_html/jquery','jquery.tooltip.js',200],['mod/lesson/pagetypes','essay.php',158],['lib','coursecatlib.php',438],['tag/classes','tag.php',893],['lib/google/src/Google/Service','Calendar.php',1006],['lib/google/src/Google/Service','Calendar.php',1181],['lib/google/src/Google/Service','Calendar.php',1333],['lib/google/src/Google/Service','Calendar.php',1714],['lib/google/src/Google/Service','PlusDomains.php',692],['lib/google/src/Google/Service','GamesConfiguration.php',334],['lib/google/src/Google/Service','GamesConfiguration.php',473],['mod/lesson/pagetypes','branchtable.php',262],['tag/classes/output','tagareashowstandard.php',64],['lib/google/src/Google/Service','AppState.php',202],['calendar','lib.php',2206],['tag/classes/output','tagareaenabled.php',69],['cohort/classes/output','cohortidnumber.php',53],['lib/google/src/Google/Service','Classroom.php',564],['cohort/classes/output','cohortname.php',53],['lib/google/src/Google/Service','SQLAdmin.php',947],['lib/google/src/Google/Service','SQLAdmin.php',1267],['lib/google/src/Google/Service','SQLAdmin.php',1534],['grade/grading/form/guide','lib.php',836],['lib/google/src/Google/Service','Compute.php',4253],['lib/google/src/Google/Service','Compute.php',4398],['lib/google/src/Google/Service','Compute.php',4767],['lib/google/src/Google/Service','Compute.php',5348],['lib/google/src/Google/Service','Compute.php',5478],['lib/google/src/Google/Service','Compute.php',8131],['lib/google/src/Google/Service','YouTube.php',1959],['lib/google/src/Google/Service','YouTube.php',2194],['lib/google/src/Google/Service','YouTube.php',2303],['lib/google/src/Google/Service','YouTube.php',2429],['lib/google/src/Google/Service','YouTube.php',2570],['lib/google/src/Google/Service','YouTube.php',3111],['lib/google/src/Google/Service','YouTube.php',3348],['lib/google/src/Google/Service','YouTube.php',3518],['lib/google/src/Google/Service','YouTube.php',3708],['lib/google/src/Google/Service','YouTube.php',4400],['lib/google/src/Google/Service','Dfareporting.php',4752],['lib/google/src/Google/Service','Dfareporting.php',4840],['lib/google/src/Google/Service','Dfareporting.php',4973],['lib/google/src/Google/Service','Dfareporting.php',5090],['lib/google/src/Google/Service','Dfareporting.php',5204],['lib/google/src/Google/Service','Dfareporting.php',5400],['lib/google/src/Google/Service','Dfareporting.php',5656],['lib/google/src/Google/Service','Dfareporting.php',5848],['lib/google/src/Google/Service','Dfareporting.php',5970],['lib/google/src/Google/Service','Dfareporting.php',6078],['lib/google/src/Google/Service','Dfareporting.php',6196],['lib/google/src/Google/Service','Dfareporting.php',6502],['lib/google/src/Google/Service','Dfareporting.php',6704],['lib/google/src/Google/Service','Dfareporting.php',6834],['lib/google/src/Google/Service','Dfareporting.php',6912],['lib/google/src/Google/Service','Dfareporting.php',7077],['lib/google/src/Google/Service','Dfareporting.php',7476],['lib/google/src/Google/Service','Dfareporting.php',7594],['lib/google/src/Google/Service','Dfareporting.php',7744],['lib/google/src/Google/Service','Dfareporting.php',7968],['lib/google/src/Google/Service','Dfareporting.php',8075],['lib/google/src/Google/Service','Dfareporting.php',8202],['lib/google/src/Google/Service','Dfareporting.php',8394],['lib/google/src/Google/Service','Dfareporting.php',8557],['lib/google/src/Google/Service','Dfareporting.php',8861],['lib/horde/framework/Horde/Imap/Client/Ids','Map.php',72]], 498],
'process_cdata': ['process_cdata', 'Provide NULL decoding ', [['backup/util/helper','restore_questions_parser_processor.class.php',86],['backup/util/helper','restore_structure_parser_processor.class.php',47],['backup/converter/moodle1','lib.php',730],['backup/util/xml/parser/processors','progressive_parser_processor.class.php',77],['backup/util/helper','restore_users_parser_processor.class.php',77],['backup/util/helper','restore_roles_parser_processor.class.php',66]], 2],
'recode_response': ['recode_response', 'Do any re-coding necessary in the student response. ', [['backup/moodle2','restore_qtype_plugin.class.php',344],['question/type/multianswer/backup/moodle2','restore_qtype_multianswer_plugin.class.php',139],['question/type/match/backup/moodle2','restore_qtype_match_plugin.class.php',183],['question/type/calculatedmulti/backup/moodle2','restore_qtype_calculatedmulti_plugin.class.php',40],['question/type/multichoice/backup/moodle2','restore_qtype_multichoice_plugin.class.php',84]], 1],
'record_exists_sql': ['record_exists_sql', 'Test whether a SQL SELECT statement returns any records. ', [['lib/dml','moodle_database.php',1846]], 52],
'add_plugin_structure': ['add_plugin_structure', 'Add plugin structure to any element in the structure backup tree ', [['backup/util/plan','backup_structure_step.class.php',128],['backup/util/plan/tests/fixtures','plan_fixtures.php',132],['backup/util/plan/tests/fixtures','plan_fixtures.php',149],['backup/util/plan','restore_structure_step.class.php',259]], 48],
'delete_backup_dir': ['delete_backup_dir', 'Given one backupid, delete completely its temp dir ', [['backup/util/helper','backup_helper.class.php',59]], 3],
'get_old_parentid': ['get_old_parentid', 'Returns the latest (parent) old id mapped by one pathelement ', [['backup/moodle2','restore_plugin.class.php',182],['backup/moodle2','restore_subplugin.class.php',114],['backup/util/plan','restore_structure_step.class.php',189]], 32],
'get_recordset_sql': ['get_recordset_sql', 'Get a number of records as an moodle_recordset.  $sql must be a complete SQL query. Since this method is a little less readable, use of it should be restricted to code where it\'s possible there might be large datasets being returned.  For known small datasets use get_records_sql - it leads to simpler code. ', [['lib/dml','pdo_moodle_database.php',252],['lib/dml','oci_native_moodle_database.php',1106],['lib/dml','pgsql_native_moodle_database.php',688],['lib/dml','mssql_native_moodle_database.php',736],['lib/dml','mysqli_native_moodle_database.php',993],['lib/dml','sqlsrv_native_moodle_database.php',811],['lib/dml/tests','dml_test.php',5544]], 283],
'process_course_completion_crit_compl': ['process_course_completion_crit_compl', 'Processes course compltion criteria complete records ', [['backup/moodle2','restore_stepslib.php',2876]], 0],
'upgrade_course_letter_boundary': ['upgrade_course_letter_boundary', 'Marks all courses that require rounded grade items be updated. ', [['lib/db','upgradelib.php',361]], 8],
'process_allowed_module': ['process_allowed_module', '', [['backup/moodle2','restore_stepslib.php',1919]], 0],
'add_evidence': ['add_evidence', 'Create an evidence from a list of parameters. ', [['competency/classes','api.php',4173]], 40],
'gradebook_calculation_freeze': ['gradebook_calculation_freeze', 'Freeze gradebook calculation if needed. ', [['backup/moodle2','restore_stepslib.php',501]], 1],
'filter_set_local_state': ['filter_set_local_state', 'Set the local activated state for a text filter. ', [['lib','filterlib.php',745]], 22],
'process_grade_letter': ['process_grade_letter', '', [['backup/moodle2','restore_stepslib.php',327],['backup/moodle2','restore_stepslib.php',3668]], 0],
'is_viewing': ['is_viewing', 'Returns true if the user has moodle/course:view capability in the course, this is intended for admins, managers (aka small admins), inspectors, etc. ', [['lib','accesslib.php',2005]], 25],
'make_request_directory': ['make_request_directory', 'Create a per-request directory and make sure it is writable. This can only be used during the current request and will be tidied away automatically afterwards. ', [['lib','setuplib.php',1627]], 31],
'get_component_directory': ['get_component_directory', 'Return exact absolute path to a plugin directory. ', [['lib','deprecatedlib.php',226],['lib/classes','component.php',1051]], 51],
'process_criterion': ['process_criterion', '', [['backup/moodle2','restore_stepslib.php',2529]], 0],
'launch_execute_after_restore': ['launch_execute_after_restore', 'Special method, only available in the restore_final_task, able to invoke the restore_plan execute_after_restore() method, so restore_execute_after_restore step will be able to launch all the after_restore() methods of the executed tasks ', [['backup/moodle2','restore_final_task.class.php',115]], 1],
'get_info': ['get_info', 'Returns file information. ', [['lib/filestorage','zip_archive.php',250],['lib','filelib.php',3524],['backup/util/plan','restore_task.class.php',46],['mod/feedback/item/multichoice','lib.php',411],['backup/util/plan','restore_plan.class.php',107],['mod/feedback/item/multichoicerated','lib.php',359],['backup/controller','restore_controller.class.php',317]], 67],
'get_backup_ids_record': ['get_backup_ids_record', '', [['backup/util/dbops','restore_dbops.class.php',1672]], 29],
'set_contextid': ['set_contextid', '', [['backup/moodle2','restore_activity_task.class.php',87],['backup/moodle2','restore_block_task.class.php',129]], 2],
'get_preloaded_information': ['get_preloaded_information', '', [['backup/util/plan','restore_task.class.php',78],['backup/util/plan','restore_plan.class.php',139]], 7],
'restore_user_enrolment': ['restore_user_enrolment', 'Restore user enrolment. ', [['enrol/manual','lib.php',481],['enrol/flatfile','lib.php',692],['lib','enrollib.php',2444],['enrol/self','lib.php',600],['enrol/ldap','lib.php',1129],['enrol/cohort','lib.php',301],['enrol/database','lib.php',960],['enrol/paypal','lib.php',266],['enrol/meta','lib.php',432]], 1],
'update_course_format_options': ['update_course_format_options', 'Updates format options for a course ', [['course/format/weeks','lib.php',327],['course/format','lib.php',777],['course/format','formatlegacy.php',322],['course/format/topics','lib.php',322]], 10],
'get_log_manager': ['get_log_manager', 'Get instance of log manager. ', [['lib','datalib.php',1520]], 51],
'set_field': ['set_field', 'Set a single field in every table record where all the given conditions met. ', [['lib/dml','moodle_database.php',1737],['availability/condition/profile/tests','condition_test.php',349]], 485],
'restore_question_usage_worker': ['restore_question_usage_worker', 'This method does the acutal work for process_question_usage or process_{nameprefix}_question_usage. ', [['backup/moodle2','restore_stepslib.php',5065]], 1],
'enrol_get_plugin': ['enrol_get_plugin', 'Returns instance of enrol plugin ', [['lib','enrollib.php',111]], 156],
'record_exists_select': ['record_exists_select', 'Check if a records exists. ', [['competency/classes','persistent.php',853],['lib/dml','moodle_database.php',1830]], 85],
'add_legacy_availability_field_condition': ['add_legacy_availability_field_condition', 'Adds a condition from the legacy availability field condition. ', [['availability/classes','info.php',545]], 5],
'groups_assign_grouping': ['groups_assign_grouping', 'Assigns group into grouping ', [['group','lib.php',815]], 35],
'build_path': ['build_path', 'Builds this category\'s path string based on its parents (if any) and its own id number. This is typically done just before inserting this object in the DB for the first time, or when a new parent is added or changed. It is a recursive function: once the calling object no longer has a parent, the path is complete. ', [['lib/grade','grade_category.php',163]], 4],
'process_course_competency_settings': ['process_course_competency_settings', 'Process a course competency settings. ', [['backup/moodle2','restore_stepslib.php',3212]], 0],
'restore_recode_legacy_answer': ['restore_recode_legacy_answer', 'Recode the legacy answer field. ', [['backup/moodle2','restore_stepslib.php',5390]], 4],
'list': ['list', '', [['mod/data/preset/imagegallery','jstemplate.js',9]], 2229],
'process_grade_category': ['process_grade_category', '', [['backup/moodle2','restore_stepslib.php',286]], 0],
'upgrade_calculated_grade_items': ['upgrade_calculated_grade_items', 'Marks all courses that require calculated grade items be updated. ', [['lib/db','upgradelib.php',188]], 5],
'set_course_role_names': ['set_course_role_names', 'For the target course context, put as many custom role names as possible ', [['backup/util/dbops','restore_dbops.class.php',1713]], 1],
'add_subplugin_structure': ['add_subplugin_structure', 'Add subplugin structure for a given plugin to any element in the structure backup tree. ', [['backup/util/plan','backup_structure_step.class.php',165],['backup/util/plan/tests/fixtures','plan_fixtures.php',136],['backup/util/plan/tests/fixtures','plan_fixtures.php',153],['backup/util/plan','restore_structure_step.class.php',297]], 46],
'get_contextid': ['get_contextid', '', [['backup/moodle2','backup_block_task.class.php',96],['backup/moodle2','restore_activity_task.class.php',115],['backup/moodle2','restore_block_task.class.php',133],['lib/filebrowser','virtual_root_file.php',182],['lib/filestorage','stored_file.php',652],['backup/moodle2','restore_section_task.class.php',63],['backup/moodle2','backup_course_task.class.php',50],['backup/converter/moodle1','lib.php',524],['backup/moodle2','restore_course_task.class.php',57],['backup/moodle2','backup_activity_task.class.php',103]], 154],
'enrol_try_internal_enrol': ['enrol_try_internal_enrol', 'Try to enrol user via default internal auth plugin. ', [['lib','enrollib.php',903]], 5],
'process_group': ['process_group', '', [['backup/moodle2','restore_stepslib.php',1172],['backup/moodle2','restore_stepslib.php',1304]], 0],
'define_structure': ['define_structure', '', [['mod/survey/backup/moodle2','restore_survey_stepslib.php',34],['mod/page/backup/moodle2','restore_page_stepslib.php',34],['mod/feedback/backup/moodle2','backup_feedback_stepslib.php',33],['mod/lti/backup/moodle2','backup_lti_stepslib.php',56],['mod/book/backup/moodle2','backup_book_stepslib.php',32],['mod/workshop/backup/moodle2','restore_workshop_stepslib.php',33],['mod/label/backup/moodle2','backup_label_stepslib.php',33],['mod/resource/backup/moodle2','backup_resource_stepslib.php',33],['mod/chat/backup/moodle2','restore_chat_stepslib.php',33],['mod/assignment/backup/moodle2','backup_assignment_stepslib.php',34],['backup/moodle2','restore_stepslib.php',143],['backup/moodle2','restore_stepslib.php',725],['backup/moodle2','restore_stepslib.php',1034],['backup/moodle2','restore_stepslib.php',1157],['backup/moodle2','restore_stepslib.php',1292],['backup/moodle2','restore_stepslib.php',1369],['backup/moodle2','restore_stepslib.php',1431],['backup/moodle2','restore_stepslib.php',1545],['backup/moodle2','restore_stepslib.php',1771],['backup/moodle2','restore_stepslib.php',1996],['backup/moodle2','restore_stepslib.php',2151],['backup/moodle2','restore_stepslib.php',2335],['backup/moodle2','restore_stepslib.php',2390],['backup/moodle2','restore_stepslib.php',2473],['backup/moodle2','restore_stepslib.php',2616],['backup/moodle2','restore_stepslib.php',2765],['backup/moodle2','restore_stepslib.php',3020],['backup/moodle2','restore_stepslib.php',3150],['backup/moodle2','restore_stepslib.php',3194],['backup/moodle2','restore_stepslib.php',3341],['backup/moodle2','restore_stepslib.php',3435],['backup/moodle2','restore_stepslib.php',3567],['backup/moodle2','restore_stepslib.php',3721],['backup/moodle2','restore_stepslib.php',3767],['backup/moodle2','restore_stepslib.php',3930],['backup/moodle2','restore_stepslib.php',4194],['backup/moodle2','restore_stepslib.php',4287],['mod/url/backup/moodle2','backup_url_stepslib.php',33],['mod/scorm/backup/moodle2','restore_scorm_stepslib.php',33],['mod/scorm/backup/moodle2','backup_scorm_stepslib.php',33],['mod/assign/backup/moodle2','backup_assign_stepslib.php',36],['mod/url/backup/moodle2','restore_url_stepslib.php',34],['mod/lesson/backup/moodle2','backup_lesson_stepslib.php',65],['mod/imscp/backup/moodle2','restore_imscp_stepslib.php',34],['mod/workshop/backup/moodle2','backup_workshop_stepslib.php',36],['mod/glossary/backup/moodle2','backup_glossary_stepslib.php',34],['mod/forum/backup/moodle2','restore_forum_stepslib.php',34],['backup/util/plan/tests/fixtures','plan_fixtures.php',120],['backup/util/plan/tests/fixtures','plan_fixtures.php',142],['mod/wiki/backup/moodle2','restore_wiki_stepslib.php',34],['mod/folder/backup/moodle2','restore_folder_stepslib.php',34],['blocks/rss_client/backup/moodle2','restore_rss_client_stepslib.php',33],['blocks/rss_client/backup/moodle2','backup_rss_client_stepslib.php',33],['mod/resource/backup/moodle2','restore_resource_stepslib.php',34],['mod/lti/backup/moodle2','restore_lti_stepslib.php',56],['mod/survey/backup/moodle2','backup_survey_stepslib.php',34],['mod/choice/backup/moodle2','backup_choice_stepslib.php',34],['mod/data/backup/moodle2','restore_data_stepslib.php',34],['mod/assignment/backup/moodle2','restore_assignment_stepslib.php',34],['backup/moodle2','backup_stepslib.php',260],['backup/moodle2','backup_stepslib.php',322],['backup/moodle2','backup_stepslib.php',370],['backup/moodle2','backup_stepslib.php',480],['backup/moodle2','backup_stepslib.php',537],['backup/moodle2','backup_stepslib.php',594],['backup/moodle2','backup_stepslib.php',628],['backup/moodle2','backup_stepslib.php',664],['backup/moodle2','backup_stepslib.php',701],['backup/moodle2','backup_stepslib.php',741],['backup/moodle2','backup_stepslib.php',782],['backup/moodle2','backup_stepslib.php',851],['backup/moodle2','backup_stepslib.php',907],['backup/moodle2','backup_stepslib.php',1049],['backup/moodle2','backup_stepslib.php',1107],['backup/moodle2','backup_stepslib.php',1139],['backup/moodle2','backup_stepslib.php',1229],['backup/moodle2','backup_stepslib.php',1391],['backup/moodle2','backup_stepslib.php',1450],['backup/moodle2','backup_stepslib.php',1484],['backup/moodle2','backup_stepslib.php',1520],['backup/moodle2','backup_stepslib.php',1547],['backup/moodle2','backup_stepslib.php',1614],['backup/moodle2','backup_stepslib.php',1657],['backup/moodle2','backup_stepslib.php',1720],['backup/moodle2','backup_stepslib.php',1758],['backup/moodle2','backup_stepslib.php',2178],['backup/moodle2','backup_stepslib.php',2315],['backup/moodle2','backup_stepslib.php',2393],['backup/moodle2','backup_stepslib.php',2485],['backup/moodle2','backup_stepslib.php',2545],['mod/imscp/backup/moodle2','backup_imscp_stepslib.php',35],['mod/folder/backup/moodle2','backup_folder_stepslib.php',33],['mod/chat/backup/moodle2','backup_chat_stepslib.php',28],['mod/quiz/backup/moodle2','restore_quiz_stepslib.php',49],['mod/label/backup/moodle2','restore_label_stepslib.php',34],['mod/forum/backup/moodle2','backup_forum_stepslib.php',34],['mod/quiz/backup/moodle2','backup_quiz_stepslib.php',36],['mod/glossary/backup/moodle2','restore_glossary_stepslib.php',34],['mod/assign/backup/moodle2','restore_assign_stepslib.php',42],['mod/book/backup/moodle2','restore_book_stepslib.php',32],['mod/lesson/backup/moodle2','restore_lesson_stepslib.php',37],['mod/feedback/backup/moodle2','restore_feedback_stepslib.php',33],['mod/choice/backup/moodle2','restore_choice_stepslib.php',34],['mod/wiki/backup/moodle2','backup_wiki_stepslib.php',34],['mod/page/backup/moodle2','backup_page_stepslib.php',36],['mod/data/backup/moodle2','backup_data_stepslib.php',34]], 4],
'invalidate_by_definition': ['invalidate_by_definition', 'Invalidates a given set of keys from a given definition. ', [['cache/classes','helper.php',206]], 35],
'process': ['process', '', [['lib/yuilib/3.17.2/datatable-base','datatable-base.js',370],['backup/moodle2','backup_xml_transformer.class.php',60],['lib/yuilib/3.17.2/datatable-table','datatable-table.js',412],['backup/util/ui','restore_ui.class.php',124],['backup/util/helper','restore_decode_content.class.php',63],['lib','csslib.php',589],['lib/minify/lib/Minify','HTML.php',85],['lib/google/src/Google/Service','MapsEngine.php',1827],['lib/google/src/Google/Service','MapsEngine.php',2436],['lib/google/src/Google/Service','MapsEngine.php',2741],['lib/google/src/Google/Service','MapsEngine.php',3004],['backup/moodle2','backup_custom_fields.php',113],['lib/minify/lib/Minify/CSS','Compressor.php',23],['backup/util/structure','backup_attribute.class.php',34],['course','dnduploadlib.php',449],['message/tests','inbound_test.php',641],['backup/util/interfaces','processable.class.php',35],['lib/editor/tinymce/tiny_mce/3.5.11','tiny_mce_src.js',16782],['lib/editor/tinymce/tiny_mce/3.5.11','tiny_mce_src.js',16881],['lib/editor/tinymce/tiny_mce/3.5.11','tiny_mce_src.js',17049],['backup/util/ui','base_ui.class.php',119],['lib/yuilib/3.17.2/datatable-table','datatable-table-debug.js',412],['backup/util/structure','backup_nested_element.class.php',66],['backup/util/xml/parser','progressive_parser.class.php',145],['lib/pear/HTML','QuickForm.php',1596],['backup/converter/moodle1','lib.php',781],['lib/minify/lib/Minify','ImportProcessor.php',25],['backup/util/plan','restore_structure_step.class.php',117],['backup/util/structure','backup_final_element.class.php',34],['backup/util/structure','backup_optigroup.class.php',59],['backup/util/loggers','base_logger.class.php',115],['lib/google/src/Google/Http','MediaFileUpload.php',222],['lib/yuilib/3.17.2/datatable-core','datatable-core-debug.js',663],['lib/yuilib/3.17.2/datatable-core','datatable-core-debug.js',758],['backup/util/ui','backup_ui_stage.class.php',89],['backup/util/ui','backup_ui_stage.class.php',244],['backup/util/ui','backup_ui_stage.class.php',397],['backup/util/ui','backup_ui_stage.class.php',526],['grade/report/singleview/classes/local/screen','screen.php',260],['lib/minify/lib/Minify','CommentPreserver.php',29],['admin/tool/log/classes/log','manager.php',76],['grade/report/singleview/classes/local/screen','user.php',316],['lib/yuilib/3.17.2/datatable-base','datatable-base-debug.js',370],['backup/util/structure','backup_optigroup_element.class.php',110],['backup/util/helper','restore_log_rule.class.php',100],['grade/report/singleview/classes/local/screen','grade.php',301],['lib/classes/message/inbound','address_manager.php',285],['lib/editor/tinymce/tiny_mce/3.5.11/plugins/paste','editor_plugin_src.js',79],['lib/editor/tinymce/tiny_mce/3.5.11/plugins/paste','editor_plugin_src.js',348],['lib/editor/tinymce/tiny_mce/3.5.11/plugins/paste','editor_plugin_src.js',768],['lib/yuilib/3.17.2/datatable-core','datatable-core.js',663],['lib/yuilib/3.17.2/datatable-core','datatable-core.js',756],['enrol/manual','locallib.php',184],['enrol/manual','locallib.php',344],['lib/jabber/XMPP','XMLStream.php',431],['backup/util/xml/tests','writer_test.php',320],['backup/util/ui','restore_ui_stage.class.php',285],['backup/util/ui','restore_ui_stage.class.php',469],['backup/util/ui','restore_ui_stage.class.php',602],['backup/util/ui','restore_ui_stage.class.php',714],['backup/util/ui','restore_ui_stage.class.php',862],['backup/util/ui','restore_ui_stage.class.php',968],['backup/converter/moodle1','handlerlib.php',562]], 350],
'grade_regrade_final_grades': ['grade_regrade_final_grades', 'Updates all final grades in course. ', [['lib','gradelib.php',1098]], 29],
'add_default_instance': ['add_default_instance', 'Add new instance of enrol plugin with default settings. ', [['enrol/manual','lib.php',123],['lib','enrollib.php',1814],['enrol/self','lib.php',318],['enrol/guest','lib.php',263]], 7],
'process_question': ['process_question', 'Appends the multichoice specific information to the question ', [['question/type/multichoice/backup/moodle1','lib.php',41],['question/type/shortanswer/backup/moodle1','lib.php',41],['backup/moodle2','restore_stepslib.php',4338],['question/type/numerical/backup/moodle1','lib.php',42],['question/type/essay/backup/moodle1','lib.php',38],['question/type/match/backup/moodle1','lib.php',40],['question/type/calculated/backup/moodle1','lib.php',44],['question/type/truefalse/backup/moodle1','lib.php',41],['question/type/multianswer/backup/moodle1','lib.php',41],['question/type/randomsamatch/backup/moodle1','lib.php',47],['lib/tests/behat','behat_data_generators.php',560],['backup/converter/moodle1','handlerlib.php',1162],['backup/converter/moodle1','handlerlib.php',1746]], 1],
'set_old_blockid': ['set_old_blockid', '', [['backup/moodle2','restore_block_task.class.php',121]], 1],
'process_question_hint': ['process_question_hint', '', [['backup/moodle2','restore_stepslib.php',4392]], 0],
'convert_legacy_fields': ['convert_legacy_fields', 'Converts legacy data from fields (if provided) into the new availability syntax. ', [['availability/classes','info.php',449]], 11],
'get_comment_mapping_itemname': ['get_comment_mapping_itemname', 'Given a commment area, return the itemname that contains the itemid mappings ', [['backup/moodle2','restore_activity_task.class.php',231],['mod/assign/backup/moodle2','restore_assign_activity_task.class.php',123],['mod/data/backup/moodle2','restore_data_activity_task.class.php',124]], 3],
'set_backup_files_record': ['set_backup_files_record', '', [['backup/util/dbops','restore_dbops.class.php',1647]], 1],
'get_components_and_fileareas': ['get_components_and_fileareas', 'Returns all the components and fileareas used by all the installed qtypes ', [['backup/moodle2','backup_qtype_plugin.class.php',163]], 2],
'purge_by_event': ['purge_by_event', 'Purges a cache of all information on a given event. ', [['cache/classes','helper.php',303]], 30],
'get_configdata_encoded_attributes': ['get_configdata_encoded_attributes', '', [['blocks/quiz_results/backup/moodle2','restore_quiz_results_block_task.class.php',46],['backup/moodle2','restore_default_block_task.class.php',49],['blocks/html/backup/moodle2','backup_html_block_task.class.php',42],['blocks/html/backup/moodle2','restore_html_block_task.class.php',42],['blocks/rss_client/backup/moodle2','backup_rss_client_block_task.class.php',46],['blocks/activity_results/backup/moodle2','restore_activity_results_block_task.class.php',55],['blocks/rss_client/backup/moodle2','restore_rss_client_block_task.class.php',46],['blocks/tags/backup/moodle2','restore_tags_block_task.class.php',43],['blocks/glossary_random/backup/moodle2','restore_glossary_random_block_task.class.php',42],['backup/moodle2','backup_default_block_task.class.php',50]], 4],
'matching_page_type_patterns_from_pattern': ['matching_page_type_patterns_from_pattern', 'Give an specific pattern, return all the page type patterns that would also match it. ', [['lib','blocklib.php',1753]], 13],
'has_capability': ['has_capability', 'Wrapper round the has_capability funciton that automatically passes in the quiz context. ', [['mod/quiz','attemptlib.php',299],['mod/quiz','attemptlib.php',922],['lib','accesslib.php',344]], 2064],
'fix_duplicate_sortorder': ['fix_duplicate_sortorder', 'Detect duplicate grade item\'s sortorder and re-sort them. Note: Duplicate sortorder will be introduced while duplicating activities or merging two courses. ', [['lib/grade','grade_item.php',1348]], 2],
'get_included_tasks': ['get_included_tasks', 'Return one array containing all the tasks that have been included in the restore process. Note that these tasks aren\'t built (they haven\'t steps nor ids data available) ', [['backup/util/dbops','restore_dbops.class.php',64]], 2],
'get_fast_modinfo': ['get_fast_modinfo', 'Returns reference to full info about modules in course (including visibility). Cached and as fast as possible (0 or 1 db query). ', [['lib','modinfolib.php',1977]], 289],
'get_section_info_all': ['get_section_info_all', 'Gets all sections as array from section number => data about section. ', [['lib','modinfolib.php',303]], 27],
'save_usage': ['save_usage', '', [['question/engine/upgrade','upgradelib.php',49]], 1],
'restore_group_member': ['restore_group_member', 'Restore user group membership. ', [['enrol/manual','lib.php',546],['lib','enrollib.php',2469],['enrol/cohort','lib.php',326],['enrol/meta','lib.php',460]], 1],
'is_enrolled': ['is_enrolled', 'Returns true if user is enrolled (is participating) in course this is intended for students and teachers. ', [['lib','accesslib.php',2038]], 145],
'load_question': ['load_question', 'Load a question definition from the database. The object returned will actually be of an appropriate {@link question_definition} subclass. ', [['question/engine','bank.php',258],['question/type/randomsamatch/db','upgradelib.php',240],['question/engine/upgrade','upgradelib.php',133],['question/engine/upgrade','upgradelib.php',287],['question/engine/upgrade/tests','helper.php',63]], 47],
'process_availability': ['process_availability', 'Process the legacy availability table record. This table does not exist in Moodle 2.7+ but we still support restore. ', [['backup/moodle2','restore_stepslib.php',1644],['backup/moodle2','restore_stepslib.php',4073]], 0],
'process_course_completion_criteria': ['process_course_completion_criteria', 'Process course completion criteria ', [['backup/moodle2','restore_stepslib.php',2788]], 0],
'fetch_course_category': ['fetch_course_category', 'Return the course level grade_category object ', [['lib/grade','grade_category.php',2451]], 21],
'process_question_category': ['process_question_category', '', [['backup/moodle2','restore_stepslib.php',4305],['lib/tests/behat','behat_data_generators.php',549],['backup/converter/moodle1','handlerlib.php',1117]], 0],
'get_basepath': ['get_basepath', '', [['backup/util/plan','backup_plan.class.php',82],['backup/util/plan','restore_plan.class.php',89],['backup/util/plan','base_step.class.php',112],['backup/util/plan','base_task.class.php',113]], 36],
'record_exists': ['record_exists', 'Check if a record exists by ID. ', [['competency/classes','persistent.php',842],['lib/dml','moodle_database.php',1817]], 901],
'set_old_moduleversion': ['set_old_moduleversion', '', [['backup/moodle2','restore_activity_task.class.php',75]], 1],
'questions_recode_layout': ['questions_recode_layout', 'Given a list of question->ids, separated by commas, returns the recoded list, with all the restore question mappings applied. Note: Used by quiz->questions and quiz_attempts->layout Note: 0 = page break (unconverted) ', [['backup/moodle2','restore_stepslib.php',5191]], 1],
'delete_old_backup_dirs': ['delete_old_backup_dirs', 'Delete all the temp dirs older than the time specified. ', [['backup/util/helper','backup_helper.class.php',150]], 2],
'get_mapping': ['get_mapping', 'Simply map each itemid by its double ', [['backup/util/helper/tests','decode_test.php',177],['backup/moodle2','restore_plugin.class.php',207],['backup/moodle2','restore_subplugin.class.php',139],['backup/util/plan','restore_structure_step.class.php',215],['backup/util/helper','restore_decode_rule.class.php',107]], 8],
'process_category': ['process_category', 'Add a category question entry based on the assessment title ', [['question/format/blackboard_six','formatqti.php',880],['question/format/blackboard_six','formatpool.php',119],['backup/moodle2','restore_stepslib.php',1906]], 2],
'get_progress': ['get_progress', '', [['backup/util/plan/tests/fixtures','plan_fixtures.php',39],['backup/util/plan','backup_plan.class.php',90],['backup/util/plan','restore_plan.class.php',97],['backup/controller','base_controller.class.php',36],['backup/util/plan','base_task.class.php',125]], 35],
'process_completion': ['process_completion', '', [['backup/moodle2','restore_stepslib.php',4203]], 0],
'get_parent_context_ids': ['get_parent_context_ids', 'Returns parent contexts of this context in reversed order, i.e. parent first, then grand parent, etc. ', [['lib','accesslib.php',5725]], 55],
'load_categories_and_questions_to_tempids': ['load_categories_and_questions_to_tempids', 'Load the needed questions.xml file to backup_ids table for future reference ', [['backup/util/dbops','restore_dbops.class.php',451]], 2],
'enrol_get_plugins': ['enrol_get_plugins', 'Returns instances of enrol plugins ', [['lib','enrollib.php',70]], 45],
'start_progress': ['start_progress', 'Marks the start of an operation that will display progress. ', [['lib/classes/progress','base.php',77]], 85],
'calculate_course_names': ['calculate_course_names', 'Given on courseid, fullname and shortname, calculate the correct fullname/shortname to avoid dupes ', [['backup/util/dbops','restore_dbops.class.php',1683]], 2],
'set_backup_ids_record': ['set_backup_ids_record', '', [['backup/util/dbops','restore_dbops.class.php',1656]], 30],
'load_users_to_tempids': ['load_users_to_tempids', 'Load the needed users.xml file to backup_ids table for future reference ', [['backup/util/dbops','restore_dbops.class.php',419]], 2],
'get_file_storage': ['get_file_storage', 'Returns local file storage instance ', [['lib','moodlelib.php',6144]], 546],
'inform_new_usage_id': ['inform_new_usage_id', '', [['mod/quiz/backup/moodle2','restore_quiz_stepslib.php',403]], 3],
'drop_restore_temp_tables': ['drop_restore_temp_tables', '', [['backup/util/dbops','restore_controller_dbops.class.php',119]], 4],
'get_sectionid': ['get_sectionid', '', [['backup/moodle2','backup_section_task.class.php',56],['backup/moodle2','restore_section_task.class.php',67],['backup/moodle2','backup_activity_task.class.php',82]], 6],
'is_samesite': ['is_samesite', '', [['backup/util/plan','restore_task.class.php',62],['backup/util/plan','restore_plan.class.php',123],['backup/controller','restore_controller.class.php',293]], 21],
'rebuild_course_cache': ['rebuild_course_cache', 'Rebuilds or resets the cached list of course activities stored in MUC. ', [['lib','modinfolib.php',2179]], 40],
'process_course_competency': ['process_course_competency', 'Process a course competency. ', [['backup/moodle2','restore_stepslib.php',3242]], 0],
'process_block': ['process_block', '', [['blocks/rss_client/backup/moodle1','lib.php',31],['question/format/blackboard_six','formatqti.php',250],['backup/moodle2','restore_stepslib.php',3777],['blocks/rss_client/backup/moodle2','restore_rss_client_stepslib.php',44],['backup/converter/moodle1','handlerlib.php',2062]], 10],
'create_restore_temp_tables': ['create_restore_temp_tables', '', [['backup/util/dbops','restore_controller_dbops.class.php',105]], 5],
'is_excluding_activities': ['is_excluding_activities', '', [['backup/util/plan','backup_task.class.php',46],['backup/util/plan','backup_plan.class.php',100],['backup/util/plan','restore_task.class.php',70],['backup/util/plan','restore_plan.class.php',131]], 8],
'get_id': ['get_id', 'Getter for $id. ', [['lib/classes/task','adhoc_task.php',51],['backup/converter','convertlib.php',100],['lib/filebrowser','virtual_root_file.php',290],['lib','adminlib.php',1719],['admin/tool/uploadcourse/classes','course.php',335],['lib/simplepie/library/SimplePie','Item.php',199],['lib/filestorage','stored_file.php',786],['cache/classes','definition.php',613],['grade/grading/form','lib.php',854],['question/engine','questionusage.php',120],['mod/lti/classes/local/ltiservice','service_base.php',76],['blocks/rss_client/classes/output','item.php',152],['backup/controller','backup_controller.class.php',263],['question/engine','questionattemptstep.php',136],['mod/lti/classes/local/ltiservice','resource_base.php',81]], 2250],
'add_item_tag': ['add_item_tag', 'Adds a tag to an item, without overwriting the current tags. ', [['tag/classes','tag.php',748]], 14],
'set_blockname': ['set_blockname', '', [['backup/moodle2','restore_block_task.class.php',105]], 1],
'process_member': ['process_member', '', [['backup/moodle2','restore_stepslib.php',1314]], 0],
'recode_legacy_state_answer': ['recode_legacy_state_answer', 'Decode legacy question_states.answer for this qtype. Used when restoring 2.0 attempt data. ', [['backup/moodle2','restore_qtype_plugin.class.php',355],['question/type/multianswer/backup/moodle2','restore_qtype_multianswer_plugin.class.php',165],['question/type/random/backup/moodle2','restore_qtype_random_plugin.class.php',63],['question/type/randomsamatch/backup/moodle2','restore_qtype_randomsamatch_plugin.class.php',100],['question/type/truefalse/backup/moodle2','restore_qtype_truefalse_plugin.class.php',82],['question/type/match/backup/moodle2','restore_qtype_match_plugin.class.php',193],['question/type/calculatedmulti/backup/moodle2','restore_qtype_calculatedmulti_plugin.class.php',45],['question/type/multichoice/backup/moodle2','restore_qtype_multichoice_plugin.class.php',106]], 1],
'process_enrol': ['process_enrol', 'Create enrolment instances. ', [['backup/moodle2','restore_stepslib.php',2161]], 0],
'restore_role_assignment': ['restore_role_assignment', 'Restore role assignment. ', [['enrol/manual','lib.php',532],['enrol/flatfile','lib.php',705],['lib','enrollib.php',2457],['enrol/self','lib.php',613],['enrol/ldap','lib.php',1156],['enrol/database','lib.php',981]], 1],
'enrol_course_updated': ['enrol_course_updated', 'Update enrol instances after course edit form submission ', [['lib','enrollib.php',364]], 3],
'is_enabled': ['is_enabled', 'Tools cannot be disabled. ', [['lib/classes/plugininfo','tool.php',39],['admin/tool/recyclebin/classes','category_bin.php',54],['admin/tool/log/classes/plugininfo','logstore.php',35],['admin/tool/recyclebin/classes','course_bin.php',54],['mod/assign/feedback/offline','locallib.php',380],['admin/tool/recyclebin/classes','base_bin.php',38],['lib','adminlib.php',1955],['search/classes','base.php',190],['lib','medialib.php',318],['lib','medialib.php',635],['lib','medialib.php',1268],['admin/tool/health','index.php',393],['lib/classes/plugininfo','mnetservice.php',33],['lib/classes/message/inbound','manager.php',37],['mod/assignment/classes/plugininfo','assignment.php',32],['competency/classes','api.php',49],['mod/assign','assignmentplugin.php',223],['lib/classes/plugininfo','orphaned.php',37],['search/tests/fixtures','mock_search_area.php',38],['tag/classes','area.php',106],['lib/classes/plugininfo','base.php',383],['mod/assign/feedback/editpdf','locallib.php',340],['tag/classes','tag.php',1269],['mod/assign/submission/comments','locallib.php',172],['lib','completionlib.php',269]], 276],
'filter_set_local_config': ['filter_set_local_config', 'Set a particular local config variable for a filter in a context. ', [['lib','filterlib.php',790]], 27],
'set_old_contextid': ['set_old_contextid', '', [['backup/moodle2','restore_activity_task.class.php',91],['backup/moodle2','restore_block_task.class.php',137]], 2],
'process_override': ['process_override', '', [['backup/moodle2','restore_stepslib.php',2073]], 0],
'get_recordset': ['get_recordset', 'Get the recordset. ', [['mod/glossary/classes','entry_query_builder.php',305],['lib/dml','moodle_database.php',1162]], 92],
'get_moduleid': ['get_moduleid', '', [['backup/moodle2','backup_block_task.class.php',88],['backup/moodle2','restore_activity_task.class.php',99],['backup/moodle2','backup_activity_task.class.php',75]], 16],
'process_active': ['process_active', '', [['backup/moodle2','restore_stepslib.php',2345]], 0],
'set_config': ['set_config', 'Set a key in global configuration ', [['lib','moodlelib.php',1336],['lib','enrollib.php',1153],['lib/editor/tinymce/classes','plugin.php',84],['mod/assign','assignmentplugin.php',314],['lib/portfolio','plugin.php',515]], 1119],
'execute_condition': ['execute_condition', 'To conditionally decide if one step will be executed or no ', [['backup/util/plan','backup_structure_step.class.php',246],['backup/moodle2','restore_stepslib.php',83],['backup/moodle2','restore_stepslib.php',689],['backup/moodle2','restore_stepslib.php',2125],['backup/moodle2','restore_stepslib.php',2431],['backup/moodle2','restore_stepslib.php',2709],['backup/moodle2','restore_stepslib.php',2998],['backup/moodle2','restore_stepslib.php',3128],['backup/moodle2','restore_stepslib.php',3313],['backup/moodle2','restore_stepslib.php',3388],['backup/moodle2','restore_stepslib.php',3416],['backup/moodle2','restore_stepslib.php',3559],['backup/moodle2','restore_stepslib.php',3704],['backup/moodle2','restore_stepslib.php',4164],['backup/util/plan','restore_structure_step.class.php',528],['backup/moodle2','backup_stepslib.php',472],['backup/moodle2','backup_stepslib.php',774],['backup/moodle2','backup_stepslib.php',893],['backup/moodle2','backup_stepslib.php',1034],['backup/moodle2','backup_stepslib.php',1099],['backup/moodle2','backup_stepslib.php',1593],['backup/moodle2','backup_stepslib.php',1635],['backup/moodle2','backup_stepslib.php',2302],['backup/moodle2','backup_stepslib.php',2385],['backup/moodle2','backup_stepslib.php',2477],['backup/moodle2','backup_stepslib.php',2531]], 2],
'get_courseid': ['get_courseid', 'Id of the current course (for site feedbacks only) ', [['mod/feedback/classes','structure.php',80],['course/format','lib.php',222],['mod/quiz','attemptlib.php',175],['mod/quiz','attemptlib.php',717],['backup/util/plan','backup_plan.class.php',78],['comment','lib.php',1002],['mod/quiz/classes','structure.php',228],['question/classes/bank','view.php',217],['backup/util/plan','restore_plan.class.php',81],['backup/controller','backup_controller.class.php',267],['backup/util/plan','base_step.class.php',105],['backup/controller','restore_controller.class.php',269],['backup/util/plan','base_task.class.php',109]], 244],
'restore_instance': ['restore_instance', 'Restore instance and map settings. ', [['enrol/manual','lib.php',461],['enrol/flatfile','lib.php',673],['lib','enrollib.php',2431],['enrol/self','lib.php',563],['enrol/ldap','lib.php',1109],['enrol/cohort','lib.php',244],['enrol/database','lib.php',941],['enrol/lti','lib.php',388],['enrol/paypal','lib.php',236],['enrol/guest','lib.php',278],['enrol/meta','lib.php',393]], 1],
'process_course_completions': ['process_course_completions', 'Process course completions ', [['backup/moodle2','restore_stepslib.php',2910]], 0],
'update_record': ['update_record', 'Update a record in a table ', [['lib/dml','pdo_moodle_database.php',461],['lib/dml','oci_native_moodle_database.php',1404],['lib/dml','pgsql_native_moodle_database.php',1089],['lib/dml','mssql_native_moodle_database.php',1067],['lib/dml','mysqli_native_moodle_database.php',1405],['lib/dml','sqlsrv_native_moodle_database.php',1148],['lib/dml/tests','dml_test.php',5551]], 650],
'get_old_system_contextid': ['get_old_system_contextid', '', [['backup/util/plan','restore_task.class.php',94]], 5],
'get_task': ['get_task', 'As far as backup structure steps are implementing backup_plugin stuff, they need to have the parent task available for wrapping purposes (get course/context....) ', [['backup/util/plan','backup_structure_step.class.php',118],['backup/util/plan','restore_structure_step.class.php',248]], 31],
'describe_alias': ['describe_alias', 'Return a human readable description of the alias file ', [['backup/moodle2','restore_stepslib.php',4929]], 2],
'get_activityid': ['get_activityid', '', [['backup/moodle2','restore_activity_task.class.php',107],['backup/moodle2','backup_activity_task.class.php',96]], 13],
'debugging': ['debugging', 'Standard Debugging Function ', [['lib','weblib.php',3012]], 1007],
'get_mappingid': ['get_mappingid', 'Return the new id of a mapping for the given itemname ', [['backup/moodle2','restore_plugin.class.php',196],['backup/moodle2','restore_subplugin.class.php',128],['backup/util/plan','restore_structure_step.class.php',203]], 224],
'get_record_sql': ['get_record_sql', 'Get a single database record as an object using a SQL statement. ', [['lib/dml','oci_native_moodle_database.php',1076],['lib/dml','moodle_database.php',1506]], 157],
'grade_verify_idnumber': ['grade_verify_idnumber', 'Verify new value of grade item idnumber. Checks for uniqueness of new ID numbers. Old ID numbers are kept intact. ', [['lib','gradelib.php',962]], 5],
'process_enrolment': ['process_enrolment', 'Create user enrolments. ', [['backup/moodle2','restore_stepslib.php',2239]], 0],
'get_list_of_themes': ['get_list_of_themes', 'Returns a list of valid and compatible themes ', [['lib','moodlelib.php',6929]], 7],
'process_logstore': ['process_logstore', 'Process the \'logstore\' element, ', [['backup/moodle2','restore_stepslib.php',3168]], 0],
'get_restoreid': ['get_restoreid', 'Gets the restore id from the controller ', [['backup/util/ui','restore_ui.class.php',167],['backup/moodle2','restore_plugin.class.php',162],['backup/moodle2','restore_subplugin.class.php',94],['backup/util/plan','restore_task.class.php',42],['backup/util/plan','restore_plan.class.php',77],['backup/util/plan','restore_step.class.php',42],['backup/util/ui','restore_ui_stage.class.php',51],['backup/controller','restore_controller.class.php',257]], 87],
'get_modulename': ['get_modulename', '', [['backup/moodle2','backup_block_task.class.php',92],['lib/testing/generator','module_generator.php',54],['backup/moodle2','restore_activity_task.class.php',95],['backup/util/plan/tests/fixtures','plan_fixtures.php',85],['backup/util/plan/tests/fixtures','plan_fixtures.php',110],['backup/moodle2','backup_activity_task.class.php',89]], 26],
'get_in_or_equal': ['get_in_or_equal', 'Constructs \'IN()\' or \'=\' sql fragment ', [['lib/dml','oci_native_moodle_database.php',1635],['lib/dml','moodle_database.php',711]], 438],
'restore_question_attempt_step_worker': ['restore_question_attempt_step_worker', 'This method does the acutal work for process_question_attempt_step or process_{nameprefix}_question_attempt_step. ', [['backup/moodle2','restore_stepslib.php',5131]], 1],
'reset_caches': ['reset_caches', 'This implementation does not use any caches. ', [['lib/classes','string_manager_install.php',245],['lib/classes','plugin_manager.php',115],['lib/classes/update','checker.php',74],['backup/moodle2','restore_stepslib.php',1538],['tag/classes','index_builder.php',367],['repository','lib.php',2636],['lib/dml','moodle_database.php',1052],['lib/classes','filetypes.php',419],['lib','accesslib.php',5149],['lib','accesslib.php',6045],['mod/glossary/classes/local','concept_cache.php',49],['lib/classes','string_manager_standard.php',599],['lib/classes','string_manager.php',127],['lib','filterlib.php',97],['lib/classes','text.php',108],['lib/classes','user.php',486]], 111],
'process_categories_and_questions': ['process_categories_and_questions', 'Process the needed question categories and questions to check all them, deciding about the action to perform (create/map) and target. ', [['backup/util/dbops','restore_dbops.class.php',1626]], 1],
'get_string_manager': ['get_string_manager', 'Returns current string_manager instance. ', [['lib','moodlelib.php',6678]], 163],
'process_availability_field': ['process_availability_field', 'Process the legacy availability fields table record. This table does not exist in Moodle 2.7+ but we still support restore. ', [['backup/moodle2','restore_stepslib.php',1660],['backup/moodle2','restore_stepslib.php',4088]], 0],
'get_field': ['get_field', 'Gets an instance of the form field. ', [['lib/behat','behat_field_manager.php',248],['mod/quiz/report/statistics/classes','calculated.php',109],['lib/dml','moodle_database.php',1546],['user/filters','lib.php',124]], 536],
'get_new_parentid': ['get_new_parentid', 'Returns the latest (parent) new id mapped by one pathelement ', [['backup/moodle2','restore_plugin.class.php',189],['backup/moodle2','restore_subplugin.class.php',121],['backup/util/plan','restore_structure_step.class.php',196]], 148],
'pack_reference': ['pack_reference', 'When user referring to a moodle file, we build the reference field ', [['lib/filestorage','file_storage.php',2197]], 19],
'get_old_activityid': ['get_old_activityid', '', [['backup/moodle2','restore_activity_task.class.php',111]], 2],
'load_inforef_to_tempids': ['load_inforef_to_tempids', 'Load one inforef.xml file to backup_ids table for future reference ', [['backup/util/dbops','restore_dbops.class.php',112]], 2],
'count_records_sql': ['count_records_sql', 'Get the result of a SQL SELECT COUNT(...) query. ', [['lib/dml','moodle_database.php',1796]], 155],
'get_fileareas': ['get_fileareas', '', [['blocks/quiz_results/backup/moodle2','restore_quiz_results_block_task.class.php',42],['backup/moodle2','restore_default_block_task.class.php',45],['blocks/html/backup/moodle2','backup_html_block_task.class.php',38],['blocks/html/backup/moodle2','restore_html_block_task.class.php',38],['blocks/rss_client/backup/moodle2','backup_rss_client_block_task.class.php',42],['blocks/activity_results/backup/moodle2','restore_activity_results_block_task.class.php',48],['blocks/rss_client/backup/moodle2','restore_rss_client_block_task.class.php',42],['blocks/tags/backup/moodle2','restore_tags_block_task.class.php',39],['blocks/glossary_random/backup/moodle2','restore_glossary_random_block_task.class.php',38],['backup/moodle2','backup_default_block_task.class.php',46]], 4],
'register_link_decoders': ['register_link_decoders', 'Adds all the course/section/activity/block contents and rules ', [['backup/util/helper','restore_decode_processor.class.php',100]], 1],
'after_execute': ['after_execute', '', [['mod/survey/backup/moodle2','restore_survey_stepslib.php',91],['mod/page/backup/moodle2','restore_page_stepslib.php',56],['mod/workshop/backup/moodle2','restore_workshop_stepslib.php',210],['mod/chat/backup/moodle2','restore_chat_stepslib.php',78],['backup/moodle2','restore_stepslib.php',372],['backup/moodle2','restore_stepslib.php',1272],['backup/moodle2','restore_stepslib.php',1418],['backup/moodle2','restore_stepslib.php',1487],['backup/moodle2','restore_stepslib.php',1742],['backup/moodle2','restore_stepslib.php',1929],['backup/moodle2','restore_stepslib.php',2605],['backup/moodle2','restore_stepslib.php',2701],['backup/moodle2','restore_stepslib.php',3540],['backup/moodle2','restore_stepslib.php',4474],['backup/moodle2','restore_stepslib.php',5232],['mod/scorm/backup/moodle2','restore_scorm_stepslib.php',190],['mod/url/backup/moodle2','restore_url_stepslib.php',56],['mod/imscp/backup/moodle2','restore_imscp_stepslib.php',57],['mod/forum/backup/moodle2','restore_forum_stepslib.php',208],['mod/wiki/backup/moodle2','restore_wiki_stepslib.php',174],['mod/folder/backup/moodle2','restore_folder_stepslib.php',62],['backup/util/plan','restore_structure_step.class.php',453],['mod/resource/backup/moodle2','restore_resource_stepslib.php',57],['mod/lti/backup/moodle2','restore_lti_stepslib.php',93],['mod/data/backup/moodle2','restore_data_stepslib.php',154],['mod/assignment/backup/moodle2','restore_assignment_stepslib.php',141],['mod/quiz/backup/moodle2','restore_quiz_stepslib.php',417],['mod/label/backup/moodle2','restore_label_stepslib.php',56],['mod/glossary/backup/moodle2','restore_glossary_stepslib.php',159],['mod/assign/backup/moodle2','restore_assign_stepslib.php',337],['mod/book/backup/moodle2','restore_book_stepslib.php',75],['mod/lesson/backup/moodle2','restore_lesson_stepslib.php',240],['mod/feedback/backup/moodle2','restore_feedback_stepslib.php',119],['mod/choice/backup/moodle2','restore_choice_stepslib.php',94]], 3],
'process_grading_definition': ['process_grading_definition', 'Processes one grading definition element ', [['backup/moodle2','restore_stepslib.php',3485]], 0],
'get_decoder': ['get_decoder', '', [['backup/util/plan','restore_task.class.php',58],['backup/util/plan','restore_plan.class.php',119]], 2],
'get_record': ['get_record', 'Load a single record. ', [['competency/classes','persistent.php',738],['lib/dml','moodle_database.php',1462]], 3224],
'notify_failure': ['notify_failure', 'Let the user know that the given alias can\'t be restored ', [['backup/moodle2','restore_stepslib.php',4914]], 8],
'process_attributes': ['process_attributes', '', [['backup/moodle2','restore_stepslib.php',159]], 0],
'prepare_activity_structure': ['prepare_activity_structure', 'Adds support for the \'activity\' path that is common to all the activities and will be processed globally here ', [['backup/moodle2','restore_stepslib.php',4238],['backup/moodle2','backup_stepslib.php',98]], 45],
'upgrade_group_members_only': ['upgrade_group_members_only', 'Using data for a single course-module that has groupmembersonly enabled, returns the new availability value that incorporates the correct groupmembersonly option. ', [['lib/db','upgradelib.php',79]], 2],
'add_legacy_question_attempt_data': ['add_legacy_question_attempt_data', 'Attach below $element (usually attempts) the needed restore_path_elements to restore question attempt data from Moodle 2.0. ', [['backup/moodle2','restore_stepslib.php',5241]], 1],
'process_grade_item': ['process_grade_item', '', [['backup/moodle2','restore_stepslib.php',174],['backup/moodle2','restore_stepslib.php',3581]], 0],
'prepare_to_restore': ['prepare_to_restore', '', [['question/engine/upgrade','upgradelib.php',265]], 1],
'count_records': ['count_records', 'Count a list of records. ', [['competency/classes','persistent.php',815],['mod/glossary/classes','entry_query_builder.php',152],['lib/dml','moodle_database.php',1766]], 1630],
'block_instance': ['block_instance', 'Creates a new instance of the specified block class. ', [['lib','blocklib.php',1672]], 13],
'get_tempdir': ['get_tempdir', '', [['backup/util/plan','restore_task.class.php',82],['backup/util/plan','restore_plan.class.php',143],['backup/controller','restore_controller.class.php',253]], 5],
'set_old_activityid': ['set_old_activityid', '', [['backup/moodle2','restore_activity_task.class.php',83]], 1],
'insert': ['insert', 'Inserts a data transfer request. (transfers.insert) ', [['lib/google/src/Google/Service','DataTransfer.php',223],['lib/grade','grade_item.php',427],['lib/google/src/Google/Service','Replicapool.php',438],['lib/google/src/Google/Service','Tasks.php',337],['lib/google/src/Google/Service','Tasks.php',457],['lib/google/src/Google/Service','AndroidPublisher.php',1264],['lib/google/src/Google/Service','AndroidPublisher.php',2113],['lib/google/src/Google/Service','Reseller.php',310],['lib/google/src/Google/Service','Reseller.php',474],['lib/google/src/Google/Service','Computeaccounts.php',527],['lib/google/src/Google/Service','Computeaccounts.php',698],['lib/grade','grade_category.php',340],['lib/grade','grade_scale.php',111],['lib/adodb','adodb-active-record.inc.php',848],['lib/grade','grade_object.php',325],['lib/google/src/Google/Service','YouTubeAnalytics.php',379],['lib/google/src/Google/Service','YouTubeAnalytics.php',474],['lib/google/src/Google/Service','Admin.php',88],['lib/google/src/Google/Service','MapsEngine.php',2781],['lib/google/src/Google/Service','MapsEngine.php',3185],['completion','data_object.php',317],['lib/google/src/Google/Service','Urlshortener.php',125],['lib/google/src/Google/Service','AdExchangeBuyer.php',967],['lib/google/src/Google/Service','AdExchangeBuyer.php',1057],['lib/google/src/Google/Service','AdExchangeBuyer.php',1152],['lib/google/src/Google/Service','AdExchangeBuyer.php',1209],['lib/google/src/Google/Service','AdExchangeBuyer.php',1307],['lib/google/src/Google/Service','AdExchangeBuyer.php',1389],['lib/google/src/Google/Service','AdExchangeBuyer.php',1431],['lib/google/src/Google/Service','AdExchangeBuyer.php',1485],['lib/google/src/Google/Service','AdExchangeBuyer.php',1591],['lib/google/src/Google/Service','Books.php',1961],['lib/grade','grade_grade.php',997],['lib/grade','grade_outcome.php',120],['lib/google/src/Google/Service','Analytics.php',2179],['lib/google/src/Google/Service','Analytics.php',2325],['lib/google/src/Google/Service','Analytics.php',2439],['lib/google/src/Google/Service','Analytics.php',2567],['lib/google/src/Google/Service','Analytics.php',2685],['lib/google/src/Google/Service','Analytics.php',2780],['lib/google/src/Google/Service','Analytics.php',2907],['lib/google/src/Google/Service','Analytics.php',3017],['lib/google/src/Google/Service','Analytics.php',3124],['lib/google/src/Google/Service','Analytics.php',3263],['lib/google/src/Google/Service','Analytics.php',3441],['lib/google/src/Google/Service','Analytics.php',3548],['lib/google/src/Google/Service','Analytics.php',3646],['lib/google/src/Google/Service','Coordinate.php',524],['lib/google/src/Google/Service','DeploymentManager.php',483],['lib/google/src/Google/Service','Blogger.php',1258],['lib/google/src/Google/Service','Blogger.php',1510],['lib/google/src/Google/Service','CloudUserAccounts.php',674],['lib/google/src/Google/Service','CloudUserAccounts.php',939],['lib/google/src/Google/Service','Replicapoolupdater.php',355],['lib/google/src/Google/Service','Bigquery.php',567],['lib/google/src/Google/Service','Bigquery.php',709],['lib/google/src/Google/Service','Bigquery.php',897],['lib/google/src/Google/Service','ShoppingContent.php',1081],['lib/google/src/Google/Service','ShoppingContent.php',1479],['lib/google/src/Google/Service','ShoppingContent.php',2001],['lib/google/src/Google/Service','GroupsMigration.php',88],['lib/google/src/Google/Service','Storage.php',1077],['lib/google/src/Google/Service','Storage.php',1197],['lib/google/src/Google/Service','Storage.php',1367],['lib/google/src/Google/Service','Storage.php',1499],['lib/google/src/Google/Service','Storage.php',1737],['lib/google/src/Google/Service','Licensing.php',256],['lib/google/src/Google/Service','Gmail.php',1078],['lib/google/src/Google/Service','Taskqueue.php',324],['lib/adodb','adodb-active-recordx.inc.php',963],['lib/google/src/Google/Service','Doubleclicksearch.php',286],['lib/google/src/Google/Service','Autoscaler.php',347],['lib/google/src/Google/Service','Prediction.php',291],['lib/google/src/Google/Service','SiteVerification.php',181],['lib/google/src/Google/Service','Drive.php',1551],['lib/google/src/Google/Service','Drive.php',1635],['lib/google/src/Google/Service','Drive.php',1816],['lib/google/src/Google/Service','Drive.php',2069],['lib/google/src/Google/Service','Drive.php',2153],['lib/google/src/Google/Service','Drive.php',2273],['lib/google/src/Google/Service','Drive.php',2437],['lib/google/src/Google/Service','Directory.php',1945],['lib/google/src/Google/Service','Directory.php',2018],['lib/google/src/Google/Service','Directory.php',2086],['lib/google/src/Google/Service','Directory.php',2183],['lib/google/src/Google/Service','Directory.php',2253],['lib/google/src/Google/Service','Directory.php',2546],['lib/google/src/Google/Service','Directory.php',2681],['lib/google/src/Google/Service','Directory.php',2760],['lib/google/src/Google/Service','Directory.php',2865],['lib/google/src/Google/Service','Directory.php',3033],['lib/google/src/Google/Service','Directory.php',3213],['lib/google/src/Google/Service','Fusiontables.php',675],['lib/google/src/Google/Service','Fusiontables.php',841],['lib/google/src/Google/Service','Fusiontables.php',1011],['lib/google/src/Google/Service','Fusiontables.php',1217],['lib/google/src/Google/Service','AdSenseHost.php',787],['lib/google/src/Google/Service','AdSenseHost.php',1042],['lib/google/src/Google/Service','AdSenseHost.php',1183],['lib/google/src/Google/Service','Plus.php',466],['lib/google/src/Google/Service','Mirror.php',394],['lib/google/src/Google/Service','Mirror.php',452],['lib/google/src/Google/Service','Mirror.php',606],['lib/google/src/Google/Service','Mirror.php',688],['lib/google/src/Google/Service','Mirror.php',802],['lib/google/src/Google/Service','AndroidEnterprise.php',1017],['lib/google/src/Google/Service','AndroidEnterprise.php',1326],['lib/google/src/Google/Service','Calendar.php',936],['lib/google/src/Google/Service','Calendar.php',1102],['lib/google/src/Google/Service','Calendar.php',1301],['lib/google/src/Google/Service','Calendar.php',1481],['lib/google/src/Google/Service','PlusDomains.php',482],['lib/google/src/Google/Service','PlusDomains.php',607],['lib/google/src/Google/Service','PlusDomains.php',733],['lib/google/src/Google/Service','PlusDomains.php',782],['lib/google/src/Google/Service','GamesConfiguration.php',280],['lib/google/src/Google/Service','GamesConfiguration.php',419],['lib/google/src/Google/Service','Resourceviews.php',475],['lib/google/src/Google/Service','SQLAdmin.php',892],['lib/google/src/Google/Service','SQLAdmin.php',1111],['lib/google/src/Google/Service','SQLAdmin.php',1406],['lib/google/src/Google/Service','SQLAdmin.php',1501],['lib/google/src/Google/Service','Compute.php',4053],['lib/google/src/Google/Service','Compute.php',4183],['lib/google/src/Google/Service','Compute.php',4332],['lib/google/src/Google/Service','Compute.php',4606],['lib/google/src/Google/Service','Compute.php',4701],['lib/google/src/Google/Service','Compute.php',4861],['lib/google/src/Google/Service','Compute.php',4972],['lib/google/src/Google/Service','Compute.php',5063],['lib/google/src/Google/Service','Compute.php',5280],['lib/google/src/Google/Service','Compute.php',5410],['lib/google/src/Google/Service','Compute.php',5557],['lib/google/src/Google/Service','Compute.php',5744],['lib/google/src/Google/Service','Compute.php',6017],['lib/google/src/Google/Service','Compute.php',6186],['lib/google/src/Google/Service','Compute.php',6404],['lib/google/src/Google/Service','Compute.php',6747],['lib/google/src/Google/Service','Compute.php',7067],['lib/google/src/Google/Service','Compute.php',7238],['lib/google/src/Google/Service','Compute.php',7331],['lib/google/src/Google/Service','Compute.php',7441],['lib/google/src/Google/Service','Compute.php',7602],['lib/google/src/Google/Service','Compute.php',7785],['lib/google/src/Google/Service','Compute.php',7972],['lib/google/src/Google/Service','Compute.php',8065],['lib/google/src/Google/Service','Compute.php',8242],['lib/google/src/Google/Service','YouTube.php',1715],['lib/google/src/Google/Service','YouTube.php',1881],['lib/google/src/Google/Service','YouTube.php',2014],['lib/google/src/Google/Service','YouTube.php',2089],['lib/google/src/Google/Service','YouTube.php',2351],['lib/google/src/Google/Service','YouTube.php',2473],['lib/google/src/Google/Service','YouTube.php',2935],['lib/google/src/Google/Service','YouTube.php',3233],['lib/google/src/Google/Service','YouTube.php',3434],['lib/google/src/Google/Service','YouTube.php',3587],['lib/google/src/Google/Service','YouTube.php',3943],['lib/google/src/Google/Service','YouTube.php',4216],['lib/google/src/Google/Service','Dfareporting.php',4686],['lib/google/src/Google/Service','Dfareporting.php',4882],['lib/google/src/Google/Service','Dfareporting.php',5029],['lib/google/src/Google/Service','Dfareporting.php',5132],['lib/google/src/Google/Service','Dfareporting.php',5257],['lib/google/src/Google/Service','Dfareporting.php',5323],['lib/google/src/Google/Service','Dfareporting.php',5595],['lib/google/src/Google/Service','Dfareporting.php',5724],['lib/google/src/Google/Service','Dfareporting.php',5786],['lib/google/src/Google/Service','Dfareporting.php',5906],['lib/google/src/Google/Service','Dfareporting.php',6012],['lib/google/src/Google/Service','Dfareporting.php',6120],['lib/google/src/Google/Service','Dfareporting.php',6329],['lib/google/src/Google/Service','Dfareporting.php',6426],['lib/google/src/Google/Service','Dfareporting.php',6624],['lib/google/src/Google/Service','Dfareporting.php',6761],['lib/google/src/Google/Service','Dfareporting.php',7027],['lib/google/src/Google/Service','Dfareporting.php',7393],['lib/google/src/Google/Service','Dfareporting.php',7532],['lib/google/src/Google/Service','Dfareporting.php',7655],['lib/google/src/Google/Service','Dfareporting.php',8010],['lib/google/src/Google/Service','Dfareporting.php',8131],['lib/google/src/Google/Service','Dfareporting.php',8322],['lib/google/src/Google/Service','Dfareporting.php',8436],['lib/google/src/Google/Service','Dfareporting.php',8497],['lib/google/src/Google/Service','Dfareporting.php',8797],['lib/google/src/Google/Service','Manager.php',275],['lib/google/src/Google/Service','Manager.php',353]], 481],
'get_userid': ['get_userid', 'Returns user ID ', [['lib/filebrowser','virtual_root_file.php',236],['mod/quiz','attemptlib.php',804],['lib/filestorage','stored_file.php',708],['mod/data','lib.php',2585],['backup/util/plan','restore_task.class.php',54],['backup/util/plan','restore_plan.class.php',115],['backup/controller','backup_controller.class.php',283],['backup/controller','restore_controller.class.php',285]], 220],
'set_moduleid': ['set_moduleid', '', [['backup/moodle2','restore_activity_task.class.php',71]], 1],
'process_question_attempt': ['process_question_attempt', 'Process question_attempts ', [['backup/moodle2','restore_stepslib.php',5051]], 0],
'process_question_usage': ['process_question_usage', 'Process question_usages ', [['backup/moodle2','restore_stepslib.php',5044]], 0],
'apply_activity_instance': ['apply_activity_instance', 'This must be invoked immediately after creating the "module" activity record (forum, choice...) and will adjust the new activity id (the instance) in various places ', [['backup/moodle2','restore_stepslib.php',4259]], 22],
'after_restore': ['after_restore', 'This function, executed after all the tasks in the plan have been executed, will perform the recode of the target quiz for the block. This must be done here and not in normal execution steps because the quiz can be restored after the block. ', [['blocks/quiz_results/backup/moodle2','restore_quiz_results_block_task.class.php',50],['backup/moodle2','restore_stepslib.php',3688],['backup/moodle2','restore_stepslib.php',4141],['mod/forum/backup/moodle2','restore_forum_stepslib.php',217],['blocks/activity_results/backup/moodle2','restore_activity_results_block_task.class.php',62],['backup/util/plan','restore_structure_step.class.php',464],['blocks/tags/backup/moodle2','restore_tags_block_task.class.php',47],['blocks/glossary_random/backup/moodle2','restore_glossary_random_block_task.class.php',46],['mod/assignment/backup/moodle2','restore_assignment_stepslib.php',149]], 2],
'process_grouping': ['process_grouping', '', [['backup/moodle2','restore_stepslib.php',1218]], 0],
'role_assign': ['role_assign', 'Assigns the specified role to a user in the context. ', [['lib/testing/generator','data_generator.php',936],['lib','accesslib.php',1661]], 269],
'recode_legacy_response_data': ['recode_legacy_response_data', 'Recode any ids in the response data ', [['backup/moodle2','restore_stepslib.php',5373]], 1],
'decode_backup_temp_info': ['decode_backup_temp_info', 'Decode the info field from backup_ids_temp or backup_files_temp. ', [['backup/util/dbops','backup_controller_dbops.class.php',169]], 15],
'get_results': ['get_results', 'Returns the results ', [['backup/util/structure','backup_nested_element.class.php',182],['backup/util/plan','base_plan.class.php',98],['backup/util/ui','restore_ui_components.php',130],['backup/controller','backup_controller.class.php',325],['backup/controller','restore_controller.class.php',388],['backup/util/plan','base_task.class.php',241]], 21],
'get_name': ['get_name', 'Return localised event name. ', [['lib/classes/event','competency_plan_unlinked.php',72],['admin/tool/langimport/classes/task','update_langpacks_task.php',35],['lib/simplepie/library/SimplePie','Author.php',106],['portfolio/download','lib.php',10],['backup/util/structure','restore_path_element.class.php',98],['lib/classes/message/inbound','private_files_handler.php',56],['lib/classes/event','grouping_group_assigned.php',48],['calendar/tests','calendartype_test_example.php',32],['lib/classes/event','enrol_instance_deleted.php',70],['report/log/classes/event','user_report_viewed.php',54],['lib/classes/task','blog_cron_task.php',31],['mod/quiz/classes/event','attempt_reviewed.php',53],['lib/classes/event','tag_unflagged.php',55],['lib/classes/task','send_new_user_passwords_task.php',31],['lib/classes/event','role_unassigned.php',53],['mod/assign/classes/event','grading_form_viewed.php',82],['question/classes/bank','edit_action_column.php',35],['admin/tool/log/store/standard/classes/task','cleanup_task.php',31],['mod/workshop/classes/event','submission_deleted.php',63],['mod/forum/classes/event','discussion_updated.php',65],['lib/classes/event','course_module_instance_list_viewed.php',75],['lib/classes/event','course_created.php',55],['lib/dml','pdo_moodle_database.php',113],['mod/assign/classes/event','extension_granted.php',77],['lib/classes/task','tag_cron_task.php',33],['enrol/imsenterprise/classes/task','cron_task.php',34],['lib/classes/event','course_deleted.php',56],['lib/classes/task','completion_daily_task.php',33],['mod/forum/classes/event','readtracking_enabled.php',64],['mod/wiki/classes/event','page_created.php',48],['lib/dml','oci_native_moodle_database.php',94],['lib/classes/event','competency_viewed.php',70],['mod/choice/classes/event','answer_updated.php',72],['lib/classes/event','search_indexed.php',47],['lib/classes/event','badge_criteria_updated.php',53],['question/classes/bank','question_type_column.php',26],['mod/wiki/classes/event','page_version_deleted.php',54],['lib/grade','grade_item.php',1384],['lib/classes/event','competency_user_competency_rated_in_plan.php',88],['lib/classes/event','webservice_token_sent.php',56],['mod/glossary/classes/event','entry_deleted.php',54],['admin/tool/messageinbound/classes/message/inbound','invalid_recipient_handler.php',60],['lib/classes/event','competency_template_viewed.php',63],['lib/classes/task','context_cleanup_task.php',32],['mod/assign/tests/fixtures','event_mod_assign_fixtures.php',62],['admin/tool/langimport/classes/event','langpack_removed.php',89],['mod/glossary/classes/event','category_deleted.php',46],['mod/forum/classes/message/inbound','reply_handler.php',51],['competency/classes','competency_rule.php',84],['mod/lti/classes/event','unknown_service_api_called.php',82],['lib/classes/event','badge_deleted.php',49],['mod/quiz/classes/event','user_override_updated.php',54],['lib/classes/event','message_contact_added.php',48],['lib/classes/event','cohort_member_added.php',49],['backup/util/ui','restore_ui.class.php',351],['lib/classes/event','blog_entry_updated.php',74],['mod/assign/classes/event','workflow_state_updated.php',88],['mod/forum/classes/event','assessable_uploaded.php',86],['mod/assign/classes/event','submission_created.php',57],['lib/classes/event','group_deleted.php',65],['lib/classes/event','role_allow_assign_updated.php',47],['mod/lesson/classes/event','highscore_added.php',59],['mod/forum/classes/event','discussion_pinned.php',55],['lib/classes/event','webservice_function_called.php',67],['lib/classes/event','competency_plan_reopened.php',75],['mod/lesson/classes/event','essay_attempt_viewed.php',48],['mod/wiki/classes/event','page_locks_deleted.php',54],['lib/classes/event','webservice_service_deleted.php',59],['mod/forum/classes/event','discussion_subscription_created.php',66],['admin/tool/log/store/database/tests/fixtures','event.php',31],['mod/workshop/classes/event','assessable_uploaded.php',93],['lib','csslib.php',2155],['lib','csslib.php',2283],['lib/classes/event','user_loggedout.php',54],['lib/classes/event','webservice_token_created.php',65],['lib/classes/event','tag_collection_updated.php',65],['competency/classes','competency_rule_all.php',84],['backup/util/settings','base_setting.class.php',145],['mod/data/classes/event','field_deleted.php',57],['mod/book/classes/event','chapter_created.php',79],['lib/classes/event','email_failed.php',56],['lib/classes/task','stats_cron_task.php',31],['mod/survey/classes/event','report_downloaded.php',55],['mod/workshop/classes/event','phase_switched.php',75],['lib/grade','grade_category.php',2300],['lib/grade','grade_scale.php',156],['lib/classes/event','course_reset_started.php',53],['mod/workshop/classes/event','assessment_evaluated.php',66],['lib/classes/event','blog_association_created.php',56],['backup/converter','convertlib.php',109],['report/outline/classes/event','activity_report_viewed.php',48],['lib/classes/task','legacy_plugin_cron_task.php',33],['lib/classes/event','competency_plan_updated.php',75],['mod/choice/classes/event','answer_submitted.php',72],['mod/lesson/classes/event','lesson_ended.php',49],['lib/classes/event','role_allow_switch_updated.php',47],['lib/classes/task','portfolio_cron_task.php',31],['lib/classes/event','competency_user_competency_rated_in_course.php',88],['question/classes/bank','question_text_row.php',35],['lib/classes/event','tag_created.php',75],['report/participation/classes/event','report_viewed.php',58],['lib/classes/event','role_capabilities_updated.php',51],['mod/survey/classes/event','response_submitted.php',53],['lib/classes/event','badge_archived.php',47],['mod/workshop/classes/event','assessment_reevaluated.php',76],['mod/assign/classes/event','submission_locked.php',78],['report/outline/classes/event','report_viewed.php',54],['lib/classes/event','user_deleted.php',57],['lib/classes/event','mnet_access_control_updated.php',57],['mod/lesson/classes/event','essay_assessed.php',78],['mod/book/tool/print/classes/event','book_printed.php',76],['lib/classes/event','grouping_deleted.php',72],['admin/tool/monitor/classes','rule.php',239],['lib/classes/event','course_viewed.php',75],['mod/forum/classes/event','user_report_viewed.php',65],['user/selector','lib.php',309],['mod/quiz/classes/event','attempt_summary_viewed.php',56],['lib/classes/event','webservice_service_user_added.php',59],['mod/forum/classes/event','discussion_unpinned.php',55],['lib/classes/event','grouping_group_unassigned.php',48],['lib/grade','grade_outcome.php',272],['mod/chat/classes/event','message_sent.php',59],['lib/classes/event','role_assigned.php',56],['mod/quiz/classes/question/bank','question_name_text_column.php',37],['question/classes/bank','modifier_name_column.php',27],['mod/glossary/classes/event','entry_viewed.php',48],['mod/data/classes/event','record_created.php',56],['lib/classes/event','course_category_deleted.php',59],['lib/dml','mariadb_native_moodle_database.php',41],['lib/classes/event','role_deleted.php',55],['lib/classes/task','question_cron_task.php',31],['portfolio/flickr','lib.php',41],['lib/classes/task','cache_cron_task.php',31],['mod/wiki/classes/event','page_version_viewed.php',54],['admin/tool/recyclebin/classes/event','category_bin_item_deleted.php',47],['admin/tool/log/store/standard/tests/fixtures','event.php',31],['mod/scorm/classes/event','status_submitted.php',46],['admin/tool/monitor/classes/event','rule_created.php',50],['admin/tool/log/store/legacy/classes/task','cleanup_task.php',31],['question/classes/bank','checkbox_column.php',32],['lib/classes/event','competency_user_competency_plan_viewed.php',81],['mod/assign/feedback/offline','locallib.php',42],['admin/tool/messageinbound/classes/task','cleanup_task.php',38],['mod/workshop/classes/event','submission_updated.php',63],['lib/editor/atto/classes/task','autosave_cleanup_task.php',33],['mod/choice/classes/event','report_viewed.php',53],['mod/lesson/classes/event','group_override_deleted.php',54],['mod/wiki/classes/event','page_map_viewed.php',54],['admin/tool/log/store/legacy/tests/fixtures','event.php',31],['mod/lesson/classes/event','question_answered.php',54],['mod/choice/classes/event','report_downloaded.php',54],['admin/tool/recyclebin/classes/task','cleanup_category_bin.php',36],['backup/util/ui','backup_ui_setting.class.php',86],['lib/classes/event','competency_user_evidence_created.php',64],['lib/classes/event','course_module_completion_updated.php',54],['repository/coursefiles','lib.php',183],['lib/classes/event','note_updated.php',56],['lib/classes/event','note_created.php',56],['lib/classes/event','competency_framework_created.php',63],['lib/classes/event','course_resources_list_viewed.php',60],['lib/classes/event','tag_updated.php',58],['mod/forum/classes/event','subscribers_viewed.php',65],['mod/book/tool/exportimscp/classes/event','book_exported.php',76],['mod/quiz/classes/question/bank','add_action_column.php',45],['lib/classes/task','completion_regular_task.php',33],['lib/classes/event','user_enrolment_deleted.php',54],['grade/report/grader/classes/event','grade_report_viewed.php',39],['lib','enrollib.php',1076],['admin/tool/recyclebin/classes/event','course_bin_item_restored.php',47],['lib/classes/event','webservice_service_updated.php',59],['lib/editor/tinymce/classes','plugin.php',101],['mod/lesson/classes/event','group_override_created.php',55],['mod/scorm/classes/event','attempt_deleted.php',62],['lib/classes/event','competency_user_competency_review_request_cancelled.php',72],['lib/classes/event','webservice_service_created.php',65],['lib/classes/task','events_cron_task.php',31],['mod/wiki/classes/event','page_version_restored.php',54],['mod/forum/classes/event','discussion_deleted.php',66],['lib/classes/event','competency_framework_updated.php',73],['mod/lesson/classes/event','lesson_restarted.php',48],['mod/wiki/classes/event','page_updated.php',54],['mod/assign/classes/event','marker_updated.php',89],['lib','modinfolib.php',1270],['mod/assign/feedback/editpdf/classes/task','convert_submissions.php',38],['lib/classes/event','course_module_updated.php',57],['repository','lib.php',1834],['auth/cas/classes/task','sync_task.php',34],['lib/classes/event','competency_template_deleted.php',73],['mod/assign/classes/event','submission_confirmation_form_viewed.php',79],['lib/bennu','iCalendar_components.php',37],['report/questioninstances/classes/event','report_viewed.php',55],['admin/tool/recyclebin/classes/task','cleanup_course_bin.php',36],['lib/classes/event','message_contact_blocked.php',48],['lib/classes/event','competency_template_updated.php',75],['question/behaviour','behaviourbase.php',83],['grade/report/history/classes/event','grade_report_viewed.php',39],['lib/classes/event','badge_disabled.php',47],['mod/assign/classes/event','grading_table_viewed.php',79],['lib/classes/event','badge_enabled.php',47],['mod/lti','OAuth.php',122],['mod/lti','OAuth.php',149],['mod/lti','OAuth.php',173],['calendar/type/gregorian/classes','structure.php',29],['mod/quiz/classes/event','edit_page_viewed.php',53],['lib/simplepie/library/SimplePie','Credit.php',139],['mod/scorm/classes/event','tracks_viewed.php',64],['mod/wiki/classes/event','page_diff_viewed.php',55],['message/tests/fixtures','inbound_fixtures.php',41],['lib/classes/event','grouping_created.php',65],['lib/classes/event','calendar_event_deleted.php',58],['enrol/flatfile/classes/task','flatfile_sync_task.php',37],['lib/classes/event','group_updated.php',65],['lib/classes/task','registration_cron_task.php',31],['mod/book/classes/event','chapter_updated.php',79],['lib/classes/event','grade_deleted.php',94],['admin/tool/recyclebin/classes/event','course_bin_item_created.php',47],['lib/classes/event','user_loggedin.php',64],['lib/classes/task','check_for_updates_task.php',31],['grade/report/singleview/classes/local/ui','grade_attribute_format.php',56],['mod/assign/submission/file','locallib.php',44],['mod/forum/classes/task','cron_task.php',30],['mod/forum/classes/event','subscription_created.php',65],['lib/classes/event','tag_collection_created.php',65],['grade/report/overview/classes/event','grade_report_viewed.php',48],['mod/assign/classes/event','batch_set_marker_allocation_viewed.php',79],['mod/quiz/classes/event','group_override_updated.php',54],['lib/classes/event','competency_plan_created.php',63],['mod/glossary/classes/event','entry_disapproved.php',46],['lib/classes/task','send_failed_login_notifications_task.php',34],['enrol/lti/classes/task','sync_grades.php',36],['lib/classes/event','message_viewed.php',54],['portfolio/boxnet','lib.php',14],['lib/classes/event','comment_created.php',58],['question/classes/bank','preview_action_column.php',26],['lib/classes/event','course_content_deleted.php',54],['lib/dml','pgsql_native_moodle_database.php',87],['mod/feedback/classes/event','response_deleted.php',83],['lib/classes/event','competency_evidence_created.php',98],['lib/classes/event','comment_deleted.php',58],['lib/classes/event','competency_user_competency_review_requested.php',72],['mod/quiz/classes/event','attempt_abandoned.php',63],['mod/scorm/classes/event','user_report_viewed.php',62],['lib/dml','mssql_native_moodle_database.php',88],['mod/quiz/classes/event','attempt_becameoverdue.php',66],['mod/quiz/classes/event','group_override_created.php',55],['lib/dml','mysqli_native_moodle_database.php',352],['backup/util/ui','backup_ui.class.php',194],['mod/book/tool/print/classes/event','chapter_printed.php',79],['mod/data/classes/event','record_deleted.php',56],['competency/classes','competency_rule_points.php',185],['lib/classes/event','competency_user_competency_viewed.php',81],['lib/classes/event','dashboard_viewed.php',59],['mod/lesson/classes/event','question_viewed.php',54],['lib/classes/event','user_profile_viewed.php',56],['lib','medialib.php',345],['admin/tool/monitor/classes/task','clean_events.php',32],['mod/lesson/classes/event','user_override_deleted.php',53],['lib/classes/event','cohort_member_removed.php',50],['mod/lesson/classes/event','lesson_started.php',48],['mod/lesson/classes/event','page_updated.php',73],['mod/workshop/classes/event','submission_viewed.php',63],['question/classes/bank','question_name_column.php',28],['lib/classes/event','competency_deleted.php',87],['admin/tool/monitor/classes','subscription.php',132],['lib/classes/task','grade_cron_task.php',31],['mod/glossary/classes/event','entry_created.php',52],['lib/classes/task','file_temp_cleanup_task.php',31],['lib/classes/event','dashboard_reset.php',60],['backup/util/structure','base_atom.class.php',71],['portfolio/googledocs','lib.php',54],['mod/assign/feedback/comments','locallib.php',36],['mod/wiki/classes/event','page_history_viewed.php',48],['lib/classes/event','competency_plan_review_request_cancelled.php',75],['lib/classes/event','competency_plan_deleted.php',73],['mod/quiz/classes/event','attempt_viewed.php',54],['mod/data/classes/event','field_updated.php',57],['lib/classes/event','grouping_updated.php',65],['cache/classes','definition.php',621],['lib/classes/task','plagiarism_cron_task.php',31],['backup/converter/moodle1','lib.php',1033],['lib/classes/event','question_category_created.php',48],['grade/report/user/classes/event','grade_report_viewed.php',48],['lib/classes/event','user_login_failed.php',56],['mod/scorm/classes/event','report_viewed.php',63],['mod/chat/classes/event','sessions_viewed.php',65],['admin/tool/recyclebin/classes/event','course_bin_item_deleted.php',47],['mod/quiz/classes/event','user_override_deleted.php',53],['portfolio/mahara','lib.php',61],['mod/quiz/classes/event','attempt_submitted.php',63],['grade/report/outcomes/classes/event','grade_report_viewed.php',39],['mod/lesson/classes/event','group_override_updated.php',54],['mod/workshop/classes/event','submission_created.php',63],['mod/assign/classes/event','submission_updated.php',57],['mod/assign/submission/onlinetext/classes/event','assessable_uploaded.php',83],['lib/classes/event','competency_updated.php',70],['lib/classes/event','note_deleted.php',56],['mod/lesson/classes/event','page_moved.php',56],['lib/classes/event','course_completed.php',73],['lib/classes/event','tag_added.php',58],['lib/classes/event','competency_created.php',70],['mod/lesson/classes/event','highscores_viewed.php',51],['lib/classes/event','message_contact_unblocked.php',48],['lib/classes/event','user_enrolment_created.php',53],['lib/classes/task','search_index_task.php',35],['lib/classes/event','course_module_created.php',86],['lib/classes/event','webservice_service_user_removed.php',59],['report/log/classes/event','report_viewed.php',58],['mod/assign/submission/file/classes/event','assessable_uploaded.php',85],['lib/classes/event','group_member_added.php',78],['mod/forum/classes/event','discussion_viewed.php',60],['mod/assign/classes/event','submission_viewed.php',76],['mod/lti/classes/local/ltiservice','service_base.php',87],['enrol/lti/classes/task','sync_members.php',46],['mod/workshop/classes/event','submission_reassessed.php',77],['lib/classes/task','session_cleanup_task.php',31],['lib/tests','messageinbound_test.php',166],['lib/classes/task','backup_cleanup_task.php',31],['mod/workshop/classes/event','assessment_evaluations_reset.php',75],['mod/scorm/classes/event','scoreraw_submitted.php',46],['mod/assign/classes/event','statement_accepted.php',77],['mod/assign/classes/event','feedback_viewed.php',76],['lib/classes/task','delete_unconfirmed_users_task.php',31],['mod/forum/classes/event','discussion_moved.php',66],['lib/classes/event','competency_user_evidence_deleted.php',64],['mod/assign/classes/event','batch_set_workflow_state_viewed.php',79],['mod/lesson/classes/event','lesson_resumed.php',48],['lib/classes/task','badges_cron_task.php',31],['lib/classes/event','comments_viewed.php',51],['mod/data/classes/event','template_viewed.php',55],['mod/wiki/classes/event','page_deleted.php',54],['mod/quiz/classes/event','report_viewed.php',56],['mod/scorm/classes/event','sco_launched.php',64],['mod/glossary/classes/event','entry_updated.php',52],['mod/lesson/classes/event','user_override_created.php',53],['mod/glossary/classes/event','category_updated.php',46],['lib/classes/event','course_updated.php',58],['grade/report/singleview/classes/event','grade_report_viewed.php',39],['mod/feedback/classes/event','response_submitted.php',83],['lib/classes/event','blog_entry_deleted.php',53],['mod/book/classes/event','chapter_deleted.php',79],['report/completion/classes/event','report_viewed.php',49],['lib/classes/event','recent_activity_viewed.php',49],['mod/quiz/classes/event','question_manually_graded.php',55],['mod/assign/classes/event','submission_status_updated.php',79],['lib/classes/event','user_enrolment_updated.php',53],['lib/classes/event','tag_deleted.php',55],['report/completion/classes/event','user_report_viewed.php',49],['report/stats/classes/event','report_viewed.php',56],['lib/classes/event','calendar_event_created.php',58],['mod/assign/classes/event','submission_duplicated.php',77],['lib/classes/event','competency_framework_deleted.php',73],['lib/classes/event','course_section_updated.php',56],['lib/classes/event','message_sent.php',82],['lib/classes/event','calendar_subscription_deleted.php',56],['lib/classes/event','course_category_updated.php',51],['lib/classes/event','user_password_updated.php',70],['enrol/lti/ims-blti','OAuth.php',65],['enrol/lti/ims-blti','OAuth.php',92],['enrol/lti/ims-blti','OAuth.php',116],['mod/forum/classes/event','subscription_deleted.php',65],['mod/assign/classes/event','reveal_identities_confirmation_page_viewed.php',79],['lib/classes/event','user_loggedinas.php',57],['lib/classes/event','competency_template_created.php',63],['lib/classes/event','user_created.php',48],['admin/tool/recyclebin/classes/event','category_bin_item_restored.php',47],['report/loglive/classes/event','report_viewed.php',48],['admin/tool/monitor/classes/event','subscription_created.php',50],['mod/book/classes/event','chapter_viewed.php',79],['lib/classes/event','badge_awarded.php',54],['lib/classes/event','calendar_subscription_created.php',57],['lib/classes/event','enrol_instance_created.php',69],['lib/classes/event','user_list_viewed.php',56],['lib/classes/task','calendar_cron_task.php',31],['mod/forum/classes/event','post_deleted.php',67],['mod/quiz/classes/event','group_override_deleted.php',54],['lib/classes/event','badge_created.php',47],['backup/util/plan','base_plan.class.php',50],['lib/classes/event','base.php',292],['lib/classes/event','competency_framework_viewed.php',69],['lib/classes/event','tag_collection_deleted.php',65],['lib/classes/event','group_member_removed.php',69],['lib/classes/event','grade_report_viewed.php',54],['lib/classes/event','calendar_event_updated.php',58],['mod/assign/submission/onlinetext','locallib.php',40],['lib/classes/event','user_updated.php',48],['mod/lesson/classes/event','page_created.php',54],['backup/util/ui','base_ui_stage.class.php',110],['mod/assign/classes/event','submission_form_viewed.php',82],['auth/ldap/classes/task','sync_task.php',34],['lib/classes/event','course_completion_updated.php',47],['lib/classes/event','competency_plan_review_started.php',75],['lib/classes/event','course_user_report_viewed.php',66],['mod/folder/classes/event','all_files_downloaded.php',60],['mod/workshop/classes/event','assessments_reset.php',74],['lib/tests/fixtures','task_fixtures.php',35],['lib/tests/fixtures','task_fixtures.php',44],['lib/tests/fixtures','task_fixtures.php',53],['mod/data/classes/event','template_updated.php',56],['mod/assign/classes/event','identities_revealed.php',75],['question/classes/bank','copy_action_column.php',35],['admin/tool/log/store/legacy/classes/event','legacy_logged.php',35],['lib/classes/event','notes_viewed.php',49],['admin/tool/recyclebin/classes/event','category_bin_item_created.php',47],['lib/classes/event','competency_plan_viewed.php',63],['mod/data/classes/event','record_updated.php',56],['mod/assign/feedback/file','locallib.php',45],['lib/classes/event','competency_plan_unapproved.php',75],['mod/lesson/classes/event','content_page_viewed.php',48],['mod/assign/feedback/editpdf','locallib.php',43],['lib/dml','sqlsrv_native_moodle_database.php',108],['admin/tool/monitor/classes/event','subscription_deleted.php',50],['mod/assign/classes/event','assessable_submitted.php',109],['mod/quiz/classes/event','attempt_started.php',62],['lib/classes/task','create_contexts_task.php',31],['lib/classes/task','file_trash_cleanup_task.php',31],['lib/classes/event','competency_user_competency_rated.php',82],['mod/forum/classes/event','post_updated.php',67],['admin/tool/cohortroles/classes/task','cohort_role_sync.php',37],['lib/classes/event','course_module_deleted.php',56],['mod/assign/submission/comments','locallib.php',39],['lib/classes/event','competency_plan_review_requested.php',75],['lib/classes/event','user_graded.php',96],['lib/classes/event','webservice_login_failed.php',71],['mod/forum/classes/event','post_created.php',67],['lib/classes/task','complete_plans_task.php',43],['mod/assign/classes/event','submission_status_viewed.php',81],['lib/classes/event','enrol_instance_updated.php',70],['lib/classes/task','messaging_cleanup_task.php',31],['portfolio/picasa','lib.php',33],['admin/tool/capability/classes/event','report_viewed.php',47],['grade/report/singleview/classes/local/ui','unique_name.php',38],['mod/data/classes/event','field_created.php',58],['mod/folder/classes/event','folder_updated.php',48],['lib/classes/event','badge_updated.php',47],['lib/tests/fixtures','event_fixtures.php',34],['lib/classes/task','cache_cleanup_task.php',31],['mod/survey/classes/event','report_viewed.php',55],['mod/quiz/classes/event','attempt_deleted.php',53],['mod/glossary/classes/event','entry_approved.php',46],['mod/wiki/classes/event','page_viewed.php',57],['lib/classes/log','reader.php',30],['lib/classes/task','password_reset_cleanup_task.php',31],['mod/forum/classes/event','readtracking_disabled.php',64],['admin/tool/langimport/classes/event','langpack_imported.php',80],['lib/classes/event','competency_plan_review_stopped.php',75],['admin/tool/langimport/classes/event','langpack_updated.php',80],['lib/classes/event','unknown_logged.php',43],['lib/classes/event','competency_user_competency_viewed_in_plan.php',85],['lib/classes/event','competency_user_competency_viewed_in_course.php',84],['lib/classes/task','search_optimize_task.php',38],['mod/glossary/classes/event','category_created.php',46],['lib/portfolio','plugin.php',120],['report/stats/classes/event','user_report_viewed.php',48],['lib/classes/event','dashboards_reset.php',59],['lib/classes/event','calendar_subscription_updated.php',57],['lib/classes/event','cohort_updated.php',49],['admin/tool/monitor/classes/event','rule_updated.php',50],['mod/lesson/classes/event','page_deleted.php',54],['lib/classes/event','course_section_deleted.php',57],['lib/classes/task','delete_incomplete_users_task.php',31],['lib/classes/task','automated_backup_task.php',31],['admin/tool/monitor/classes/event','subscription_criteria_met.php',55],['lib/classes/event','mnet_access_control_created.php',57],['admin/tool/messageinbound/classes/task','pickup_task.php',38],['mod/forum/classes/event','discussion_created.php',65],['question/classes/bank','creator_name_column.php',28],['lib/classes/event','blog_entries_viewed.php',62],['lib/classes/task','sync_plans_from_template_cohorts_task.php',41],['mod/quiz/classes/event','attempt_preview_started.php',54],['lib/classes/event','content_viewed.php',80],['lib/classes/event','competency_user_evidence_updated.php',64],['lib/dml/tests','dml_test.php',5530],['mod/assign/classes/event','submission_graded.php',78],['mod/assign/classes/event','all_submissions_downloaded.php',75],['lib/classes/event','course_restored.php',58],['lib/classes/event','group_created.php',65],['lib/classes/event','badge_criteria_deleted.php',52],['lib/classes/event','tag_flagged.php',55],['lib/classes/event','competency_plan_completed.php',75],['mod/lesson/classes/event','user_override_updated.php',54],['lib/classes/event','role_allow_override_updated.php',47],['mod/forum/classes/event','discussion_subscription_deleted.php',66],['lib/classes/event','cohort_deleted.php',49],['lib/classes/event','badge_criteria_created.php',52],['admin/tool/log/classes/helper','reader.php',41],['admin/tool/monitor/classes/task','check_subscriptions.php',50],['lib/classes/event','blog_entry_created.php',76],['mod/scorm/classes/event','interactions_viewed.php',63],['mod/workshop/classes/event','submission_assessed.php',76],['lib/classes/event','badge_duplicated.php',47],['backup/util/plan','base_step.class.php',49],['lib/classes/event','course_category_created.php',48],['lib/classes/event','cohort_created.php',49],['lib/classes/event','tag_removed.php',58],['lib/classes/event','competency_plan_approved.php',75],['mod/choice/classes/event','answer_deleted.php',56],['backup/util/ui','restore_ui_stage.class.php',75],['lib/classes/event','competency_user_competency_review_started.php',72],['lib/classes/event','course_reset_ended.php',53],['mod/quiz/classes/event','user_override_created.php',53],['mod/forum/classes/event','course_searched.php',66],['lib/classes/event','message_contact_removed.php',48],['admin/tool/monitor/classes/event','rule_deleted.php',50],['lib/classes/event','message_deleted.php',91],['mod/assign/classes/event','submission_unlocked.php',78],['lib/classes/event','competency_user_competency_review_stopped.php',72],['lib/classes/event','course_module_viewed.php',62],['backup/util/plan','base_task.class.php',58],['question/classes/bank','delete_action_column.php',36]], 469],
'process_grading_area': ['process_grading_area', 'Processes one grading area element ', [['backup/moodle2','restore_stepslib.php',3467]], 0],
'set_activityid': ['set_activityid', '', [['backup/moodle2','restore_activity_task.class.php',79]], 1],
'set_preloaded_information': ['set_preloaded_information', '', [['backup/util/plan','restore_task.class.php',74],['backup/util/plan','restore_plan.class.php',135]], 2],
'process_course_module_competency': ['process_course_module_competency', 'Process a course module competency. ', [['backup/moodle2','restore_stepslib.php',3353]], 0],
'get_setting_value': ['get_setting_value', 'Returns the value of one (task/plan) setting ', [['backup/moodle2','backup_plugin.class.php',68],['backup/moodle2','restore_plugin.class.php',230],['backup/util/ui','base_ui.class.php',330],['backup/moodle2','restore_subplugin.class.php',169],['backup/moodle2','backup_subplugin.class.php',68],['backup/util/plan','base_step.class.php',98],['backup/util/plan','base_task.class.php',105]], 142],
'fopen': ['fopen', 'Return a stream handle to this stream. ', [['lib/horde/framework/Horde/Support','CombineStream.php',41],['lib/spout/src/Spout/Common/Helper','GlobalFunctionsHelper.php',15],['lib/horde/framework/Horde/Support','StringStream.php',41]], 221],
'component_callback': ['component_callback', 'Invoke component\'s callback functions ', [['lib','moodlelib.php',7413]], 28],
'restore_question_attempt_worker': ['restore_question_attempt_worker', 'This method does the acutal work for process_question_attempt or process_{nameprefix}_question_attempt. ', [['backup/moodle2','restore_stepslib.php',5100]], 1],
'find_question_session_and_states': ['find_question_session_and_states', '', [['backup/moodle2','restore_stepslib.php',5348]], 1],
'process_grouping_group': ['process_grouping_group', '', [['backup/moodle2','restore_stepslib.php',1263]], 0],
'send_files_to_pool': ['send_files_to_pool', 'Given one component/filearea/context and optionally one source itemname to match itemids put the corresponding files in the pool ', [['backup/util/dbops','restore_dbops.class.php',848]], 13],
'process_section': ['process_section', '', [['backup/moodle2','restore_stepslib.php',1567]], 0],
'instance': ['instance', 'Returns an instance of the cache_factor method. ', [['cache','disabledlib.php',171],['cache','disabledlib.php',296],['lib/classes','useragent.php',101],['lib/htmlpurifier/HTMLPurifier','ConfigSchema.php',80],['lib/htmlpurifier/HTMLPurifier','URISchemeRegistry.php',9],['search/classes','manager.php',109],['cache','locallib.php',52],['lib/htmlpurifier/HTMLPurifier','LanguageFactory.php',53],['lib/classes','plugin_manager.php',103],['lib/htmlpurifier','HTMLPurifier.php',251],['course/format','lib.php',156],['lib/classes/update','checker.php',62],['lib/htmlpurifier/HTMLPurifier','DefinitionCacheFactory.php',31],['admin/tool/installaddon/classes','installer.php',40],['lib','modinfolib.php',373],['cache/classes','helper.php',76],['lib/tests','string_manager_standard_test.php',124],['lib/portfolio','exporter.php',251],['lib/classes/update','validator.php',88],['search/classes','document_factory.php',49],['lib','accesslib.php',6235],['lib','accesslib.php',6487],['lib','accesslib.php',6665],['lib','accesslib.php',6919],['lib','accesslib.php',7180],['lib','accesslib.php',7392],['backup/cc/cc_lib','cc_utils.php',387],['backup/cc/cc_lib','cc_utils.php',443],['lib','filterlib.php',80],['search/tests/fixtures','testable_core_search.php',43],['lib/tests/fixtures','testable_update_checker.php',45],['backup/cc','validator.php',35],['cache/classes','config.php',87],['cache/classes','factory.php',114],['lib/htmlpurifier/HTMLPurifier','EntityLookup.php',29]], 4647],
'set_sectionid': ['set_sectionid', '', [['backup/moodle2','restore_section_task.class.php',59]], 1],
'instance_by_id': ['instance_by_id', 'Get a context instance as an object, from a given context id. ', [['lib','accesslib.php',5434]], 235],
'add_legacy_availability_condition': ['add_legacy_availability_condition', 'Adds a condition from the legacy availability condition. ', [['availability/classes','info.php',512]], 7],
'get_logger': ['get_logger', '', [['backup/util/plan','backup_plan.class.php',86],['backup/util/plan','restore_plan.class.php',93],['backup/controller','base_controller.class.php',55],['backup/util/plan','base_step.class.php',116],['backup/util/plan','base_task.class.php',121]], 14],
'upgrade_extra_credit_weightoverride': ['upgrade_extra_credit_weightoverride', 'Marks all courses with changes in extra credit weight calculation ', [['lib/db','upgradelib.php',153]], 5],
'expected_alias_location': ['expected_alias_location', 'Return the expected location of a file ', [['backup/moodle2','restore_stepslib.php',4946]], 1],
'get_all_response_file_areas': ['get_all_response_file_areas', '', [['question/engine','lib.php',432]], 3],
'process_badge': ['process_badge', '', [['backup/moodle2','restore_stepslib.php',2483]], 0],
'legacy_add_to_log': ['legacy_add_to_log', 'Legacy add_to_log() code. ', [['admin/tool/log/store/legacy/classes/log','store.php',183],['admin/tool/log/classes/log','manager.php',203]], 4],
'get_attempt_upgrader': ['get_attempt_upgrader', '', [['backup/moodle2','restore_stepslib.php',5272]], 1],
'check_minmaxtouse': ['check_minmaxtouse', 'Checks what should happen with the course grade setting minmaxtouse. ', [['backup/moodle2','restore_stepslib.php',534]], 1],
'restore_get_question_banks': ['restore_get_question_banks', 'Return one array of contextid => contextlevel pairs of question banks to be checked for one given restore operation ordered from CONTEXT_SYSTEM downto CONTEXT_MODULE If contextlevel is specified, then only banks corresponding to that level are returned ', [['backup/util/dbops','restore_dbops.class.php',698]], 2],
'process_grading_instance': ['process_grading_instance', 'Processes one grading form instance element ', [['backup/moodle2','restore_stepslib.php',3507]], 0],
'close': ['close', 'Close archive, write changes to disk. ', [['lib/filestorage','zip_archive.php',183],['lib/dml','mssql_native_moodle_recordset.php',87],['auth/fc','fcFPP.php',78],['lib/dml','mysqli_native_moodle_recordset.php',86],['lib/spout/src/Spout/Reader','ReaderInterface.php',30],['lib/spout/src/Spout/Writer/ODS/Internal','Workbook.php',81],['lib/dml','pdo_moodle_recordset.php',79],['lib','csvlib.class.php',256],['lib/horde/framework/Horde/Socket','Client.php',135],['backup/util/helper','backup_null_iterator.class.php',53],['admin/tool/uploaduser','locallib.php',149],['lib/tcpdf','tcpdf.php',2943],['lib/phpunit/classes','phpmailer_sink.php',41],['lib/phpmailer','class.smtp.php',582],['lib/dml','sqlsrv_native_moodle_recordset.php',133],['lib/classes/dml','recordset_walk.php',153],['lib/spout/src/Spout/Writer/XLSX/Helper','SharedStringsHelper.php',84],['grade/export','lib.php',689],['lib','excellib.class.php',93],['backup/util/loggers','file_logger.class.php',69],['grade','lib.php',324],['backup/util/helper','backup_array_iterator.class.php',63],['lib/horde/framework/Horde/Imap/Client','Base.php',1846],['mod/assign/feedback/offline','importgradeslib.php',204],['lib/dml','oci_native_moodle_recordset.php',80],['lib/adodb','adodb.inc.php',2361],['lib/adodb','adodb.inc.php',3090],['lib/adodb','adodb.inc.php',3870],['lib/google/src/Google/Logger','File.php',132],['lib/phpunit/classes','event_sink.php',39],['lib/horde/framework/Horde','Stream.php',585],['backup/util/loggers','base_logger.class.php',89],['lib/phpexcel/PHPExcel/Shared','ZipArchive.php',71],['question/engine/tests','helpers.php',1241],['lib/spout/src/Spout/Writer','AbstractWriter.php',312],['lib','odslib.class.php',71],['lib/spout/src/Spout/Writer/Common/Internal','WorksheetInterface.php',34],['lib/spout/src/Spout/Writer/ODS/Internal','Worksheet.php',214],['lib/spout/src/Spout/Writer','WriterInterface.php',84],['lib/spout/src/Spout/Writer/XLSX/Internal','Worksheet.php',174],['lib/spout/src/Spout/Reader','AbstractReader.php',183],['lib/phpunit/classes','message_sink.php',39],['lib/spout/src/Spout/Writer/Common/Internal','WorkbookInterface.php',65],['lib/spout/src/Spout/Writer/XLSX/Internal','Workbook.php',95],['lib/pear/Net','GeoIP.php',556],['lib/tests','completionlib_test.php',907],['lib/pear/Auth','RADIUS.php',550],['lib/pear/Auth','RADIUS.php',710],['lib/pear/Auth','RADIUS.php',829],['lib','webdavlib.php',176],['lib/dml','pgsql_native_moodle_recordset.php',107]], 1128],
'groups_get_group_by_idnumber': ['groups_get_group_by_idnumber', 'Returns the groupid of a group with the idnumber specified for the course. Group idnumbers should be unique within course ', [['lib','grouplib.php',98]], 22],
'send_qtype_files': ['send_qtype_files', 'Send the question type specific files to a new context. ', [['backup/moodle2','restore_stepslib.php',4645]], 1],
'get_list_of_translations': ['get_list_of_translations', 'Returns localised list of installed translations ', [['lib/classes','string_manager_install.php',209],['lib/classes','string_manager_standard.php',504],['lib/classes','string_manager.php',102]], 23],
'or': ['or', '', [['lib/tcpdf','LICENSE.TXT',69]], 556],
'itemid_mapping': ['itemid_mapping', 'Helper method returning the mapping identifierto use for grading form instance\'s itemid field ', [['backup/moodle2','restore_gradingform_plugin.class.php',39]], 3],
'create_included_users': ['create_included_users', 'Given one restoreid, create in DB all the users present in backup_ids having newitemid = 0, as far as precheck_included_users() have left them there ready to be created. Also, annotate their newids once created for later reference. ', [['backup/util/dbops','restore_dbops.class.php',1077]], 1],
'define_execution': ['define_execution', '', [['backup/converter/imscc11','backuplib.php',59],['backup/converter/imscc11','backuplib.php',109],['backup/converter/imscc11','backuplib.php',135],['backup/moodle2','restore_stepslib.php',35],['backup/moodle2','restore_stepslib.php',65],['backup/moodle2','restore_stepslib.php',770],['backup/moodle2','restore_stepslib.php',785],['backup/moodle2','restore_stepslib.php',817],['backup/moodle2','restore_stepslib.php',833],['backup/moodle2','restore_stepslib.php',870],['backup/moodle2','restore_stepslib.php',950],['backup/moodle2','restore_stepslib.php',1005],['backup/moodle2','restore_stepslib.php',1077],['backup/moodle2','restore_stepslib.php',1101],['backup/moodle2','restore_stepslib.php',1124],['backup/moodle2','restore_stepslib.php',1143],['backup/moodle2','restore_stepslib.php',1502],['backup/moodle2','restore_stepslib.php',1521],['backup/moodle2','restore_stepslib.php',1965],['backup/moodle2','restore_stepslib.php',2092],['backup/moodle2','restore_stepslib.php',2283],['backup/moodle2','restore_stepslib.php',4534],['backup/moodle2','restore_stepslib.php',4569],['backup/moodle2','restore_stepslib.php',4689],['backup/moodle2','backup_stepslib.php',35],['backup/moodle2','backup_stepslib.php',57],['backup/moodle2','backup_stepslib.php',83],['backup/moodle2','backup_stepslib.php',210],['backup/moodle2','backup_stepslib.php',221],['backup/moodle2','backup_stepslib.php',1695],['backup/moodle2','backup_stepslib.php',1881],['backup/moodle2','backup_stepslib.php',1972],['backup/moodle2','backup_stepslib.php',1997],['backup/moodle2','backup_stepslib.php',2022],['backup/moodle2','backup_stepslib.php',2057],['backup/moodle2','backup_stepslib.php',2083],['backup/moodle2','backup_stepslib.php',2106],['backup/moodle2','backup_stepslib.php',2133],['backup/moodle2','backup_stepslib.php',2266]], 4],
'process_comment': ['process_comment', '', [['backup/moodle2','restore_stepslib.php',2399],['question/behaviour','behaviourbase.php',463],['question/behaviour/informationitem','behaviour.php',100]], 7],
'instance_allow_multiple': ['instance_allow_multiple', '', [['blocks/blog_menu','block_blog_menu.php',36],['blocks/private_files','block_private_files.php',39],['blocks/admin_bookmarks','block_admin_bookmarks.php',49],['blocks/myprofile','block_myprofile.php',188],['blocks/mentees','block_mentees.php',39],['blocks/html','block_html.php',43],['blocks/tag_flickr','block_tag_flickr.php',42],['blocks/quiz_results','block_quiz_results.php',56],['blocks/settings','block_settings.php',54],['blocks/glossary_random','block_glossary_random.php',217],['blocks/blog_tags','block_blog_tags.php',36],['blocks','moodleblock.class.php',461],['blocks/navigation','block_navigation.php',63],['blocks/comments','block_comments.php',44],['blocks/badges','block_badges.php',39],['blocks/tag_youtube','block_tag_youtube.php',59],['blocks/tags','block_tags.php',30],['blocks/activity_results','block_activity_results.php',655],['blocks/rss_client','block_rss_client.php',152]], 2],
'notify_success': ['notify_success', 'Output a success notification. ', [['admin/tool/cohortroles/classes/output','renderer.php',65],['backup/moodle2','restore_stepslib.php',4904],['admin/tool/lp/classes/output','renderer.php',255],['lib','outputrenderers.php',2928],['report/competency/classes/output','renderer.php',87]], 7],
'process_outcome': ['process_outcome', '', [['backup/moodle2','restore_stepslib.php',1438]], 0],
'process_manual_award': ['process_manual_award', '', [['backup/moodle2','restore_stepslib.php',2581],['badges/lib','awardlib.php',219]], 1],
'groups_add_member': ['groups_add_member', 'Adds a specified user to a group ', [['group','lib.php',31]], 101],
'process_module': ['process_module', '', [['backup/moodle2','restore_stepslib.php',3959]], 0],
'assign_capability': ['assign_capability', '', [['lib/tests','coursecatlib_test.php',66],['lib','accesslib.php',1538]], 303],
'groups_get_grouping_by_idnumber': ['groups_get_grouping_by_idnumber', 'Returns the groupingid of a grouping with the idnumber specified for the course. Grouping names should be unique within course ', [['lib','grouplib.php',139]], 21],
'process_legacy_quiz_attempt_data': ['process_legacy_quiz_attempt_data', 'Process the attempt data defined by {@link add_legacy_question_attempt_data()}. ', [['backup/moodle2','restore_stepslib.php',5280]], 1],
'process_log_record': ['process_log_record', '', [['backup/util/helper','restore_logs_processor.class.php',78]], 2],
'create': ['create', 'Auto-scan an incoming line to determine the response type. ', [['lib/horde/framework/Horde/Imap/Client/Interaction','Server.php',65],['lib/google/src/Google/Service','Partners.php',492],['lib/simplepie/library/SimplePie','Cache.php',95],['lib/google/src/Google/Service','YouTubeReporting.php',237],['lib/htmlpurifier/HTMLPurifier','LanguageFactory.php',81],['lib/google/src/Google/Service','MapsEngine.php',1677],['lib/google/src/Google/Service','MapsEngine.php',1977],['lib/google/src/Google/Service','MapsEngine.php',2253],['lib/google/src/Google/Service','MapsEngine.php',2330],['lib/google/src/Google/Service','MapsEngine.php',2898],['lib/spout/src/Spout/Writer','WriterFactory.php',18],['lib/google/src/Google/Service','Dns.php',290],['lib/google/src/Google/Service','Dns.php',363],['lib/google/src/Google/Service','Appengine.php',438],['tag/classes','collection.php',188],['lib/adodb','adodb-xmlschema.inc.php',152],['lib/adodb','adodb-xmlschema.inc.php',473],['lib/adodb','adodb-xmlschema.inc.php',738],['lib/adodb','adodb-xmlschema.inc.php',884],['lib/adodb','adodb-xmlschema.inc.php',1129],['mod/quiz','attemptlib.php',100],['mod/quiz','attemptlib.php',596],['lib','weblib.php',3206],['lib/htmlpurifier/HTMLPurifier','DefinitionCacheFactory.php',58],['lib/google/src/Google/Service','Dataflow.php',273],['lib/simplepie/library/SimplePie','Registry.php',153],['competency/classes','persistent.php',387],['lib/google/src/Google/Service','Cloudresourcemanager.php',373],['lib/phpexcel/PHPExcel/Shared/PCLZip','pclzip.lib.php',270],['lib/google/src/Google/Service','TagManager.php',1007],['lib/google/src/Google/Service','TagManager.php',1097],['lib/google/src/Google/Service','TagManager.php',1249],['lib/google/src/Google/Service','TagManager.php',1342],['lib/google/src/Google/Service','TagManager.php',1436],['lib/google/src/Google/Service','TagManager.php',1530],['lib/google/src/Google/Service','TagManager.php',1681],['mod/lesson','locallib.php',1011],['mod/lesson','locallib.php',2163],['mod/lesson','locallib.php',3212],['lib','modinfolib.php',1732],['repository','lib.php',206],['repository','lib.php',1910],['lib','navigationlib.php',268],['lib/htmlpurifier/HTMLPurifier','Config.php',114],['lib/google/src/Google/Service','Container.php',284],['lib/google/src/Google/Service','Genomics.php',632],['lib/google/src/Google/Service','Genomics.php',721],['lib/google/src/Google/Service','Genomics.php',1312],['lib/google/src/Google/Service','Genomics.php',1427],['lib/google/src/Google/Service','Games.php',1649],['lib/google/src/Google/Service','Games.php',2013],['lib/google/src/Google/Service','Fitness.php',377],['lib/google/src/Google/Service','Gmail.php',747],['lib/google/src/Google/Service','Gmail.php',905],['mod/quiz/classes','structure.php',65],['lib/htmlpurifier/HTMLPurifier','ElementDef.php',135],['lib/adodb','adodb-xmlschema03.inc.php',170],['lib/adodb','adodb-xmlschema03.inc.php',514],['lib/adodb','adodb-xmlschema03.inc.php',779],['lib/adodb','adodb-xmlschema03.inc.php',930],['lib/adodb','adodb-xmlschema03.inc.php',1228],['lib/google/src/Google/Service','Proximitybeacon.php',500],['tag/classes','area.php',205],['course','lib.php',3003],['question/type/ddmarker','shapes.php',170],['lib/classes/event','base.php',149],['lib','coursecatlib.php',325],['repository/filesystem','lib.php',498],['lib/google/src/Google/Service','Storagetransfer.php',281],['calendar','lib.php',2686],['lib/htmlpurifier/HTMLPurifier','Lexer.php',53],['lib/google/src/Google/Service','Classroom.php',445],['lib/google/src/Google/Service','Classroom.php',596],['lib/google/src/Google/Service','Classroom.php',673],['lib/google/src/Google/Service','Classroom.php',783],['lib/google/src/Google/Service','Classroom.php',912],['lib/spout/src/Spout/Reader','ReaderFactory.php',18],['lib/google/src/Google/Service','Pubsub.php',220],['lib/google/src/Google/Service','Pubsub.php',365],['lib/google/src/Google/Service','CloudMonitoring.php',258]], 3276],
'get_blockname': ['get_blockname', '', [['backup/moodle2','backup_block_task.class.php',84],['backup/moodle2','restore_block_task.class.php',109],['lib/testing/generator','block_generator.php',51]], 6],
'questions_recode_response_data': ['questions_recode_response_data', 'Recode the respones data for a particular step of an attempt at at particular question. ', [['backup/moodle2','restore_stepslib.php',5175]], 3],
'add_instance': ['add_instance', 'Add new instance of enrol plugin. ', [['enrol/manual','lib.php',147],['lib','enrollib.php',1745],['enrol/self','lib.php',958],['enrol/cohort','lib.php',99],['mod/assign','locallib.php',600],['tag/classes','tag.php',543],['enrol/lti','lib.php',88],['enrol/paypal','lib.php',124],['enrol/guest','lib.php',247],['enrol/meta','lib.php',131]], 91],
'create_file_from_reference': ['create_file_from_reference', 'Create a new alias/shortcut file from file reference information ', [['lib/filestorage','file_storage.php',1599]], 17],
'process_assignment': ['process_assignment', 'Assign roles ', [['backup/moodle2','restore_stepslib.php',2009],['mod/assignment/backup/moodle2','restore_assignment_stepslib.php',56],['mod/assignment/backup/moodle1','lib.php',75]], 0],
'load_roles_to_tempids': ['load_roles_to_tempids', 'Load the needed role.xml file to backup_ids table for future reference ', [['backup/util/dbops','restore_dbops.class.php',144]], 2],
'process_included_roles': ['process_included_roles', 'Process the loaded roles, looking for their best mapping or skipping Any error will cause exception. Note this is one wrapper over precheck_included_roles, that contains all the logic, but returns errors/warnings instead and is executed as part of the restore prechecks ', [['backup/util/dbops','restore_dbops.class.php',401]], 1],
'progress': ['progress', 'Called during a file processing operation that reports progress. ', [['lib/filestorage','file_progress.php',35],['lib/filestorage/tests','tgz_packer_test.php',458],['lib/classes/progress','base.php',157],['backup/moodle2','backup_stepslib.php',1945],['lib/filestorage/tests','zip_packer_test.php',622],['backup/util/ui','restore_ui_stage.class.php',334]], 110],
'set_blockid': ['set_blockid', '', [['backup/moodle2','restore_block_task.class.php',113]], 1],
'process_question_attempt_step': ['process_question_attempt_step', 'Process question_attempt_steps ', [['backup/moodle2','restore_stepslib.php',5058]], 0],
'restore_sync_course': ['restore_sync_course', 'Automatic enrol sync executed during restore. Useful for automatic sync by course->idnumber or course category. ', [['lib','enrollib.php',2422],['enrol/ldap','lib.php',1097],['enrol/category','lib.php',113],['enrol/database','lib.php',932]], 2],
'process_log': ['process_log', 'Process log entries. ', [['admin/tool/log/backup/moodle2','restore_tool_log_logstore_subplugin.class.php',38],['backup/moodle2','restore_stepslib.php',3030],['backup/moodle2','restore_stepslib.php',3077]], 2],
'insert_record': ['insert_record', 'Insert a record into a table and return the "id" field if required, Some conversions and safety checks are carried out. Lobs are supported. If the return ID isn\'t required, then this just reports success as true/false. $data is an object containing needed data ', [['lib/dml','pdo_moodle_database.php',387],['lib/dml','oci_native_moodle_database.php',1297],['lib/dml','pgsql_native_moodle_database.php',889],['lib/dml','mssql_native_moodle_database.php',962],['lib/dml','mysqli_native_moodle_database.php',1185],['question/engine/upgrade','upgradelib.php',124],['lib/dml','sqlsrv_native_moodle_database.php',1045],['lib/dml/tests','dml_test.php',5548]], 1611],
'process_included_users': ['process_included_users', 'Process the needed users in order to decide which action to perform with them (create/map) ', [['backup/util/dbops','restore_dbops.class.php',1599]], 1],
'get_cm': ['get_cm', 'Returns the current course module ', [['mod/feedback/classes','complete_form.php',245],['search/classes','base_mod.php',51],['mod/feedback/classes','structure.php',72],['mod/quiz','attemptlib.php',215],['mod/quiz','attemptlib.php',742],['lib','modinfolib.php',222],['comment','lib.php',1010]], 137],
'rewrite_step_backup_file_for_legacy_freeze': ['rewrite_step_backup_file_for_legacy_freeze', 'Rewrite step definition to handle the legacy freeze attribute. ', [['backup/moodle2','restore_stepslib.php',600]], 1],
'add_result': ['add_result', 'Saves the results to an array ', [['backup/util/structure','backup_nested_element.class.php',155],['backup/util/plan','base_plan.class.php',82],['backup/util/plan','base_task.class.php',227]], 8],
'unpack_reference': ['unpack_reference', 'Unpack reference field ', [['lib/filestorage','file_storage.php',2215]], 10],
'get_old_courseid': ['get_old_courseid', '', [['backup/util/plan','restore_task.class.php',86]], 1],
'get_taskbasepath': ['get_taskbasepath', 'Block tasks have their own directory to write files ', [['backup/moodle2','backup_block_task.class.php',104],['backup/moodle2','restore_activity_task.class.php',64],['backup/moodle2','restore_block_task.class.php',58],['backup/moodle2','backup_section_task.class.php',60],['backup/util/plan/tests/fixtures','plan_fixtures.php',76],['backup/moodle2','restore_section_task.class.php',51],['backup/moodle2','backup_course_task.class.php',54],['backup/moodle2','restore_course_task.class.php',49],['backup/moodle2','backup_activity_task.class.php',110],['backup/util/plan','base_task.class.php',117]], 20],
'process_calendarevents': ['process_calendarevents', '', [['backup/moodle2','restore_stepslib.php',2625]], 0],
'end_progress': ['end_progress', 'Marks the end of an operation that will display progress. ', [['lib/classes/progress','base.php',129]], 73],
'course_get_format': ['course_get_format', 'Returns an instance of format class (extending format_base) for given course ', [['course/format','lib.php',27]], 99],
'get_target': ['get_target', '', [['backup/util/plan','restore_task.class.php',50],['backup/util/plan','restore_plan.class.php',111],['backup/util/ui','restore_ui_stage.class.php',571],['backup/controller','restore_controller.class.php',289]], 25],
'get_config': ['get_config', 'Config get method. ', [['lib/classes/antivirus','scanner.php',54],['competency/classes','competency_rule.php',59],['question/engine','bank.php',109],['admin/tool/log/classes/helper','store.php',63],['lib','moodlelib.php',1409],['lib','enrollib.php',1142],['lib/editor/tinymce/classes','plugin.php',73],['competency/classes','competency_rule_points.php',43],['search/classes','base.php',169],['mod/assign','assignmentplugin.php',345],['lib/portfolio','plugin.php',546]], 934],
'convert_question_attempt': ['convert_question_attempt', '', [['question/engine/upgrade','upgradelib.php',218]], 52],
'filter_is_enabled': ['filter_is_enabled', '', [['lib','filterlib.php',667]], 9],
'add_question_usages': ['add_question_usages', 'Attach below $element (usually attempts) the needed restore_path_elements to restore question_usages and all they contain. ', [['backup/moodle2','restore_stepslib.php',5001],['backup/moodle2','backup_stepslib.php',133]], 2],
'enrol_is_enabled': ['enrol_is_enabled', 'Checks if a given plugin is in the list of enabled enrolment plugins. ', [['lib','enrollib.php',171]], 60],
'update_after_restore': ['update_after_restore', 'Updates this node after restore, returning true if anything changed. The default behaviour is simply to return false. If there is a problem with the update, $logger can be used to output a warning. ', [['availability/classes','tree_node.php',104],['availability/condition/grouping/classes','condition.php',178],['availability/condition/group/classes','condition.php',147],['availability/classes','tree.php',675],['availability/condition/completion/classes','condition.php',205],['availability/classes','info.php',305],['availability/condition/date/classes','condition.php',227],['availability/condition/grade/classes','condition.php',271]], 4],
'add_result_item': ['add_result_item', 'Append a value to the given resultset ', [['backup/moodle2','restore_stepslib.php',4966]], 1],
'set_mapping': ['set_mapping', 'To send ids pairs to backup_ids_table and to store them into paths ', [['backup/moodle2','restore_plugin.class.php',169],['backup/moodle2','restore_subplugin.class.php',101],['backup/util/plan','restore_structure_step.class.php',158]], 131],
'get_records_sql': ['get_records_sql', 'Get a number of records as an array of objects. ', [['lib/dml','pdo_moodle_database.php',309],['lib/dml','oci_native_moodle_database.php',1145],['lib/dml','pgsql_native_moodle_database.php',732],['lib/dml','mssql_native_moodle_database.php',805],['lib/dml','mysqli_native_moodle_database.php',1057],['lib/dml','sqlsrv_native_moodle_database.php',890],['lib/dml/tests','dml_test.php',5545]], 700],
'process_course_format_options': ['process_course_format_options', '', [['backup/moodle2','restore_stepslib.php',1714]], 0],
'get_old_contextid': ['get_old_contextid', '', [['backup/moodle2','restore_activity_task.class.php',119],['backup/moodle2','restore_block_task.class.php',141],['backup/util/plan','restore_task.class.php',90]], 13],
'fputs': ['fputs', 'Wrapper around global function fputs() ', [['lib/spout/src/Spout/Common/Helper','GlobalFunctionsHelper.php',41]], 41],
'get_instance': ['get_instance', 'Get the DB record for the current instance. ', [['course','moodleform_mod.php',116],['question/engine','bank.php',464],['backup/util/output','output_controller.class.php',53],['repository','lib.php',1137],['backup/util/helper','restore_logs_processor.class.php',69],['grade/grading/form','lib.php',474],['mnet/service/enrol','locallib.php',57],['mod/assign','locallib.php',1224],['lib','externallib.php',1000],['blog','locallib.php',857]], 420],
'get_path': ['get_path', '', [['backup/util/structure','restore_path_element.class.php',102],['lib','weblib.php',880],['competency/tests','persistent_test.php',530],['mod/lti/service/profile/classes/local/resource','profile.php',59],['backup/converter/moodle1','lib.php',1040],['mod/lti/classes/local/ltiservice','resource_base.php',103]], 56],
'process_config': ['process_config', 'Processes and stores configuration data for this authentication plugin. ', [['auth/radius','auth.php',185],['auth/nntp','auth.php',121],['auth/email','auth.php',233],['backup/moodle2','restore_stepslib.php',2363],['auth/mnet','auth.php',690],['auth/imap','auth.php',158],['auth/webservice','auth.php',151],['auth/shibboleth','auth.php',242],['auth/pam','auth.php',133],['auth/manual','auth.php',203],['auth/none','auth.php',149],['auth/ldap','auth.php',1837],['lib','authlib.php',423],['auth/fc','auth.php',226],['auth/pop3','auth.php',154],['auth/cas','auth.php',284],['auth/db','auth.php',764]], 3],
'process_grade_grade': ['process_grade_grade', '', [['backup/moodle2','restore_stepslib.php',254],['backup/moodle2','restore_stepslib.php',740],['backup/moodle2','restore_stepslib.php',3645],['backup/moodle2','restore_stepslib.php',3736]], 0],
'process_tag': ['process_tag', '', [['backup/moodle2','restore_stepslib.php',1910],['backup/moodle2','restore_stepslib.php',4054],['backup/moodle2','restore_stepslib.php',4449]], 0],
'get_plugin_list': ['get_plugin_list', 'Use when listing real plugins of one type. ', [['lib','deprecatedlib.php',150],['lib/classes','component.php',796],['admin/tool/monitor/classes','eventlist.php',176]], 191],
'process_user_competency_course': ['process_user_competency_course', 'Process the user competency course. ', [['backup/moodle2','restore_stepslib.php',3278]], 0],
'is_dir': ['is_dir', '', [], 211],
'preg_replace': ['preg_replace', '', [], 917],
'array_key_exists': ['array_key_exists', '', [], 1445],
'reset': ['reset', '', [], 1213],
'unserialize': ['unserialize', '', [], 192],
'base64_decode': ['base64_decode', '', [], 92],
'floatval': ['floatval', '', [], 101],
'fclose': ['fclose', '', [], 275],
'array_keys': ['array_keys', '', [], 1256],
'str_replace': ['str_replace', '', [], 1648],
'preg_match': ['preg_match', '', [], 1286],
'serialize': ['serialize', '', [], 282],
'rtrim': ['rtrim', '', [], 165],
'substr_count': ['substr_count', '', [], 72],
'log': ['log', '', [], 2031],
'preg_match_all': ['preg_match_all', '', [], 161],
'defined': ['defined', '', [], 4731],
'strtotime': ['strtotime', '', [], 245],
'class_exists': ['class_exists', '', [], 279],
'array_merge': ['array_merge', '', [], 2944],
'max': ['max', '', [], 1266],
'feof': ['feof', '', [], 52],
'ksort': ['ksort', '', [], 153],
'explode': ['explode', '', [], 1572],
'substr': ['substr', '', [], 2823],
'fgets': ['fgets', '', [], 44],
'rename': ['rename', '', [], 48],
'in_array': ['in_array', '', [], 1234],
'is_null': ['is_null', '', [], 2003],
'base64_encode': ['base64_encode', '', [], 134],
'min': ['min', '', [], 898],
'implode': ['implode', '', [], 1281],
'is_array': ['is_array', '', [], 1608],
'strpos': ['strpos', '', [], 1604],
'method_exists': ['method_exists', '', [], 265],
'time': ['time', '', [], 1959],
'file_exists': ['file_exists', '', [], 867],
'count': ['count', '', [], 4095],
'array_values': ['array_values', '', [], 342]};
CLASS_DATA={
'restore_logs_processor': ['restore_logs_processor', 'This class is one varying singleton that, for all the logs corresponding to one task, is in charge of storing all its {@link restore_log_rule} rules, dispatching to the correct one and insert/log the resulting information. ', [['backup/util/helper','restore_logs_processor.class.php',27]], 4],
'competency': ['competency', 'Competency framework form. ', [['admin/tool/lp/classes/form','competency.php',30],['competency/classes','competency.php',34]], 250],
'restore_userscompletion_structure_step': ['restore_userscompletion_structure_step', 'Structure step that will process the user activity completion information if all these conditions are met: - Target site has completion enabled ($CFG->enablecompletion) - Activity includes completion info (file_exists) ', [['backup/moodle2','restore_stepslib.php',4157]], 1],
'competency_framework': ['competency_framework', 'Competency framework form. ', [['admin/tool/lp/classes/form','competency_framework.php',30],['competency/classes','competency_framework.php',34]], 45],
'restore_decode_processor': ['restore_decode_processor', 'Helper class that will perform all the necessary decoding tasks on restore ', [['backup/util/helper','restore_decode_processor.class.php',27]], 2],
'restore_create_categories_and_questions': ['restore_create_categories_and_questions', 'Structure step in charge of creating/mapping all the qcats and qs by parsing the questions.xml file and checking it against the results calculated by {@link restore_process_categories_and_questions} and stored in backup_ids_temp ', [['backup/moodle2','restore_stepslib.php',4276]], 1],
'restore_execute_after_restore': ['restore_execute_after_restore', 'Review all the tasks having one after_restore method executing it to perform some final adjustments of information not available when the task was executed. ', [['backup/moodle2','restore_stepslib.php',810]], 1],
'restore_ras_and_caps_structure_step': ['restore_ras_and_caps_structure_step', '', [['backup/moodle2','restore_stepslib.php',1993]], 3],
'coding_exception': ['coding_exception', 'Exception indicating programming error, must be fixed by a programer. For example a core API might throw this type of exception if a plugin calls it incorrectly. ', [['lib','setuplib.php',239]], 1200],
'restore_fix_restorer_access_step': ['restore_fix_restorer_access_step', 'Make sure the user restoring the course can actually access it. ', [['backup/moodle2','restore_stepslib.php',2279]], 1],
'info': ['info', 'Defines the structure of objects returned by {@link \core\update\checker::get_update_info()} ', [['lib/classes/update','info.php',28]], 53],
'restore_default_enrolments_step': ['restore_default_enrolments_step', 'If no instances yet add default enrol methods the same way as when creating new course in UI. ', [['backup/moodle2','restore_stepslib.php',2087]], 1],
'restore_gradebook_structure_step': ['restore_gradebook_structure_step', 'Restore calculated grade items, grade categories etc ', [['backup/moodle2','restore_stepslib.php',78]], 1],
'restore_module_structure_step': ['restore_module_structure_step', 'Structure step to restore common course_module information ', [['backup/moodle2','restore_stepslib.php',3919]], 1],
'evidence': ['evidence', 'Evidence persistent class. ', [['competency/classes','evidence.php',35]], 97],
'restore_groups_structure_step': ['restore_groups_structure_step', 'Structure step that will create all the needed groups and groupings by loading them from the groups.xml file performing the required matches. Note group members only will be added if restoring user info ', [['backup/moodle2','restore_stepslib.php',1150]], 1],
'restore_create_and_clean_temp_stuff': ['restore_create_and_clean_temp_stuff', 'delete old directories and conditionally create backup_temp_ids table ', [['backup/moodle2','restore_stepslib.php',30]], 1],
'core_component': ['core_component', 'Collection of components related methods. ', [['lib/classes','component.php',41]], 511],
'restore_enrolments_structure_step': ['restore_enrolments_structure_step', 'This structure steps restores the enrol plugins and their underlying enrolments, performing all the mappings and/or movements required ', [['backup/moodle2','restore_stepslib.php',2116]], 1],
'restore_course_completion_structure_step': ['restore_course_completion_structure_step', '', [['backup/moodle2','restore_stepslib.php',2707]], 1],
'repository': ['repository', 'Class for repositories ', [['lib/classes/plugininfo','repository.php',30]], 210],
'restore_activity_competencies_structure_step': ['restore_activity_competencies_structure_step', 'Restore activity competencies structure step. ', [['backup/moodle2','restore_stepslib.php',3336]], 1],
'restore_drop_and_clean_temp_stuff': ['restore_drop_and_clean_temp_stuff', 'delete the temp dir used by backup/restore (conditionally), delete old directories and drop temp ids table ', [['backup/moodle2','restore_stepslib.php',59]], 1],
'restore_filters_structure_step': ['restore_filters_structure_step', 'This structure steps restores the filters and their configs ', [['backup/moodle2','restore_stepslib.php',2330]], 2],
'restore_process_course_modules_availability': ['restore_process_course_modules_availability', 'Process legacy module availability records in backup_ids. ', [['backup/moodle2','restore_stepslib.php',935]], 1],
'restore_update_availability': ['restore_update_availability', 'Updates the availability data for course modules and sections. ', [['backup/moodle2','restore_stepslib.php',857]], 1],
'restore_create_question_files': ['restore_create_question_files', 'Execution step that will create all the question/answers/qtype-specific files for the restored questions. It must be executed after {@link restore_move_module_questions_categories} because only then each question is in its final category and only then the contexts can be determined. ', [['backup/moodle2','restore_stepslib.php',4558]], 1],
'context_block': ['context_block', 'Block context class ', [['lib','accesslib.php',7281]], 30],
'restore_activity_grade_history_structure_step': ['restore_activity_grade_history_structure_step', 'Step in charge of restoring the grade history of an activity. ', [['backup/moodle2','restore_stepslib.php',3695]], 1],
'restore_activity_logs_structure_step': ['restore_activity_logs_structure_step', 'This structure step restores activity logs, extending {@link restore_course_logs_structure_step} sharing its same structure but modifying the way records are handled ', [['backup/moodle2','restore_stepslib.php',3071]], 1],
'restore_activity_grades_structure_step': ['restore_activity_grades_structure_step', 'This structure step restores the grade items associated with one activity All the grade items are made child of the "course" grade item but the original categoryid is saved as parentitemid in the backup_ids table, so, when restoring the complete gradebook (categories and calculations), that information is available there ', [['backup/moodle2','restore_stepslib.php',3550]], 1],
'restore_process_file_aliases_queue': ['restore_process_file_aliases_queue', 'Try to restore aliases and references to external files. ', [['backup/moodle2','restore_stepslib.php',4667]], 1],
'restore_course_legacy_files_step': ['restore_course_legacy_files_step', 'Execution step that will migrate legacy files if present. ', [['backup/moodle2','restore_stepslib.php',1961]], 1],
'restore_course_structure_step': ['restore_course_structure_step', 'Structure step that will read the course.xml file, loading it and performing various actions depending of the site/restore settings. Note that target course always exist before arriving here so this step will be updating the course record (never inserting) ', [['backup/moodle2','restore_stepslib.php',1748]], 1],
'file_storage': ['file_storage', 'File storage class used for low level access to stored files. ', [['lib/filestorage','file_storage.php',30]], 21],
'restore_load_included_inforef_records': ['restore_load_included_inforef_records', '', [['backup/moodle2','restore_stepslib.php',1003]], 1],
'cache_helper': ['cache_helper', 'The cache helper class. ', [['cache/classes','helper.php',31]], 139],
'restore_groups_members_structure_step': ['restore_groups_members_structure_step', 'Structure step that will create all the needed group memberships by loading them from the groups.xml file performing the required matches. ', [['backup/moodle2','restore_stepslib.php',1284]], 1],
'restore_move_module_questions_categories': ['restore_move_module_questions_categories', 'Execution step that will move all the CONTEXT_MODULE question categories created at early stages of restore in course context (because modules weren\'t created yet) to their target module (matching by old-new-contextid mapping) ', [['backup/moodle2','restore_stepslib.php',4527]], 1],
'restore_process_categories_and_questions': ['restore_process_categories_and_questions', 'Execution step that, *conditionally* (if there isn\'t preloaded information) will process all the needed categories and questions in order to decide and perform any action with them (create / map / error) Note: Any error will cause exception, as far as this is the same processing than the one into restore prechecks (that should have stopped process earlier) ', [['backup/moodle2','restore_stepslib.php',1512]], 1],
'restore_calendarevents_structure_step': ['restore_calendarevents_structure_step', 'This structure steps restores the calendar events ', [['backup/moodle2','restore_stepslib.php',2611]], 2],
'restore_load_and_map_roles': ['restore_load_and_map_roles', 'Execution step that, *conditionally* (if there isn\'t preloaded information), will load all the needed roles to backup_temp_ids. They will be stored with "role" itemname. Also it will perform one automatic mapping to roles existing in the target site, based in permissions of the user performing the restore, archetypes and other bits. At the end, each original role will have its associated target role or 0 if it\'s going to be skipped. Note we wrap everything over one restore_dbops method, as far as the same stuff is going to be also executed by restore prechecks ', [['backup/moodle2','restore_stepslib.php',1065]], 1],
'question_engine_attempt_upgrader': ['question_engine_attempt_upgrader', 'This class manages upgrading all the question attempts from the old database structure to the new question engine. ', [['question/engine/upgrade','upgradelib.php',36]], 2],
'context_course': ['context_course', 'Course context class ', [['lib','accesslib.php',6817]], 1323],
'restore_load_included_users': ['restore_load_included_users', 'Execution step that, *conditionally* (if there isn\'t preloaded information and users have been selected in settings, will load all the needed users to backup_temp_ids. They will be stored with "user" itemname and with their original contextid as paremitemid ', [['backup/moodle2','restore_stepslib.php',1093]], 1],
'restore_step_exception': ['restore_step_exception', '', [['backup/util/plan','restore_step.class.php',102]], 43],
'restore_review_pending_block_positions': ['restore_review_pending_block_positions', 'Review all the (pending) block positions in backup_ids, matching by contextid, creating positions as needed. This is executed by the final task, once all the contexts have been created ', [['backup/moodle2','restore_stepslib.php',826]], 1],
'restore_decode_interlinks': ['restore_decode_interlinks', 'decode all the interlinks present in restored content relying 100% in the restore_decode_processor that handles both the contents to modify and the rules to be applied ', [['backup/moodle2','restore_stepslib.php',763]], 1],
'restore_grade_history_structure_step': ['restore_grade_history_structure_step', 'Step in charge of restoring the grade history of a course. ', [['backup/moodle2','restore_stepslib.php',680]], 1],
'restore_load_categories_and_questions': ['restore_load_categories_and_questions', 'Execution step that, *conditionally* (if there isn\'t preloaded information will load all the question categories and questions (header info only) to backup_temp_ids. They will be stored with "question_category" and "question" itemnames and with their original contextid and question category id as paremitemids ', [['backup/moodle2','restore_stepslib.php',1493]], 1],
'restore_process_included_users': ['restore_process_included_users', 'Execution step that, *conditionally* (if there isn\'t preloaded information and users have been selected in settings, will process all the needed users in order to decide and perform any action with them (create / map / error) Note: Any error will cause exception, as far as this is the same processing than the one into restore prechecks (that should have stopped process earlier) ', [['backup/moodle2','restore_stepslib.php',1115]], 1],
'restore_section_structure_step': ['restore_section_structure_step', 'Structure step that will read the section.xml creating/updating sections as needed, rebuilding course cache and other friends ', [['backup/moodle2','restore_stepslib.php',1530]], 2],
'restore_course_logstores_structure_step': ['restore_course_logstores_structure_step', 'Structure step in charge of restoring the logstores.xml file for the course logs. ', [['backup/moodle2','restore_stepslib.php',3120]], 2],
'course_competency': ['course_competency', 'Class for loading/storing course_competencies from the DB. ', [['competency/classes','course_competency.php',31]], 64],
'core_tag_tag': ['core_tag_tag', 'Represents one tag and also contains lots of useful tag-related methods as static functions. ', [['tag/classes','tag.php',27]], 352],
'restore_outcomes_structure_step': ['restore_outcomes_structure_step', 'Structure step that will create all the needed outocomes by loading them from the outcomes.xml ', [['backup/moodle2','restore_stepslib.php',1425]], 1],
'restore_rebuild_course_cache': ['restore_rebuild_course_cache', 'first, ensure that we have no gaps in section numbers and then, rebuid the course cache ', [['backup/moodle2','restore_stepslib.php',779]], 1],
'restore_block_instance_structure_step': ['restore_block_instance_structure_step', 'This structure steps restores one instance + positions of one block Note: Positions corresponding to one existing context are restored here, but all the ones having unknown contexts are sent to backup_ids for a later chance to be restored at the end (final task) ', [['backup/moodle2','restore_stepslib.php',3759]], 1],
'course_module_competency': ['course_module_competency', 'Class for loading/storing course_module_competencies from the DB. ', [['competency/classes','course_module_competency.php',30]], 43],
'restore_create_included_users': ['restore_create_included_users', 'Execution step that will create all the needed users as calculated by @restore_process_included_users (those having newiteind = 0) ', [['backup/moodle2','restore_stepslib.php',1137]], 1],
'restore_scales_structure_step': ['restore_scales_structure_step', 'Structure step that will create all the needed scales by loading them from the scales.xml ', [['backup/moodle2','restore_stepslib.php',1363]], 1],
'grade_grade': ['grade_grade', 'grade_grades is an object mapped to DB table {prefix}grade_grades ', [['lib/grade','grade_grade.php',30]], 154],
'api': ['api', 'Class for doing things with cohort roles. ', [['admin/tool/cohortroles/classes','api.php',30],['admin/tool/mobile/classes','api.php',31],['competency/classes','api.php',41],['lib/classes/update','api.php',33],['admin/tool/templatelibrary/classes','api.php',33]], 699],
'restore_course_competencies_structure_step': ['restore_course_competencies_structure_step', 'Restore course competencies structure step. ', [['backup/moodle2','restore_stepslib.php',3189]], 1],
'grade_item': ['grade_item', 'Class representing a grade item. ', [['lib/grade','grade_item.php',29]], 246],
'restore_path_element': ['restore_path_element', 'Class representing one path to be restored from XML file ', [['backup/util/structure','restore_path_element.class.php',27]], 232],
'context_module': ['context_module', 'Course module context class ', [['lib','accesslib.php',7039]], 1106],
'restore_comments_structure_step': ['restore_comments_structure_step', 'This structure steps restores the comments Note: Cannot use the comments API because defaults to USER->id. That should change allowing to pass $userid ', [['backup/moodle2','restore_stepslib.php',2383]], 3],
'restore_activity_grading_structure_step': ['restore_activity_grading_structure_step', 'Defines the restore step for advanced grading methods attached to the activity module ', [['backup/moodle2','restore_stepslib.php',3411]], 1],
'restore_badges_structure_step': ['restore_badges_structure_step', 'This structure steps restores the badges and their configs ', [['backup/moodle2','restore_stepslib.php',2426]], 1],
'grade_category': ['grade_category', 'grade_category is an object mapped to DB table {prefix}grade_categories ', [['lib/grade','grade_category.php',29]], 180],
'restore_activity_logstores_structure_step': ['restore_activity_logstores_structure_step', 'Structure step in charge of restoring the logstores.xml file for the activity logs. ', [['backup/moodle2','restore_stepslib.php',3181]], 1],
'restore_course_logs_structure_step': ['restore_course_logs_structure_step', 'This structure step restores course logs (cmid = 0), delegating the hard work to the corresponding {@link restore_logs_processor} passing the collection of {@link restore_log_rule} rules to be observed as they are defined by the task. Note this is only executed based in the \'logs\' setting. ', [['backup/moodle2','restore_stepslib.php',2981]], 2],
'restore_load_included_files': ['restore_load_included_files', '', [['backup/moodle2','restore_stepslib.php',1032]], 1],
'context_system': ['context_system', 'System context class ', [['lib','accesslib.php',6157]], 1147],
'course_competency_settings': ['course_competency_settings', 'Class for course_competency_settings persistence. ', [['competency/classes','course_competency_settings.php',31]], 17]};
CONST_DATA={
'IGNORE_MULTIPLE': ['IGNORE_MULTIPLE', '', [['lib','dmllib.php',50]], 43],
'MUST_EXIST': ['MUST_EXIST', '', [['lib','dmllib.php',52]], 1384],
'GRADE_MIN_MAX_FROM_GRADE_GRADE': ['GRADE_MIN_MAX_FROM_GRADE_GRADE', '', [['lib/grade','constants.php',265]], 22],
'BADGE_STATUS_INACTIVE': ['BADGE_STATUS_INACTIVE', '', [['lib','badgeslib.php',51]], 12],
'BADGE_TYPE_COURSE': ['BADGE_TYPE_COURSE', '', [['lib','badgeslib.php',85]], 28],
'SITEID': ['SITEID', '', [['admin/cli','install.php',219],['lib/db','install.php',87],['','install.php',242],['lib','setup.php',755]], 608],
'CONTEXT_MODULE': ['CONTEXT_MODULE', '', [['lib','accesslib.php',150]], 466],
'CAP_PREVENT': ['CAP_PREVENT', '', [['lib','accesslib.php',137]], 44],
'BADGE_CRITERIA_TYPE_COURSE': ['BADGE_CRITERIA_TYPE_COURSE', '', [['badges/criteria','award_criteria.php',57]], 7],
'MOODLE_INTERNAL': ['MOODLE_INTERNAL', '', [['admin/cli','install.php',140],['','install.php',93],['lib','setup.php',391]], 4153],
'DEBUG_DEVELOPER': ['DEBUG_DEVELOPER', '', [['lib','setuplib.php',40]], 736],
'GRADE_MIN_MAX_FROM_GRADE_ITEM': ['GRADE_MIN_MAX_FROM_GRADE_ITEM', '', [['lib/grade','constants.php',260]], 19],
'SYSCONTEXTID': ['SYSCONTEXTID', '', [['lib','accesslib.php',6316]], 72],
'SQL_PARAMS_NAMED': ['SQL_PARAMS_NAMED', '', [['lib/dml','moodle_database.php',32]], 315],
'BADGE_CRITERIA_TYPE_ACTIVITY': ['BADGE_CRITERIA_TYPE_ACTIVITY', '', [['badges/criteria','award_criteria.php',39]], 8],
'BADGE_CRITERIA_TYPE_MANUAL': ['BADGE_CRITERIA_TYPE_MANUAL', '', [['badges/criteria','award_criteria.php',45]], 9],
'ENROL_INSTANCE_ENABLED': ['ENROL_INSTANCE_ENABLED', '', [['lib','enrollib.php',31]], 115]};
</script>
<div id="func-popup" class="funcpopup"><p id="func-title" class="popup-title">title</p><p id="func-desc" class="popup-desc">Description</p><p id="func-body" class="popup-body">Body</p></div>
<div id="class-popup" class="funcpopup"><p id="class-title" class="popup-title">title</p><p id="class-desc" class="popup-desc">Description</p><p id="class-body" class="popup-body">Body</p></div>
<div id="const-popup" class="funcpopup"><p id="const-title" class="popup-title">title</p><p id="const-desc" class="popup-desc">Description</p><p id="const-body" class="popup-body">Body</p></div>
<div id="req-popup" class="funcpopup"><p id="req-title" class="popup-title">title</p><p id="req-body" class="popup-body">Body</p></div>
<!-- A link to the phpxref site in your customized footer file is appreciated ;-) -->
<br><hr>
<table width="100%">
	<tr><td>Generated: Thu Aug 11 10:00:09 2016</td>
	<td align="right"><i>Cross-referenced by <a href="http://phpxref.sourceforge.net/">PHPXref 0.7.1</a></i></td>
	</tr>
</table>
</body></html>
