<!doctype html public "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
    <title>PHPXRef 0.7.1 : Unnamed Project : Detail view of restore_dbops.class.php</title>
    <link rel="stylesheet" href="../../../sample.css" type="text/css">
    <link rel="stylesheet" href="../../../sample-print.css" type="text/css" media="print">
    <style id="hilight" type="text/css"></style>
    <meta http-equiv="content-type" content="text/html;charset=iso-8859-1">
</head>
<body bgcolor="#ffffff" text="#000000" link="#801800" vlink="#300540" alink="#ffffff">
<table class="pagetitle" width="100%">
	<tr>
        <td valign="top" class="pagetitle">
            [ <a href="../../../index.html">Index</a> ]
        </td>
        <td align="right" class="pagetitle">
		    <h2 style="margin-bottom: 0px">PHP Cross Reference of Unnamed Project</h2>
	    </td>
    </tr>
</table>


<!-- Generated by PHPXref 0.7.1 at Thu May 28 19:17:31 2015 -->
<!-- PHPXref (c) 2000-2010 Gareth Watts - gareth@omnipotent.net -->
<!-- http://phpxref.sourceforge.net/ -->

<script src="../../../phpxref.js" type="text/javascript"></script>
<script language="JavaScript" type="text/javascript">
<!--
ext='.html';
relbase='../../../';
subdir='backup/util/dbops';
filename='restore_dbops.class.php.html';
cookiekey='phpxref';
handleNavFrame(relbase, subdir, filename);

// -->
</script>
<script language="JavaScript" type="text/javascript">
if (gwGetCookie('xrefnav')=='off')
  document.write('<p class="navlinks">[ <a href="javascript:navOn()">Show Explorer<\/a> ]<\/p>');
else
  document.write('<p class="navlinks">[ <a href="javascript:navOff()">Hide Explorer<\/a> ]<\/p>');
</script>
<noscript>
<p class="navlinks">
[ <a href="../../../nav.html" target="_top">Show Explorer</a> ]
[ <a href="index.html" target="_top">Hide Navbar</a> ]
</p>
</noscript>
<script language="JavaScript" type="text/javascript">
<!--

document.writeln('<table align="right" class="searchbox-link"><tr><td><a class="searchbox-link" href="javascript:void(0)" onMouseOver="showSearchBox()">Search</a><br>');
document.writeln('<table border="0" cellspacing="0" cellpadding="0" class="searchbox" id="searchbox">');
document.writeln('<tr><td class="searchbox-title">');
document.writeln('<a class="searchbox-title" href="javascript:showSearchPopup()">Search History +</a>');
document.writeln('<\/td><\/tr>');

document.writeln('<tr><td class="searchbox-body" id="searchbox-body">');
document.writeln('<form name="search" style="margin:0px; padding:0px" onSubmit=\'return jump()\'>');
document.writeln('<a class="searchbox-body" href="../../../_classes/index.html">Class<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="classname"><br>');
document.writeln('<a id="funcsearchlink" class="searchbox-body" href="../../../_functions/index.html">Function<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="funcname"><br>');
document.writeln('<a class="searchbox-body" href="../../../_variables/index.html">Variable<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="varname"><br>');
document.writeln('<a class="searchbox-body" href="../../../_constants/index.html">Constant<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="constname"><br>');
document.writeln('<a class="searchbox-body" href="../../../_tables/index.html">Table<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="tablename"><br>');
document.writeln('<input type="submit" class="searchbox-button" value="Search">');
document.writeln('<\/form>');
document.writeln('<\/td><\/tr><\/table>');
document.writeln('<\/td><\/tr><\/table>');
// -->
</script>
<div id="search-popup" class="searchpopup"><p id="searchpopup-title" class="searchpopup-title">title</p><div id="searchpopup-body" class="searchpopup-body">Body</div><p class="searchpopup-close"><a href="javascript:gwCloseActive()">[close]</a></p></div>
<h2 class="details-heading"><a href="./index.html">/backup/util/dbops/</a> -> <a href="restore_dbops.class.php.source.html">restore_dbops.class.php</a> (summary)</h2>
<div class="details-summary">
<p class="viewlinks">[<a href="restore_dbops.class.php.source.html">Source view</a>]
[<a href="javascript:window.print();">Print</a>]
[<a href="../../../_stats.html">Project Stats</a>]</p>
<p><b>(no description)</b></p>
<table>
<tr><td align="right">Copyright: </td><td>2010 onwards Eloy Lafuente (stronk7) {@link http://stronk7.com}</td></tr>
<tr><td align="right">License: </td><td><a href="http://www.gnu.org/copyleft/gpl.html" target="_blank">http://www.gnu.org/copyleft/gpl.html</a> GNU GPL v3 or later</td></tr>
<tr><td align="right">File Size: </td><td>1758 lines (87 kb)</td></tr>
<tr><td align="right">Included or required:</td><td>0 times</td></tr>
<tr><td align="right" valign="top">Referenced: </td><td>2 times</td></tr>
<tr><td align="right" valign="top">Includes or requires: </td><td>0 files</td></tr>
</table>
<h3>Defines 1 class</h3>
<div class="inset">
<p><b>restore_dbops_exception::</b> (1 method):<br>
&nbsp;&nbsp;<a href="#__construct">__construct</a>()<br>
</p>
</div>
<h3>Defines 1 function</h3>
<div class="inset">
&nbsp;&nbsp;<a href="#get_included_tasks">get_included_tasks</a>()<br>
&nbsp;&nbsp;<a href="#load_inforef_to_tempids">load_inforef_to_tempids</a>()<br>
&nbsp;&nbsp;<a href="#load_roles_to_tempids">load_roles_to_tempids</a>()<br>
&nbsp;&nbsp;<a href="#precheck_included_roles">precheck_included_roles</a>()<br>
&nbsp;&nbsp;<a href="#get_backup_ids_cached">get_backup_ids_cached</a>()<br>
&nbsp;&nbsp;<a href="#set_backup_ids_cached">set_backup_ids_cached</a>()<br>
&nbsp;&nbsp;<a href="#update_backup_cached_record">update_backup_cached_record</a>()<br>
&nbsp;&nbsp;<a href="#reset_backup_ids_cached">reset_backup_ids_cached</a>()<br>
&nbsp;&nbsp;<a href="#get_best_assignable_role">get_best_assignable_role</a>()<br>
&nbsp;&nbsp;<a href="#process_included_roles">process_included_roles</a>()<br>
&nbsp;&nbsp;<a href="#load_users_to_tempids">load_users_to_tempids</a>()<br>
&nbsp;&nbsp;<a href="#load_categories_and_questions_to_tempids">load_categories_and_questions_to_tempids</a>()<br>
&nbsp;&nbsp;<a href="#precheck_categories_and_questions">precheck_categories_and_questions</a>()<br>
&nbsp;&nbsp;<a href="#prechek_precheck_qbanks_by_level">prechek_precheck_qbanks_by_level</a>()<br>
&nbsp;&nbsp;<a href="#restore_get_question_banks">restore_get_question_banks</a>()<br>
&nbsp;&nbsp;<a href="#restore_get_question_categories">restore_get_question_categories</a>()<br>
&nbsp;&nbsp;<a href="#restore_find_best_target_context">restore_find_best_target_context</a>()<br>
&nbsp;&nbsp;<a href="#restore_get_questions">restore_get_questions</a>()<br>
&nbsp;&nbsp;<a href="#send_files_to_pool">send_files_to_pool</a>()<br>
&nbsp;&nbsp;<a href="#get_missing_file_result">get_missing_file_result</a>()<br>
&nbsp;&nbsp;<a href="#create_included_users">create_included_users</a>()<br>
&nbsp;&nbsp;<a href="#precheck_user">precheck_user</a>()<br>
&nbsp;&nbsp;<a href="#precheck_included_users">precheck_included_users</a>()<br>
&nbsp;&nbsp;<a href="#process_included_users">process_included_users</a>()<br>
&nbsp;&nbsp;<a href="#process_categories_and_questions">process_categories_and_questions</a>()<br>
&nbsp;&nbsp;<a href="#set_backup_files_record">set_backup_files_record</a>()<br>
&nbsp;&nbsp;<a href="#set_backup_ids_record">set_backup_ids_record</a>()<br>
&nbsp;&nbsp;<a href="#get_backup_ids_record">get_backup_ids_record</a>()<br>
&nbsp;&nbsp;<a href="#calculate_course_names">calculate_course_names</a>()<br>
&nbsp;&nbsp;<a href="#set_course_role_names">set_course_role_names</a>()<br>
&nbsp;&nbsp;<a href="#create_new_course">create_new_course</a>()<br>
&nbsp;&nbsp;<a href="#delete_course_content">delete_course_content</a>()<br>
</div>
</div>
<br><div class="details-funclist">
<div class="details-classinfo">
<p class="details-classtitle">Class: <a name="restore_dbops_exception"><b>restore_dbops_exception</b></a>&nbsp;&nbsp;- <a href="../../../_classes/restore_dbops_exception.html"><small>X-Ref</small></a>
</p>
<div class="inset"><table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="__construct" onClick="logFunction('__construct', 'restore_dbops.class.php.source.html#l1755')" href="restore_dbops.class.php.source.html#l1755">__construct</a>(<a href="../../../_variables/errorcode.html">$errorcode</a>, <a href="../../../_variables/a.html">$a</a>=NULL, <a href="../../../_variables/debuginfo.html">$debuginfo</a>=null)&nbsp;&nbsp;
<a href="../../../_functions/__construct.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><i>No description</i></td></tr></table>

<br>
</div>
</div>
<div class="details-classtitle"><a name="functions"><b>Functions</b></a></div>
<div class="details-classinfo">
Functions that are not part of a class:<br><br>
<div class="inset"><table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="get_included_tasks" onClick="logFunction('get_included_tasks', 'restore_dbops.class.php.source.html#l64')" href="restore_dbops.class.php.source.html#l64">get_included_tasks</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>)&nbsp;&nbsp;
<a href="../../../_functions/get_included_tasks.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Return one array containing all the tasks that have been included<BR>
in the restore process. Note that these tasks aren't built (they<BR>
haven't steps nor ids data available)<BR>
</b><BR></td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="load_inforef_to_tempids" onClick="logFunction('load_inforef_to_tempids', 'restore_dbops.class.php.source.html#l110')" href="restore_dbops.class.php.source.html#l110">load_inforef_to_tempids</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/inforeffile.html">$inforeffile</a>,\core\progress\base <a href="../../../_variables/progress.html">$progress</a> = null)&nbsp;&nbsp;
<a href="../../../_functions/load_inforef_to_tempids.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Load one inforef.xml file to backup_ids table for future reference<BR>
</b><BR><b>param:</b> string $restoreid Restore id<br>
<b>param:</b> string $inforeffile File path<br>
<b>param:</b> \core\progress\base $progress Progress tracker<br>
</td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="load_roles_to_tempids" onClick="logFunction('load_roles_to_tempids', 'restore_dbops.class.php.source.html#l142')" href="restore_dbops.class.php.source.html#l142">load_roles_to_tempids</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/rolesfile.html">$rolesfile</a>)&nbsp;&nbsp;
<a href="../../../_functions/load_roles_to_tempids.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Load the needed role.xml file to backup_ids table for future reference<BR>
</b><BR></td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="precheck_included_roles" onClick="logFunction('precheck_included_roles', 'restore_dbops.class.php.source.html#l158')" href="restore_dbops.class.php.source.html#l158">precheck_included_roles</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/courseid.html">$courseid</a>, <a href="../../../_variables/userid.html">$userid</a>, <a href="../../../_variables/samesite.html">$samesite</a>, <a href="../../../_variables/rolemappings.html">$rolemappings</a>)&nbsp;&nbsp;
<a href="../../../_functions/precheck_included_roles.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Precheck the loaded roles, return empty array if everything is ok, and<BR>
array with 'errors', 'warnings' elements (suitable to be used by restore_prechecks)<BR>
with any problem found. At the same time, store all the mapping into backup_ids_temp<BR>
and also put the information into $rolemappings (controller-&gt;info), so it can be reworked later by<BR>
post-precheck stages while at the same time accept modified info in the same object coming from UI<BR>
</b><BR></td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="get_backup_ids_cached" onClick="logFunction('get_backup_ids_cached', 'restore_dbops.class.php.source.html#l201')" href="restore_dbops.class.php.source.html#l201">get_backup_ids_cached</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/itemname.html">$itemname</a>, <a href="../../../_variables/itemid.html">$itemid</a>)&nbsp;&nbsp;
<a href="../../../_functions/get_backup_ids_cached.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Return cached backup id's<BR>
</b><BR><b>param:</b> int $restoreid id of backup<br>
<b>param:</b> string $itemname name of the item<br>
<b>param:</b> int $itemid id of item<br>
<b>return:</b> array backup id's<br>
</td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="set_backup_ids_cached" onClick="logFunction('set_backup_ids_cached', 'restore_dbops.class.php.source.html#l249')" href="restore_dbops.class.php.source.html#l249">set_backup_ids_cached</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/itemname.html">$itemname</a>, <a href="../../../_variables/itemid.html">$itemid</a>, <a href="../../../_variables/extrarecord.html">$extrarecord</a>)&nbsp;&nbsp;
<a href="../../../_functions/set_backup_ids_cached.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Cache backup ids'<BR>
</b><BR><b>param:</b> int $restoreid id of backup<br>
<b>param:</b> string $itemname name of the item<br>
<b>param:</b> int $itemid id of item<br>
<b>param:</b> array $extrarecord extra record which needs to be updated<br>
<b>return:</b> void<br>
</td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="update_backup_cached_record" onClick="logFunction('update_backup_cached_record', 'restore_dbops.class.php.source.html#l298')" href="restore_dbops.class.php.source.html#l298">update_backup_cached_record</a>(<a href="../../../_variables/record.html">$record</a>, <a href="../../../_variables/extrarecord.html">$extrarecord</a>, <a href="../../../_variables/key.html">$key</a>, <a href="../../../_variables/existingrecord.html">$existingrecord</a> = null)&nbsp;&nbsp;
<a href="../../../_functions/update_backup_cached_record.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Updates existing backup record<BR>
</b><BR><b>param:</b> array $record record which needs to be updated<br>
<b>param:</b> array $extrarecord extra record which needs to be updated<br>
<b>param:</b> string $key unique key which is used to identify cached record<br>
<b>param:</b> stdClass $existingrecord (optional) existing record<br>
</td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="reset_backup_ids_cached" onClick="logFunction('reset_backup_ids_cached', 'restore_dbops.class.php.source.html#l330')" href="restore_dbops.class.php.source.html#l330">reset_backup_ids_cached</a>()&nbsp;&nbsp;
<a href="../../../_functions/reset_backup_ids_cached.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Reset the ids caches completely<BR>
</b><BR>Any destructive operation (partial delete, truncate, drop or recreate) performed<BR>
with the backup_ids table must cause the backup_ids caches to be<BR>
invalidated by calling this method. See MDL-33630.<BR>
<BR>
Note that right now, the only operation of that type is the recreation<BR>
(drop &amp; restore) of the table that may happen once the prechecks have ended. All<BR>
the rest of operations are always routed via {@link set_backup_ids_record()}, 1 by 1,<BR>
keeping the caches on sync.<BR>
<BR>
</td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="get_best_assignable_role" onClick="logFunction('get_best_assignable_role', 'restore_dbops.class.php.source.html#l355')" href="restore_dbops.class.php.source.html#l355">get_best_assignable_role</a>(<a href="../../../_variables/role.html">$role</a>, <a href="../../../_variables/courseid.html">$courseid</a>, <a href="../../../_variables/userid.html">$userid</a>, <a href="../../../_variables/samesite.html">$samesite</a>)&nbsp;&nbsp;
<a href="../../../_functions/get_best_assignable_role.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Given one role, as loaded from XML, perform the best possible matching against the assignable<BR>
roles, using different fallback alternatives (shortname, archetype, editingteacher =&gt; teacher, defaultcourseroleid)<BR>
returning the id of the best matching role or 0 if no match is found<BR>
</b><BR></td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="process_included_roles" onClick="logFunction('process_included_roles', 'restore_dbops.class.php.source.html#l399')" href="restore_dbops.class.php.source.html#l399">process_included_roles</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/courseid.html">$courseid</a>, <a href="../../../_variables/userid.html">$userid</a>, <a href="../../../_variables/samesite.html">$samesite</a>, <a href="../../../_variables/rolemappings.html">$rolemappings</a>)&nbsp;&nbsp;
<a href="../../../_functions/process_included_roles.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Process the loaded roles, looking for their best mapping or skipping<BR>
Any error will cause exception. Note this is one wrapper over<BR>
precheck_included_roles, that contains all the logic, but returns<BR>
errors/warnings instead and is executed as part of the restore prechecks<BR>
</b><BR></td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="load_users_to_tempids" onClick="logFunction('load_users_to_tempids', 'restore_dbops.class.php.source.html#l417')" href="restore_dbops.class.php.source.html#l417">load_users_to_tempids</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/usersfile.html">$usersfile</a>,\core\progress\base <a href="../../../_variables/progress.html">$progress</a> = null)&nbsp;&nbsp;
<a href="../../../_functions/load_users_to_tempids.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Load the needed users.xml file to backup_ids table for future reference<BR>
</b><BR><b>param:</b> string $restoreid Restore id<br>
<b>param:</b> string $usersfile File path<br>
<b>param:</b> \core\progress\base $progress Progress tracker<br>
</td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="load_categories_and_questions_to_tempids" onClick="logFunction('load_categories_and_questions_to_tempids', 'restore_dbops.class.php.source.html#l449')" href="restore_dbops.class.php.source.html#l449">load_categories_and_questions_to_tempids</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/questionsfile.html">$questionsfile</a>)&nbsp;&nbsp;
<a href="../../../_functions/load_categories_and_questions_to_tempids.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Load the needed questions.xml file to backup_ids table for future reference<BR>
</b><BR></td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="precheck_categories_and_questions" onClick="logFunction('precheck_categories_and_questions', 'restore_dbops.class.php.source.html#l465')" href="restore_dbops.class.php.source.html#l465">precheck_categories_and_questions</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/courseid.html">$courseid</a>, <a href="../../../_variables/userid.html">$userid</a>, <a href="../../../_variables/samesite.html">$samesite</a>)&nbsp;&nbsp;
<a href="../../../_functions/precheck_categories_and_questions.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Check all the included categories and questions, deciding the action to perform<BR>
for each one (mapping / creation) and returning one array of problems in case<BR>
something is wrong.<BR>
</b><BR>There are some basic rules that the method below will always try to enforce:<BR>
<BR>
Rule1: Targets will be, always, calculated for *whole* question banks (a.k.a. contexid source),<BR>
so, given 2 question categories belonging to the same bank, their target bank will be<BR>
always the same. If not, we can be incurring into &quot;fragmentation&quot;, leading to random/cloze<BR>
problems (qtypes having &quot;child&quot; questions).<BR>
<BR>
Rule2: The 'moodle/question:managecategory' and 'moodle/question:add' capabilities will be<BR>
checked before creating any category/question respectively and, if the cap is not allowed<BR>
into upper contexts (system, coursecat)) but in lower ones (course), the *whole* question bank<BR>
will be created there.<BR>
<BR>
Rule3: Coursecat question banks not existing in the target site will be created as course<BR>
(lower ctx) question banks, never as &quot;guessed&quot; coursecat question banks base on depth or so.<BR>
<BR>
Rule4: System question banks will be created at system context if user has perms to do so. Else they<BR>
will created as course (lower ctx) question banks (similary to rule3). In other words, course ctx<BR>
if always a fallback for system and coursecat question banks.<BR>
<BR>
Also, there are some notes to clarify the scope of this method:<BR>
<BR>
Note1: This method won't create any question category nor question at all. It simply will calculate<BR>
which actions (create/map) must be performed for each element and where, validating that all those<BR>
actions are doable by the user executing the restore operation. Any problem found will be<BR>
returned in the problems array, causing the restore process to stop with error.<BR>
<BR>
Note2: To decide if one question bank (all its question categories and questions) is going to be remapped,<BR>
then all the categories and questions must exist in the same target bank. If able to do so, missing<BR>
qcats and qs will be created (rule2). But if, at the end, something is missing, the whole question bank<BR>
will be recreated at course ctx (rule1), no matter if that duplicates some categories/questions.<BR>
<BR>
Note3: We'll be using the newitemid column in the temp_ids table to store the action to be performed<BR>
with each question category and question. newitemid = 0 means the qcat/q needs to be created and<BR>
any other value means the qcat/q is mapped. Also, for qcats, parentitemid will contain the target<BR>
context where the categories have to be created (but for module contexts where we'll keep the old<BR>
one until the activity is created)<BR>
<BR>
Note4: All these &quot;actions&quot; will be &quot;executed&quot; later by {@link restore_create_categories_and_questions}<BR>
</td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="prechek_precheck_qbanks_by_level" onClick="logFunction('prechek_precheck_qbanks_by_level', 'restore_dbops.class.php.source.html#l533')" href="restore_dbops.class.php.source.html#l533">prechek_precheck_qbanks_by_level</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/courseid.html">$courseid</a>, <a href="../../../_variables/userid.html">$userid</a>, <a href="../../../_variables/samesite.html">$samesite</a>, <a href="../../../_variables/contextlevel.html">$contextlevel</a>)&nbsp;&nbsp;
<a href="../../../_functions/prechek_precheck_qbanks_by_level.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>This function will process all the question banks present in restore<BR>
at some contextlevel (from CONTEXT_SYSTEM to CONTEXT_MODULE), finding<BR>
the target contexts where each bank will be restored and returning<BR>
warnings/errors as needed.<BR>
</b><BR>Some contextlevels (system, coursecat), will delegate process to<BR>
course level if any problem is found (lack of permissions, non-matching<BR>
target context...). Other contextlevels (course, module) will<BR>
cause return error if some problem is found.<BR>
<BR>
At the end, if no errors were found, all the categories in backup_temp_ids<BR>
will be pointing (parentitemid) to the target context where they must be<BR>
created later in the restore process.<BR>
<BR>
Note: at the time these prechecks are executed, activities haven't been<BR>
created yet so, for CONTEXT_MODULE banks, we keep the old contextid<BR>
in the parentitemid field. Once the activity (and its context) has been<BR>
created, we'll update that context in the required qcats<BR>
<BR>
Caller {@link precheck_categories_and_questions} will, simply, execute<BR>
this function for all the contextlevels, acting as a simple controller<BR>
of warnings and errors.<BR>
<BR>
The function returns 2 arrays, one containing errors and another containing<BR>
warnings. Both empty if no errors/warnings are found.<BR>
</td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="restore_get_question_banks" onClick="logFunction('restore_get_question_banks', 'restore_dbops.class.php.source.html#l696')" href="restore_dbops.class.php.source.html#l696">restore_get_question_banks</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/contextlevel.html">$contextlevel</a> = null)&nbsp;&nbsp;
<a href="../../../_functions/restore_get_question_banks.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Return one array of contextid =&gt; contextlevel pairs<BR>
of question banks to be checked for one given restore operation<BR>
ordered from CONTEXT_SYSTEM downto CONTEXT_MODULE<BR>
If contextlevel is specified, then only banks corresponding to<BR>
that level are returned<BR>
</b><BR></td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="restore_get_question_categories" onClick="logFunction('restore_get_question_categories', 'restore_dbops.class.php.source.html#l727')" href="restore_dbops.class.php.source.html#l727">restore_get_question_categories</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/contextid.html">$contextid</a>)&nbsp;&nbsp;
<a href="../../../_functions/restore_get_question_categories.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Return one array of question_category records for<BR>
a given restore operation and one restore context (question bank)<BR>
</b><BR></td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="restore_find_best_target_context" onClick="logFunction('restore_find_best_target_context', 'restore_dbops.class.php.source.html#l748')" href="restore_dbops.class.php.source.html#l748">restore_find_best_target_context</a>(<a href="../../../_variables/categories.html">$categories</a>, <a href="../../../_variables/courseid.html">$courseid</a>, <a href="../../../_variables/contextlevel.html">$contextlevel</a>)&nbsp;&nbsp;
<a href="../../../_functions/restore_find_best_target_context.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Calculates the best context found to restore one collection of qcats,<BR>
al them belonging to the same context (question bank), returning the<BR>
target context found (object) or false<BR>
</b><BR></td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="restore_get_questions" onClick="logFunction('restore_get_questions', 'restore_dbops.class.php.source.html#l826')" href="restore_dbops.class.php.source.html#l826">restore_get_questions</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/qcatid.html">$qcatid</a>)&nbsp;&nbsp;
<a href="../../../_functions/restore_get_questions.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Return one array of question records for<BR>
a given restore operation and one question category<BR>
</b><BR></td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="send_files_to_pool" onClick="logFunction('send_files_to_pool', 'restore_dbops.class.php.source.html#l846')" href="restore_dbops.class.php.source.html#l846">send_files_to_pool</a>(<a href="../../../_variables/basepath.html">$basepath</a>, <a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/component.html">$component</a>, <a href="../../../_variables/filearea.html">$filearea</a>,<a href="../../../_variables/oldcontextid.html">$oldcontextid</a>, <a href="../../../_variables/dfltuserid.html">$dfltuserid</a>, <a href="../../../_variables/itemname.html">$itemname</a> = null, <a href="../../../_variables/olditemid.html">$olditemid</a> = null,<a href="../../../_variables/forcenewcontextid.html">$forcenewcontextid</a> = null, <a href="../../../_variables/skipparentitemidctxmatch.html">$skipparentitemidctxmatch</a> = false,\core\progress\base <a href="../../../_variables/progress.html">$progress</a> = null)&nbsp;&nbsp;
<a href="../../../_functions/send_files_to_pool.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Given one component/filearea/context and<BR>
optionally one source itemname to match itemids<BR>
put the corresponding files in the pool<BR>
</b><BR>If you specify a progress reporter, it will get called once per file with<BR>
indeterminate progress.<BR>
<BR>
<b>param:</b> string $basepath the full path to the root of unzipped backup file<br>
<b>param:</b> string $restoreid the restore job's identification<br>
<b>param:</b> string $component<br>
<b>param:</b> string $filearea<br>
<b>param:</b> int $oldcontextid<br>
<b>param:</b> int $dfltuserid default $file-&gt;user if the old one can't be mapped<br>
<b>param:</b> string|null $itemname<br>
<b>param:</b> int|null $olditemid<br>
<b>param:</b> int|null $forcenewcontextid explicit value for the new contextid (skip mapping)<br>
<b>param:</b> bool $skipparentitemidctxmatch<br>
<b>param:</b> \core\progress\base $progress Optional progress reporter<br>
<b>return:</b> array of result object<br>
</td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="get_missing_file_result" onClick="logFunction('get_missing_file_result', 'restore_dbops.class.php.source.html#l1059')" href="restore_dbops.class.php.source.html#l1059">get_missing_file_result</a>(<a href="../../../_variables/file.html">$file</a>)&nbsp;&nbsp;
<a href="../../../_functions/get_missing_file_result.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Returns suitable entry to include in log when there is a missing file.<BR>
</b><BR><b>param:</b> stdClass $file File definition<br>
<b>return:</b> stdClass Log entry<br>
</td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="create_included_users" onClick="logFunction('create_included_users', 'restore_dbops.class.php.source.html#l1075')" href="restore_dbops.class.php.source.html#l1075">create_included_users</a>(<a href="../../../_variables/basepath.html">$basepath</a>, <a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/userid.html">$userid</a>,\core\progress\base <a href="../../../_variables/progress.html">$progress</a>)&nbsp;&nbsp;
<a href="../../../_functions/create_included_users.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Given one restoreid, create in DB all the users present<BR>
in backup_ids having newitemid = 0, as far as<BR>
precheck_included_users() have left them there<BR>
ready to be created. Also, annotate their newids<BR>
once created for later reference.<BR>
</b><BR>This function will start and end a new progress section in the progress<BR>
object.<BR>
<BR>
<b>param:</b> string $basepath Base path of unzipped backup<br>
<b>param:</b> string $restoreid Restore ID<br>
<b>param:</b> int $userid Default userid for files<br>
<b>param:</b> \core\progress\base $progress Object used for progress tracking<br>
</td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="precheck_user" onClick="logFunction('precheck_user', 'restore_dbops.class.php.source.html#l1255')" href="restore_dbops.class.php.source.html#l1255">precheck_user</a>(<a href="../../../_variables/user.html">$user</a>, <a href="../../../_variables/samesite.html">$samesite</a>)&nbsp;&nbsp;
<a href="../../../_functions/precheck_user.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Given one user object (from backup file), perform all the neccesary<BR>
checks is order to decide how that user will be handled on restore.<BR>
</b><BR>Note the function requires $user-&gt;mnethostid to be already calculated<BR>
so it's caller responsibility to set it<BR>
<BR>
This function is used both by @restore_precheck_users() and<BR>
</td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="precheck_included_users" onClick="logFunction('precheck_included_users', 'restore_dbops.class.php.source.html#l1478')" href="restore_dbops.class.php.source.html#l1478">precheck_included_users</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/courseid.html">$courseid</a>, <a href="../../../_variables/userid.html">$userid</a>, <a href="../../../_variables/samesite.html">$samesite</a>,\core\progress\base <a href="../../../_variables/progress.html">$progress</a>)&nbsp;&nbsp;
<a href="../../../_functions/precheck_included_users.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Check all the included users, deciding the action to perform<BR>
for each one (mapping / creation) and returning one array<BR>
of problems in case something is wrong (lack of permissions,<BR>
conficts)<BR>
</b><BR><b>param:</b> string $restoreid Restore id<br>
<b>param:</b> int $courseid Course id<br>
<b>param:</b> int $userid User id<br>
<b>param:</b> bool $samesite True if restore is to same site<br>
<b>param:</b> \core\progress\base $progress Progress reporter<br>
</td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="process_included_users" onClick="logFunction('process_included_users', 'restore_dbops.class.php.source.html#l1566')" href="restore_dbops.class.php.source.html#l1566">process_included_users</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/courseid.html">$courseid</a>, <a href="../../../_variables/userid.html">$userid</a>, <a href="../../../_variables/samesite.html">$samesite</a>,\core\progress\base <a href="../../../_variables/progress.html">$progress</a> = null)&nbsp;&nbsp;
<a href="../../../_functions/process_included_users.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Process the needed users in order to decide<BR>
which action to perform with them (create/map)<BR>
</b><BR>Just wrap over precheck_included_users(), returning<BR>
exception if any problem is found<BR>
<BR>
<b>param:</b> string $restoreid Restore id<br>
<b>param:</b> int $courseid Course id<br>
<b>param:</b> int $userid User id<br>
<b>param:</b> bool $samesite True if restore is to same site<br>
<b>param:</b> \core\progress\base $progress Optional progress tracker<br>
</td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="process_categories_and_questions" onClick="logFunction('process_categories_and_questions', 'restore_dbops.class.php.source.html#l1593')" href="restore_dbops.class.php.source.html#l1593">process_categories_and_questions</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/courseid.html">$courseid</a>, <a href="../../../_variables/userid.html">$userid</a>, <a href="../../../_variables/samesite.html">$samesite</a>)&nbsp;&nbsp;
<a href="../../../_functions/process_categories_and_questions.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Process the needed question categories and questions<BR>
to check all them, deciding about the action to perform<BR>
(create/map) and target.<BR>
</b><BR>Just wrap over precheck_categories_and_questions(), returning<BR>
exception if any problem is found<BR>
</td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="set_backup_files_record" onClick="logFunction('set_backup_files_record', 'restore_dbops.class.php.source.html#l1614')" href="restore_dbops.class.php.source.html#l1614">set_backup_files_record</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/filerec.html">$filerec</a>)&nbsp;&nbsp;
<a href="../../../_functions/set_backup_files_record.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><i>No description</i></td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="set_backup_ids_record" onClick="logFunction('set_backup_ids_record', 'restore_dbops.class.php.source.html#l1623')" href="restore_dbops.class.php.source.html#l1623">set_backup_ids_record</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/itemname.html">$itemname</a>, <a href="../../../_variables/itemid.html">$itemid</a>, <a href="../../../_variables/newitemid.html">$newitemid</a> = 0, <a href="../../../_variables/parentitemid.html">$parentitemid</a> = null, <a href="../../../_variables/info.html">$info</a> = null)&nbsp;&nbsp;
<a href="../../../_functions/set_backup_ids_record.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><i>No description</i></td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="get_backup_ids_record" onClick="logFunction('get_backup_ids_record', 'restore_dbops.class.php.source.html#l1639')" href="restore_dbops.class.php.source.html#l1639">get_backup_ids_record</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/itemname.html">$itemname</a>, <a href="../../../_variables/itemid.html">$itemid</a>)&nbsp;&nbsp;
<a href="../../../_functions/get_backup_ids_record.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><i>No description</i></td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="calculate_course_names" onClick="logFunction('calculate_course_names', 'restore_dbops.class.php.source.html#l1650')" href="restore_dbops.class.php.source.html#l1650">calculate_course_names</a>(<a href="../../../_variables/courseid.html">$courseid</a>, <a href="../../../_variables/fullname.html">$fullname</a>, <a href="../../../_variables/shortname.html">$shortname</a>)&nbsp;&nbsp;
<a href="../../../_functions/calculate_course_names.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Given on courseid, fullname and shortname, calculate the correct fullname/shortname to avoid dupes<BR>
</b><BR></td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="set_course_role_names" onClick="logFunction('set_course_role_names', 'restore_dbops.class.php.source.html#l1680')" href="restore_dbops.class.php.source.html#l1680">set_course_role_names</a>(<a href="../../../_variables/restoreid.html">$restoreid</a>, <a href="../../../_variables/courseid.html">$courseid</a>)&nbsp;&nbsp;
<a href="../../../_functions/set_course_role_names.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>For the target course context, put as many custom role names as possible<BR>
</b><BR></td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="create_new_course" onClick="logFunction('create_new_course', 'restore_dbops.class.php.source.html#l1707')" href="restore_dbops.class.php.source.html#l1707">create_new_course</a>(<a href="../../../_variables/fullname.html">$fullname</a>, <a href="../../../_variables/shortname.html">$shortname</a>, <a href="../../../_variables/categoryid.html">$categoryid</a>)&nbsp;&nbsp;
<a href="../../../_functions/create_new_course.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Creates a skeleton record within the database using the passed parameters<BR>
and returns the new course id.<BR>
</b><BR><b>param:</b> string $fullname<br>
<b>param:</b> string $shortname<br>
<b>param:</b> int $categoryid<br>
<b>return:</b> int The new course id<br>
</td></tr></table>

<br>
<table border="0" width="80%" class="funcinfo"><tr class="funcinfo-title"><td>
<a name="delete_course_content" onClick="logFunction('delete_course_content', 'restore_dbops.class.php.source.html#l1739')" href="restore_dbops.class.php.source.html#l1739">delete_course_content</a>(<a href="../../../_variables/courseid.html">$courseid</a>, array <a href="../../../_variables/options.html">$options</a> = null)&nbsp;&nbsp;
<a href="../../../_functions/delete_course_content.html"><small>X-Ref</small></a>
</td></tr><tr class="funcinfo-body"><td><b>Deletes all of the content associated with the given course (courseid)<BR>
</b><BR><b>param:</b> int $courseid<br>
<b>param:</b> array $options<br>
<b>return:</b> bool True for success<br>
</td></tr></table>

<br>
</div></div>

</div>
<!-- A link to the phpxref site in your customized footer file is appreciated ;-) -->
<br><hr>
<table width="100%">
	<tr><td>Generated: Thu May 28 19:17:31 2015</td>
	<td align="right"><i>Cross-referenced by <a href="http://phpxref.sourceforge.net/">PHPXref 0.7.1</a></i></td>
	</tr>
</table>
</body></html>
