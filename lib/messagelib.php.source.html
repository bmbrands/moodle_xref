<!doctype html public "-//W3C//DTD HTML 4.0 Transitional//EN" "http://www.w3.org/TR/REC-html40/loose.dtd">
<html>
<head>
    <title>PHPXRef 0.7.1 : Unnamed Project : /lib/messagelib.php source</title>
    <link rel="stylesheet" href="../sample.css" type="text/css">
    <link rel="stylesheet" href="../sample-print.css" type="text/css" media="print">
    <style id="hilight" type="text/css"></style>
    <meta http-equiv="content-type" content="text/html;charset=iso-8859-1">
</head>
<body bgcolor="#ffffff" text="#000000" link="#801800" vlink="#300540" alink="#ffffff">
<table class="pagetitle" width="100%">
	<tr>
        <td valign="top" class="pagetitle">
            [ <a href="../index.html">Index</a> ]
        </td>
        <td align="right" class="pagetitle">
		    <h2 style="margin-bottom: 0px">PHP Cross Reference of Unnamed Project</h2>
	    </td>
    </tr>
</table>


<!-- Generated by PHPXref 0.7.1 at Thu May 28 19:17:31 2015 -->
<!-- PHPXref (c) 2000-2010 Gareth Watts - gareth@omnipotent.net -->
<!-- http://phpxref.sourceforge.net/ -->

<script src="../phpxref.js" type="text/javascript"></script>
<script language="JavaScript" type="text/javascript">
<!--
ext='.html';
relbase='../';
subdir='lib';
filename='messagelib.php.source.html';
cookiekey='phpxref';
handleNavFrame(relbase, subdir, filename);

// -->
</script>
<script language="JavaScript" type="text/javascript">
if (gwGetCookie('xrefnav')=='off')
  document.write('<p class="navlinks">[ <a href="javascript:navOn()">Show Explorer<\/a> ]<\/p>');
else
  document.write('<p class="navlinks">[ <a href="javascript:navOff()">Hide Explorer<\/a> ]<\/p>');
</script>
<noscript>
<p class="navlinks">
[ <a href="../nav.html" target="_top">Show Explorer</a> ]
[ <a href="index.html" target="_top">Hide Navbar</a> ]
</p>
</noscript>
<script language="JavaScript" type="text/javascript">
<!--

document.writeln('<table align="right" class="searchbox-link"><tr><td><a class="searchbox-link" href="javascript:void(0)" onMouseOver="showSearchBox()">Search</a><br>');
document.writeln('<table border="0" cellspacing="0" cellpadding="0" class="searchbox" id="searchbox">');
document.writeln('<tr><td class="searchbox-title">');
document.writeln('<a class="searchbox-title" href="javascript:showSearchPopup()">Search History +</a>');
document.writeln('<\/td><\/tr>');

document.writeln('<tr><td class="searchbox-body" id="searchbox-body">');
document.writeln('<form name="search" style="margin:0px; padding:0px" onSubmit=\'return jump()\'>');
document.writeln('<a class="searchbox-body" href="../_classes/index.html">Class<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="classname"><br>');
document.writeln('<a id="funcsearchlink" class="searchbox-body" href="../_functions/index.html">Function<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="funcname"><br>');
document.writeln('<a class="searchbox-body" href="../_variables/index.html">Variable<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="varname"><br>');
document.writeln('<a class="searchbox-body" href="../_constants/index.html">Constant<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="constname"><br>');
document.writeln('<a class="searchbox-body" href="../_tables/index.html">Table<\/a>: ');
document.writeln('<input type="text" size=10 value="" name="tablename"><br>');
document.writeln('<input type="submit" class="searchbox-button" value="Search">');
document.writeln('<\/form>');
document.writeln('<\/td><\/tr><\/table>');
document.writeln('<\/td><\/tr><\/table>');
// -->
</script>
<div id="search-popup" class="searchpopup"><p id="searchpopup-title" class="searchpopup-title">title</p><div id="searchpopup-body" class="searchpopup-body">Body</div><p class="searchpopup-close"><a href="javascript:gwCloseActive()">[close]</a></p></div>
<h2 class="listing-heading"><a href="./index.html">/lib/</a> -> <a href="messagelib.php.html">messagelib.php</a> (source)</h2>
<div class="listing">
<p class="viewlinks">[<a href="messagelib.php.html">Summary view</a>]
[<a href="javascript:window.print();">Print</a>]
[<a href="messagelib.php.source.txt" target="_new">Text view</a>]
</p>
<pre>
<a name="l1"><span class="linenum">   1</span></a>  &lt;?php
<a name="l2"><span class="linenum">   2</span></a>  <span class="comment">// This file is part of Moodle - http://moodle.org/</span>
<a name="l3"><span class="linenum">   3</span></a>  <span class="comment">//</span>
<a name="l4"><span class="linenum">   4</span></a>  <span class="comment">// Moodle is free software: you can redistribute it and/or modify</span>
<a name="l5"><span class="linenum">   5</span></a>  <span class="comment">// it under the terms of the GNU General Public License as published by</span>
<a name="l6"><span class="linenum">   6</span></a>  <span class="comment">// the Free Software Foundation, either version 3 of the License, or</span>
<a name="l7"><span class="linenum">   7</span></a>  <span class="comment">// (at your option) any later version.</span>
<a name="l8"><span class="linenum">   8</span></a>  <span class="comment">//</span>
<a name="l9"><span class="linenum">   9</span></a>  <span class="comment">// Moodle is distributed in the hope that it will be useful,</span>
<a name="l10"><span class="linenum">  10</span></a>  <span class="comment">// but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<a name="l11"><span class="linenum">  11</span></a>  <span class="comment">// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<a name="l12"><span class="linenum">  12</span></a>  <span class="comment">// GNU General Public License for more details.</span>
<a name="l13"><span class="linenum">  13</span></a>  <span class="comment">//</span>
<a name="l14"><span class="linenum">  14</span></a>  <span class="comment">// You should have received a copy of the GNU General Public License</span>
<a name="l15"><span class="linenum">  15</span></a>  <span class="comment">// along with Moodle.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>
<a name="l16"><span class="linenum">  16</span></a>  
<a name="l17"><span class="linenum">  17</span></a>  <span class="comment">/**</span>
<a name="l18"><span class="linenum">  18</span></a>  <span class="comment"> * Functions for interacting with the message system</span>
<a name="l19"><span class="linenum">  19</span></a>  <span class="comment"> *</span>
<a name="l20"><span class="linenum">  20</span></a>  <span class="comment"> * @package   core_message</span>
<a name="l21"><span class="linenum">  21</span></a>  <span class="comment"> * @copyright 2008 Luis Rodrigues and Martin Dougiamas</span>
<a name="l22"><span class="linenum">  22</span></a>  <span class="comment"> * @license   http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later</span>
<a name="l23"><span class="linenum">  23</span></a>  <span class="comment"> */</span>
<a name="l24"><span class="linenum">  24</span></a>  
<a name="l25"><span class="linenum">  25</span></a>  <a class="phpfunction" onClick="logFunction('defined')" href="../_functions/defined.html" onMouseOver="phpfuncPopup(event,'defined')">defined</a>('<a class="constant" onClick="logConstant('MOODLE_INTERNAL')" href="../_constants/MOODLE_INTERNAL.html" onMouseOver="constPopup(event,'MOODLE_INTERNAL')">MOODLE_INTERNAL</a>') || die();
<a name="l26"><span class="linenum">  26</span></a>  
<a name="l27"><span class="linenum">  27</span></a>  require_once(<a class="phpfunction" onClick="logFunction('dirname')" href="../_functions/dirname.html" onMouseOver="phpfuncPopup(event,'dirname')">dirname</a>(<a class="phpfunction" onClick="logFunction('dirname')" href="../_functions/dirname.html" onMouseOver="phpfuncPopup(event,'dirname')">dirname</a>(__FILE__)) . '<a class="filename" href="../message/lib.php.html">/message/lib.php</a>');
<a name="l28"><span class="linenum">  28</span></a>  
<a name="l29"><span class="linenum">  29</span></a>  <span class="comment">/**</span>
<a name="l30"><span class="linenum">  30</span></a>  <span class="comment"> * Called when a message provider wants to send a message.</span>
<a name="l31"><span class="linenum">  31</span></a>  <span class="comment"> * This functions checks the message recipient's message processor configuration then</span>
<a name="l32"><span class="linenum">  32</span></a>  <span class="comment"> * sends the message to the configured processors</span>
<a name="l33"><span class="linenum">  33</span></a>  <span class="comment"> *</span>
<a name="l34"><span class="linenum">  34</span></a>  <span class="comment"> * Required parameters of the $eventdata object:</span>
<a name="l35"><span class="linenum">  35</span></a>  <span class="comment"> *  component string component name. must exist in message_providers</span>
<a name="l36"><span class="linenum">  36</span></a>  <span class="comment"> *  name string message type name. must exist in message_providers</span>
<a name="l37"><span class="linenum">  37</span></a>  <span class="comment"> *  userfrom object|int the user sending the message</span>
<a name="l38"><span class="linenum">  38</span></a>  <span class="comment"> *  userto object|int the message recipient</span>
<a name="l39"><span class="linenum">  39</span></a>  <span class="comment"> *  subject string the message subject</span>
<a name="l40"><span class="linenum">  40</span></a>  <span class="comment"> *  fullmessage string the full message in a given format</span>
<a name="l41"><span class="linenum">  41</span></a>  <span class="comment"> *  fullmessageformat int the format if the full message (FORMAT_MOODLE, FORMAT_HTML, ..)</span>
<a name="l42"><span class="linenum">  42</span></a>  <span class="comment"> *  fullmessagehtml string the full version (the message processor will choose with one to use)</span>
<a name="l43"><span class="linenum">  43</span></a>  <span class="comment"> *  smallmessage string the small version of the message</span>
<a name="l44"><span class="linenum">  44</span></a>  <span class="comment"> *</span>
<a name="l45"><span class="linenum">  45</span></a>  <span class="comment"> * Optional parameters of the $eventdata object:</span>
<a name="l46"><span class="linenum">  46</span></a>  <span class="comment"> *  notification bool should the message be considered as a notification rather than a personal message</span>
<a name="l47"><span class="linenum">  47</span></a>  <span class="comment"> *  contexturl string if this is a notification then you can specify a url to view the event. For example the forum post the user is being notified of.</span>
<a name="l48"><span class="linenum">  48</span></a>  <span class="comment"> *  contexturlname string the display text for contexturl</span>
<a name="l49"><span class="linenum">  49</span></a>  <span class="comment"> *</span>
<a name="l50"><span class="linenum">  50</span></a>  <span class="comment"> * Note: processor failure is is not reported as false return value,</span>
<a name="l51"><span class="linenum">  51</span></a>  <span class="comment"> *       earlier versions did not do it consistently either.</span>
<a name="l52"><span class="linenum">  52</span></a>  <span class="comment"> *</span>
<a name="l53"><span class="linenum">  53</span></a>  <span class="comment"> * @category message</span>
<a name="l54"><span class="linenum">  54</span></a>  <span class="comment"> * @param stdClass|\core\message\message $eventdata information about the message (component, userfrom, userto, ...)</span>
<a name="l55"><span class="linenum">  55</span></a>  <span class="comment"> * @return mixed the integer ID of the new message or false if there was a problem with submitted data</span>
<a name="l56"><span class="linenum">  56</span></a>  <span class="comment"> */</span>
<a name="l57"><span class="linenum">  57</span></a>  function <a class="function" onClick="logFunction('message_send')" href="../_functions/message_send.html" onMouseOver="funcPopup(event,'message_send')">message_send</a>(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>) {
<a name="l58"><span class="linenum">  58</span></a>      global <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../_variables/CFG.html">$CFG</a>, <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>;
<a name="l59"><span class="linenum">  59</span></a>  
<a name="l60"><span class="linenum">  60</span></a>  <span class="comment">    //new message ID to return</span>
<a name="l61"><span class="linenum">  61</span></a>      <a class="var it177" onMouseOver="hilite(177)" onMouseOut="lolite()" onClick="logVariable('messageid')" href="../_variables/messageid.html">$messageid</a> = false;
<a name="l62"><span class="linenum">  62</span></a>  
<a name="l63"><span class="linenum">  63</span></a>  <span class="comment">    // Fetch default (site) preferences</span>
<a name="l64"><span class="linenum">  64</span></a>      <a class="var it17320" onMouseOver="hilite(17320)" onMouseOut="lolite()" onClick="logVariable('defaultpreferences')" href="../_variables/defaultpreferences.html">$defaultpreferences</a> = <a class="function" onClick="logFunction('get_message_output_default_preferences')" href="../_functions/get_message_output_default_preferences.html" onMouseOver="funcPopup(event,'get_message_output_default_preferences')">get_message_output_default_preferences</a>();
<a name="l65"><span class="linenum">  65</span></a>      <a class="var it17321" onMouseOver="hilite(17321)" onMouseOut="lolite()" onClick="logVariable('preferencebase')" href="../_variables/preferencebase.html">$preferencebase</a> = <a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('component')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/component.html">component</a>.'_'.<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('name')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/name.html">name</a>;
<a name="l66"><span class="linenum">  66</span></a>  <span class="comment">    // If message provider is disabled then don't do any processing.</span>
<a name="l67"><span class="linenum">  67</span></a>      if (!empty(<a class="var it17320" onMouseOver="hilite(17320)" onMouseOut="lolite()" onClick="logVariable('defaultpreferences')" href="../_variables/defaultpreferences.html">$defaultpreferences</a>-&gt;{<a class="var it17321" onMouseOver="hilite(17321)" onMouseOut="lolite()" onClick="logVariable('preferencebase')" href="../_variables/preferencebase.html">$preferencebase</a>.'_disable'})) {
<a name="l68"><span class="linenum">  68</span></a>          return <a class="var it177" onMouseOver="hilite(177)" onMouseOut="lolite()" onClick="logVariable('messageid')" href="../_variables/messageid.html">$messageid</a>;
<a name="l69"><span class="linenum">  69</span></a>      }
<a name="l70"><span class="linenum">  70</span></a>  
<a name="l71"><span class="linenum">  71</span></a>  <span class="comment">    // By default a message is a notification. Only personal/private messages aren't notifications.</span>
<a name="l72"><span class="linenum">  72</span></a>      if (!isset(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('notification')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/notification.html">notification</a>)) {
<a name="l73"><span class="linenum">  73</span></a>          <a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('notification')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/notification.html">notification</a> = 1;
<a name="l74"><span class="linenum">  74</span></a>      }
<a name="l75"><span class="linenum">  75</span></a>  
<a name="l76"><span class="linenum">  76</span></a>      if (!<a class="phpfunction" onClick="logFunction('is_object')" href="../_functions/is_object.html" onMouseOver="phpfuncPopup(event,'is_object')">is_object</a>(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userto')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userto.html">userto</a>)) {
<a name="l77"><span class="linenum">  77</span></a>          <a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userto')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userto.html">userto</a> = <a class="class" onClick="logClass('core_user')" href="../_classes/core_user.html" onMouseOver="classPopup(event,'core_user')">core_user</a>::<a class="function" onClick="logFunction('get_user')" href="../_functions/get_user.html" onMouseOver="funcPopup(event,'get_user')">get_user</a>(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userto')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userto.html">userto</a>);
<a name="l78"><span class="linenum">  78</span></a>      }
<a name="l79"><span class="linenum">  79</span></a>      if (!<a class="phpfunction" onClick="logFunction('is_object')" href="../_functions/is_object.html" onMouseOver="phpfuncPopup(event,'is_object')">is_object</a>(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userfrom')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userfrom.html">userfrom</a>)) {
<a name="l80"><span class="linenum">  80</span></a>          <a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userfrom')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userfrom.html">userfrom</a> = <a class="class" onClick="logClass('core_user')" href="../_classes/core_user.html" onMouseOver="classPopup(event,'core_user')">core_user</a>::<a class="function" onClick="logFunction('get_user')" href="../_functions/get_user.html" onMouseOver="funcPopup(event,'get_user')">get_user</a>(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userfrom')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userfrom.html">userfrom</a>);
<a name="l81"><span class="linenum">  81</span></a>      }
<a name="l82"><span class="linenum">  82</span></a>      if (!<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userto')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userto.html">userto</a>) {
<a name="l83"><span class="linenum">  83</span></a>          <a class="function" onClick="logFunction('debugging')" href="../_functions/debugging.html" onMouseOver="funcPopup(event,'debugging')">debugging</a>('Attempt to send msg to unknown user', <a class="constant" onClick="logConstant('DEBUG_NORMAL')" href="../_constants/DEBUG_NORMAL.html" onMouseOver="constPopup(event,'DEBUG_NORMAL')">DEBUG_NORMAL</a>);
<a name="l84"><span class="linenum">  84</span></a>          return false;
<a name="l85"><span class="linenum">  85</span></a>      }
<a name="l86"><span class="linenum">  86</span></a>      if (!<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userfrom')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userfrom.html">userfrom</a>) {
<a name="l87"><span class="linenum">  87</span></a>          <a class="function" onClick="logFunction('debugging')" href="../_functions/debugging.html" onMouseOver="funcPopup(event,'debugging')">debugging</a>('Attempt to send msg from unknown user', <a class="constant" onClick="logConstant('DEBUG_NORMAL')" href="../_constants/DEBUG_NORMAL.html" onMouseOver="constPopup(event,'DEBUG_NORMAL')">DEBUG_NORMAL</a>);
<a name="l88"><span class="linenum">  88</span></a>          return false;
<a name="l89"><span class="linenum">  89</span></a>      }
<a name="l90"><span class="linenum">  90</span></a>  
<a name="l91"><span class="linenum">  91</span></a>  <span class="comment">    // Verify all necessary data fields are present.</span>
<a name="l92"><span class="linenum">  92</span></a>      if (!isset(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userto')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userto.html">userto</a>-&gt;auth) or !isset(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userto')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userto.html">userto</a>-&gt;suspended)
<a name="l93"><span class="linenum">  93</span></a>              or !isset(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userto')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userto.html">userto</a>-&gt;deleted) or !isset(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userto')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userto.html">userto</a>-&gt;emailstop)) {
<a name="l94"><span class="linenum">  94</span></a>  
<a name="l95"><span class="linenum">  95</span></a>          <a class="function" onClick="logFunction('debugging')" href="../_functions/debugging.html" onMouseOver="funcPopup(event,'debugging')">debugging</a>('Necessary properties missing in userto object, fetching full record', <a class="constant" onClick="logConstant('DEBUG_DEVELOPER')" href="../_constants/DEBUG_DEVELOPER.html" onMouseOver="constPopup(event,'DEBUG_DEVELOPER')">DEBUG_DEVELOPER</a>);
<a name="l96"><span class="linenum">  96</span></a>          <a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userto')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userto.html">userto</a> = <a class="class" onClick="logClass('core_user')" href="../_classes/core_user.html" onMouseOver="classPopup(event,'core_user')">core_user</a>::<a class="function" onClick="logFunction('get_user')" href="../_functions/get_user.html" onMouseOver="funcPopup(event,'get_user')">get_user</a>(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userto')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userto.html">userto</a>-&gt;id);
<a name="l97"><span class="linenum">  97</span></a>      }
<a name="l98"><span class="linenum">  98</span></a>  
<a name="l99"><span class="linenum">  99</span></a>      <a class="var it17322" onMouseOver="hilite(17322)" onMouseOut="lolite()" onClick="logVariable('usertoisrealuser')" href="../_variables/usertoisrealuser.html">$usertoisrealuser</a> = (<a class="class" onClick="logClass('core_user')" href="../_classes/core_user.html" onMouseOver="classPopup(event,'core_user')">core_user</a>::<a class="function" onClick="logFunction('is_real_user')" href="../_functions/is_real_user.html" onMouseOver="funcPopup(event,'is_real_user')">is_real_user</a>(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userto')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userto.html">userto</a>-&gt;id) != false);
<a name="l100"><span class="linenum"> 100</span></a>  <span class="comment">    // If recipient is internal user (noreply user), and emailstop is set then don't send any msg.</span>
<a name="l101"><span class="linenum"> 101</span></a>      if (!<a class="var it17322" onMouseOver="hilite(17322)" onMouseOut="lolite()" onClick="logVariable('usertoisrealuser')" href="../_variables/usertoisrealuser.html">$usertoisrealuser</a> &amp;&amp; !empty(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userto')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userto.html">userto</a>-&gt;emailstop)) {
<a name="l102"><span class="linenum"> 102</span></a>          <a class="function" onClick="logFunction('debugging')" href="../_functions/debugging.html" onMouseOver="funcPopup(event,'debugging')">debugging</a>('Attempt to send msg to internal (noreply) user', <a class="constant" onClick="logConstant('DEBUG_NORMAL')" href="../_constants/DEBUG_NORMAL.html" onMouseOver="constPopup(event,'DEBUG_NORMAL')">DEBUG_NORMAL</a>);
<a name="l103"><span class="linenum"> 103</span></a>          return false;
<a name="l104"><span class="linenum"> 104</span></a>      }
<a name="l105"><span class="linenum"> 105</span></a>  
<a name="l106"><span class="linenum"> 106</span></a>  <span class="comment">    //after how long inactive should the user be considered logged off?</span>
<a name="l107"><span class="linenum"> 107</span></a>      if (isset(<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('block_online_users_timetosee')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../_variables/block_online_users_timetosee.html">block_online_users_timetosee</a>)) {
<a name="l108"><span class="linenum"> 108</span></a>          <a class="var it17324" onMouseOver="hilite(17324)" onMouseOut="lolite()" onClick="logVariable('timetoshowusers')" href="../_variables/timetoshowusers.html">$timetoshowusers</a> = <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('block_online_users_timetosee')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../_variables/block_online_users_timetosee.html">block_online_users_timetosee</a> * 60;
<a name="l109"><span class="linenum"> 109</span></a>      } else {
<a name="l110"><span class="linenum"> 110</span></a>          <a class="var it17324" onMouseOver="hilite(17324)" onMouseOut="lolite()" onClick="logVariable('timetoshowusers')" href="../_variables/timetoshowusers.html">$timetoshowusers</a> = 300;<span class="comment">//5 minutes</span>
<a name="l111"><span class="linenum"> 111</span></a>      }
<a name="l112"><span class="linenum"> 112</span></a>  
<a name="l113"><span class="linenum"> 113</span></a>  <span class="comment">    // Work out if the user is logged in or not</span>
<a name="l114"><span class="linenum"> 114</span></a>      if (!empty(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userto')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userto.html">userto</a>-&gt;lastaccess) &amp;&amp; (<a class="phpfunction" onClick="logFunction('time')" href="../_functions/time.html" onMouseOver="phpfuncPopup(event,'time')">time</a>()-<a class="var it17324" onMouseOver="hilite(17324)" onMouseOut="lolite()" onClick="logVariable('timetoshowusers')" href="../_variables/timetoshowusers.html">$timetoshowusers</a>) &lt; <a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userto')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userto.html">userto</a>-&gt;lastaccess) {
<a name="l115"><span class="linenum"> 115</span></a>          <a class="var it17325" onMouseOver="hilite(17325)" onMouseOut="lolite()" onClick="logVariable('userstate')" href="../_variables/userstate.html">$userstate</a> = 'loggedin';
<a name="l116"><span class="linenum"> 116</span></a>      } else {
<a name="l117"><span class="linenum"> 117</span></a>          <a class="var it17325" onMouseOver="hilite(17325)" onMouseOut="lolite()" onClick="logVariable('userstate')" href="../_variables/userstate.html">$userstate</a> = 'loggedoff';
<a name="l118"><span class="linenum"> 118</span></a>      }
<a name="l119"><span class="linenum"> 119</span></a>  
<a name="l120"><span class="linenum"> 120</span></a>  <span class="comment">    // Create the message object</span>
<a name="l121"><span class="linenum"> 121</span></a>      <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a> = new stdClass();
<a name="l122"><span class="linenum"> 122</span></a>      <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>-&gt;<a onClick="logVariable('useridfrom')" class="var it41057" onMouseOver="hilite(41057)" onMouseOut="lolite()" href="../_variables/useridfrom.html">useridfrom</a>        = <a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userfrom')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userfrom.html">userfrom</a>-&gt;id;
<a name="l123"><span class="linenum"> 123</span></a>      <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>-&gt;<a onClick="logVariable('useridto')" class="var it41057" onMouseOver="hilite(41057)" onMouseOut="lolite()" href="../_variables/useridto.html">useridto</a>          = <a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userto')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userto.html">userto</a>-&gt;id;
<a name="l124"><span class="linenum"> 124</span></a>      <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>-&gt;<a onClick="logVariable('subject')" class="var it41057" onMouseOver="hilite(41057)" onMouseOut="lolite()" href="../_variables/subject.html">subject</a>           = <a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('subject')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/subject.html">subject</a>;
<a name="l125"><span class="linenum"> 125</span></a>      <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>-&gt;<a onClick="logVariable('fullmessage')" class="var it41057" onMouseOver="hilite(41057)" onMouseOut="lolite()" href="../_variables/fullmessage.html">fullmessage</a>       = <a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('fullmessage')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/fullmessage.html">fullmessage</a>;
<a name="l126"><span class="linenum"> 126</span></a>      <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>-&gt;<a onClick="logVariable('fullmessageformat')" class="var it41057" onMouseOver="hilite(41057)" onMouseOut="lolite()" href="../_variables/fullmessageformat.html">fullmessageformat</a> = <a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('fullmessageformat')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/fullmessageformat.html">fullmessageformat</a>;
<a name="l127"><span class="linenum"> 127</span></a>      <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>-&gt;<a onClick="logVariable('fullmessagehtml')" class="var it41057" onMouseOver="hilite(41057)" onMouseOut="lolite()" href="../_variables/fullmessagehtml.html">fullmessagehtml</a>   = <a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('fullmessagehtml')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/fullmessagehtml.html">fullmessagehtml</a>;
<a name="l128"><span class="linenum"> 128</span></a>      <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>-&gt;<a onClick="logVariable('smallmessage')" class="var it41057" onMouseOver="hilite(41057)" onMouseOut="lolite()" href="../_variables/smallmessage.html">smallmessage</a>      = <a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('smallmessage')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/smallmessage.html">smallmessage</a>;
<a name="l129"><span class="linenum"> 129</span></a>      <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>-&gt;<a onClick="logVariable('notification')" class="var it41057" onMouseOver="hilite(41057)" onMouseOut="lolite()" href="../_variables/notification.html">notification</a>      = <a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('notification')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/notification.html">notification</a>;
<a name="l130"><span class="linenum"> 130</span></a>  
<a name="l131"><span class="linenum"> 131</span></a>      if (!empty(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('contexturl')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/contexturl.html">contexturl</a>)) {
<a name="l132"><span class="linenum"> 132</span></a>          <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>-&gt;<a onClick="logVariable('contexturl')" class="var it41057" onMouseOver="hilite(41057)" onMouseOut="lolite()" href="../_variables/contexturl.html">contexturl</a> = (string)<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('contexturl')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/contexturl.html">contexturl</a>;
<a name="l133"><span class="linenum"> 133</span></a>      } else {
<a name="l134"><span class="linenum"> 134</span></a>          <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>-&gt;<a onClick="logVariable('contexturl')" class="var it41057" onMouseOver="hilite(41057)" onMouseOut="lolite()" href="../_variables/contexturl.html">contexturl</a> = null;
<a name="l135"><span class="linenum"> 135</span></a>      }
<a name="l136"><span class="linenum"> 136</span></a>  
<a name="l137"><span class="linenum"> 137</span></a>      if (!empty(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('contexturlname')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/contexturlname.html">contexturlname</a>)) {
<a name="l138"><span class="linenum"> 138</span></a>          <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>-&gt;<a onClick="logVariable('contexturlname')" class="var it41057" onMouseOver="hilite(41057)" onMouseOut="lolite()" href="../_variables/contexturlname.html">contexturlname</a> = (string)<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('contexturlname')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/contexturlname.html">contexturlname</a>;
<a name="l139"><span class="linenum"> 139</span></a>      } else {
<a name="l140"><span class="linenum"> 140</span></a>          <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>-&gt;<a onClick="logVariable('contexturlname')" class="var it41057" onMouseOver="hilite(41057)" onMouseOut="lolite()" href="../_variables/contexturlname.html">contexturlname</a> = null;
<a name="l141"><span class="linenum"> 141</span></a>      }
<a name="l142"><span class="linenum"> 142</span></a>  
<a name="l143"><span class="linenum"> 143</span></a>      <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>-&gt;<a onClick="logVariable('timecreated')" class="var it41057" onMouseOver="hilite(41057)" onMouseOut="lolite()" href="../_variables/timecreated.html">timecreated</a> = <a class="phpfunction" onClick="logFunction('time')" href="../_functions/time.html" onMouseOver="phpfuncPopup(event,'time')">time</a>();
<a name="l144"><span class="linenum"> 144</span></a>  
<a name="l145"><span class="linenum"> 145</span></a>      if (<a class="constant" onClick="logConstant('PHPUNIT_TEST')" href="../_constants/PHPUNIT_TEST.html" onMouseOver="constPopup(event,'PHPUNIT_TEST')">PHPUNIT_TEST</a> and <a class="phpfunction" onClick="logFunction('class_exists')" href="../_functions/class_exists.html" onMouseOver="phpfuncPopup(event,'class_exists')">class_exists</a>('phpunit_util')) {
<a name="l146"><span class="linenum"> 146</span></a>  <span class="comment">        // Add some more tests to make sure the normal code can actually work.</span>
<a name="l147"><span class="linenum"> 147</span></a>          <a class="var it17329" onMouseOver="hilite(17329)" onMouseOut="lolite()" onClick="logVariable('componentdir')" href="../_variables/componentdir.html">$componentdir</a> = <a class="class" onClick="logClass('core_component')" href="../_classes/core_component.html" onMouseOver="classPopup(event,'core_component')">core_component</a>::<a class="function" onClick="logFunction('get_component_directory')" href="../_functions/get_component_directory.html" onMouseOver="funcPopup(event,'get_component_directory')">get_component_directory</a>(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('component')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/component.html">component</a>);
<a name="l148"><span class="linenum"> 148</span></a>          if (!<a class="var it17329" onMouseOver="hilite(17329)" onMouseOut="lolite()" onClick="logVariable('componentdir')" href="../_variables/componentdir.html">$componentdir</a> or !<a class="phpfunction" onClick="logFunction('is_dir')" href="../_functions/is_dir.html" onMouseOver="phpfuncPopup(event,'is_dir')">is_dir</a>(<a class="var it17329" onMouseOver="hilite(17329)" onMouseOut="lolite()" onClick="logVariable('componentdir')" href="../_variables/componentdir.html">$componentdir</a>)) {
<a name="l149"><span class="linenum"> 149</span></a>              throw <span class="keyword">new </span><a class="class" onClick="logClass('coding_exception')" href="../_classes/coding_exception.html" onMouseOver="classPopup(event,'coding_exception')">coding_exception</a>('Invalid component specified in message-<a class="function" onClick="logFunction('send')" href="../_functions/send.html" onMouseOver="funcPopup(event,'send')">send</a>(): '.<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('component')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/component.html">component</a>);
<a name="l150"><span class="linenum"> 150</span></a>          }
<a name="l151"><span class="linenum"> 151</span></a>          if (!<a class="phpfunction" onClick="logFunction('file_exists')" href="../_functions/file_exists.html" onMouseOver="phpfuncPopup(event,'file_exists')">file_exists</a>(&quot;<a class="var it17329" onMouseOver="hilite(17329)" onMouseOut="lolite()" onClick="logVariable('componentdir')" href="../_variables/componentdir.html">$componentdir</a>/db/messages.php&quot;)) {
<a name="l152"><span class="linenum"> 152</span></a>              throw <span class="keyword">new </span><a class="class" onClick="logClass('coding_exception')" href="../_classes/coding_exception.html" onMouseOver="classPopup(event,'coding_exception')">coding_exception</a>(&quot;<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('component')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/component.html">component</a> does not contain db/messages.php necessary for <a class="function" onClick="logFunction('message_send')" href="../_functions/message_send.html" onMouseOver="funcPopup(event,'message_send')">message_send</a>()&quot;);
<a name="l153"><span class="linenum"> 153</span></a>          }
<a name="l154"><span class="linenum"> 154</span></a>          <a class="var it7619" onMouseOver="hilite(7619)" onMouseOut="lolite()" onClick="logVariable('messageproviders')" href="../_variables/messageproviders.html">$messageproviders</a> = null;
<a name="l155"><span class="linenum"> 155</span></a>          include(&quot;<a class="var it17329" onMouseOver="hilite(17329)" onMouseOut="lolite()" onClick="logVariable('componentdir')" href="../_variables/componentdir.html">$componentdir</a>/db/messages.php&quot;);
<a name="l156"><span class="linenum"> 156</span></a>          if (!isset(<a class="var it7619" onMouseOver="hilite(7619)" onMouseOut="lolite()" onClick="logVariable('messageproviders')" href="../_variables/messageproviders.html">$messageproviders</a>[<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('name')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/name.html">name</a>])) {
<a name="l157"><span class="linenum"> 157</span></a>              throw <span class="keyword">new </span><a class="class" onClick="logClass('coding_exception')" href="../_classes/coding_exception.html" onMouseOver="classPopup(event,'coding_exception')">coding_exception</a>(&quot;Missing messaging defaults for event '<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('name')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/name.html">name</a>' in '<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('component')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/component.html">component</a>' messages.php file&quot;);
<a name="l158"><span class="linenum"> 158</span></a>          }
<a name="l159"><span class="linenum"> 159</span></a>          unset(<a class="var it17329" onMouseOver="hilite(17329)" onMouseOut="lolite()" onClick="logVariable('componentdir')" href="../_variables/componentdir.html">$componentdir</a>);
<a name="l160"><span class="linenum"> 160</span></a>          unset(<a class="var it7619" onMouseOver="hilite(7619)" onMouseOut="lolite()" onClick="logVariable('messageproviders')" href="../_variables/messageproviders.html">$messageproviders</a>);
<a name="l161"><span class="linenum"> 161</span></a>  <span class="comment">        // Now ask phpunit if it wants to catch this message.</span>
<a name="l162"><span class="linenum"> 162</span></a>          if (<a class="class" onClick="logClass('phpunit_util')" href="../_classes/phpunit_util.html" onMouseOver="classPopup(event,'phpunit_util')">phpunit_util</a>::<a class="function" onClick="logFunction('is_redirecting_messages')" href="../_functions/is_redirecting_messages.html" onMouseOver="funcPopup(event,'is_redirecting_messages')">is_redirecting_messages</a>()) {
<a name="l163"><span class="linenum"> 163</span></a>              <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>-&gt;<a onClick="logVariable('timeread')" class="var it41057" onMouseOver="hilite(41057)" onMouseOut="lolite()" href="../_variables/timeread.html">timeread</a> = <a class="phpfunction" onClick="logFunction('time')" href="../_functions/time.html" onMouseOver="phpfuncPopup(event,'time')">time</a>();
<a name="l164"><span class="linenum"> 164</span></a>              <a class="var it177" onMouseOver="hilite(177)" onMouseOut="lolite()" onClick="logVariable('messageid')" href="../_variables/messageid.html">$messageid</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('message_read', <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>);
<a name="l165"><span class="linenum"> 165</span></a>              <a class="var it643" onMouseOver="hilite(643)" onMouseOut="lolite()" onClick="logVariable('message')" href="../_variables/message.html">$message</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_record')" href="../_functions/get_record.html" onMouseOver="funcPopup(event,'get_record')">get_record</a>('message_read', array('id'=&gt;<a class="var it177" onMouseOver="hilite(177)" onMouseOut="lolite()" onClick="logVariable('messageid')" href="../_variables/messageid.html">$messageid</a>));
<a name="l166"><span class="linenum"> 166</span></a>              <a class="class" onClick="logClass('phpunit_util')" href="../_classes/phpunit_util.html" onMouseOver="classPopup(event,'phpunit_util')">phpunit_util</a>::<a class="function" onClick="logFunction('message_sent')" href="../_functions/message_sent.html" onMouseOver="funcPopup(event,'message_sent')">message_sent</a>(<a class="var it643" onMouseOver="hilite(643)" onMouseOut="lolite()" onClick="logVariable('message')" href="../_variables/message.html">$message</a>);
<a name="l167"><span class="linenum"> 167</span></a>              return <a class="var it177" onMouseOver="hilite(177)" onMouseOut="lolite()" onClick="logVariable('messageid')" href="../_variables/messageid.html">$messageid</a>;
<a name="l168"><span class="linenum"> 168</span></a>          }
<a name="l169"><span class="linenum"> 169</span></a>      }
<a name="l170"><span class="linenum"> 170</span></a>  
<a name="l171"><span class="linenum"> 171</span></a>  <span class="comment">    // Fetch enabled processors</span>
<a name="l172"><span class="linenum"> 172</span></a>      <a class="var it17330" onMouseOver="hilite(17330)" onMouseOut="lolite()" onClick="logVariable('processors')" href="../_variables/processors.html">$processors</a> = <a class="function" onClick="logFunction('get_message_processors')" href="../_functions/get_message_processors.html" onMouseOver="funcPopup(event,'get_message_processors')">get_message_processors</a>(true);
<a name="l173"><span class="linenum"> 173</span></a>  
<a name="l174"><span class="linenum"> 174</span></a>  <span class="comment">    // Preset variables</span>
<a name="l175"><span class="linenum"> 175</span></a>      <a class="var it17331" onMouseOver="hilite(17331)" onMouseOut="lolite()" onClick="logVariable('processorlist')" href="../_variables/processorlist.html">$processorlist</a> = array();
<a name="l176"><span class="linenum"> 176</span></a>  <span class="comment">    // Fill in the array of processors to be used based on default and user preferences</span>
<a name="l177"><span class="linenum"> 177</span></a>      foreach (<a class="var it17330" onMouseOver="hilite(17330)" onMouseOut="lolite()" onClick="logVariable('processors')" href="../_variables/processors.html">$processors</a> as <a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a>) {
<a name="l178"><span class="linenum"> 178</span></a>  <span class="comment">        // Skip adding processors for internal user, if processor doesn't support sending message to internal user.</span>
<a name="l179"><span class="linenum"> 179</span></a>          if (!<a class="var it17322" onMouseOver="hilite(17322)" onMouseOut="lolite()" onClick="logVariable('usertoisrealuser')" href="../_variables/usertoisrealuser.html">$usertoisrealuser</a> &amp;&amp; !<a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a>-&gt;<a onClick="logVariable('object')" class="var it40115" onMouseOver="hilite(40115)" onMouseOut="lolite()" href="../_variables/object.html">object</a>-&gt;<a class="function" onClick="logFunction('can_send_to_any_users')" href="../_functions/can_send_to_any_users.html" onMouseOver="funcPopup(event,'can_send_to_any_users')">can_send_to_any_users</a>()) {
<a name="l180"><span class="linenum"> 180</span></a>              continue;
<a name="l181"><span class="linenum"> 181</span></a>          }
<a name="l182"><span class="linenum"> 182</span></a>  
<a name="l183"><span class="linenum"> 183</span></a>  <span class="comment">        // First find out permissions</span>
<a name="l184"><span class="linenum"> 184</span></a>          <a class="var it17332" onMouseOver="hilite(17332)" onMouseOut="lolite()" onClick="logVariable('defaultpreference')" href="../_variables/defaultpreference.html">$defaultpreference</a> = <a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a>-&gt;<a onClick="logVariable('name')" class="var it40115" onMouseOver="hilite(40115)" onMouseOut="lolite()" href="../_variables/name.html">name</a>.'_provider_'.<a class="var it17321" onMouseOver="hilite(17321)" onMouseOut="lolite()" onClick="logVariable('preferencebase')" href="../_variables/preferencebase.html">$preferencebase</a>.'_permitted';
<a name="l185"><span class="linenum"> 185</span></a>          if (isset(<a class="var it17320" onMouseOver="hilite(17320)" onMouseOut="lolite()" onClick="logVariable('defaultpreferences')" href="../_variables/defaultpreferences.html">$defaultpreferences</a>-&gt;{<a class="var it17332" onMouseOver="hilite(17332)" onMouseOut="lolite()" onClick="logVariable('defaultpreference')" href="../_variables/defaultpreference.html">$defaultpreference</a>})) {
<a name="l186"><span class="linenum"> 186</span></a>              <a class="var it17333" onMouseOver="hilite(17333)" onMouseOut="lolite()" onClick="logVariable('permitted')" href="../_variables/permitted.html">$permitted</a> = <a class="var it17320" onMouseOver="hilite(17320)" onMouseOut="lolite()" onClick="logVariable('defaultpreferences')" href="../_variables/defaultpreferences.html">$defaultpreferences</a>-&gt;{<a class="var it17332" onMouseOver="hilite(17332)" onMouseOut="lolite()" onClick="logVariable('defaultpreference')" href="../_variables/defaultpreference.html">$defaultpreference</a>};
<a name="l187"><span class="linenum"> 187</span></a>          } else {
<a name="l188"><span class="linenum"> 188</span></a>  <span class="comment">            // MDL-25114 They supplied an $eventdata-&gt;component $eventdata-&gt;name combination which doesn't</span>
<a name="l189"><span class="linenum"> 189</span></a>  <span class="comment">            // exist in the message_provider table (thus there is no default settings for them).</span>
<a name="l190"><span class="linenum"> 190</span></a>              <a class="var it17334" onMouseOver="hilite(17334)" onMouseOut="lolite()" onClick="logVariable('preferrormsg')" href="../_variables/preferrormsg.html">$preferrormsg</a> = &quot;Could not load preference <a class="var it17332" onMouseOver="hilite(17332)" onMouseOut="lolite()" onClick="logVariable('defaultpreference')" href="../_variables/defaultpreference.html">$defaultpreference</a>. Make sure the component and name you supplied
<a name="l191"><span class="linenum"> 191</span></a>                      to <a class="function" onClick="logFunction('message_send')" href="../_functions/message_send.html" onMouseOver="funcPopup(event,'message_send')">message_send</a>() are valid.&quot;;
<a name="l192"><span class="linenum"> 192</span></a>              throw <span class="keyword">new </span><a class="class" onClick="logClass('coding_exception')" href="../_classes/coding_exception.html" onMouseOver="classPopup(event,'coding_exception')">coding_exception</a>(<a class="var it17334" onMouseOver="hilite(17334)" onMouseOut="lolite()" onClick="logVariable('preferrormsg')" href="../_variables/preferrormsg.html">$preferrormsg</a>);
<a name="l193"><span class="linenum"> 193</span></a>          }
<a name="l194"><span class="linenum"> 194</span></a>  
<a name="l195"><span class="linenum"> 195</span></a>  <span class="comment">        // Find out if user has configured this output</span>
<a name="l196"><span class="linenum"> 196</span></a>  <span class="comment">        // Some processors cannot function without settings from the user</span>
<a name="l197"><span class="linenum"> 197</span></a>          <a class="var it17335" onMouseOver="hilite(17335)" onMouseOut="lolite()" onClick="logVariable('userisconfigured')" href="../_variables/userisconfigured.html">$userisconfigured</a> = <a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a>-&gt;<a onClick="logVariable('object')" class="var it40115" onMouseOver="hilite(40115)" onMouseOut="lolite()" href="../_variables/object.html">object</a>-&gt;<a class="function" onClick="logFunction('is_user_configured')" href="../_functions/is_user_configured.html" onMouseOver="funcPopup(event,'is_user_configured')">is_user_configured</a>(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userto')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userto.html">userto</a>);
<a name="l198"><span class="linenum"> 198</span></a>  
<a name="l199"><span class="linenum"> 199</span></a>  <span class="comment">        // DEBUG: notify if we are forcing unconfigured output</span>
<a name="l200"><span class="linenum"> 200</span></a>          if (<a class="var it17333" onMouseOver="hilite(17333)" onMouseOut="lolite()" onClick="logVariable('permitted')" href="../_variables/permitted.html">$permitted</a> == 'forced' &amp;&amp; !<a class="var it17335" onMouseOver="hilite(17335)" onMouseOut="lolite()" onClick="logVariable('userisconfigured')" href="../_variables/userisconfigured.html">$userisconfigured</a>) {
<a name="l201"><span class="linenum"> 201</span></a>              <a class="function" onClick="logFunction('debugging')" href="../_functions/debugging.html" onMouseOver="funcPopup(event,'debugging')">debugging</a>('Attempt to force message delivery to user who has &quot;'.<a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a>-&gt;<a onClick="logVariable('name')" class="var it40115" onMouseOver="hilite(40115)" onMouseOut="lolite()" href="../_variables/name.html">name</a>.'&quot; output unconfigured', <a class="constant" onClick="logConstant('DEBUG_NORMAL')" href="../_constants/DEBUG_NORMAL.html" onMouseOver="constPopup(event,'DEBUG_NORMAL')">DEBUG_NORMAL</a>);
<a name="l202"><span class="linenum"> 202</span></a>          }
<a name="l203"><span class="linenum"> 203</span></a>  
<a name="l204"><span class="linenum"> 204</span></a>  <span class="comment">        // Populate the list of processors we will be using</span>
<a name="l205"><span class="linenum"> 205</span></a>          if (<a class="var it17333" onMouseOver="hilite(17333)" onMouseOut="lolite()" onClick="logVariable('permitted')" href="../_variables/permitted.html">$permitted</a> == 'forced' &amp;&amp; <a class="var it17335" onMouseOver="hilite(17335)" onMouseOut="lolite()" onClick="logVariable('userisconfigured')" href="../_variables/userisconfigured.html">$userisconfigured</a>) {
<a name="l206"><span class="linenum"> 206</span></a>  <span class="comment">            // An admin is forcing users to use this message processor. Use this processor unconditionally.</span>
<a name="l207"><span class="linenum"> 207</span></a>              <a class="var it17331" onMouseOver="hilite(17331)" onMouseOut="lolite()" onClick="logVariable('processorlist')" href="../_variables/processorlist.html">$processorlist</a>[] = <a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a>-&gt;<a onClick="logVariable('name')" class="var it40115" onMouseOver="hilite(40115)" onMouseOut="lolite()" href="../_variables/name.html">name</a>;
<a name="l208"><span class="linenum"> 208</span></a>          } else if (<a class="var it17333" onMouseOver="hilite(17333)" onMouseOut="lolite()" onClick="logVariable('permitted')" href="../_variables/permitted.html">$permitted</a> == 'permitted' &amp;&amp; <a class="var it17335" onMouseOver="hilite(17335)" onMouseOut="lolite()" onClick="logVariable('userisconfigured')" href="../_variables/userisconfigured.html">$userisconfigured</a> &amp;&amp; !<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userto')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userto.html">userto</a>-&gt;emailstop) {
<a name="l209"><span class="linenum"> 209</span></a>  <span class="comment">            // User has not disabled notifications</span>
<a name="l210"><span class="linenum"> 210</span></a>  <span class="comment">            // See if user set any notification preferences, otherwise use site default ones</span>
<a name="l211"><span class="linenum"> 211</span></a>              <a class="var it17336" onMouseOver="hilite(17336)" onMouseOut="lolite()" onClick="logVariable('userpreferencename')" href="../_variables/userpreferencename.html">$userpreferencename</a> = 'message_provider_'.<a class="var it17321" onMouseOver="hilite(17321)" onMouseOut="lolite()" onClick="logVariable('preferencebase')" href="../_variables/preferencebase.html">$preferencebase</a>.'_'.<a class="var it17325" onMouseOver="hilite(17325)" onMouseOut="lolite()" onClick="logVariable('userstate')" href="../_variables/userstate.html">$userstate</a>;
<a name="l212"><span class="linenum"> 212</span></a>              if (<a class="var it17337" onMouseOver="hilite(17337)" onMouseOut="lolite()" onClick="logVariable('userpreference')" href="../_variables/userpreference.html">$userpreference</a> = <a class="function" onClick="logFunction('get_user_preferences')" href="../_functions/get_user_preferences.html" onMouseOver="funcPopup(event,'get_user_preferences')">get_user_preferences</a>(<a class="var it17336" onMouseOver="hilite(17336)" onMouseOut="lolite()" onClick="logVariable('userpreferencename')" href="../_variables/userpreferencename.html">$userpreferencename</a>, null, <a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('userto')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/userto.html">userto</a>)) {
<a name="l213"><span class="linenum"> 213</span></a>                  if (<a class="phpfunction" onClick="logFunction('in_array')" href="../_functions/in_array.html" onMouseOver="phpfuncPopup(event,'in_array')">in_array</a>(<a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a>-&gt;<a onClick="logVariable('name')" class="var it40115" onMouseOver="hilite(40115)" onMouseOut="lolite()" href="../_variables/name.html">name</a>, <a class="phpfunction" onClick="logFunction('explode')" href="../_functions/explode.html" onMouseOver="phpfuncPopup(event,'explode')">explode</a>(',', <a class="var it17337" onMouseOver="hilite(17337)" onMouseOut="lolite()" onClick="logVariable('userpreference')" href="../_variables/userpreference.html">$userpreference</a>))) {
<a name="l214"><span class="linenum"> 214</span></a>                      <a class="var it17331" onMouseOver="hilite(17331)" onMouseOut="lolite()" onClick="logVariable('processorlist')" href="../_variables/processorlist.html">$processorlist</a>[] = <a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a>-&gt;<a onClick="logVariable('name')" class="var it40115" onMouseOver="hilite(40115)" onMouseOut="lolite()" href="../_variables/name.html">name</a>;
<a name="l215"><span class="linenum"> 215</span></a>                  }
<a name="l216"><span class="linenum"> 216</span></a>              } else if (isset(<a class="var it17320" onMouseOver="hilite(17320)" onMouseOut="lolite()" onClick="logVariable('defaultpreferences')" href="../_variables/defaultpreferences.html">$defaultpreferences</a>-&gt;{<a class="var it17336" onMouseOver="hilite(17336)" onMouseOut="lolite()" onClick="logVariable('userpreferencename')" href="../_variables/userpreferencename.html">$userpreferencename</a>})) {
<a name="l217"><span class="linenum"> 217</span></a>                  if (<a class="phpfunction" onClick="logFunction('in_array')" href="../_functions/in_array.html" onMouseOver="phpfuncPopup(event,'in_array')">in_array</a>(<a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a>-&gt;<a onClick="logVariable('name')" class="var it40115" onMouseOver="hilite(40115)" onMouseOut="lolite()" href="../_variables/name.html">name</a>, <a class="phpfunction" onClick="logFunction('explode')" href="../_functions/explode.html" onMouseOver="phpfuncPopup(event,'explode')">explode</a>(',', <a class="var it17320" onMouseOver="hilite(17320)" onMouseOut="lolite()" onClick="logVariable('defaultpreferences')" href="../_variables/defaultpreferences.html">$defaultpreferences</a>-&gt;{<a class="var it17336" onMouseOver="hilite(17336)" onMouseOut="lolite()" onClick="logVariable('userpreferencename')" href="../_variables/userpreferencename.html">$userpreferencename</a>}))) {
<a name="l218"><span class="linenum"> 218</span></a>                      <a class="var it17331" onMouseOver="hilite(17331)" onMouseOut="lolite()" onClick="logVariable('processorlist')" href="../_variables/processorlist.html">$processorlist</a>[] = <a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a>-&gt;<a onClick="logVariable('name')" class="var it40115" onMouseOver="hilite(40115)" onMouseOut="lolite()" href="../_variables/name.html">name</a>;
<a name="l219"><span class="linenum"> 219</span></a>                  }
<a name="l220"><span class="linenum"> 220</span></a>              }
<a name="l221"><span class="linenum"> 221</span></a>          }
<a name="l222"><span class="linenum"> 222</span></a>      }
<a name="l223"><span class="linenum"> 223</span></a>  
<a name="l224"><span class="linenum"> 224</span></a>  <span class="comment">    // Store unread message just in case we get a fatal error any time later.</span>
<a name="l225"><span class="linenum"> 225</span></a>      <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>-&gt;<a onClick="logVariable('id')" class="var it41057" onMouseOver="hilite(41057)" onMouseOut="lolite()" href="../_variables/id.html">id</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('message', <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>);
<a name="l226"><span class="linenum"> 226</span></a>      <a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>-&gt;<a onClick="logVariable('savedmessageid')" class="var it39511" onMouseOver="hilite(39511)" onMouseOut="lolite()" href="../_variables/savedmessageid.html">savedmessageid</a> = <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>-&gt;<a onClick="logVariable('id')" class="var it41057" onMouseOver="hilite(41057)" onMouseOut="lolite()" href="../_variables/id.html">id</a>;
<a name="l227"><span class="linenum"> 227</span></a>  
<a name="l228"><span class="linenum"> 228</span></a>  <span class="comment">    // Let the manager do the sending or buffering when db transaction in progress.</span>
<a name="l229"><span class="linenum"> 229</span></a>      return \core\message\<a class="class" onClick="logClass('manager')" href="../_classes/manager.html" onMouseOver="classPopup(event,'manager')">manager</a>::<a class="function" onClick="logFunction('send_message')" href="../_functions/send_message.html" onMouseOver="funcPopup(event,'send_message')">send_message</a>(<a class="var it8012" onMouseOver="hilite(8012)" onMouseOut="lolite()" onClick="logVariable('eventdata')" href="../_variables/eventdata.html">$eventdata</a>, <a class="var it17326" onMouseOver="hilite(17326)" onMouseOut="lolite()" onClick="logVariable('savemessage')" href="../_variables/savemessage.html">$savemessage</a>, <a class="var it17331" onMouseOver="hilite(17331)" onMouseOut="lolite()" onClick="logVariable('processorlist')" href="../_variables/processorlist.html">$processorlist</a>);
<a name="l230"><span class="linenum"> 230</span></a>  }
<a name="l231"><span class="linenum"> 231</span></a>  
<a name="l232"><span class="linenum"> 232</span></a>  
<a name="l233"><span class="linenum"> 233</span></a>  <span class="comment">/**</span>
<a name="l234"><span class="linenum"> 234</span></a>  <span class="comment"> * Updates the message_providers table with the current set of message providers</span>
<a name="l235"><span class="linenum"> 235</span></a>  <span class="comment"> *</span>
<a name="l236"><span class="linenum"> 236</span></a>  <span class="comment"> * @param string $component For example 'moodle', 'mod_forum' or 'block_quiz_results'</span>
<a name="l237"><span class="linenum"> 237</span></a>  <span class="comment"> * @return boolean True on success</span>
<a name="l238"><span class="linenum"> 238</span></a>  <span class="comment"> */</span>
<a name="l239"><span class="linenum"> 239</span></a>  function <a class="function" onClick="logFunction('message_update_providers')" href="../_functions/message_update_providers.html" onMouseOver="funcPopup(event,'message_update_providers')">message_update_providers</a>(<a class="var it547" onMouseOver="hilite(547)" onMouseOut="lolite()" onClick="logVariable('component')" href="../_variables/component.html">$component</a>='moodle') {
<a name="l240"><span class="linenum"> 240</span></a>      global <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>;
<a name="l241"><span class="linenum"> 241</span></a>  
<a name="l242"><span class="linenum"> 242</span></a>  <span class="comment">    // load message providers from files</span>
<a name="l243"><span class="linenum"> 243</span></a>      <a class="var it17338" onMouseOver="hilite(17338)" onMouseOut="lolite()" onClick="logVariable('fileproviders')" href="../_variables/fileproviders.html">$fileproviders</a> = <a class="function" onClick="logFunction('message_get_providers_from_file')" href="../_functions/message_get_providers_from_file.html" onMouseOver="funcPopup(event,'message_get_providers_from_file')">message_get_providers_from_file</a>(<a class="var it547" onMouseOver="hilite(547)" onMouseOut="lolite()" onClick="logVariable('component')" href="../_variables/component.html">$component</a>);
<a name="l244"><span class="linenum"> 244</span></a>  
<a name="l245"><span class="linenum"> 245</span></a>  <span class="comment">    // load message providers from the database</span>
<a name="l246"><span class="linenum"> 246</span></a>      <a class="var it17339" onMouseOver="hilite(17339)" onMouseOut="lolite()" onClick="logVariable('dbproviders')" href="../_variables/dbproviders.html">$dbproviders</a> = <a class="function" onClick="logFunction('message_get_providers_from_db')" href="../_functions/message_get_providers_from_db.html" onMouseOver="funcPopup(event,'message_get_providers_from_db')">message_get_providers_from_db</a>(<a class="var it547" onMouseOver="hilite(547)" onMouseOut="lolite()" onClick="logVariable('component')" href="../_variables/component.html">$component</a>);
<a name="l247"><span class="linenum"> 247</span></a>  
<a name="l248"><span class="linenum"> 248</span></a>      foreach (<a class="var it17338" onMouseOver="hilite(17338)" onMouseOut="lolite()" onClick="logVariable('fileproviders')" href="../_variables/fileproviders.html">$fileproviders</a> as <a class="var it17340" onMouseOver="hilite(17340)" onMouseOut="lolite()" onClick="logVariable('messagename')" href="../_variables/messagename.html">$messagename</a> =&gt; <a class="var it17341" onMouseOver="hilite(17341)" onMouseOut="lolite()" onClick="logVariable('fileprovider')" href="../_variables/fileprovider.html">$fileprovider</a>) {
<a name="l249"><span class="linenum"> 249</span></a>  
<a name="l250"><span class="linenum"> 250</span></a>          if (!empty(<a class="var it17339" onMouseOver="hilite(17339)" onMouseOut="lolite()" onClick="logVariable('dbproviders')" href="../_variables/dbproviders.html">$dbproviders</a>[<a class="var it17340" onMouseOver="hilite(17340)" onMouseOut="lolite()" onClick="logVariable('messagename')" href="../_variables/messagename.html">$messagename</a>])) {   // Already exists in the database
<a name="l251"><span class="linenum"> 251</span></a>  <span class="comment">            // check if capability has changed</span>
<a name="l252"><span class="linenum"> 252</span></a>              if (<a class="var it17339" onMouseOver="hilite(17339)" onMouseOut="lolite()" onClick="logVariable('dbproviders')" href="../_variables/dbproviders.html">$dbproviders</a>[<a class="var it17340" onMouseOver="hilite(17340)" onMouseOut="lolite()" onClick="logVariable('messagename')" href="../_variables/messagename.html">$messagename</a>]-&gt;capability == <a class="var it17341" onMouseOver="hilite(17341)" onMouseOut="lolite()" onClick="logVariable('fileprovider')" href="../_variables/fileprovider.html">$fileprovider</a>['capability']) {  // Same, so ignore
<a name="l253"><span class="linenum"> 253</span></a>  <span class="comment">                // exact same message provider already present in db, ignore this entry</span>
<a name="l254"><span class="linenum"> 254</span></a>                  unset(<a class="var it17339" onMouseOver="hilite(17339)" onMouseOut="lolite()" onClick="logVariable('dbproviders')" href="../_variables/dbproviders.html">$dbproviders</a>[<a class="var it17340" onMouseOver="hilite(17340)" onMouseOut="lolite()" onClick="logVariable('messagename')" href="../_variables/messagename.html">$messagename</a>]);
<a name="l255"><span class="linenum"> 255</span></a>                  continue;
<a name="l256"><span class="linenum"> 256</span></a>  
<a name="l257"><span class="linenum"> 257</span></a>              } else {                                // Update existing one
<a name="l258"><span class="linenum"> 258</span></a>                  <a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a> = new stdClass();
<a name="l259"><span class="linenum"> 259</span></a>                  <a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>-&gt;<a onClick="logVariable('id')" class="var it39611" onMouseOver="hilite(39611)" onMouseOut="lolite()" href="../_variables/id.html">id</a>         = <a class="var it17339" onMouseOver="hilite(17339)" onMouseOut="lolite()" onClick="logVariable('dbproviders')" href="../_variables/dbproviders.html">$dbproviders</a>[<a class="var it17340" onMouseOver="hilite(17340)" onMouseOut="lolite()" onClick="logVariable('messagename')" href="../_variables/messagename.html">$messagename</a>]-&gt;id;
<a name="l260"><span class="linenum"> 260</span></a>                  <a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>-&gt;<a onClick="logVariable('capability')" class="var it39611" onMouseOver="hilite(39611)" onMouseOut="lolite()" href="../_variables/capability.html">capability</a> = <a class="var it17341" onMouseOver="hilite(17341)" onMouseOut="lolite()" onClick="logVariable('fileprovider')" href="../_variables/fileprovider.html">$fileprovider</a>['capability'];
<a name="l261"><span class="linenum"> 261</span></a>                  <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('update_record')" href="../_functions/update_record.html" onMouseOver="funcPopup(event,'update_record')">update_record</a>('message_providers', <a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>);
<a name="l262"><span class="linenum"> 262</span></a>                  unset(<a class="var it17339" onMouseOver="hilite(17339)" onMouseOut="lolite()" onClick="logVariable('dbproviders')" href="../_variables/dbproviders.html">$dbproviders</a>[<a class="var it17340" onMouseOver="hilite(17340)" onMouseOut="lolite()" onClick="logVariable('messagename')" href="../_variables/messagename.html">$messagename</a>]);
<a name="l263"><span class="linenum"> 263</span></a>                  continue;
<a name="l264"><span class="linenum"> 264</span></a>              }
<a name="l265"><span class="linenum"> 265</span></a>  
<a name="l266"><span class="linenum"> 266</span></a>          } else {             // <span class="keyword">New </span><a class="class" onClick="logClass('message')" href="../_classes/message.html" onMouseOver="classPopup(event,'message')">message</a> provider, add it
<a name="l267"><span class="linenum"> 267</span></a>  
<a name="l268"><span class="linenum"> 268</span></a>              <a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a> = new stdClass();
<a name="l269"><span class="linenum"> 269</span></a>              <a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>-&gt;<a onClick="logVariable('name')" class="var it39611" onMouseOver="hilite(39611)" onMouseOut="lolite()" href="../_variables/name.html">name</a>       = <a class="var it17340" onMouseOver="hilite(17340)" onMouseOut="lolite()" onClick="logVariable('messagename')" href="../_variables/messagename.html">$messagename</a>;
<a name="l270"><span class="linenum"> 270</span></a>              <a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>-&gt;<a onClick="logVariable('component')" class="var it39611" onMouseOver="hilite(39611)" onMouseOut="lolite()" href="../_variables/component.html">component</a>  = <a class="var it547" onMouseOver="hilite(547)" onMouseOut="lolite()" onClick="logVariable('component')" href="../_variables/component.html">$component</a>;
<a name="l271"><span class="linenum"> 271</span></a>              <a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>-&gt;<a onClick="logVariable('capability')" class="var it39611" onMouseOver="hilite(39611)" onMouseOut="lolite()" href="../_variables/capability.html">capability</a> = <a class="var it17341" onMouseOver="hilite(17341)" onMouseOut="lolite()" onClick="logVariable('fileprovider')" href="../_variables/fileprovider.html">$fileprovider</a>['capability'];
<a name="l272"><span class="linenum"> 272</span></a>  
<a name="l273"><span class="linenum"> 273</span></a>              <a class="var it2929" onMouseOver="hilite(2929)" onMouseOut="lolite()" onClick="logVariable('transaction')" href="../_variables/transaction.html">$transaction</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('start_delegated_transaction')" href="../_functions/start_delegated_transaction.html" onMouseOver="funcPopup(event,'start_delegated_transaction')">start_delegated_transaction</a>();
<a name="l274"><span class="linenum"> 274</span></a>              <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('insert_record')" href="../_functions/insert_record.html" onMouseOver="funcPopup(event,'insert_record')">insert_record</a>('message_providers', <a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>);
<a name="l275"><span class="linenum"> 275</span></a>              <a class="function" onClick="logFunction('message_set_default_message_preference')" href="../_functions/message_set_default_message_preference.html" onMouseOver="funcPopup(event,'message_set_default_message_preference')">message_set_default_message_preference</a>(<a class="var it547" onMouseOver="hilite(547)" onMouseOut="lolite()" onClick="logVariable('component')" href="../_variables/component.html">$component</a>, <a class="var it17340" onMouseOver="hilite(17340)" onMouseOut="lolite()" onClick="logVariable('messagename')" href="../_variables/messagename.html">$messagename</a>, <a class="var it17341" onMouseOver="hilite(17341)" onMouseOut="lolite()" onClick="logVariable('fileprovider')" href="../_variables/fileprovider.html">$fileprovider</a>);
<a name="l276"><span class="linenum"> 276</span></a>              <a class="var it2929" onMouseOver="hilite(2929)" onMouseOut="lolite()" onClick="logVariable('transaction')" href="../_variables/transaction.html">$transaction</a>-&gt;<a class="function" onClick="logFunction('allow_commit')" href="../_functions/allow_commit.html" onMouseOver="funcPopup(event,'allow_commit')">allow_commit</a>();
<a name="l277"><span class="linenum"> 277</span></a>          }
<a name="l278"><span class="linenum"> 278</span></a>      }
<a name="l279"><span class="linenum"> 279</span></a>  
<a name="l280"><span class="linenum"> 280</span></a>      foreach (<a class="var it17339" onMouseOver="hilite(17339)" onMouseOut="lolite()" onClick="logVariable('dbproviders')" href="../_variables/dbproviders.html">$dbproviders</a> as <a class="var it17342" onMouseOver="hilite(17342)" onMouseOut="lolite()" onClick="logVariable('dbprovider')" href="../_variables/dbprovider.html">$dbprovider</a>) {  // Delete old ones
<a name="l281"><span class="linenum"> 281</span></a>          <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('delete_records')" href="../_functions/delete_records.html" onMouseOver="funcPopup(event,'delete_records')">delete_records</a>('message_providers', array('id' =&gt; <a class="var it17342" onMouseOver="hilite(17342)" onMouseOut="lolite()" onClick="logVariable('dbprovider')" href="../_variables/dbprovider.html">$dbprovider</a>-&gt;<a onClick="logVariable('id')" class="var it41058" onMouseOver="hilite(41058)" onMouseOut="lolite()" href="../_variables/id.html">id</a>));
<a name="l282"><span class="linenum"> 282</span></a>          <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('delete_records_select')" href="../_functions/delete_records_select.html" onMouseOver="funcPopup(event,'delete_records_select')">delete_records_select</a>('config_plugins', &quot;plugin = 'message' AND &quot;.<a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_like')" href="../_functions/sql_like.html" onMouseOver="funcPopup(event,'sql_like')">sql_like</a>('name', '?', false), array(&quot;%_provider_{<a class="var it547" onMouseOver="hilite(547)" onMouseOut="lolite()" onClick="logVariable('component')" href="../_variables/component.html">$component</a>}_{<a class="var it17342" onMouseOver="hilite(17342)" onMouseOut="lolite()" onClick="logVariable('dbprovider')" href="../_variables/dbprovider.html">$dbprovider</a>-&gt;<a onClick="logVariable('name')" class="var it41058" onMouseOver="hilite(41058)" onMouseOut="lolite()" href="../_variables/name.html">name</a>}_%&quot;));
<a name="l283"><span class="linenum"> 283</span></a>          <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('delete_records_select')" href="../_functions/delete_records_select.html" onMouseOver="funcPopup(event,'delete_records_select')">delete_records_select</a>('user_preferences', <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_like')" href="../_functions/sql_like.html" onMouseOver="funcPopup(event,'sql_like')">sql_like</a>('name', '?', false), array(&quot;message_provider_{<a class="var it547" onMouseOver="hilite(547)" onMouseOut="lolite()" onClick="logVariable('component')" href="../_variables/component.html">$component</a>}_{<a class="var it17342" onMouseOver="hilite(17342)" onMouseOut="lolite()" onClick="logVariable('dbprovider')" href="../_variables/dbprovider.html">$dbprovider</a>-&gt;<a onClick="logVariable('name')" class="var it41058" onMouseOver="hilite(41058)" onMouseOut="lolite()" href="../_variables/name.html">name</a>}_%&quot;));
<a name="l284"><span class="linenum"> 284</span></a>          <a class="class" onClick="logClass('cache_helper')" href="../_classes/cache_helper.html" onMouseOver="classPopup(event,'cache_helper')">cache_helper</a>::<a class="function" onClick="logFunction('invalidate_by_definition')" href="../_functions/invalidate_by_definition.html" onMouseOver="funcPopup(event,'invalidate_by_definition')">invalidate_by_definition</a>('core', 'config', array(), 'message');
<a name="l285"><span class="linenum"> 285</span></a>      }
<a name="l286"><span class="linenum"> 286</span></a>  
<a name="l287"><span class="linenum"> 287</span></a>      return true;
<a name="l288"><span class="linenum"> 288</span></a>  }
<a name="l289"><span class="linenum"> 289</span></a>  
<a name="l290"><span class="linenum"> 290</span></a>  <span class="comment">/**</span>
<a name="l291"><span class="linenum"> 291</span></a>  <span class="comment"> * This function populates default message preferences for all existing providers</span>
<a name="l292"><span class="linenum"> 292</span></a>  <span class="comment"> * when the new message processor is added.</span>
<a name="l293"><span class="linenum"> 293</span></a>  <span class="comment"> *</span>
<a name="l294"><span class="linenum"> 294</span></a>  <span class="comment"> * @param string $processorname The name of message processor plugin (e.g. 'email', 'jabber')</span>
<a name="l295"><span class="linenum"> 295</span></a>  <span class="comment"> * @throws invalid_parameter_exception if $processorname does not exist in the database</span>
<a name="l296"><span class="linenum"> 296</span></a>  <span class="comment"> */</span>
<a name="l297"><span class="linenum"> 297</span></a>  function <a class="function" onClick="logFunction('message_update_processors')" href="../_functions/message_update_processors.html" onMouseOver="funcPopup(event,'message_update_processors')">message_update_processors</a>(<a class="var it17343" onMouseOver="hilite(17343)" onMouseOut="lolite()" onClick="logVariable('processorname')" href="../_variables/processorname.html">$processorname</a>) {
<a name="l298"><span class="linenum"> 298</span></a>      global <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>;
<a name="l299"><span class="linenum"> 299</span></a>  
<a name="l300"><span class="linenum"> 300</span></a>  <span class="comment">    // validate if our processor exists</span>
<a name="l301"><span class="linenum"> 301</span></a>      <a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records')" href="../_functions/get_records.html" onMouseOver="funcPopup(event,'get_records')">get_records</a>('message_processors', array('name' =&gt; <a class="var it17343" onMouseOver="hilite(17343)" onMouseOut="lolite()" onClick="logVariable('processorname')" href="../_variables/processorname.html">$processorname</a>));
<a name="l302"><span class="linenum"> 302</span></a>      if (empty(<a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a>)) {
<a name="l303"><span class="linenum"> 303</span></a>          throw <span class="keyword">new </span><a class="class" onClick="logClass('invalid_parameter_exception')" href="../_classes/invalid_parameter_exception.html" onMouseOver="classPopup(event,'invalid_parameter_exception')">invalid_parameter_exception</a>();
<a name="l304"><span class="linenum"> 304</span></a>      }
<a name="l305"><span class="linenum"> 305</span></a>  
<a name="l306"><span class="linenum"> 306</span></a>      <a class="var it17344" onMouseOver="hilite(17344)" onMouseOut="lolite()" onClick="logVariable('providers')" href="../_variables/providers.html">$providers</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records_sql')" href="../_functions/get_records_sql.html" onMouseOver="funcPopup(event,'get_records_sql')">get_records_sql</a>('SELECT DISTINCT component FROM {message_providers}');
<a name="l307"><span class="linenum"> 307</span></a>  
<a name="l308"><span class="linenum"> 308</span></a>      <a class="var it2929" onMouseOver="hilite(2929)" onMouseOut="lolite()" onClick="logVariable('transaction')" href="../_variables/transaction.html">$transaction</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('start_delegated_transaction')" href="../_functions/start_delegated_transaction.html" onMouseOver="funcPopup(event,'start_delegated_transaction')">start_delegated_transaction</a>();
<a name="l309"><span class="linenum"> 309</span></a>      foreach (<a class="var it17344" onMouseOver="hilite(17344)" onMouseOut="lolite()" onClick="logVariable('providers')" href="../_variables/providers.html">$providers</a> as <a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>) {
<a name="l310"><span class="linenum"> 310</span></a>  <span class="comment">        // load message providers from files</span>
<a name="l311"><span class="linenum"> 311</span></a>          <a class="var it17338" onMouseOver="hilite(17338)" onMouseOut="lolite()" onClick="logVariable('fileproviders')" href="../_variables/fileproviders.html">$fileproviders</a> = <a class="function" onClick="logFunction('message_get_providers_from_file')" href="../_functions/message_get_providers_from_file.html" onMouseOver="funcPopup(event,'message_get_providers_from_file')">message_get_providers_from_file</a>(<a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>-&gt;<a onClick="logVariable('component')" class="var it39611" onMouseOver="hilite(39611)" onMouseOut="lolite()" href="../_variables/component.html">component</a>);
<a name="l312"><span class="linenum"> 312</span></a>          foreach (<a class="var it17338" onMouseOver="hilite(17338)" onMouseOut="lolite()" onClick="logVariable('fileproviders')" href="../_variables/fileproviders.html">$fileproviders</a> as <a class="var it17340" onMouseOver="hilite(17340)" onMouseOut="lolite()" onClick="logVariable('messagename')" href="../_variables/messagename.html">$messagename</a> =&gt; <a class="var it17341" onMouseOver="hilite(17341)" onMouseOut="lolite()" onClick="logVariable('fileprovider')" href="../_variables/fileprovider.html">$fileprovider</a>) {
<a name="l313"><span class="linenum"> 313</span></a>              <a class="function" onClick="logFunction('message_set_default_message_preference')" href="../_functions/message_set_default_message_preference.html" onMouseOver="funcPopup(event,'message_set_default_message_preference')">message_set_default_message_preference</a>(<a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>-&gt;<a onClick="logVariable('component')" class="var it39611" onMouseOver="hilite(39611)" onMouseOut="lolite()" href="../_variables/component.html">component</a>, <a class="var it17340" onMouseOver="hilite(17340)" onMouseOut="lolite()" onClick="logVariable('messagename')" href="../_variables/messagename.html">$messagename</a>, <a class="var it17341" onMouseOver="hilite(17341)" onMouseOut="lolite()" onClick="logVariable('fileprovider')" href="../_variables/fileprovider.html">$fileprovider</a>, <a class="var it17343" onMouseOver="hilite(17343)" onMouseOut="lolite()" onClick="logVariable('processorname')" href="../_variables/processorname.html">$processorname</a>);
<a name="l314"><span class="linenum"> 314</span></a>          }
<a name="l315"><span class="linenum"> 315</span></a>      }
<a name="l316"><span class="linenum"> 316</span></a>      <a class="var it2929" onMouseOver="hilite(2929)" onMouseOut="lolite()" onClick="logVariable('transaction')" href="../_variables/transaction.html">$transaction</a>-&gt;<a class="function" onClick="logFunction('allow_commit')" href="../_functions/allow_commit.html" onMouseOver="funcPopup(event,'allow_commit')">allow_commit</a>();
<a name="l317"><span class="linenum"> 317</span></a>  }
<a name="l318"><span class="linenum"> 318</span></a>  
<a name="l319"><span class="linenum"> 319</span></a>  <span class="comment">/**</span>
<a name="l320"><span class="linenum"> 320</span></a>  <span class="comment"> * Setting default messaging preferences for particular message provider</span>
<a name="l321"><span class="linenum"> 321</span></a>  <span class="comment"> *</span>
<a name="l322"><span class="linenum"> 322</span></a>  <span class="comment"> * @param  string $component   The name of component (e.g. moodle, mod_forum, etc.)</span>
<a name="l323"><span class="linenum"> 323</span></a>  <span class="comment"> * @param  string $messagename The name of message provider</span>
<a name="l324"><span class="linenum"> 324</span></a>  <span class="comment"> * @param  array  $fileprovider The value of $messagename key in the array defined in plugin messages.php</span>
<a name="l325"><span class="linenum"> 325</span></a>  <span class="comment"> * @param  string $processorname The optional name of message processor</span>
<a name="l326"><span class="linenum"> 326</span></a>  <span class="comment"> */</span>
<a name="l327"><span class="linenum"> 327</span></a>  function <a class="function" onClick="logFunction('message_set_default_message_preference')" href="../_functions/message_set_default_message_preference.html" onMouseOver="funcPopup(event,'message_set_default_message_preference')">message_set_default_message_preference</a>(<a class="var it547" onMouseOver="hilite(547)" onMouseOut="lolite()" onClick="logVariable('component')" href="../_variables/component.html">$component</a>, <a class="var it17340" onMouseOver="hilite(17340)" onMouseOut="lolite()" onClick="logVariable('messagename')" href="../_variables/messagename.html">$messagename</a>, <a class="var it17341" onMouseOver="hilite(17341)" onMouseOut="lolite()" onClick="logVariable('fileprovider')" href="../_variables/fileprovider.html">$fileprovider</a>, <a class="var it17343" onMouseOver="hilite(17343)" onMouseOut="lolite()" onClick="logVariable('processorname')" href="../_variables/processorname.html">$processorname</a>='') {
<a name="l328"><span class="linenum"> 328</span></a>      global <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>;
<a name="l329"><span class="linenum"> 329</span></a>  
<a name="l330"><span class="linenum"> 330</span></a>  <span class="comment">    // Fetch message processors</span>
<a name="l331"><span class="linenum"> 331</span></a>      <a class="var it5142" onMouseOver="hilite(5142)" onMouseOut="lolite()" onClick="logVariable('condition')" href="../_variables/condition.html">$condition</a> = null;
<a name="l332"><span class="linenum"> 332</span></a>  <span class="comment">    // If we need to process a particular processor, set the select condition</span>
<a name="l333"><span class="linenum"> 333</span></a>      if (!empty(<a class="var it17343" onMouseOver="hilite(17343)" onMouseOut="lolite()" onClick="logVariable('processorname')" href="../_variables/processorname.html">$processorname</a>)) {
<a name="l334"><span class="linenum"> 334</span></a>         <a class="var it5142" onMouseOver="hilite(5142)" onMouseOut="lolite()" onClick="logVariable('condition')" href="../_variables/condition.html">$condition</a> = array('name' =&gt; <a class="var it17343" onMouseOver="hilite(17343)" onMouseOut="lolite()" onClick="logVariable('processorname')" href="../_variables/processorname.html">$processorname</a>);
<a name="l335"><span class="linenum"> 335</span></a>      }
<a name="l336"><span class="linenum"> 336</span></a>      <a class="var it17330" onMouseOver="hilite(17330)" onMouseOut="lolite()" onClick="logVariable('processors')" href="../_variables/processors.html">$processors</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records')" href="../_functions/get_records.html" onMouseOver="funcPopup(event,'get_records')">get_records</a>('message_processors', <a class="var it5142" onMouseOver="hilite(5142)" onMouseOut="lolite()" onClick="logVariable('condition')" href="../_variables/condition.html">$condition</a>);
<a name="l337"><span class="linenum"> 337</span></a>  
<a name="l338"><span class="linenum"> 338</span></a>  <span class="comment">    // load default messaging preferences</span>
<a name="l339"><span class="linenum"> 339</span></a>      <a class="var it17320" onMouseOver="hilite(17320)" onMouseOut="lolite()" onClick="logVariable('defaultpreferences')" href="../_variables/defaultpreferences.html">$defaultpreferences</a> = <a class="function" onClick="logFunction('get_message_output_default_preferences')" href="../_functions/get_message_output_default_preferences.html" onMouseOver="funcPopup(event,'get_message_output_default_preferences')">get_message_output_default_preferences</a>();
<a name="l340"><span class="linenum"> 340</span></a>  
<a name="l341"><span class="linenum"> 341</span></a>  <span class="comment">    // Setting default preference</span>
<a name="l342"><span class="linenum"> 342</span></a>      <a class="var it17345" onMouseOver="hilite(17345)" onMouseOut="lolite()" onClick="logVariable('componentproviderbase')" href="../_variables/componentproviderbase.html">$componentproviderbase</a> = <a class="var it547" onMouseOver="hilite(547)" onMouseOut="lolite()" onClick="logVariable('component')" href="../_variables/component.html">$component</a>.'_'.<a class="var it17340" onMouseOver="hilite(17340)" onMouseOut="lolite()" onClick="logVariable('messagename')" href="../_variables/messagename.html">$messagename</a>;
<a name="l343"><span class="linenum"> 343</span></a>      <a class="var it17346" onMouseOver="hilite(17346)" onMouseOut="lolite()" onClick="logVariable('loggedinpref')" href="../_variables/loggedinpref.html">$loggedinpref</a> = array();
<a name="l344"><span class="linenum"> 344</span></a>      <a class="var it17347" onMouseOver="hilite(17347)" onMouseOut="lolite()" onClick="logVariable('loggedoffpref')" href="../_variables/loggedoffpref.html">$loggedoffpref</a> = array();
<a name="l345"><span class="linenum"> 345</span></a>  <span class="comment">    // set 'permitted' preference first for each messaging processor</span>
<a name="l346"><span class="linenum"> 346</span></a>      foreach (<a class="var it17330" onMouseOver="hilite(17330)" onMouseOut="lolite()" onClick="logVariable('processors')" href="../_variables/processors.html">$processors</a> as <a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a>) {
<a name="l347"><span class="linenum"> 347</span></a>          <a class="var it17348" onMouseOver="hilite(17348)" onMouseOut="lolite()" onClick="logVariable('preferencename')" href="../_variables/preferencename.html">$preferencename</a> = <a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a>-&gt;<a onClick="logVariable('name')" class="var it40115" onMouseOver="hilite(40115)" onMouseOut="lolite()" href="../_variables/name.html">name</a>.'_provider_'.<a class="var it17345" onMouseOver="hilite(17345)" onMouseOut="lolite()" onClick="logVariable('componentproviderbase')" href="../_variables/componentproviderbase.html">$componentproviderbase</a>.'_permitted';
<a name="l348"><span class="linenum"> 348</span></a>  <span class="comment">        // if we do not have this setting yet, set it</span>
<a name="l349"><span class="linenum"> 349</span></a>          if (!isset(<a class="var it17320" onMouseOver="hilite(17320)" onMouseOut="lolite()" onClick="logVariable('defaultpreferences')" href="../_variables/defaultpreferences.html">$defaultpreferences</a>-&gt;{<a class="var it17348" onMouseOver="hilite(17348)" onMouseOut="lolite()" onClick="logVariable('preferencename')" href="../_variables/preferencename.html">$preferencename</a>})) {
<a name="l350"><span class="linenum"> 350</span></a>  <span class="comment">            // determine plugin default settings</span>
<a name="l351"><span class="linenum"> 351</span></a>              <a class="var it17349" onMouseOver="hilite(17349)" onMouseOut="lolite()" onClick="logVariable('plugindefault')" href="../_variables/plugindefault.html">$plugindefault</a> = 0;
<a name="l352"><span class="linenum"> 352</span></a>              if (isset(<a class="var it17341" onMouseOver="hilite(17341)" onMouseOut="lolite()" onClick="logVariable('fileprovider')" href="../_variables/fileprovider.html">$fileprovider</a>['defaults'][<a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a>-&gt;<a onClick="logVariable('name')" class="var it40115" onMouseOver="hilite(40115)" onMouseOut="lolite()" href="../_variables/name.html">name</a>])) {
<a name="l353"><span class="linenum"> 353</span></a>                  <a class="var it17349" onMouseOver="hilite(17349)" onMouseOut="lolite()" onClick="logVariable('plugindefault')" href="../_variables/plugindefault.html">$plugindefault</a> = <a class="var it17341" onMouseOver="hilite(17341)" onMouseOut="lolite()" onClick="logVariable('fileprovider')" href="../_variables/fileprovider.html">$fileprovider</a>['defaults'][<a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a>-&gt;<a onClick="logVariable('name')" class="var it40115" onMouseOver="hilite(40115)" onMouseOut="lolite()" href="../_variables/name.html">name</a>];
<a name="l354"><span class="linenum"> 354</span></a>              }
<a name="l355"><span class="linenum"> 355</span></a>  <span class="comment">            // get string values of the settings</span>
<a name="l356"><span class="linenum"> 356</span></a>              <a class="function" onClick="logFunction('list')" href="../_functions/list.html" onMouseOver="funcPopup(event,'list')">list</a>(<a class="var it17333" onMouseOver="hilite(17333)" onMouseOut="lolite()" onClick="logVariable('permitted')" href="../_variables/permitted.html">$permitted</a>, <a class="var it11930" onMouseOver="hilite(11930)" onMouseOut="lolite()" onClick="logVariable('loggedin')" href="../_variables/loggedin.html">$loggedin</a>, <a class="var it17350" onMouseOver="hilite(17350)" onMouseOut="lolite()" onClick="logVariable('loggedoff')" href="../_variables/loggedoff.html">$loggedoff</a>) = <a class="function" onClick="logFunction('translate_message_default_setting')" href="../_functions/translate_message_default_setting.html" onMouseOver="funcPopup(event,'translate_message_default_setting')">translate_message_default_setting</a>(<a class="var it17349" onMouseOver="hilite(17349)" onMouseOut="lolite()" onClick="logVariable('plugindefault')" href="../_variables/plugindefault.html">$plugindefault</a>, <a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a>-&gt;<a onClick="logVariable('name')" class="var it40115" onMouseOver="hilite(40115)" onMouseOut="lolite()" href="../_variables/name.html">name</a>);
<a name="l357"><span class="linenum"> 357</span></a>  <span class="comment">            // store default preferences for current processor</span>
<a name="l358"><span class="linenum"> 358</span></a>              <a class="function" onClick="logFunction('set_config')" href="../_functions/set_config.html" onMouseOver="funcPopup(event,'set_config')">set_config</a>(<a class="var it17348" onMouseOver="hilite(17348)" onMouseOut="lolite()" onClick="logVariable('preferencename')" href="../_variables/preferencename.html">$preferencename</a>, <a class="var it17333" onMouseOver="hilite(17333)" onMouseOut="lolite()" onClick="logVariable('permitted')" href="../_variables/permitted.html">$permitted</a>, 'message');
<a name="l359"><span class="linenum"> 359</span></a>  <span class="comment">            // save loggedin/loggedoff settings</span>
<a name="l360"><span class="linenum"> 360</span></a>              if (<a class="var it11930" onMouseOver="hilite(11930)" onMouseOut="lolite()" onClick="logVariable('loggedin')" href="../_variables/loggedin.html">$loggedin</a>) {
<a name="l361"><span class="linenum"> 361</span></a>                  <a class="var it17346" onMouseOver="hilite(17346)" onMouseOut="lolite()" onClick="logVariable('loggedinpref')" href="../_variables/loggedinpref.html">$loggedinpref</a>[] = <a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a>-&gt;<a onClick="logVariable('name')" class="var it40115" onMouseOver="hilite(40115)" onMouseOut="lolite()" href="../_variables/name.html">name</a>;
<a name="l362"><span class="linenum"> 362</span></a>              }
<a name="l363"><span class="linenum"> 363</span></a>              if (<a class="var it17350" onMouseOver="hilite(17350)" onMouseOut="lolite()" onClick="logVariable('loggedoff')" href="../_variables/loggedoff.html">$loggedoff</a>) {
<a name="l364"><span class="linenum"> 364</span></a>                  <a class="var it17347" onMouseOver="hilite(17347)" onMouseOut="lolite()" onClick="logVariable('loggedoffpref')" href="../_variables/loggedoffpref.html">$loggedoffpref</a>[] = <a class="var it7620" onMouseOver="hilite(7620)" onMouseOut="lolite()" onClick="logVariable('processor')" href="../_variables/processor.html">$processor</a>-&gt;<a onClick="logVariable('name')" class="var it40115" onMouseOver="hilite(40115)" onMouseOut="lolite()" href="../_variables/name.html">name</a>;
<a name="l365"><span class="linenum"> 365</span></a>              }
<a name="l366"><span class="linenum"> 366</span></a>          }
<a name="l367"><span class="linenum"> 367</span></a>      }
<a name="l368"><span class="linenum"> 368</span></a>  <span class="comment">    // now set loggedin/loggedoff preferences</span>
<a name="l369"><span class="linenum"> 369</span></a>      if (!empty(<a class="var it17346" onMouseOver="hilite(17346)" onMouseOut="lolite()" onClick="logVariable('loggedinpref')" href="../_variables/loggedinpref.html">$loggedinpref</a>)) {
<a name="l370"><span class="linenum"> 370</span></a>          <a class="var it17348" onMouseOver="hilite(17348)" onMouseOut="lolite()" onClick="logVariable('preferencename')" href="../_variables/preferencename.html">$preferencename</a> = 'message_provider_'.<a class="var it17345" onMouseOver="hilite(17345)" onMouseOut="lolite()" onClick="logVariable('componentproviderbase')" href="../_variables/componentproviderbase.html">$componentproviderbase</a>.'_loggedin';
<a name="l371"><span class="linenum"> 371</span></a>          if (isset(<a class="var it17320" onMouseOver="hilite(17320)" onMouseOut="lolite()" onClick="logVariable('defaultpreferences')" href="../_variables/defaultpreferences.html">$defaultpreferences</a>-&gt;{<a class="var it17348" onMouseOver="hilite(17348)" onMouseOut="lolite()" onClick="logVariable('preferencename')" href="../_variables/preferencename.html">$preferencename</a>})) {
<a name="l372"><span class="linenum"> 372</span></a>  <span class="comment">            // We have the default preferences for this message provider, which</span>
<a name="l373"><span class="linenum"> 373</span></a>  <span class="comment">            // likely means that we have been adding a new processor. Add defaults</span>
<a name="l374"><span class="linenum"> 374</span></a>  <span class="comment">            // to exisitng preferences.</span>
<a name="l375"><span class="linenum"> 375</span></a>              <a class="var it17346" onMouseOver="hilite(17346)" onMouseOut="lolite()" onClick="logVariable('loggedinpref')" href="../_variables/loggedinpref.html">$loggedinpref</a> = <a class="phpfunction" onClick="logFunction('array_merge')" href="../_functions/array_merge.html" onMouseOver="phpfuncPopup(event,'array_merge')">array_merge</a>(<a class="var it17346" onMouseOver="hilite(17346)" onMouseOut="lolite()" onClick="logVariable('loggedinpref')" href="../_variables/loggedinpref.html">$loggedinpref</a>, <a class="phpfunction" onClick="logFunction('explode')" href="../_functions/explode.html" onMouseOver="phpfuncPopup(event,'explode')">explode</a>(',', <a class="var it17320" onMouseOver="hilite(17320)" onMouseOut="lolite()" onClick="logVariable('defaultpreferences')" href="../_variables/defaultpreferences.html">$defaultpreferences</a>-&gt;{<a class="var it17348" onMouseOver="hilite(17348)" onMouseOut="lolite()" onClick="logVariable('preferencename')" href="../_variables/preferencename.html">$preferencename</a>}));
<a name="l376"><span class="linenum"> 376</span></a>          }
<a name="l377"><span class="linenum"> 377</span></a>          <a class="function" onClick="logFunction('set_config')" href="../_functions/set_config.html" onMouseOver="funcPopup(event,'set_config')">set_config</a>(<a class="var it17348" onMouseOver="hilite(17348)" onMouseOut="lolite()" onClick="logVariable('preferencename')" href="../_variables/preferencename.html">$preferencename</a>, <a class="function" onClick="logFunction('join')" href="../_functions/join.html" onMouseOver="funcPopup(event,'join')">join</a>(',', <a class="var it17346" onMouseOver="hilite(17346)" onMouseOut="lolite()" onClick="logVariable('loggedinpref')" href="../_variables/loggedinpref.html">$loggedinpref</a>), 'message');
<a name="l378"><span class="linenum"> 378</span></a>      }
<a name="l379"><span class="linenum"> 379</span></a>      if (!empty(<a class="var it17347" onMouseOver="hilite(17347)" onMouseOut="lolite()" onClick="logVariable('loggedoffpref')" href="../_variables/loggedoffpref.html">$loggedoffpref</a>)) {
<a name="l380"><span class="linenum"> 380</span></a>          <a class="var it17348" onMouseOver="hilite(17348)" onMouseOut="lolite()" onClick="logVariable('preferencename')" href="../_variables/preferencename.html">$preferencename</a> = 'message_provider_'.<a class="var it17345" onMouseOver="hilite(17345)" onMouseOut="lolite()" onClick="logVariable('componentproviderbase')" href="../_variables/componentproviderbase.html">$componentproviderbase</a>.'_loggedoff';
<a name="l381"><span class="linenum"> 381</span></a>          if (isset(<a class="var it17320" onMouseOver="hilite(17320)" onMouseOut="lolite()" onClick="logVariable('defaultpreferences')" href="../_variables/defaultpreferences.html">$defaultpreferences</a>-&gt;{<a class="var it17348" onMouseOver="hilite(17348)" onMouseOut="lolite()" onClick="logVariable('preferencename')" href="../_variables/preferencename.html">$preferencename</a>})) {
<a name="l382"><span class="linenum"> 382</span></a>  <span class="comment">            // We have the default preferences for this message provider, which</span>
<a name="l383"><span class="linenum"> 383</span></a>  <span class="comment">            // likely means that we have been adding a new processor. Add defaults</span>
<a name="l384"><span class="linenum"> 384</span></a>  <span class="comment">            // to exisitng preferences.</span>
<a name="l385"><span class="linenum"> 385</span></a>              <a class="var it17347" onMouseOver="hilite(17347)" onMouseOut="lolite()" onClick="logVariable('loggedoffpref')" href="../_variables/loggedoffpref.html">$loggedoffpref</a> = <a class="phpfunction" onClick="logFunction('array_merge')" href="../_functions/array_merge.html" onMouseOver="phpfuncPopup(event,'array_merge')">array_merge</a>(<a class="var it17347" onMouseOver="hilite(17347)" onMouseOut="lolite()" onClick="logVariable('loggedoffpref')" href="../_variables/loggedoffpref.html">$loggedoffpref</a>, <a class="phpfunction" onClick="logFunction('explode')" href="../_functions/explode.html" onMouseOver="phpfuncPopup(event,'explode')">explode</a>(',', <a class="var it17320" onMouseOver="hilite(17320)" onMouseOut="lolite()" onClick="logVariable('defaultpreferences')" href="../_variables/defaultpreferences.html">$defaultpreferences</a>-&gt;{<a class="var it17348" onMouseOver="hilite(17348)" onMouseOut="lolite()" onClick="logVariable('preferencename')" href="../_variables/preferencename.html">$preferencename</a>}));
<a name="l386"><span class="linenum"> 386</span></a>          }
<a name="l387"><span class="linenum"> 387</span></a>          <a class="function" onClick="logFunction('set_config')" href="../_functions/set_config.html" onMouseOver="funcPopup(event,'set_config')">set_config</a>(<a class="var it17348" onMouseOver="hilite(17348)" onMouseOut="lolite()" onClick="logVariable('preferencename')" href="../_variables/preferencename.html">$preferencename</a>, <a class="function" onClick="logFunction('join')" href="../_functions/join.html" onMouseOver="funcPopup(event,'join')">join</a>(',', <a class="var it17347" onMouseOver="hilite(17347)" onMouseOut="lolite()" onClick="logVariable('loggedoffpref')" href="../_variables/loggedoffpref.html">$loggedoffpref</a>), 'message');
<a name="l388"><span class="linenum"> 388</span></a>      }
<a name="l389"><span class="linenum"> 389</span></a>  }
<a name="l390"><span class="linenum"> 390</span></a>  
<a name="l391"><span class="linenum"> 391</span></a>  <span class="comment">/**</span>
<a name="l392"><span class="linenum"> 392</span></a>  <span class="comment"> * Returns the active providers for the user specified, based on capability</span>
<a name="l393"><span class="linenum"> 393</span></a>  <span class="comment"> *</span>
<a name="l394"><span class="linenum"> 394</span></a>  <span class="comment"> * @param int $userid id of user</span>
<a name="l395"><span class="linenum"> 395</span></a>  <span class="comment"> * @return array An array of message providers</span>
<a name="l396"><span class="linenum"> 396</span></a>  <span class="comment"> */</span>
<a name="l397"><span class="linenum"> 397</span></a>  function <a class="function" onClick="logFunction('message_get_providers_for_user')" href="../_functions/message_get_providers_for_user.html" onMouseOver="funcPopup(event,'message_get_providers_for_user')">message_get_providers_for_user</a>(<a class="var it182" onMouseOver="hilite(182)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../_variables/userid.html">$userid</a>) {
<a name="l398"><span class="linenum"> 398</span></a>      global <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>, <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../_variables/CFG.html">$CFG</a>;
<a name="l399"><span class="linenum"> 399</span></a>  
<a name="l400"><span class="linenum"> 400</span></a>      <a class="var it17344" onMouseOver="hilite(17344)" onMouseOut="lolite()" onClick="logVariable('providers')" href="../_variables/providers.html">$providers</a> = <a class="function" onClick="logFunction('get_message_providers')" href="../_functions/get_message_providers.html" onMouseOver="funcPopup(event,'get_message_providers')">get_message_providers</a>();
<a name="l401"><span class="linenum"> 401</span></a>  
<a name="l402"><span class="linenum"> 402</span></a>  <span class="comment">    // Ensure user is not allowed to configure instantmessage if it is globally disabled.</span>
<a name="l403"><span class="linenum"> 403</span></a>      if (!<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('messaging')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../_variables/messaging.html">messaging</a>) {
<a name="l404"><span class="linenum"> 404</span></a>          foreach (<a class="var it17344" onMouseOver="hilite(17344)" onMouseOut="lolite()" onClick="logVariable('providers')" href="../_variables/providers.html">$providers</a> as <a class="var it17351" onMouseOver="hilite(17351)" onMouseOut="lolite()" onClick="logVariable('providerid')" href="../_variables/providerid.html">$providerid</a> =&gt; <a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>) {
<a name="l405"><span class="linenum"> 405</span></a>              if (<a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>-&gt;<a onClick="logVariable('name')" class="var it39611" onMouseOver="hilite(39611)" onMouseOut="lolite()" href="../_variables/name.html">name</a> == 'instantmessage') {
<a name="l406"><span class="linenum"> 406</span></a>                  unset(<a class="var it17344" onMouseOver="hilite(17344)" onMouseOut="lolite()" onClick="logVariable('providers')" href="../_variables/providers.html">$providers</a>[<a class="var it17351" onMouseOver="hilite(17351)" onMouseOut="lolite()" onClick="logVariable('providerid')" href="../_variables/providerid.html">$providerid</a>]);
<a name="l407"><span class="linenum"> 407</span></a>                  break;
<a name="l408"><span class="linenum"> 408</span></a>              }
<a name="l409"><span class="linenum"> 409</span></a>          }
<a name="l410"><span class="linenum"> 410</span></a>      }
<a name="l411"><span class="linenum"> 411</span></a>  
<a name="l412"><span class="linenum"> 412</span></a>  <span class="comment">    // If the component is an enrolment plugin, check it is enabled</span>
<a name="l413"><span class="linenum"> 413</span></a>      foreach (<a class="var it17344" onMouseOver="hilite(17344)" onMouseOut="lolite()" onClick="logVariable('providers')" href="../_variables/providers.html">$providers</a> as <a class="var it17351" onMouseOver="hilite(17351)" onMouseOut="lolite()" onClick="logVariable('providerid')" href="../_variables/providerid.html">$providerid</a> =&gt; <a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>) {
<a name="l414"><span class="linenum"> 414</span></a>          <a class="function" onClick="logFunction('list')" href="../_functions/list.html" onMouseOver="funcPopup(event,'list')">list</a>(<a class="var it494" onMouseOver="hilite(494)" onMouseOut="lolite()" onClick="logVariable('type')" href="../_variables/type.html">$type</a>, <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('name')" href="../_variables/name.html">$name</a>) = <a class="class" onClick="logClass('core_component')" href="../_classes/core_component.html" onMouseOver="classPopup(event,'core_component')">core_component</a>::<a class="function" onClick="logFunction('normalize_component')" href="../_functions/normalize_component.html" onMouseOver="funcPopup(event,'normalize_component')">normalize_component</a>(<a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>-&gt;<a onClick="logVariable('component')" class="var it39611" onMouseOver="hilite(39611)" onMouseOut="lolite()" href="../_variables/component.html">component</a>);
<a name="l415"><span class="linenum"> 415</span></a>          if (<a class="var it494" onMouseOver="hilite(494)" onMouseOut="lolite()" onClick="logVariable('type')" href="../_variables/type.html">$type</a> == 'enrol' &amp;&amp; !<a class="function" onClick="logFunction('enrol_is_enabled')" href="../_functions/enrol_is_enabled.html" onMouseOver="funcPopup(event,'enrol_is_enabled')">enrol_is_enabled</a>(<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('name')" href="../_variables/name.html">$name</a>)) {
<a name="l416"><span class="linenum"> 416</span></a>              unset(<a class="var it17344" onMouseOver="hilite(17344)" onMouseOut="lolite()" onClick="logVariable('providers')" href="../_variables/providers.html">$providers</a>[<a class="var it17351" onMouseOver="hilite(17351)" onMouseOut="lolite()" onClick="logVariable('providerid')" href="../_variables/providerid.html">$providerid</a>]);
<a name="l417"><span class="linenum"> 417</span></a>          }
<a name="l418"><span class="linenum"> 418</span></a>      }
<a name="l419"><span class="linenum"> 419</span></a>  
<a name="l420"><span class="linenum"> 420</span></a>  <span class="comment">    // Now we need to check capabilities. We need to eliminate the providers</span>
<a name="l421"><span class="linenum"> 421</span></a>  <span class="comment">    // where the user does not have the corresponding capability anywhere.</span>
<a name="l422"><span class="linenum"> 422</span></a>  <span class="comment">    // Here we deal with the common simple case of the user having the</span>
<a name="l423"><span class="linenum"> 423</span></a>  <span class="comment">    // capability in the system context. That handles $CFG-&gt;defaultuserroleid.</span>
<a name="l424"><span class="linenum"> 424</span></a>  <span class="comment">    // For the remaining providers/capabilities, we need to do a more complex</span>
<a name="l425"><span class="linenum"> 425</span></a>  <span class="comment">    // query involving all overrides everywhere.</span>
<a name="l426"><span class="linenum"> 426</span></a>      <a class="var it17352" onMouseOver="hilite(17352)" onMouseOut="lolite()" onClick="logVariable('unsureproviders')" href="../_variables/unsureproviders.html">$unsureproviders</a> = array();
<a name="l427"><span class="linenum"> 427</span></a>      <a class="var it17353" onMouseOver="hilite(17353)" onMouseOut="lolite()" onClick="logVariable('unsurecapabilities')" href="../_variables/unsurecapabilities.html">$unsurecapabilities</a> = array();
<a name="l428"><span class="linenum"> 428</span></a>      <a class="var it17" onMouseOver="hilite(17)" onMouseOut="lolite()" onClick="logVariable('systemcontext')" href="../_variables/systemcontext.html">$systemcontext</a> = <a class="class" onClick="logClass('context_system')" href="../_classes/context_system.html" onMouseOver="classPopup(event,'context_system')">context_system</a>::<a class="function" onClick="logFunction('instance')" href="../_functions/instance.html" onMouseOver="funcPopup(event,'instance')">instance</a>();
<a name="l429"><span class="linenum"> 429</span></a>      foreach (<a class="var it17344" onMouseOver="hilite(17344)" onMouseOut="lolite()" onClick="logVariable('providers')" href="../_variables/providers.html">$providers</a> as <a class="var it17351" onMouseOver="hilite(17351)" onMouseOut="lolite()" onClick="logVariable('providerid')" href="../_variables/providerid.html">$providerid</a> =&gt; <a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>) {
<a name="l430"><span class="linenum"> 430</span></a>          if (empty(<a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>-&gt;<a onClick="logVariable('capability')" class="var it39611" onMouseOver="hilite(39611)" onMouseOut="lolite()" href="../_variables/capability.html">capability</a>) || <a class="function" onClick="logFunction('has_capability')" href="../_functions/has_capability.html" onMouseOver="funcPopup(event,'has_capability')">has_capability</a>(<a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>-&gt;<a onClick="logVariable('capability')" class="var it39611" onMouseOver="hilite(39611)" onMouseOut="lolite()" href="../_variables/capability.html">capability</a>, <a class="var it17" onMouseOver="hilite(17)" onMouseOut="lolite()" onClick="logVariable('systemcontext')" href="../_variables/systemcontext.html">$systemcontext</a>, <a class="var it182" onMouseOver="hilite(182)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../_variables/userid.html">$userid</a>)) {
<a name="l431"><span class="linenum"> 431</span></a>  <span class="comment">            // The provider is relevant to this user.</span>
<a name="l432"><span class="linenum"> 432</span></a>              continue;
<a name="l433"><span class="linenum"> 433</span></a>          }
<a name="l434"><span class="linenum"> 434</span></a>  
<a name="l435"><span class="linenum"> 435</span></a>          <a class="var it17352" onMouseOver="hilite(17352)" onMouseOut="lolite()" onClick="logVariable('unsureproviders')" href="../_variables/unsureproviders.html">$unsureproviders</a>[<a class="var it17351" onMouseOver="hilite(17351)" onMouseOut="lolite()" onClick="logVariable('providerid')" href="../_variables/providerid.html">$providerid</a>] = <a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>;
<a name="l436"><span class="linenum"> 436</span></a>          <a class="var it17353" onMouseOver="hilite(17353)" onMouseOut="lolite()" onClick="logVariable('unsurecapabilities')" href="../_variables/unsurecapabilities.html">$unsurecapabilities</a>[<a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>-&gt;<a onClick="logVariable('capability')" class="var it39611" onMouseOver="hilite(39611)" onMouseOut="lolite()" href="../_variables/capability.html">capability</a>] = 1;
<a name="l437"><span class="linenum"> 437</span></a>          unset(<a class="var it17344" onMouseOver="hilite(17344)" onMouseOut="lolite()" onClick="logVariable('providers')" href="../_variables/providers.html">$providers</a>[<a class="var it17351" onMouseOver="hilite(17351)" onMouseOut="lolite()" onClick="logVariable('providerid')" href="../_variables/providerid.html">$providerid</a>]);
<a name="l438"><span class="linenum"> 438</span></a>      }
<a name="l439"><span class="linenum"> 439</span></a>  
<a name="l440"><span class="linenum"> 440</span></a>      if (empty(<a class="var it17352" onMouseOver="hilite(17352)" onMouseOut="lolite()" onClick="logVariable('unsureproviders')" href="../_variables/unsureproviders.html">$unsureproviders</a>)) {
<a name="l441"><span class="linenum"> 441</span></a>  <span class="comment">        // More complex checks are not required.</span>
<a name="l442"><span class="linenum"> 442</span></a>          return <a class="var it17344" onMouseOver="hilite(17344)" onMouseOut="lolite()" onClick="logVariable('providers')" href="../_variables/providers.html">$providers</a>;
<a name="l443"><span class="linenum"> 443</span></a>      }
<a name="l444"><span class="linenum"> 444</span></a>  
<a name="l445"><span class="linenum"> 445</span></a>  <span class="comment">    // Now check the unsure capabilities.</span>
<a name="l446"><span class="linenum"> 446</span></a>      <a class="function" onClick="logFunction('list')" href="../_functions/list.html" onMouseOver="funcPopup(event,'list')">list</a>(<a class="var it17354" onMouseOver="hilite(17354)" onMouseOut="lolite()" onClick="logVariable('capcondition')" href="../_variables/capcondition.html">$capcondition</a>, <a class="var it46" onMouseOver="hilite(46)" onMouseOut="lolite()" onClick="logVariable('params')" href="../_variables/params.html">$params</a>) = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_in_or_equal')" href="../_functions/get_in_or_equal.html" onMouseOver="funcPopup(event,'get_in_or_equal')">get_in_or_equal</a>(
<a name="l447"><span class="linenum"> 447</span></a>              <a class="phpfunction" onClick="logFunction('array_keys')" href="../_functions/array_keys.html" onMouseOver="phpfuncPopup(event,'array_keys')">array_keys</a>(<a class="var it17353" onMouseOver="hilite(17353)" onMouseOut="lolite()" onClick="logVariable('unsurecapabilities')" href="../_variables/unsurecapabilities.html">$unsurecapabilities</a>), <a class="constant" onClick="logConstant('SQL_PARAMS_NAMED')" href="../_constants/SQL_PARAMS_NAMED.html" onMouseOver="constPopup(event,'SQL_PARAMS_NAMED')">SQL_PARAMS_NAMED</a>);
<a name="l448"><span class="linenum"> 448</span></a>      <a class="var it46" onMouseOver="hilite(46)" onMouseOut="lolite()" onClick="logVariable('params')" href="../_variables/params.html">$params</a>['userid'] = <a class="var it182" onMouseOver="hilite(182)" onMouseOut="lolite()" onClick="logVariable('userid')" href="../_variables/userid.html">$userid</a>;
<a name="l449"><span class="linenum"> 449</span></a>  
<a name="l450"><span class="linenum"> 450</span></a>      <a class="var it125" onMouseOver="hilite(125)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../_variables/sql.html">$sql</a> = &quot;SELECT DISTINCT rc.capability, 1
<a name="l451"><span class="linenum"> 451</span></a>  
<a name="l452"><span class="linenum"> 452</span></a>                FROM {role_assignments} ra
<a name="l453"><span class="linenum"> 453</span></a>                JOIN {context} actx ON actx.id = ra.contextid
<a name="l454"><span class="linenum"> 454</span></a>                JOIN {role_capabilities} rc ON rc.roleid = ra.roleid
<a name="l455"><span class="linenum"> 455</span></a>                JOIN {context} cctx ON cctx.id = rc.contextid
<a name="l456"><span class="linenum"> 456</span></a>  
<a name="l457"><span class="linenum"> 457</span></a>               WHERE ra.userid = :userid
<a name="l458"><span class="linenum"> 458</span></a>                 AND rc.capability <a class="var it17354" onMouseOver="hilite(17354)" onMouseOut="lolite()" onClick="logVariable('capcondition')" href="../_variables/capcondition.html">$capcondition</a>
<a name="l459"><span class="linenum"> 459</span></a>                 AND rc.permission &gt; 0
<a name="l460"><span class="linenum"> 460</span></a>                 AND (&quot;.<a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_concat')" href="../_functions/sql_concat.html" onMouseOver="funcPopup(event,'sql_concat')">sql_concat</a>('actx.path', &quot;'/'&quot;).&quot; LIKE &quot;.<a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_concat')" href="../_functions/sql_concat.html" onMouseOver="funcPopup(event,'sql_concat')">sql_concat</a>('cctx.path', &quot;'/%'&quot;).
<a name="l461"><span class="linenum"> 461</span></a>                 &quot; OR &quot;.<a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_concat')" href="../_functions/sql_concat.html" onMouseOver="funcPopup(event,'sql_concat')">sql_concat</a>('cctx.path', &quot;'/'&quot;).&quot; LIKE &quot;.<a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_concat')" href="../_functions/sql_concat.html" onMouseOver="funcPopup(event,'sql_concat')">sql_concat</a>('actx.path', &quot;'/%'&quot;).&quot;)&quot;;
<a name="l462"><span class="linenum"> 462</span></a>  
<a name="l463"><span class="linenum"> 463</span></a>      if (!empty(<a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('defaultfrontpageroleid')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../_variables/defaultfrontpageroleid.html">defaultfrontpageroleid</a>)) {
<a name="l464"><span class="linenum"> 464</span></a>          <a class="var it17355" onMouseOver="hilite(17355)" onMouseOut="lolite()" onClick="logVariable('frontpagecontext')" href="../_variables/frontpagecontext.html">$frontpagecontext</a> = <a class="class" onClick="logClass('context_course')" href="../_classes/context_course.html" onMouseOver="classPopup(event,'context_course')">context_course</a>::<a class="function" onClick="logFunction('instance')" href="../_functions/instance.html" onMouseOver="funcPopup(event,'instance')">instance</a>(<a class="constant" onClick="logConstant('SITEID')" href="../_constants/SITEID.html" onMouseOver="constPopup(event,'SITEID')">SITEID</a>);
<a name="l465"><span class="linenum"> 465</span></a>  
<a name="l466"><span class="linenum"> 466</span></a>          <a class="function" onClick="logFunction('list')" href="../_functions/list.html" onMouseOver="funcPopup(event,'list')">list</a>(<a class="var it17356" onMouseOver="hilite(17356)" onMouseOut="lolite()" onClick="logVariable('capcondition2')" href="../_variables/capcondition2.html">$capcondition2</a>, <a class="var it373" onMouseOver="hilite(373)" onMouseOut="lolite()" onClick="logVariable('params2')" href="../_variables/params2.html">$params2</a>) = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_in_or_equal')" href="../_functions/get_in_or_equal.html" onMouseOver="funcPopup(event,'get_in_or_equal')">get_in_or_equal</a>(
<a name="l467"><span class="linenum"> 467</span></a>                  <a class="phpfunction" onClick="logFunction('array_keys')" href="../_functions/array_keys.html" onMouseOver="phpfuncPopup(event,'array_keys')">array_keys</a>(<a class="var it17353" onMouseOver="hilite(17353)" onMouseOut="lolite()" onClick="logVariable('unsurecapabilities')" href="../_variables/unsurecapabilities.html">$unsurecapabilities</a>), <a class="constant" onClick="logConstant('SQL_PARAMS_NAMED')" href="../_constants/SQL_PARAMS_NAMED.html" onMouseOver="constPopup(event,'SQL_PARAMS_NAMED')">SQL_PARAMS_NAMED</a>);
<a name="l468"><span class="linenum"> 468</span></a>          <a class="var it46" onMouseOver="hilite(46)" onMouseOut="lolite()" onClick="logVariable('params')" href="../_variables/params.html">$params</a> = <a class="phpfunction" onClick="logFunction('array_merge')" href="../_functions/array_merge.html" onMouseOver="phpfuncPopup(event,'array_merge')">array_merge</a>(<a class="var it46" onMouseOver="hilite(46)" onMouseOut="lolite()" onClick="logVariable('params')" href="../_variables/params.html">$params</a>, <a class="var it373" onMouseOver="hilite(373)" onMouseOut="lolite()" onClick="logVariable('params2')" href="../_variables/params2.html">$params2</a>);
<a name="l469"><span class="linenum"> 469</span></a>          <a class="var it46" onMouseOver="hilite(46)" onMouseOut="lolite()" onClick="logVariable('params')" href="../_variables/params.html">$params</a>['frontpageroleid'] = <a class="var it1" onMouseOver="hilite(1)" onMouseOut="lolite()" onClick="logVariable('CFG')" href="../_variables/CFG.html">$CFG</a>-&gt;<a onClick="logVariable('defaultfrontpageroleid')" class="var it39440" onMouseOver="hilite(39440)" onMouseOut="lolite()" href="../_variables/defaultfrontpageroleid.html">defaultfrontpageroleid</a>;
<a name="l470"><span class="linenum"> 470</span></a>          <a class="var it46" onMouseOver="hilite(46)" onMouseOut="lolite()" onClick="logVariable('params')" href="../_variables/params.html">$params</a>['frontpagepathpattern'] = <a class="var it17355" onMouseOver="hilite(17355)" onMouseOut="lolite()" onClick="logVariable('frontpagecontext')" href="../_variables/frontpagecontext.html">$frontpagecontext</a>-&gt;<a onClick="logVariable('path')" class="var it40980" onMouseOver="hilite(40980)" onMouseOut="lolite()" href="../_variables/path.html">path</a> . '/';
<a name="l471"><span class="linenum"> 471</span></a>  
<a name="l472"><span class="linenum"> 472</span></a>          <a class="var it125" onMouseOver="hilite(125)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../_variables/sql.html">$sql</a> .= &quot;
<a name="l473"><span class="linenum"> 473</span></a>               UNION
<a name="l474"><span class="linenum"> 474</span></a>  
<a name="l475"><span class="linenum"> 475</span></a>              SELECT DISTINCT rc.capability, 1
<a name="l476"><span class="linenum"> 476</span></a>  
<a name="l477"><span class="linenum"> 477</span></a>                FROM {role_capabilities} rc
<a name="l478"><span class="linenum"> 478</span></a>                JOIN {context} cctx ON cctx.id = rc.contextid
<a name="l479"><span class="linenum"> 479</span></a>  
<a name="l480"><span class="linenum"> 480</span></a>               WHERE rc.roleid = :frontpageroleid
<a name="l481"><span class="linenum"> 481</span></a>                 AND rc.capability <a class="var it17356" onMouseOver="hilite(17356)" onMouseOut="lolite()" onClick="logVariable('capcondition2')" href="../_variables/capcondition2.html">$capcondition2</a>
<a name="l482"><span class="linenum"> 482</span></a>                 AND rc.permission &gt; 0
<a name="l483"><span class="linenum"> 483</span></a>                 AND &quot;.<a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_concat')" href="../_functions/sql_concat.html" onMouseOver="funcPopup(event,'sql_concat')">sql_concat</a>('cctx.path', &quot;'/'&quot;).&quot; LIKE :frontpagepathpattern&quot;;
<a name="l484"><span class="linenum"> 484</span></a>      }
<a name="l485"><span class="linenum"> 485</span></a>  
<a name="l486"><span class="linenum"> 486</span></a>      <a class="var it17357" onMouseOver="hilite(17357)" onMouseOut="lolite()" onClick="logVariable('relevantcapabilities')" href="../_variables/relevantcapabilities.html">$relevantcapabilities</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records_sql_menu')" href="../_functions/get_records_sql_menu.html" onMouseOver="funcPopup(event,'get_records_sql_menu')">get_records_sql_menu</a>(<a class="var it125" onMouseOver="hilite(125)" onMouseOut="lolite()" onClick="logVariable('sql')" href="../_variables/sql.html">$sql</a>, <a class="var it46" onMouseOver="hilite(46)" onMouseOut="lolite()" onClick="logVariable('params')" href="../_variables/params.html">$params</a>);
<a name="l487"><span class="linenum"> 487</span></a>  
<a name="l488"><span class="linenum"> 488</span></a>  <span class="comment">    // Add back any providers based on the detailed capability check.</span>
<a name="l489"><span class="linenum"> 489</span></a>      foreach (<a class="var it17352" onMouseOver="hilite(17352)" onMouseOut="lolite()" onClick="logVariable('unsureproviders')" href="../_variables/unsureproviders.html">$unsureproviders</a> as <a class="var it17351" onMouseOver="hilite(17351)" onMouseOut="lolite()" onClick="logVariable('providerid')" href="../_variables/providerid.html">$providerid</a> =&gt; <a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>) {
<a name="l490"><span class="linenum"> 490</span></a>          if (<a class="phpfunction" onClick="logFunction('array_key_exists')" href="../_functions/array_key_exists.html" onMouseOver="phpfuncPopup(event,'array_key_exists')">array_key_exists</a>(<a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>-&gt;<a onClick="logVariable('capability')" class="var it39611" onMouseOver="hilite(39611)" onMouseOut="lolite()" href="../_variables/capability.html">capability</a>, <a class="var it17357" onMouseOver="hilite(17357)" onMouseOut="lolite()" onClick="logVariable('relevantcapabilities')" href="../_variables/relevantcapabilities.html">$relevantcapabilities</a>)) {
<a name="l491"><span class="linenum"> 491</span></a>              <a class="var it17344" onMouseOver="hilite(17344)" onMouseOut="lolite()" onClick="logVariable('providers')" href="../_variables/providers.html">$providers</a>[<a class="var it17351" onMouseOver="hilite(17351)" onMouseOut="lolite()" onClick="logVariable('providerid')" href="../_variables/providerid.html">$providerid</a>] = <a class="var it4130" onMouseOver="hilite(4130)" onMouseOut="lolite()" onClick="logVariable('provider')" href="../_variables/provider.html">$provider</a>;
<a name="l492"><span class="linenum"> 492</span></a>          }
<a name="l493"><span class="linenum"> 493</span></a>      }
<a name="l494"><span class="linenum"> 494</span></a>  
<a name="l495"><span class="linenum"> 495</span></a>      return <a class="var it17344" onMouseOver="hilite(17344)" onMouseOut="lolite()" onClick="logVariable('providers')" href="../_variables/providers.html">$providers</a>;
<a name="l496"><span class="linenum"> 496</span></a>  }
<a name="l497"><span class="linenum"> 497</span></a>  
<a name="l498"><span class="linenum"> 498</span></a>  <span class="comment">/**</span>
<a name="l499"><span class="linenum"> 499</span></a>  <span class="comment"> * Gets the message providers that are in the database for this component.</span>
<a name="l500"><span class="linenum"> 500</span></a>  <span class="comment"> *</span>
<a name="l501"><span class="linenum"> 501</span></a>  <span class="comment"> * This is an internal function used within messagelib.php</span>
<a name="l502"><span class="linenum"> 502</span></a>  <span class="comment"> *</span>
<a name="l503"><span class="linenum"> 503</span></a>  <span class="comment"> * @see message_update_providers()</span>
<a name="l504"><span class="linenum"> 504</span></a>  <span class="comment"> * @param string $component A moodle component like 'moodle', 'mod_forum', 'block_quiz_results'</span>
<a name="l505"><span class="linenum"> 505</span></a>  <span class="comment"> * @return array An array of message providers</span>
<a name="l506"><span class="linenum"> 506</span></a>  <span class="comment"> */</span>
<a name="l507"><span class="linenum"> 507</span></a>  function <a class="function" onClick="logFunction('message_get_providers_from_db')" href="../_functions/message_get_providers_from_db.html" onMouseOver="funcPopup(event,'message_get_providers_from_db')">message_get_providers_from_db</a>(<a class="var it547" onMouseOver="hilite(547)" onMouseOut="lolite()" onClick="logVariable('component')" href="../_variables/component.html">$component</a>) {
<a name="l508"><span class="linenum"> 508</span></a>      global <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>;
<a name="l509"><span class="linenum"> 509</span></a>  
<a name="l510"><span class="linenum"> 510</span></a>      return <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('get_records')" href="../_functions/get_records.html" onMouseOver="funcPopup(event,'get_records')">get_records</a>('message_providers', array('component'=&gt;<a class="var it547" onMouseOver="hilite(547)" onMouseOut="lolite()" onClick="logVariable('component')" href="../_variables/component.html">$component</a>), '', 'name, id, component, capability');  <span class="comment">// Name is unique per component</span>
<a name="l511"><span class="linenum"> 511</span></a>  }
<a name="l512"><span class="linenum"> 512</span></a>  
<a name="l513"><span class="linenum"> 513</span></a>  <span class="comment">/**</span>
<a name="l514"><span class="linenum"> 514</span></a>  <span class="comment"> * Loads the messages definitions for a component from file</span>
<a name="l515"><span class="linenum"> 515</span></a>  <span class="comment"> *</span>
<a name="l516"><span class="linenum"> 516</span></a>  <span class="comment"> * If no messages are defined for the component, return an empty array.</span>
<a name="l517"><span class="linenum"> 517</span></a>  <span class="comment"> * This is an internal function used within messagelib.php</span>
<a name="l518"><span class="linenum"> 518</span></a>  <span class="comment"> *</span>
<a name="l519"><span class="linenum"> 519</span></a>  <span class="comment"> * @see message_update_providers()</span>
<a name="l520"><span class="linenum"> 520</span></a>  <span class="comment"> * @see message_update_processors()</span>
<a name="l521"><span class="linenum"> 521</span></a>  <span class="comment"> * @param string $component A moodle component like 'moodle', 'mod_forum', 'block_quiz_results'</span>
<a name="l522"><span class="linenum"> 522</span></a>  <span class="comment"> * @return array An array of message providers or empty array if not exists</span>
<a name="l523"><span class="linenum"> 523</span></a>  <span class="comment"> */</span>
<a name="l524"><span class="linenum"> 524</span></a>  function <a class="function" onClick="logFunction('message_get_providers_from_file')" href="../_functions/message_get_providers_from_file.html" onMouseOver="funcPopup(event,'message_get_providers_from_file')">message_get_providers_from_file</a>(<a class="var it547" onMouseOver="hilite(547)" onMouseOut="lolite()" onClick="logVariable('component')" href="../_variables/component.html">$component</a>) {
<a name="l525"><span class="linenum"> 525</span></a>      <a class="var it17358" onMouseOver="hilite(17358)" onMouseOut="lolite()" onClick="logVariable('defpath')" href="../_variables/defpath.html">$defpath</a> = <a class="class" onClick="logClass('core_component')" href="../_classes/core_component.html" onMouseOver="classPopup(event,'core_component')">core_component</a>::<a class="function" onClick="logFunction('get_component_directory')" href="../_functions/get_component_directory.html" onMouseOver="funcPopup(event,'get_component_directory')">get_component_directory</a>(<a class="var it547" onMouseOver="hilite(547)" onMouseOut="lolite()" onClick="logVariable('component')" href="../_variables/component.html">$component</a>).'/db/messages.php';
<a name="l526"><span class="linenum"> 526</span></a>  
<a name="l527"><span class="linenum"> 527</span></a>      <a class="var it7619" onMouseOver="hilite(7619)" onMouseOut="lolite()" onClick="logVariable('messageproviders')" href="../_variables/messageproviders.html">$messageproviders</a> = array();
<a name="l528"><span class="linenum"> 528</span></a>  
<a name="l529"><span class="linenum"> 529</span></a>      if (<a class="phpfunction" onClick="logFunction('file_exists')" href="../_functions/file_exists.html" onMouseOver="phpfuncPopup(event,'file_exists')">file_exists</a>(<a class="var it17358" onMouseOver="hilite(17358)" onMouseOut="lolite()" onClick="logVariable('defpath')" href="../_variables/defpath.html">$defpath</a>)) {
<a name="l530"><span class="linenum"> 530</span></a>          <a class="function" onClick="logFunction('require')" href="../_functions/require.html" onMouseOver="funcPopup(event,'require')">require</a>(<a class="var it17358" onMouseOver="hilite(17358)" onMouseOut="lolite()" onClick="logVariable('defpath')" href="../_variables/defpath.html">$defpath</a>);
<a name="l531"><span class="linenum"> 531</span></a>      }
<a name="l532"><span class="linenum"> 532</span></a>  
<a name="l533"><span class="linenum"> 533</span></a>      foreach (<a class="var it7619" onMouseOver="hilite(7619)" onMouseOut="lolite()" onClick="logVariable('messageproviders')" href="../_variables/messageproviders.html">$messageproviders</a> as <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('name')" href="../_variables/name.html">$name</a> =&gt; <a class="var it17359" onMouseOver="hilite(17359)" onMouseOut="lolite()" onClick="logVariable('messageprovider')" href="../_variables/messageprovider.html">$messageprovider</a>) {   // Fix up missing values if required
<a name="l534"><span class="linenum"> 534</span></a>          if (empty(<a class="var it17359" onMouseOver="hilite(17359)" onMouseOut="lolite()" onClick="logVariable('messageprovider')" href="../_variables/messageprovider.html">$messageprovider</a>['capability'])) {
<a name="l535"><span class="linenum"> 535</span></a>              <a class="var it7619" onMouseOver="hilite(7619)" onMouseOut="lolite()" onClick="logVariable('messageproviders')" href="../_variables/messageproviders.html">$messageproviders</a>[<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('name')" href="../_variables/name.html">$name</a>]['capability'] = NULL;
<a name="l536"><span class="linenum"> 536</span></a>          }
<a name="l537"><span class="linenum"> 537</span></a>          if (empty(<a class="var it17359" onMouseOver="hilite(17359)" onMouseOut="lolite()" onClick="logVariable('messageprovider')" href="../_variables/messageprovider.html">$messageprovider</a>['defaults'])) {
<a name="l538"><span class="linenum"> 538</span></a>              <a class="var it7619" onMouseOver="hilite(7619)" onMouseOut="lolite()" onClick="logVariable('messageproviders')" href="../_variables/messageproviders.html">$messageproviders</a>[<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('name')" href="../_variables/name.html">$name</a>]['defaults'] = array();
<a name="l539"><span class="linenum"> 539</span></a>          }
<a name="l540"><span class="linenum"> 540</span></a>      }
<a name="l541"><span class="linenum"> 541</span></a>  
<a name="l542"><span class="linenum"> 542</span></a>      return <a class="var it7619" onMouseOver="hilite(7619)" onMouseOut="lolite()" onClick="logVariable('messageproviders')" href="../_variables/messageproviders.html">$messageproviders</a>;
<a name="l543"><span class="linenum"> 543</span></a>  }
<a name="l544"><span class="linenum"> 544</span></a>  
<a name="l545"><span class="linenum"> 545</span></a>  <span class="comment">/**</span>
<a name="l546"><span class="linenum"> 546</span></a>  <span class="comment"> * Remove all message providers for particular component and corresponding settings</span>
<a name="l547"><span class="linenum"> 547</span></a>  <span class="comment"> *</span>
<a name="l548"><span class="linenum"> 548</span></a>  <span class="comment"> * @param string $component A moodle component like 'moodle', 'mod_forum', 'block_quiz_results'</span>
<a name="l549"><span class="linenum"> 549</span></a>  <span class="comment"> * @return void</span>
<a name="l550"><span class="linenum"> 550</span></a>  <span class="comment"> */</span>
<a name="l551"><span class="linenum"> 551</span></a>  function <a class="function" onClick="logFunction('message_provider_uninstall')" href="../_functions/message_provider_uninstall.html" onMouseOver="funcPopup(event,'message_provider_uninstall')">message_provider_uninstall</a>(<a class="var it547" onMouseOver="hilite(547)" onMouseOut="lolite()" onClick="logVariable('component')" href="../_variables/component.html">$component</a>) {
<a name="l552"><span class="linenum"> 552</span></a>      global <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>;
<a name="l553"><span class="linenum"> 553</span></a>  
<a name="l554"><span class="linenum"> 554</span></a>      <a class="var it2929" onMouseOver="hilite(2929)" onMouseOut="lolite()" onClick="logVariable('transaction')" href="../_variables/transaction.html">$transaction</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('start_delegated_transaction')" href="../_functions/start_delegated_transaction.html" onMouseOver="funcPopup(event,'start_delegated_transaction')">start_delegated_transaction</a>();
<a name="l555"><span class="linenum"> 555</span></a>      <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('delete_records')" href="../_functions/delete_records.html" onMouseOver="funcPopup(event,'delete_records')">delete_records</a>('message_providers', array('component' =&gt; <a class="var it547" onMouseOver="hilite(547)" onMouseOut="lolite()" onClick="logVariable('component')" href="../_variables/component.html">$component</a>));
<a name="l556"><span class="linenum"> 556</span></a>      <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('delete_records_select')" href="../_functions/delete_records_select.html" onMouseOver="funcPopup(event,'delete_records_select')">delete_records_select</a>('config_plugins', &quot;plugin = 'message' AND &quot;.<a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_like')" href="../_functions/sql_like.html" onMouseOver="funcPopup(event,'sql_like')">sql_like</a>('name', '?', false), array(&quot;%_provider_{<a class="var it547" onMouseOver="hilite(547)" onMouseOut="lolite()" onClick="logVariable('component')" href="../_variables/component.html">$component</a>}_%&quot;));
<a name="l557"><span class="linenum"> 557</span></a>      <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('delete_records_select')" href="../_functions/delete_records_select.html" onMouseOver="funcPopup(event,'delete_records_select')">delete_records_select</a>('user_preferences', <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_like')" href="../_functions/sql_like.html" onMouseOver="funcPopup(event,'sql_like')">sql_like</a>('name', '?', false), array(&quot;message_provider_{<a class="var it547" onMouseOver="hilite(547)" onMouseOut="lolite()" onClick="logVariable('component')" href="../_variables/component.html">$component</a>}_%&quot;));
<a name="l558"><span class="linenum"> 558</span></a>      <a class="var it2929" onMouseOver="hilite(2929)" onMouseOut="lolite()" onClick="logVariable('transaction')" href="../_variables/transaction.html">$transaction</a>-&gt;<a class="function" onClick="logFunction('allow_commit')" href="../_functions/allow_commit.html" onMouseOver="funcPopup(event,'allow_commit')">allow_commit</a>();
<a name="l559"><span class="linenum"> 559</span></a>  <span class="comment">    // Purge all messaging settings from the caches. They are stored by plugin so we have to clear all message settings.</span>
<a name="l560"><span class="linenum"> 560</span></a>      <a class="class" onClick="logClass('cache_helper')" href="../_classes/cache_helper.html" onMouseOver="classPopup(event,'cache_helper')">cache_helper</a>::<a class="function" onClick="logFunction('invalidate_by_definition')" href="../_functions/invalidate_by_definition.html" onMouseOver="funcPopup(event,'invalidate_by_definition')">invalidate_by_definition</a>('core', 'config', array(), 'message');
<a name="l561"><span class="linenum"> 561</span></a>  }
<a name="l562"><span class="linenum"> 562</span></a>  
<a name="l563"><span class="linenum"> 563</span></a>  <span class="comment">/**</span>
<a name="l564"><span class="linenum"> 564</span></a>  <span class="comment"> * Uninstall a message processor</span>
<a name="l565"><span class="linenum"> 565</span></a>  <span class="comment"> *</span>
<a name="l566"><span class="linenum"> 566</span></a>  <span class="comment"> * @param string $name A message processor name like 'email', 'jabber'</span>
<a name="l567"><span class="linenum"> 567</span></a>  <span class="comment"> */</span>
<a name="l568"><span class="linenum"> 568</span></a>  function <a class="function" onClick="logFunction('message_processor_uninstall')" href="../_functions/message_processor_uninstall.html" onMouseOver="funcPopup(event,'message_processor_uninstall')">message_processor_uninstall</a>(<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('name')" href="../_variables/name.html">$name</a>) {
<a name="l569"><span class="linenum"> 569</span></a>      global <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>;
<a name="l570"><span class="linenum"> 570</span></a>  
<a name="l571"><span class="linenum"> 571</span></a>      <a class="var it2929" onMouseOver="hilite(2929)" onMouseOut="lolite()" onClick="logVariable('transaction')" href="../_variables/transaction.html">$transaction</a> = <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('start_delegated_transaction')" href="../_functions/start_delegated_transaction.html" onMouseOver="funcPopup(event,'start_delegated_transaction')">start_delegated_transaction</a>();
<a name="l572"><span class="linenum"> 572</span></a>      <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('delete_records')" href="../_functions/delete_records.html" onMouseOver="funcPopup(event,'delete_records')">delete_records</a>('message_processors', array('name' =&gt; <a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('name')" href="../_variables/name.html">$name</a>));
<a name="l573"><span class="linenum"> 573</span></a>      <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('delete_records_select')" href="../_functions/delete_records_select.html" onMouseOver="funcPopup(event,'delete_records_select')">delete_records_select</a>('config_plugins', &quot;plugin = ?&quot;, array(&quot;message_{<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('name')" href="../_variables/name.html">$name</a>}&quot;));
<a name="l574"><span class="linenum"> 574</span></a>  <span class="comment">    // delete permission preferences only, we do not care about loggedin/loggedoff</span>
<a name="l575"><span class="linenum"> 575</span></a>  <span class="comment">    // defaults, they will be removed on the next attempt to update the preferences</span>
<a name="l576"><span class="linenum"> 576</span></a>      <a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('delete_records_select')" href="../_functions/delete_records_select.html" onMouseOver="funcPopup(event,'delete_records_select')">delete_records_select</a>('config_plugins', &quot;plugin = 'message' AND &quot;.<a class="var it2" onMouseOver="hilite(2)" onMouseOut="lolite()" onClick="logVariable('DB')" href="../_variables/DB.html">$DB</a>-&gt;<a class="function" onClick="logFunction('sql_like')" href="../_functions/sql_like.html" onMouseOver="funcPopup(event,'sql_like')">sql_like</a>('name', '?', false), array(&quot;{<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('name')" href="../_variables/name.html">$name</a>}_provider_%&quot;));
<a name="l577"><span class="linenum"> 577</span></a>      <a class="var it2929" onMouseOver="hilite(2929)" onMouseOut="lolite()" onClick="logVariable('transaction')" href="../_variables/transaction.html">$transaction</a>-&gt;<a class="function" onClick="logFunction('allow_commit')" href="../_functions/allow_commit.html" onMouseOver="funcPopup(event,'allow_commit')">allow_commit</a>();
<a name="l578"><span class="linenum"> 578</span></a>  <span class="comment">    // Purge all messaging settings from the caches. They are stored by plugin so we have to clear all message settings.</span>
<a name="l579"><span class="linenum"> 579</span></a>      <a class="class" onClick="logClass('cache_helper')" href="../_classes/cache_helper.html" onMouseOver="classPopup(event,'cache_helper')">cache_helper</a>::<a class="function" onClick="logFunction('invalidate_by_definition')" href="../_functions/invalidate_by_definition.html" onMouseOver="funcPopup(event,'invalidate_by_definition')">invalidate_by_definition</a>('core', 'config', array(), array('message', &quot;message_{<a class="var it5" onMouseOver="hilite(5)" onMouseOut="lolite()" onClick="logVariable('name')" href="../_variables/name.html">$name</a>}&quot;));
<a name="l580"><span class="linenum"> 580</span></a>  }
</pre>
</div>
<script language="JavaScript" type="text/javascript">
FUNC_DATA={
'set_config': ['set_config', 'Set a configuration value for this plugin ', [['mod/assign','assignmentplugin.php',314],['lib/portfolio','plugin.php',515],['lib','moodlelib.php',1331],['lib','enrollib.php',1152],['lib/editor/tinymce/classes','plugin.php',84]], 985],
'message_sent': ['message_sent', 'To be called from messagelib.php only! ', [['lib/phpunit/classes','util.php',679]], 1],
'send_message': ['send_message', 'Process the popup message. The popup doesn\'t send data only saves in the database for later use, the popup_interface.php takes the message from the message table into the message_read. ', [['message/output/popup','message_output_popup.php',37],['lib/classes/message','manager.php',48],['message/tests','externallib_test.php',44],['message/output/airnotifier','message_output_airnotifier.php',39],['message/output/jabber','message_output_jabber.php',37],['message/output/email','message_output_email.php',35]], 14],
'get_records_sql_menu': ['get_records_sql_menu', 'Get the first two columns from a number of records as an associative array using a SQL statement. ', [['lib/dml','moodle_database.php',1387]], 33],
'message_update_processors': ['message_update_processors', 'This function populates default message preferences for all existing providers when the new message processor is added. ', [['lib','messagelib.php',290]], 3],
'message_update_providers': ['message_update_providers', 'Updates the message_providers table with the current set of message providers ', [['lib','messagelib.php',233]], 11],
'is_user_configured': ['is_user_configured', 'Are the message processor\'s user specific settings configured? ', [['message/output','lib.php',73],['message/output/jabber','message_output_jabber.php',144]], 2],
'message_set_default_message_preference': ['message_set_default_message_preference', 'Setting default messaging preferences for particular message provider ', [['lib','messagelib.php',319]], 2],
'debugging': ['debugging', 'Standard Debugging Function ', [['lib','weblib.php',2854]], 853],
'get_component_directory': ['get_component_directory', 'Return exact absolute path to a plugin directory. ', [['lib/classes','component.php',1003],['lib','deprecatedlib.php',543]], 44],
'get_user': ['get_user', 'Return user object from db or create noreply or support user, if userid matches corse_user::NOREPLY_USER or corse_user::SUPPORT_USER respectively. If userid is not found, then return false. ', [['lib/classes','user.php',52]], 27],
'get_message_processors': ['get_message_processors', 'Get all message processors, validate corresponding plugin existance and system configuration ', [['message','lib.php',2438]], 14],
'start_delegated_transaction': ['start_delegated_transaction', 'On DBs that support it, switch to transaction mode and begin a transaction you\'ll need to ensure you call allow_commit() on the returned object or your changes *will* be lost. ', [['lib/dml','moodle_database.php',2344]], 137],
'insert_record': ['insert_record', 'Insert a record into a table and return the "id" field if required. ', [['lib/dml','pgsql_native_moodle_database.php',883],['lib/dml','oci_native_moodle_database.php',1249],['lib/dml','sqlsrv_native_moodle_database.php',978],['lib/dml','mssql_native_moodle_database.php',898],['lib/dml','mysqli_native_moodle_database.php',1177],['lib/dml/tests','dml_test.php',5427],['lib/dml','pdo_moodle_database.php',386],['question/engine/upgrade','upgradelib.php',121]], 1512],
'allow_commit': ['allow_commit', 'Commit delegated transaction. The real database commit SQL is executed only after committing all delegated transactions. ', [['lib/dml','moodle_transaction.php',78]], 127],
'sql_like': ['sql_like', 'Returns \'LIKE\' part of a query. ', [['lib/dml','pgsql_native_moodle_database.php',1273],['lib/dml','oci_native_moodle_database.php',1523],['lib/dml','sqlsrv_native_moodle_database.php',1224],['lib/dml','moodle_database.php',2004],['lib/dml','mssql_native_moodle_database.php',1160],['lib/dml','mysqli_native_moodle_database.php',1502]], 158],
'has_capability': ['has_capability', 'Wrapper round the has_capability funciton that automatically passes in the quiz context. ', [['mod/quiz','attemptlib.php',299],['mod/quiz','attemptlib.php',884],['lib','accesslib.php',346]], 1929],
'get_records': ['get_records', 'Get a number of records as an array of objects where all the given conditions met. ', [['lib/dml','moodle_database.php',1236],['lib','coursecatlib.php',654],['question','category_class.php',63]], 860],
'is_redirecting_messages': ['is_redirecting_messages', 'Are messages redirected to some sink? ', [['lib/phpunit/classes','util.php',668]], 4],
'join': ['join', 'Join a room. For internal use by the Games SDK only. Calling this method directly is unsupported. (rooms.join) ', [['lib/google/src/Google/Service','Games.php',1715],['lib/google/src/Google/Service','Games.php',2099]], 949],
'sql_concat': ['sql_concat', '', [['lib/dml','pgsql_native_moodle_database.php',1315],['lib/dml','oci_native_moodle_database.php',1550],['lib/dml','sqlsrv_native_moodle_database.php',1257],['lib/dml','sqlite3_pdo_moodle_database.php',353],['lib/dml','mssql_native_moodle_database.php',1194],['lib/dml','mysqli_native_moodle_database.php',1531],['lib/dml/tests','dml_test.php',5433],['lib/dml','pdo_moodle_database.php',536]], 73],
'get_record': ['get_record', 'Get a single database record as an object where all the given conditions met. ', [['lib/dml','moodle_database.php',1413]], 2960],
'invalidate_by_definition': ['invalidate_by_definition', 'Invalidates a given set of keys from a given definition. ', [['cache/classes','helper.php',206]], 35],
'message_processor_uninstall': ['message_processor_uninstall', 'Uninstall a message processor ', [['lib','messagelib.php',563]], 1],
'message_provider_uninstall': ['message_provider_uninstall', 'Remove all message providers for particular component and corresponding settings ', [['lib','messagelib.php',545]], 1],
'enrol_is_enabled': ['enrol_is_enabled', 'Checks if a given plugin is in the list of enabled enrolment plugins. ', [['lib','enrollib.php',171]], 56],
'list': ['list', '', [['mod/data/preset/imagegallery','jstemplate.js',9]], 1891],
'message_get_providers_from_file': ['message_get_providers_from_file', 'Loads the messages definitions for a component from file ', [['lib','messagelib.php',513]], 2],
'can_send_to_any_users': ['can_send_to_any_users', 'Returns true if message can be sent to fake/internal user as well. If message_output support message to be sent to fake user, then it should return true, like email. ', [['message/output','lib.php',96],['message/output/email','message_output_email.php',190]], 2],
'send': ['send', '', [['lib/horde/framework/Horde/Mail/Transport','Smtpmx.php',179],['lib/horde/framework/Horde/Mail/Transport','Smtphorde.php',116],['lib/horde/framework/Horde/Mail/Transport','Null.php',54],['lib/zend/Zend/Service/DeveloperGarden','SendSms.php',126],['lib/google/src/Google/Service','Gmail.php',739],['lib/google/src/Google/Service','Gmail.php',1057],['lib','excellib.class.php',132],['lib/horde/framework/Horde/Mail/Transport','Mail.php',60],['auth/cas/CAS/CAS/Request','AbstractRequest.php',223],['lib/pear/Auth','RADIUS.php',370],['lib/phpmailer','class.phpmailer.php',954],['lib/zend/Zend/Service/Amazon','Sqs.php',185],['lib/horde/framework/Horde/Mail/Transport','Smtp.php',158],['auth/cas/CAS/CAS/ProxiedService/Http','Abstract.php',126],['auth/cas/CAS/CAS/ProxiedService','Http.php',62],['lib/jabber/XMPP','XMLStream.php',677],['lib','odslib.class.php',81],['auth/cas/CAS/CAS/Request','CurlMultiRequest.php',99],['lib/horde/framework/Horde/Mime','Part.php',1679],['backup/util/xml/output','memory_xml_output.class.php',59],['lib/horde/framework/Horde/Mail/Transport','Mock.php',91],['lib/horde/framework/Horde/Mail/Transport','Sendmail.php',89],['mnet/xmlrpc','client.php',119],['auth/cas/CAS/CAS/Request','RequestInterface.php',136],['lib/jabber/XMPP','BOSH.php',150],['auth/cas/CAS/CAS/Request','MultiRequestInterface.php',75],['mod/lti/classes/local/ltiservice','response.php',205],['backup/util/xml/output','file_xml_output.class.php',66],['lib/htmlpurifier/HTMLPurifier','ErrorCollector.php',65],['lib/horde/framework/Horde/Mime','Mail.php',372]], 205],
'delete_records_select': ['delete_records_select', 'Delete one or more records from a table which match a particular WHERE clause. ', [['lib/dml','pgsql_native_moodle_database.php',1247],['lib/dml','oci_native_moodle_database.php',1445],['lib/dml','sqlsrv_native_moodle_database.php',1153],['lib/dml','mssql_native_moodle_database.php',1082],['lib/dml','mysqli_native_moodle_database.php',1469],['lib/dml/tests','dml_test.php',5432],['lib/dml','pdo_moodle_database.php',207]], 166],
'instance': ['instance', 'Retrieve sole instance of the registry. ', [['lib/htmlpurifier/HTMLPurifier','URISchemeRegistry.php',9],['lib/classes/update','checker.php',62],['lib/htmlpurifier/HTMLPurifier','EntityLookup.php',29],['lib/classes','useragent.php',101],['backup/cc','validator.php',35],['lib/portfolio','exporter.php',251],['lib/tests','update_deployer_test.php',69],['lib/tests','string_manager_standard_test.php',124],['lib','modinfolib.php',373],['','mdeploy.php',96],['cache','disabledlib.php',171],['cache','disabledlib.php',296],['admin/tool/installaddon/classes','validator.php',85],['cache/classes','config.php',87],['course/format','lib.php',156],['lib','accesslib.php',6184],['lib','accesslib.php',6436],['lib','accesslib.php',6614],['lib','accesslib.php',6868],['lib','accesslib.php',7129],['lib','accesslib.php',7341],['cache','locallib.php',52],['lib/htmlpurifier','HTMLPurifier.php',251],['cache/classes','factory.php',114],['lib/htmlpurifier/HTMLPurifier','LanguageFactory.php',53],['cache/classes','helper.php',76],['lib/htmlpurifier/HTMLPurifier','DefinitionCacheFactory.php',31],['lib/classes','plugin_manager.php',83],['lib','filterlib.php',81],['lib/htmlpurifier/HTMLPurifier','ConfigSchema.php',80],['lib/classes/update','deployer.php',54],['admin/tool/installaddon/classes','pluginfo_client.php',37],['admin/tool/installaddon/classes','installer.php',40],['backup/cc/cc_lib','cc_utils.php',387],['backup/cc/cc_lib','cc_utils.php',443]], 3942],
'get_records_sql': ['get_records_sql', 'Get a number of records as an array of objects using a SQL statement. ', [['lib/dml','pgsql_native_moodle_database.php',732],['lib/dml','oci_native_moodle_database.php',1102],['lib/dml','sqlsrv_native_moodle_database.php',823],['lib/dml','mssql_native_moodle_database.php',741],['lib/dml','mysqli_native_moodle_database.php',1049],['lib/dml/tests','dml_test.php',5424],['lib/dml','pdo_moodle_database.php',308]], 678],
'normalize_component': ['normalize_component', 'Normalize the component name using the "frankenstyle" rules. ', [['lib/classes','component.php',968],['lib','deprecatedlib.php',528]], 85],
'require': ['require', '', [['lib/yuilib/3.17.2/timers','timers-debug.js',27],['lib/yuilib/3.17.2/timers','timers.js',27]], 454],
'get_user_preferences': ['get_user_preferences', 'Used to fetch user preference(s) ', [['lib','moodlelib.php',1969]], 177],
'update_record': ['update_record', 'Update a record in a table ', [['lib/dml','pgsql_native_moodle_database.php',1137],['lib/dml','oci_native_moodle_database.php',1355],['lib/dml','sqlsrv_native_moodle_database.php',1081],['lib/dml','mssql_native_moodle_database.php',1003],['lib/dml','mysqli_native_moodle_database.php',1397],['lib/dml/tests','dml_test.php',5430],['lib/dml','pdo_moodle_database.php',460]], 565],
'message_get_providers_for_user': ['message_get_providers_for_user', 'Returns the active providers for the user specified, based on capability ', [['lib','messagelib.php',391]], 8],
'message_send': ['message_send', 'Called when a message provider wants to send a message. This functions checks the message recipient\'s message processor configuration then sends the message to the configured processors ', [['lib','messagelib.php',29]], 99],
'get_message_output_default_preferences': ['get_message_output_default_preferences', 'Get messaging outputs default (site) preferences ', [['message','lib.php',2554]], 6],
'is_real_user': ['is_real_user', 'Return true is user id is greater than self::NOREPLY_USER and alternatively check db. ', [['lib/classes','user.php',220]], 16],
'get_in_or_equal': ['get_in_or_equal', 'Constructs \'IN()\' or \'=\' sql fragment ', [['lib/dml','oci_native_moodle_database.php',1583],['lib/dml','moodle_database.php',678]], 375],
'message_get_providers_from_db': ['message_get_providers_from_db', 'Gets the message providers that are in the database for this component. ', [['lib','messagelib.php',498]], 1],
'delete_records': ['delete_records', 'Delete the records from a table where all the given conditions met. If conditions not specified, table is truncated. ', [['lib/dml','moodle_database.php',1815],['lib/dml','sqlite3_pdo_moodle_database.php',337]], 778],
'translate_message_default_setting': ['translate_message_default_setting', 'Translate message default settings from binary value to the array of string representing the settings to be stored. Also validate the provided value and use default if it is malformed. ', [['message','lib.php',2563]], 1],
'get_message_providers': ['get_message_providers', 'Get all message providers, validate their plugin existance and system configuration ', [['message','lib.php',2496]], 2],
'explode': ['explode', '', [], 1599],
'class_exists': ['class_exists', '', [], 273],
'in_array': ['in_array', '', [], 1173],
'time': ['time', '', [], 1768],
'dirname': ['dirname', '', [], 1071],
'array_key_exists': ['array_key_exists', '', [], 1539],
'file_exists': ['file_exists', '', [], 873],
'array_keys': ['array_keys', '', [], 1152],
'array_merge': ['array_merge', '', [], 2320],
'is_dir': ['is_dir', '', [], 221],
'defined': ['defined', '', [], 4098],
'is_object': ['is_object', '', [], 508]};
CLASS_DATA={
'core_user': ['core_user', 'User class to access user details. ', [['lib/classes','user.php',27]], 143],
'context_system': ['context_system', 'System context class ', [['lib','accesslib.php',6106]], 929],
'manager': ['manager', 'Defines MAnager class for myprofile navigation tree. ', [['user/classes/output/myprofile','manager.php',28],['lib/classes/log','manager.php',29],['admin/tool/messageinbound/classes','manager.php',29],['lib/classes/message','manager.php',31],['lib/classes/message/inbound','manager.php',29],['admin/tool/log/classes/log','manager.php',29],['lib/classes/session','manager.php',29],['lib/classes/task','manager.php',28],['lib/classes/event','manager.php',30]], 346],
'coding_exception': ['coding_exception', 'Exception indicating programming error, must be fixed by a programer. For example a core API might throw this type of exception if a plugin calls it incorrectly. ', [['lib','setuplib.php',214]], 867],
'cache_helper': ['cache_helper', 'The cache helper class. ', [['cache/classes','helper.php',31]], 131],
'invalid_parameter_exception': ['invalid_parameter_exception', 'Exception indicating malformed parameter problem. This exception is not supposed to be thrown when processing user submitted data in forms. It is more suitable for WS and other low level stuff. ', [['lib','setuplib.php',234]], 58],
'message': ['message', 'Class for messaging processors ', [['lib/classes/plugininfo','message.php',30],['lib/classes/message','message.php',30]], 3],
'context_course': ['context_course', 'Course context class ', [['lib','accesslib.php',6766]], 1197],
'core_component': ['core_component', 'Collection of components related methods. ', [['lib/classes','component.php',41]], 485],
'phpunit_util': ['phpunit_util', 'Collection of utility methods. ', [['lib/phpunit/classes','util.php',28]], 136]};
CONST_DATA={
'DEBUG_DEVELOPER': ['DEBUG_DEVELOPER', '', [['lib','setuplib.php',40]], 554],
'PHPUNIT_TEST': ['PHPUNIT_TEST', '', [['admin/cli','install.php',143],['','install.php',49],['lib','setup.php',247],['lib/phpunit','bootstrap.php',63]], 54],
'SITEID': ['SITEID', '', [['admin/cli','install.php',217],['','install.php',244],['lib/db','install.php',87],['lib','setup.php',748]], 612],
'SQL_PARAMS_NAMED': ['SQL_PARAMS_NAMED', '', [['lib/dml','moodle_database.php',32]], 271],
'DEBUG_NORMAL': ['DEBUG_NORMAL', '', [['lib','setuplib.php',36]], 22],
'MOODLE_INTERNAL': ['MOODLE_INTERNAL', '', [['admin/cli','install.php',138],['','install.php',93],['lib','setup.php',386]], 3532]};
</script>
<div id="func-popup" class="funcpopup"><p id="func-title" class="popup-title">title</p><p id="func-desc" class="popup-desc">Description</p><p id="func-body" class="popup-body">Body</p></div>
<div id="class-popup" class="funcpopup"><p id="class-title" class="popup-title">title</p><p id="class-desc" class="popup-desc">Description</p><p id="class-body" class="popup-body">Body</p></div>
<div id="const-popup" class="funcpopup"><p id="const-title" class="popup-title">title</p><p id="const-desc" class="popup-desc">Description</p><p id="const-body" class="popup-body">Body</p></div>
<div id="req-popup" class="funcpopup"><p id="req-title" class="popup-title">title</p><p id="req-body" class="popup-body">Body</p></div>
<!-- A link to the phpxref site in your customized footer file is appreciated ;-) -->
<br><hr>
<table width="100%">
	<tr><td>Generated: Thu May 28 19:17:31 2015</td>
	<td align="right"><i>Cross-referenced by <a href="http://phpxref.sourceforge.net/">PHPXref 0.7.1</a></i></td>
	</tr>
</table>
</body></html>
